# ä¸šåŠ¡æƒé™å®æˆ˜ç¤ºä¾‹ - è´¢åŠ¡æ¨¡å—

## ğŸ“¦ å®Œæ•´ç¤ºä¾‹ï¼šè´¢åŠ¡è®¢å•ç®¡ç†

è¿™ä¸ªç¤ºä¾‹å±•ç¤ºå¦‚ä½•åœ¨ä¸€ä¸ªçœŸå®çš„ä¸šåŠ¡æ¨¡å—ä¸­å®ç°ä¸¤å±‚æƒé™æ£€æŸ¥ã€‚

## 1ï¸âƒ£ ç¬¬ä¸€æ­¥ï¼šé…ç½®èœå•æƒé™

### åœ¨èœå•ç®¡ç†ç•Œé¢é…ç½®

```javascript
// èœå•ï¼šfinance
{
  "name": "finance",
  "path": "/finance",
  "title": "è´¢åŠ¡ç®¡ç†",
  "available_permissions": [
    // åŸºç¡€æƒé™ï¼ˆCRUDï¼‰
    { "action": "read", "label": "æŸ¥çœ‹", "is_basic": true },
    { "action": "create", "label": "åˆ›å»º", "is_basic": true },
    { "action": "update", "label": "ä¿®æ”¹", "is_basic": true },
    { "action": "delete", "label": "åˆ é™¤", "is_basic": true },
    
    // ä¸šåŠ¡æƒé™
    { "action": "pending", "label": "æŒ‚è´¦", "description": "å°†è®¢å•æ ‡è®°ä¸ºæŒ‚è´¦", "is_basic": false },
    { "action": "verify", "label": "æ ¸é”€", "description": "æ ¸é”€æŒ‚è´¦è®¢å•", "is_basic": false },
    { "action": "audit", "label": "å®¡æ ¸", "description": "å®¡æ ¸è´¢åŠ¡å•æ®", "is_basic": false },
    { "action": "export", "label": "å¯¼å‡º", "description": "å¯¼å‡ºè´¢åŠ¡æŠ¥è¡¨", "is_basic": false }
  ]
}
```

## 2ï¸âƒ£ ç¬¬äºŒæ­¥ï¼šä¸ºè§’è‰²åˆ†é…æƒé™

### ä¸åŒè§’è‰²çš„æƒé™é…ç½®

```javascript
// è§’è‰²ï¼šè´¢åŠ¡ä¸»ç®¡
{
  "name": "è´¢åŠ¡ä¸»ç®¡",
  "menu_permissions": {
    "finance": ["read", "create", "update", "delete", "pending", "verify", "audit", "export"]
  }
}

// è§’è‰²ï¼šè´¢åŠ¡ä¸“å‘˜
{
  "name": "è´¢åŠ¡ä¸“å‘˜",
  "menu_permissions": {
    "finance": ["read", "create", "pending"]  // åªèƒ½æŸ¥çœ‹ã€åˆ›å»ºã€æŒ‚è´¦
  }
}

// è§’è‰²ï¼šè´¢åŠ¡æŸ¥è¯¢
{
  "name": "è´¢åŠ¡æŸ¥è¯¢",
  "menu_permissions": {
    "finance": ["read", "export"]  // åªèƒ½æŸ¥çœ‹å’Œå¯¼å‡º
  }
}
```

## 3ï¸âƒ£ ç¬¬ä¸‰æ­¥ï¼šé…ç½®è·¯ç”±

### Gateway è·¯ç”±é…ç½®

```go
// cmd/gateway/main.go

func setupFinanceRoutes(r *gin.RouterGroup) {
    finance := r.Group("/finance")
    {
        // æ‰€æœ‰è¯·æ±‚éƒ½ä¼šç»è¿‡ Gateway çš„ Casbin ä¸­é—´ä»¶
        
        // è®¢å•ç›¸å…³ï¼ˆåŸºç¡€ CRUDï¼‰
        finance.GET("", financeHandler.ListOrders)          // â†’ read
        finance.GET("/:id", financeHandler.GetOrder)        // â†’ read
        finance.POST("", financeHandler.CreateOrder)        // â†’ create
        finance.PUT("/:id", financeHandler.UpdateOrder)     // â†’ update
        finance.DELETE("/:id", financeHandler.DeleteOrder)  // â†’ delete
        
        // ä¸šåŠ¡æ“ä½œï¼ˆéœ€è¦åœ¨ service å±‚å†æ¬¡æ£€æŸ¥ï¼‰
        finance.POST("/action", financeHandler.HandleAction) // â†’ createï¼ˆGateway åªèƒ½æ£€æŸ¥åˆ°è¿™é‡Œï¼‰
        finance.POST("/export", financeHandler.ExportReport) // â†’ createï¼ˆGateway åªèƒ½æ£€æŸ¥åˆ°è¿™é‡Œï¼‰
    }
}
```

## 4ï¸âƒ£ ç¬¬å››æ­¥ï¼šå®ç° Service å±‚

### service/finance.go

```go
package services

import (
    "context"
    "fmt"
    "log"
    "time"
    
    "mule-cloud/core/casbin"
    "mule-cloud/internal/models"
    "mule-cloud/internal/repository"
)

type FinanceService struct {
    orderRepo *repository.OrderRepository
}

func NewFinanceService() *FinanceService {
    return &FinanceService{
        orderRepo: repository.NewOrderRepository(),
    }
}

// ============ åŸºç¡€ CRUDï¼ˆGateway å·²æ£€æŸ¥ï¼‰ ============

// CreateOrder åˆ›å»ºè®¢å•
// Gateway å·²æ£€æŸ¥ "create" æƒé™ï¼Œè¿™é‡Œä¸éœ€è¦å†æ£€æŸ¥
func (s *FinanceService) CreateOrder(ctx context.Context, order *models.Order) error {
    return s.orderRepo.Create(ctx, order)
}

// GetOrder è·å–è®¢å•
// Gateway å·²æ£€æŸ¥ "read" æƒé™
func (s *FinanceService) GetOrder(ctx context.Context, orderID string) (*models.Order, error) {
    return s.orderRepo.GetByID(ctx, orderID)
}

// UpdateOrder æ›´æ–°è®¢å•
// Gateway å·²æ£€æŸ¥ "update" æƒé™
func (s *FinanceService) UpdateOrder(ctx context.Context, orderID string, updates map[string]interface{}) error {
    return s.orderRepo.Update(ctx, orderID, updates)
}

// DeleteOrder åˆ é™¤è®¢å•
// Gateway å·²æ£€æŸ¥ "delete" æƒé™
func (s *FinanceService) DeleteOrder(ctx context.Context, orderID string) error {
    return s.orderRepo.Delete(ctx, orderID)
}

// ============ ä¸šåŠ¡æ“ä½œï¼ˆéœ€è¦æ‰‹åŠ¨æ£€æŸ¥æƒé™ï¼‰ ============

// HandleOrderAction å¤„ç†è®¢å•ä¸šåŠ¡æ“ä½œ
func (s *FinanceService) HandleOrderAction(ctx context.Context, userID, tenantID, action, orderID string) error {
    // æ ¹æ® action è·¯ç”±åˆ°ä¸åŒçš„å¤„ç†å‡½æ•°
    switch action {
    case "pending":
        return s.PendingOrder(ctx, userID, tenantID, orderID)
    case "verify":
        return s.VerifyOrder(ctx, userID, tenantID, orderID)
    case "audit":
        return s.AuditOrder(ctx, userID, tenantID, orderID)
    default:
        return fmt.Errorf("æœªçŸ¥æ“ä½œ: %s", action)
    }
}

// PendingOrder æŒ‚è´¦
func (s *FinanceService) PendingOrder(ctx context.Context, userID, tenantID, orderID string) error {
    // ğŸ”’ ç¬¬äºŒå±‚æƒé™æ£€æŸ¥ï¼šæ£€æŸ¥ "pending" æƒé™
    hasPermission := casbin.CheckUserPermission(tenantID, userID, "/finance", "pending")
    if !hasPermission {
        log.Printf("[æƒé™æ‹’ç»] ç”¨æˆ· %s æ— æŒ‚è´¦æƒé™", userID)
        return fmt.Errorf("æ— æŒ‚è´¦æƒé™")
    }
    
    // è·å–è®¢å•
    order, err := s.orderRepo.GetByID(ctx, orderID)
    if err != nil {
        return fmt.Errorf("è®¢å•ä¸å­˜åœ¨: %w", err)
    }
    
    // ä¸šåŠ¡è§„åˆ™æ£€æŸ¥
    if order.Status == "pending" {
        return fmt.Errorf("è®¢å•å·²ç»æ˜¯æŒ‚è´¦çŠ¶æ€")
    }
    if order.Status == "paid" {
        return fmt.Errorf("å·²æ”¯ä»˜è®¢å•ä¸èƒ½æŒ‚è´¦")
    }
    
    // æ‰§è¡ŒæŒ‚è´¦é€»è¾‘
    updates := map[string]interface{}{
        "status":       "pending",
        "pending_by":   userID,
        "pending_at":   time.Now().Unix(),
        "updated_by":   userID,
        "updated_at":   time.Now().Unix(),
    }
    
    err = s.orderRepo.Update(ctx, orderID, updates)
    if err != nil {
        return fmt.Errorf("æŒ‚è´¦å¤±è´¥: %w", err)
    }
    
    log.Printf("[æŒ‚è´¦æˆåŠŸ] è®¢å•: %s, æ“ä½œäºº: %s", orderID, userID)
    return nil
}

// VerifyOrder æ ¸é”€
func (s *FinanceService) VerifyOrder(ctx context.Context, userID, tenantID, orderID string) error {
    // ğŸ”’ ç¬¬äºŒå±‚æƒé™æ£€æŸ¥ï¼šæ£€æŸ¥ "verify" æƒé™
    hasPermission := casbin.CheckUserPermission(tenantID, userID, "/finance", "verify")
    if !hasPermission {
        log.Printf("[æƒé™æ‹’ç»] ç”¨æˆ· %s æ— æ ¸é”€æƒé™", userID)
        return fmt.Errorf("æ— æ ¸é”€æƒé™")
    }
    
    // è·å–è®¢å•
    order, err := s.orderRepo.GetByID(ctx, orderID)
    if err != nil {
        return fmt.Errorf("è®¢å•ä¸å­˜åœ¨: %w", err)
    }
    
    // ä¸šåŠ¡è§„åˆ™æ£€æŸ¥
    if order.Status != "pending" {
        return fmt.Errorf("åªèƒ½æ ¸é”€æŒ‚è´¦çŠ¶æ€çš„è®¢å•")
    }
    
    // æ‰§è¡Œæ ¸é”€é€»è¾‘
    updates := map[string]interface{}{
        "status":       "verified",
        "verified_by":  userID,
        "verified_at":  time.Now().Unix(),
        "updated_by":   userID,
        "updated_at":   time.Now().Unix(),
    }
    
    err = s.orderRepo.Update(ctx, orderID, updates)
    if err != nil {
        return fmt.Errorf("æ ¸é”€å¤±è´¥: %w", err)
    }
    
    log.Printf("[æ ¸é”€æˆåŠŸ] è®¢å•: %s, æ“ä½œäºº: %s", orderID, userID)
    return nil
}

// AuditOrder å®¡æ ¸
func (s *FinanceService) AuditOrder(ctx context.Context, userID, tenantID, orderID string) error {
    // ğŸ”’ ç¬¬äºŒå±‚æƒé™æ£€æŸ¥ï¼šæ£€æŸ¥ "audit" æƒé™
    hasPermission := casbin.CheckUserPermission(tenantID, userID, "/finance", "audit")
    if !hasPermission {
        log.Printf("[æƒé™æ‹’ç»] ç”¨æˆ· %s æ— å®¡æ ¸æƒé™", userID)
        return fmt.Errorf("æ— å®¡æ ¸æƒé™")
    }
    
    // æ‰§è¡Œå®¡æ ¸é€»è¾‘...
    log.Printf("[å®¡æ ¸æˆåŠŸ] è®¢å•: %s, æ“ä½œäºº: %s", orderID, userID)
    return nil
}

// ExportReport å¯¼å‡ºæŠ¥è¡¨
func (s *FinanceService) ExportReport(ctx context.Context, userID, tenantID string, params map[string]interface{}) ([]byte, error) {
    // ğŸ”’ ç¬¬äºŒå±‚æƒé™æ£€æŸ¥ï¼šæ£€æŸ¥ "export" æƒé™
    hasPermission := casbin.CheckUserPermission(tenantID, userID, "/finance", "export")
    if !hasPermission {
        log.Printf("[æƒé™æ‹’ç»] ç”¨æˆ· %s æ— å¯¼å‡ºæƒé™", userID)
        return nil, fmt.Errorf("æ— å¯¼å‡ºæƒé™")
    }
    
    // ç”Ÿæˆ Excel
    log.Printf("[å¯¼å‡ºæŠ¥è¡¨] æ“ä½œäºº: %s, å‚æ•°: %+v", userID, params)
    
    // è¿™é‡Œåº”è¯¥è°ƒç”¨ Excel ç”Ÿæˆé€»è¾‘
    excelData := []byte("å¯¼å‡ºçš„æ•°æ®...")
    return excelData, nil
}
```

## 5ï¸âƒ£ ç¬¬äº”æ­¥ï¼šå®ç° Transport å±‚

### transport/finance.go

```go
package transport

import (
    "mule-cloud/app/finance/dto"
    "mule-cloud/app/finance/services"
    "mule-cloud/core/response"
    
    "github.com/gin-gonic/gin"
)

// HandleOrderActionHandler å¤„ç†è®¢å•ä¸šåŠ¡æ“ä½œ
func HandleOrderActionHandler(financeSvc *services.FinanceService) gin.HandlerFunc {
    return func(c *gin.Context) {
        // ä» JWT ä¸­é—´ä»¶è·å–ç”¨æˆ·ä¿¡æ¯
        userID := c.GetString("userID")
        tenantID := c.GetString("tenantID")
        
        // è§£æè¯·æ±‚
        var req dto.OrderActionRequest
        if err := c.ShouldBindJSON(&req); err != nil {
            response.Error(c, "å‚æ•°é”™è¯¯: "+err.Error())
            return
        }
        
        // è°ƒç”¨ service å±‚ï¼ˆservice å±‚ä¼šæ£€æŸ¥ä¸šåŠ¡æƒé™ï¼‰
        err := financeSvc.HandleOrderAction(c.Request.Context(), userID, tenantID, req.Action, req.OrderID)
        if err != nil {
            response.Error(c, err.Error())
            return
        }
        
        response.SuccessWithMsg(c, "æ“ä½œæˆåŠŸ", nil)
    }
}

// ExportReportHandler å¯¼å‡ºæŠ¥è¡¨
func ExportReportHandler(financeSvc *services.FinanceService) gin.HandlerFunc {
    return func(c *gin.Context) {
        userID := c.GetString("userID")
        tenantID := c.GetString("tenantID")
        
        var req dto.ExportRequest
        if err := c.ShouldBindJSON(&req); err != nil {
            response.Error(c, "å‚æ•°é”™è¯¯: "+err.Error())
            return
        }
        
        // è°ƒç”¨ service å±‚ï¼ˆservice å±‚ä¼šæ£€æŸ¥å¯¼å‡ºæƒé™ï¼‰
        excelData, err := financeSvc.ExportReport(c.Request.Context(), userID, tenantID, req.Params)
        if err != nil {
            response.Error(c, err.Error())
            return
        }
        
        // è¿”å› Excel æ–‡ä»¶
        c.Header("Content-Type", "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet")
        c.Header("Content-Disposition", "attachment; filename=report.xlsx")
        c.Data(200, "application/octet-stream", excelData)
    }
}
```

## 6ï¸âƒ£ ç¬¬å…­æ­¥ï¼šå‰ç«¯å®ç°

### å‰ç«¯é¡µé¢ - finance/index.vue

```vue
<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { NButton, NDataTable, NSpace, NPopconfirm } from 'naive-ui'
import { usePermission } from '@/hooks'
import { 
  fetchOrderList, 
  handleOrderAction, 
  exportFinanceReport 
} from '@/service/api/finance'

const { hasAction } = usePermission()

const tableData = ref<any[]>([])

// åŠ è½½è®¢å•åˆ—è¡¨ï¼ˆéœ€è¦ read æƒé™ï¼‰
async function loadOrders() {
  if (!hasAction('finance', 'read')) {
    window.$message.error('æ— æŸ¥çœ‹æƒé™')
    return
  }
  
  const { data } = await fetchOrderList()
  tableData.value = data
}

// æŒ‚è´¦
async function handlePending(row: any) {
  try {
    await handleOrderAction({
      action: 'pending',
      orderId: row.id,
    })
    window.$message.success('æŒ‚è´¦æˆåŠŸ')
    loadOrders()
  }
  catch (error: any) {
    window.$message.error(error.message || 'æŒ‚è´¦å¤±è´¥')
  }
}

// æ ¸é”€
async function handleVerify(row: any) {
  try {
    await handleOrderAction({
      action: 'verify',
      orderId: row.id,
    })
    window.$message.success('æ ¸é”€æˆåŠŸ')
    loadOrders()
  }
  catch (error: any) {
    window.$message.error(error.message || 'æ ¸é”€å¤±è´¥')
  }
}

// å®¡æ ¸
async function handleAudit(row: any) {
  try {
    await handleOrderAction({
      action: 'audit',
      orderId: row.id,
    })
    window.$message.success('å®¡æ ¸æˆåŠŸ')
    loadOrders()
  }
  catch (error: any) {
    window.$message.error(error.message || 'å®¡æ ¸å¤±è´¥')
  }
}

// å¯¼å‡º
async function handleExport() {
  try {
    const blob = await exportFinanceReport({ dateRange: ['2025-01-01', '2025-01-31'] })
    
    // ä¸‹è½½æ–‡ä»¶
    const url = window.URL.createObjectURL(blob)
    const link = document.createElement('a')
    link.href = url
    link.download = 'è´¢åŠ¡æŠ¥è¡¨.xlsx'
    link.click()
    
    window.$message.success('å¯¼å‡ºæˆåŠŸ')
  }
  catch (error: any) {
    window.$message.error(error.message || 'å¯¼å‡ºå¤±è´¥')
  }
}

const columns = [
  { title: 'è®¢å•å·', key: 'orderNo' },
  { title: 'å®¢æˆ·', key: 'customer' },
  { title: 'é‡‘é¢', key: 'amount' },
  { title: 'çŠ¶æ€', key: 'status' },
  {
    title: 'æ“ä½œ',
    key: 'actions',
    render: (row: any) => {
      return (
        <NSpace>
          {/* åŸºç¡€æƒé™ï¼šç¼–è¾‘ */}
          {hasAction('finance', 'update') && (
            <NButton text type="primary" onClick={() => handleEdit(row)}>
              ç¼–è¾‘
            </NButton>
          )}
          
          {/* ä¸šåŠ¡æƒé™ï¼šæŒ‚è´¦ï¼ˆåªæœ‰æœªæŒ‚è´¦çš„è®¢å•æ‰æ˜¾ç¤ºï¼‰ */}
          {hasAction('finance', 'pending') && row.status !== 'pending' && (
            <NButton text type="warning" onClick={() => handlePending(row)}>
              æŒ‚è´¦
            </NButton>
          )}
          
          {/* ä¸šåŠ¡æƒé™ï¼šæ ¸é”€ï¼ˆåªæœ‰æŒ‚è´¦çŠ¶æ€æ‰æ˜¾ç¤ºï¼‰ */}
          {hasAction('finance', 'verify') && row.status === 'pending' && (
            <NButton text type="success" onClick={() => handleVerify(row)}>
              æ ¸é”€
            </NButton>
          )}
          
          {/* ä¸šåŠ¡æƒé™ï¼šå®¡æ ¸ */}
          {hasAction('finance', 'audit') && (
            <NButton text type="info" onClick={() => handleAudit(row)}>
              å®¡æ ¸
            </NButton>
          )}
          
          {/* åŸºç¡€æƒé™ï¼šåˆ é™¤ */}
          {hasAction('finance', 'delete') && (
            <NPopconfirm onPositiveClick={() => handleDelete(row)}>
              {{
                default: () => 'ç¡®å®šåˆ é™¤å—ï¼Ÿ',
                trigger: () => (
                  <NButton text type="error">åˆ é™¤</NButton>
                ),
              }}
            </NPopconfirm>
          )}
        </NSpace>
      )
    },
  },
]

onMounted(() => {
  loadOrders()
})
</script>

<template>
  <div class="p-4">
    <div class="mb-4 flex justify-between">
      <h2 class="text-xl font-bold">è´¢åŠ¡ç®¡ç†</h2>
      <NSpace>
        {/* åŸºç¡€æƒé™ï¼šæ–°å»º */}
        <NButton v-if="hasAction('finance', 'create')" type="primary" @click="handleCreate">
          æ–°å»ºè®¢å•
        </NButton>
        
        {/* ä¸šåŠ¡æƒé™ï¼šå¯¼å‡º */}
        <NButton v-if="hasAction('finance', 'export')" @click="handleExport">
          å¯¼å‡ºæŠ¥è¡¨
        </NButton>
      </NSpace>
    </div>
    
    <NDataTable :columns="columns" :data="tableData" />
  </div>
</template>
```

## 7ï¸âƒ£ å®Œæ•´è¯·æ±‚æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·ç‚¹å‡»"æŒ‚è´¦"æŒ‰é’®                                              â”‚
â”‚  â†’ å‰ç«¯è°ƒç”¨: handleOrderAction({ action: 'pending', ... })     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HTTP è¯·æ±‚                                                       â”‚
â”‚  POST /admin/finance/action                                     â”‚
â”‚  Body: { "action": "pending", "orderId": "123" }                â”‚
â”‚  Headers: { "Authorization": "Bearer xxx" }                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Gateway ç¬¬ä¸€å±‚æ£€æŸ¥ âœ…                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Casbin ä¸­é—´ä»¶                                            â”‚ â”‚
â”‚  â”‚  - æå–: method=POST, path=/admin/finance/action         â”‚ â”‚
â”‚  â”‚  - æ˜ å°„: action="create"                                 â”‚ â”‚
â”‚  â”‚  - æ£€æŸ¥: casbin.CheckPermission(user, "/finance", "create")â”‚ â”‚
â”‚  â”‚  - ç»“æœ: âœ… é€šè¿‡ï¼ˆç”¨æˆ·æœ‰ create æƒé™ï¼‰                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è·¯ç”±åˆ° Transport å±‚                                             â”‚
â”‚  HandleOrderActionHandler()                                     â”‚
â”‚  - è§£æ userID, tenantID                                        â”‚
â”‚  - è§£æ req.Action = "pending"                                  â”‚
â”‚  - è°ƒç”¨: financeSvc.HandleOrderAction(userID, tenantID, ...)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Service å±‚ç¬¬äºŒå±‚æ£€æŸ¥ âœ…                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  financeSvc.PendingOrder()                                â”‚ â”‚
â”‚  â”‚  - æ£€æŸ¥: casbin.CheckUserPermission(                      â”‚ â”‚
â”‚  â”‚           tenantID, userID, "/finance", "pending"        â”‚ â”‚
â”‚  â”‚         )                                                 â”‚ â”‚
â”‚  â”‚  - ç»“æœ: âœ… é€šè¿‡ï¼ˆç”¨æˆ·æœ‰ pending æƒé™ï¼‰                  â”‚ â”‚
â”‚  â”‚  - æ‰§è¡ŒæŒ‚è´¦é€»è¾‘                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿”å›æˆåŠŸ                                                        â”‚
â”‚  { "code": 0, "msg": "æ“ä½œæˆåŠŸ" }                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ å…³é”®ç‚¹æ€»ç»“

### 1. Gateway å±‚åªåš HTTP è®¿é—®æ§åˆ¶
- âœ… `POST /finance/action` â†’ æ£€æŸ¥ `create` æƒé™
- âŒ ä¸çŸ¥é“å…·ä½“æ˜¯ä»€ä¹ˆä¸šåŠ¡æ“ä½œ

### 2. Service å±‚åšä¸šåŠ¡æ“ä½œæ§åˆ¶
- âœ… è§£æ `action="pending"` â†’ æ£€æŸ¥ `pending` æƒé™
- âœ… è§£æ `action="verify"` â†’ æ£€æŸ¥ `verify` æƒé™

### 3. å‰ç«¯ç²¾ç¡®æ§åˆ¶æŒ‰é’®æ˜¾ç¤º
- âœ… `hasAction('finance', 'pending')` â†’ æ˜¾ç¤º"æŒ‚è´¦"æŒ‰é’®
- âœ… `hasAction('finance', 'verify')` â†’ æ˜¾ç¤º"æ ¸é”€"æŒ‰é’®

### 4. æƒé™åŒæ­¥æ˜¯è‡ªåŠ¨çš„
- âœ… è§’è‰²åˆ†é…æƒé™æ—¶è‡ªåŠ¨åŒæ­¥åˆ° Casbin
- âœ… ç”¨æˆ·ç™»å½•æ—¶è‡ªåŠ¨è·å–æ‰€æœ‰æƒé™

## ğŸ“Š æƒé™æµè½¬å…¨é“¾è·¯

```
1. ç®¡ç†å‘˜é…ç½®èœå•æƒé™
   â†’ Menu.available_permissions = ["read", "create", "pending", "verify"]

2. ç®¡ç†å‘˜ä¸ºè§’è‰²åˆ†é…æƒé™
   â†’ Role.menu_permissions = {"finance": ["read", "create", "pending"]}
   â†’ è‡ªåŠ¨åŒæ­¥åˆ° Casbin ç­–ç•¥è¡¨

3. ç”¨æˆ·ç™»å½•
   â†’ æŸ¥è¯¢ç”¨æˆ·æ‰€æœ‰è§’è‰²çš„æƒé™ï¼ˆåˆå¹¶ï¼‰
   â†’ userInfo.menu_permissions = {"finance": ["read", "create", "pending"]}

4. å‰ç«¯æ˜¾ç¤ºæŒ‰é’®
   â†’ hasAction('finance', 'pending') â†’ true â†’ æ˜¾ç¤º"æŒ‚è´¦"æŒ‰é’®
   â†’ hasAction('finance', 'verify') â†’ false â†’ éšè—"æ ¸é”€"æŒ‰é’®

5. ç”¨æˆ·ç‚¹å‡»"æŒ‚è´¦"
   â†’ POST /finance/action
   â†’ Gateway: æ£€æŸ¥ "create" æƒé™ âœ…
   â†’ Service: æ£€æŸ¥ "pending" æƒé™ âœ…
   â†’ æ‰§è¡ŒæŒ‚è´¦é€»è¾‘
```

## ğŸ‰ å®Œæˆï¼

ç°åœ¨ä½ æœ‰äº†ä¸€ä¸ª**å®Œæ•´çš„ã€å¯è¿è¡Œçš„**è´¢åŠ¡æ¨¡å—ç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ä¸¤å±‚æƒé™æ£€æŸ¥æ¶æ„ï¼

