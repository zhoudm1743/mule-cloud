# 业务权限实战示例 - 财务模块

## 📦 完整示例：财务订单管理

这个示例展示如何在一个真实的业务模块中实现两层权限检查。

## 1️⃣ 第一步：配置菜单权限

### 在菜单管理界面配置

```javascript
// 菜单：finance
{
  "name": "finance",
  "path": "/finance",
  "title": "财务管理",
  "available_permissions": [
    // 基础权限（CRUD）
    { "action": "read", "label": "查看", "is_basic": true },
    { "action": "create", "label": "创建", "is_basic": true },
    { "action": "update", "label": "修改", "is_basic": true },
    { "action": "delete", "label": "删除", "is_basic": true },
    
    // 业务权限
    { "action": "pending", "label": "挂账", "description": "将订单标记为挂账", "is_basic": false },
    { "action": "verify", "label": "核销", "description": "核销挂账订单", "is_basic": false },
    { "action": "audit", "label": "审核", "description": "审核财务单据", "is_basic": false },
    { "action": "export", "label": "导出", "description": "导出财务报表", "is_basic": false }
  ]
}
```

## 2️⃣ 第二步：为角色分配权限

### 不同角色的权限配置

```javascript
// 角色：财务主管
{
  "name": "财务主管",
  "menu_permissions": {
    "finance": ["read", "create", "update", "delete", "pending", "verify", "audit", "export"]
  }
}

// 角色：财务专员
{
  "name": "财务专员",
  "menu_permissions": {
    "finance": ["read", "create", "pending"]  // 只能查看、创建、挂账
  }
}

// 角色：财务查询
{
  "name": "财务查询",
  "menu_permissions": {
    "finance": ["read", "export"]  // 只能查看和导出
  }
}
```

## 3️⃣ 第三步：配置路由

### Gateway 路由配置

```go
// cmd/gateway/main.go

func setupFinanceRoutes(r *gin.RouterGroup) {
    finance := r.Group("/finance")
    {
        // 所有请求都会经过 Gateway 的 Casbin 中间件
        
        // 订单相关（基础 CRUD）
        finance.GET("", financeHandler.ListOrders)          // → read
        finance.GET("/:id", financeHandler.GetOrder)        // → read
        finance.POST("", financeHandler.CreateOrder)        // → create
        finance.PUT("/:id", financeHandler.UpdateOrder)     // → update
        finance.DELETE("/:id", financeHandler.DeleteOrder)  // → delete
        
        // 业务操作（需要在 service 层再次检查）
        finance.POST("/action", financeHandler.HandleAction) // → create（Gateway 只能检查到这里）
        finance.POST("/export", financeHandler.ExportReport) // → create（Gateway 只能检查到这里）
    }
}
```

## 4️⃣ 第四步：实现 Service 层

### service/finance.go

```go
package services

import (
    "context"
    "fmt"
    "log"
    "time"
    
    "mule-cloud/core/casbin"
    "mule-cloud/internal/models"
    "mule-cloud/internal/repository"
)

type FinanceService struct {
    orderRepo *repository.OrderRepository
}

func NewFinanceService() *FinanceService {
    return &FinanceService{
        orderRepo: repository.NewOrderRepository(),
    }
}

// ============ 基础 CRUD（Gateway 已检查） ============

// CreateOrder 创建订单
// Gateway 已检查 "create" 权限，这里不需要再检查
func (s *FinanceService) CreateOrder(ctx context.Context, order *models.Order) error {
    return s.orderRepo.Create(ctx, order)
}

// GetOrder 获取订单
// Gateway 已检查 "read" 权限
func (s *FinanceService) GetOrder(ctx context.Context, orderID string) (*models.Order, error) {
    return s.orderRepo.GetByID(ctx, orderID)
}

// UpdateOrder 更新订单
// Gateway 已检查 "update" 权限
func (s *FinanceService) UpdateOrder(ctx context.Context, orderID string, updates map[string]interface{}) error {
    return s.orderRepo.Update(ctx, orderID, updates)
}

// DeleteOrder 删除订单
// Gateway 已检查 "delete" 权限
func (s *FinanceService) DeleteOrder(ctx context.Context, orderID string) error {
    return s.orderRepo.Delete(ctx, orderID)
}

// ============ 业务操作（需要手动检查权限） ============

// HandleOrderAction 处理订单业务操作
func (s *FinanceService) HandleOrderAction(ctx context.Context, userID, tenantID, action, orderID string) error {
    // 根据 action 路由到不同的处理函数
    switch action {
    case "pending":
        return s.PendingOrder(ctx, userID, tenantID, orderID)
    case "verify":
        return s.VerifyOrder(ctx, userID, tenantID, orderID)
    case "audit":
        return s.AuditOrder(ctx, userID, tenantID, orderID)
    default:
        return fmt.Errorf("未知操作: %s", action)
    }
}

// PendingOrder 挂账
func (s *FinanceService) PendingOrder(ctx context.Context, userID, tenantID, orderID string) error {
    // 🔒 第二层权限检查：检查 "pending" 权限
    hasPermission := casbin.CheckUserPermission(tenantID, userID, "/finance", "pending")
    if !hasPermission {
        log.Printf("[权限拒绝] 用户 %s 无挂账权限", userID)
        return fmt.Errorf("无挂账权限")
    }
    
    // 获取订单
    order, err := s.orderRepo.GetByID(ctx, orderID)
    if err != nil {
        return fmt.Errorf("订单不存在: %w", err)
    }
    
    // 业务规则检查
    if order.Status == "pending" {
        return fmt.Errorf("订单已经是挂账状态")
    }
    if order.Status == "paid" {
        return fmt.Errorf("已支付订单不能挂账")
    }
    
    // 执行挂账逻辑
    updates := map[string]interface{}{
        "status":       "pending",
        "pending_by":   userID,
        "pending_at":   time.Now().Unix(),
        "updated_by":   userID,
        "updated_at":   time.Now().Unix(),
    }
    
    err = s.orderRepo.Update(ctx, orderID, updates)
    if err != nil {
        return fmt.Errorf("挂账失败: %w", err)
    }
    
    log.Printf("[挂账成功] 订单: %s, 操作人: %s", orderID, userID)
    return nil
}

// VerifyOrder 核销
func (s *FinanceService) VerifyOrder(ctx context.Context, userID, tenantID, orderID string) error {
    // 🔒 第二层权限检查：检查 "verify" 权限
    hasPermission := casbin.CheckUserPermission(tenantID, userID, "/finance", "verify")
    if !hasPermission {
        log.Printf("[权限拒绝] 用户 %s 无核销权限", userID)
        return fmt.Errorf("无核销权限")
    }
    
    // 获取订单
    order, err := s.orderRepo.GetByID(ctx, orderID)
    if err != nil {
        return fmt.Errorf("订单不存在: %w", err)
    }
    
    // 业务规则检查
    if order.Status != "pending" {
        return fmt.Errorf("只能核销挂账状态的订单")
    }
    
    // 执行核销逻辑
    updates := map[string]interface{}{
        "status":       "verified",
        "verified_by":  userID,
        "verified_at":  time.Now().Unix(),
        "updated_by":   userID,
        "updated_at":   time.Now().Unix(),
    }
    
    err = s.orderRepo.Update(ctx, orderID, updates)
    if err != nil {
        return fmt.Errorf("核销失败: %w", err)
    }
    
    log.Printf("[核销成功] 订单: %s, 操作人: %s", orderID, userID)
    return nil
}

// AuditOrder 审核
func (s *FinanceService) AuditOrder(ctx context.Context, userID, tenantID, orderID string) error {
    // 🔒 第二层权限检查：检查 "audit" 权限
    hasPermission := casbin.CheckUserPermission(tenantID, userID, "/finance", "audit")
    if !hasPermission {
        log.Printf("[权限拒绝] 用户 %s 无审核权限", userID)
        return fmt.Errorf("无审核权限")
    }
    
    // 执行审核逻辑...
    log.Printf("[审核成功] 订单: %s, 操作人: %s", orderID, userID)
    return nil
}

// ExportReport 导出报表
func (s *FinanceService) ExportReport(ctx context.Context, userID, tenantID string, params map[string]interface{}) ([]byte, error) {
    // 🔒 第二层权限检查：检查 "export" 权限
    hasPermission := casbin.CheckUserPermission(tenantID, userID, "/finance", "export")
    if !hasPermission {
        log.Printf("[权限拒绝] 用户 %s 无导出权限", userID)
        return nil, fmt.Errorf("无导出权限")
    }
    
    // 生成 Excel
    log.Printf("[导出报表] 操作人: %s, 参数: %+v", userID, params)
    
    // 这里应该调用 Excel 生成逻辑
    excelData := []byte("导出的数据...")
    return excelData, nil
}
```

## 5️⃣ 第五步：实现 Transport 层

### transport/finance.go

```go
package transport

import (
    "mule-cloud/app/finance/dto"
    "mule-cloud/app/finance/services"
    "mule-cloud/core/response"
    
    "github.com/gin-gonic/gin"
)

// HandleOrderActionHandler 处理订单业务操作
func HandleOrderActionHandler(financeSvc *services.FinanceService) gin.HandlerFunc {
    return func(c *gin.Context) {
        // 从 JWT 中间件获取用户信息
        userID := c.GetString("userID")
        tenantID := c.GetString("tenantID")
        
        // 解析请求
        var req dto.OrderActionRequest
        if err := c.ShouldBindJSON(&req); err != nil {
            response.Error(c, "参数错误: "+err.Error())
            return
        }
        
        // 调用 service 层（service 层会检查业务权限）
        err := financeSvc.HandleOrderAction(c.Request.Context(), userID, tenantID, req.Action, req.OrderID)
        if err != nil {
            response.Error(c, err.Error())
            return
        }
        
        response.SuccessWithMsg(c, "操作成功", nil)
    }
}

// ExportReportHandler 导出报表
func ExportReportHandler(financeSvc *services.FinanceService) gin.HandlerFunc {
    return func(c *gin.Context) {
        userID := c.GetString("userID")
        tenantID := c.GetString("tenantID")
        
        var req dto.ExportRequest
        if err := c.ShouldBindJSON(&req); err != nil {
            response.Error(c, "参数错误: "+err.Error())
            return
        }
        
        // 调用 service 层（service 层会检查导出权限）
        excelData, err := financeSvc.ExportReport(c.Request.Context(), userID, tenantID, req.Params)
        if err != nil {
            response.Error(c, err.Error())
            return
        }
        
        // 返回 Excel 文件
        c.Header("Content-Type", "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet")
        c.Header("Content-Disposition", "attachment; filename=report.xlsx")
        c.Data(200, "application/octet-stream", excelData)
    }
}
```

## 6️⃣ 第六步：前端实现

### 前端页面 - finance/index.vue

```vue
<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { NButton, NDataTable, NSpace, NPopconfirm } from 'naive-ui'
import { usePermission } from '@/hooks'
import { 
  fetchOrderList, 
  handleOrderAction, 
  exportFinanceReport 
} from '@/service/api/finance'

const { hasAction } = usePermission()

const tableData = ref<any[]>([])

// 加载订单列表（需要 read 权限）
async function loadOrders() {
  if (!hasAction('finance', 'read')) {
    window.$message.error('无查看权限')
    return
  }
  
  const { data } = await fetchOrderList()
  tableData.value = data
}

// 挂账
async function handlePending(row: any) {
  try {
    await handleOrderAction({
      action: 'pending',
      orderId: row.id,
    })
    window.$message.success('挂账成功')
    loadOrders()
  }
  catch (error: any) {
    window.$message.error(error.message || '挂账失败')
  }
}

// 核销
async function handleVerify(row: any) {
  try {
    await handleOrderAction({
      action: 'verify',
      orderId: row.id,
    })
    window.$message.success('核销成功')
    loadOrders()
  }
  catch (error: any) {
    window.$message.error(error.message || '核销失败')
  }
}

// 审核
async function handleAudit(row: any) {
  try {
    await handleOrderAction({
      action: 'audit',
      orderId: row.id,
    })
    window.$message.success('审核成功')
    loadOrders()
  }
  catch (error: any) {
    window.$message.error(error.message || '审核失败')
  }
}

// 导出
async function handleExport() {
  try {
    const blob = await exportFinanceReport({ dateRange: ['2025-01-01', '2025-01-31'] })
    
    // 下载文件
    const url = window.URL.createObjectURL(blob)
    const link = document.createElement('a')
    link.href = url
    link.download = '财务报表.xlsx'
    link.click()
    
    window.$message.success('导出成功')
  }
  catch (error: any) {
    window.$message.error(error.message || '导出失败')
  }
}

const columns = [
  { title: '订单号', key: 'orderNo' },
  { title: '客户', key: 'customer' },
  { title: '金额', key: 'amount' },
  { title: '状态', key: 'status' },
  {
    title: '操作',
    key: 'actions',
    render: (row: any) => {
      return (
        <NSpace>
          {/* 基础权限：编辑 */}
          {hasAction('finance', 'update') && (
            <NButton text type="primary" onClick={() => handleEdit(row)}>
              编辑
            </NButton>
          )}
          
          {/* 业务权限：挂账（只有未挂账的订单才显示） */}
          {hasAction('finance', 'pending') && row.status !== 'pending' && (
            <NButton text type="warning" onClick={() => handlePending(row)}>
              挂账
            </NButton>
          )}
          
          {/* 业务权限：核销（只有挂账状态才显示） */}
          {hasAction('finance', 'verify') && row.status === 'pending' && (
            <NButton text type="success" onClick={() => handleVerify(row)}>
              核销
            </NButton>
          )}
          
          {/* 业务权限：审核 */}
          {hasAction('finance', 'audit') && (
            <NButton text type="info" onClick={() => handleAudit(row)}>
              审核
            </NButton>
          )}
          
          {/* 基础权限：删除 */}
          {hasAction('finance', 'delete') && (
            <NPopconfirm onPositiveClick={() => handleDelete(row)}>
              {{
                default: () => '确定删除吗？',
                trigger: () => (
                  <NButton text type="error">删除</NButton>
                ),
              }}
            </NPopconfirm>
          )}
        </NSpace>
      )
    },
  },
]

onMounted(() => {
  loadOrders()
})
</script>

<template>
  <div class="p-4">
    <div class="mb-4 flex justify-between">
      <h2 class="text-xl font-bold">财务管理</h2>
      <NSpace>
        {/* 基础权限：新建 */}
        <NButton v-if="hasAction('finance', 'create')" type="primary" @click="handleCreate">
          新建订单
        </NButton>
        
        {/* 业务权限：导出 */}
        <NButton v-if="hasAction('finance', 'export')" @click="handleExport">
          导出报表
        </NButton>
      </NSpace>
    </div>
    
    <NDataTable :columns="columns" :data="tableData" />
  </div>
</template>
```

## 7️⃣ 完整请求流程图

```
┌─────────────────────────────────────────────────────────────────┐
│  用户点击"挂账"按钮                                              │
│  → 前端调用: handleOrderAction({ action: 'pending', ... })     │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  HTTP 请求                                                       │
│  POST /admin/finance/action                                     │
│  Body: { "action": "pending", "orderId": "123" }                │
│  Headers: { "Authorization": "Bearer xxx" }                     │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  Gateway 第一层检查 ✅                                           │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  Casbin 中间件                                            │ │
│  │  - 提取: method=POST, path=/admin/finance/action         │ │
│  │  - 映射: action="create"                                 │ │
│  │  - 检查: casbin.CheckPermission(user, "/finance", "create")│ │
│  │  - 结果: ✅ 通过（用户有 create 权限）                   │ │
│  └───────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  路由到 Transport 层                                             │
│  HandleOrderActionHandler()                                     │
│  - 解析 userID, tenantID                                        │
│  - 解析 req.Action = "pending"                                  │
│  - 调用: financeSvc.HandleOrderAction(userID, tenantID, ...)   │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  Service 层第二层检查 ✅                                         │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  financeSvc.PendingOrder()                                │ │
│  │  - 检查: casbin.CheckUserPermission(                      │ │
│  │           tenantID, userID, "/finance", "pending"        │ │
│  │         )                                                 │ │
│  │  - 结果: ✅ 通过（用户有 pending 权限）                  │ │
│  │  - 执行挂账逻辑                                          │ │
│  └───────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  返回成功                                                        │
│  { "code": 0, "msg": "操作成功" }                               │
└─────────────────────────────────────────────────────────────────┘
```

## 🎯 关键点总结

### 1. Gateway 层只做 HTTP 访问控制
- ✅ `POST /finance/action` → 检查 `create` 权限
- ❌ 不知道具体是什么业务操作

### 2. Service 层做业务操作控制
- ✅ 解析 `action="pending"` → 检查 `pending` 权限
- ✅ 解析 `action="verify"` → 检查 `verify` 权限

### 3. 前端精确控制按钮显示
- ✅ `hasAction('finance', 'pending')` → 显示"挂账"按钮
- ✅ `hasAction('finance', 'verify')` → 显示"核销"按钮

### 4. 权限同步是自动的
- ✅ 角色分配权限时自动同步到 Casbin
- ✅ 用户登录时自动获取所有权限

## 📊 权限流转全链路

```
1. 管理员配置菜单权限
   → Menu.available_permissions = ["read", "create", "pending", "verify"]

2. 管理员为角色分配权限
   → Role.menu_permissions = {"finance": ["read", "create", "pending"]}
   → 自动同步到 Casbin 策略表

3. 用户登录
   → 查询用户所有角色的权限（合并）
   → userInfo.menu_permissions = {"finance": ["read", "create", "pending"]}

4. 前端显示按钮
   → hasAction('finance', 'pending') → true → 显示"挂账"按钮
   → hasAction('finance', 'verify') → false → 隐藏"核销"按钮

5. 用户点击"挂账"
   → POST /finance/action
   → Gateway: 检查 "create" 权限 ✅
   → Service: 检查 "pending" 权限 ✅
   → 执行挂账逻辑
```

## 🎉 完成！

现在你有了一个**完整的、可运行的**财务模块示例，展示了如何使用两层权限检查架构！

