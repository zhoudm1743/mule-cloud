# 快速开始指南

## 🎯 5分钟快速体验

### 步骤 1: 启动Consul

```bash
# 打开终端1
consul agent -dev
```

保持终端运行，访问 http://localhost:8500 确认Consul已启动。

### 步骤 2: 启动所有服务

```bash
# 打开新终端，进入项目目录
cd K:\Git\mule-cloud

# 一键启动所有服务
.\scripts\start_all.bat
```

会自动打开5个窗口，分别启动：
1. Test HTTP服务 (:8000)
2. Basic HTTP服务 (:8001)  
3. Admin gRPC服务 (:9000)
4. Product gRPC服务 (:9001)
5. API网关 (:8080)

### 步骤 3: 测试服务

**打开新终端**:

```bash
# 测试网关健康检查
curl http://localhost:8080/gateway/health

# 测试公开接口（无需登录）
curl http://localhost:8080/basic/color/1

# 响应示例
{
  "code": 0,
  "msg": "success",
  "data": {
    "color": {
      "id": "1",
      "name": "红色",
      "hex_code": "#FF0000"
    }
  }
}
```

### 步骤 4: 登录获取Token

```bash
# 管理员登录
curl -X POST http://localhost:8080/api/login ^
  -H "Content-Type: application/json" ^
  -d "{\"username\":\"admin\",\"password\":\"admin123\"}"

# 响应示例
{
  "code": 0,
  "msg": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiMSIsInVzZXJuYW1lIjoiYWRtaW4iLCJyb2xlcyI6WyJhZG1pbiIsInVzZXIiXSwiZXhwIjoxNzM1Njg5NjAwLCJpYXQiOjE3MzU2MDMyMDAsImlzcyI6Im11bGUtY2xvdWQifQ.xxxxx",
    "username": "admin",
    "roles": ["admin", "user"]
  }
}
```

**复制token**（下面用`{TOKEN}`表示）

### 步骤 5: 访问受保护接口

```bash
# 获取管理员信息（需要登录）
curl -H "Authorization: Bearer {TOKEN}" ^
  http://localhost:8080/test/admin/1

# 响应示例
{
  "code": 0,
  "msg": "success",
  "data": {
    "admin": {
      "id": "1",
      "name": "超级管理员",
      "email": "admin@example.com",
      "role": "admin",
      "created_at": "2024-12-01T10:00:00Z"
    },
    "requested_by": "admin"
  }
}
```

### 步骤 6: 测试gRPC服务（可选）

```bash
# 安装grpcurl
go install github.com/fullstorydev/grpcurl/cmd/grpcurl@latest

# 测试Admin gRPC服务
grpcurl -plaintext -d "{\"id\":\"1\"}" ^
  localhost:9000 admin.AdminService/GetAdmin

# 响应示例
{
  "admin": {
    "id": "1",
    "name": "超级管理员",
    "email": "admin@example.com",
    "role": "admin",
    "createdAt": "1701424800"
  }
}
```

## 🎨 完整测试流程

运行自动化测试脚本：

```bash
.\scripts\test_services.bat
```

会自动测试：
- ✅ 网关健康检查
- ✅ 公开接口（颜色、尺寸）
- ✅ 登录接口
- ✅ 显示Token供手动测试

## 📊 服务端口一览

| 服务 | 端口 | URL | 说明 |
|------|------|-----|------|
| Consul | 8500 | http://localhost:8500 | 服务注册中心 |
| Test服务 | 8000 | http://localhost:8000 | Admin管理服务 |
| Basic服务 | 8001 | http://localhost:8001 | 基础服务 |
| Admin gRPC | 9000 | grpc://localhost:9000 | 管理gRPC服务 |
| Product gRPC | 9001 | grpc://localhost:9001 | 产品gRPC服务 |
| **API网关** | **8080** | **http://localhost:8080** | **统一入口** |

## 🔐 测试账号

| 用户名 | 密码 | 角色 | 权限 |
|--------|------|------|------|
| admin | admin123 | admin, user | 所有接口 |
| user | user123 | user | 仅基础接口 |

## 📝 常用API端点

### 公开接口（无需认证）

```bash
# 获取所有颜色
GET http://localhost:8080/basic/color

# 获取指定颜色
GET http://localhost:8080/basic/color/1

# 获取所有尺寸
GET http://localhost:8080/basic/size

# 获取指定尺寸
GET http://localhost:8080/basic/size/2

# 网关健康检查
GET http://localhost:8080/gateway/health

# 登录
POST http://localhost:8080/api/login
Content-Type: application/json

{
  "username": "admin",
  "password": "admin123"
}
```

### 需要认证的接口

```bash
# 获取管理员信息
GET http://localhost:8080/test/admin/{id}
Authorization: Bearer {token}

# 删除管理员
DELETE http://localhost:8080/test/admin/{id}
Authorization: Bearer {token}

# 创建管理员
POST http://localhost:8080/test/admin
Authorization: Bearer {token}
Content-Type: application/json

{
  "name": "新管理员",
  "email": "new@example.com",
  "role": "manager"
}

# 更新管理员
PUT http://localhost:8080/test/admin/{id}
Authorization: Bearer {token}
Content-Type: application/json

{
  "name": "更新的名字",
  "email": "updated@example.com",
  "role": "manager"
}
```

## 🎯 通过网关 vs 直连服务

### ❌ 不推荐：直连服务

```bash
# 直连Test服务（绕过网关）
curl http://localhost:8000/admin/1

# 问题：
# - 没有统一认证
# - 没有限流保护
# - 客户端需要知道所有服务地址
```

### ✅ 推荐：通过网关

```bash
# 通过网关访问（推荐）
curl -H "Authorization: Bearer {token}" ^
  http://localhost:8080/test/admin/1

# 优势：
# - 统一认证鉴权
# - 统一日志监控
# - 限流保护
# - 客户端只需知道网关地址
```

## 🔄 服务重启

### 重启单个服务

```bash
# 在对应的服务窗口按 Ctrl+C
# 然后重新运行

cd test/cmd
go run main.go
```

### 重启所有服务

```bash
# 关闭所有服务窗口
# 重新运行启动脚本
.\scripts\start_all.bat
```

## 🐛 问题排查

### 问题1: 服务无法启动

**检查端口占用**:
```bash
netstat -ano | findstr "8080"
netstat -ano | findstr "8000"
```

**解决**: 关闭占用端口的程序或修改服务端口

### 问题2: Consul连接失败

**检查Consul是否运行**:
```bash
curl http://localhost:8500/v1/status/leader
```

**解决**: 
```bash
consul agent -dev
```

### 问题3: Token验证失败

**常见原因**:
- Token格式错误（应该是 `Bearer {token}`）
- Token过期（24小时）
- JWT密钥不匹配

**解决**: 重新登录获取新Token

### 问题4: Proto文件修改后不生效

**重新生成Proto代码**:
```bash
.\scripts\generate_proto.bat
```

## 📚 下一步

- 📖 [完整架构说明](架构说明.md)
- 🚪 [API网关详解](API网关指南.md)
- 🔐 [JWT认证指南](JWT和gRPC集成指南.md)
- 🏗️ [添加新服务](快速开发指南.md)

## 💡 开发技巧

### 使用Postman测试

1. 导入Collection
2. 设置环境变量:
   - `base_url`: http://localhost:8080
   - `token`: 从登录接口获取
3. 在需要认证的请求中添加:
   - Header: `Authorization` = `Bearer {{token}}`

### 使用VSCode REST Client

创建 `test.http`:

```http
### 登录
POST http://localhost:8080/api/login
Content-Type: application/json

{
  "username": "admin",
  "password": "admin123"
}

### 保存token后使用
@token = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

### 获取管理员
GET http://localhost:8080/test/admin/1
Authorization: Bearer {{token}}
```

---

🎉 **恭喜！您已经完成了快速入门。**

现在您可以：
- ✅ 访问公开接口
- ✅ 登录获取Token
- ✅ 访问受保护接口
- ✅ 调用gRPC服务
- ✅ 开始开发新功能！
