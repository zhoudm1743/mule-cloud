# åŠ¨æ€è·¯ç”±ä¸ç†”æ–­é…ç½®æŒ‡å—

## æ¦‚è¿°

ç½‘å…³ç°åœ¨æ”¯æŒ**åŠ¨æ€è·¯ç”±é…ç½®**å’Œ**åŠ¨æ€ Hystrix ç†”æ–­é…ç½®**ï¼Œé…ç½®å­˜å‚¨åœ¨ Consul KV ä¸­ï¼Œæ— éœ€é‡å¯ç½‘å…³å³å¯ç”Ÿæ•ˆï¼

### ä¸»è¦ç‰¹æ€§

âœ… **åŠ¨æ€è·¯ç”±ç®¡ç†** - æ·»åŠ /ä¿®æ”¹/åˆ é™¤è·¯ç”±æ— éœ€é‡å¯
âœ… **åŠ¨æ€ç†”æ–­é…ç½®** - å®æ—¶è°ƒæ•´ Hystrix å‚æ•°
âœ… **é…ç½®æŒä¹…åŒ–** - æ‰€æœ‰é…ç½®å­˜å‚¨åœ¨ Consul KV
âœ… **è‡ªåŠ¨åŒæ­¥** - æ¯ 10 ç§’è‡ªåŠ¨ä» Consul æ‹‰å–æœ€æ–°é…ç½®
âœ… **é…ç½®è¿ç§»** - é¦–æ¬¡å¯åŠ¨æ—¶è‡ªåŠ¨ä» YAML è¿ç§»åˆ° Consul
âœ… **HTTP API** - æä¾›å®Œæ•´çš„é…ç½®ç®¡ç†æ¥å£

---

## å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨ç½‘å…³

ç¡®ä¿ Consul å·²å¯åŠ¨å¹¶åœ¨ `config/gateway.yaml` ä¸­å¯ç”¨ï¼š

```yaml
consul:
  enabled: true
  address: "127.0.0.1:8500"
```

å¯åŠ¨ç½‘å…³åï¼Œä¼šè‡ªåŠ¨ï¼š
- è¿æ¥åˆ° Consul
- ä»é…ç½®æ–‡ä»¶è¿ç§»è·¯ç”±åˆ° Consul KVï¼ˆå¦‚æœ Consul ä¸­æ²¡æœ‰é…ç½®ï¼‰
- å¯åŠ¨é…ç½®ç›‘å¬å™¨ï¼ˆæ¯ 10 ç§’æ£€æŸ¥æ›´æ–°ï¼‰

### 2. æŸ¥çœ‹å½“å‰é…ç½®

```bash
# æŸ¥çœ‹æ‰€æœ‰è·¯ç”±é…ç½®
curl http://localhost:8080/gateway/admin/routes

# æŸ¥çœ‹æ‰€æœ‰ Hystrix é…ç½®
curl http://localhost:8080/gateway/admin/hystrix
```

---

## åŠ¨æ€è·¯ç”±ç®¡ç† API

### 1. è·å–æ‰€æœ‰è·¯ç”±

**è¯·æ±‚ï¼š**
```bash
GET http://localhost:8080/gateway/admin/routes
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "/auth": {
      "service_name": "authservice",
      "require_auth": false,
      "require_role": []
    },
    "/basic": {
      "service_name": "basicservice",
      "require_auth": false,
      "require_role": []
    },
    "/admin": {
      "service_name": "testservice",
      "require_auth": true,
      "require_role": ["admin"]
    }
  }
}
```

### 2. è·å–æŒ‡å®šè·¯ç”±

**è¯·æ±‚ï¼š**
```bash
GET http://localhost:8080/gateway/admin/routes/auth
```

### 3. æ·»åŠ æ–°è·¯ç”±

**è¯·æ±‚ï¼š**
```bash
POST http://localhost:8080/gateway/admin/routes
Content-Type: application/json

{
  "prefix": "/product",
  "service_name": "productservice",
  "require_auth": true,
  "require_role": ["user"]
}
```

**å“åº”ï¼š**
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "message": "è·¯ç”±æ·»åŠ æˆåŠŸ",
    "prefix": "/product",
    "config": {
      "service_name": "productservice",
      "require_auth": true,
      "require_role": ["user"]
    }
  }
}
```

**âœ¨ ç«‹å³ç”Ÿæ•ˆ** - æ·»åŠ åæœ€å¤š 10 ç§’å†…è‡ªåŠ¨ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯ç½‘å…³ï¼

### 4. æ›´æ–°è·¯ç”±

**è¯·æ±‚ï¼š**
```bash
PUT http://localhost:8080/gateway/admin/routes/product
Content-Type: application/json

{
  "service_name": "productservice",
  "require_auth": true,
  "require_role": ["admin", "user"]
}
```

### 5. åˆ é™¤è·¯ç”±

**è¯·æ±‚ï¼š**
```bash
DELETE http://localhost:8080/gateway/admin/routes/product
```

---

## åŠ¨æ€ Hystrix é…ç½® API

### 1. è·å–æ‰€æœ‰ Hystrix é…ç½®

**è¯·æ±‚ï¼š**
```bash
GET http://localhost:8080/gateway/admin/hystrix
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "authservice": {
      "timeout": 3000,
      "max_concurrent_requests": 100,
      "request_volume_threshold": 20,
      "sleep_window": 5000,
      "error_percent_threshold": 50
    },
    "basicservice": {
      "timeout": 5000,
      "max_concurrent_requests": 100,
      "request_volume_threshold": 20,
      "sleep_window": 5000,
      "error_percent_threshold": 60
    }
  }
}
```

### 2. è·å–æŒ‡å®šæœåŠ¡çš„ Hystrix é…ç½®

**è¯·æ±‚ï¼š**
```bash
GET http://localhost:8080/gateway/admin/hystrix/authservice
```

### 3. æ·»åŠ  Hystrix é…ç½®

**è¯·æ±‚ï¼š**
```bash
POST http://localhost:8080/gateway/admin/hystrix
Content-Type: application/json

{
  "service_name": "productservice",
  "timeout": 4000,
  "max_concurrent_requests": 80,
  "request_volume_threshold": 15,
  "sleep_window": 4000,
  "error_percent_threshold": 55
}
```

**å‚æ•°è¯´æ˜ï¼š**
- `timeout`: è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
- `max_concurrent_requests`: æœ€å¤§å¹¶å‘è¯·æ±‚æ•°
- `request_volume_threshold`: è¯·æ±‚é‡é˜ˆå€¼ï¼ˆè§¦å‘ç†”æ–­çš„æœ€å°è¯·æ±‚æ•°ï¼‰
- `sleep_window`: ç†”æ–­å™¨æ‰“å¼€åå¤šä¹…å°è¯•åŠå¼€ï¼ˆæ¯«ç§’ï¼‰
- `error_percent_threshold`: é”™è¯¯ç‡é˜ˆå€¼ï¼ˆ0-100ï¼‰

**âœ¨ ç«‹å³ç”Ÿæ•ˆ** - é…ç½®ä¼šç«‹å³åº”ç”¨åˆ° Hystrixï¼

### 4. æ›´æ–° Hystrix é…ç½®

**è¯·æ±‚ï¼š**
```bash
PUT http://localhost:8080/gateway/admin/hystrix/productservice
Content-Type: application/json

{
  "timeout": 5000,
  "max_concurrent_requests": 120,
  "request_volume_threshold": 25,
  "sleep_window": 6000,
  "error_percent_threshold": 50
}
```

### 5. åˆ é™¤ Hystrix é…ç½®

**è¯·æ±‚ï¼š**
```bash
DELETE http://localhost:8080/gateway/admin/hystrix/productservice
```

---

## å®æˆ˜åœºæ™¯

### åœºæ™¯ 1: æ·»åŠ æ–°æœåŠ¡

å‡è®¾ä½ å¼€å‘äº†ä¸€ä¸ªæ–°çš„ `order-service` æœåŠ¡ï¼Œå·²æ³¨å†Œåˆ° Consulï¼š

```bash
# 1. æ·»åŠ è·¯ç”±é…ç½®
curl -X POST http://localhost:8080/gateway/admin/routes \
  -H "Content-Type: application/json" \
  -d '{
    "prefix": "/order",
    "service_name": "orderservice",
    "require_auth": true,
    "require_role": ["user"]
  }'

# 2. æ·»åŠ  Hystrix é…ç½®
curl -X POST http://localhost:8080/gateway/admin/hystrix \
  -H "Content-Type: application/json" \
  -d '{
    "service_name": "orderservice",
    "timeout": 3000,
    "max_concurrent_requests": 100,
    "request_volume_threshold": 20,
    "sleep_window": 5000,
    "error_percent_threshold": 50
  }'

# 3. æµ‹è¯•æ–°è·¯ç”±ï¼ˆç­‰å¾… 10 ç§’é…ç½®åŒæ­¥ï¼Œæˆ–ç«‹å³ç”Ÿæ•ˆï¼‰
curl http://localhost:8080/order/list
```

âœ… **å®Œæˆï¼** æ— éœ€é‡å¯ç½‘å…³ï¼Œæ–°æœåŠ¡è·¯ç”±å·²å¯ç”¨ï¼

### åœºæ™¯ 2: è°ƒæ•´ç†”æ–­é˜ˆå€¼

å‡è®¾ `basic-service` ç»å¸¸è¶…æ—¶ï¼Œéœ€è¦è°ƒæ•´ç†”æ–­é…ç½®ï¼š

```bash
# å¢åŠ è¶…æ—¶æ—¶é—´ï¼Œé™ä½ç†”æ–­æ•æ„Ÿåº¦
curl -X PUT http://localhost:8080/gateway/admin/hystrix/basicservice \
  -H "Content-Type: application/json" \
  -d '{
    "timeout": 8000,
    "max_concurrent_requests": 150,
    "request_volume_threshold": 30,
    "sleep_window": 10000,
    "error_percent_threshold": 70
  }'
```

âœ… **ç«‹å³ç”Ÿæ•ˆï¼** Hystrix é…ç½®å®æ—¶æ›´æ–°ï¼

### åœºæ™¯ 3: ä¸´æ—¶å…³é—­æŸä¸ªè·¯ç”±

```bash
# åˆ é™¤è·¯ç”±ï¼ˆæœåŠ¡ä¸å¯è®¿é—®ï¼‰
curl -X DELETE http://localhost:8080/gateway/admin/routes/product

# æ¢å¤è·¯ç”±
curl -X POST http://localhost:8080/gateway/admin/routes \
  -H "Content-Type: application/json" \
  -d '{
    "prefix": "/product",
    "service_name": "productservice",
    "require_auth": true,
    "require_role": ["user"]
  }'
```

---

## Consul KV å­˜å‚¨ç»“æ„

é…ç½®å­˜å‚¨åœ¨ Consul KV ä¸­ï¼Œè·¯å¾„ç»“æ„ï¼š

```
gateway/
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ /auth          -> è·¯ç”±é…ç½®ï¼ˆJSONï¼‰
â”‚   â”œâ”€â”€ /basic         -> è·¯ç”±é…ç½®ï¼ˆJSONï¼‰
â”‚   â”œâ”€â”€ /admin         -> è·¯ç”±é…ç½®ï¼ˆJSONï¼‰
â”‚   â””â”€â”€ /product       -> è·¯ç”±é…ç½®ï¼ˆJSONï¼‰
â””â”€â”€ hystrix/
    â”œâ”€â”€ authservice    -> Hystrix é…ç½®ï¼ˆJSONï¼‰
    â”œâ”€â”€ basicservice   -> Hystrix é…ç½®ï¼ˆJSONï¼‰
    â””â”€â”€ productservice -> Hystrix é…ç½®ï¼ˆJSONï¼‰
```

### ç›´æ¥åœ¨ Consul UI ä¸­ç®¡ç†

ä½ ä¹Ÿå¯ä»¥ç›´æ¥åœ¨ Consul UI (`http://localhost:8500/ui`) ä¸­ç¼–è¾‘é…ç½®ï¼š

1. è¿›å…¥ **Key/Value** é¡µé¢
2. æ‰¾åˆ° `gateway/routes/` æˆ– `gateway/hystrix/`
3. ç¼–è¾‘ JSON é…ç½®
4. ä¿å­˜å 10 ç§’å†…è‡ªåŠ¨åŒæ­¥åˆ°ç½‘å…³

---

## é…ç½®ç›‘å¬æœºåˆ¶

- **è½®è¯¢é—´éš”ï¼š** 10 ç§’
- **é…ç½®æ¥æºï¼š** Consul KV
- **æ•…éšœé™çº§ï¼š** å¦‚æœ Consul ä¸å¯ç”¨ï¼Œä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„é™æ€é…ç½®

### æŸ¥çœ‹æ—¥å¿—

å¯åŠ¨ç½‘å…³æ—¶ä¼šçœ‹åˆ°ï¼š

```
âœ… å¯ç”¨åŠ¨æ€è·¯ç”±ç®¡ç†å™¨ (åŸºäºConsul KV)
ğŸ”„ æ£€æµ‹åˆ°Consulä¸­æ— è·¯ç”±é…ç½®ï¼Œæ­£åœ¨ä»é…ç½®æ–‡ä»¶è¿ç§»...
   âœ“ åŠ è½½è·¯ç”±: /auth -> authservice
   âœ“ åŠ è½½è·¯ç”±: /basic -> basicservice
   âœ“ åŠ è½½è·¯ç”±: /admin -> testservice
âœ… ä»ConsulåŠ è½½äº† 3 ä¸ªè·¯ç”±é…ç½®
ğŸ”„ æ£€æµ‹åˆ°Consulä¸­æ— Hystrixé…ç½®ï¼Œæ­£åœ¨ä»é…ç½®æ–‡ä»¶è¿ç§»...
   âœ“ åŠ è½½Hystrixé…ç½®: authservice (timeout=3000ms)
   âœ“ åŠ è½½Hystrixé…ç½®: basicservice (timeout=5000ms)
âœ… ä»ConsulåŠ è½½äº† 2 ä¸ªHystrixé…ç½®
ğŸ” å¯åŠ¨é…ç½®ç›‘å¬å™¨...
```

---

## æœ€ä½³å®è·µ

### 1. é…ç½®ç‰ˆæœ¬ç®¡ç†

å»ºè®®åœ¨ä¿®æ”¹å‰å¤‡ä»½é…ç½®ï¼š

```bash
# å¯¼å‡ºå½“å‰é…ç½®
curl http://localhost:8080/gateway/admin/routes > routes_backup.json
curl http://localhost:8080/gateway/admin/hystrix > hystrix_backup.json
```

### 2. æµ‹è¯•æ–°é…ç½®

åœ¨ç”Ÿäº§ç¯å¢ƒä¿®æ”¹é…ç½®å‰ï¼Œå…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯ï¼š

```bash
# 1. åœ¨æµ‹è¯•ç¯å¢ƒæ·»åŠ è·¯ç”±
curl -X POST http://test-gateway:8080/gateway/admin/routes -d '{...}'

# 2. æµ‹è¯•è·¯ç”±
curl http://test-gateway:8080/new-route/test

# 3. ç¡®è®¤æ— è¯¯åï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒåº”ç”¨
curl -X POST http://prod-gateway:8080/gateway/admin/routes -d '{...}'
```

### 3. ç›‘æ§é…ç½®å˜æ›´

ä½¿ç”¨ Consul çš„ watch åŠŸèƒ½ç›‘æ§é…ç½®å˜æ›´ï¼š

```bash
consul watch -type=keyprefix -prefix=gateway/ \
  "echo 'Gateway config changed!'"
```

### 4. Hystrix è°ƒä¼˜å»ºè®®

| åœºæ™¯ | è¶…æ—¶æ—¶é—´ | é”™è¯¯ç‡é˜ˆå€¼ | å¹¶å‘æ•° |
|------|---------|----------|--------|
| å¿«é€Ÿ API | 1000-2000ms | 50% | 100+ |
| æ™®é€šæŸ¥è¯¢ | 3000-5000ms | 50-60% | 50-100 |
| å¤æ‚è®¡ç®— | 5000-10000ms | 60-70% | 30-50 |
| å¤–éƒ¨è°ƒç”¨ | 10000-15000ms | 70-80% | 20-30 |

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: é…ç½®ä¸ç”Ÿæ•ˆ

**æ£€æŸ¥é¡¹ï¼š**
1. Consul æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Ÿ
2. ç½‘å…³æ˜¯å¦å¯ç”¨äº† Consulï¼Ÿï¼ˆ`consul.enabled: true`ï¼‰
3. æ˜¯å¦ç­‰å¾…äº† 10 ç§’ï¼Ÿï¼ˆé…ç½®è½®è¯¢é—´éš”ï¼‰
4. æŸ¥çœ‹ç½‘å…³æ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯

**è§£å†³æ–¹æ³•ï¼š**
```bash
# æŸ¥çœ‹ Consul KV
consul kv get -recurse gateway/

# æ‰‹åŠ¨è§¦å‘é‡è½½ï¼ˆå¦‚æœæä¾›äº† APIï¼‰
curl -X POST http://localhost:8080/gateway/admin/reload
```

### é—®é¢˜ 2: Hystrix é…ç½®æœªç”Ÿæ•ˆ

**å¯èƒ½åŸå› ï¼š**
- æœåŠ¡åä¸åŒ¹é…ï¼ˆæ£€æŸ¥ `service_name` æ˜¯å¦æ­£ç¡®ï¼‰
- é…ç½®å€¼æ— æ•ˆï¼ˆå¦‚è¶…æ—¶æ—¶é—´ä¸ºè´Ÿæ•°ï¼‰

**æ£€æŸ¥æ–¹æ³•ï¼š**
```bash
# æŸ¥çœ‹ Hystrix æŒ‡æ ‡
curl http://localhost:8080/gateway/hystrix/metrics/yourservice
```

---

## ä¸é™æ€é…ç½®çš„å¯¹æ¯”

| ç‰¹æ€§ | é™æ€é…ç½®ï¼ˆYAMLï¼‰ | åŠ¨æ€é…ç½®ï¼ˆConsul KVï¼‰ |
|------|----------------|-------------------|
| é…ç½®ä¿®æ”¹ | éœ€è¦é‡å¯ | æ— éœ€é‡å¯ |
| ç”Ÿæ•ˆæ—¶é—´ | é‡å¯åç«‹å³ | æœ€å¤š 10 ç§’ |
| é…ç½®å…±äº« | æ¯ä¸ªå®ä¾‹ç‹¬ç«‹ | å¤šå®ä¾‹å…±äº« |
| ç‰ˆæœ¬ç®¡ç† | Git ç®¡ç† | Consul å†å²è®°å½• |
| æ˜“ç”¨æ€§ | æ–‡ä»¶ç¼–è¾‘ | HTTP API |
| å¯é æ€§ | é«˜ï¼ˆæœ¬åœ°æ–‡ä»¶ï¼‰ | ä¾èµ– Consul |

**å»ºè®®ï¼š** å¼€å‘ç¯å¢ƒä½¿ç”¨ YAMLï¼Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨ Consul KV

---

## API å®Œæ•´åˆ—è¡¨

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | `/gateway/admin/routes` | è·å–æ‰€æœ‰è·¯ç”± |
| GET | `/gateway/admin/routes/:prefix` | è·å–æŒ‡å®šè·¯ç”± |
| POST | `/gateway/admin/routes` | æ·»åŠ è·¯ç”± |
| PUT | `/gateway/admin/routes/:prefix` | æ›´æ–°è·¯ç”± |
| DELETE | `/gateway/admin/routes/:prefix` | åˆ é™¤è·¯ç”± |
| GET | `/gateway/admin/hystrix` | è·å–æ‰€æœ‰ Hystrix é…ç½® |
| GET | `/gateway/admin/hystrix/:service` | è·å–æŒ‡å®š Hystrix é…ç½® |
| POST | `/gateway/admin/hystrix` | æ·»åŠ  Hystrix é…ç½® |
| PUT | `/gateway/admin/hystrix/:service` | æ›´æ–° Hystrix é…ç½® |
| DELETE | `/gateway/admin/hystrix/:service` | åˆ é™¤ Hystrix é…ç½® |
| POST | `/gateway/admin/reload` | æ‰‹åŠ¨è§¦å‘é…ç½®é‡è½½ |

---

## æ€»ç»“

âœ… **åŠ¨æ€è·¯ç”±** - æ— éœ€é‡å¯å³å¯æ·»åŠ æ–°æœåŠ¡  
âœ… **åŠ¨æ€ç†”æ–­** - å®æ—¶è°ƒæ•´æœåŠ¡ä¿æŠ¤ç­–ç•¥  
âœ… **é…ç½®æŒä¹…åŒ–** - Consul KV é›†ä¸­å­˜å‚¨  
âœ… **è‡ªåŠ¨åŒæ­¥** - 10 ç§’å†…è‡ªåŠ¨åº”ç”¨å˜æ›´  
âœ… **ç®€å•æ˜“ç”¨** - HTTP API ç®¡ç†é…ç½®  

**ç°åœ¨ï¼Œä½ å¯ä»¥åƒç®¡ç† K8s Ingress ä¸€æ ·ç®¡ç†ç½‘å…³è·¯ç”±äº†ï¼** ğŸ‰

