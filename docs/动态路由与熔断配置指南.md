# 动态路由与熔断配置指南

## 概述

网关现在支持**动态路由配置**和**动态 Hystrix 熔断配置**，配置存储在 Consul KV 中，无需重启网关即可生效！

### 主要特性

✅ **动态路由管理** - 添加/修改/删除路由无需重启
✅ **动态熔断配置** - 实时调整 Hystrix 参数
✅ **配置持久化** - 所有配置存储在 Consul KV
✅ **自动同步** - 每 10 秒自动从 Consul 拉取最新配置
✅ **配置迁移** - 首次启动时自动从 YAML 迁移到 Consul
✅ **HTTP API** - 提供完整的配置管理接口

---

## 快速开始

### 1. 启动网关

确保 Consul 已启动并在 `config/gateway.yaml` 中启用：

```yaml
consul:
  enabled: true
  address: "127.0.0.1:8500"
```

启动网关后，会自动：
- 连接到 Consul
- 从配置文件迁移路由到 Consul KV（如果 Consul 中没有配置）
- 启动配置监听器（每 10 秒检查更新）

### 2. 查看当前配置

```bash
# 查看所有路由配置
curl http://localhost:8080/gateway/admin/routes

# 查看所有 Hystrix 配置
curl http://localhost:8080/gateway/admin/hystrix
```

---

## 动态路由管理 API

### 1. 获取所有路由

**请求：**
```bash
GET http://localhost:8080/gateway/admin/routes
```

**响应示例：**
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "/auth": {
      "service_name": "authservice",
      "require_auth": false,
      "require_role": []
    },
    "/basic": {
      "service_name": "basicservice",
      "require_auth": false,
      "require_role": []
    },
    "/admin": {
      "service_name": "testservice",
      "require_auth": true,
      "require_role": ["admin"]
    }
  }
}
```

### 2. 获取指定路由

**请求：**
```bash
GET http://localhost:8080/gateway/admin/routes/auth
```

### 3. 添加新路由

**请求：**
```bash
POST http://localhost:8080/gateway/admin/routes
Content-Type: application/json

{
  "prefix": "/product",
  "service_name": "productservice",
  "require_auth": true,
  "require_role": ["user"]
}
```

**响应：**
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "message": "路由添加成功",
    "prefix": "/product",
    "config": {
      "service_name": "productservice",
      "require_auth": true,
      "require_role": ["user"]
    }
  }
}
```

**✨ 立即生效** - 添加后最多 10 秒内自动生效，无需重启网关！

### 4. 更新路由

**请求：**
```bash
PUT http://localhost:8080/gateway/admin/routes/product
Content-Type: application/json

{
  "service_name": "productservice",
  "require_auth": true,
  "require_role": ["admin", "user"]
}
```

### 5. 删除路由

**请求：**
```bash
DELETE http://localhost:8080/gateway/admin/routes/product
```

---

## 动态 Hystrix 配置 API

### 1. 获取所有 Hystrix 配置

**请求：**
```bash
GET http://localhost:8080/gateway/admin/hystrix
```

**响应示例：**
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "authservice": {
      "timeout": 3000,
      "max_concurrent_requests": 100,
      "request_volume_threshold": 20,
      "sleep_window": 5000,
      "error_percent_threshold": 50
    },
    "basicservice": {
      "timeout": 5000,
      "max_concurrent_requests": 100,
      "request_volume_threshold": 20,
      "sleep_window": 5000,
      "error_percent_threshold": 60
    }
  }
}
```

### 2. 获取指定服务的 Hystrix 配置

**请求：**
```bash
GET http://localhost:8080/gateway/admin/hystrix/authservice
```

### 3. 添加 Hystrix 配置

**请求：**
```bash
POST http://localhost:8080/gateway/admin/hystrix
Content-Type: application/json

{
  "service_name": "productservice",
  "timeout": 4000,
  "max_concurrent_requests": 80,
  "request_volume_threshold": 15,
  "sleep_window": 4000,
  "error_percent_threshold": 55
}
```

**参数说明：**
- `timeout`: 超时时间（毫秒）
- `max_concurrent_requests`: 最大并发请求数
- `request_volume_threshold`: 请求量阈值（触发熔断的最小请求数）
- `sleep_window`: 熔断器打开后多久尝试半开（毫秒）
- `error_percent_threshold`: 错误率阈值（0-100）

**✨ 立即生效** - 配置会立即应用到 Hystrix！

### 4. 更新 Hystrix 配置

**请求：**
```bash
PUT http://localhost:8080/gateway/admin/hystrix/productservice
Content-Type: application/json

{
  "timeout": 5000,
  "max_concurrent_requests": 120,
  "request_volume_threshold": 25,
  "sleep_window": 6000,
  "error_percent_threshold": 50
}
```

### 5. 删除 Hystrix 配置

**请求：**
```bash
DELETE http://localhost:8080/gateway/admin/hystrix/productservice
```

---

## 实战场景

### 场景 1: 添加新服务

假设你开发了一个新的 `order-service` 服务，已注册到 Consul：

```bash
# 1. 添加路由配置
curl -X POST http://localhost:8080/gateway/admin/routes \
  -H "Content-Type: application/json" \
  -d '{
    "prefix": "/order",
    "service_name": "orderservice",
    "require_auth": true,
    "require_role": ["user"]
  }'

# 2. 添加 Hystrix 配置
curl -X POST http://localhost:8080/gateway/admin/hystrix \
  -H "Content-Type: application/json" \
  -d '{
    "service_name": "orderservice",
    "timeout": 3000,
    "max_concurrent_requests": 100,
    "request_volume_threshold": 20,
    "sleep_window": 5000,
    "error_percent_threshold": 50
  }'

# 3. 测试新路由（等待 10 秒配置同步，或立即生效）
curl http://localhost:8080/order/list
```

✅ **完成！** 无需重启网关，新服务路由已可用！

### 场景 2: 调整熔断阈值

假设 `basic-service` 经常超时，需要调整熔断配置：

```bash
# 增加超时时间，降低熔断敏感度
curl -X PUT http://localhost:8080/gateway/admin/hystrix/basicservice \
  -H "Content-Type: application/json" \
  -d '{
    "timeout": 8000,
    "max_concurrent_requests": 150,
    "request_volume_threshold": 30,
    "sleep_window": 10000,
    "error_percent_threshold": 70
  }'
```

✅ **立即生效！** Hystrix 配置实时更新！

### 场景 3: 临时关闭某个路由

```bash
# 删除路由（服务不可访问）
curl -X DELETE http://localhost:8080/gateway/admin/routes/product

# 恢复路由
curl -X POST http://localhost:8080/gateway/admin/routes \
  -H "Content-Type: application/json" \
  -d '{
    "prefix": "/product",
    "service_name": "productservice",
    "require_auth": true,
    "require_role": ["user"]
  }'
```

---

## Consul KV 存储结构

配置存储在 Consul KV 中，路径结构：

```
gateway/
├── routes/
│   ├── /auth          -> 路由配置（JSON）
│   ├── /basic         -> 路由配置（JSON）
│   ├── /admin         -> 路由配置（JSON）
│   └── /product       -> 路由配置（JSON）
└── hystrix/
    ├── authservice    -> Hystrix 配置（JSON）
    ├── basicservice   -> Hystrix 配置（JSON）
    └── productservice -> Hystrix 配置（JSON）
```

### 直接在 Consul UI 中管理

你也可以直接在 Consul UI (`http://localhost:8500/ui`) 中编辑配置：

1. 进入 **Key/Value** 页面
2. 找到 `gateway/routes/` 或 `gateway/hystrix/`
3. 编辑 JSON 配置
4. 保存后 10 秒内自动同步到网关

---

## 配置监听机制

- **轮询间隔：** 10 秒
- **配置来源：** Consul KV
- **故障降级：** 如果 Consul 不可用，使用配置文件中的静态配置

### 查看日志

启动网关时会看到：

```
✅ 启用动态路由管理器 (基于Consul KV)
🔄 检测到Consul中无路由配置，正在从配置文件迁移...
   ✓ 加载路由: /auth -> authservice
   ✓ 加载路由: /basic -> basicservice
   ✓ 加载路由: /admin -> testservice
✅ 从Consul加载了 3 个路由配置
🔄 检测到Consul中无Hystrix配置，正在从配置文件迁移...
   ✓ 加载Hystrix配置: authservice (timeout=3000ms)
   ✓ 加载Hystrix配置: basicservice (timeout=5000ms)
✅ 从Consul加载了 2 个Hystrix配置
🔍 启动配置监听器...
```

---

## 最佳实践

### 1. 配置版本管理

建议在修改前备份配置：

```bash
# 导出当前配置
curl http://localhost:8080/gateway/admin/routes > routes_backup.json
curl http://localhost:8080/gateway/admin/hystrix > hystrix_backup.json
```

### 2. 测试新配置

在生产环境修改配置前，先在测试环境验证：

```bash
# 1. 在测试环境添加路由
curl -X POST http://test-gateway:8080/gateway/admin/routes -d '{...}'

# 2. 测试路由
curl http://test-gateway:8080/new-route/test

# 3. 确认无误后，在生产环境应用
curl -X POST http://prod-gateway:8080/gateway/admin/routes -d '{...}'
```

### 3. 监控配置变更

使用 Consul 的 watch 功能监控配置变更：

```bash
consul watch -type=keyprefix -prefix=gateway/ \
  "echo 'Gateway config changed!'"
```

### 4. Hystrix 调优建议

| 场景 | 超时时间 | 错误率阈值 | 并发数 |
|------|---------|----------|--------|
| 快速 API | 1000-2000ms | 50% | 100+ |
| 普通查询 | 3000-5000ms | 50-60% | 50-100 |
| 复杂计算 | 5000-10000ms | 60-70% | 30-50 |
| 外部调用 | 10000-15000ms | 70-80% | 20-30 |

---

## 故障排查

### 问题 1: 配置不生效

**检查项：**
1. Consul 是否正常运行？
2. 网关是否启用了 Consul？（`consul.enabled: true`）
3. 是否等待了 10 秒？（配置轮询间隔）
4. 查看网关日志是否有错误

**解决方法：**
```bash
# 查看 Consul KV
consul kv get -recurse gateway/

# 手动触发重载（如果提供了 API）
curl -X POST http://localhost:8080/gateway/admin/reload
```

### 问题 2: Hystrix 配置未生效

**可能原因：**
- 服务名不匹配（检查 `service_name` 是否正确）
- 配置值无效（如超时时间为负数）

**检查方法：**
```bash
# 查看 Hystrix 指标
curl http://localhost:8080/gateway/hystrix/metrics/yourservice
```

---

## 与静态配置的对比

| 特性 | 静态配置（YAML） | 动态配置（Consul KV） |
|------|----------------|-------------------|
| 配置修改 | 需要重启 | 无需重启 |
| 生效时间 | 重启后立即 | 最多 10 秒 |
| 配置共享 | 每个实例独立 | 多实例共享 |
| 版本管理 | Git 管理 | Consul 历史记录 |
| 易用性 | 文件编辑 | HTTP API |
| 可靠性 | 高（本地文件） | 依赖 Consul |

**建议：** 开发环境使用 YAML，生产环境使用 Consul KV

---

## API 完整列表

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/gateway/admin/routes` | 获取所有路由 |
| GET | `/gateway/admin/routes/:prefix` | 获取指定路由 |
| POST | `/gateway/admin/routes` | 添加路由 |
| PUT | `/gateway/admin/routes/:prefix` | 更新路由 |
| DELETE | `/gateway/admin/routes/:prefix` | 删除路由 |
| GET | `/gateway/admin/hystrix` | 获取所有 Hystrix 配置 |
| GET | `/gateway/admin/hystrix/:service` | 获取指定 Hystrix 配置 |
| POST | `/gateway/admin/hystrix` | 添加 Hystrix 配置 |
| PUT | `/gateway/admin/hystrix/:service` | 更新 Hystrix 配置 |
| DELETE | `/gateway/admin/hystrix/:service` | 删除 Hystrix 配置 |
| POST | `/gateway/admin/reload` | 手动触发配置重载 |

---

## 总结

✅ **动态路由** - 无需重启即可添加新服务  
✅ **动态熔断** - 实时调整服务保护策略  
✅ **配置持久化** - Consul KV 集中存储  
✅ **自动同步** - 10 秒内自动应用变更  
✅ **简单易用** - HTTP API 管理配置  

**现在，你可以像管理 K8s Ingress 一样管理网关路由了！** 🎉

