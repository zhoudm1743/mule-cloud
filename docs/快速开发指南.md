# 快速开发指南 - 添加新接口

## 🚀 5分钟添加一个新接口

### 📋 检查清单

- [ ] 1. 在 `services/` 创建或修改Service
- [ ] 2. 在 `endpoint/` 添加Endpoint函数
- [ ] 3. 在 `transport/` 添加Handler
- [ ] 4. 在 `cmd/main.go` 注册路由

---

## 📝 代码模板

### 1️⃣ Service 层模板

```go
// services/{模块名}.go
package services

type I{模块}Service interface {
    {方法名}({参数}) ({返回值}, error)
}

type {模块}Service struct {
    // 依赖注入（如数据库连接）
}

func (s *{模块}Service) {方法名}({参数}) ({返回值}, error) {
    // 业务逻辑
    return result, nil
}

func New{模块}Service() I{模块}Service {
    return &{模块}Service{}
}
```

**示例**:
```go
// services/user.go
type IUserService interface {
    GetById(id string) (*User, error)
}
```

---

### 2️⃣ Endpoint 层模板

```go
// endpoint/{模块名}.go
package endpoint

import (
    "context"
    "mule-cloud/test/services"
    "github.com/go-kit/kit/endpoint"
)

// 请求结构
type {操作}{模块}Request struct {
    // Query参数: `form:"xxx"`
    // URI参数:   `uri:"xxx"`
    // JSON参数:  `json:"xxx"`
    // 必填字段:  `binding"required"`
}

// 响应结构
type {操作}{模块}Response struct {
    // 响应字段
}

// Endpoint函数
func {操作}{模块}Endpoint(svc services.I{模块}Service) endpoint.Endpoint {
    return func(ctx context.Context, request interface{}) (interface{}, error) {
        req := request.({操作}{模块}Request)
        result, err := svc.{方法名}(req.参数)
        if err != nil {
            return nil, err
        }
        return {操作}{模块}Response{/* 填充响应 */}, nil
    }
}
```

**示例**:
```go
// endpoint/user.go
type GetUserRequest struct {
    Id string `uri:"id" binding"required"`
}

type GetUserResponse struct {
    User *services.User `json:"user"`
}

func GetUserEndpoint(svc services.IUserService) endpoint.Endpoint {
    return func(ctx context.Context, request interface{}) (interface{}, error) {
        req := request.(GetUserRequest)
        user, err := svc.GetById(req.Id)
        if err != nil {
            return nil, err
        }
        return GetUserResponse{User: user}, nil
    }
}
```

---

### 3️⃣ Transport 层模板

```go
// transport/{模块名}.go
package transport

import (
    "mule-cloud/core/response"
    "mule-cloud/test/endpoint"
    "mule-cloud/test/services"
    "github.com/gin-gonic/gin"
)

func {模块}{操作}Handler(svc services.I{模块}Service) gin.HandlerFunc {
    return func(c *gin.Context) {
        // 1. 参数绑定
        var req endpoint.{操作}{模块}Request
        if err := c.Should{绑定方法}(&req); err != nil {
            response.Error(c, "参数错误: "+err.Error())
            return
        }

        // 2. 调用endpoint
        ep := endpoint.{操作}{模块}Endpoint(svc)
        resp, err := ep(c.Request.Context(), req)
        if err != nil {
            response.Error(c, err.Error())
            return
        }

        // 3. 返回响应
        response.Success(c, resp)
    }
}
```

**绑定方法对照表**:
- Query参数: `ShouldBindQuery`
- URI参数: `ShouldBindUri`
- JSON Body: `ShouldBindJSON`
- Form表单: `ShouldBind`

**示例**:
```go
// transport/user.go
func UserGetByIdHandler(svc services.IUserService) gin.HandlerFunc {
    return func(c *gin.Context) {
        var req endpoint.GetUserRequest
        if err := c.ShouldBindUri(&req); err != nil {
            response.Error(c, "参数错误: "+err.Error())
            return
        }

        ep := endpoint.GetUserEndpoint(svc)
        resp, err := ep(c.Request.Context(), req)
        if err != nil {
            response.Error(c, err.Error())
            return
        }

        response.Success(c, resp)
    }
}
```

---

### 4️⃣ 路由注册模板

```go
// cmd/main.go
func main() {
    // 初始化服务
    {模块}Svc := services.New{模块}Service()

    // 初始化路由
    r := gin.Default()

    // 路由组
    {模块} := r.Group("/{路径}")
    {
        {模块}.GET("/{path}", transport.{模块}{操作}Handler({模块}Svc))
        {模块}.POST("/{path}", transport.{模块}{操作}Handler({模块}Svc))
        {模块}.PUT("/{path}", transport.{模块}{操作}Handler({模块}Svc))
        {模块}.DELETE("/{path}", transport.{模块}{操作}Handler({模块}Svc))
    }

    r.Run(":8080")
}
```

**示例**:
```go
// cmd/main.go
func main() {
    userSvc := services.NewUserService()
    
    r := gin.Default()
    
    user := r.Group("/user")
    {
        user.GET("/:id", transport.UserGetByIdHandler(userSvc))
    }
    
    r.Run(":8080")
}
```

---

## 🎯 常见接口类型速查

### 类型1: 列表查询 (GET /resource)

```go
// Service
func (s *Service) List() ([]*Item, error)

// Endpoint Request
type ListRequest struct{}

// Transport
c.ShouldBindQuery(&req)  // 可选的查询参数
```

### 类型2: 详情查询 (GET /resource/:id)

```go
// Service
func (s *Service) GetById(id string) (*Item, error)

// Endpoint Request
type GetRequest struct {
    Id string `uri:"id" binding"required"`
}

// Transport
c.ShouldBindUri(&req)
```

### 类型3: 创建 (POST /resource)

```go
// Service
func (s *Service) Create(data *CreateData) (*Item, error)

// Endpoint Request
type CreateRequest struct {
    Field1 string `json:"field1" binding"required"`
    Field2 int    `json:"field2"`
}

// Transport
c.ShouldBindJSON(&req)
```

### 类型4: 更新 (PUT /resource/:id)

```go
// Service
func (s *Service) Update(id string, data *UpdateData) error

// Endpoint Request
type UpdateRequest struct {
    Id     string `uri:"id" binding"required"`
    Field1 string `json:"field1" binding"required"`
}

// Transport
c.ShouldBindUri(&req)  // 先绑定URI参数
c.ShouldBindJSON(&req) // 再绑定JSON参数
```

### 类型5: 删除 (DELETE /resource/:id)

```go
// Service
func (s *Service) Delete(id string) error

// Endpoint Request
type DeleteRequest struct {
    Id string `uri:"id" binding"required"`
}

// Transport
c.ShouldBindUri(&req)
```

---

## ⚡ 实战示例：完整CRUD（5个接口）

```go
// ============ services/article.go ============
package services

type IArticleService interface {
    List(page, pageSize int) ([]*Article, error)
    GetById(id string) (*Article, error)
    Create(title, content string) (*Article, error)
    Update(id, title, content string) error
    Delete(id string) error
}

type Article struct {
    Id      string `json:"id"`
    Title   string `json:"title"`
    Content string `json:"content"`
}

type ArticleService struct{}

func NewArticleService() IArticleService {
    return &ArticleService{}
}

func (s *ArticleService) List(page, pageSize int) ([]*Article, error) {
    return []*Article{}, nil
}

func (s *ArticleService) GetById(id string) (*Article, error) {
    return &Article{Id: id}, nil
}

func (s *ArticleService) Create(title, content string) (*Article, error) {
    return &Article{Title: title, Content: content}, nil
}

func (s *ArticleService) Update(id, title, content string) error {
    return nil
}

func (s *ArticleService) Delete(id string) error {
    return nil
}

// ============ endpoint/article.go ============
package endpoint

import (
    "context"
    "mule-cloud/test/services"
    "github.com/go-kit/kit/endpoint"
)

// List
type ListArticleRequest struct {
    Page     int `form:"page"`
    PageSize int `form:"page_size"`
}
type ListArticleResponse struct {
    Articles []*services.Article `json:"articles"`
}
func ListArticleEndpoint(svc services.IArticleService) endpoint.Endpoint {
    return func(ctx context.Context, request interface{}) (interface{}, error) {
        req := request.(ListArticleRequest)
        articles, err := svc.List(req.Page, req.PageSize)
        if err != nil {
            return nil, err
        }
        return ListArticleResponse{Articles: articles}, nil
    }
}

// Get
type GetArticleRequest struct {
    Id string `uri:"id" binding"required"`
}
type GetArticleResponse struct {
    Article *services.Article `json:"article"`
}
func GetArticleEndpoint(svc services.IArticleService) endpoint.Endpoint {
    return func(ctx context.Context, request interface{}) (interface{}, error) {
        req := request.(GetArticleRequest)
        article, err := svc.GetById(req.Id)
        if err != nil {
            return nil, err
        }
        return GetArticleResponse{Article: article}, nil
    }
}

// Create
type CreateArticleRequest struct {
    Title   string `json:"title" binding"required"`
    Content string `json:"content" binding"required"`
}
type CreateArticleResponse struct {
    Article *services.Article `json:"article"`
}
func CreateArticleEndpoint(svc services.IArticleService) endpoint.Endpoint {
    return func(ctx context.Context, request interface{}) (interface{}, error) {
        req := request.(CreateArticleRequest)
        article, err := svc.Create(req.Title, req.Content)
        if err != nil {
            return nil, err
        }
        return CreateArticleResponse{Article: article}, nil
    }
}

// Update
type UpdateArticleRequest struct {
    Id      string `uri:"id" binding"required"`
    Title   string `json:"title" binding"required"`
    Content string `json:"content" binding"required"`
}
type UpdateArticleResponse struct {
    Message string `json:"message"`
}
func UpdateArticleEndpoint(svc services.IArticleService) endpoint.Endpoint {
    return func(ctx context.Context, request interface{}) (interface{}, error) {
        req := request.(UpdateArticleRequest)
        err := svc.Update(req.Id, req.Title, req.Content)
        if err != nil {
            return nil, err
        }
        return UpdateArticleResponse{Message: "更新成功"}, nil
    }
}

// Delete
type DeleteArticleRequest struct {
    Id string `uri:"id" binding"required"`
}
type DeleteArticleResponse struct {
    Message string `json:"message"`
}
func DeleteArticleEndpoint(svc services.IArticleService) endpoint.Endpoint {
    return func(ctx context.Context, request interface{}) (interface{}, error) {
        req := request.(DeleteArticleRequest)
        err := svc.Delete(req.Id)
        if err != nil {
            return nil, err
        }
        return DeleteArticleResponse{Message: "删除成功"}, nil
    }
}

// ============ transport/article.go ============
package transport

import (
    "mule-cloud/core/response"
    "mule-cloud/test/endpoint"
    "mule-cloud/test/services"
    "github.com/gin-gonic/gin"
)

func ArticleListHandler(svc services.IArticleService) gin.HandlerFunc {
    return func(c *gin.Context) {
        var req endpoint.ListArticleRequest
        c.ShouldBindQuery(&req)  // 可选参数，不检查错误
        
        ep := endpoint.ListArticleEndpoint(svc)
        resp, err := ep(c.Request.Context(), req)
        if err != nil {
            response.Error(c, err.Error())
            return
        }
        response.Success(c, resp)
    }
}

func ArticleGetHandler(svc services.IArticleService) gin.HandlerFunc {
    return func(c *gin.Context) {
        var req endpoint.GetArticleRequest
        if err := c.ShouldBindUri(&req); err != nil {
            response.Error(c, "参数错误: "+err.Error())
            return
        }
        
        ep := endpoint.GetArticleEndpoint(svc)
        resp, err := ep(c.Request.Context(), req)
        if err != nil {
            response.Error(c, err.Error())
            return
        }
        response.Success(c, resp)
    }
}

func ArticleCreateHandler(svc services.IArticleService) gin.HandlerFunc {
    return func(c *gin.Context) {
        var req endpoint.CreateArticleRequest
        if err := c.ShouldBindJSON(&req); err != nil {
            response.Error(c, "参数错误: "+err.Error())
            return
        }
        
        ep := endpoint.CreateArticleEndpoint(svc)
        resp, err := ep(c.Request.Context(), req)
        if err != nil {
            response.Error(c, err.Error())
            return
        }
        response.Success(c, resp)
    }
}

func ArticleUpdateHandler(svc services.IArticleService) gin.HandlerFunc {
    return func(c *gin.Context) {
        var req endpoint.UpdateArticleRequest
        if err := c.ShouldBindUri(&req); err != nil {
            response.Error(c, "参数错误: "+err.Error())
            return
        }
        if err := c.ShouldBindJSON(&req); err != nil {
            response.Error(c, "参数错误: "+err.Error())
            return
        }
        
        ep := endpoint.UpdateArticleEndpoint(svc)
        resp, err := ep(c.Request.Context(), req)
        if err != nil {
            response.Error(c, err.Error())
            return
        }
        response.Success(c, resp)
    }
}

func ArticleDeleteHandler(svc services.IArticleService) gin.HandlerFunc {
    return func(c *gin.Context) {
        var req endpoint.DeleteArticleRequest
        if err := c.ShouldBindUri(&req); err != nil {
            response.Error(c, "参数错误: "+err.Error())
            return
        }
        
        ep := endpoint.DeleteArticleEndpoint(svc)
        resp, err := ep(c.Request.Context(), req)
        if err != nil {
            response.Error(c, err.Error())
            return
        }
        response.Success(c, resp)
    }
}

// ============ cmd/main.go ============
package main

import (
    "mule-cloud/test/services"
    "mule-cloud/test/transport"
    "github.com/gin-gonic/gin"
)

func main() {
    // 初始化服务
    articleSvc := services.NewArticleService()

    // 初始化路由
    r := gin.Default()

    // Article路由
    article := r.Group("/article")
    {
        article.GET("", transport.ArticleListHandler(articleSvc))
        article.GET("/:id", transport.ArticleGetHandler(articleSvc))
        article.POST("", transport.ArticleCreateHandler(articleSvc))
        article.PUT("/:id", transport.ArticleUpdateHandler(articleSvc))
        article.DELETE("/:id", transport.ArticleDeleteHandler(articleSvc))
    }

    r.Run(":8080")
}
```

---

## 🧪 测试命令

```bash
# 列表查询
curl "http://localhost:8080/article?page=1&page_size=10"

# 详情查询
curl "http://localhost:8080/article/123"

# 创建
curl -X POST "http://localhost:8080/article" \
  -H "Content-Type: application/json" \
  -d '{"title":"标题","content":"内容"}'

# 更新
curl -X PUT "http://localhost:8080/article/123" \
  -H "Content-Type: application/json" \
  -d '{"title":"新标题","content":"新内容"}'

# 删除
curl -X DELETE "http://localhost:8080/article/123"
```

---

## 📌 记住这三点

1. **每个接口 = 1个Service方法 + 1个Endpoint函数 + 1个Handler函数**
2. **同一个模块的所有Endpoint可以放在一个文件中**
3. **参数绑定方式**: Query用`ShouldBindQuery`，URI用`ShouldBindUri`，JSON用`ShouldBindJSON`

---

## 🔗 更多详情

查看完整架构说明文档：[架构说明.md](./架构说明.md)
