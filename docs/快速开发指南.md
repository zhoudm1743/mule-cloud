# å¿«é€Ÿå¼€å‘æŒ‡å— - æ·»åŠ æ–°æ¥å£

## ğŸš€ 5åˆ†é’Ÿæ·»åŠ ä¸€ä¸ªæ–°æ¥å£

### ğŸ“‹ æ£€æŸ¥æ¸…å•

- [ ] 1. åœ¨ `services/` åˆ›å»ºæˆ–ä¿®æ”¹Service
- [ ] 2. åœ¨ `endpoint/` æ·»åŠ Endpointå‡½æ•°
- [ ] 3. åœ¨ `transport/` æ·»åŠ Handler
- [ ] 4. åœ¨ `cmd/main.go` æ³¨å†Œè·¯ç”±

---

## ğŸ“ ä»£ç æ¨¡æ¿

### 1ï¸âƒ£ Service å±‚æ¨¡æ¿

```go
// services/{æ¨¡å—å}.go
package services

type I{æ¨¡å—}Service interface {
    {æ–¹æ³•å}({å‚æ•°}) ({è¿”å›å€¼}, error)
}

type {æ¨¡å—}Service struct {
    // ä¾èµ–æ³¨å…¥ï¼ˆå¦‚æ•°æ®åº“è¿æ¥ï¼‰
}

func (s *{æ¨¡å—}Service) {æ–¹æ³•å}({å‚æ•°}) ({è¿”å›å€¼}, error) {
    // ä¸šåŠ¡é€»è¾‘
    return result, nil
}

func New{æ¨¡å—}Service() I{æ¨¡å—}Service {
    return &{æ¨¡å—}Service{}
}
```

**ç¤ºä¾‹**:
```go
// services/user.go
type IUserService interface {
    GetById(id string) (*User, error)
}
```

---

### 2ï¸âƒ£ Endpoint å±‚æ¨¡æ¿

```go
// endpoint/{æ¨¡å—å}.go
package endpoint

import (
    "context"
    "mule-cloud/test/services"
    "github.com/go-kit/kit/endpoint"
)

// è¯·æ±‚ç»“æ„
type {æ“ä½œ}{æ¨¡å—}Request struct {
    // Queryå‚æ•°: `form:"xxx"`
    // URIå‚æ•°:   `uri:"xxx"`
    // JSONå‚æ•°:  `json:"xxx"`
    // å¿…å¡«å­—æ®µ:  `binding"required"`
}

// å“åº”ç»“æ„
type {æ“ä½œ}{æ¨¡å—}Response struct {
    // å“åº”å­—æ®µ
}

// Endpointå‡½æ•°
func {æ“ä½œ}{æ¨¡å—}Endpoint(svc services.I{æ¨¡å—}Service) endpoint.Endpoint {
    return func(ctx context.Context, request interface{}) (interface{}, error) {
        req := request.({æ“ä½œ}{æ¨¡å—}Request)
        result, err := svc.{æ–¹æ³•å}(req.å‚æ•°)
        if err != nil {
            return nil, err
        }
        return {æ“ä½œ}{æ¨¡å—}Response{/* å¡«å……å“åº” */}, nil
    }
}
```

**ç¤ºä¾‹**:
```go
// endpoint/user.go
type GetUserRequest struct {
    Id string `uri:"id" binding"required"`
}

type GetUserResponse struct {
    User *services.User `json:"user"`
}

func GetUserEndpoint(svc services.IUserService) endpoint.Endpoint {
    return func(ctx context.Context, request interface{}) (interface{}, error) {
        req := request.(GetUserRequest)
        user, err := svc.GetById(req.Id)
        if err != nil {
            return nil, err
        }
        return GetUserResponse{User: user}, nil
    }
}
```

---

### 3ï¸âƒ£ Transport å±‚æ¨¡æ¿

```go
// transport/{æ¨¡å—å}.go
package transport

import (
    "mule-cloud/core/response"
    "mule-cloud/test/endpoint"
    "mule-cloud/test/services"
    "github.com/gin-gonic/gin"
)

func {æ¨¡å—}{æ“ä½œ}Handler(svc services.I{æ¨¡å—}Service) gin.HandlerFunc {
    return func(c *gin.Context) {
        // 1. å‚æ•°ç»‘å®š
        var req endpoint.{æ“ä½œ}{æ¨¡å—}Request
        if err := c.Should{ç»‘å®šæ–¹æ³•}(&req); err != nil {
            response.Error(c, "å‚æ•°é”™è¯¯: "+err.Error())
            return
        }

        // 2. è°ƒç”¨endpoint
        ep := endpoint.{æ“ä½œ}{æ¨¡å—}Endpoint(svc)
        resp, err := ep(c.Request.Context(), req)
        if err != nil {
            response.Error(c, err.Error())
            return
        }

        // 3. è¿”å›å“åº”
        response.Success(c, resp)
    }
}
```

**ç»‘å®šæ–¹æ³•å¯¹ç…§è¡¨**:
- Queryå‚æ•°: `ShouldBindQuery`
- URIå‚æ•°: `ShouldBindUri`
- JSON Body: `ShouldBindJSON`
- Formè¡¨å•: `ShouldBind`

**ç¤ºä¾‹**:
```go
// transport/user.go
func UserGetByIdHandler(svc services.IUserService) gin.HandlerFunc {
    return func(c *gin.Context) {
        var req endpoint.GetUserRequest
        if err := c.ShouldBindUri(&req); err != nil {
            response.Error(c, "å‚æ•°é”™è¯¯: "+err.Error())
            return
        }

        ep := endpoint.GetUserEndpoint(svc)
        resp, err := ep(c.Request.Context(), req)
        if err != nil {
            response.Error(c, err.Error())
            return
        }

        response.Success(c, resp)
    }
}
```

---

### 4ï¸âƒ£ è·¯ç”±æ³¨å†Œæ¨¡æ¿

```go
// cmd/main.go
func main() {
    // åˆå§‹åŒ–æœåŠ¡
    {æ¨¡å—}Svc := services.New{æ¨¡å—}Service()

    // åˆå§‹åŒ–è·¯ç”±
    r := gin.Default()

    // è·¯ç”±ç»„
    {æ¨¡å—} := r.Group("/{è·¯å¾„}")
    {
        {æ¨¡å—}.GET("/{path}", transport.{æ¨¡å—}{æ“ä½œ}Handler({æ¨¡å—}Svc))
        {æ¨¡å—}.POST("/{path}", transport.{æ¨¡å—}{æ“ä½œ}Handler({æ¨¡å—}Svc))
        {æ¨¡å—}.PUT("/{path}", transport.{æ¨¡å—}{æ“ä½œ}Handler({æ¨¡å—}Svc))
        {æ¨¡å—}.DELETE("/{path}", transport.{æ¨¡å—}{æ“ä½œ}Handler({æ¨¡å—}Svc))
    }

    r.Run(":8080")
}
```

**ç¤ºä¾‹**:
```go
// cmd/main.go
func main() {
    userSvc := services.NewUserService()
    
    r := gin.Default()
    
    user := r.Group("/user")
    {
        user.GET("/:id", transport.UserGetByIdHandler(userSvc))
    }
    
    r.Run(":8080")
}
```

---

## ğŸ¯ å¸¸è§æ¥å£ç±»å‹é€ŸæŸ¥

### ç±»å‹1: åˆ—è¡¨æŸ¥è¯¢ (GET /resource)

```go
// Service
func (s *Service) List() ([]*Item, error)

// Endpoint Request
type ListRequest struct{}

// Transport
c.ShouldBindQuery(&req)  // å¯é€‰çš„æŸ¥è¯¢å‚æ•°
```

### ç±»å‹2: è¯¦æƒ…æŸ¥è¯¢ (GET /resource/:id)

```go
// Service
func (s *Service) GetById(id string) (*Item, error)

// Endpoint Request
type GetRequest struct {
    Id string `uri:"id" binding"required"`
}

// Transport
c.ShouldBindUri(&req)
```

### ç±»å‹3: åˆ›å»º (POST /resource)

```go
// Service
func (s *Service) Create(data *CreateData) (*Item, error)

// Endpoint Request
type CreateRequest struct {
    Field1 string `json:"field1" binding"required"`
    Field2 int    `json:"field2"`
}

// Transport
c.ShouldBindJSON(&req)
```

### ç±»å‹4: æ›´æ–° (PUT /resource/:id)

```go
// Service
func (s *Service) Update(id string, data *UpdateData) error

// Endpoint Request
type UpdateRequest struct {
    Id     string `uri:"id" binding"required"`
    Field1 string `json:"field1" binding"required"`
}

// Transport
c.ShouldBindUri(&req)  // å…ˆç»‘å®šURIå‚æ•°
c.ShouldBindJSON(&req) // å†ç»‘å®šJSONå‚æ•°
```

### ç±»å‹5: åˆ é™¤ (DELETE /resource/:id)

```go
// Service
func (s *Service) Delete(id string) error

// Endpoint Request
type DeleteRequest struct {
    Id string `uri:"id" binding"required"`
}

// Transport
c.ShouldBindUri(&req)
```

---

## âš¡ å®æˆ˜ç¤ºä¾‹ï¼šå®Œæ•´CRUDï¼ˆ5ä¸ªæ¥å£ï¼‰

```go
// ============ services/article.go ============
package services

type IArticleService interface {
    List(page, pageSize int) ([]*Article, error)
    GetById(id string) (*Article, error)
    Create(title, content string) (*Article, error)
    Update(id, title, content string) error
    Delete(id string) error
}

type Article struct {
    Id      string `json:"id"`
    Title   string `json:"title"`
    Content string `json:"content"`
}

type ArticleService struct{}

func NewArticleService() IArticleService {
    return &ArticleService{}
}

func (s *ArticleService) List(page, pageSize int) ([]*Article, error) {
    return []*Article{}, nil
}

func (s *ArticleService) GetById(id string) (*Article, error) {
    return &Article{Id: id}, nil
}

func (s *ArticleService) Create(title, content string) (*Article, error) {
    return &Article{Title: title, Content: content}, nil
}

func (s *ArticleService) Update(id, title, content string) error {
    return nil
}

func (s *ArticleService) Delete(id string) error {
    return nil
}

// ============ endpoint/article.go ============
package endpoint

import (
    "context"
    "mule-cloud/test/services"
    "github.com/go-kit/kit/endpoint"
)

// List
type ListArticleRequest struct {
    Page     int `form:"page"`
    PageSize int `form:"page_size"`
}
type ListArticleResponse struct {
    Articles []*services.Article `json:"articles"`
}
func ListArticleEndpoint(svc services.IArticleService) endpoint.Endpoint {
    return func(ctx context.Context, request interface{}) (interface{}, error) {
        req := request.(ListArticleRequest)
        articles, err := svc.List(req.Page, req.PageSize)
        if err != nil {
            return nil, err
        }
        return ListArticleResponse{Articles: articles}, nil
    }
}

// Get
type GetArticleRequest struct {
    Id string `uri:"id" binding"required"`
}
type GetArticleResponse struct {
    Article *services.Article `json:"article"`
}
func GetArticleEndpoint(svc services.IArticleService) endpoint.Endpoint {
    return func(ctx context.Context, request interface{}) (interface{}, error) {
        req := request.(GetArticleRequest)
        article, err := svc.GetById(req.Id)
        if err != nil {
            return nil, err
        }
        return GetArticleResponse{Article: article}, nil
    }
}

// Create
type CreateArticleRequest struct {
    Title   string `json:"title" binding"required"`
    Content string `json:"content" binding"required"`
}
type CreateArticleResponse struct {
    Article *services.Article `json:"article"`
}
func CreateArticleEndpoint(svc services.IArticleService) endpoint.Endpoint {
    return func(ctx context.Context, request interface{}) (interface{}, error) {
        req := request.(CreateArticleRequest)
        article, err := svc.Create(req.Title, req.Content)
        if err != nil {
            return nil, err
        }
        return CreateArticleResponse{Article: article}, nil
    }
}

// Update
type UpdateArticleRequest struct {
    Id      string `uri:"id" binding"required"`
    Title   string `json:"title" binding"required"`
    Content string `json:"content" binding"required"`
}
type UpdateArticleResponse struct {
    Message string `json:"message"`
}
func UpdateArticleEndpoint(svc services.IArticleService) endpoint.Endpoint {
    return func(ctx context.Context, request interface{}) (interface{}, error) {
        req := request.(UpdateArticleRequest)
        err := svc.Update(req.Id, req.Title, req.Content)
        if err != nil {
            return nil, err
        }
        return UpdateArticleResponse{Message: "æ›´æ–°æˆåŠŸ"}, nil
    }
}

// Delete
type DeleteArticleRequest struct {
    Id string `uri:"id" binding"required"`
}
type DeleteArticleResponse struct {
    Message string `json:"message"`
}
func DeleteArticleEndpoint(svc services.IArticleService) endpoint.Endpoint {
    return func(ctx context.Context, request interface{}) (interface{}, error) {
        req := request.(DeleteArticleRequest)
        err := svc.Delete(req.Id)
        if err != nil {
            return nil, err
        }
        return DeleteArticleResponse{Message: "åˆ é™¤æˆåŠŸ"}, nil
    }
}

// ============ transport/article.go ============
package transport

import (
    "mule-cloud/core/response"
    "mule-cloud/test/endpoint"
    "mule-cloud/test/services"
    "github.com/gin-gonic/gin"
)

func ArticleListHandler(svc services.IArticleService) gin.HandlerFunc {
    return func(c *gin.Context) {
        var req endpoint.ListArticleRequest
        c.ShouldBindQuery(&req)  // å¯é€‰å‚æ•°ï¼Œä¸æ£€æŸ¥é”™è¯¯
        
        ep := endpoint.ListArticleEndpoint(svc)
        resp, err := ep(c.Request.Context(), req)
        if err != nil {
            response.Error(c, err.Error())
            return
        }
        response.Success(c, resp)
    }
}

func ArticleGetHandler(svc services.IArticleService) gin.HandlerFunc {
    return func(c *gin.Context) {
        var req endpoint.GetArticleRequest
        if err := c.ShouldBindUri(&req); err != nil {
            response.Error(c, "å‚æ•°é”™è¯¯: "+err.Error())
            return
        }
        
        ep := endpoint.GetArticleEndpoint(svc)
        resp, err := ep(c.Request.Context(), req)
        if err != nil {
            response.Error(c, err.Error())
            return
        }
        response.Success(c, resp)
    }
}

func ArticleCreateHandler(svc services.IArticleService) gin.HandlerFunc {
    return func(c *gin.Context) {
        var req endpoint.CreateArticleRequest
        if err := c.ShouldBindJSON(&req); err != nil {
            response.Error(c, "å‚æ•°é”™è¯¯: "+err.Error())
            return
        }
        
        ep := endpoint.CreateArticleEndpoint(svc)
        resp, err := ep(c.Request.Context(), req)
        if err != nil {
            response.Error(c, err.Error())
            return
        }
        response.Success(c, resp)
    }
}

func ArticleUpdateHandler(svc services.IArticleService) gin.HandlerFunc {
    return func(c *gin.Context) {
        var req endpoint.UpdateArticleRequest
        if err := c.ShouldBindUri(&req); err != nil {
            response.Error(c, "å‚æ•°é”™è¯¯: "+err.Error())
            return
        }
        if err := c.ShouldBindJSON(&req); err != nil {
            response.Error(c, "å‚æ•°é”™è¯¯: "+err.Error())
            return
        }
        
        ep := endpoint.UpdateArticleEndpoint(svc)
        resp, err := ep(c.Request.Context(), req)
        if err != nil {
            response.Error(c, err.Error())
            return
        }
        response.Success(c, resp)
    }
}

func ArticleDeleteHandler(svc services.IArticleService) gin.HandlerFunc {
    return func(c *gin.Context) {
        var req endpoint.DeleteArticleRequest
        if err := c.ShouldBindUri(&req); err != nil {
            response.Error(c, "å‚æ•°é”™è¯¯: "+err.Error())
            return
        }
        
        ep := endpoint.DeleteArticleEndpoint(svc)
        resp, err := ep(c.Request.Context(), req)
        if err != nil {
            response.Error(c, err.Error())
            return
        }
        response.Success(c, resp)
    }
}

// ============ cmd/main.go ============
package main

import (
    "mule-cloud/test/services"
    "mule-cloud/test/transport"
    "github.com/gin-gonic/gin"
)

func main() {
    // åˆå§‹åŒ–æœåŠ¡
    articleSvc := services.NewArticleService()

    // åˆå§‹åŒ–è·¯ç”±
    r := gin.Default()

    // Articleè·¯ç”±
    article := r.Group("/article")
    {
        article.GET("", transport.ArticleListHandler(articleSvc))
        article.GET("/:id", transport.ArticleGetHandler(articleSvc))
        article.POST("", transport.ArticleCreateHandler(articleSvc))
        article.PUT("/:id", transport.ArticleUpdateHandler(articleSvc))
        article.DELETE("/:id", transport.ArticleDeleteHandler(articleSvc))
    }

    r.Run(":8080")
}
```

---

## ğŸ§ª æµ‹è¯•å‘½ä»¤

```bash
# åˆ—è¡¨æŸ¥è¯¢
curl "http://localhost:8080/article?page=1&page_size=10"

# è¯¦æƒ…æŸ¥è¯¢
curl "http://localhost:8080/article/123"

# åˆ›å»º
curl -X POST "http://localhost:8080/article" \
  -H "Content-Type: application/json" \
  -d '{"title":"æ ‡é¢˜","content":"å†…å®¹"}'

# æ›´æ–°
curl -X PUT "http://localhost:8080/article/123" \
  -H "Content-Type: application/json" \
  -d '{"title":"æ–°æ ‡é¢˜","content":"æ–°å†…å®¹"}'

# åˆ é™¤
curl -X DELETE "http://localhost:8080/article/123"
```

---

## ğŸ“Œ è®°ä½è¿™ä¸‰ç‚¹

1. **æ¯ä¸ªæ¥å£ = 1ä¸ªServiceæ–¹æ³• + 1ä¸ªEndpointå‡½æ•° + 1ä¸ªHandlerå‡½æ•°**
2. **åŒä¸€ä¸ªæ¨¡å—çš„æ‰€æœ‰Endpointå¯ä»¥æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­**
3. **å‚æ•°ç»‘å®šæ–¹å¼**: Queryç”¨`ShouldBindQuery`ï¼ŒURIç”¨`ShouldBindUri`ï¼ŒJSONç”¨`ShouldBindJSON`

---

## ğŸ”— æ›´å¤šè¯¦æƒ…

æŸ¥çœ‹å®Œæ•´æ¶æ„è¯´æ˜æ–‡æ¡£ï¼š[æ¶æ„è¯´æ˜.md](./æ¶æ„è¯´æ˜.md)
