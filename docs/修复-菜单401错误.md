# 修复 - 菜单 401 错误 ✅

## 🐛 问题

用户报错：
```
获取菜单失败: 调用 system 服务失败, 请求失败. 
状态码: 401, 响应: {"code":401,"msg":"未提供认证token","timestamp":1759670052}
```

## 🔍 原因

1. **system 服务的所有路由都要求认证了**
   ```go
   system := r.Group("/system")
   middleware.Apply(system, jwtManager) // ✅ 所有 system 路由需要认证
   ```

2. **auth 服务还在用 HTTP 调用 system 服务**
   ```go
   // ❌ 旧代码：HTTP 调用 system 服务
   err := s.httpClient.CallService(ctx, "GET", "systemservice", "/system/menus/all", ...)
   ```

3. **HTTP 调用没有传递 token** → system 服务拒绝请求 → 返回 401

---

## ✅ 解决方案

**让 auth 服务直接使用 repository 查询数据库**，不再通过 HTTP 调用 system 服务。

### 修改的代码

**`app/auth/services/auth.go`**

#### 1. 添加 menuRepo 字段
```go
type AuthService struct {
    repo       repository.AdminRepository
    tenantRepo repository.TenantRepository
    roleRepo   repository.RoleRepository
    menuRepo   *repository.MenuRepository  // ✅ 新增
    jwtManager *jwtPkg.JWTManager
    httpClient *httpclient.ServiceClient
}
```

#### 2. 初始化 menuRepo
```go
func NewAuthService(jwtManager *jwtPkg.JWTManager) IAuthService {
    repo := repository.NewAdminRepository()
    tenantRepo := repository.NewTenantRepository()
    roleRepo := repository.NewRoleRepository()
    menuRepo := repository.NewMenuRepository()  // ✅ 新增

    return &AuthService{
        repo:       repo,
        tenantRepo: tenantRepo,
        roleRepo:   roleRepo,
        menuRepo:   menuRepo,  // ✅ 新增
        jwtManager: jwtManager,
        httpClient: client,
    }
}
```

#### 3. 改用 repository 查询数据库
```go
// fetchAllMenusFromSystem 从数据库获取所有菜单
func (s *AuthService) fetchAllMenusFromSystem() ([]dto.RouteItem, error) {
    // ✅ 直接使用 repository 查询数据库（菜单在系统库）
    ctx := context.Background() // 菜单在系统库，不需要租户上下文
    
    menus, err := s.menuRepo.GetAll(ctx)
    if err != nil {
        return nil, fmt.Errorf("查询菜单失败: %w", err)
    }

    // 转换为 RouteItem
    var routes []dto.RouteItem
    for _, menu := range menus {
        routes = append(routes, dto.RouteItem{
            Name:          menu.Name,
            Path:          menu.Path,
            Title:         menu.Title,
            RequiresAuth:  menu.RequiresAuth,
            Icon:          menu.Icon,
            MenuType:      menu.MenuType,
            ComponentPath: menu.ComponentPath,
        })
    }

    return routes, nil
}
```

**之前（❌ HTTP 调用）：**
```go
err := s.httpClient.CallService(ctx, "GET", "systemservice", "/system/menus/all", ...)
```

**现在（✅ 直接查数据库）：**
```go
menus, err := s.menuRepo.GetAll(ctx)
```

---

## 🎯 优势

### 之前（❌ HTTP 调用）
- 需要 token 验证
- 需要通过网络调用
- 可能失败（网络/认证）
- 性能较慢

### 现在（✅ Repository）
- 不需要 token
- 直接查数据库
- 更可靠
- 性能更快

---

## 🚀 测试

### 重启 auth 服务

```powershell
# 停止 auth 服务（Ctrl+C）

# 重启
go run cmd/auth/main.go
```

### 验证

1. **系统管理员登录** ✅
2. **租户用户登录** ✅
3. **获取菜单** ✅ 不再报 401 错误
4. **切换租户** ✅ 正常工作

---

## 📝 总结

**问题**: auth 服务用 HTTP 调用 system 服务，但 system 要求认证

**解决**: auth 服务直接用 repository 查数据库，绕过 HTTP 和认证

**结果**: 401 错误消失，菜单正常加载！✅

---

## 🎉 完成

修复后，用户应该能够：
- ✅ 正常登录
- ✅ 获取菜单（不再 401）
- ✅ 切换租户
- ✅ 访问所有功能

**重启 auth 服务后测试！**
