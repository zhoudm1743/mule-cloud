# 配置文件指南

## 📖 概述

本项目使用 **Viper** + **YAML** 进行配置管理，支持：
- ✅ **YAML配置文件**: 结构化配置
- ✅ **环境变量覆盖**: 生产环境灵活配置
- ✅ **热重载**: 配置文件变化自动生效
- ✅ **多环境支持**: dev、test、prod

---

## 📁 配置文件结构

```
mule-cloud/
├── config.yaml              # 默认配置（根目录）
└── config/
    ├── gateway.yaml         # 网关配置
    ├── basic.yaml           # Basic服务配置
    └── test.yaml            # Test服务配置
```

---

## ⚙️ 配置项说明

### 服务器配置 (server)

```yaml
server:
  name: "gateway"           # 服务名称
  host: "0.0.0.0"          # 监听地址
  port: 8080               # 监听端口
  mode: "release"          # 运行模式: debug, release, test
```

### Consul配置 (consul)

```yaml
consul:
  enabled: true                      # 是否启用Consul
  address: "127.0.0.1:8500"         # Consul地址
  scheme: "http"                    # 协议: http, https
  
  # 服务注册
  service_id: ""                    # 服务ID（为空则自动生成）
  service_name: "gateway"           # 服务名称
  service_ip: "127.0.0.1"          # 服务IP
  service_port: 8080               # 服务端口
  tags:                            # 服务标签
    - "gateway"
    - "api"
  
  # 健康检查
  health_check_interval: "10s"     # 健康检查间隔
  health_check_timeout: "5s"       # 健康检查超时
  deregister_after: "30s"          # 失败后注销时间
```

### JWT配置 (jwt)

```yaml
jwt:
  secret_key: "your-secret-key"    # JWT密钥（至少32字符）
  expire_time: 24                  # 过期时间（小时）
  issuer: "mule-cloud"             # 签发者
```

**⚠️ 生产环境**: 必须通过环境变量 `JWT_SECRET` 设置密钥

### Hystrix配置 (hystrix)

```yaml
hystrix:
  enabled: true                    # 是否启用熔断器
  
  # 默认配置（所有未指定的命令使用）
  default:
    timeout: 3000                  # 超时时间（毫秒）
    max_concurrent_requests: 100   # 最大并发数
    request_volume_threshold: 20   # 请求量阈值
    sleep_window: 5000             # 熔断后等待时间（毫秒）
    error_percent_threshold: 50    # 错误率阈值（百分比）
  
  # 服务级别配置
  commands:
    testservice:
      timeout: 2000
      max_concurrent_requests: 50
      request_volume_threshold: 10
      sleep_window: 3000
      error_percent_threshold: 50
    basicservice:
      timeout: 5000
      max_concurrent_requests: 100
      request_volume_threshold: 20
      sleep_window: 5000
      error_percent_threshold: 60
```

### 网关配置 (gateway)

```yaml
gateway:
  # 限流配置
  rate_limit:
    enabled: true                  # 是否启用限流
    rate: 100                      # 每秒请求数
  
  # 超时配置
  timeout:
    read: 30                       # 读超时（秒）
    write: 30                      # 写超时（秒）
  
  # 路由配置
  routes:
    /test:
      service_name: "testservice"  # 目标服务名
      require_auth: true           # 是否需要认证
      require_role: []             # 需要的角色（空=只需登录）
    /basic:
      service_name: "basicservice"
      require_auth: false
      require_role: []
    /admin:
      service_name: "testservice"
      require_auth: true
      require_role:
        - "admin"                  # 需要admin角色
```

### 数据库配置 (database) - 可选

```yaml
database:
  type: "mysql"                    # 数据库类型: mysql, postgres, sqlite
  host: "127.0.0.1"
  port: 3306
  username: "root"
  password: "password"
  database: "mule_cloud"
  charset: "utf8mb4"
  max_idle: 10                     # 最大空闲连接
  max_open: 100                    # 最大打开连接
```

### Redis配置 (redis) - 可选

```yaml
redis:
  enabled: false                   # 是否启用Redis
  host: "127.0.0.1"
  port: 6379
  password: ""
  db: 0
  pool_size: 10
```

### 日志配置 (log)

```yaml
log:
  level: "info"                    # 日志级别: debug, info, warn, error
  format: "text"                   # 日志格式: json, text
  output: "stdout"                 # 输出: stdout, file
  file_path: "logs/app.log"        # 日志文件路径
  max_size: 100                    # 单个文件最大MB
  max_backups: 3                   # 保留文件数量
  max_age: 7                       # 保留天数
  compress: true                   # 是否压缩旧文件
```

---

## 🚀 使用方法

### 1. 在代码中加载配置

```go
package main

import (
    "log"
    "mule-cloud/core/config"
)

func main() {
    // 方法1: 使用默认路径
    cfg, err := config.Load("")
    if err != nil {
        log.Fatalf("加载配置失败: %v", err)
    }

    // 方法2: 指定配置文件
    cfg, err := config.Load("config/gateway.yaml")
    if err != nil {
        log.Fatalf("加载配置失败: %v", err)
    }

    // 方法3: 使用命令行参数
    // go run main.go -config=config/gateway.yaml

    // 打印配置
    config.PrintConfig(cfg)

    // 使用配置
    log.Printf("服务端口: %d", cfg.Server.Port)
    log.Printf("Consul地址: %s", cfg.Consul.Address)
}
```

### 2. 访问配置项

```go
// 获取全局配置
cfg := config.Get()

// 服务器配置
port := cfg.Server.Port
host := cfg.Server.Host

// Consul配置
consulAddr := cfg.Consul.Address

// JWT配置
jwtSecret := cfg.JWT.SecretKey
expireTime := cfg.JWT.ExpireTime

// Hystrix配置
if cfg.Hystrix.Enabled {
    timeout := cfg.Hystrix.Default.Timeout
    // ...
}

// 路由配置
for prefix, route := range cfg.Gateway.Routes {
    log.Printf("路由: %s -> %s", prefix, route.ServiceName)
}
```

### 3. 监听配置变化

```go
// 监听配置文件变化并自动重载
config.Watch(func(newCfg *config.Config) {
    log.Println("配置已更新")
    // 处理配置更新逻辑
})
```

---

## 🌍 环境变量覆盖

环境变量优先级 **高于** 配置文件，适合生产环境使用。

### 命名规则

环境变量格式: `MULE_<配置路径>`

- 前缀: `MULE_`
- 层级分隔符: `_` 替代 `.`

### 示例

```bash
# Consul地址
export MULE_CONSUL_ADDRESS="192.168.1.100:8500"

# JWT密钥
export MULE_JWT_SECRET_KEY="your-production-secret-key"

# 服务IP
export MULE_CONSUL_SERVICE_IP="192.168.1.101"

# 服务端口
export MULE_SERVER_PORT=9090

# 启用Hystrix
export MULE_HYSTRIX_ENABLED=true
```

### Windows环境

```powershell
$env:MULE_CONSUL_ADDRESS="192.168.1.100:8500"
$env:MULE_JWT_SECRET_KEY="your-production-secret-key"
```

### Docker环境

```yaml
# docker-compose.yml
version: '3'
services:
  gateway:
    image: mule-cloud-gateway
    environment:
      - MULE_CONSUL_ADDRESS=consul:8500
      - MULE_JWT_SECRET_KEY=your-secret-key
      - MULE_SERVER_PORT=8080
```

---

## 📋 启动服务

### Gateway

```bash
# 方式1: 使用默认配置
cd gateway
go run main.go

# 方式2: 指定配置文件
go run main.go -config=config/gateway.yaml

# 方式3: 使用环境变量
export MULE_SERVER_PORT=9090
go run main.go
```

### Basic Service

```bash
cd basic/cmd
go run main.go -config=../../config/basic.yaml
```

### Test Service

```bash
cd test/cmd
go run main.go -config=../../config/test.yaml
```

---

## 🎯 多环境配置

### 方式1: 不同配置文件

```
config/
├── gateway.dev.yaml      # 开发环境
├── gateway.test.yaml     # 测试环境
└── gateway.prod.yaml     # 生产环境
```

启动时指定：
```bash
# 开发环境
go run main.go -config=config/gateway.dev.yaml

# 生产环境
go run main.go -config=config/gateway.prod.yaml
```

### 方式2: 环境变量

```bash
# 开发环境
export ENV=dev
go run main.go -config=config/gateway.${ENV}.yaml

# 生产环境
export ENV=prod
go run main.go -config=config/gateway.${ENV}.yaml
```

---

## 🔧 配置最佳实践

### 1. 敏感信息处理

```yaml
# ❌ 错误：敏感信息写在配置文件
jwt:
  secret_key: "my-super-secret-key-12345"

# ✅ 正确：使用环境变量
jwt:
  secret_key: ""  # 留空，通过环境变量设置
```

```bash
export MULE_JWT_SECRET_KEY="$(openssl rand -base64 32)"
```

### 2. 开发与生产分离

```yaml
# config/gateway.dev.yaml (开发)
server:
  mode: "debug"
  port: 8080
log:
  level: "debug"
  output: "stdout"

# config/gateway.prod.yaml (生产)
server:
  mode: "release"
  port: 80
log:
  level: "warn"
  output: "file"
  file_path: "/var/log/gateway.log"
```

### 3. 配置验证

```go
func validateConfig(cfg *config.Config) error {
    if cfg.Server.Port < 1 || cfg.Server.Port > 65535 {
        return fmt.Errorf("无效的端口号: %d", cfg.Server.Port)
    }
    if len(cfg.JWT.SecretKey) < 32 {
        return fmt.Errorf("JWT密钥长度必须至少32字符")
    }
    return nil
}
```

### 4. 配置文档化

在每个配置文件中添加注释：

```yaml
# Gateway 网关配置
# 维护人: DevOps团队
# 更新日期: 2025-09-30

server:
  name: "mule-cloud-gateway"
  port: 8080  # 监听端口，生产环境使用80或443
```

---

## 🐛 故障排查

### 配置文件未找到

```
错误: 读取配置文件失败: Config File "config" Not Found
```

**解决**:
1. 检查配置文件路径
2. 使用绝对路径: `go run main.go -config=/path/to/config.yaml`
3. 查看当前工作目录: `pwd`

### 配置解析失败

```
错误: 解析配置文件失败: yaml: unmarshal errors
```

**解决**:
1. 检查YAML格式（缩进、冒号、引号）
2. 使用在线YAML验证器
3. 检查中文编码（使用UTF-8）

### 环境变量未生效

**解决**:
1. 确认环境变量格式: `MULE_<路径>`
2. 使用 `echo $MULE_SERVER_PORT` 验证
3. 重启服务

---

## 📚 参考资料

- [Viper GitHub](https://github.com/spf13/viper)
- [YAML 语法](https://yaml.org/)
- [12-Factor App 配置](https://12factor.net/config)

---

**快速配置，轻松部署！⚙️**
