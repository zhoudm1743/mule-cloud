# é…ç½®æ–‡ä»¶æŒ‡å—

## ğŸ“– æ¦‚è¿°

æœ¬é¡¹ç›®ä½¿ç”¨ **Viper** + **YAML** è¿›è¡Œé…ç½®ç®¡ç†ï¼Œæ”¯æŒï¼š
- âœ… **YAMLé…ç½®æ–‡ä»¶**: ç»“æ„åŒ–é…ç½®
- âœ… **ç¯å¢ƒå˜é‡è¦†ç›–**: ç”Ÿäº§ç¯å¢ƒçµæ´»é…ç½®
- âœ… **çƒ­é‡è½½**: é…ç½®æ–‡ä»¶å˜åŒ–è‡ªåŠ¨ç”Ÿæ•ˆ
- âœ… **å¤šç¯å¢ƒæ”¯æŒ**: devã€testã€prod

---

## ğŸ“ é…ç½®æ–‡ä»¶ç»“æ„

```
mule-cloud/
â”œâ”€â”€ config.yaml              # é»˜è®¤é…ç½®ï¼ˆæ ¹ç›®å½•ï¼‰
â””â”€â”€ config/
    â”œâ”€â”€ gateway.yaml         # ç½‘å…³é…ç½®
    â”œâ”€â”€ basic.yaml           # BasicæœåŠ¡é…ç½®
    â””â”€â”€ test.yaml            # TestæœåŠ¡é…ç½®
```

---

## âš™ï¸ é…ç½®é¡¹è¯´æ˜

### æœåŠ¡å™¨é…ç½® (server)

```yaml
server:
  name: "gateway"           # æœåŠ¡åç§°
  host: "0.0.0.0"          # ç›‘å¬åœ°å€
  port: 8080               # ç›‘å¬ç«¯å£
  mode: "release"          # è¿è¡Œæ¨¡å¼: debug, release, test
```

### Consulé…ç½® (consul)

```yaml
consul:
  enabled: true                      # æ˜¯å¦å¯ç”¨Consul
  address: "127.0.0.1:8500"         # Consulåœ°å€
  scheme: "http"                    # åè®®: http, https
  
  # æœåŠ¡æ³¨å†Œ
  service_id: ""                    # æœåŠ¡IDï¼ˆä¸ºç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆï¼‰
  service_name: "gateway"           # æœåŠ¡åç§°
  service_ip: "127.0.0.1"          # æœåŠ¡IP
  service_port: 8080               # æœåŠ¡ç«¯å£
  tags:                            # æœåŠ¡æ ‡ç­¾
    - "gateway"
    - "api"
  
  # å¥åº·æ£€æŸ¥
  health_check_interval: "10s"     # å¥åº·æ£€æŸ¥é—´éš”
  health_check_timeout: "5s"       # å¥åº·æ£€æŸ¥è¶…æ—¶
  deregister_after: "30s"          # å¤±è´¥åæ³¨é”€æ—¶é—´
```

### JWTé…ç½® (jwt)

```yaml
jwt:
  secret_key: "your-secret-key"    # JWTå¯†é’¥ï¼ˆè‡³å°‘32å­—ç¬¦ï¼‰
  expire_time: 24                  # è¿‡æœŸæ—¶é—´ï¼ˆå°æ—¶ï¼‰
  issuer: "mule-cloud"             # ç­¾å‘è€…
```

**âš ï¸ ç”Ÿäº§ç¯å¢ƒ**: å¿…é¡»é€šè¿‡ç¯å¢ƒå˜é‡ `JWT_SECRET` è®¾ç½®å¯†é’¥

### Hystrixé…ç½® (hystrix)

```yaml
hystrix:
  enabled: true                    # æ˜¯å¦å¯ç”¨ç†”æ–­å™¨
  
  # é»˜è®¤é…ç½®ï¼ˆæ‰€æœ‰æœªæŒ‡å®šçš„å‘½ä»¤ä½¿ç”¨ï¼‰
  default:
    timeout: 3000                  # è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    max_concurrent_requests: 100   # æœ€å¤§å¹¶å‘æ•°
    request_volume_threshold: 20   # è¯·æ±‚é‡é˜ˆå€¼
    sleep_window: 5000             # ç†”æ–­åç­‰å¾…æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    error_percent_threshold: 50    # é”™è¯¯ç‡é˜ˆå€¼ï¼ˆç™¾åˆ†æ¯”ï¼‰
  
  # æœåŠ¡çº§åˆ«é…ç½®
  commands:
    testservice:
      timeout: 2000
      max_concurrent_requests: 50
      request_volume_threshold: 10
      sleep_window: 3000
      error_percent_threshold: 50
    basicservice:
      timeout: 5000
      max_concurrent_requests: 100
      request_volume_threshold: 20
      sleep_window: 5000
      error_percent_threshold: 60
```

### ç½‘å…³é…ç½® (gateway)

```yaml
gateway:
  # é™æµé…ç½®
  rate_limit:
    enabled: true                  # æ˜¯å¦å¯ç”¨é™æµ
    rate: 100                      # æ¯ç§’è¯·æ±‚æ•°
  
  # è¶…æ—¶é…ç½®
  timeout:
    read: 30                       # è¯»è¶…æ—¶ï¼ˆç§’ï¼‰
    write: 30                      # å†™è¶…æ—¶ï¼ˆç§’ï¼‰
  
  # è·¯ç”±é…ç½®
  routes:
    /test:
      service_name: "testservice"  # ç›®æ ‡æœåŠ¡å
      require_auth: true           # æ˜¯å¦éœ€è¦è®¤è¯
      require_role: []             # éœ€è¦çš„è§’è‰²ï¼ˆç©º=åªéœ€ç™»å½•ï¼‰
    /basic:
      service_name: "basicservice"
      require_auth: false
      require_role: []
    /admin:
      service_name: "testservice"
      require_auth: true
      require_role:
        - "admin"                  # éœ€è¦adminè§’è‰²
```

### æ•°æ®åº“é…ç½® (database) - å¯é€‰

```yaml
database:
  type: "mysql"                    # æ•°æ®åº“ç±»å‹: mysql, postgres, sqlite
  host: "127.0.0.1"
  port: 3306
  username: "root"
  password: "password"
  database: "mule_cloud"
  charset: "utf8mb4"
  max_idle: 10                     # æœ€å¤§ç©ºé—²è¿æ¥
  max_open: 100                    # æœ€å¤§æ‰“å¼€è¿æ¥
```

### Redisé…ç½® (redis) - å¯é€‰

```yaml
redis:
  enabled: false                   # æ˜¯å¦å¯ç”¨Redis
  host: "127.0.0.1"
  port: 6379
  password: ""
  db: 0
  pool_size: 10
```

### æ—¥å¿—é…ç½® (log)

```yaml
log:
  level: "info"                    # æ—¥å¿—çº§åˆ«: debug, info, warn, error
  format: "text"                   # æ—¥å¿—æ ¼å¼: json, text
  output: "stdout"                 # è¾“å‡º: stdout, file
  file_path: "logs/app.log"        # æ—¥å¿—æ–‡ä»¶è·¯å¾„
  max_size: 100                    # å•ä¸ªæ–‡ä»¶æœ€å¤§MB
  max_backups: 3                   # ä¿ç•™æ–‡ä»¶æ•°é‡
  max_age: 7                       # ä¿ç•™å¤©æ•°
  compress: true                   # æ˜¯å¦å‹ç¼©æ—§æ–‡ä»¶
```

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. åœ¨ä»£ç ä¸­åŠ è½½é…ç½®

```go
package main

import (
    "log"
    "mule-cloud/core/config"
)

func main() {
    // æ–¹æ³•1: ä½¿ç”¨é»˜è®¤è·¯å¾„
    cfg, err := config.Load("")
    if err != nil {
        log.Fatalf("åŠ è½½é…ç½®å¤±è´¥: %v", err)
    }

    // æ–¹æ³•2: æŒ‡å®šé…ç½®æ–‡ä»¶
    cfg, err := config.Load("config/gateway.yaml")
    if err != nil {
        log.Fatalf("åŠ è½½é…ç½®å¤±è´¥: %v", err)
    }

    // æ–¹æ³•3: ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°
    // go run main.go -config=config/gateway.yaml

    // æ‰“å°é…ç½®
    config.PrintConfig(cfg)

    // ä½¿ç”¨é…ç½®
    log.Printf("æœåŠ¡ç«¯å£: %d", cfg.Server.Port)
    log.Printf("Consulåœ°å€: %s", cfg.Consul.Address)
}
```

### 2. è®¿é—®é…ç½®é¡¹

```go
// è·å–å…¨å±€é…ç½®
cfg := config.Get()

// æœåŠ¡å™¨é…ç½®
port := cfg.Server.Port
host := cfg.Server.Host

// Consulé…ç½®
consulAddr := cfg.Consul.Address

// JWTé…ç½®
jwtSecret := cfg.JWT.SecretKey
expireTime := cfg.JWT.ExpireTime

// Hystrixé…ç½®
if cfg.Hystrix.Enabled {
    timeout := cfg.Hystrix.Default.Timeout
    // ...
}

// è·¯ç”±é…ç½®
for prefix, route := range cfg.Gateway.Routes {
    log.Printf("è·¯ç”±: %s -> %s", prefix, route.ServiceName)
}
```

### 3. ç›‘å¬é…ç½®å˜åŒ–

```go
// ç›‘å¬é…ç½®æ–‡ä»¶å˜åŒ–å¹¶è‡ªåŠ¨é‡è½½
config.Watch(func(newCfg *config.Config) {
    log.Println("é…ç½®å·²æ›´æ–°")
    // å¤„ç†é…ç½®æ›´æ–°é€»è¾‘
})
```

---

## ğŸŒ ç¯å¢ƒå˜é‡è¦†ç›–

ç¯å¢ƒå˜é‡ä¼˜å…ˆçº§ **é«˜äº** é…ç½®æ–‡ä»¶ï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚

### å‘½åè§„åˆ™

ç¯å¢ƒå˜é‡æ ¼å¼: `MULE_<é…ç½®è·¯å¾„>`

- å‰ç¼€: `MULE_`
- å±‚çº§åˆ†éš”ç¬¦: `_` æ›¿ä»£ `.`

### ç¤ºä¾‹

```bash
# Consulåœ°å€
export MULE_CONSUL_ADDRESS="192.168.1.100:8500"

# JWTå¯†é’¥
export MULE_JWT_SECRET_KEY="your-production-secret-key"

# æœåŠ¡IP
export MULE_CONSUL_SERVICE_IP="192.168.1.101"

# æœåŠ¡ç«¯å£
export MULE_SERVER_PORT=9090

# å¯ç”¨Hystrix
export MULE_HYSTRIX_ENABLED=true
```

### Windowsç¯å¢ƒ

```powershell
$env:MULE_CONSUL_ADDRESS="192.168.1.100:8500"
$env:MULE_JWT_SECRET_KEY="your-production-secret-key"
```

### Dockerç¯å¢ƒ

```yaml
# docker-compose.yml
version: '3'
services:
  gateway:
    image: mule-cloud-gateway
    environment:
      - MULE_CONSUL_ADDRESS=consul:8500
      - MULE_JWT_SECRET_KEY=your-secret-key
      - MULE_SERVER_PORT=8080
```

---

## ğŸ“‹ å¯åŠ¨æœåŠ¡

### Gateway

```bash
# æ–¹å¼1: ä½¿ç”¨é»˜è®¤é…ç½®
cd gateway
go run main.go

# æ–¹å¼2: æŒ‡å®šé…ç½®æ–‡ä»¶
go run main.go -config=config/gateway.yaml

# æ–¹å¼3: ä½¿ç”¨ç¯å¢ƒå˜é‡
export MULE_SERVER_PORT=9090
go run main.go
```

### Basic Service

```bash
cd basic/cmd
go run main.go -config=../../config/basic.yaml
```

### Test Service

```bash
cd test/cmd
go run main.go -config=../../config/test.yaml
```

---

## ğŸ¯ å¤šç¯å¢ƒé…ç½®

### æ–¹å¼1: ä¸åŒé…ç½®æ–‡ä»¶

```
config/
â”œâ”€â”€ gateway.dev.yaml      # å¼€å‘ç¯å¢ƒ
â”œâ”€â”€ gateway.test.yaml     # æµ‹è¯•ç¯å¢ƒ
â””â”€â”€ gateway.prod.yaml     # ç”Ÿäº§ç¯å¢ƒ
```

å¯åŠ¨æ—¶æŒ‡å®šï¼š
```bash
# å¼€å‘ç¯å¢ƒ
go run main.go -config=config/gateway.dev.yaml

# ç”Ÿäº§ç¯å¢ƒ
go run main.go -config=config/gateway.prod.yaml
```

### æ–¹å¼2: ç¯å¢ƒå˜é‡

```bash
# å¼€å‘ç¯å¢ƒ
export ENV=dev
go run main.go -config=config/gateway.${ENV}.yaml

# ç”Ÿäº§ç¯å¢ƒ
export ENV=prod
go run main.go -config=config/gateway.${ENV}.yaml
```

---

## ğŸ”§ é…ç½®æœ€ä½³å®è·µ

### 1. æ•æ„Ÿä¿¡æ¯å¤„ç†

```yaml
# âŒ é”™è¯¯ï¼šæ•æ„Ÿä¿¡æ¯å†™åœ¨é…ç½®æ–‡ä»¶
jwt:
  secret_key: "my-super-secret-key-12345"

# âœ… æ­£ç¡®ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡
jwt:
  secret_key: ""  # ç•™ç©ºï¼Œé€šè¿‡ç¯å¢ƒå˜é‡è®¾ç½®
```

```bash
export MULE_JWT_SECRET_KEY="$(openssl rand -base64 32)"
```

### 2. å¼€å‘ä¸ç”Ÿäº§åˆ†ç¦»

```yaml
# config/gateway.dev.yaml (å¼€å‘)
server:
  mode: "debug"
  port: 8080
log:
  level: "debug"
  output: "stdout"

# config/gateway.prod.yaml (ç”Ÿäº§)
server:
  mode: "release"
  port: 80
log:
  level: "warn"
  output: "file"
  file_path: "/var/log/gateway.log"
```

### 3. é…ç½®éªŒè¯

```go
func validateConfig(cfg *config.Config) error {
    if cfg.Server.Port < 1 || cfg.Server.Port > 65535 {
        return fmt.Errorf("æ— æ•ˆçš„ç«¯å£å·: %d", cfg.Server.Port)
    }
    if len(cfg.JWT.SecretKey) < 32 {
        return fmt.Errorf("JWTå¯†é’¥é•¿åº¦å¿…é¡»è‡³å°‘32å­—ç¬¦")
    }
    return nil
}
```

### 4. é…ç½®æ–‡æ¡£åŒ–

åœ¨æ¯ä¸ªé…ç½®æ–‡ä»¶ä¸­æ·»åŠ æ³¨é‡Šï¼š

```yaml
# Gateway ç½‘å…³é…ç½®
# ç»´æŠ¤äºº: DevOpså›¢é˜Ÿ
# æ›´æ–°æ—¥æœŸ: 2025-09-30

server:
  name: "mule-cloud-gateway"
  port: 8080  # ç›‘å¬ç«¯å£ï¼Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨80æˆ–443
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### é…ç½®æ–‡ä»¶æœªæ‰¾åˆ°

```
é”™è¯¯: è¯»å–é…ç½®æ–‡ä»¶å¤±è´¥: Config File "config" Not Found
```

**è§£å†³**:
1. æ£€æŸ¥é…ç½®æ–‡ä»¶è·¯å¾„
2. ä½¿ç”¨ç»å¯¹è·¯å¾„: `go run main.go -config=/path/to/config.yaml`
3. æŸ¥çœ‹å½“å‰å·¥ä½œç›®å½•: `pwd`

### é…ç½®è§£æå¤±è´¥

```
é”™è¯¯: è§£æé…ç½®æ–‡ä»¶å¤±è´¥: yaml: unmarshal errors
```

**è§£å†³**:
1. æ£€æŸ¥YAMLæ ¼å¼ï¼ˆç¼©è¿›ã€å†’å·ã€å¼•å·ï¼‰
2. ä½¿ç”¨åœ¨çº¿YAMLéªŒè¯å™¨
3. æ£€æŸ¥ä¸­æ–‡ç¼–ç ï¼ˆä½¿ç”¨UTF-8ï¼‰

### ç¯å¢ƒå˜é‡æœªç”Ÿæ•ˆ

**è§£å†³**:
1. ç¡®è®¤ç¯å¢ƒå˜é‡æ ¼å¼: `MULE_<è·¯å¾„>`
2. ä½¿ç”¨ `echo $MULE_SERVER_PORT` éªŒè¯
3. é‡å¯æœåŠ¡

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [Viper GitHub](https://github.com/spf13/viper)
- [YAML è¯­æ³•](https://yaml.org/)
- [12-Factor App é…ç½®](https://12factor.net/config)

---

**å¿«é€Ÿé…ç½®ï¼Œè½»æ¾éƒ¨ç½²ï¼âš™ï¸**
