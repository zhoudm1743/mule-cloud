# 人员系统快速开始

## 🎉 完成状态

✅ **后端API** - 已完成  
✅ **小程序前端** - 已完成  
✅ **数据迁移脚本** - 已完成  

---

## 📦 已实现的功能

### 后端API
1. ✅ 扩展TenantMember模型（59个完整字段）
2. ✅ 员工档案查询API（`GET /miniapp/member/profile`）
3. ✅ 更新基本信息API（`PUT /miniapp/member/profile/basic`）
4. ✅ 更新联系信息API（`PUT /miniapp/member/profile/contact`）
5. ✅ 上传照片API（`POST /miniapp/member/profile/photo`）

### 小程序前端
1. ✅ 个人档案页面（完整展示）
2. ✅ 编辑基本信息页面（扩展版，支持身份证、生日、民族等）
3. ✅ 编辑联系信息页面
4. ✅ 工作信息页面（只读）
5. ✅ 技能证书页面（只读）

### 数据迁移
1. ✅ Python迁移脚本（`scripts/migrate_member_fields.py`）
2. ✅ Python查询脚本（`scripts/query_member_data.py`）

---

## 🚀 快速开始

### 步骤1：数据迁移

```bash
# 1. 安装依赖
pip install pymongo

# 2. 运行迁移脚本（会提示确认）
py scripts/migrate_member_fields.py

# 3. 验证数据（可选）
py scripts/query_member_data.py
```

### 步骤2：启动后端服务

```bash
# 启动miniapp服务
cd cmd/miniapp
go run main.go

# 或使用配置文件
go run main.go -config=../../config/miniapp.yaml
```

后端API地址：
- 本地：`http://localhost:8007`
- 通过网关：`http://localhost:8080/api/miniapp/`

### 步骤3：配置小程序

确保小程序的API基础地址正确配置：

```javascript
// wxApp/src/utils/request.js
const baseURL = 'http://your-server:8080/api'  // 通过网关访问
```

### 步骤4：测试功能

1. **登录小程序**
   - 使用微信登录
   - 选择/切换租户

2. **查看个人档案**
   - 访问"我的"页面
   - 点击"个人档案"（需要添加入口）

3. **编辑信息**
   - 点击各个信息卡片
   - 编辑并保存
   - 验证数据更新

---

## 📡 API接口列表

| 方法 | 路径 | 说明 | 认证 |
|------|------|------|------|
| GET | `/miniapp/member/profile` | 获取个人档案 | 需要 |
| PUT | `/miniapp/member/profile/basic` | 更新基本信息 | 需要 |
| PUT | `/miniapp/member/profile/contact` | 更新联系信息 | 需要 |
| POST | `/miniapp/member/profile/photo` | 上传照片 | 需要 |

### API使用示例

```javascript
// 1. 获取个人档案
import { getProfile } from '@/api/member'

const res = await getProfile()
console.log(res.data) // 完整的员工档案

// 2. 更新基本信息
import { updateBasicInfo } from '@/api/member'

await updateBasicInfo({
  name: '张三',
  gender: 1,
  id_card_no: '430121199501011234',
  birthday: 946656000,
  nation: '汉族',
  native_place: '湖南长沙',
  marital_status: 'married',
  political: 'masses',
  education: 'college'
})

// 3. 更新联系信息
import { updateContactInfo } from '@/api/member'

await updateContactInfo({
  phone: '13800138000',
  email: 'zhangsan@example.com',
  address: '广东省深圳市...',
  emergency_contact: '李四',
  emergency_phone: '13900139000',
  emergency_relation: '父亲'
})

// 4. 上传照片
import { uploadPhoto } from '@/api/member'

await uploadPhoto({
  type: 'avatar',  // 或 'photo'
  url: 'https://cdn.example.com/photo.jpg'
})
```

---

## 📂 文件结构

```
mule-cloud/
├── internal/models/
│   └── tenant_member.go           # 扩展后的员工模型
├── internal/repository/
│   └── tenant_member.go           # Repository（已存在）
├── app/miniapp/
│   ├── dto/
│   │   └── member.go              # 员工相关DTO
│   ├── services/
│   │   └── member_service.go      # 员工服务
│   ├── endpoint/
│   │   └── member.go              # API端点
│   └── transport/
│       └── member.go              # HTTP路由
├── cmd/miniapp/
│   └── main.go                    # 已注册新路由
├── scripts/
│   ├── migrate_member_fields.py   # 数据迁移脚本
│   └── query_member_data.py       # 数据查询脚本
├── wxApp/src/
│   ├── api/
│   │   └── member.js              # API接口
│   └── pages/member/
│       ├── profile/               # 个人档案页面
│       ├── edit-contact/          # 编辑联系信息
│       ├── work-info/             # 工作信息
│       └── skills/                # 技能证书
└── docs/
    ├── 人员系统实施方案.md          # 详细方案
    └── 人员系统快速开始.md          # 本文档
```

---

## 🔍 数据查询工具

### 使用Python查询脚本

```bash
py scripts/query_member_data.py
```

功能：
1. 查看所有租户数据库
2. 查看指定租户的员工列表
3. 查看指定员工的详细信息
4. 统计信息（人数、部门分布、学历分布等）

### 使用MongoDB命令行

```javascript
// 切换到租户数据库
use tenant_ace

// 查看员工列表
db.member.find({is_deleted: 0}, {name: 1, job_number: 1, department: 1})

// 查看指定员工详情
db.member.findOne({job_number: 'GY001'})

// 统计在职员工数
db.member.countDocuments({status: 'active', is_deleted: 0})

// 按部门统计
db.member.aggregate([
  {$match: {status: 'active', is_deleted: 0}},
  {$group: {_id: '$department', count: {$sum: 1}}}
])
```

---

## 📋 员工可编辑字段列表

员工通过小程序可以编辑以下字段：

### 基本信息
- ✅ 姓名
- ✅ 性别
- ✅ 身份证号（首次填写后不可修改）
- ✅ 出生日期
- ✅ 民族
- ✅ 籍贯
- ✅ 婚姻状况
- ✅ 政治面貌
- ✅ 学历
- ✅ 头像
- ✅ 证件照

### 联系信息
- ✅ 手机号
- ✅ 邮箱
- ✅ 家庭住址
- ✅ 紧急联系人姓名
- ✅ 紧急联系电话
- ✅ 紧急联系人关系

### 只读字段（只能由管理员修改）
- ❌ 工号
- ❌ 部门、岗位
- ❌ 车间、班组
- ❌ 入职日期、工龄
- ❌ 合同信息
- ❌ 技能与证书
- ❌ 薪资信息

---

## 🔒 安全特性

1. **敏感信息脱敏**
   - 身份证号：显示为 `430***********1234`
   - 银行卡号：显示为 `6222 **** **** 1234`

2. **字段权限控制**
   - 员工只能编辑允许的字段
   - 敏感字段（工号、薪资等）只读

3. **数据验证**
   - 身份证号首次填写后不可修改
   - 枚举值验证（婚姻状况、学历等）

4. **租户隔离**
   - 数据存储在租户独立数据库
   - Context自动切换数据库
   - 物理隔离保证安全

---

## 🐛 常见问题

### 1. 迁移后数据未显示

**原因**：可能是数据库未正确迁移

**解决**：
```bash
# 运行查询脚本查看数据
py scripts/query_member_data.py

# 重新运行迁移
py scripts/migrate_member_fields.py
```

### 2. API返回401错误

**原因**：JWT Token未正确传递

**解决**：
- 检查小程序是否已登录
- 检查Token是否已过期
- 检查请求头是否包含`Authorization: Bearer {token}`

### 3. 照片上传失败

**原因**：文件上传接口配置问题

**解决**：
- 检查`uploadFile`函数实现
- 确认服务器支持文件上传
- 检查文件大小限制

### 4. 日期选择器不显示

**原因**：uView UI组件未正确安装

**解决**：
```bash
# 确保安装了uView UI
npm install uview-ui

# 在main.js中引入
import uView from 'uview-ui'
Vue.use(uView)
```

---

## 📊 数据模型字段说明

| 分类 | 字段数 | 说明 |
|------|--------|------|
| 基础关联 | 2 | UnionID, UserID |
| 个人基本信息 | 13 | 姓名、性别、身份证、生日等 |
| 联系信息 | 6 | 手机、邮箱、地址、紧急联系人等 |
| 企业信息 | 10 | 工号、部门、岗位、车间、班组等 |
| 权限与角色 | 2 | Roles, Permissions |
| 工作相关 | 7 | 入职日期、工龄、合同等 |
| 技能与资质 | 2 | Skills, Certificates |
| 薪资信息 | 8 | 薪资类型、基本工资、银行卡等 |
| 状态 | 3 | Status, LeftAt, LeftReason |
| 系统字段 | 5 | 创建时间、更新时间等 |
| **总计** | **59** | |

---

## 🎯 下一步扩展

### 短期（1-2周）
- [ ] 在小程序"我的"页面添加"个人档案"入口
- [ ] 添加头像裁剪功能
- [ ] 添加表单验证增强

### 中期（1-2个月）
- [ ] PC管理后台（员工管理）
- [ ] 批量导入/导出功能
- [ ] 合同到期提醒
- [ ] 生日提醒

### 长期（3-6个月）
- [ ] 员工绩效管理
- [ ] 电子工资条
- [ ] 培训记录管理
- [ ] 技能成长轨迹

---

## 📞 支持

如有问题，请查看：
1. [人员系统实施方案](./人员系统实施方案.md) - 详细设计文档
2. [微信小程序多租户用户系统设计方案](./微信小程序多租户用户系统设计方案.md) - 多租户架构说明

---

**文档版本**：v1.0  
**创建日期**：2025-10-19  
**状态**：已完成 ✅

