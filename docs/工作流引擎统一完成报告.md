# 工作流引擎统一完成报告

## 📅 完成时间
2025年10月19日

## 🎯 目标

统一使用 `app/order/services/workflow_engine` 作为唯一的工作流引擎，移除对 `core/workflow` 的直接依赖。

## 🔄 重构内容

### 1. **Production 服务重构** ✅

#### 修改文件：`app/production/services/report.go`

**变更内容**：

1. **移除 core/workflow 依赖**
   ```go
   // 删除
   import "mule-cloud/core/workflow"
   
   // 添加
   import "mule-cloud/app/order/services"
   ```

2. **修改服务结构体**
   ```go
   type reportService struct {
       // ... 其他字段
       workflow *workflow.OrderWorkflow  // ❌ 删除
       workflowEngine services.IWorkflowEngineService  // ✅ 添加
   }
   ```

3. **修改初始化方法**
   ```go
   func NewReportService() IReportService {
       return &reportService{
           // ...
           workflow: workflow.NewOrderWorkflow(),  // ❌ 删除
           workflowEngine: services.NewWorkflowEngineService(),  // ✅ 添加
       }
   }
   ```

4. **重写状态转换逻辑**

**修改前**：使用 `core/workflow`
```go
func (s *reportService) triggerWorkflowByProgress(ctx context.Context, orderID string, orderProgress float64, completedCount, totalPieces int) {
    order, err := s.orderRepo.Get(ctx, orderID)
    if err != nil {
        return
    }
    
    currentStatus := workflow.OrderStatus(order.Status)
    
    if orderProgress >= 1.0 && currentStatus == workflow.StatusProduction {
        err = s.workflow.TransitionToAdvanced(
            ctx,
            orderID,
            workflow.EventComplete,
            "system",
            "",
            "所有裁片已完成",
            metadata,
        )
    } else if orderProgress > 0 && (currentStatus == workflow.StatusOrdered || currentStatus == workflow.StatusDraft) {
        err = s.workflow.StartProduction(ctx, orderID, "system", "工序上报自动触发")
    }
}
```

**修改后**：使用 `workflow_engine`
```go
func (s *reportService) triggerWorkflowByProgress(ctx context.Context, orderID string, orderProgress float64, completedCount, totalPieces int) {
    order, err := s.orderRepo.Get(ctx, orderID)
    if err != nil {
        return
    }
    
    // 使用数字状态码直接比较
    if orderProgress >= 1.0 && order.Status == 2 { // 2 = 生产中
        err = s.workflowEngine.TransitionOrderState(
            ctx,
            orderID,
            "complete",  // 事件名称
            "system",
            "所有裁片已完成",
            metadata,
        )
    } else if orderProgress > 0 && (order.Status == 0 || order.Status == 1) {
        // 根据当前状态选择事件
        event := "start_production"
        if order.Status == 0 {
            event = "submit_order"  // 从草稿先提交
        }
        
        err = s.workflowEngine.TransitionOrderState(ctx, orderID, event, "system", "工序上报自动触发", nil)
        
        // 如果是从草稿，再转到生产中
        if event == "submit_order" {
            s.workflowEngine.TransitionOrderState(ctx, orderID, "start_production", "system", "工序上报自动触发", nil)
        }
    }
}
```

5. **更新进度计算方法**

**修改前**：
```go
func (s *reportService) updateOrderProgress(ctx context.Context, orderID string) {
    // ... 计算进度
    _ = s.workflow.UpdateProgress(ctx, orderID, newProgress, operator)
}
```

**修改后**：
```go
func (s *reportService) updateOrderProgress(ctx context.Context, orderID string) {
    // ... 计算进度
    
    // 直接更新订单进度字段
    _ = s.orderRepo.Update(ctx, orderID, bson.M{
        "progress":   newProgress,
        "updated_at": time.Now().Unix(),
    })
    
    fmt.Printf("📊 订单进度更新（基于工序）: 订单=%s, 进度=%.2f%%\n", orderID, newProgress*100)
}
```

### 2. **Order 服务保持不变** ✅

Order 服务已经使用 `workflow_engine`，无需修改。

### 3. **core/workflow 保留但不直接使用** ✅

`core/workflow` 包保留作为底层实现，但不再被 Production 服务直接调用。

## 📊 状态转换事件映射

### workflow_engine 支持的事件

| 事件名称 | 说明 | 源状态 | 目标状态 |
|---------|------|--------|---------|
| `submit_order` | 提交订单 | 草稿 (0) | 已下单 (1) |
| `start_production` | 开始生产 | 已下单 (1) | 生产中 (2) |
| `complete` | 完成订单 | 生产中 (2) | 已完成 (3) |
| `cancel` | 取消订单 | 任意 | 已取消 (4) |

### 状态码定义

| 状态码 | 状态名称 | workflow_state | 说明 |
|-------|---------|----------------|------|
| 0 | 草稿 | draft | 订单草稿 |
| 1 | 已下单 | ordered | 订单已提交 |
| 2 | 生产中 | production | 正在生产 |
| 3 | 已完成 | completed | 生产完成 |
| 4 | 已取消 | cancelled | 订单取消 |

## ✅ 核心优势

### 统一架构

1. **单一工作流引擎**
   - 只使用 `workflow_engine`
   - 所有状态转换通过数据库工作流定义
   - 支持工作流设计器

2. **状态字段同步**
   - `status` 和 `workflow_state` 始终同步
   - 通过 `workflow_engine` 统一更新
   - 避免状态不一致

3. **灵活可配置**
   - 工作流定义存储在 MongoDB
   - 支持可视化工作流设计器
   - 可动态修改工作流规则

### 智能状态转换

1. **自动开始生产**
   ```
   条件：订单有进度 (progress > 0) 且状态为"草稿"或"已下单"
   操作：自动转换到"生产中"
   ```

2. **自动完成订单**
   ```
   条件：订单进度达到100% 且状态为"生产中"
   操作：自动转换到"已完成"
   ```

3. **状态转换日志**
   - 记录到 `workflow_instances.history`
   - 包含操作者、原因、时间戳
   - 完整的审计追踪

## 🔍 工作流实例数据结构

```javascript
{
  "_id": "workflow_instance_id",
  "workflow_id": "basic_order_workflow_id",
  "entity_type": "order",
  "entity_id": "order_id",
  "current_state": "production",  // 当前状态
  "variables": {
    "progress": 0.56,
    "completed_count": 2,
    "total_pieces": 4
  },
  "history": [
    {
      "from_state": "draft",
      "to_state": "ordered",
      "event": "submit_order",
      "operator": "system",
      "reason": "订单创建",
      "timestamp": 1729123456,
      "metadata": {}
    },
    {
      "from_state": "ordered",
      "to_state": "production",
      "event": "start_production",
      "operator": "system",
      "reason": "工序上报自动触发",
      "timestamp": 1729234567,
      "metadata": {
        "progress": 0.13
      }
    }
  ],
  "created_at": 1729123456,
  "updated_at": 1729234567
}
```

## 📝 API调用示例

### 执行状态转换

```go
// Production 服务中的调用
err := s.workflowEngine.TransitionOrderState(
    ctx,
    orderID,
    "complete",  // 事件
    "system",    // 操作者
    "所有裁片已完成",  // 原因
    map[string]interface{}{
        "progress": 1.0,
        "completed_count": 10,
        "total_pieces": 10,
    },
)
```

### 获取工作流状态

```go
instance, err := s.workflowEngine.GetOrderWorkflowState(ctx, orderID)
// instance.CurrentState = "production"
```

### 获取可用转换

```go
transitions, err := s.workflowEngine.GetAvailableTransitions(ctx, orderID)
// 返回当前状态可执行的所有转换
```

## 🚀 部署步骤

1. **停止服务**
   ```bash
   # 停止 Production Service
   # 停止 Order Service
   ```

2. **重新编译**
   ```bash
   go build -o ./bin/production.exe ./cmd/production
   go build -o ./bin/order.exe ./cmd/order
   ```

3. **启动服务**
   ```bash
   # 启动 Order Service
   # 启动 Production Service
   ```

4. **验证功能**
   - 扫码上报工序
   - 检查订单状态自动转换
   - 验证工作流状态同步

## 🎉 重构完成

### 编译状态
- ✅ Production Service 编译成功
- ✅ Order Service 编译成功

### 功能验证待完成
- ⏳ 扫码上报工序测试
- ⏳ 自动状态转换测试
- ⏳ 工作流历史记录验证

---

**重构完成！** 🎊

现在系统使用统一的工作流引擎，架构更清晰，状态管理更可靠！

