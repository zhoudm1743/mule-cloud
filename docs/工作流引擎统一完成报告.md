# å·¥ä½œæµå¼•æ“ç»Ÿä¸€å®ŒæˆæŠ¥å‘Š

## ğŸ“… å®Œæˆæ—¶é—´
2025å¹´10æœˆ19æ—¥

## ğŸ¯ ç›®æ ‡

ç»Ÿä¸€ä½¿ç”¨ `app/order/services/workflow_engine` ä½œä¸ºå”¯ä¸€çš„å·¥ä½œæµå¼•æ“ï¼Œç§»é™¤å¯¹ `core/workflow` çš„ç›´æ¥ä¾èµ–ã€‚

## ğŸ”„ é‡æ„å†…å®¹

### 1. **Production æœåŠ¡é‡æ„** âœ…

#### ä¿®æ”¹æ–‡ä»¶ï¼š`app/production/services/report.go`

**å˜æ›´å†…å®¹**ï¼š

1. **ç§»é™¤ core/workflow ä¾èµ–**
   ```go
   // åˆ é™¤
   import "mule-cloud/core/workflow"
   
   // æ·»åŠ 
   import "mule-cloud/app/order/services"
   ```

2. **ä¿®æ”¹æœåŠ¡ç»“æ„ä½“**
   ```go
   type reportService struct {
       // ... å…¶ä»–å­—æ®µ
       workflow *workflow.OrderWorkflow  // âŒ åˆ é™¤
       workflowEngine services.IWorkflowEngineService  // âœ… æ·»åŠ 
   }
   ```

3. **ä¿®æ”¹åˆå§‹åŒ–æ–¹æ³•**
   ```go
   func NewReportService() IReportService {
       return &reportService{
           // ...
           workflow: workflow.NewOrderWorkflow(),  // âŒ åˆ é™¤
           workflowEngine: services.NewWorkflowEngineService(),  // âœ… æ·»åŠ 
       }
   }
   ```

4. **é‡å†™çŠ¶æ€è½¬æ¢é€»è¾‘**

**ä¿®æ”¹å‰**ï¼šä½¿ç”¨ `core/workflow`
```go
func (s *reportService) triggerWorkflowByProgress(ctx context.Context, orderID string, orderProgress float64, completedCount, totalPieces int) {
    order, err := s.orderRepo.Get(ctx, orderID)
    if err != nil {
        return
    }
    
    currentStatus := workflow.OrderStatus(order.Status)
    
    if orderProgress >= 1.0 && currentStatus == workflow.StatusProduction {
        err = s.workflow.TransitionToAdvanced(
            ctx,
            orderID,
            workflow.EventComplete,
            "system",
            "",
            "æ‰€æœ‰è£ç‰‡å·²å®Œæˆ",
            metadata,
        )
    } else if orderProgress > 0 && (currentStatus == workflow.StatusOrdered || currentStatus == workflow.StatusDraft) {
        err = s.workflow.StartProduction(ctx, orderID, "system", "å·¥åºä¸ŠæŠ¥è‡ªåŠ¨è§¦å‘")
    }
}
```

**ä¿®æ”¹å**ï¼šä½¿ç”¨ `workflow_engine`
```go
func (s *reportService) triggerWorkflowByProgress(ctx context.Context, orderID string, orderProgress float64, completedCount, totalPieces int) {
    order, err := s.orderRepo.Get(ctx, orderID)
    if err != nil {
        return
    }
    
    // ä½¿ç”¨æ•°å­—çŠ¶æ€ç ç›´æ¥æ¯”è¾ƒ
    if orderProgress >= 1.0 && order.Status == 2 { // 2 = ç”Ÿäº§ä¸­
        err = s.workflowEngine.TransitionOrderState(
            ctx,
            orderID,
            "complete",  // äº‹ä»¶åç§°
            "system",
            "æ‰€æœ‰è£ç‰‡å·²å®Œæˆ",
            metadata,
        )
    } else if orderProgress > 0 && (order.Status == 0 || order.Status == 1) {
        // æ ¹æ®å½“å‰çŠ¶æ€é€‰æ‹©äº‹ä»¶
        event := "start_production"
        if order.Status == 0 {
            event = "submit_order"  // ä»è‰ç¨¿å…ˆæäº¤
        }
        
        err = s.workflowEngine.TransitionOrderState(ctx, orderID, event, "system", "å·¥åºä¸ŠæŠ¥è‡ªåŠ¨è§¦å‘", nil)
        
        // å¦‚æœæ˜¯ä»è‰ç¨¿ï¼Œå†è½¬åˆ°ç”Ÿäº§ä¸­
        if event == "submit_order" {
            s.workflowEngine.TransitionOrderState(ctx, orderID, "start_production", "system", "å·¥åºä¸ŠæŠ¥è‡ªåŠ¨è§¦å‘", nil)
        }
    }
}
```

5. **æ›´æ–°è¿›åº¦è®¡ç®—æ–¹æ³•**

**ä¿®æ”¹å‰**ï¼š
```go
func (s *reportService) updateOrderProgress(ctx context.Context, orderID string) {
    // ... è®¡ç®—è¿›åº¦
    _ = s.workflow.UpdateProgress(ctx, orderID, newProgress, operator)
}
```

**ä¿®æ”¹å**ï¼š
```go
func (s *reportService) updateOrderProgress(ctx context.Context, orderID string) {
    // ... è®¡ç®—è¿›åº¦
    
    // ç›´æ¥æ›´æ–°è®¢å•è¿›åº¦å­—æ®µ
    _ = s.orderRepo.Update(ctx, orderID, bson.M{
        "progress":   newProgress,
        "updated_at": time.Now().Unix(),
    })
    
    fmt.Printf("ğŸ“Š è®¢å•è¿›åº¦æ›´æ–°ï¼ˆåŸºäºå·¥åºï¼‰: è®¢å•=%s, è¿›åº¦=%.2f%%\n", orderID, newProgress*100)
}
```

### 2. **Order æœåŠ¡ä¿æŒä¸å˜** âœ…

Order æœåŠ¡å·²ç»ä½¿ç”¨ `workflow_engine`ï¼Œæ— éœ€ä¿®æ”¹ã€‚

### 3. **core/workflow ä¿ç•™ä½†ä¸ç›´æ¥ä½¿ç”¨** âœ…

`core/workflow` åŒ…ä¿ç•™ä½œä¸ºåº•å±‚å®ç°ï¼Œä½†ä¸å†è¢« Production æœåŠ¡ç›´æ¥è°ƒç”¨ã€‚

## ğŸ“Š çŠ¶æ€è½¬æ¢äº‹ä»¶æ˜ å°„

### workflow_engine æ”¯æŒçš„äº‹ä»¶

| äº‹ä»¶åç§° | è¯´æ˜ | æºçŠ¶æ€ | ç›®æ ‡çŠ¶æ€ |
|---------|------|--------|---------|
| `submit_order` | æäº¤è®¢å• | è‰ç¨¿ (0) | å·²ä¸‹å• (1) |
| `start_production` | å¼€å§‹ç”Ÿäº§ | å·²ä¸‹å• (1) | ç”Ÿäº§ä¸­ (2) |
| `complete` | å®Œæˆè®¢å• | ç”Ÿäº§ä¸­ (2) | å·²å®Œæˆ (3) |
| `cancel` | å–æ¶ˆè®¢å• | ä»»æ„ | å·²å–æ¶ˆ (4) |

### çŠ¶æ€ç å®šä¹‰

| çŠ¶æ€ç  | çŠ¶æ€åç§° | workflow_state | è¯´æ˜ |
|-------|---------|----------------|------|
| 0 | è‰ç¨¿ | draft | è®¢å•è‰ç¨¿ |
| 1 | å·²ä¸‹å• | ordered | è®¢å•å·²æäº¤ |
| 2 | ç”Ÿäº§ä¸­ | production | æ­£åœ¨ç”Ÿäº§ |
| 3 | å·²å®Œæˆ | completed | ç”Ÿäº§å®Œæˆ |
| 4 | å·²å–æ¶ˆ | cancelled | è®¢å•å–æ¶ˆ |

## âœ… æ ¸å¿ƒä¼˜åŠ¿

### ç»Ÿä¸€æ¶æ„

1. **å•ä¸€å·¥ä½œæµå¼•æ“**
   - åªä½¿ç”¨ `workflow_engine`
   - æ‰€æœ‰çŠ¶æ€è½¬æ¢é€šè¿‡æ•°æ®åº“å·¥ä½œæµå®šä¹‰
   - æ”¯æŒå·¥ä½œæµè®¾è®¡å™¨

2. **çŠ¶æ€å­—æ®µåŒæ­¥**
   - `status` å’Œ `workflow_state` å§‹ç»ˆåŒæ­¥
   - é€šè¿‡ `workflow_engine` ç»Ÿä¸€æ›´æ–°
   - é¿å…çŠ¶æ€ä¸ä¸€è‡´

3. **çµæ´»å¯é…ç½®**
   - å·¥ä½œæµå®šä¹‰å­˜å‚¨åœ¨ MongoDB
   - æ”¯æŒå¯è§†åŒ–å·¥ä½œæµè®¾è®¡å™¨
   - å¯åŠ¨æ€ä¿®æ”¹å·¥ä½œæµè§„åˆ™

### æ™ºèƒ½çŠ¶æ€è½¬æ¢

1. **è‡ªåŠ¨å¼€å§‹ç”Ÿäº§**
   ```
   æ¡ä»¶ï¼šè®¢å•æœ‰è¿›åº¦ (progress > 0) ä¸”çŠ¶æ€ä¸º"è‰ç¨¿"æˆ–"å·²ä¸‹å•"
   æ“ä½œï¼šè‡ªåŠ¨è½¬æ¢åˆ°"ç”Ÿäº§ä¸­"
   ```

2. **è‡ªåŠ¨å®Œæˆè®¢å•**
   ```
   æ¡ä»¶ï¼šè®¢å•è¿›åº¦è¾¾åˆ°100% ä¸”çŠ¶æ€ä¸º"ç”Ÿäº§ä¸­"
   æ“ä½œï¼šè‡ªåŠ¨è½¬æ¢åˆ°"å·²å®Œæˆ"
   ```

3. **çŠ¶æ€è½¬æ¢æ—¥å¿—**
   - è®°å½•åˆ° `workflow_instances.history`
   - åŒ…å«æ“ä½œè€…ã€åŸå› ã€æ—¶é—´æˆ³
   - å®Œæ•´çš„å®¡è®¡è¿½è¸ª

## ğŸ” å·¥ä½œæµå®ä¾‹æ•°æ®ç»“æ„

```javascript
{
  "_id": "workflow_instance_id",
  "workflow_id": "basic_order_workflow_id",
  "entity_type": "order",
  "entity_id": "order_id",
  "current_state": "production",  // å½“å‰çŠ¶æ€
  "variables": {
    "progress": 0.56,
    "completed_count": 2,
    "total_pieces": 4
  },
  "history": [
    {
      "from_state": "draft",
      "to_state": "ordered",
      "event": "submit_order",
      "operator": "system",
      "reason": "è®¢å•åˆ›å»º",
      "timestamp": 1729123456,
      "metadata": {}
    },
    {
      "from_state": "ordered",
      "to_state": "production",
      "event": "start_production",
      "operator": "system",
      "reason": "å·¥åºä¸ŠæŠ¥è‡ªåŠ¨è§¦å‘",
      "timestamp": 1729234567,
      "metadata": {
        "progress": 0.13
      }
    }
  ],
  "created_at": 1729123456,
  "updated_at": 1729234567
}
```

## ğŸ“ APIè°ƒç”¨ç¤ºä¾‹

### æ‰§è¡ŒçŠ¶æ€è½¬æ¢

```go
// Production æœåŠ¡ä¸­çš„è°ƒç”¨
err := s.workflowEngine.TransitionOrderState(
    ctx,
    orderID,
    "complete",  // äº‹ä»¶
    "system",    // æ“ä½œè€…
    "æ‰€æœ‰è£ç‰‡å·²å®Œæˆ",  // åŸå› 
    map[string]interface{}{
        "progress": 1.0,
        "completed_count": 10,
        "total_pieces": 10,
    },
)
```

### è·å–å·¥ä½œæµçŠ¶æ€

```go
instance, err := s.workflowEngine.GetOrderWorkflowState(ctx, orderID)
// instance.CurrentState = "production"
```

### è·å–å¯ç”¨è½¬æ¢

```go
transitions, err := s.workflowEngine.GetAvailableTransitions(ctx, orderID)
// è¿”å›å½“å‰çŠ¶æ€å¯æ‰§è¡Œçš„æ‰€æœ‰è½¬æ¢
```

## ğŸš€ éƒ¨ç½²æ­¥éª¤

1. **åœæ­¢æœåŠ¡**
   ```bash
   # åœæ­¢ Production Service
   # åœæ­¢ Order Service
   ```

2. **é‡æ–°ç¼–è¯‘**
   ```bash
   go build -o ./bin/production.exe ./cmd/production
   go build -o ./bin/order.exe ./cmd/order
   ```

3. **å¯åŠ¨æœåŠ¡**
   ```bash
   # å¯åŠ¨ Order Service
   # å¯åŠ¨ Production Service
   ```

4. **éªŒè¯åŠŸèƒ½**
   - æ‰«ç ä¸ŠæŠ¥å·¥åº
   - æ£€æŸ¥è®¢å•çŠ¶æ€è‡ªåŠ¨è½¬æ¢
   - éªŒè¯å·¥ä½œæµçŠ¶æ€åŒæ­¥

## ğŸ‰ é‡æ„å®Œæˆ

### ç¼–è¯‘çŠ¶æ€
- âœ… Production Service ç¼–è¯‘æˆåŠŸ
- âœ… Order Service ç¼–è¯‘æˆåŠŸ

### åŠŸèƒ½éªŒè¯å¾…å®Œæˆ
- â³ æ‰«ç ä¸ŠæŠ¥å·¥åºæµ‹è¯•
- â³ è‡ªåŠ¨çŠ¶æ€è½¬æ¢æµ‹è¯•
- â³ å·¥ä½œæµå†å²è®°å½•éªŒè¯

---

**é‡æ„å®Œæˆï¼** ğŸŠ

ç°åœ¨ç³»ç»Ÿä½¿ç”¨ç»Ÿä¸€çš„å·¥ä½œæµå¼•æ“ï¼Œæ¶æ„æ›´æ¸…æ™°ï¼ŒçŠ¶æ€ç®¡ç†æ›´å¯é ï¼

