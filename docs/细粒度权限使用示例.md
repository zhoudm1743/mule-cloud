# ç»†ç²’åº¦æƒé™ä½¿ç”¨ç¤ºä¾‹

## âœ… å·²å®Œæˆçš„æ”¹é€ 

### åç«¯

1. **Casbin åŒæ­¥** âœ…
   - `AssignMenus` æœåŠ¡ä¸­å·²å¯ç”¨ Casbin åŒæ­¥
   - è‡ªåŠ¨æŸ¥è¯¢èœå•è·¯å¾„å¹¶æ„å»ºæ˜ å°„
   - æƒé™å˜æ›´è‡ªåŠ¨åŒæ­¥åˆ° Casbin

2. **ç§Ÿæˆ·æƒé™è¾¹ç•Œ** âœ…
   - ç§Ÿæˆ·è¶…ç®¡åˆ†é…è§’è‰²æƒé™æ—¶ï¼Œåªèƒ½ä»ç§Ÿæˆ·æ‹¥æœ‰çš„èœå•ä¸­é€‰æ‹©
   - `HasAllMenus()` æ–¹æ³•æ£€æŸ¥æ‰€æœ‰èœå•æ˜¯å¦åœ¨ç§Ÿæˆ·æƒé™èŒƒå›´å†…

3. **ç»†ç²’åº¦æƒé™æ˜ å°„** âœ…
   - Gateway ä¸­é—´ä»¶æ”¯æŒ create/read/update/delete å››æƒé™
   - Casbin æ”¯æŒä»»æ„è‡ªå®šä¹‰æƒé™ï¼ˆpending, verify, audit...ï¼‰

### å‰ç«¯

1. **æƒé™ Hook æ‰©å±•** âœ…
   - `hasPermission()` - è§’è‰²æƒé™æ£€æŸ¥ï¼ˆåŸæœ‰åŠŸèƒ½ï¼‰
   - `hasAction()` - æ“ä½œæƒé™æ£€æŸ¥ï¼ˆæ–°å¢ï¼‰
   - `hasResource()` - èµ„æºæƒé™æ£€æŸ¥ï¼ˆæ–°å¢ï¼‰

2. **è§’è‰²ç®¡ç†ç•Œé¢** âœ…
   - æ”¯æŒå‹¾é€‰ç»†ç²’åº¦æƒé™
   - åŸºç¡€æƒé™å’Œä¸šåŠ¡æƒé™åˆ†ç»„æ˜¾ç¤º
   - Tooltip æç¤ºæƒé™è¯´æ˜

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### 1. åç«¯ï¼šä¸šåŠ¡ä»£ç æ£€æŸ¥æƒé™

```go
// app/business/services/finance.go

func (s *FinanceService) PendingPayment(c *gin.Context, req *dto.PendingRequest) error {
    userID := c.GetString("user_id")
    tenantID := c.GetString("tenant_id")
    
    // æ£€æŸ¥æŒ‚è´¦æƒé™
    allowed, err := casbin.CheckUserPermission(
        tenantID,
        userID,
        "/business/finance",
        "pending",  // è‡ªå®šä¹‰æƒé™
    )
    
    if !allowed {
        return fmt.Errorf("æ— æŒ‚è´¦æƒé™")
    }
    
    // æ‰§è¡ŒæŒ‚è´¦é€»è¾‘
    return s.repo.CreatePendingPayment(req)
}
```

### 2. å‰ç«¯ï¼šæŒ‰é’®çº§æƒé™æ§åˆ¶

#### æ–¹å¼1ï¼šä½¿ç”¨ hasAction

```vue
<script setup lang="ts">
import { usePermission } from '@/hooks'

const { hasAction } = usePermission()
</script>

<template>
  <NSpace>
    <!-- åŸºç¡€æƒé™ -->
    <NButton v-if="hasAction('admin', 'create')" @click="handleCreate">
      æ–°å»º
    </NButton>
    <NButton v-if="hasAction('admin', 'update')" @click="handleEdit">
      ç¼–è¾‘
    </NButton>
    <NButton v-if="hasAction('admin', 'delete')" @click="handleDelete">
      åˆ é™¤
    </NButton>
    
    <!-- ä¸šåŠ¡æƒé™ -->
    <NButton v-if="hasAction('finance', 'pending')" @click="handlePending">
      æŒ‚è´¦
    </NButton>
    <NButton v-if="hasAction('finance', 'verify')" @click="handleVerify">
      æ ¸é”€
    </NButton>
    <NButton v-if="hasAction('finance', 'audit')" @click="handleAudit">
      å®¡æ ¸
    </NButton>
  </NSpace>
</template>
```

#### æ–¹å¼2ï¼šä½¿ç”¨ hasResourceï¼ˆæ¨èï¼‰

```vue
<script setup lang="ts">
import { usePermission } from '@/hooks'

const { hasResource } = usePermission()
</script>

<template>
  <NSpace>
    <NButton v-if="hasResource('admin:create')" @click="handleCreate">
      æ–°å»º
    </NButton>
    <NButton v-if="hasResource('admin:update')" @click="handleEdit">
      ç¼–è¾‘
    </NButton>
    <NButton v-if="hasResource('finance:pending')" @click="handlePending">
      æŒ‚è´¦
    </NButton>
  </NSpace>
</template>
```

#### æ–¹å¼3ï¼šåœ¨ä»£ç é€»è¾‘ä¸­æ£€æŸ¥

```typescript
import { usePermission } from '@/hooks'

const { hasAction, hasResource } = usePermission()

function handleOperation() {
  if (!hasAction('admin', 'delete')) {
    window.$message.error('æ— åˆ é™¤æƒé™')
    return
  }
  
  // æ‰§è¡Œåˆ é™¤æ“ä½œ
  deleteRecord()
}

// æˆ–è€…
function canUserExport() {
  return hasResource('finance:export')
}
```

### 3. å‰ç«¯ï¼šv-permission æŒ‡ä»¤ï¼ˆè§’è‰²çº§æƒé™ï¼‰

Nova-admin åŸæœ‰çš„æŒ‡ä»¤ä»ç„¶å¯ç”¨ï¼Œç”¨äºæ£€æŸ¥è§’è‰²æ ‡è¯†ï¼š

```vue
<template>
  <div>
    <!-- åªæœ‰ super è§’è‰²èƒ½çœ‹åˆ° -->
    <NButton v-permission="'super'">
      è¶…çº§ç®¡ç†å‘˜åŠŸèƒ½
    </NButton>
    
    <!-- admin å’Œ super è§’è‰²èƒ½çœ‹åˆ° -->
    <NButton v-permission="['admin', 'super']">
      ç®¡ç†å‘˜åŠŸèƒ½
    </NButton>
    
    <!-- æ‰€æœ‰äººéƒ½èƒ½çœ‹åˆ° -->
    <NButton>
      æ™®é€šåŠŸèƒ½
    </NButton>
  </div>
</template>
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å‰ç«¯æƒé™æ£€æŸ¥çš„å±€é™æ€§

å½“å‰ `hasAction` å’Œ `hasResource` çš„å®ç°æ˜¯**ä¸´æ—¶æ–¹æ¡ˆ**ï¼š
- âœ… super è§’è‰²æ‹¥æœ‰æ‰€æœ‰æƒé™
- âš ï¸ å…¶ä»–è§’è‰²ï¼šåªè¦æœ‰èœå•å°±å‡è®¾æœ‰æ‰€æœ‰æƒé™
- âŒ **æœªçœŸæ­£æ£€æŸ¥ç»†ç²’åº¦æƒé™**

**åŸå› **ï¼šéœ€è¦åç«¯åœ¨ç”¨æˆ·ç™»å½•æ—¶è¿”å›ç”¨æˆ·çš„ `menu_permissions` æ•°æ®ã€‚

### 2. å®Œæ•´å®ç°æ­¥éª¤

#### æ­¥éª¤1ï¼šåç«¯è¿”å›ç”¨æˆ·æƒé™

ä¿®æ”¹ `app/auth/services/auth.go` ä¸­çš„ `GetUserProfile` æˆ–ç™»å½•å“åº”ï¼š

```go
type UserProfileResponse struct {
    UserID    string                      `json:"user_id"`
    Username  string                      `json:"username"`
    Roles     []RoleInfo                  `json:"roles"`
    
    // æ–°å¢ï¼šç”¨æˆ·çš„èœå•æƒé™æ˜ å°„
    MenuPermissions map[string][]string  `json:"menu_permissions"`
    // ç¤ºä¾‹ï¼š{"admin": ["read", "create", "update"], "finance": ["read", "pending"]}
}

func (s *AuthService) GetUserProfile(userID string) (*UserProfileResponse, error) {
    // ... è·å–ç”¨æˆ·ä¿¡æ¯
    
    // è·å–ç”¨æˆ·çš„æ‰€æœ‰è§’è‰²
    roles := getUserRoles(userID)
    
    // åˆå¹¶æ‰€æœ‰è§’è‰²çš„èœå•æƒé™
    menuPermissions := make(map[string][]string)
    for _, role := range roles {
        for menuName, actions := range role.MenuPermissions {
            // åˆå¹¶æƒé™ï¼ˆå»é‡ï¼‰
            existingActions := menuPermissions[menuName]
            for _, action := range actions {
                if !contains(existingActions, action) {
                    menuPermissions[menuName] = append(menuPermissions[menuName], action)
                }
            }
        }
    }
    
    return &UserProfileResponse{
        UserID:          user.ID,
        Username:        user.Username,
        Roles:           roles,
        MenuPermissions: menuPermissions,
    }
}
```

#### æ­¥éª¤2ï¼šå‰ç«¯å­˜å‚¨æƒé™æ•°æ®

ä¿®æ”¹ `frontend/src/store/auth.ts`ï¼š

```typescript
interface UserInfo {
  userId: string
  userName: string
  role: Entity.RoleType[]
  menuPermissions?: Record<string, string[]>  // æ–°å¢
}

const useAuthStore = defineStore('auth-store', {
  state: (): AuthState => ({
    userInfo: getLocal<UserInfo>(localStg.userInfo) || null,
    // ...
  }),
  
  actions: {
    async login(params: Api.Login.LoginRequest) {
      const res = await fetchLogin(params)
      const { userInfo, token } = res.data
      
      // å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ï¼ˆåŒ…å« menuPermissionsï¼‰
      this.userInfo = userInfo
      setLocal(localStg.userInfo, userInfo)
      
      // ...
    }
  }
})
```

#### æ­¥éª¤3ï¼šå®Œå–„ hasAction å®ç°

ä¿®æ”¹ `frontend/src/hooks/usePermission.ts`ï¼š

```typescript
function hasAction(menuName: string, action: string): boolean {
  // super è§’è‰²æ‹¥æœ‰æ‰€æœ‰æƒé™
  if (hasPermission('super')) {
    return true
  }

  if (!authStore.userInfo) {
    return false
  }

  const { menuPermissions } = authStore.userInfo
  
  if (!menuPermissions || !menuPermissions[menuName]) {
    return false
  }

  return menuPermissions[menuName].includes(action)
}
```

---

## ğŸ¯ æƒé™æ§åˆ¶å±‚æ¬¡

### ç¬¬ä¸€å±‚ï¼šèœå•æ˜¾ç¤ºæ§åˆ¶ï¼ˆå·²å®Œæˆï¼‰
- åŸºäº `Role.menus`
- ç”¨æˆ·æ²¡æœ‰èœå•æƒé™ â†’ èœå•ä¸æ˜¾ç¤º
- å‰ç«¯è·¯ç”± guard è‡ªåŠ¨å¤„ç†

### ç¬¬äºŒå±‚ï¼šHTTP æ–¹æ³•æƒé™ï¼ˆå·²å®Œæˆï¼‰
- åŸºäº HTTP æ–¹æ³•è‡ªåŠ¨æ˜ å°„ï¼š
  - `GET` â†’ `read`
  - `POST` â†’ `create`
  - `PUT/PATCH` â†’ `update`
  - `DELETE` â†’ `delete`
- Gateway Casbin ä¸­é—´ä»¶è‡ªåŠ¨æ£€æŸ¥

### ç¬¬ä¸‰å±‚ï¼šæŒ‰é’®æ˜¾ç¤ºæ§åˆ¶ï¼ˆéƒ¨åˆ†å®Œæˆï¼‰
- ä½¿ç”¨ `hasAction()` æˆ– `hasResource()`
- å‰ç«¯éšè—æ— æƒé™æŒ‰é’®
- âš ï¸ éœ€è¦åç«¯è¿”å› `menu_permissions`

### ç¬¬å››å±‚ï¼šä¸šåŠ¡æ“ä½œæƒé™ï¼ˆå·²å®Œæˆï¼‰
- ä¸šåŠ¡ä»£ç æ‰‹åŠ¨æ£€æŸ¥ï¼š
  ```go
  casbin.CheckUserPermission(tenantID, userID, resource, action)
  ```
- ç”¨äºè‡ªå®šä¹‰æƒé™ï¼špending, verify, audit...

---

## ğŸ“š æƒé™é…ç½®æµç¨‹

### 1. ç³»ç»Ÿç®¡ç†å‘˜é…ç½®èœå•æƒé™

```javascript
// åœ¨ MongoDB ä¸­ä¸ºèœå•æ·»åŠ å¯ç”¨æƒé™
db.menus.updateOne(
  { name: "finance" },
  {
    $set: {
      available_permissions: [
        { action: "read", label: "æŸ¥çœ‹", is_basic: true },
        { action: "create", label: "åˆ›å»º", is_basic: true },
        { action: "pending", label: "æŒ‚è´¦", is_basic: false, description: "å°†è®¢å•æŒ‚è´¦å»¶æœŸæ”¯ä»˜" },
        { action: "verify", label: "æ ¸é”€", is_basic: false, description: "æ ¸é”€å·²æŒ‚è´¦è®¢å•" },
        { action: "audit", label: "å®¡æ ¸", is_basic: false },
        { action: "export", label: "å¯¼å‡º", is_basic: false }
      ]
    }
  }
)
```

### 2. ç§Ÿæˆ·ç®¡ç†å‘˜åˆ†é…è§’è‰²æƒé™

è¿›å…¥ **ç³»ç»Ÿè®¾ç½® â†’ è§’è‰²ç®¡ç† â†’ åˆ†é…æƒé™**ï¼š

```
â˜‘ï¸ è´¢åŠ¡ç®¡ç†
   [åŸºç¡€æƒé™] â˜‘ï¸æŸ¥çœ‹ â˜‘ï¸åˆ›å»º â˜ä¿®æ”¹ â˜åˆ é™¤
   [ä¸šåŠ¡æƒé™] â˜‘ï¸æŒ‚è´¦ â˜‘ï¸æ ¸é”€ â˜å®¡æ ¸ â˜‘ï¸å¯¼å‡º
```

### 3. æƒé™è‡ªåŠ¨åŒæ­¥åˆ° Casbin

```
p, tenant:A:role:finance_staff, /business/finance, read
p, tenant:A:role:finance_staff, /business/finance, create
p, tenant:A:role:finance_staff, /business/finance, pending
p, tenant:A:role:finance_staff, /business/finance, verify
p, tenant:A:role:finance_staff, /business/finance, export
```

### 4. ç”¨æˆ·è·å¾—æƒé™

```
ç”¨æˆ· â†’ æ‹¥æœ‰è§’è‰² â†’ è§’è‰²çš„èœå•æƒé™ â†’ ç»†ç²’åº¦æ“ä½œæƒé™
```

---

## ğŸ”§ å¾…å®Œæˆäº‹é¡¹

### é«˜ä¼˜å…ˆçº§
- [ ] åç«¯ï¼šåœ¨ç”¨æˆ·ç™»å½•/è·å–profileæ—¶è¿”å› `menu_permissions`
- [ ] å‰ç«¯ï¼šå®Œå–„ `hasAction` çš„å®é™…æ£€æŸ¥é€»è¾‘
- [ ] å‰ç«¯ï¼šåœ¨å„ä¸ªä¸šåŠ¡é¡µé¢åº”ç”¨æŒ‰é’®çº§æƒé™æ§åˆ¶

### ä¸­ä¼˜å…ˆçº§
- [ ] æ·»åŠ æƒé™ç¼“å­˜ï¼ˆæå‡æ€§èƒ½ï¼‰
- [ ] æ·»åŠ æƒé™å˜æ›´ç›‘å¬ï¼ˆå®æ—¶æ›´æ–°ï¼‰
- [ ] å®Œå–„æƒé™é”™è¯¯æç¤º

### ä½ä¼˜å…ˆçº§
- [ ] æƒé™ç®¡ç†ç•Œé¢ï¼ˆæŸ¥çœ‹/ä¿®æ”¹ Casbin ç­–ç•¥ï¼‰
- [ ] æƒé™å®¡è®¡æ—¥å¿—
- [ ] æ‰¹é‡æƒé™æ“ä½œå·¥å…·

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

- [Casbin å¢åˆ æ”¹æŸ¥æƒé™è¯´æ˜](./Casbinå¢åˆ æ”¹æŸ¥æƒé™è¯´æ˜.md)
- [Casbin è‡ªå®šä¹‰ä¸šåŠ¡æƒé™æ–¹æ¡ˆ](./Casbinè‡ªå®šä¹‰ä¸šåŠ¡æƒé™æ–¹æ¡ˆ.md)
- [æƒé™ç³»ç»Ÿæ”¹é€ å®Œæˆè¯´æ˜](./æƒé™ç³»ç»Ÿæ”¹é€ å®Œæˆè¯´æ˜.md)
- [Nova-admin æƒé™æ§åˆ¶](https://nova-admin-docs.netlify.app/guide/permission-control)

