# 细粒度权限使用示例

## ✅ 已完成的改造

### 后端

1. **Casbin 同步** ✅
   - `AssignMenus` 服务中已启用 Casbin 同步
   - 自动查询菜单路径并构建映射
   - 权限变更自动同步到 Casbin

2. **租户权限边界** ✅
   - 租户超管分配角色权限时，只能从租户拥有的菜单中选择
   - `HasAllMenus()` 方法检查所有菜单是否在租户权限范围内

3. **细粒度权限映射** ✅
   - Gateway 中间件支持 create/read/update/delete 四权限
   - Casbin 支持任意自定义权限（pending, verify, audit...）

### 前端

1. **权限 Hook 扩展** ✅
   - `hasPermission()` - 角色权限检查（原有功能）
   - `hasAction()` - 操作权限检查（新增）
   - `hasResource()` - 资源权限检查（新增）

2. **角色管理界面** ✅
   - 支持勾选细粒度权限
   - 基础权限和业务权限分组显示
   - Tooltip 提示权限说明

---

## 📝 使用示例

### 1. 后端：业务代码检查权限

```go
// app/business/services/finance.go

func (s *FinanceService) PendingPayment(c *gin.Context, req *dto.PendingRequest) error {
    userID := c.GetString("user_id")
    tenantID := c.GetString("tenant_id")
    
    // 检查挂账权限
    allowed, err := casbin.CheckUserPermission(
        tenantID,
        userID,
        "/business/finance",
        "pending",  // 自定义权限
    )
    
    if !allowed {
        return fmt.Errorf("无挂账权限")
    }
    
    // 执行挂账逻辑
    return s.repo.CreatePendingPayment(req)
}
```

### 2. 前端：按钮级权限控制

#### 方式1：使用 hasAction

```vue
<script setup lang="ts">
import { usePermission } from '@/hooks'

const { hasAction } = usePermission()
</script>

<template>
  <NSpace>
    <!-- 基础权限 -->
    <NButton v-if="hasAction('admin', 'create')" @click="handleCreate">
      新建
    </NButton>
    <NButton v-if="hasAction('admin', 'update')" @click="handleEdit">
      编辑
    </NButton>
    <NButton v-if="hasAction('admin', 'delete')" @click="handleDelete">
      删除
    </NButton>
    
    <!-- 业务权限 -->
    <NButton v-if="hasAction('finance', 'pending')" @click="handlePending">
      挂账
    </NButton>
    <NButton v-if="hasAction('finance', 'verify')" @click="handleVerify">
      核销
    </NButton>
    <NButton v-if="hasAction('finance', 'audit')" @click="handleAudit">
      审核
    </NButton>
  </NSpace>
</template>
```

#### 方式2：使用 hasResource（推荐）

```vue
<script setup lang="ts">
import { usePermission } from '@/hooks'

const { hasResource } = usePermission()
</script>

<template>
  <NSpace>
    <NButton v-if="hasResource('admin:create')" @click="handleCreate">
      新建
    </NButton>
    <NButton v-if="hasResource('admin:update')" @click="handleEdit">
      编辑
    </NButton>
    <NButton v-if="hasResource('finance:pending')" @click="handlePending">
      挂账
    </NButton>
  </NSpace>
</template>
```

#### 方式3：在代码逻辑中检查

```typescript
import { usePermission } from '@/hooks'

const { hasAction, hasResource } = usePermission()

function handleOperation() {
  if (!hasAction('admin', 'delete')) {
    window.$message.error('无删除权限')
    return
  }
  
  // 执行删除操作
  deleteRecord()
}

// 或者
function canUserExport() {
  return hasResource('finance:export')
}
```

### 3. 前端：v-permission 指令（角色级权限）

Nova-admin 原有的指令仍然可用，用于检查角色标识：

```vue
<template>
  <div>
    <!-- 只有 super 角色能看到 -->
    <NButton v-permission="'super'">
      超级管理员功能
    </NButton>
    
    <!-- admin 和 super 角色能看到 -->
    <NButton v-permission="['admin', 'super']">
      管理员功能
    </NButton>
    
    <!-- 所有人都能看到 -->
    <NButton>
      普通功能
    </NButton>
  </div>
</template>
```

---

## ⚠️ 注意事项

### 1. 前端权限检查的局限性

当前 `hasAction` 和 `hasResource` 的实现是**临时方案**：
- ✅ super 角色拥有所有权限
- ⚠️ 其他角色：只要有菜单就假设有所有权限
- ❌ **未真正检查细粒度权限**

**原因**：需要后端在用户登录时返回用户的 `menu_permissions` 数据。

### 2. 完整实现步骤

#### 步骤1：后端返回用户权限

修改 `app/auth/services/auth.go` 中的 `GetUserProfile` 或登录响应：

```go
type UserProfileResponse struct {
    UserID    string                      `json:"user_id"`
    Username  string                      `json:"username"`
    Roles     []RoleInfo                  `json:"roles"`
    
    // 新增：用户的菜单权限映射
    MenuPermissions map[string][]string  `json:"menu_permissions"`
    // 示例：{"admin": ["read", "create", "update"], "finance": ["read", "pending"]}
}

func (s *AuthService) GetUserProfile(userID string) (*UserProfileResponse, error) {
    // ... 获取用户信息
    
    // 获取用户的所有角色
    roles := getUserRoles(userID)
    
    // 合并所有角色的菜单权限
    menuPermissions := make(map[string][]string)
    for _, role := range roles {
        for menuName, actions := range role.MenuPermissions {
            // 合并权限（去重）
            existingActions := menuPermissions[menuName]
            for _, action := range actions {
                if !contains(existingActions, action) {
                    menuPermissions[menuName] = append(menuPermissions[menuName], action)
                }
            }
        }
    }
    
    return &UserProfileResponse{
        UserID:          user.ID,
        Username:        user.Username,
        Roles:           roles,
        MenuPermissions: menuPermissions,
    }
}
```

#### 步骤2：前端存储权限数据

修改 `frontend/src/store/auth.ts`：

```typescript
interface UserInfo {
  userId: string
  userName: string
  role: Entity.RoleType[]
  menuPermissions?: Record<string, string[]>  // 新增
}

const useAuthStore = defineStore('auth-store', {
  state: (): AuthState => ({
    userInfo: getLocal<UserInfo>(localStg.userInfo) || null,
    // ...
  }),
  
  actions: {
    async login(params: Api.Login.LoginRequest) {
      const res = await fetchLogin(params)
      const { userInfo, token } = res.data
      
      // 存储用户信息（包含 menuPermissions）
      this.userInfo = userInfo
      setLocal(localStg.userInfo, userInfo)
      
      // ...
    }
  }
})
```

#### 步骤3：完善 hasAction 实现

修改 `frontend/src/hooks/usePermission.ts`：

```typescript
function hasAction(menuName: string, action: string): boolean {
  // super 角色拥有所有权限
  if (hasPermission('super')) {
    return true
  }

  if (!authStore.userInfo) {
    return false
  }

  const { menuPermissions } = authStore.userInfo
  
  if (!menuPermissions || !menuPermissions[menuName]) {
    return false
  }

  return menuPermissions[menuName].includes(action)
}
```

---

## 🎯 权限控制层次

### 第一层：菜单显示控制（已完成）
- 基于 `Role.menus`
- 用户没有菜单权限 → 菜单不显示
- 前端路由 guard 自动处理

### 第二层：HTTP 方法权限（已完成）
- 基于 HTTP 方法自动映射：
  - `GET` → `read`
  - `POST` → `create`
  - `PUT/PATCH` → `update`
  - `DELETE` → `delete`
- Gateway Casbin 中间件自动检查

### 第三层：按钮显示控制（部分完成）
- 使用 `hasAction()` 或 `hasResource()`
- 前端隐藏无权限按钮
- ⚠️ 需要后端返回 `menu_permissions`

### 第四层：业务操作权限（已完成）
- 业务代码手动检查：
  ```go
  casbin.CheckUserPermission(tenantID, userID, resource, action)
  ```
- 用于自定义权限：pending, verify, audit...

---

## 📚 权限配置流程

### 1. 系统管理员配置菜单权限

```javascript
// 在 MongoDB 中为菜单添加可用权限
db.menus.updateOne(
  { name: "finance" },
  {
    $set: {
      available_permissions: [
        { action: "read", label: "查看", is_basic: true },
        { action: "create", label: "创建", is_basic: true },
        { action: "pending", label: "挂账", is_basic: false, description: "将订单挂账延期支付" },
        { action: "verify", label: "核销", is_basic: false, description: "核销已挂账订单" },
        { action: "audit", label: "审核", is_basic: false },
        { action: "export", label: "导出", is_basic: false }
      ]
    }
  }
)
```

### 2. 租户管理员分配角色权限

进入 **系统设置 → 角色管理 → 分配权限**：

```
☑️ 财务管理
   [基础权限] ☑️查看 ☑️创建 ☐修改 ☐删除
   [业务权限] ☑️挂账 ☑️核销 ☐审核 ☑️导出
```

### 3. 权限自动同步到 Casbin

```
p, tenant:A:role:finance_staff, /business/finance, read
p, tenant:A:role:finance_staff, /business/finance, create
p, tenant:A:role:finance_staff, /business/finance, pending
p, tenant:A:role:finance_staff, /business/finance, verify
p, tenant:A:role:finance_staff, /business/finance, export
```

### 4. 用户获得权限

```
用户 → 拥有角色 → 角色的菜单权限 → 细粒度操作权限
```

---

## 🔧 待完成事项

### 高优先级
- [ ] 后端：在用户登录/获取profile时返回 `menu_permissions`
- [ ] 前端：完善 `hasAction` 的实际检查逻辑
- [ ] 前端：在各个业务页面应用按钮级权限控制

### 中优先级
- [ ] 添加权限缓存（提升性能）
- [ ] 添加权限变更监听（实时更新）
- [ ] 完善权限错误提示

### 低优先级
- [ ] 权限管理界面（查看/修改 Casbin 策略）
- [ ] 权限审计日志
- [ ] 批量权限操作工具

---

## 📖 相关文档

- [Casbin 增删改查权限说明](./Casbin增删改查权限说明.md)
- [Casbin 自定义业务权限方案](./Casbin自定义业务权限方案.md)
- [权限系统改造完成说明](./权限系统改造完成说明.md)
- [Nova-admin 权限控制](https://nova-admin-docs.netlify.app/guide/permission-control)

