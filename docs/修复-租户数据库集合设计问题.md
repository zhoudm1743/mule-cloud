# 修复 - 租户数据库集合设计问题

## 🐛 问题现象

创建租户时，数据库中创建了很多独立的集合：
```
租户数据库: mule_68e27febab849776302...
├── admin          ✅ 管理员
├── role           ✅ 角色
├── menu           ✅ 菜单
├── basic          ✅ 基础数据
├── color          ❌ 不应该独立
├── size           ❌ 不应该独立
├── customer       ❌ 不应该独立
├── order_type     ❌ 不应该独立
├── procedure      ❌ 不应该独立
└── salesman       ❌ 不应该独立
```

## 🔍 问题分析

### 错误的设计

**原来的代码**：`core/database/manager.go:96-107`

```go
collections := []string{
    "admin",      // 管理员
    "role",       // 角色
    "menu",       // 菜单
    "basic",      // 基础数据
    "color",      // 颜色 ❌
    "customer",   // 客户 ❌
    "order_type", // 订单类型 ❌
    "procedure",  // 工序 ❌
    "salesman",   // 业务员 ❌
    "size",       // 尺寸 ❌
}
```

**问题**：
1. **集合过多**：每种基础数据类型一个集合
2. **维护困难**：新增类型需要修改代码创建新集合
3. **不符合设计**：基础数据应该用 `type` 字段区分，统一存储

### 正确的设计

**MongoDB 文档结构**：

```json
// basic 集合
{
  "_id": "xxx",
  "type": "color",           // 类型：color, size, customer, order_type, procedure, salesman
  "code": "red",             // 代码
  "name": "红色",            // 名称
  "value": "#FF0000",        // 值（可选，根据类型不同）
  "order": 1,                // 排序
  "status": 1,               // 状态
  "is_deleted": 0,           // 软删除
  "created_at": 1234567890,
  "updated_at": 1234567890
}
```

**优势**：
1. ✅ **统一管理**：所有基础数据在一个集合
2. ✅ **灵活扩展**：新增类型只需改 `type` 字段值
3. ✅ **索引优化**：可以对 `type` 字段建索引提高查询性能
4. ✅ **代码简洁**：一套 CRUD 逻辑处理所有类型

---

## ✅ 解决方案

### 修改1: 移除独立集合

**文件**：`core/database/manager.go:95-103`

```go
// 创建集合列表
collections := []string{
    "admin", // 管理员
    "role",  // 角色
    "menu",  // 菜单
    "basic", // 基础数据（统一存储：颜色、尺码、客户、订单类型、工序、业务员等，通过 type 字段区分）
    // ❌ 不再创建独立集合：color、size、customer、order_type、procedure、salesman
    // ✅ 所有基础数据统一存储在 basic 集合中
}
```

### 修改2: 为 basic 集合添加索引

**文件**：`core/database/manager.go:146-162`

```go
// basic 集合特殊索引
if collName == "basic" {
    // type 索引（用于区分基础数据类型）
    _, err = collection.Indexes().CreateOne(ctx, mongo.IndexModel{
        Keys: bson.D{{Key: "type", Value: 1}},
    })
    if err != nil {
        log.Printf("⚠️  创建 type 索引失败: %v", err)
    }

    // type + code 复合索引（确保同类型下 code 唯一）
    _, err = collection.Indexes().CreateOne(ctx, mongo.IndexModel{
        Keys: bson.D{
            {Key: "type", Value: 1},
            {Key: "code", Value: 1},
        },
        Options: options.Index().SetUnique(true).SetSparse(true),
    })
    if err != nil {
        log.Printf("⚠️  创建 type+code 复合索引失败: %v", err)
    }
}
```

**索引说明**：
1. **`type` 单字段索引**：加速按类型查询（如：查询所有颜色）
2. **`type + code` 复合唯一索引**：确保同类型下代码唯一（如：不能有两个 code 为 "red" 的颜色）

---

## 🎯 影响范围

### 新创建的租户

- ✅ 自动使用新的集合结构
- ✅ 只有 4 个集合：`admin`, `role`, `menu`, `basic`
- ✅ 所有基础数据存储在 `basic` 中

### 已存在的租户

**不受影响**：
- ✅ 旧租户的数据库结构保持不变
- ✅ 不需要迁移数据
- ✅ 如果旧租户有独立集合（color、size 等），仍然可以正常使用

**如果需要统一**（可选）：
1. 创建迁移脚本
2. 将独立集合的数据迁移到 `basic` 集合
3. 删除旧集合

---

## 📊 数据库对比

### 修改前（错误）

```
租户数据库: mule_xxx
├── admin (10 docs)
├── role (2 docs)
├── menu (50 docs)
├── basic (0 docs)       ← 空的！
├── color (20 docs)      ← 独立集合
├── size (15 docs)       ← 独立集合
├── customer (100 docs)  ← 独立集合
├── order_type (5 docs)  ← 独立集合
├── procedure (30 docs)  ← 独立集合
└── salesman (10 docs)   ← 独立集合

总共: 10 个集合
```

### 修改后（正确）

```
租户数据库: mule_xxx
├── admin (10 docs)
├── role (2 docs)
├── menu (50 docs)
└── basic (180 docs)     ← 统一存储所有基础数据
    ├── type=color (20 docs)
    ├── type=size (15 docs)
    ├── type=customer (100 docs)
    ├── type=order_type (5 docs)
    ├── type=procedure (30 docs)
    └── type=salesman (10 docs)

总共: 4 个集合
```

---

## 🚀 测试验证

### 1. 重新创建租户

1. **删除测试租户**
2. **重新创建租户**
3. **查看数据库**

**期望结果**：
```
只有 4 个集合：
✅ admin
✅ role
✅ menu
✅ basic
```

### 2. 创建基础数据

**通过 API 创建颜色**：
```http
POST /basic/colors
{
  "code": "red",
  "name": "红色",
  "value": "#FF0000"
}
```

**查看数据库**：
```javascript
db.basic.find({ type: "color" })

// 应该返回：
{
  "_id": "xxx",
  "type": "color",
  "code": "red",
  "name": "红色",
  "value": "#FF0000",
  ...
}
```

---

## 🎉 修复完成

- ✅ 移除了冗余的独立集合创建
- ✅ 统一使用 `basic` 集合存储所有基础数据
- ✅ 添加了 `type` 和 `type+code` 索引
- ✅ 简化了数据库结构
- ✅ 提高了查询性能
- ✅ 便于未来扩展

**新创建的租户将使用正确的集合结构！** 🎊

---

## 📝 注意事项

### 已存在的租户

如果你的系统中已经有租户使用了旧的集合结构（独立的 color、size 等集合），需要注意：

1. **代码兼容性**：basic 服务的代码应该能同时支持新旧结构
2. **数据迁移**：可以选择保持旧结构，或者创建迁移脚本
3. **不影响使用**：旧租户仍然可以正常使用

### Repository 代码

确保 `BasicRepository` 正确使用 `basic` 集合和 `type` 字段：

```go
// 查询特定类型的基础数据
func (r *BasicRepository) GetByType(ctx context.Context, dataType string) ([]*models.Basic, error) {
    filter := bson.M{
        "type": dataType,
        "is_deleted": 0,
    }
    // ...
}
```
