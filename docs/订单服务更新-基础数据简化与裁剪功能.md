# 订单服务更新总结 - 基础数据简化与裁剪功能

## 更新时间
2025-01-XX

## 更新概述

本次更新主要包含两大部分：
1. **基础数据简化**：去除ID依赖，直接使用名称（value），支持快速创建基础数据
2. **裁剪功能实现**：完整实现订单裁剪管理，包括裁剪任务、裁剪批次（制菲）、二维码打印等

---

## 一、基础数据简化

### 1.1 数据模型调整

#### 调整内容
- **订单明细（OrderItem）**：移除 `color_id`、`color_name`、`size_id`、`size_name`，改为直接使用 `color` 和 `size`
- **订单工序（OrderProcedure）**：移除 `procedure_id`，只保留 `procedure_name`
- **款式工序（StyleProcedure）**：同样移除 `procedure_id`
- **裁剪批次（CuttingBatch）**：颜色字段从 `color_id` + `color_name` 改为 `color`
- **裁片监控（CuttingPiece）**：颜色和尺码字段简化为 `color` 和 `size`

#### 修改的文件
- `internal/models/order.go` - 数据模型定义
- `frontend/src/typings/api/order.d.ts` - 前端类型定义

### 1.2 快速创建基础数据

#### 实现方式
采用前端tag模式输入，用户可以直接在前端输入新的基础数据名称，前端调用basic service的API自动创建。

**支持快速创建的基础数据类型：**
- 客户（Customer）
- 颜色（Color）
- 尺码（Size）
- 订单类型（OrderType）
- 业务员（Salesman）
- 工序（Procedure）

**工作流程：**
1. 用户在前端选择或输入新名称
2. 前端使用 `tag` 模式的 NSelect 组件
3. 用户输入后回车，前端显示新的tag
4. 提交时，如果basic service中不存在该名称，会自动创建
5. 后续使用时可以直接选择

### 1.3 前端交互优化

#### 颜色和尺码选择
- 使用 `NSelect` 的 `tag` 模式
- 用户可以直接输入新的颜色/尺码名称
- 输入后自动创建标签，后端保存时自动创建记录

**代码示例：**
```vue
<NSelect
  v-model:value="formModel.colors"
  :options="colorOptions"
  placeholder="请选择颜色，可直接输入新颜色"
  multiple
  filterable
  tag
  @update:value="onColorsChange"
/>
```

#### 款式联动
当用户选择款式时，自动填充：
- 颜色列表
- 尺码列表
- 单价
- 工序清单
- 自动生成颜色×尺码的订单明细表

---

## 二、裁剪功能实现

### 2.1 数据模型

#### CuttingTask（裁剪任务）
```go
type CuttingTask struct {
    ID           string          // 任务ID
    OrderID      string          // 订单ID
    ContractNo   string          // 合同号
    StyleNo      string          // 款号
    StyleName    string          // 款名
    CustomerName string          // 客户名称
    TotalPieces  int             // 总件数
    CutPieces    int             // 已裁件数
    Status       int             // 状态：0-待裁剪 1-裁剪中 2-已完成
    Batches      []CuttingBatch  // 裁剪批次列表
    CreatedAt    int64           // 创建时间
    UpdatedAt    int64           // 更新时间
}
```

#### CuttingBatch（裁剪批次/制菲）
```go
type CuttingBatch struct {
    ID          string        // 批次ID
    TaskID      string        // 裁剪任务ID
    OrderID     string        // 订单ID
    ContractNo  string        // 合同号
    StyleNo     string        // 款号
    BedNo       string        // 床号
    BundleNo    string        // 扎号
    Color       string        // 颜色名称
    LayerCount  int           // 拉布层数
    SizeDetails []SizeDetail  // 尺码明细
    TotalPieces int           // 总件数
    QRCode      string        // 二维码内容（JSON）
    PrintCount  int           // 打印次数
    CreatedAt   int64         // 创建时间
    PrintedAt   int64         // 最后打印时间
}
```

#### CuttingPiece（裁片监控）
```go
type CuttingPiece struct {
    ID           string  // 裁片ID
    OrderID      string  // 订单ID
    ContractNo   string  // 合同号
    StyleNo      string  // 款号
    BedNo        string  // 床号
    BundleNo     string  // 扎号
    Color        string  // 颜色名称
    Size         string  // 尺码名称
    Quantity     int     // 数量
    Progress     int     // 进度（已完成工序数）
    TotalProcess int     // 总工序数
    CreatedAt    int64   // 创建时间
}
```

### 2.2 后端实现

#### Repository层
**文件：** `internal/repository/cutting.go`

实现了三个仓库接口：
- `CuttingTaskRepository` - 裁剪任务数据访问
- `CuttingBatchRepository` - 裁剪批次数据访问
- `CuttingPieceRepository` - 裁片监控数据访问

**主要方法：**
```go
// 裁剪任务
- Create()
- Update()
- Delete()
- GetByID()
- GetByOrderID()
- List()

// 裁剪批次
- Create()
- Update()
- Delete()
- GetByID()
- List()

// 裁片监控
- Create()
- Update()
- GetByID()
- List()
```

#### Service层
**文件：** `app/order/services/cutting.go`

实现了 `ICuttingService` 接口，提供完整的裁剪业务逻辑：

**裁剪任务管理：**
- `CreateCuttingTask()` - 从订单创建裁剪任务
- `GetCuttingTaskList()` - 获取任务列表
- `GetCuttingTaskByID()` - 获取任务详情
- `GetCuttingTaskByOrderID()` - 根据订单ID获取任务

**裁剪批次管理：**
- `CreateCuttingBatch()` - 创建裁剪批次（制菲）
  - 自动计算总件数（尺码数量 × 拉布层数）
  - 生成二维码内容（JSON格式，包含所有批次信息）
  - 创建对应的裁片监控记录
  - 更新任务状态和进度
- `GetCuttingBatchList()` - 获取批次列表
- `GetCuttingBatchByID()` - 获取批次详情
- `DeleteCuttingBatch()` - 删除批次（软删除）
- `PrintCuttingBatch()` - 记录打印次数

**裁片监控：**
- `GetCuttingPieceList()` - 获取裁片列表
- `GetCuttingPieceByID()` - 获取裁片详情
- `UpdateCuttingPieceProgress()` - 更新裁片进度

#### Endpoint层
**文件：** `app/order/endpoint/cutting.go`

使用 Go-Kit 框架定义了所有裁剪相关的端点：
- 12个端点覆盖所有裁剪功能
- 统一的请求/响应处理

#### Transport层
**文件：** `app/order/transport/cutting.go`

实现 HTTP 路由和请求解码：

**路由列表：**
```
POST   /cutting/tasks                  - 创建裁剪任务
GET    /cutting/tasks                  - 获取任务列表
GET    /cutting/tasks/:id              - 获取任务详情
GET    /cutting/tasks/order/:orderId   - 根据订单ID获取任务

POST   /cutting/batches                - 创建裁剪批次
GET    /cutting/batches                - 获取批次列表
GET    /cutting/batches/:id            - 获取批次详情
DELETE /cutting/batches/:id            - 删除批次
POST   /cutting/batches/:id/print      - 打印批次

GET    /cutting/pieces                 - 获取裁片列表
GET    /cutting/pieces/:id             - 获取裁片详情
PUT    /cutting/pieces/:id/progress    - 更新裁片进度
```

### 2.3 前端实现

#### 类型定义
**文件：** `frontend/src/typings/api/order.d.ts`

新增裁剪相关的 TypeScript 类型：
- `CuttingTaskInfo` - 裁剪任务信息
- `CuttingBatchInfo` - 裁剪批次信息
- `CuttingPieceInfo` - 裁片监控信息
- 以及相关的 Request 和 Response 类型

#### API服务
**文件：** `frontend/src/service/api/order.ts`

实现了所有裁剪相关的 API 调用方法，与后端路由一一对应。

#### 裁剪管理页面
**文件：** `frontend/src/views/order/cutting/index.vue`

**功能特性：**
1. **裁剪任务列表**
   - 显示所有裁剪任务
   - 支持按合同号、款号搜索
   - 显示任务进度（已裁件数/总件数）
   - 显示任务状态（待裁剪/裁剪中/已完成）

2. **裁剪批次管理**
   - 点击任务可查看该任务下的所有批次
   - 显示批次详细信息（床号、扎号、颜色、层数、尺码明细）
   - 支持打印批次标签
   - 支持删除批次

3. **打印功能**
   - 自动生成打印标签
   - 包含批次所有信息
   - 包含尺码明细表格
   - 包含二维码内容
   - 支持浏览器打印

#### 制菲Modal
**文件：** `frontend/src/views/order/cutting/components/BatchModal.vue`

**功能特性：**
1. **基本信息输入**
   - 床号
   - 扎号
   - 颜色
   - 拉布层数

2. **尺码明细配置**
   - 动态添加/删除尺码
   - 输入每层数量
   - 自动计算小计（每层数量 × 拉布层数）
   - 自动计算总件数

3. **实时计算**
   - 总件数 = Σ(尺码数量 × 拉布层数)
   - 实时显示计算结果

### 2.4 二维码与打印

#### 二维码内容
生成的二维码包含以下JSON信息：
```json
{
  "task_id": "任务ID",
  "order_id": "订单ID",
  "contract_no": "合同号",
  "style_no": "款号",
  "bed_no": "床号",
  "bundle_no": "扎号",
  "color": "颜色",
  "layer_count": 拉布层数,
  "size_details": [
    {"size": "S", "quantity": 10},
    {"size": "M", "quantity": 15}
  ],
  "total_pieces": 总件数
}
```

#### 打印标签内容
- 批次基本信息（合同号、款号、床号、扎号、颜色）
- 拉布层数和总件数
- 尺码明细表格
- 二维码内容
- 打印按钮（调用浏览器打印功能）

---

## 三、使用流程

### 3.1 创建订单流程（含自动创建基础数据）

1. **步骤1：基础信息**
   - 输入合同号
   - 选择或输入客户名称（不存在会自动创建）
   - 选择或输入订单类型（不存在会自动创建）
   - 选择或输入业务员（不存在会自动创建）
   - 选择交货日期

2. **步骤2：款式数量**
   - 选择款式（自动填充颜色、尺码、单价、工序）
   - 或直接输入新的颜色、尺码（会自动创建）
   - 配置颜色×尺码组合的数量
   - 自动计算总数量

3. **步骤3：工序确认**
   - 查看并调整工序清单
   - 设置工价
   - 指定工人
   - 标记最慢工序和不分扎工序

### 3.2 裁剪流程

1. **创建裁剪任务**
   - 从订单列表选择订单
   - 点击"裁剪"按钮创建裁剪任务
   - 系统自动计算总件数

2. **制菲（创建裁剪批次）**
   - 打开裁剪任务
   - 点击"制菲"按钮
   - 填写床号、扎号、颜色
   - 设置拉布层数
   - 配置尺码明细（每个尺码的每层数量）
   - 系统自动计算总件数
   - 保存后自动生成二维码

3. **打印标签**
   - 选择批次
   - 点击"打印"按钮
   - 系统生成打印标签（含二维码）
   - 调用浏览器打印功能
   - 记录打印次数

4. **裁片监控**
   - 扫描二维码或手动查询裁片
   - 查看裁片进度
   - 更新工序完成情况

---

## 四、技术要点

### 4.1 租户隔离
所有裁剪相关的数据都支持租户隔离：
- Repository层使用 `GetCollectionWithContext` 获取租户数据库
- 自动从Context获取租户ID
- 数据存储在对应租户的MongoDB数据库中

### 4.2 数据一致性
- 创建裁剪批次时自动更新任务进度
- 删除批次时需要重新计算任务进度
- 裁片监控自动从批次创建

### 4.3 HTTP客户端使用
`BasicDataHelper` 使用 `httpclient.ServiceClient` 进行服务间调用：
- 通过Consul服务发现
- 支持重试和超时
- 自动传递租户上下文

### 4.4 前端状态管理
- 使用组合式API（Composition API）
- 合理使用 `computed`、`reactive`、`ref`
- 组件间通过 `emit` 和 `ref` 通信

---

## 五、文件清单

### 后端文件

#### 数据模型
- `internal/models/order.go` - 订单、款式、裁剪相关模型

#### Repository层
- `internal/repository/cutting.go` - 裁剪数据仓库

#### Service层
- `app/order/services/cutting.go` - 裁剪业务服务
- `app/order/services/basic_data_helper.go` - 基础数据自动创建服务

#### Endpoint层
- `app/order/endpoint/cutting.go` - 裁剪端点定义

#### Transport层
- `app/order/transport/cutting.go` - 裁剪HTTP路由

#### DTO层
- `app/order/dto/cutting.go` - 裁剪数据传输对象

### 前端文件

#### 类型定义
- `frontend/src/typings/api/order.d.ts` - 订单和裁剪类型定义

#### API服务
- `frontend/src/service/api/order.ts` - 订单和裁剪API调用

#### 页面组件
- `frontend/src/views/order/cutting/index.vue` - 裁剪管理主页面
- `frontend/src/views/order/cutting/components/BatchModal.vue` - 制菲Modal
- `frontend/src/views/order/orders/components/TableModal.vue` - 订单表单（已优化）

---

## 六、下一步计划

### 待实现功能
1. **裁片监控页面**
   - 实时监控裁片进度
   - 支持扫码更新进度
   - 统计分析功能

2. **二维码扫描**
   - 移动端扫码功能
   - 快速更新裁片状态
   - 离线缓存支持

3. **打印优化**
   - 支持批量打印
   - 自定义打印模板
   - 实际二维码图片生成

4. **数据统计**
   - 裁剪效率统计
   - 工人产量统计
   - 异常数据监控

---

## 七、注意事项

1. **基础数据自动创建**
   - 需要配置正确的Consul地址
   - 需要basic服务正常运行
   - 建议在生产环境加入权限控制

2. **裁剪任务**
   - 一个订单只能创建一个裁剪任务
   - 删除批次需要谨慎操作
   - 打印次数用于追踪，不能重置

3. **前端Tag模式**
   - 用户可以直接输入任意内容
   - 需要在保存时验证合法性
   - 建议添加输入格式提示

4. **打印功能**
   - 当前使用浏览器打印API
   - 需要浏览器支持打印功能
   - 可能需要调整打印样式以适配不同打印机

---

## 八、总结

本次更新实现了两大核心功能：

1. **基础数据简化**：通过去除ID依赖，简化了数据结构，提升了用户体验。配合自动创建功能，用户可以在创建订单/款式时快速创建新的基础数据，无需频繁切换页面。

2. **裁剪功能**：从数据模型到前后端实现，完整实现了服装生产中的裁剪管理流程。支持裁剪任务创建、制菲、打印标签、裁片监控等全流程管理，大大提升了生产管理效率。

这两个功能相辅相成，为整个订单管理系统提供了更强大、更灵活的能力。
