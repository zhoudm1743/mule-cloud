# 工作流自动触发完整实现

## 📋 实现概述

工作流系统现已完全集成到订单业务流程中，实现了**自动状态转换**和**进度计算**。

---

## 🔥 核心修改

### **1. 裁片进度更新自动触发** (`app/order/services/cutting.go`)

#### **修改内容：**
```go
// UpdateCuttingPieceProgress 更新裁片进度
func (s *cuttingService) UpdateCuttingPieceProgress(ctx context.Context, id string, progress int) error {
    piece, err := s.pieceRepo.GetByID(ctx, id)
    if err != nil {
        return err
    }

    oldProgress := piece.Progress
    piece.Progress = progress
    err = s.pieceRepo.Update(ctx, id, piece)
    if err != nil {
        return err
    }

    // 🔥 进度变化时，触发订单进度计算和工作流状态更新
    if oldProgress != progress {
        go s.updateOrderProgressAndWorkflow(context.Background(), piece.OrderID, piece.ContractNo)
    }

    return nil
}
```

#### **功能说明：**
- ✅ **自动计算订单进度**：基于所有裁片的加权平均进度
- ✅ **自动更新订单 progress 字段**：实时同步到数据库
- ✅ **自动完成订单**：当进度达到 100% 时，自动触发 `complete` 事件

#### **进度计算公式：**
```
订单进度 = Σ(裁片进度 / 总工序数 × 裁片数量) / 总裁片数量
```

---

### **2. 订单提交使用工作流** (`app/order/services/order.go`)

#### **修改前（硬编码）：**
```go
update := bson.M{
    "procedures": req.Procedures,
    "status":     1, // ❌ 硬编码为已下单
    "updated_at": time.Now().Unix(),
}
```

#### **修改后（工作流驱动）：**
```go
update := bson.M{
    "procedures": req.Procedures,
    "updated_at": time.Now().Unix(),
}

err := s.repo.Update(ctx, req.ID, update)
if err != nil {
    return nil, err
}

// 🔥 使用工作流提交订单（从草稿 -> 已下单）
workflowReq := dto.OrderWorkflowTransitionRequest{
    ID:       req.ID,
    Event:    "submit_order",
    Operator: "system",
    Reason:   "完成订单工序配置，提交订单",
}
_ = s.TransitionWorkflowState(ctx, workflowReq)
```

---

### **3. 工作流引擎服务** (`app/order/services/workflow_engine.go`)

#### **核心功能：**

1. **InitOrderWorkflow**：订单创建时初始化工作流实例
   ```go
   // 创建订单时自动调用
   _ = s.workflowEngine.InitOrderWorkflow(ctx, order.ID, "order_basic")
   ```

2. **TransitionOrderState**：执行状态转换
   - 检查转换规则是否存在
   - 验证转换条件（如进度 >= 100%）
   - 检查角色权限（如取消订单需要 admin）
   - 更新工作流实例和订单状态
   - 记录状态历史

3. **GetOrderWorkflowState**：获取订单当前工作流状态
4. **GetAvailableTransitions**：获取订单当前可用的转换

---

## 🔄 完整工作流程

### **流程图：**

```
创建订单 (0. 草稿)
    ↓ [自动]
初始化工作流实例
    ↓ [用户]
配置工序
    ↓ [自动触发 submit_order]
订单提交 (1. 已下单)
    ↓ [用户]
创建裁剪任务
    ↓ [自动触发 start_cutting]
开始生产 (2. 生产中)
    ↓ [用户]
扫码上报裁片进度
    ↓ [自动计算]
更新订单进度
    ↓ [自动检查]
进度达到 100%?
    ↓ YES [自动触发 complete]
订单完成 (3. 已完成)
```

### **详细步骤：**

| 步骤 | 操作 | 触发方式 | 工作流事件 | 状态变化 |
|------|------|----------|------------|----------|
| 1 | 创建订单 | 用户 | `init` | - → 草稿 |
| 2 | 配置款式和工序 | 用户 | `submit_order` | 草稿 → 已下单 |
| 3 | 创建裁剪任务 | 用户 | `start_cutting` | 已下单 → 生产中 |
| 4 | 扫码上报裁片进度 | 用户 | - | 进度更新 |
| 5 | 所有裁片完成 | **自动** | `complete` | 生产中 → 已完成 |

---

## 📊 控制台日志示例

### **1. 订单创建时：**
```
[INFO] 初始化工作流实例
  订单ID: 68f38803075a19ada180fcb8
  工作流: order_basic
  初始状态: draft
```

### **2. 配置工序后：**
```
[INFO] 工作流状态转换
  订单ID: 68f38803075a19ada180fcb8
  事件: submit_order
  状态变化: draft → ordered
  操作人: system
```

### **3. 扫码上报进度时：**
```
📊 订单进度计算: 订单=68f38803075a19ada180fcb8, 总件数=300, 已完成=5/10, 进度=67.00%
```

### **4. 进度达到 100% 时：**
```
✅ 订单 68f38803075a19ada180fcb8 进度已达100%，自动触发完成事件

[INFO] 工作流状态转换
  订单ID: 68f38803075a19ada180fcb8
  事件: complete
  状态变化: production → completed
  操作人: system
  
🎉 订单 68f38803075a19ada180fcb8 已自动完成！
```

---

## 🧪 测试步骤

### **测试场景 1：创建新订单**
1. 打开订单管理页面，点击"新建订单"
2. 填写基础信息（合同号、客户等）
3. 查看数据库：
   ```javascript
   db.orders.findOne({contract_no: "202510183528"})
   // 应该看到：
   // workflow_code: "order_basic"
   // workflow_instance: "68f38803075a19ada180fcb8"
   // workflow_state: "draft"
   // status: 0
   ```

### **测试场景 2：配置工序提交**
1. 选择款式和工序
2. 点击"完成"按钮
3. 查看订单状态：
   ```javascript
   db.orders.findOne({contract_no: "202510183528"})
   // 应该看到：
   // workflow_state: "ordered"
   // status: 1
   ```
4. 查看工作流历史：
   ```javascript
   db.workflow_instances.findOne({entity_id: "订单ID"})
   // 应该看到 history 数组中有 submit_order 事件
   ```

### **测试场景 3：裁片进度更新**
1. 进入裁片监控页面
2. 选择一个裁片，点击"更新进度"
3. 修改进度值（例如从 0 改为 1）
4. 保存后查看订单详情页：
   - 进度百分比应该更新
   - 控制台应该输出进度计算日志

### **测试场景 4：自动完成订单**
1. 将所有裁片的进度都更新为最大值（例如总工序数为 3，则更新为 3）
2. 保存最后一个裁片的进度
3. 观察：
   - 控制台输出：`✅ 订单 xxx 进度已达100%，自动触发完成事件`
   - 订单状态自动变为"已完成"
   - 订单详情页显示绿色的"已完成"标签

---

## 🔍 数据库结构

### **订单表 (orders)**
```javascript
{
  "_id": "68f38803075a19ada180fcb8",
  "contract_no": "202510183528",
  "status": 2,                    // 0:草稿, 1:已下单, 2:生产中, 3:已完成, 4:已取消
  "progress": 0.67,                // 订单总体进度 (0-1)
  "workflow_code": "order_basic",  // 工作流定义代码
  "workflow_instance": "68f...",   // 工作流实例ID
  "workflow_state": "production",  // 当前工作流状态
  ...
}
```

### **工作流实例表 (workflow_instances)**
```javascript
{
  "_id": "68f38803075a19ada180fcb8",
  "workflow_id": "68f...",         // 工作流定义ID
  "entity_type": "order",          // 实体类型
  "entity_id": "68f...",           // 订单ID
  "current_state": "production",   // 当前状态
  "variables": {},                 // 变量
  "history": [                     // 状态历史
    {
      "from_state": "draft",
      "to_state": "ordered",
      "event": "submit_order",
      "operator": "system",
      "reason": "完成订单工序配置，提交订单",
      "timestamp": 1729265331,
      "metadata": {}
    },
    ...
  ]
}
```

### **裁片表 (cutting_pieces)**
```javascript
{
  "_id": "68f38803075a19ada180fcb8",
  "order_id": "68f...",
  "contract_no": "202510183528",
  "progress": 2,                   // 当前完成的工序数
  "total_process": 3,              // 总工序数
  "quantity": 100,                 // 裁片数量
  ...
}
```

---

## ⚠️ 注意事项

### **1. Redis 依赖**
工作流历史记录需要 Redis 支持，确保 `config/order.yaml` 中 Redis 已启用：
```yaml
redis:
  enabled: true
  host: "127.0.0.1"
  port: 6379
  password: "redis123"
  db: 0
```

### **2. 工作流定义**
确保系统中存在激活的 `order_basic` 工作流定义：
```javascript
db.workflow_definitions.find({code: "order_basic", is_active: true})
```

### **3. 权限控制**
某些转换需要特定角色（如取消订单需要 `admin` 角色），确保在前端调用时传递正确的 `operator` 和角色信息。

### **4. 异步处理**
进度更新触发工作流状态转换使用了 `goroutine` 异步处理，不会阻塞用户操作，但可能有几秒延迟。

---

## 🐛 故障排查

### **问题1：订单状态没有自动更新**
**可能原因：**
- 工作流实例未正确初始化
- 工作流定义不存在或未激活
- 转换条件不满足（如进度未达到 100%）

**排查方法：**
```bash
# 1. 检查订单是否关联工作流
db.orders.findOne({_id: "订单ID"}, {workflow_instance: 1, workflow_code: 1})

# 2. 检查工作流实例
db.workflow_instances.findOne({entity_id: "订单ID"})

# 3. 查看控制台日志
# 搜索包含订单ID的日志，看是否有错误信息
```

### **问题2：进度计算不正确**
**可能原因：**
- 裁片数据不完整
- 总工序数为 0
- 数据类型不匹配

**排查方法：**
```bash
# 1. 检查裁片数据
db.cutting_pieces.find({order_id: "订单ID"})

# 2. 查看控制台日志
# 搜索 "📊 订单进度计算"
```

### **问题3：自动完成事件未触发**
**可能原因：**
- 订单当前状态不是"生产中"
- 进度未真正达到 100%（可能是 99.9%）
- 转换条件检查失败

**排查方法：**
```bash
# 1. 检查订单当前状态
db.orders.findOne({_id: "订单ID"}, {status: 1, workflow_state: 1, progress: 1})

# 2. 手动触发完成事件（测试）
# 在订单详情页，点击"执行转换" → "完成"
```

---

## 📝 API 接口

### **1. 获取工作流状态**
```http
GET /order/orders/:id/workflow/state
```

**响应示例：**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "instance": {
      "id": "68f38803075a19ada180fcb8",
      "workflow_id": "68f...",
      "current_state": "production",
      "history": [
        {
          "from_state": "draft",
          "to_state": "ordered",
          "event": "submit_order",
          "operator": "system",
          "timestamp": 1729265331
        }
      ]
    }
  }
}
```

### **2. 获取可用转换**
```http
GET /order/orders/:id/workflow/transitions
```

**响应示例：**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "transitions": [
      {
        "id": "trans_001",
        "name": "更新进度",
        "event": "update_progress",
        "from_state": "production",
        "to_state": "production",
        "conditions": [],
        "require_role": ""
      },
      {
        "id": "trans_002",
        "name": "完成",
        "event": "complete",
        "from_state": "production",
        "to_state": "completed",
        "conditions": [
          {
            "type": "field",
            "field": "progress",
            "operator": "gte",
            "value": 1
          }
        ]
      }
    ]
  }
}
```

### **3. 执行状态转换**
```http
POST /order/orders/:id/workflow/transition
Content-Type: application/json

{
  "event": "complete",
  "operator": "admin",
  "reason": "手动完成订单",
  "metadata": {
    "progress": 1.0
  }
}
```

---

## ✅ 验证清单

- [ ] 创建订单时自动初始化工作流（状态：草稿）
- [ ] 配置工序后自动提交订单（草稿 → 已下单）
- [ ] 创建裁剪任务时开始生产（已下单 → 生产中）
- [ ] 扫码上报进度时自动计算订单进度
- [ ] 所有裁片完成时自动完成订单（生产中 → 已完成）
- [ ] 订单详情页显示正确的工作流状态和进度
- [ ] 工作流历史记录完整
- [ ] 控制台日志输出正确

---

## 🎉 总结

工作流系统现已完全集成到订单业务中，实现了：

1. ✅ **自动状态转换**：无需手动修改订单状态
2. ✅ **实时进度计算**：基于裁片进度自动更新订单进度
3. ✅ **条件驱动**：只有满足条件才能执行转换
4. ✅ **权限控制**：敏感操作需要特定角色
5. ✅ **历史追踪**：完整记录所有状态变化
6. ✅ **异步处理**：不阻塞用户操作

现在订单的状态管理完全由工作流引擎驱动，更加灵活、可靠、可追溯！🚀


