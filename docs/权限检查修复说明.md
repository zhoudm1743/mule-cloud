# 权限检查修复说明

## 问题描述

前端在编辑/分配角色菜单时，提示：**"无权限：只能编辑本租户的角色"**

## 原因分析

在物理隔离架构中，每个租户的数据存储在独立的数据库中：
- 系统库：`tenant_system`（只存储 tenant、menu）
- 租户库：`mule_{tenantID}`（存储该租户的 admin、role、业务数据）

**数据库自动切换机制**：
```go
// Repository 的 getCollection 自动根据 context 切换数据库
func (r *roleRepository) getCollection(ctx context.Context) *mongo.Collection {
    tenantID := tenantCtx.GetTenantID(ctx)
    db := r.dbManager.GetDatabase(tenantID) // 自动切换到 mule_{tenantID}
    return db.Collection("role")
}
```

因此：
1. **物理隔离**：租户 A 的用户登录后，JWT 中携带 `tenant_id: A`
2. **Context 传递**：中间件将 `tenant_id: A` 注入到 Context
3. **自动切换**：Repository 自动切换到 `mule_A` 数据库
4. **天然隔离**：用户只能查询到自己数据库中的数据，**根本查不到其他租户的数据**

**前端的 tenant_id 检查是多余的，因为：**
- 后端已经通过数据库隔离保证了安全
- 前端看到的所有数据都是当前租户的数据
- 不存在"编辑其他租户角色"的可能性

## 修复方案

### 前端修复

**文件：** `frontend/src/views/system/role/components/TableModal.vue`

```typescript
// 修改前（第 280-287 行）
// 租户超管权限检查：只能编辑本租户的角色
if (!isSystemAdmin.value) {
  const currentTenantId = authStore.userInfo?.tenant_id || ''
  if (data.tenant_id !== currentTenantId) {
    window.$message.error('无权限：只能编辑本租户的角色')
    return
  }
}

// 修改后
// 数据库物理隔离模式：每个租户只能访问自己数据库中的数据，无需额外检查
```

### 后端状态

后端的 Transport 层已经移除了 `tenant_id` 权限检查：

```go
// app/system/transport/role.go

// UpdateRoleHandler 更新角色
func UpdateRoleHandler(roleSvc *services.RoleService) gin.HandlerFunc {
    return func(c *gin.Context) {
        // ... 省略参数验证 ...
        
        // 数据库隔离后不需要租户权限检查
        
        err := roleSvc.Update(c.Request.Context(), id, &req, updatedBy)
        // ...
    }
}
```

## 安全性保证

即使移除了前端的权限检查，系统仍然是安全的：

### 1. JWT 验证
```go
// Gateway 中间件验证 JWT
claims, err := jwtManager.ParseToken(token)
tenantID := claims.TenantID
```

### 2. Context 注入
```go
// 将 tenant_id 注入到 Context
ctx = tenantCtx.WithTenantID(ctx, tenantID)
```

### 3. 数据库自动切换
```go
// Repository 自动切换到租户数据库
db := r.dbManager.GetDatabase(tenantID) // mule_{tenantID}
```

### 4. 物理隔离
```
租户 A (tenant_id: "xxx")
→ 只能访问 mule_xxx 数据库
→ 物理上无法访问 mule_yyy 数据库

租户 B (tenant_id: "yyy")
→ 只能访问 mule_yyy 数据库
→ 物理上无法访问 mule_xxx 数据库
```

## 测试验证

### 1. 租户用户登录
```bash
POST /admin/auth/login
{
    "phone": "13838383388",
    "password": "123456",
    "tenant_code": "default"
}

响应：
{
    "token": "...",
    "tenant_id": "68dda6cd04ba0d6c8dda4b7a"
}
```

### 2. 查询角色列表
```bash
GET /admin/system/roles
Header: Authorization: Bearer {token}

→ Context 中 tenant_id = "68dda6cd04ba0d6c8dda4b7a"
→ Repository 自动切换到 mule_68dda6cd04ba0d6c8dda4b7a
→ 只返回该租户的角色
```

### 3. 编辑角色
```bash
PUT /admin/system/roles/{id}
Header: Authorization: Bearer {token}

→ 同样只能编辑 mule_68dda6cd04ba0d6c8dda4b7a 中的角色
→ 无法编辑其他租户的角色（数据库级别隔离）
```

## 总结

✅ **已修复：** 移除前端多余的 `tenant_id` 权限检查

✅ **安全保证：** 通过数据库物理隔离确保数据安全

✅ **编译通过：** 后端代码编译正常

✅ **功能正常：** 角色编辑、菜单分配功能可正常使用

**现在可以正常编辑角色和分配菜单权限了！** 🎉

