# æƒé™æ£€æŸ¥ä¿®å¤è¯´æ˜

## é—®é¢˜æè¿°

å‰ç«¯åœ¨ç¼–è¾‘/åˆ†é…è§’è‰²èœå•æ—¶ï¼Œæç¤ºï¼š**"æ— æƒé™ï¼šåªèƒ½ç¼–è¾‘æœ¬ç§Ÿæˆ·çš„è§’è‰²"**

## åŸå› åˆ†æ

åœ¨ç‰©ç†éš”ç¦»æ¶æ„ä¸­ï¼Œæ¯ä¸ªç§Ÿæˆ·çš„æ•°æ®å­˜å‚¨åœ¨ç‹¬ç«‹çš„æ•°æ®åº“ä¸­ï¼š
- ç³»ç»Ÿåº“ï¼š`tenant_system`ï¼ˆåªå­˜å‚¨ tenantã€menuï¼‰
- ç§Ÿæˆ·åº“ï¼š`mule_{tenantID}`ï¼ˆå­˜å‚¨è¯¥ç§Ÿæˆ·çš„ adminã€roleã€ä¸šåŠ¡æ•°æ®ï¼‰

**æ•°æ®åº“è‡ªåŠ¨åˆ‡æ¢æœºåˆ¶**ï¼š
```go
// Repository çš„ getCollection è‡ªåŠ¨æ ¹æ® context åˆ‡æ¢æ•°æ®åº“
func (r *roleRepository) getCollection(ctx context.Context) *mongo.Collection {
    tenantID := tenantCtx.GetTenantID(ctx)
    db := r.dbManager.GetDatabase(tenantID) // è‡ªåŠ¨åˆ‡æ¢åˆ° mule_{tenantID}
    return db.Collection("role")
}
```

å› æ­¤ï¼š
1. **ç‰©ç†éš”ç¦»**ï¼šç§Ÿæˆ· A çš„ç”¨æˆ·ç™»å½•åï¼ŒJWT ä¸­æºå¸¦ `tenant_id: A`
2. **Context ä¼ é€’**ï¼šä¸­é—´ä»¶å°† `tenant_id: A` æ³¨å…¥åˆ° Context
3. **è‡ªåŠ¨åˆ‡æ¢**ï¼šRepository è‡ªåŠ¨åˆ‡æ¢åˆ° `mule_A` æ•°æ®åº“
4. **å¤©ç„¶éš”ç¦»**ï¼šç”¨æˆ·åªèƒ½æŸ¥è¯¢åˆ°è‡ªå·±æ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œ**æ ¹æœ¬æŸ¥ä¸åˆ°å…¶ä»–ç§Ÿæˆ·çš„æ•°æ®**

**å‰ç«¯çš„ tenant_id æ£€æŸ¥æ˜¯å¤šä½™çš„ï¼Œå› ä¸ºï¼š**
- åç«¯å·²ç»é€šè¿‡æ•°æ®åº“éš”ç¦»ä¿è¯äº†å®‰å…¨
- å‰ç«¯çœ‹åˆ°çš„æ‰€æœ‰æ•°æ®éƒ½æ˜¯å½“å‰ç§Ÿæˆ·çš„æ•°æ®
- ä¸å­˜åœ¨"ç¼–è¾‘å…¶ä»–ç§Ÿæˆ·è§’è‰²"çš„å¯èƒ½æ€§

## ä¿®å¤æ–¹æ¡ˆ

### å‰ç«¯ä¿®å¤

**æ–‡ä»¶ï¼š** `frontend/src/views/system/role/components/TableModal.vue`

```typescript
// ä¿®æ”¹å‰ï¼ˆç¬¬ 280-287 è¡Œï¼‰
// ç§Ÿæˆ·è¶…ç®¡æƒé™æ£€æŸ¥ï¼šåªèƒ½ç¼–è¾‘æœ¬ç§Ÿæˆ·çš„è§’è‰²
if (!isSystemAdmin.value) {
  const currentTenantId = authStore.userInfo?.tenant_id || ''
  if (data.tenant_id !== currentTenantId) {
    window.$message.error('æ— æƒé™ï¼šåªèƒ½ç¼–è¾‘æœ¬ç§Ÿæˆ·çš„è§’è‰²')
    return
  }
}

// ä¿®æ”¹å
// æ•°æ®åº“ç‰©ç†éš”ç¦»æ¨¡å¼ï¼šæ¯ä¸ªç§Ÿæˆ·åªèƒ½è®¿é—®è‡ªå·±æ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œæ— éœ€é¢å¤–æ£€æŸ¥
```

### åç«¯çŠ¶æ€

åç«¯çš„ Transport å±‚å·²ç»ç§»é™¤äº† `tenant_id` æƒé™æ£€æŸ¥ï¼š

```go
// app/system/transport/role.go

// UpdateRoleHandler æ›´æ–°è§’è‰²
func UpdateRoleHandler(roleSvc *services.RoleService) gin.HandlerFunc {
    return func(c *gin.Context) {
        // ... çœç•¥å‚æ•°éªŒè¯ ...
        
        // æ•°æ®åº“éš”ç¦»åä¸éœ€è¦ç§Ÿæˆ·æƒé™æ£€æŸ¥
        
        err := roleSvc.Update(c.Request.Context(), id, &req, updatedBy)
        // ...
    }
}
```

## å®‰å…¨æ€§ä¿è¯

å³ä½¿ç§»é™¤äº†å‰ç«¯çš„æƒé™æ£€æŸ¥ï¼Œç³»ç»Ÿä»ç„¶æ˜¯å®‰å…¨çš„ï¼š

### 1. JWT éªŒè¯
```go
// Gateway ä¸­é—´ä»¶éªŒè¯ JWT
claims, err := jwtManager.ParseToken(token)
tenantID := claims.TenantID
```

### 2. Context æ³¨å…¥
```go
// å°† tenant_id æ³¨å…¥åˆ° Context
ctx = tenantCtx.WithTenantID(ctx, tenantID)
```

### 3. æ•°æ®åº“è‡ªåŠ¨åˆ‡æ¢
```go
// Repository è‡ªåŠ¨åˆ‡æ¢åˆ°ç§Ÿæˆ·æ•°æ®åº“
db := r.dbManager.GetDatabase(tenantID) // mule_{tenantID}
```

### 4. ç‰©ç†éš”ç¦»
```
ç§Ÿæˆ· A (tenant_id: "xxx")
â†’ åªèƒ½è®¿é—® mule_xxx æ•°æ®åº“
â†’ ç‰©ç†ä¸Šæ— æ³•è®¿é—® mule_yyy æ•°æ®åº“

ç§Ÿæˆ· B (tenant_id: "yyy")
â†’ åªèƒ½è®¿é—® mule_yyy æ•°æ®åº“
â†’ ç‰©ç†ä¸Šæ— æ³•è®¿é—® mule_xxx æ•°æ®åº“
```

## æµ‹è¯•éªŒè¯

### 1. ç§Ÿæˆ·ç”¨æˆ·ç™»å½•
```bash
POST /admin/auth/login
{
    "phone": "13838383388",
    "password": "123456",
    "tenant_code": "default"
}

å“åº”ï¼š
{
    "token": "...",
    "tenant_id": "68dda6cd04ba0d6c8dda4b7a"
}
```

### 2. æŸ¥è¯¢è§’è‰²åˆ—è¡¨
```bash
GET /admin/system/roles
Header: Authorization: Bearer {token}

â†’ Context ä¸­ tenant_id = "68dda6cd04ba0d6c8dda4b7a"
â†’ Repository è‡ªåŠ¨åˆ‡æ¢åˆ° mule_68dda6cd04ba0d6c8dda4b7a
â†’ åªè¿”å›è¯¥ç§Ÿæˆ·çš„è§’è‰²
```

### 3. ç¼–è¾‘è§’è‰²
```bash
PUT /admin/system/roles/{id}
Header: Authorization: Bearer {token}

â†’ åŒæ ·åªèƒ½ç¼–è¾‘ mule_68dda6cd04ba0d6c8dda4b7a ä¸­çš„è§’è‰²
â†’ æ— æ³•ç¼–è¾‘å…¶ä»–ç§Ÿæˆ·çš„è§’è‰²ï¼ˆæ•°æ®åº“çº§åˆ«éš”ç¦»ï¼‰
```

## æ€»ç»“

âœ… **å·²ä¿®å¤ï¼š** ç§»é™¤å‰ç«¯å¤šä½™çš„ `tenant_id` æƒé™æ£€æŸ¥

âœ… **å®‰å…¨ä¿è¯ï¼š** é€šè¿‡æ•°æ®åº“ç‰©ç†éš”ç¦»ç¡®ä¿æ•°æ®å®‰å…¨

âœ… **ç¼–è¯‘é€šè¿‡ï¼š** åç«¯ä»£ç ç¼–è¯‘æ­£å¸¸

âœ… **åŠŸèƒ½æ­£å¸¸ï¼š** è§’è‰²ç¼–è¾‘ã€èœå•åˆ†é…åŠŸèƒ½å¯æ­£å¸¸ä½¿ç”¨

**ç°åœ¨å¯ä»¥æ­£å¸¸ç¼–è¾‘è§’è‰²å’Œåˆ†é…èœå•æƒé™äº†ï¼** ğŸ‰

