# ä¸¤å±‚æƒé™æ£€æŸ¥æ¶æ„è¯´æ˜

## ğŸ¤” é—®é¢˜èƒŒæ™¯

**ç”¨æˆ·ç–‘é—®**ï¼šå½“å‰ Casbin é€šè¿‡ `path + action` æ¥åŒ¹é…æƒé™ï¼Œä½†è‡ªå®šä¹‰ä¸šåŠ¡æƒé™ï¼ˆå¦‚"æŒ‚è´¦"ã€"æ ¸é”€"ï¼‰æ²¡æœ‰å¯¹åº”çš„ç‹¬ç«‹ HTTP è·¯å¾„ï¼ŒCasbin æ€ä¹ˆåˆ¤æ–­ï¼Ÿ

## âœ… æ­£ç¡®ç­”æ¡ˆï¼šä¸¤å±‚æ£€æŸ¥æ¶æ„

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Gateway å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Casbin ä¸­é—´ä»¶ (casbin_auth.go)                   â”‚     â”‚
â”‚  â”‚  - æ‹¦æˆªæ‰€æœ‰ HTTP è¯·æ±‚                              â”‚     â”‚
â”‚  â”‚  - æå– path + method                              â”‚     â”‚
â”‚  â”‚  - æ˜ å°„: GETâ†’read, POSTâ†’create, PUTâ†’update         â”‚     â”‚
â”‚  â”‚  - æ£€æŸ¥: ç”¨æˆ·èƒ½å¦è®¿é—®è¿™ä¸ªè·¯å¾„                      â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚               â†“ é€šè¿‡åŸºç¡€æ£€æŸ¥                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸šåŠ¡æœåŠ¡å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  ä¸šåŠ¡é€»è¾‘ä»£ç  (services/*.go)                      â”‚     â”‚
â”‚  â”‚  - æ ¹æ®å…·ä½“ä¸šåŠ¡æ“ä½œ                                â”‚     â”‚
â”‚  â”‚  - è°ƒç”¨ casbin.CheckUserPermission()               â”‚     â”‚
â”‚  â”‚  - æ£€æŸ¥: ç”¨æˆ·èƒ½å¦æ‰§è¡Œç‰¹å®šä¸šåŠ¡åŠ¨ä½œï¼ˆpending/verifyï¼‰â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š ç¬¬ä¸€å±‚ï¼šGateway HTTP å±‚é¢æ£€æŸ¥

### Gateway çš„ Casbin ä¸­é—´ä»¶

```go
// app/gateway/middleware/casbin_auth.go

func getActionFromMethod(method string) string {
    switch strings.ToUpper(method) {
    case "GET", "HEAD":   return "read"
    case "POST":          return "create"
    case "PUT", "PATCH":  return "update"
    case "DELETE":        return "delete"
    default:              return "read"
    }
}

// æƒé™æ£€æŸ¥
resource := "/finance/order"           // è¯·æ±‚è·¯å¾„
action := getActionFromMethod("POST")  // POST â†’ "create"
allowed, err = casbin.CheckPermission(userSub, resource, action)
```

### è¿™ä¸€å±‚çš„ä½œç”¨

âœ… **æ£€æŸ¥å†…å®¹**ï¼šç”¨æˆ·èƒ½å¦è®¿é—®è¿™ä¸ª HTTP è·¯å¾„
- `GET /finance/order` â†’ æ£€æŸ¥ `read` æƒé™
- `POST /finance/order` â†’ æ£€æŸ¥ `create` æƒé™
- `PUT /finance/order/:id` â†’ æ£€æŸ¥ `update` æƒé™
- `DELETE /finance/order/:id` â†’ æ£€æŸ¥ `delete` æƒé™

âŒ **æ— æ³•æ£€æŸ¥**ï¼šå…·ä½“çš„ä¸šåŠ¡æ“ä½œï¼ˆæŒ‚è´¦ã€æ ¸é”€ã€å®¡æ ¸ç­‰ï¼‰

### ä¸ºä»€ä¹ˆæ— æ³•æ£€æŸ¥ä¸šåŠ¡æ“ä½œï¼Ÿ

å› ä¸ºæ‰€æœ‰ä¸šåŠ¡æ“ä½œå¯èƒ½éƒ½æ˜¯ **ç›¸åŒçš„ HTTP è¯·æ±‚**ï¼š

```bash
# åˆ›å»ºè®¢å•
POST /finance/order
Body: { "amount": 100, "customer": "å¼ ä¸‰" }

# æŒ‚è´¦æ“ä½œ
POST /finance/order/action
Body: { "action": "pending", "orderId": "123" }

# æ ¸é”€æ“ä½œ  
POST /finance/order/action
Body: { "action": "verify", "orderId": "123" }
```

Gateway åªèƒ½çœ‹åˆ°ï¼š
- Method: `POST`
- Path: `/finance/order/action`
- Action: `create` (å› ä¸ºæ˜¯ POST)

Gateway **æ— æ³•åŒºåˆ†**è¿™æ˜¯"æŒ‚è´¦"è¿˜æ˜¯"æ ¸é”€"ï¼Œå› ä¸ºå®ƒä»¬éƒ½æ˜¯ POST è¯·æ±‚ï¼

## ğŸ“Š ç¬¬äºŒå±‚ï¼šä¸šåŠ¡ä»£ç å±‚é¢æ£€æŸ¥

### åœ¨ä¸šåŠ¡é€»è¾‘ä¸­æ‰‹åŠ¨æ£€æŸ¥

```go
// app/finance/services/order.go

import "mule-cloud/core/casbin"

type OrderService struct {
    // ...
}

// HandleOrderAction å¤„ç†è®¢å•æ“ä½œ
func (s *OrderService) HandleOrderAction(ctx context.Context, userID, tenantID, action, orderID string) error {
    // ç¬¬ä¸€æ­¥ï¼šæ ¹æ® action ç¡®å®šéœ€è¦çš„æƒé™
    var requiredPermission string
    switch action {
    case "pending":
        requiredPermission = "pending"  // æŒ‚è´¦æƒé™
    case "verify":
        requiredPermission = "verify"   // æ ¸é”€æƒé™
    case "audit":
        requiredPermission = "audit"    // å®¡æ ¸æƒé™
    default:
        return fmt.Errorf("æœªçŸ¥æ“ä½œ: %s", action)
    }
    
    // ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰è¿™ä¸ªä¸šåŠ¡æƒé™
    hasPermission := casbin.CheckUserPermission(tenantID, userID, "/finance", requiredPermission)
    if !hasPermission {
        log.Printf("[æƒé™æ‹’ç»] ç”¨æˆ· %s æ—  %s æƒé™", userID, requiredPermission)
        return fmt.Errorf("æ— %sæƒé™", requiredPermission)
    }
    
    // ç¬¬ä¸‰æ­¥ï¼šæ‰§è¡Œä¸šåŠ¡é€»è¾‘
    switch action {
    case "pending":
        return s.pendingOrder(ctx, orderID)
    case "verify":
        return s.verifyOrder(ctx, orderID)
    case "audit":
        return s.auditOrder(ctx, orderID)
    }
    
    return nil
}

func (s *OrderService) pendingOrder(ctx context.Context, orderID string) error {
    log.Printf("æ‰§è¡ŒæŒ‚è´¦é€»è¾‘: %s", orderID)
    // æ›´æ–°è®¢å•çŠ¶æ€ä¸ºæŒ‚è´¦...
    return nil
}

func (s *OrderService) verifyOrder(ctx context.Context, orderID string) error {
    log.Printf("æ‰§è¡Œæ ¸é”€é€»è¾‘: %s", orderID)
    // æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå·²æ ¸é”€...
    return nil
}
```

### å®Œæ•´è¯·æ±‚æµç¨‹

```
1. ç”¨æˆ·å‘èµ·è¯·æ±‚
   POST /admin/finance/order/action
   Body: { "action": "pending", "orderId": "123" }
   â†“

2. Gateway Casbin ä¸­é—´ä»¶ âœ…
   - æ£€æŸ¥: POST /admin/finance/order/action â†’ "create" æƒé™
   - ç”¨æˆ·æœ‰ "create" æƒé™ â†’ æ”¾è¡Œ
   â†“

3. è·¯ç”±åˆ° OrderService.HandleOrderAction() âœ…
   - è§£æ action = "pending"
   - è°ƒç”¨ casbin.CheckUserPermission(tenantID, userID, "/finance", "pending")
   - ç”¨æˆ·æœ‰ "pending" æƒé™ â†’ æ‰§è¡ŒæŒ‚è´¦é€»è¾‘
   â†“

4. è¿”å›æˆåŠŸ
```

## ğŸ¯ å…³é”®ç‚¹æ€»ç»“

### 1. Gateway å±‚çš„ Casbin ç­–ç•¥

```
tenant:A:user:user1, /finance, read
tenant:A:user:user1, /finance, create
tenant:A:user:user1, /finance, update
tenant:A:user:user1, /finance, pending  â† è‡ªå®šä¹‰ä¸šåŠ¡æƒé™ä¹Ÿå­˜å‚¨åœ¨ Casbinï¼
tenant:A:user:user1, /finance, verify   â† è‡ªå®šä¹‰ä¸šåŠ¡æƒé™ä¹Ÿå­˜å‚¨åœ¨ Casbinï¼
```

- Gateway ä¸­é—´ä»¶**åªæ£€æŸ¥ HTTP å±‚é¢**çš„æƒé™ï¼ˆread/create/update/deleteï¼‰
- ä½† Casbin æ•°æ®åº“ä¸­**å­˜å‚¨äº†æ‰€æœ‰æƒé™**ï¼ˆåŒ…æ‹¬ pending/verifyï¼‰
- ä¸šåŠ¡ä»£ç å¯ä»¥é€šè¿‡ `casbin.CheckUserPermission()` **æ‰‹åŠ¨æŸ¥è¯¢**è¿™äº›æƒé™

### 2. ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡ï¼Ÿ

#### âœ… ä¼˜ç‚¹

1. **è§£è€¦åˆ**ï¼šGateway è´Ÿè´£ HTTP å±‚ï¼Œä¸šåŠ¡ä»£ç è´Ÿè´£ä¸šåŠ¡é€»è¾‘
2. **çµæ´»æ€§**ï¼šä¸šåŠ¡æƒé™å¯ä»¥è‡ªç”±å®šä¹‰ï¼Œä¸å— HTTP æ–¹æ³•é™åˆ¶
3. **å®‰å…¨æ€§**ï¼šåŒé‡æ£€æŸ¥ï¼Œæ›´åŠ å®‰å…¨
4. **å¯æ‰©å±•**ï¼šæ–°å¢ä¸šåŠ¡æƒé™ä¸éœ€è¦ä¿®æ”¹ Gateway

#### âŒ å¦‚æœåªä¾èµ– Gatewayï¼Ÿ

å‡è®¾è¦åœ¨ Gateway æ£€æŸ¥"æŒ‚è´¦"æƒé™ï¼Œéœ€è¦ï¼š
- ä¸ºæ¯ä¸ªä¸šåŠ¡æ“ä½œåˆ›å»ºç‹¬ç«‹è·¯ç”±ï¼š`POST /finance/pending`, `POST /finance/verify`
- æˆ–è€…è‡ªå®šä¹‰ HTTP å¤´ï¼š`X-Business-Action: pending`
- éƒ½ä¸å¤Ÿä¼˜é›…ï¼

## ğŸ“ ä»£ç ç¤ºä¾‹åˆé›†

### ç¤ºä¾‹ 1ï¼šè´¢åŠ¡è®¢å•æŒ‚è´¦

```go
// app/finance/transport/order.go

func HandleOrderActionHandler(orderSvc *services.OrderService) gin.HandlerFunc {
    return func(c *gin.Context) {
        userID := c.GetString("userID")
        tenantID := c.GetString("tenantID")
        
        var req struct {
            Action  string `json:"action" binding:"required"`
            OrderID string `json:"orderId" binding:"required"`
        }
        
        if err := c.ShouldBindJSON(&req); err != nil {
            response.Error(c, "å‚æ•°é”™è¯¯")
            return
        }
        
        // è°ƒç”¨ service å±‚ï¼Œservice å±‚ä¼šæ£€æŸ¥æƒé™
        err := orderSvc.HandleOrderAction(c.Request.Context(), userID, tenantID, req.Action, req.OrderID)
        if err != nil {
            response.Error(c, err.Error())
            return
        }
        
        response.SuccessWithMsg(c, "æ“ä½œæˆåŠŸ", nil)
    }
}
```

### ç¤ºä¾‹ 2ï¼šå·¥ä½œæµå®¡æ‰¹

```go
// app/workflow/services/approval.go

func (s *ApprovalService) ApproveTask(ctx context.Context, userID, tenantID, taskID string) error {
    // æ£€æŸ¥å®¡æ‰¹æƒé™
    hasPermission := casbin.CheckUserPermission(tenantID, userID, "/workflow", "approve")
    if !hasPermission {
        return fmt.Errorf("æ— å®¡æ‰¹æƒé™")
    }
    
    // æ‰§è¡Œå®¡æ‰¹é€»è¾‘
    return s.repo.UpdateTaskStatus(ctx, taskID, "approved", userID)
}

func (s *ApprovalService) RejectTask(ctx context.Context, userID, tenantID, taskID string) error {
    // æ£€æŸ¥é©³å›æƒé™
    hasPermission := casbin.CheckUserPermission(tenantID, userID, "/workflow", "reject")
    if !hasPermission {
        return fmt.Errorf("æ— é©³å›æƒé™")
    }
    
    // æ‰§è¡Œé©³å›é€»è¾‘
    return s.repo.UpdateTaskStatus(ctx, taskID, "rejected", userID)
}
```

### ç¤ºä¾‹ 3ï¼šæ•°æ®å¯¼å‡º

```go
// app/report/services/export.go

func (s *ReportService) ExportData(ctx context.Context, userID, tenantID, reportType string) ([]byte, error) {
    // æ£€æŸ¥å¯¼å‡ºæƒé™
    hasPermission := casbin.CheckUserPermission(tenantID, userID, "/report", "export")
    if !hasPermission {
        return nil, fmt.Errorf("æ— å¯¼å‡ºæƒé™")
    }
    
    // æ‰§è¡Œå¯¼å‡ºé€»è¾‘
    return s.generateExcel(ctx, reportType)
}
```

## ğŸ”— æƒé™åŒæ­¥æœºåˆ¶

### æƒé™æ˜¯å¦‚ä½•å­˜å‚¨åˆ° Casbin çš„ï¼Ÿ

```go
// app/system/services/role.go

func (s *RoleService) AssignMenus(ctx context.Context, roleID string, menuNames []string, menuPermissions map[string][]string, updatedBy string) error {
    // 1. æ›´æ–°æ•°æ®åº“
    updates := map[string]interface{}{
        "menus":            menuNames,
        "menu_permissions": menuPermissions,  // {"finance": ["read", "create", "pending", "verify"]}
    }
    err = s.roleRepo.Update(ctx, roleID, updates)
    
    // 2. åŒæ­¥åˆ° Casbinï¼ˆåŒ…æ‹¬è‡ªå®šä¹‰æƒé™ï¼ï¼‰
    menuPathMap := make(map[string]string)
    for _, menuName := range menuNames {
        menu, _ := s.menuRepo.GetByName(ctx, menuName)
        menuPathMap[menuName] = menu.Path  // {"finance": "/finance"}
    }
    
    // è¿™é‡Œä¼šæŠŠæ‰€æœ‰æƒé™ï¼ˆread/create/pending/verifyï¼‰éƒ½å†™å…¥ Casbinï¼
    err = casbin.SyncRoleMenusWithPermissions(role.TenantID, roleID, menuPermissions, menuPathMap)
    
    return nil
}
```

### Casbin ç­–ç•¥è¡¨å†…å®¹

```
p, tenant:A:role:role1, /finance, read
p, tenant:A:role:role1, /finance, create
p, tenant:A:role:role1, /finance, update
p, tenant:A:role:role1, /finance, delete
p, tenant:A:role:role1, /finance, pending   â† è‡ªå®šä¹‰æƒé™åœ¨è¿™é‡Œï¼
p, tenant:A:role:role1, /finance, verify    â† è‡ªå®šä¹‰æƒé™åœ¨è¿™é‡Œï¼

g, tenant:A:user:user1, tenant:A:role:role1
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ä¸šåŠ¡ä»£ç å¿…é¡»æ‰‹åŠ¨æ£€æŸ¥æƒé™

âŒ **é”™è¯¯ç¤ºä¾‹**ï¼ˆæ²¡æœ‰æ£€æŸ¥æƒé™ï¼‰ï¼š
```go
func (s *OrderService) PendingOrder(ctx context.Context, orderID string) error {
    // ç›´æ¥æ‰§è¡Œä¸šåŠ¡é€»è¾‘ - å±é™©ï¼
    return s.updateOrderStatus(ctx, orderID, "pending")
}
```

âœ… **æ­£ç¡®ç¤ºä¾‹**ï¼ˆå…ˆæ£€æŸ¥æƒé™ï¼‰ï¼š
```go
func (s *OrderService) PendingOrder(ctx context.Context, userID, tenantID, orderID string) error {
    // å…ˆæ£€æŸ¥æƒé™
    if !casbin.CheckUserPermission(tenantID, userID, "/finance", "pending") {
        return fmt.Errorf("æ— æŒ‚è´¦æƒé™")
    }
    
    // å†æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    return s.updateOrderStatus(ctx, orderID, "pending")
}
```

### 2. æƒé™å‘½åè§„èŒƒ

| æƒé™ç±»å‹ | Action ç¤ºä¾‹ | è¯´æ˜ |
|---------|-------------|------|
| åŸºç¡€æƒé™ | read, create, update, delete | HTTP æ–¹æ³•æ˜ å°„ |
| ä¸šåŠ¡æƒé™ | pending, verify, approve, reject, export | è‡ªå®šä¹‰ä¸šåŠ¡æ“ä½œ |

### 3. å‰ç«¯æƒé™æ§åˆ¶

å‰ç«¯ä½¿ç”¨ `hasAction` æ§åˆ¶æŒ‰é’®æ˜¾ç¤ºï¼š

```vue
<script setup lang="ts">
import { usePermission } from '@/hooks'

const { hasAction } = usePermission()
</script>

<template>
  <!-- åŸºç¡€æƒé™ -->
  <NButton v-if="hasAction('finance', 'create')" @click="handleCreate">
    æ–°å»ºè®¢å•
  </NButton>
  
  <!-- ä¸šåŠ¡æƒé™ -->
  <NButton v-if="hasAction('finance', 'pending')" @click="handlePending">
    æŒ‚è´¦
  </NButton>
  
  <NButton v-if="hasAction('finance', 'verify')" @click="handleVerify">
    æ ¸é”€
  </NButton>
</template>
```

## ğŸ‰ æ€»ç»“

| å±‚çº§ | æ£€æŸ¥å†…å®¹ | æ£€æŸ¥æ–¹å¼ | ä½œç”¨ |
|-----|---------|---------|------|
| Gateway å±‚ | HTTP è®¿é—®æƒé™ | Casbin ä¸­é—´ä»¶è‡ªåŠ¨æ£€æŸ¥ | ç²—ç²’åº¦æ‹¦æˆªï¼Œé˜²æ­¢æœªæˆæƒè®¿é—® |
| ä¸šåŠ¡ä»£ç å±‚ | ä¸šåŠ¡æ“ä½œæƒé™ | æ‰‹åŠ¨è°ƒç”¨ `casbin.CheckUserPermission()` | ç»†ç²’åº¦æ§åˆ¶ï¼Œç¡®ä¿ä¸šåŠ¡å®‰å…¨ |

**æ ¸å¿ƒæ€æƒ³**ï¼š
- Gateway è´Ÿè´£ **"èƒ½ä¸èƒ½è¿›æ¥"**
- ä¸šåŠ¡ä»£ç è´Ÿè´£ **"èƒ½ä¸èƒ½åšè¿™ä¸ªæ“ä½œ"**
- ä¸¤å±‚æ£€æŸ¥ï¼ŒåŒé‡ä¿éšœï¼ğŸ”’

