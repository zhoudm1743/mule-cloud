# 日志系统使用指南

## 📋 概述

项目使用基于 **Uber Zap** 的统一日志系统，提供高性能、结构化的日志记录功能。

---

## 🚀 快速开始

### 1. 服务启动时初始化日志

所有服务在 `main.go` 中已经自动初始化了日志系统：

```go
// cmd/auth/main.go
func main() {
	// 加载配置
	cfg, err := cfgPkg.Load(*configPath)
	if err != nil {
		log.Fatalf("加载配置失败: %v", err)
	}

	// ✅ 初始化日志系统
	if err := loggerPkg.InitLogger(&cfg.Log); err != nil {
		log.Fatalf("初始化日志系统失败: %v", err)
	}
	defer loggerPkg.Close()

	// 开始使用日志
	loggerPkg.Info("🚀 AuthService 启动中...",
		zap.String("service", cfg.Server.Name),
		zap.Int("port", cfg.Server.Port),
	)
}
```

### 2. 在代码中使用日志

#### 导入包

```go
import (
	"mule-cloud/core/logger"
	"go.uber.org/zap"
)
```

#### 基本使用

```go
// ✅ 推荐：结构化日志（使用 zap.Field）
logger.Info("用户登录成功", 
	zap.String("user_id", userID), 
	zap.String("phone", phone))

logger.Error("数据库查询失败", 
	zap.String("collection", "users"), 
	zap.Error(err))

// ✅ 简单场景：格式化日志
logger.Infof("用户 %s 登录成功", phone)
logger.Errorf("查询失败: %v", err)

// ❌ 不推荐：fmt.Printf / log.Printf
fmt.Printf("用户 %s 登录成功\n", phone)  // 不要这样做
log.Printf("查询失败: %v", err)          // 不要这样做
```

---

## 📚 日志级别

### 级别说明

| 级别 | 使用场景 | 示例 |
|------|---------|------|
| **Debug** | 调试信息（开发/测试环境） | 详细的变量值、中间状态 |
| **Info** | 一般信息（正常业务流程） | 用户登录、服务启动 |
| **Warn** | 警告（可恢复的错误） | 配置缺失、降级处理 |
| **Error** | 错误（需要关注的问题） | 数据库连接失败、API调用失败 |
| **Fatal** | 致命错误（服务无法继续） | 配置错误导致无法启动 |

### 使用示例

```go
// Debug - 调试信息
logger.Debug("查询参数", 
	zap.String("filter", filter), 
	zap.Int("page", page))

// Info - 正常业务
logger.Info("租户登录", 
	zap.String("phone", req.Phone), 
	zap.String("tenant_code", req.TenantCode))

// Warn - 可恢复的问题
logger.Warn("无法连接 Consul，使用默认配置", zap.Error(err))

// Error - 需要关注的错误
logger.Error("查询租户用户失败", zap.Error(err))

// Fatal - 致命错误（会终止程序）
logger.Fatal("初始化MongoDB失败", zap.Error(err))
```

---

## 🎯 结构化日志 vs 格式化日志

### 结构化日志（推荐）

**优点**：
- ✅ 性能更好（无需字符串格式化）
- ✅ 易于解析和搜索（JSON格式）
- ✅ 类型安全

```go
// ✅ 推荐
logger.Info("用户登录", 
	zap.String("user_id", "123"), 
	zap.String("tenant_code", "default"),
	zap.Duration("duration", time.Since(start)))

// 输出（JSON格式）：
// {"time":"2025-01-08T10:00:00","level":"INFO","msg":"用户登录","user_id":"123","tenant_code":"default","duration":0.5}
```

### 格式化日志（简单场景）

**使用场景**：简单的单行日志，不需要解析

```go
// ✅ 简单场景可用
logger.Infof("用户 %s 登录成功", phone)
logger.Warnf("配置项 %s 缺失，使用默认值: %v", key, defaultValue)

// 输出：
// 2025-01-08 10:00:00  INFO  用户 13800138000 登录成功
```

---

## 🔧 常用 Zap Field 类型

```go
// 字符串
zap.String("key", "value")

// 数字
zap.Int("count", 10)
zap.Int64("id", 123456789)
zap.Float64("price", 99.99)

// 布尔值
zap.Bool("is_active", true)

// 错误
zap.Error(err)

// 时间和持续时间
zap.Time("created_at", time.Now())
zap.Duration("latency", time.Since(start))

// 数组
zap.Strings("roles", []string{"admin", "user"})
zap.Ints("ids", []int{1, 2, 3})

// 任意对象（会序列化为JSON）
zap.Any("user", userObject)
```

---

## 📖 完整示例

### 登录流程日志

```go
func (s *AuthService) Login(req dto.LoginRequest) (*dto.LoginResponse, error) {
	// 1. 开始登录
	logger.Info("租户登录", 
		zap.String("phone", req.Phone), 
		zap.String("tenant_code", req.TenantCode))

	// 2. 查询租户
	tenant, err := s.tenantRepo.GetByCode(ctx, req.TenantCode)
	if err != nil || tenant == nil {
		logger.Warn("租户不存在", zap.String("tenant_code", req.TenantCode))
		return nil, fmt.Errorf("租户不存在或已禁用")
	}

	logger.Info("找到租户", 
		zap.String("id", tenant.ID), 
		zap.String("code", tenant.Code), 
		zap.String("name", tenant.Name))

	// 3. 查询用户
	admin, err = s.repo.GetByPhone(ctx, req.Phone)
	if err != nil {
		logger.Error("查询租户用户失败", zap.Error(err))
		return nil, fmt.Errorf("查询用户失败: %w", err)
	}

	if admin == nil {
		logger.Warn("用户不存在", zap.String("phone", req.Phone))
		return nil, ErrUserNotFound
	}

	logger.Info("找到用户", 
		zap.String("id", admin.ID), 
		zap.String("nickname", admin.Nickname), 
		zap.Strings("roles", admin.Roles))

	// 4. 生成Token
	token, err := s.jwtManager.GenerateToken(...)
	if err != nil {
		logger.Error("生成token失败", zap.Error(err))
		return nil, err
	}

	logger.Info("登录成功", 
		zap.String("user_id", admin.ID),
		zap.String("tenant_code", tenant.Code))

	return &dto.LoginResponse{...}, nil
}
```

### 中间件日志

```go
func TenantContextMiddleware() gin.HandlerFunc {
	return func(c *gin.Context) {
		tenantID := c.GetHeader("X-Tenant-Context")
		
		if tenantID != "" {
			logger.Debug("系统管理员切换租户上下文", 
				zap.String("tenant_id", tenantID),
				zap.String("path", c.Request.URL.Path))
			
			ctx := c.Request.Context()
			ctx = tenantCtx.WithTenantID(ctx, tenantID)
			c.Request = c.Request.WithContext(ctx)
		}
		
		c.Next()
	}
}
```

### 性能监控日志

```go
func (s *Service) ProcessOrder(orderID string) error {
	start := time.Now()
	
	logger.Info("开始处理订单", zap.String("order_id", orderID))
	
	// 处理逻辑...
	
	duration := time.Since(start)
	logger.Info("订单处理完成", 
		zap.String("order_id", orderID),
		zap.Duration("duration", duration))
	
	if duration > 5*time.Second {
		logger.Warn("订单处理耗时过长", 
			zap.String("order_id", orderID),
			zap.Duration("duration", duration))
	}
	
	return nil
}
```

---

## ⚙️ 配置

日志配置在 `config/xxx.yaml` 中：

```yaml
log:
  level: "info"        # debug, info, warn, error, fatal
  format: "console"    # console（彩色）或 json
  output: "stdout"     # stdout（标准输出）或 file（文件）
  file_path: "logs/auth.log"  # 当 output=file 时生效
  max_size: 100        # 单个日志文件最大大小（MB）
  max_backups: 3       # 保留旧文件数量
  max_age: 7           # 保留天数
  compress: true       # 是否压缩旧文件
```

### 开发环境配置（推荐）

```yaml
log:
  level: "debug"
  format: "console"
  output: "stdout"
```

### 生产环境配置（推荐）

```yaml
log:
  level: "info"
  format: "json"
  output: "file"
  file_path: "/var/log/mule-cloud/auth.log"
  max_size: 100
  max_backups: 10
  max_age: 30
  compress: true
```

---

## 🎨 日志格式

### Console 格式（彩色，适合开发）

```
2025-01-08 10:00:00  INFO  用户登录  {"phone": "13800138000", "tenant_code": "default"}
2025-01-08 10:00:01  WARN  租户不存在  {"tenant_code": "invalid"}
2025-01-08 10:00:02  ERROR 查询失败  {"error": "connection timeout"}
```

### JSON 格式（适合生产，便于日志分析）

```json
{"time":"2025-01-08T10:00:00","level":"INFO","msg":"用户登录","phone":"13800138000","tenant_code":"default"}
{"time":"2025-01-08T10:00:01","level":"WARN","msg":"租户不存在","tenant_code":"invalid"}
{"time":"2025-01-08T10:00:02","level":"ERROR","msg":"查询失败","error":"connection timeout"}
```

---

## 📝 最佳实践

### 1. 日志级别选择

```go
// ✅ 正确
logger.Debug("调试信息", zap.Any("data", data))  // 仅开发环境
logger.Info("用户登录", zap.String("user_id", id))  // 正常业务
logger.Warn("配置缺失，使用默认值", zap.String("key", key))  // 可恢复
logger.Error("数据库查询失败", zap.Error(err))  // 需要关注

// ❌ 错误
logger.Info("数据库连接失败")  // 应该用 Error
logger.Error("用户登录成功")  // 应该用 Info
```

### 2. 错误处理

```go
// ✅ 推荐：记录错误并返回
admin, err := s.repo.GetByPhone(ctx, req.Phone)
if err != nil {
	logger.Error("查询用户失败", 
		zap.String("phone", req.Phone), 
		zap.Error(err))
	return nil, fmt.Errorf("查询用户失败: %w", err)
}

// ❌ 不推荐：只打印不返回
if err != nil {
	logger.Error("查询用户失败", zap.Error(err))
	// 继续执行？？？
}
```

### 3. 敏感信息保护

```go
// ✅ 正确：不记录密码
logger.Info("用户登录", zap.String("phone", req.Phone))

// ❌ 错误：记录了密码
logger.Info("用户登录", 
	zap.String("phone", req.Phone), 
	zap.String("password", req.Password))  // 敏感信息泄露！

// ✅ 正确：脱敏处理
logger.Debug("请求数据", 
	zap.String("phone", maskPhone(req.Phone)),  // 138****8000
	zap.String("id_card", maskIDCard(req.IDCard)))  // 330***********1234
```

### 4. 性能考虑

```go
// ✅ 正确：Debug 日志在生产环境不会执行
logger.Debug("详细调试信息", zap.Any("large_object", obj))

// ❌ 错误：即使不输出也会格式化字符串
logger.Infof("用户: %v", expensiveFunction())  // expensiveFunction 总是会执行

// ✅ 正确：先检查日志级别
if logger.Logger.Core().Enabled(zapcore.DebugLevel) {
	logger.Debug("详细调试信息", zap.Any("data", expensiveFunction()))
}
```

### 5. 上下文关联

```go
// ✅ 推荐：使用 With 创建带上下文的 logger
func (s *Service) ProcessRequest(ctx context.Context, req Request) {
	log := logger.With(
		zap.String("request_id", req.ID),
		zap.String("user_id", getUserID(ctx)),
	)
	
	log.Info("开始处理请求")
	// ... 业务逻辑
	log.Info("请求处理完成")
	
	// 所有日志都会自动包含 request_id 和 user_id
}
```

---

## 🔍 日志查询和分析

### 1. 实时查看日志

```bash
# 查看最新日志
tail -f logs/auth.log

# 查看错误日志
tail -f logs/auth.log | grep ERROR

# 查看特定用户的日志
tail -f logs/auth.log | grep "user_id\":\"123"
```

### 2. JSON 日志解析（生产环境）

```bash
# 使用 jq 解析 JSON 日志
tail -f logs/auth.log | jq '.'

# 只显示错误日志
tail -f logs/auth.log | jq 'select(.level == "ERROR")'

# 统计错误类型
cat logs/auth.log | jq 'select(.level == "ERROR") | .msg' | sort | uniq -c
```

### 3. 集成日志平台

推荐集成 ELK (Elasticsearch + Logstash + Kibana) 或 Loki + Grafana：

```yaml
# filebeat.yml（收集日志）
filebeat.inputs:
  - type: log
    enabled: true
    paths:
      - /var/log/mule-cloud/*.log
    json.keys_under_root: true
    json.add_error_key: true

output.elasticsearch:
  hosts: ["localhost:9200"]
```

---

## 🎉 迁移指南

### 从 fmt.Printf / log.Printf 迁移

```go
// ❌ 旧代码
fmt.Printf("[登录] 租户登录: 手机号=%s, 租户代码=%s\n", req.Phone, req.TenantCode)
log.Printf("警告: 获取角色 %s 菜单失败: %v", roleID, err)

// ✅ 新代码
logger.Info("租户登录", 
	zap.String("phone", req.Phone), 
	zap.String("tenant_code", req.TenantCode))
logger.Warn("获取角色菜单失败", 
	zap.String("role_id", roleID), 
	zap.Error(err))
```

---

## 📚 参考资料

- [Uber Zap 官方文档](https://pkg.go.dev/go.uber.org/zap)
- [项目日志配置](../config/)
- [日志系统实现](../core/logger/logger.go)

---

**现在开始使用统一的日志系统，让日志更清晰、更易分析！** 🎊
