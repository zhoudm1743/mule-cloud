# æ—¥å¿—ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

é¡¹ç›®ä½¿ç”¨åŸºäº **Uber Zap** çš„ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿï¼Œæä¾›é«˜æ€§èƒ½ã€ç»“æ„åŒ–çš„æ—¥å¿—è®°å½•åŠŸèƒ½ã€‚

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. æœåŠ¡å¯åŠ¨æ—¶åˆå§‹åŒ–æ—¥å¿—

æ‰€æœ‰æœåŠ¡åœ¨ `main.go` ä¸­å·²ç»è‡ªåŠ¨åˆå§‹åŒ–äº†æ—¥å¿—ç³»ç»Ÿï¼š

```go
// cmd/auth/main.go
func main() {
	// åŠ è½½é…ç½®
	cfg, err := cfgPkg.Load(*configPath)
	if err != nil {
		log.Fatalf("åŠ è½½é…ç½®å¤±è´¥: %v", err)
	}

	// âœ… åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
	if err := loggerPkg.InitLogger(&cfg.Log); err != nil {
		log.Fatalf("åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿå¤±è´¥: %v", err)
	}
	defer loggerPkg.Close()

	// å¼€å§‹ä½¿ç”¨æ—¥å¿—
	loggerPkg.Info("ğŸš€ AuthService å¯åŠ¨ä¸­...",
		zap.String("service", cfg.Server.Name),
		zap.Int("port", cfg.Server.Port),
	)
}
```

### 2. åœ¨ä»£ç ä¸­ä½¿ç”¨æ—¥å¿—

#### å¯¼å…¥åŒ…

```go
import (
	"mule-cloud/core/logger"
	"go.uber.org/zap"
)
```

#### åŸºæœ¬ä½¿ç”¨

```go
// âœ… æ¨èï¼šç»“æ„åŒ–æ—¥å¿—ï¼ˆä½¿ç”¨ zap.Fieldï¼‰
logger.Info("ç”¨æˆ·ç™»å½•æˆåŠŸ", 
	zap.String("user_id", userID), 
	zap.String("phone", phone))

logger.Error("æ•°æ®åº“æŸ¥è¯¢å¤±è´¥", 
	zap.String("collection", "users"), 
	zap.Error(err))

// âœ… ç®€å•åœºæ™¯ï¼šæ ¼å¼åŒ–æ—¥å¿—
logger.Infof("ç”¨æˆ· %s ç™»å½•æˆåŠŸ", phone)
logger.Errorf("æŸ¥è¯¢å¤±è´¥: %v", err)

// âŒ ä¸æ¨èï¼šfmt.Printf / log.Printf
fmt.Printf("ç”¨æˆ· %s ç™»å½•æˆåŠŸ\n", phone)  // ä¸è¦è¿™æ ·åš
log.Printf("æŸ¥è¯¢å¤±è´¥: %v", err)          // ä¸è¦è¿™æ ·åš
```

---

## ğŸ“š æ—¥å¿—çº§åˆ«

### çº§åˆ«è¯´æ˜

| çº§åˆ« | ä½¿ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|------|---------|------|
| **Debug** | è°ƒè¯•ä¿¡æ¯ï¼ˆå¼€å‘/æµ‹è¯•ç¯å¢ƒï¼‰ | è¯¦ç»†çš„å˜é‡å€¼ã€ä¸­é—´çŠ¶æ€ |
| **Info** | ä¸€èˆ¬ä¿¡æ¯ï¼ˆæ­£å¸¸ä¸šåŠ¡æµç¨‹ï¼‰ | ç”¨æˆ·ç™»å½•ã€æœåŠ¡å¯åŠ¨ |
| **Warn** | è­¦å‘Šï¼ˆå¯æ¢å¤çš„é”™è¯¯ï¼‰ | é…ç½®ç¼ºå¤±ã€é™çº§å¤„ç† |
| **Error** | é”™è¯¯ï¼ˆéœ€è¦å…³æ³¨çš„é—®é¢˜ï¼‰ | æ•°æ®åº“è¿æ¥å¤±è´¥ã€APIè°ƒç”¨å¤±è´¥ |
| **Fatal** | è‡´å‘½é”™è¯¯ï¼ˆæœåŠ¡æ— æ³•ç»§ç»­ï¼‰ | é…ç½®é”™è¯¯å¯¼è‡´æ— æ³•å¯åŠ¨ |

### ä½¿ç”¨ç¤ºä¾‹

```go
// Debug - è°ƒè¯•ä¿¡æ¯
logger.Debug("æŸ¥è¯¢å‚æ•°", 
	zap.String("filter", filter), 
	zap.Int("page", page))

// Info - æ­£å¸¸ä¸šåŠ¡
logger.Info("ç§Ÿæˆ·ç™»å½•", 
	zap.String("phone", req.Phone), 
	zap.String("tenant_code", req.TenantCode))

// Warn - å¯æ¢å¤çš„é—®é¢˜
logger.Warn("æ— æ³•è¿æ¥ Consulï¼Œä½¿ç”¨é»˜è®¤é…ç½®", zap.Error(err))

// Error - éœ€è¦å…³æ³¨çš„é”™è¯¯
logger.Error("æŸ¥è¯¢ç§Ÿæˆ·ç”¨æˆ·å¤±è´¥", zap.Error(err))

// Fatal - è‡´å‘½é”™è¯¯ï¼ˆä¼šç»ˆæ­¢ç¨‹åºï¼‰
logger.Fatal("åˆå§‹åŒ–MongoDBå¤±è´¥", zap.Error(err))
```

---

## ğŸ¯ ç»“æ„åŒ–æ—¥å¿— vs æ ¼å¼åŒ–æ—¥å¿—

### ç»“æ„åŒ–æ—¥å¿—ï¼ˆæ¨èï¼‰

**ä¼˜ç‚¹**ï¼š
- âœ… æ€§èƒ½æ›´å¥½ï¼ˆæ— éœ€å­—ç¬¦ä¸²æ ¼å¼åŒ–ï¼‰
- âœ… æ˜“äºè§£æå’Œæœç´¢ï¼ˆJSONæ ¼å¼ï¼‰
- âœ… ç±»å‹å®‰å…¨

```go
// âœ… æ¨è
logger.Info("ç”¨æˆ·ç™»å½•", 
	zap.String("user_id", "123"), 
	zap.String("tenant_code", "default"),
	zap.Duration("duration", time.Since(start)))

// è¾“å‡ºï¼ˆJSONæ ¼å¼ï¼‰ï¼š
// {"time":"2025-01-08T10:00:00","level":"INFO","msg":"ç”¨æˆ·ç™»å½•","user_id":"123","tenant_code":"default","duration":0.5}
```

### æ ¼å¼åŒ–æ—¥å¿—ï¼ˆç®€å•åœºæ™¯ï¼‰

**ä½¿ç”¨åœºæ™¯**ï¼šç®€å•çš„å•è¡Œæ—¥å¿—ï¼Œä¸éœ€è¦è§£æ

```go
// âœ… ç®€å•åœºæ™¯å¯ç”¨
logger.Infof("ç”¨æˆ· %s ç™»å½•æˆåŠŸ", phone)
logger.Warnf("é…ç½®é¡¹ %s ç¼ºå¤±ï¼Œä½¿ç”¨é»˜è®¤å€¼: %v", key, defaultValue)

// è¾“å‡ºï¼š
// 2025-01-08 10:00:00  INFO  ç”¨æˆ· 13800138000 ç™»å½•æˆåŠŸ
```

---

## ğŸ”§ å¸¸ç”¨ Zap Field ç±»å‹

```go
// å­—ç¬¦ä¸²
zap.String("key", "value")

// æ•°å­—
zap.Int("count", 10)
zap.Int64("id", 123456789)
zap.Float64("price", 99.99)

// å¸ƒå°”å€¼
zap.Bool("is_active", true)

// é”™è¯¯
zap.Error(err)

// æ—¶é—´å’ŒæŒç»­æ—¶é—´
zap.Time("created_at", time.Now())
zap.Duration("latency", time.Since(start))

// æ•°ç»„
zap.Strings("roles", []string{"admin", "user"})
zap.Ints("ids", []int{1, 2, 3})

// ä»»æ„å¯¹è±¡ï¼ˆä¼šåºåˆ—åŒ–ä¸ºJSONï¼‰
zap.Any("user", userObject)
```

---

## ğŸ“– å®Œæ•´ç¤ºä¾‹

### ç™»å½•æµç¨‹æ—¥å¿—

```go
func (s *AuthService) Login(req dto.LoginRequest) (*dto.LoginResponse, error) {
	// 1. å¼€å§‹ç™»å½•
	logger.Info("ç§Ÿæˆ·ç™»å½•", 
		zap.String("phone", req.Phone), 
		zap.String("tenant_code", req.TenantCode))

	// 2. æŸ¥è¯¢ç§Ÿæˆ·
	tenant, err := s.tenantRepo.GetByCode(ctx, req.TenantCode)
	if err != nil || tenant == nil {
		logger.Warn("ç§Ÿæˆ·ä¸å­˜åœ¨", zap.String("tenant_code", req.TenantCode))
		return nil, fmt.Errorf("ç§Ÿæˆ·ä¸å­˜åœ¨æˆ–å·²ç¦ç”¨")
	}

	logger.Info("æ‰¾åˆ°ç§Ÿæˆ·", 
		zap.String("id", tenant.ID), 
		zap.String("code", tenant.Code), 
		zap.String("name", tenant.Name))

	// 3. æŸ¥è¯¢ç”¨æˆ·
	admin, err = s.repo.GetByPhone(ctx, req.Phone)
	if err != nil {
		logger.Error("æŸ¥è¯¢ç§Ÿæˆ·ç”¨æˆ·å¤±è´¥", zap.Error(err))
		return nil, fmt.Errorf("æŸ¥è¯¢ç”¨æˆ·å¤±è´¥: %w", err)
	}

	if admin == nil {
		logger.Warn("ç”¨æˆ·ä¸å­˜åœ¨", zap.String("phone", req.Phone))
		return nil, ErrUserNotFound
	}

	logger.Info("æ‰¾åˆ°ç”¨æˆ·", 
		zap.String("id", admin.ID), 
		zap.String("nickname", admin.Nickname), 
		zap.Strings("roles", admin.Roles))

	// 4. ç”ŸæˆToken
	token, err := s.jwtManager.GenerateToken(...)
	if err != nil {
		logger.Error("ç”Ÿæˆtokenå¤±è´¥", zap.Error(err))
		return nil, err
	}

	logger.Info("ç™»å½•æˆåŠŸ", 
		zap.String("user_id", admin.ID),
		zap.String("tenant_code", tenant.Code))

	return &dto.LoginResponse{...}, nil
}
```

### ä¸­é—´ä»¶æ—¥å¿—

```go
func TenantContextMiddleware() gin.HandlerFunc {
	return func(c *gin.Context) {
		tenantID := c.GetHeader("X-Tenant-Context")
		
		if tenantID != "" {
			logger.Debug("ç³»ç»Ÿç®¡ç†å‘˜åˆ‡æ¢ç§Ÿæˆ·ä¸Šä¸‹æ–‡", 
				zap.String("tenant_id", tenantID),
				zap.String("path", c.Request.URL.Path))
			
			ctx := c.Request.Context()
			ctx = tenantCtx.WithTenantID(ctx, tenantID)
			c.Request = c.Request.WithContext(ctx)
		}
		
		c.Next()
	}
}
```

### æ€§èƒ½ç›‘æ§æ—¥å¿—

```go
func (s *Service) ProcessOrder(orderID string) error {
	start := time.Now()
	
	logger.Info("å¼€å§‹å¤„ç†è®¢å•", zap.String("order_id", orderID))
	
	// å¤„ç†é€»è¾‘...
	
	duration := time.Since(start)
	logger.Info("è®¢å•å¤„ç†å®Œæˆ", 
		zap.String("order_id", orderID),
		zap.Duration("duration", duration))
	
	if duration > 5*time.Second {
		logger.Warn("è®¢å•å¤„ç†è€—æ—¶è¿‡é•¿", 
			zap.String("order_id", orderID),
			zap.Duration("duration", duration))
	}
	
	return nil
}
```

---

## âš™ï¸ é…ç½®

æ—¥å¿—é…ç½®åœ¨ `config/xxx.yaml` ä¸­ï¼š

```yaml
log:
  level: "info"        # debug, info, warn, error, fatal
  format: "console"    # consoleï¼ˆå½©è‰²ï¼‰æˆ– json
  output: "stdout"     # stdoutï¼ˆæ ‡å‡†è¾“å‡ºï¼‰æˆ– fileï¼ˆæ–‡ä»¶ï¼‰
  file_path: "logs/auth.log"  # å½“ output=file æ—¶ç”Ÿæ•ˆ
  max_size: 100        # å•ä¸ªæ—¥å¿—æ–‡ä»¶æœ€å¤§å¤§å°ï¼ˆMBï¼‰
  max_backups: 3       # ä¿ç•™æ—§æ–‡ä»¶æ•°é‡
  max_age: 7           # ä¿ç•™å¤©æ•°
  compress: true       # æ˜¯å¦å‹ç¼©æ—§æ–‡ä»¶
```

### å¼€å‘ç¯å¢ƒé…ç½®ï¼ˆæ¨èï¼‰

```yaml
log:
  level: "debug"
  format: "console"
  output: "stdout"
```

### ç”Ÿäº§ç¯å¢ƒé…ç½®ï¼ˆæ¨èï¼‰

```yaml
log:
  level: "info"
  format: "json"
  output: "file"
  file_path: "/var/log/mule-cloud/auth.log"
  max_size: 100
  max_backups: 10
  max_age: 30
  compress: true
```

---

## ğŸ¨ æ—¥å¿—æ ¼å¼

### Console æ ¼å¼ï¼ˆå½©è‰²ï¼Œé€‚åˆå¼€å‘ï¼‰

```
2025-01-08 10:00:00  INFO  ç”¨æˆ·ç™»å½•  {"phone": "13800138000", "tenant_code": "default"}
2025-01-08 10:00:01  WARN  ç§Ÿæˆ·ä¸å­˜åœ¨  {"tenant_code": "invalid"}
2025-01-08 10:00:02  ERROR æŸ¥è¯¢å¤±è´¥  {"error": "connection timeout"}
```

### JSON æ ¼å¼ï¼ˆé€‚åˆç”Ÿäº§ï¼Œä¾¿äºæ—¥å¿—åˆ†æï¼‰

```json
{"time":"2025-01-08T10:00:00","level":"INFO","msg":"ç”¨æˆ·ç™»å½•","phone":"13800138000","tenant_code":"default"}
{"time":"2025-01-08T10:00:01","level":"WARN","msg":"ç§Ÿæˆ·ä¸å­˜åœ¨","tenant_code":"invalid"}
{"time":"2025-01-08T10:00:02","level":"ERROR","msg":"æŸ¥è¯¢å¤±è´¥","error":"connection timeout"}
```

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. æ—¥å¿—çº§åˆ«é€‰æ‹©

```go
// âœ… æ­£ç¡®
logger.Debug("è°ƒè¯•ä¿¡æ¯", zap.Any("data", data))  // ä»…å¼€å‘ç¯å¢ƒ
logger.Info("ç”¨æˆ·ç™»å½•", zap.String("user_id", id))  // æ­£å¸¸ä¸šåŠ¡
logger.Warn("é…ç½®ç¼ºå¤±ï¼Œä½¿ç”¨é»˜è®¤å€¼", zap.String("key", key))  // å¯æ¢å¤
logger.Error("æ•°æ®åº“æŸ¥è¯¢å¤±è´¥", zap.Error(err))  // éœ€è¦å…³æ³¨

// âŒ é”™è¯¯
logger.Info("æ•°æ®åº“è¿æ¥å¤±è´¥")  // åº”è¯¥ç”¨ Error
logger.Error("ç”¨æˆ·ç™»å½•æˆåŠŸ")  // åº”è¯¥ç”¨ Info
```

### 2. é”™è¯¯å¤„ç†

```go
// âœ… æ¨èï¼šè®°å½•é”™è¯¯å¹¶è¿”å›
admin, err := s.repo.GetByPhone(ctx, req.Phone)
if err != nil {
	logger.Error("æŸ¥è¯¢ç”¨æˆ·å¤±è´¥", 
		zap.String("phone", req.Phone), 
		zap.Error(err))
	return nil, fmt.Errorf("æŸ¥è¯¢ç”¨æˆ·å¤±è´¥: %w", err)
}

// âŒ ä¸æ¨èï¼šåªæ‰“å°ä¸è¿”å›
if err != nil {
	logger.Error("æŸ¥è¯¢ç”¨æˆ·å¤±è´¥", zap.Error(err))
	// ç»§ç»­æ‰§è¡Œï¼Ÿï¼Ÿï¼Ÿ
}
```

### 3. æ•æ„Ÿä¿¡æ¯ä¿æŠ¤

```go
// âœ… æ­£ç¡®ï¼šä¸è®°å½•å¯†ç 
logger.Info("ç”¨æˆ·ç™»å½•", zap.String("phone", req.Phone))

// âŒ é”™è¯¯ï¼šè®°å½•äº†å¯†ç 
logger.Info("ç”¨æˆ·ç™»å½•", 
	zap.String("phone", req.Phone), 
	zap.String("password", req.Password))  // æ•æ„Ÿä¿¡æ¯æ³„éœ²ï¼

// âœ… æ­£ç¡®ï¼šè„±æ•å¤„ç†
logger.Debug("è¯·æ±‚æ•°æ®", 
	zap.String("phone", maskPhone(req.Phone)),  // 138****8000
	zap.String("id_card", maskIDCard(req.IDCard)))  // 330***********1234
```

### 4. æ€§èƒ½è€ƒè™‘

```go
// âœ… æ­£ç¡®ï¼šDebug æ—¥å¿—åœ¨ç”Ÿäº§ç¯å¢ƒä¸ä¼šæ‰§è¡Œ
logger.Debug("è¯¦ç»†è°ƒè¯•ä¿¡æ¯", zap.Any("large_object", obj))

// âŒ é”™è¯¯ï¼šå³ä½¿ä¸è¾“å‡ºä¹Ÿä¼šæ ¼å¼åŒ–å­—ç¬¦ä¸²
logger.Infof("ç”¨æˆ·: %v", expensiveFunction())  // expensiveFunction æ€»æ˜¯ä¼šæ‰§è¡Œ

// âœ… æ­£ç¡®ï¼šå…ˆæ£€æŸ¥æ—¥å¿—çº§åˆ«
if logger.Logger.Core().Enabled(zapcore.DebugLevel) {
	logger.Debug("è¯¦ç»†è°ƒè¯•ä¿¡æ¯", zap.Any("data", expensiveFunction()))
}
```

### 5. ä¸Šä¸‹æ–‡å…³è”

```go
// âœ… æ¨èï¼šä½¿ç”¨ With åˆ›å»ºå¸¦ä¸Šä¸‹æ–‡çš„ logger
func (s *Service) ProcessRequest(ctx context.Context, req Request) {
	log := logger.With(
		zap.String("request_id", req.ID),
		zap.String("user_id", getUserID(ctx)),
	)
	
	log.Info("å¼€å§‹å¤„ç†è¯·æ±‚")
	// ... ä¸šåŠ¡é€»è¾‘
	log.Info("è¯·æ±‚å¤„ç†å®Œæˆ")
	
	// æ‰€æœ‰æ—¥å¿—éƒ½ä¼šè‡ªåŠ¨åŒ…å« request_id å’Œ user_id
}
```

---

## ğŸ” æ—¥å¿—æŸ¥è¯¢å’Œåˆ†æ

### 1. å®æ—¶æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹æœ€æ–°æ—¥å¿—
tail -f logs/auth.log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f logs/auth.log | grep ERROR

# æŸ¥çœ‹ç‰¹å®šç”¨æˆ·çš„æ—¥å¿—
tail -f logs/auth.log | grep "user_id\":\"123"
```

### 2. JSON æ—¥å¿—è§£æï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

```bash
# ä½¿ç”¨ jq è§£æ JSON æ—¥å¿—
tail -f logs/auth.log | jq '.'

# åªæ˜¾ç¤ºé”™è¯¯æ—¥å¿—
tail -f logs/auth.log | jq 'select(.level == "ERROR")'

# ç»Ÿè®¡é”™è¯¯ç±»å‹
cat logs/auth.log | jq 'select(.level == "ERROR") | .msg' | sort | uniq -c
```

### 3. é›†æˆæ—¥å¿—å¹³å°

æ¨èé›†æˆ ELK (Elasticsearch + Logstash + Kibana) æˆ– Loki + Grafanaï¼š

```yaml
# filebeat.ymlï¼ˆæ”¶é›†æ—¥å¿—ï¼‰
filebeat.inputs:
  - type: log
    enabled: true
    paths:
      - /var/log/mule-cloud/*.log
    json.keys_under_root: true
    json.add_error_key: true

output.elasticsearch:
  hosts: ["localhost:9200"]
```

---

## ğŸ‰ è¿ç§»æŒ‡å—

### ä» fmt.Printf / log.Printf è¿ç§»

```go
// âŒ æ—§ä»£ç 
fmt.Printf("[ç™»å½•] ç§Ÿæˆ·ç™»å½•: æ‰‹æœºå·=%s, ç§Ÿæˆ·ä»£ç =%s\n", req.Phone, req.TenantCode)
log.Printf("è­¦å‘Š: è·å–è§’è‰² %s èœå•å¤±è´¥: %v", roleID, err)

// âœ… æ–°ä»£ç 
logger.Info("ç§Ÿæˆ·ç™»å½•", 
	zap.String("phone", req.Phone), 
	zap.String("tenant_code", req.TenantCode))
logger.Warn("è·å–è§’è‰²èœå•å¤±è´¥", 
	zap.String("role_id", roleID), 
	zap.Error(err))
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [Uber Zap å®˜æ–¹æ–‡æ¡£](https://pkg.go.dev/go.uber.org/zap)
- [é¡¹ç›®æ—¥å¿—é…ç½®](../config/)
- [æ—¥å¿—ç³»ç»Ÿå®ç°](../core/logger/logger.go)

---

**ç°åœ¨å¼€å§‹ä½¿ç”¨ç»Ÿä¸€çš„æ—¥å¿—ç³»ç»Ÿï¼Œè®©æ—¥å¿—æ›´æ¸…æ™°ã€æ›´æ˜“åˆ†æï¼** ğŸŠ
