# å¾®ä¿¡å°ç¨‹åºå¤šç§Ÿæˆ·ç”¨æˆ·ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ

## ğŸ“‹ ç›®å½•
- [ä¸€ã€èƒŒæ™¯ä¸æŒ‘æˆ˜](#ä¸€èƒŒæ™¯ä¸æŒ‘æˆ˜)
- [äºŒã€æ¶æ„è®¾è®¡æ–¹æ¡ˆ](#äºŒæ¶æ„è®¾è®¡æ–¹æ¡ˆ)
- [ä¸‰ã€æ•°æ®æ¨¡å‹è®¾è®¡](#ä¸‰æ•°æ®æ¨¡å‹è®¾è®¡)
- [å››ã€ç™»å½•æµç¨‹è®¾è®¡](#å››ç™»å½•æµç¨‹è®¾è®¡)
- [äº”ã€ç§Ÿæˆ·åˆ‡æ¢æ–¹æ¡ˆ](#äº”ç§Ÿæˆ·åˆ‡æ¢æ–¹æ¡ˆ)
- [å…­ã€æ ¸å¿ƒåŠŸèƒ½å®ç°](#å…­æ ¸å¿ƒåŠŸèƒ½å®ç°)
- [ä¸ƒã€å®‰å…¨ä¸æƒé™æ§åˆ¶](#ä¸ƒå®‰å…¨ä¸æƒé™æ§åˆ¶)
- [å…«ã€å®æ–½æ­¥éª¤](#å…«å®æ–½æ­¥éª¤)

---

## ä¸€ã€èƒŒæ™¯ä¸æŒ‘æˆ˜

### 1.1 ä¸šåŠ¡åœºæ™¯
- **è¡Œä¸šç‰¹æ€§**ï¼šä¸­å°å‹æœè£…å·¥å‚ï¼Œå‘˜å·¥æµåŠ¨æ€§å¤§
- **ä½¿ç”¨åœºæ™¯**ï¼šå‘˜å·¥ä¸»è¦ä½¿ç”¨å¾®ä¿¡å°ç¨‹åºè¿›è¡Œæ—¥å¸¸æ“ä½œ
- **æ ¸å¿ƒç—›ç‚¹**ï¼šå‘˜å·¥ä»å·¥å‚Aç¦»èŒåï¼Œå¯èƒ½å…¥èŒå·¥å‚Bï¼ˆä¹Ÿä½¿ç”¨æœ¬ç³»ç»Ÿï¼‰

### 1.2 æ ¸å¿ƒæŒ‘æˆ˜

#### æŒ‘æˆ˜1ï¼šç”¨æˆ·çš„å…¨å±€å”¯ä¸€æ€§
- âœ… åŒä¸€ä¸ªå¾®ä¿¡ç”¨æˆ·å¯èƒ½åœ¨å¤šä¸ªç§Ÿæˆ·ï¼ˆå·¥å‚ï¼‰ä¸­å·¥ä½œ
- âœ… ç”¨æˆ·çš„åŸºç¡€ä¿¡æ¯åº”è¯¥å…¨å±€å”¯ä¸€ï¼ˆå¦‚å¾®ä¿¡UnionIDï¼‰
- âœ… ä½†ç”¨æˆ·åœ¨ä¸åŒç§Ÿæˆ·ä¸­çš„è§’è‰²ã€æƒé™ã€ä¸šåŠ¡æ•°æ®åº”è¯¥éš”ç¦»

#### æŒ‘æˆ˜2ï¼šäººå‘˜æµåŠ¨ç®¡ç†
- âœ… å‘˜å·¥ç¦»èŒåï¼Œå¦‚ä½•å¤„ç†å…¶åœ¨åŸç§Ÿæˆ·ä¸­çš„æ•°æ®ï¼Ÿ
- âœ… å‘˜å·¥å…¥èŒæ–°ç§Ÿæˆ·æ—¶ï¼Œå¦‚ä½•å¿«é€Ÿå…³è”å·²æœ‰çš„å¾®ä¿¡è´¦å·ï¼Ÿ
- âœ… å¦‚ä½•é¿å…é‡å¤æ³¨å†Œå’Œæ•°æ®å†—ä½™ï¼Ÿ

#### æŒ‘æˆ˜3ï¼šå¾®ä¿¡ç™»å½•ç‰¹æ€§
- âœ… å¾®ä¿¡UnionIDï¼šåŒä¸€å¾®ä¿¡å¼€æ”¾å¹³å°ä¸‹çš„å”¯ä¸€æ ‡è¯†
- âœ… å¾®ä¿¡OpenIDï¼šåŒä¸€å°ç¨‹åºä¸‹çš„å”¯ä¸€æ ‡è¯†
- âœ… æ‰‹æœºå·æˆæƒï¼šç”¨æˆ·å¯èƒ½æ‹’ç»æˆæƒæ‰‹æœºå·
- âœ… ç”¨æˆ·ä¿¡æ¯æ›´æ–°ï¼šå¾®ä¿¡å¤´åƒã€æ˜µç§°å¯èƒ½å˜åŒ–

---

## äºŒã€æ¶æ„è®¾è®¡æ–¹æ¡ˆ

### 2.1 æ•´ä½“æ¶æ„

é‡‡ç”¨ **"å…¨å±€ç”¨æˆ· + ç§Ÿæˆ·æˆå‘˜"åŒè¡¨æ¨¡å‹**ï¼Œä¿æŒç°æœ‰çš„æ•°æ®åº“ç‰©ç†éš”ç¦»æ¶æ„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç³»ç»Ÿåº“ (tenant_system)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“¦ tenant              ç§Ÿæˆ·è¡¨                   â”‚
â”‚  ğŸ“¦ wechat_user         å…¨å±€å¾®ä¿¡ç”¨æˆ·è¡¨ â† æ–°å¢   â”‚
â”‚  ğŸ“¦ user_tenant_map     ç”¨æˆ·ç§Ÿæˆ·æ˜ å°„è¡¨ â† æ–°å¢   â”‚
â”‚  ğŸ“¦ admin               ç³»ç»Ÿç®¡ç†å‘˜               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“ ä¸€ä¸ªç”¨æˆ·å¯ä»¥å±äºå¤šä¸ªç§Ÿæˆ·
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç§Ÿæˆ·åº“ A (tenant_ace)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“¦ member              ç§Ÿæˆ·æˆå‘˜è¡¨ â† æ”¹é€        â”‚
â”‚  ğŸ“¦ role                è§’è‰²è¡¨                   â”‚
â”‚  ğŸ“¦ order               è®¢å•è¡¨                   â”‚
â”‚  â””â”€ ... å…¶ä»–ä¸šåŠ¡æ•°æ®                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç§Ÿæˆ·åº“ B (tenant_factory_b)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“¦ member              ç§Ÿæˆ·æˆå‘˜è¡¨               â”‚
â”‚  â””â”€ ... ä¸šåŠ¡æ•°æ®                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 è®¾è®¡åŸåˆ™

1. **ç”¨æˆ·å…¨å±€å”¯ä¸€**ï¼šå¾®ä¿¡UnionIDä½œä¸ºå…¨å±€ç”¨æˆ·å”¯ä¸€æ ‡è¯†
2. **ç§Ÿæˆ·æ•°æ®éš”ç¦»**ï¼šä¸šåŠ¡æ•°æ®ä»ç„¶å­˜å‚¨åœ¨å„ç§Ÿæˆ·ç‹¬ç«‹æ•°æ®åº“ä¸­
3. **çµæ´»çš„å…³è”å…³ç³»**ï¼šæ”¯æŒä¸€ä¸ªç”¨æˆ·åœ¨å¤šä¸ªç§Ÿæˆ·ä¸­æ‹¥æœ‰ä¸åŒè§’è‰²
4. **å‘ä¸‹å…¼å®¹**ï¼šä¿æŒç°æœ‰ç³»ç»Ÿç®¡ç†å‘˜ï¼ˆAdminï¼‰ç™»å½•æ–¹å¼ä¸å˜

---

## ä¸‰ã€æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 ç³»ç»Ÿåº“æ¨¡å‹

#### 3.1.1 WechatUserï¼ˆå…¨å±€å¾®ä¿¡ç”¨æˆ·è¡¨ï¼‰

å­˜å‚¨ä½ç½®ï¼š`tenant_system.wechat_user`

```go
// WechatUser å…¨å±€å¾®ä¿¡ç”¨æˆ·ï¼ˆå­˜å‚¨åœ¨ç³»ç»Ÿåº“ï¼‰
type WechatUser struct {
    ID          string `json:"id" bson:"_id,omitempty"`          // MongoDB ObjectID
    UnionID     string `json:"union_id" bson:"union_id"`         // å¾®ä¿¡UnionIDï¼ˆå…¨å±€å”¯ä¸€ï¼‰
    Phone       string `json:"phone" bson:"phone"`               // æ‰‹æœºå·ï¼ˆå¯èƒ½ä¸ºç©ºï¼‰
    Nickname    string `json:"nickname" bson:"nickname"`         // å¾®ä¿¡æ˜µç§°
    Avatar      string `json:"avatar" bson:"avatar"`             // å¾®ä¿¡å¤´åƒ
    Gender      int    `json:"gender" bson:"gender"`             // æ€§åˆ«ï¼š0-æœªçŸ¥ 1-ç”· 2-å¥³
    Country     string `json:"country" bson:"country"`           // å›½å®¶
    Province    string `json:"province" bson:"province"`         // çœä»½
    City        string `json:"city" bson:"city"`                 // åŸå¸‚
    Language    string `json:"language" bson:"language"`         // è¯­è¨€
    
    // å¤šç§Ÿæˆ·å…³è”ï¼ˆä»…ç”¨äºå¿«é€ŸæŸ¥è¯¢ï¼‰
    TenantIDs   []string `json:"tenant_ids" bson:"tenant_ids"`   // ç”¨æˆ·å…³è”çš„ç§Ÿæˆ·IDåˆ—è¡¨
    
    // ç³»ç»Ÿå­—æ®µ
    Status      int    `json:"status" bson:"status"`             // çŠ¶æ€ï¼š1-æ­£å¸¸ 0-ç¦ç”¨
    IsDeleted   int    `json:"is_deleted" bson:"is_deleted"`     // æ˜¯å¦åˆ é™¤
    CreatedAt   int64  `json:"created_at" bson:"created_at"`     // åˆ›å»ºæ—¶é—´
    UpdatedAt   int64  `json:"updated_at" bson:"updated_at"`     // æ›´æ–°æ—¶é—´
    LastLoginAt int64  `json:"last_login_at" bson:"last_login_at"` // æœ€åç™»å½•æ—¶é—´
}

// ç´¢å¼•
// - union_id: å”¯ä¸€ç´¢å¼•
// - phone: å”¯ä¸€ç´¢å¼•ï¼ˆç¨€ç–ç´¢å¼•ï¼Œå…è®¸nullï¼‰
// - tenant_ids: æ•°ç»„ç´¢å¼•ï¼ˆå¿«é€ŸæŸ¥è¯¢ç”¨æˆ·å±äºå“ªäº›ç§Ÿæˆ·ï¼‰
```

#### 3.1.2 UserTenantMapï¼ˆç”¨æˆ·ç§Ÿæˆ·æ˜ å°„è¡¨ï¼‰

å­˜å‚¨ä½ç½®ï¼š`tenant_system.user_tenant_map`

```go
// UserTenantMap ç”¨æˆ·-ç§Ÿæˆ·å…³ç³»æ˜ å°„è¡¨ï¼ˆå­˜å‚¨åœ¨ç³»ç»Ÿåº“ï¼‰
type UserTenantMap struct {
    ID          string `json:"id" bson:"_id,omitempty"`        // MongoDB ObjectID
    UserID      string `json:"user_id" bson:"user_id"`         // å¾®ä¿¡ç”¨æˆ·IDï¼ˆWechatUser._idï¼‰
    UnionID     string `json:"union_id" bson:"union_id"`       // å†—ä½™å­—æ®µï¼Œä¾¿äºæŸ¥è¯¢
    TenantID    string `json:"tenant_id" bson:"tenant_id"`     // ç§Ÿæˆ·ID
    TenantCode  string `json:"tenant_code" bson:"tenant_code"` // ç§Ÿæˆ·ä»£ç 
    MemberID    string `json:"member_id" bson:"member_id"`     // åœ¨ç§Ÿæˆ·åº“ä¸­çš„æˆå‘˜ID
    
    // å…³ç³»çŠ¶æ€
    Status      string `json:"status" bson:"status"`           // çŠ¶æ€ï¼šactive-åœ¨èŒ inactive-ç¦»èŒ pending-å¾…å®¡æ ¸
    JoinedAt    int64  `json:"joined_at" bson:"joined_at"`     // åŠ å…¥æ—¶é—´
    LeftAt      int64  `json:"left_at" bson:"left_at"`         // ç¦»èŒæ—¶é—´ï¼ˆå¦‚æœå·²ç¦»èŒï¼‰
    
    // ç³»ç»Ÿå­—æ®µ
    IsDeleted   int   `json:"is_deleted" bson:"is_deleted"`    // è½¯åˆ é™¤
    CreatedAt   int64 `json:"created_at" bson:"created_at"`
    UpdatedAt   int64 `json:"updated_at" bson:"updated_at"`
}

// ç´¢å¼•
// - user_id + tenant_id: è”åˆå”¯ä¸€ç´¢å¼•
// - union_id + status: ç»„åˆç´¢å¼•ï¼ˆæŸ¥è¯¢ç”¨æˆ·æ‰€æœ‰åœ¨èŒç§Ÿæˆ·ï¼‰
// - tenant_id + status: ç»„åˆç´¢å¼•ï¼ˆæŸ¥è¯¢ç§Ÿæˆ·æ‰€æœ‰åœ¨èŒæˆå‘˜ï¼‰
```

### 3.2 ç§Ÿæˆ·åº“æ¨¡å‹

#### 3.2.1 TenantMemberï¼ˆç§Ÿæˆ·æˆå‘˜è¡¨ï¼‰

å­˜å‚¨ä½ç½®ï¼š`tenant_xxx.member`ï¼ˆåŸadminè¡¨æ”¹é€ ï¼‰

```go
// TenantMember ç§Ÿæˆ·æˆå‘˜ï¼ˆå­˜å‚¨åœ¨å„ç§Ÿæˆ·åº“ä¸­ï¼‰
type TenantMember struct {
    ID          string   `json:"id" bson:"_id,omitempty"`      // MongoDB ObjectID
    
    // å…³è”å…¨å±€ç”¨æˆ·
    UnionID     string   `json:"union_id" bson:"union_id"`     // å¾®ä¿¡UnionIDï¼ˆå…³è”å…¨å±€ç”¨æˆ·ï¼‰
    UserID      string   `json:"user_id" bson:"user_id"`       // å…¨å±€ç”¨æˆ·IDï¼ˆWechatUser._idï¼‰
    
    // ç§Ÿæˆ·å†…ä¿¡æ¯ï¼ˆå¯è¢«ç§Ÿæˆ·ç®¡ç†å‘˜ä¿®æ”¹ï¼‰
    Name        string   `json:"name" bson:"name"`             // å‘˜å·¥å§“åï¼ˆåœ¨æœ¬ç§Ÿæˆ·çš„ç§°å‘¼ï¼‰
    JobNumber   string   `json:"job_number" bson:"job_number"` // å·¥å·
    Department  string   `json:"department" bson:"department"` // éƒ¨é—¨
    Position    string   `json:"position" bson:"position"`     // å²—ä½
    Phone       string   `json:"phone" bson:"phone"`           // è”ç³»ç”µè¯ï¼ˆå†—ä½™ï¼‰
    
    // æƒé™ä¸è§’è‰²
    Roles       []string `json:"role" bson:"role"`             // è§’è‰²IDæ•°ç»„
    Permissions []string `json:"permissions" bson:"permissions"` // é¢å¤–æƒé™
    
    // çŠ¶æ€
    Status      string   `json:"status" bson:"status"`         // çŠ¶æ€ï¼šactive-åœ¨èŒ inactive-ç¦»èŒ
    EmployedAt  int64    `json:"employed_at" bson:"employed_at"`  // å…¥èŒæ—¶é—´
    LeftAt      int64    `json:"left_at" bson:"left_at"`       // ç¦»èŒæ—¶é—´
    
    // ç³»ç»Ÿå­—æ®µ
    IsDeleted   int      `json:"is_deleted" bson:"is_deleted"`
    CreatedBy   string   `json:"created_by" bson:"created_by"`
    UpdatedBy   string   `json:"updated_by" bson:"updated_by"`
    CreatedAt   int64    `json:"created_at" bson:"created_at"`
    UpdatedAt   int64    `json:"updated_at" bson:"updated_at"`
}

// ç´¢å¼•
// - union_id: å”¯ä¸€ç´¢å¼•
// - job_number: å”¯ä¸€ç´¢å¼•ï¼ˆå¦‚æœä½¿ç”¨ï¼‰
// - status + is_deleted: ç»„åˆç´¢å¼•ï¼ˆæŸ¥è¯¢åœ¨èŒå‘˜å·¥ï¼‰
```

---

## å››ã€ç™»å½•æµç¨‹è®¾è®¡

### 4.1 å¾®ä¿¡å°ç¨‹åºç™»å½•æµç¨‹

```mermaid
sequenceDiagram
    participant MP as å¾®ä¿¡å°ç¨‹åº
    participant Backend as åç«¯API
    participant WeChat as å¾®ä¿¡æœåŠ¡å™¨
    participant SysDB as ç³»ç»Ÿåº“
    participant TenantDB as ç§Ÿæˆ·åº“

    MP->>WeChat: 1. wx.login() è·å–code
    WeChat-->>MP: code
    MP->>Backend: 2. POST /api/auth/wechat/login {code}
    Backend->>WeChat: 3. codeæ¢å–session_key & openid
    WeChat-->>Backend: {session_key, openid, unionid}
    
    Backend->>SysDB: 4. æŸ¥è¯¢WechatUser by unionid
    
    alt ç”¨æˆ·ä¸å­˜åœ¨
        Backend->>SysDB: 5. åˆ›å»ºWechatUser
    else ç”¨æˆ·å·²å­˜åœ¨
        Backend->>SysDB: 6. æ›´æ–°æœ€åç™»å½•æ—¶é—´
    end
    
    Backend->>SysDB: 7. æŸ¥è¯¢UserTenantMapï¼ˆç”¨æˆ·å…³è”çš„ç§Ÿæˆ·ï¼‰
    
    alt ç”¨æˆ·åªå±äºä¸€ä¸ªç§Ÿæˆ·
        Backend->>TenantDB: 8. æŸ¥è¯¢TenantMemberï¼ˆè·å–è§’è‰²ï¼‰
        Backend->>Backend: 9. ç”ŸæˆJWTï¼ˆåŒ…å«ç§Ÿæˆ·ä¿¡æ¯ï¼‰
        Backend-->>MP: {token, user_info, tenant_info}
    else ç”¨æˆ·å±äºå¤šä¸ªç§Ÿæˆ·
        Backend-->>MP: {need_select_tenant, tenants: [...]}
        MP->>Backend: 10. POST /api/auth/select-tenant {tenant_id}
        Backend->>TenantDB: 11. æŸ¥è¯¢TenantMember
        Backend->>Backend: 12. ç”ŸæˆJWT
        Backend-->>MP: {token, user_info, tenant_info}
    else ç”¨æˆ·ä¸å±äºä»»ä½•ç§Ÿæˆ·
        Backend-->>MP: {need_bind_tenant, user_info}
        Note over MP: å¼•å¯¼ç”¨æˆ·è¾“å…¥ç§Ÿæˆ·é‚€è¯·ç 
    end
```

### 4.2 é¦–æ¬¡ç™»å½•-ç»‘å®šç§Ÿæˆ·æµç¨‹

```
ç”¨æˆ·é¦–æ¬¡ç™»å½• â†’ å¾®ä¿¡æˆæƒ â†’ åˆ›å»ºå…¨å±€ç”¨æˆ·
    â†“
ç”¨æˆ·è¾“å…¥ç§Ÿæˆ·é‚€è¯·ç  â†’ éªŒè¯é‚€è¯·ç 
    â†“
åœ¨ç§Ÿæˆ·åº“åˆ›å»ºMemberè®°å½• â†’ åœ¨ç³»ç»Ÿåº“åˆ›å»ºUserTenantMap
    â†“
ç”ŸæˆJWT Token â†’ ç™»å½•æˆåŠŸ
```

### 4.3 å‘˜å·¥ç¦»èŒ-å…¥èŒæ–°ç§Ÿæˆ·æµç¨‹

```
å‘˜å·¥åœ¨ç§Ÿæˆ·Aç¦»èŒ
    â†“
æ›´æ–° UserTenantMap.status = 'inactive'
æ›´æ–° TenantMember.status = 'inactive'
    â†“
å‘˜å·¥å…¥èŒç§Ÿæˆ·B
    â†“
ä½¿ç”¨ç›¸åŒå¾®ä¿¡è´¦å·ç™»å½• â†’ æ£€æµ‹åˆ°å·²æœ‰WechatUser
    â†“
è¾“å…¥ç§Ÿæˆ·Bé‚€è¯·ç  â†’ åœ¨ç§Ÿæˆ·Båˆ›å»ºæ–°çš„Memberè®°å½•
    â†“
åˆ›å»ºæ–°çš„UserTenantMapå…³è”ï¼ˆstatus='active'ï¼‰
    â†“
ç”¨æˆ·ç°åœ¨å¯ä»¥åœ¨ç§Ÿæˆ·Aï¼ˆå·²ç¦»èŒï¼‰å’Œç§Ÿæˆ·Bï¼ˆåœ¨èŒï¼‰é—´åˆ‡æ¢æŸ¥çœ‹
```

---

## äº”ã€ç§Ÿæˆ·åˆ‡æ¢æ–¹æ¡ˆ

### 5.1 åˆ‡æ¢åœºæ™¯

#### åœºæ™¯1ï¼šåœ¨èŒå¤šä¸ªç§Ÿæˆ·ï¼ˆå…¼èŒï¼‰
- ç”¨æˆ·åŒæ—¶åœ¨å·¥å‚Aå’Œå·¥å‚Bå·¥ä½œ
- å¯ä»¥å®æ—¶åˆ‡æ¢ç§Ÿæˆ·ï¼ŒæŸ¥çœ‹ä¸åŒç§Ÿæˆ·çš„æ•°æ®

#### åœºæ™¯2ï¼šæŸ¥çœ‹å†å²ç§Ÿæˆ·ï¼ˆå·²ç¦»èŒï¼‰
- ç”¨æˆ·åœ¨å·¥å‚Aç¦»èŒï¼Œä½†æƒ³æŸ¥çœ‹å†å²å·¥å•
- åˆ‡æ¢åˆ°å·²ç¦»èŒç§Ÿæˆ·ï¼Œåªè¯»æ¨¡å¼

### 5.2 åˆ‡æ¢å®ç°æ–¹æ¡ˆ

#### æ–¹æ¡ˆAï¼šé‡æ–°ç™»å½•ï¼ˆæ¨è â­ï¼‰

```javascript
// å°ç¨‹åºç«¯
async switchTenant(tenantId) {
  const res = await api.post('/api/auth/switch-tenant', {
    tenant_id: tenantId
  });
  
  // æ›´æ–°æœ¬åœ°Token
  wx.setStorageSync('token', res.data.token);
  
  // é‡æ–°åŠ è½½é¡µé¢
  wx.reLaunch({url: '/pages/index/index'});
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… JWTä¸­åŒ…å«ç§Ÿæˆ·ä¿¡æ¯ï¼Œåç«¯è‡ªåŠ¨åˆ‡æ¢æ•°æ®åº“
- âœ… å®‰å…¨æ€§é«˜ï¼Œæ¯æ¬¡åˆ‡æ¢éƒ½é‡æ–°éªŒè¯æƒé™
- âœ… å®ç°ç®€å•

**ç¼ºç‚¹**ï¼š
- âŒ éœ€è¦é‡æ–°åŠ è½½é¡µé¢

#### æ–¹æ¡ˆBï¼šHeaderä¼ é€’ï¼ˆé€‚åˆé¢‘ç¹åˆ‡æ¢ï¼‰

```javascript
// å°ç¨‹åºç«¯ï¼šæ¯ä¸ªè¯·æ±‚éƒ½å¸¦ä¸Šç§Ÿæˆ·ID
wx.request({
  url: '/api/order/list',
  header: {
    'Authorization': 'Bearer ' + token,
    'X-Tenant-ID': currentTenantId  // â† å½“å‰ç§Ÿæˆ·
  }
});
```

**åç«¯ä¸­é—´ä»¶**ï¼š
```go
// ä¼˜å…ˆä½¿ç”¨Headerä¸­çš„ç§Ÿæˆ·IDï¼Œä½†éœ€éªŒè¯ç”¨æˆ·æœ‰æƒé™è®¿é—®è¯¥ç§Ÿæˆ·
func TenantSwitchMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        // ä»JWTè·å–ç”¨æˆ·ID
        claims := c.MustGet("claims").(*jwt.Claims)
        
        // ä»Headerè·å–è¦åˆ‡æ¢çš„ç§Ÿæˆ·ID
        requestTenantID := c.GetHeader("X-Tenant-ID")
        if requestTenantID == "" {
            requestTenantID = claims.TenantID // é»˜è®¤ä½¿ç”¨JWTä¸­çš„ç§Ÿæˆ·
        }
        
        // âš ï¸ éªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰æƒè®¿é—®è¯¥ç§Ÿæˆ·
        if requestTenantID != claims.TenantID {
            valid := validateUserTenantAccess(claims.UserID, requestTenantID)
            if !valid {
                response.Error(c, "æ— æƒè®¿é—®è¯¥ç§Ÿæˆ·")
                c.Abort()
                return
            }
        }
        
        // è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡
        ctx := tenantCtx.WithTenantID(c.Request.Context(), requestTenantID)
        c.Request = c.Request.WithContext(ctx)
        
        c.Next()
    }
}
```

---

## å…­ã€æ ¸å¿ƒåŠŸèƒ½å®ç°

### 6.1 å¾®ä¿¡ç™»å½•æ¥å£

```go
// app/auth/dto/wechat.go
package dto

type WechatLoginRequest struct {
    Code        string `json:"code" binding:"required"`         // å¾®ä¿¡ç™»å½•code
    EncryptData string `json:"encrypted_data"`                  // åŠ å¯†çš„ç”¨æˆ·ä¿¡æ¯
    IV          string `json:"iv"`                              // åŠ å¯†ç®—æ³•åˆå§‹å‘é‡
}

type WechatLoginResponse struct {
    NeedSelectTenant bool                `json:"need_select_tenant"` // æ˜¯å¦éœ€è¦é€‰æ‹©ç§Ÿæˆ·
    NeedBindTenant   bool                `json:"need_bind_tenant"`   // æ˜¯å¦éœ€è¦ç»‘å®šç§Ÿæˆ·
    Token            string              `json:"token,omitempty"`
    UserInfo         *WechatUserInfo     `json:"user_info"`
    Tenants          []UserTenantInfo    `json:"tenants,omitempty"` // ç”¨æˆ·å…³è”çš„ç§Ÿæˆ·åˆ—è¡¨
    CurrentTenant    *UserTenantInfo     `json:"current_tenant,omitempty"`
}

type WechatUserInfo struct {
    ID       string `json:"id"`
    UnionID  string `json:"union_id"`
    Nickname string `json:"nickname"`
    Avatar   string `json:"avatar"`
    Phone    string `json:"phone"`
}

type UserTenantInfo struct {
    TenantID   string `json:"tenant_id"`
    TenantCode string `json:"tenant_code"`
    TenantName string `json:"tenant_name"`
    Status     string `json:"status"`      // active/inactive
    Role       string `json:"role"`        // åœ¨è¯¥ç§Ÿæˆ·çš„è§’è‰²
    JoinedAt   int64  `json:"joined_at"`
}
```

```go
// app/auth/services/wechat.go
package services

import (
    "context"
    "fmt"
    "mule-cloud/app/auth/dto"
    "mule-cloud/core/jwt"
    "mule-cloud/internal/models"
    "mule-cloud/internal/repository"
    tenantCtx "mule-cloud/core/context"
    "time"
)

type WechatService struct {
    wechatUserRepo  repository.WechatUserRepository
    userTenantRepo  repository.UserTenantMapRepository
    tenantRepo      repository.TenantRepository
    memberRepo      repository.TenantMemberRepository
    jwtManager      *jwt.JWTManager
    
    appID           string
    appSecret       string
}

// WechatLogin å¾®ä¿¡ç™»å½•
func (s *WechatService) WechatLogin(req dto.WechatLoginRequest) (*dto.WechatLoginResponse, error) {
    ctx := context.Background()
    
    // 1. è°ƒç”¨å¾®ä¿¡æ¥å£ï¼Œç”¨codeæ¢å–session_keyå’Œopenid
    wxSession, err := s.getWechatSession(req.Code)
    if err != nil {
        return nil, fmt.Errorf("å¾®ä¿¡ç™»å½•å¤±è´¥: %w", err)
    }
    
    // 2. è§£å¯†ç”¨æˆ·ä¿¡æ¯ï¼ˆå¦‚æœæä¾›äº†åŠ å¯†æ•°æ®ï¼‰
    var userInfo *WechatUserInfo
    if req.EncryptData != "" {
        userInfo, err = s.decryptWechatUserInfo(wxSession.SessionKey, req.EncryptData, req.IV)
        if err != nil {
            return nil, fmt.Errorf("è§£å¯†ç”¨æˆ·ä¿¡æ¯å¤±è´¥: %w", err)
        }
    }
    
    // 3. æŸ¥è¯¢æˆ–åˆ›å»ºå…¨å±€ç”¨æˆ·ï¼ˆç³»ç»Ÿåº“ï¼‰
    systemCtx := tenantCtx.WithTenantCode(ctx, "")
    wechatUser, err := s.wechatUserRepo.GetByUnionID(systemCtx, wxSession.UnionID)
    
    if wechatUser == nil {
        // é¦–æ¬¡ç™»å½•ï¼Œåˆ›å»ºå…¨å±€ç”¨æˆ·
        wechatUser = &models.WechatUser{
            UnionID:   wxSession.UnionID,
            Nickname:  userInfo.Nickname,
            Avatar:    userInfo.Avatar,
            Status:    1,
            CreatedAt: time.Now().Unix(),
            UpdatedAt: time.Now().Unix(),
        }
        err = s.wechatUserRepo.Create(systemCtx, wechatUser)
        if err != nil {
            return nil, fmt.Errorf("åˆ›å»ºç”¨æˆ·å¤±è´¥: %w", err)
        }
    } else {
        // æ›´æ–°æœ€åç™»å½•æ—¶é—´å’Œç”¨æˆ·ä¿¡æ¯
        s.wechatUserRepo.Update(systemCtx, wechatUser.ID, map[string]interface{}{
            "last_login_at": time.Now().Unix(),
            "nickname":      userInfo.Nickname,
            "avatar":        userInfo.Avatar,
        })
    }
    
    // 4. æŸ¥è¯¢ç”¨æˆ·å…³è”çš„ç§Ÿæˆ·ï¼ˆç³»ç»Ÿåº“ï¼‰
    tenantMaps, err := s.userTenantRepo.GetUserActiveTenants(systemCtx, wechatUser.ID)
    if err != nil {
        return nil, fmt.Errorf("æŸ¥è¯¢ç”¨æˆ·ç§Ÿæˆ·å¤±è´¥: %w", err)
    }
    
    // 5. æ ¹æ®ç§Ÿæˆ·æ•°é‡è¿”å›ä¸åŒå“åº”
    if len(tenantMaps) == 0 {
        // ç”¨æˆ·æ²¡æœ‰å…³è”ä»»ä½•ç§Ÿæˆ·ï¼Œéœ€è¦ç»‘å®š
        return &dto.WechatLoginResponse{
            NeedBindTenant: true,
            UserInfo: &dto.WechatUserInfo{
                ID:       wechatUser.ID,
                UnionID:  wechatUser.UnionID,
                Nickname: wechatUser.Nickname,
                Avatar:   wechatUser.Avatar,
                Phone:    wechatUser.Phone,
            },
        }, nil
    }
    
    if len(tenantMaps) == 1 {
        // åªæœ‰ä¸€ä¸ªç§Ÿæˆ·ï¼Œç›´æ¥ç™»å½•
        tenantMap := tenantMaps[0]
        token, currentTenant, err := s.generateTokenForTenant(wechatUser, &tenantMap)
        if err != nil {
            return nil, err
        }
        
        return &dto.WechatLoginResponse{
            Token:         token,
            UserInfo:      s.buildUserInfo(wechatUser),
            CurrentTenant: currentTenant,
        }, nil
    }
    
    // å¤šä¸ªç§Ÿæˆ·ï¼Œéœ€è¦ç”¨æˆ·é€‰æ‹©
    tenantInfos := make([]dto.UserTenantInfo, 0, len(tenantMaps))
    for _, tm := range tenantMaps {
        tenant, _ := s.tenantRepo.Get(systemCtx, tm.TenantID)
        tenantInfos = append(tenantInfos, dto.UserTenantInfo{
            TenantID:   tm.TenantID,
            TenantCode: tm.TenantCode,
            TenantName: tenant.Name,
            Status:     tm.Status,
            JoinedAt:   tm.JoinedAt,
        })
    }
    
    return &dto.WechatLoginResponse{
        NeedSelectTenant: true,
        UserInfo:         s.buildUserInfo(wechatUser),
        Tenants:          tenantInfos,
    }, nil
}

// generateTokenForTenant ä¸ºæŒ‡å®šç§Ÿæˆ·ç”ŸæˆToken
func (s *WechatService) generateTokenForTenant(user *models.WechatUser, tenantMap *models.UserTenantMap) (string, *dto.UserTenantInfo, error) {
    // æŸ¥è¯¢ç§Ÿæˆ·ä¿¡æ¯
    systemCtx := tenantCtx.WithTenantCode(context.Background(), "")
    tenant, err := s.tenantRepo.Get(systemCtx, tenantMap.TenantID)
    if err != nil {
        return "", nil, fmt.Errorf("æŸ¥è¯¢ç§Ÿæˆ·å¤±è´¥: %w", err)
    }
    
    // æŸ¥è¯¢ç§Ÿæˆ·æˆå‘˜ä¿¡æ¯ï¼ˆè·å–è§’è‰²ï¼‰
    tenantCtx := tenantCtx.WithTenantCode(context.Background(), tenantMap.TenantCode)
    member, err := s.memberRepo.GetByUnionID(tenantCtx, user.UnionID)
    if err != nil {
        return "", nil, fmt.Errorf("æŸ¥è¯¢æˆå‘˜ä¿¡æ¯å¤±è´¥: %w", err)
    }
    
    // ç”ŸæˆJWT Token
    token, err := s.jwtManager.GenerateToken(
        user.ID,
        user.Nickname,
        tenantMap.TenantID,
        tenantMap.TenantCode,
        member.Roles,
    )
    if err != nil {
        return "", nil, fmt.Errorf("ç”Ÿæˆtokenå¤±è´¥: %w", err)
    }
    
    currentTenant := &dto.UserTenantInfo{
        TenantID:   tenant.ID,
        TenantCode: tenant.Code,
        TenantName: tenant.Name,
        Status:     tenantMap.Status,
        Role:       member.Roles[0], // ç®€åŒ–å¤„ç†
        JoinedAt:   tenantMap.JoinedAt,
    }
    
    return token, currentTenant, nil
}

// getWechatSession è°ƒç”¨å¾®ä¿¡æ¥å£è·å–session
func (s *WechatService) getWechatSession(code string) (*WechatSession, error) {
    // è°ƒç”¨å¾®ä¿¡API: https://api.weixin.qq.com/sns/jscode2session
    // å‚æ•°: appid, secret, js_code, grant_type
    // TODO: å®ç°å¾®ä¿¡APIè°ƒç”¨
    return &WechatSession{}, nil
}

type WechatSession struct {
    OpenID     string `json:"openid"`
    SessionKey string `json:"session_key"`
    UnionID    string `json:"unionid"`
}
```

### 6.2 ç»‘å®šç§Ÿæˆ·æ¥å£

```go
// BindTenant ç»‘å®šç§Ÿæˆ·ï¼ˆé€šè¿‡é‚€è¯·ç ï¼‰
func (s *WechatService) BindTenant(userID string, inviteCode string) error {
    ctx := context.Background()
    systemCtx := tenantCtx.WithTenantCode(ctx, "")
    
    // 1. éªŒè¯é‚€è¯·ç ï¼Œè·å–ç§Ÿæˆ·ä¿¡æ¯
    tenant, err := s.tenantRepo.GetByInviteCode(systemCtx, inviteCode)
    if err != nil || tenant == nil {
        return fmt.Errorf("æ— æ•ˆçš„é‚€è¯·ç ")
    }
    
    // 2. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»åœ¨è¯¥ç§Ÿæˆ·ä¸­
    existing, _ := s.userTenantRepo.GetByUserAndTenant(systemCtx, userID, tenant.ID)
    if existing != nil && existing.Status == "active" {
        return fmt.Errorf("æ‚¨å·²ç»æ˜¯è¯¥ç§Ÿæˆ·æˆå‘˜")
    }
    
    // 3. è·å–ç”¨æˆ·ä¿¡æ¯
    wechatUser, err := s.wechatUserRepo.Get(systemCtx, userID)
    if err != nil {
        return fmt.Errorf("ç”¨æˆ·ä¸å­˜åœ¨")
    }
    
    // 4. åœ¨ç§Ÿæˆ·åº“åˆ›å»ºæˆå‘˜è®°å½•
    tenantCtx := tenantCtx.WithTenantCode(ctx, tenant.Code)
    member := &models.TenantMember{
        UnionID:    wechatUser.UnionID,
        UserID:     wechatUser.ID,
        Name:       wechatUser.Nickname,
        Phone:      wechatUser.Phone,
        Roles:      []string{"employee"}, // é»˜è®¤è§’è‰²
        Status:     "active",
        EmployedAt: time.Now().Unix(),
        CreatedAt:  time.Now().Unix(),
    }
    err = s.memberRepo.Create(tenantCtx, member)
    if err != nil {
        return fmt.Errorf("åˆ›å»ºæˆå‘˜å¤±è´¥: %w", err)
    }
    
    // 5. åœ¨ç³»ç»Ÿåº“åˆ›å»ºç”¨æˆ·-ç§Ÿæˆ·æ˜ å°„
    userTenantMap := &models.UserTenantMap{
        UserID:     userID,
        UnionID:    wechatUser.UnionID,
        TenantID:   tenant.ID,
        TenantCode: tenant.Code,
        MemberID:   member.ID,
        Status:     "active",
        JoinedAt:   time.Now().Unix(),
        CreatedAt:  time.Now().Unix(),
    }
    err = s.userTenantRepo.Create(systemCtx, userTenantMap)
    if err != nil {
        // å›æ»šï¼šåˆ é™¤æˆå‘˜è®°å½•
        s.memberRepo.HardDelete(tenantCtx, member.ID)
        return fmt.Errorf("åˆ›å»ºå…³è”å¤±è´¥: %w", err)
    }
    
    // 6. æ›´æ–°ç”¨æˆ·çš„ç§Ÿæˆ·åˆ—è¡¨ï¼ˆå†—ä½™å­—æ®µï¼‰
    s.wechatUserRepo.AddTenant(systemCtx, userID, tenant.ID)
    
    return nil
}
```

### 6.3 åˆ‡æ¢ç§Ÿæˆ·æ¥å£

```go
// SwitchTenant åˆ‡æ¢ç§Ÿæˆ·ï¼ˆé‡æ–°ç”ŸæˆTokenï¼‰
func (s *WechatService) SwitchTenant(userID string, tenantID string) (*dto.WechatLoginResponse, error) {
    ctx := context.Background()
    systemCtx := tenantCtx.WithTenantCode(ctx, "")
    
    // 1. éªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰æƒè®¿é—®è¯¥ç§Ÿæˆ·
    tenantMap, err := s.userTenantRepo.GetByUserAndTenant(systemCtx, userID, tenantID)
    if err != nil || tenantMap == nil {
        return nil, fmt.Errorf("æ— æƒè®¿é—®è¯¥ç§Ÿæˆ·")
    }
    
    // 2. è·å–ç”¨æˆ·ä¿¡æ¯
    wechatUser, err := s.wechatUserRepo.Get(systemCtx, userID)
    if err != nil {
        return nil, fmt.Errorf("ç”¨æˆ·ä¸å­˜åœ¨")
    }
    
    // 3. ç”Ÿæˆæ–°çš„Token
    token, currentTenant, err := s.generateTokenForTenant(wechatUser, tenantMap)
    if err != nil {
        return nil, err
    }
    
    return &dto.WechatLoginResponse{
        Token:         token,
        UserInfo:      s.buildUserInfo(wechatUser),
        CurrentTenant: currentTenant,
    }, nil
}
```

---

## ä¸ƒã€å®‰å…¨ä¸æƒé™æ§åˆ¶

### 7.1 å®‰å…¨è€ƒè™‘

#### 1. ç§Ÿæˆ·éš”ç¦»éªŒè¯
```go
// ä¸­é—´ä»¶ï¼šéªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰æƒè®¿é—®å½“å‰ç§Ÿæˆ·
func ValidateTenantAccess() gin.HandlerFunc {
    return func(c *gin.Context) {
        claims := c.MustGet("claims").(*jwt.Claims)
        
        // JWTä¸­çš„ç§Ÿæˆ·ID
        jwtTenantID := claims.TenantID
        
        // å¦‚æœHeaderä¸­æŒ‡å®šäº†ä¸åŒçš„ç§Ÿæˆ·IDï¼Œéœ€è¦éªŒè¯
        headerTenantID := c.GetHeader("X-Tenant-ID")
        if headerTenantID != "" && headerTenantID != jwtTenantID {
            // éªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰æƒè®¿é—®è¯¥ç§Ÿæˆ·
            valid := validateUserTenantAccess(claims.UserID, headerTenantID)
            if !valid {
                response.Error(c, "æ— æƒè®¿é—®è¯¥ç§Ÿæˆ·")
                c.Abort()
                return
            }
        }
        
        c.Next()
    }
}
```

#### 2. ç¦»èŒå‘˜å·¥æƒé™é™çº§
```go
// æŸ¥è¯¢æˆå‘˜ä¿¡æ¯æ—¶æ£€æŸ¥çŠ¶æ€
member, err := memberRepo.GetByUnionID(ctx, unionID)
if member.Status == "inactive" {
    // å·²ç¦»èŒï¼Œåªå…è®¸åªè¯»æ“ä½œ
    if c.Request.Method != "GET" {
        response.Error(c, "æ‚¨å·²ç¦»èŒï¼Œæ— æ³•æ‰§è¡Œæ­¤æ“ä½œ")
        c.Abort()
        return
    }
}
```

### 7.2 æ•°æ®æƒé™æ§åˆ¶

#### ç¦»èŒå‘˜å·¥æ•°æ®è®¿é—®ç­–ç•¥

| åœºæ™¯ | ç­–ç•¥ | è¯´æ˜ |
|------|------|------|
| æŸ¥çœ‹å†å²è®¢å• | âœ… å…è®¸ï¼ˆåªè¯»ï¼‰ | å¯ä»¥æŸ¥çœ‹è‡ªå·±å‚ä¸çš„å†å²è®¢å• |
| ä¿®æ”¹è®¢å• | âŒ ç¦æ­¢ | å·²ç¦»èŒï¼Œæ— ä¿®æ”¹æƒé™ |
| æŸ¥çœ‹å…¶ä»–å‘˜å·¥ä¿¡æ¯ | âŒ ç¦æ­¢ | ç¦»èŒåä¸èƒ½æŸ¥çœ‹åœ¨èŒå‘˜å·¥ |
| ä¸‹è½½å†å²æŠ¥è¡¨ | âœ… å…è®¸ï¼ˆé™åˆ¶ï¼‰ | åªèƒ½ä¸‹è½½è‡ªå·±ç›¸å…³çš„æ•°æ® |

---

## å…«ã€å®æ–½æ­¥éª¤

### ç¬¬ä¸€é˜¶æ®µï¼šæ•°æ®æ¨¡å‹ä¸åŸºç¡€æœåŠ¡ï¼ˆ2-3å¤©ï¼‰

#### Step 1: åˆ›å»ºæ–°æ•°æ®æ¨¡å‹

```bash
# åˆ›å»ºæ¨¡å‹æ–‡ä»¶
touch internal/models/wechat_user.go
touch internal/models/user_tenant_map.go
```

#### Step 2: åˆ›å»ºRepositoryå±‚

```bash
touch internal/repository/wechat_user.go
touch internal/repository/user_tenant_map.go
```

#### Step 3: æ”¹é€ ç°æœ‰Adminæ¨¡å‹ä¸ºTenantMember

```go
// é‡å‘½åæˆ–æ–°å»º
cp internal/models/admin.go internal/models/tenant_member.go
# ä¿®æ”¹ç»“æ„ä½“ï¼Œæ·»åŠ UnionIDã€UserIDç­‰å­—æ®µ
```

### ç¬¬äºŒé˜¶æ®µï¼šå¾®ä¿¡ç™»å½•æœåŠ¡ï¼ˆ2-3å¤©ï¼‰

#### Step 4: å®ç°å¾®ä¿¡ç™»å½•æœåŠ¡

```bash
mkdir app/auth/services/wechat
touch app/auth/services/wechat/login.go
touch app/auth/services/wechat/session.go
```

#### Step 5: æ·»åŠ å¾®ä¿¡ç™»å½•æ¥å£

```bash
# æ·»åŠ DTO
touch app/auth/dto/wechat.go

# æ·»åŠ Endpoint
touch app/auth/endpoint/wechat.go

# æ·»åŠ Transport
# ä¿®æ”¹ app/auth/transport/auth.go
```

#### Step 6: æ³¨å†Œè·¯ç”±

```go
// cmd/auth/main.go
wechatSvc := services.NewWechatService(jwtManager, cfg.Wechat.AppID, cfg.Wechat.AppSecret)

auth.POST("/wechat/login", transport.WechatLoginHandler(wechatSvc))
auth.POST("/wechat/bind-tenant", transport.BindTenantHandler(wechatSvc))
auth.POST("/wechat/switch-tenant", transport.SwitchTenantHandler(wechatSvc))
```

### ç¬¬ä¸‰é˜¶æ®µï¼šæ•°æ®è¿ç§»ï¼ˆ1-2å¤©ï¼‰

#### Step 7: ç¼–å†™æ•°æ®è¿ç§»è„šæœ¬

```javascript
// scripts/migrate_to_wechat_user.js

// 1. ä¸ºç°æœ‰adminç”¨æˆ·ç”Ÿæˆä¸´æ—¶UnionIDï¼ˆå¦‚æœæ²¡æœ‰å¾®ä¿¡ç™»å½•ï¼‰
// 2. åˆ›å»ºUserTenantMapå…³è”
// 3. æ›´æ–°Memberè¡¨ç»“æ„
```

#### Step 8: é…ç½®å¾®ä¿¡å°ç¨‹åº

```yaml
# config/auth.yaml
wechat:
  app_id: "wxXXXXXXXXXXXXXX"
  app_secret: "XXXXXXXXXXXXXXXXXXXXXXXX"
  # å¦‚æœæœ‰å¾®ä¿¡å¼€æ”¾å¹³å°ï¼Œé…ç½®UnionID
  open_app_id: "wxXXXXXXXXXXXXXX"
```

### ç¬¬å››é˜¶æ®µï¼šå°ç¨‹åºç«¯é€‚é…ï¼ˆ2-3å¤©ï¼‰

#### Step 9: å°ç¨‹åºç™»å½•é¡µé¢

```javascript
// pages/login/index.js
async wechatLogin() {
  // 1. è·å–å¾®ä¿¡ç™»å½•code
  const { code } = await wx.login();
  
  // 2. è°ƒç”¨åç«¯ç™»å½•æ¥å£
  const res = await api.post('/api/auth/wechat/login', { code });
  
  // 3. æ ¹æ®å“åº”å¤„ç†ä¸åŒæƒ…å†µ
  if (res.data.need_bind_tenant) {
    // éœ€è¦ç»‘å®šç§Ÿæˆ·ï¼Œè·³è½¬åˆ°è¾“å…¥é‚€è¯·ç é¡µé¢
    wx.navigateTo({ url: '/pages/bind-tenant/index' });
  } else if (res.data.need_select_tenant) {
    // éœ€è¦é€‰æ‹©ç§Ÿæˆ·
    wx.navigateTo({ 
      url: '/pages/select-tenant/index',
      data: { tenants: res.data.tenants }
    });
  } else {
    // ç›´æ¥ç™»å½•æˆåŠŸ
    wx.setStorageSync('token', res.data.token);
    wx.switchTab({ url: '/pages/index/index' });
  }
}
```

### ç¬¬äº”é˜¶æ®µï¼šæµ‹è¯•ä¸ä¸Šçº¿ï¼ˆ2-3å¤©ï¼‰

#### Step 10: åŠŸèƒ½æµ‹è¯•

- âœ… æ–°ç”¨æˆ·é¦–æ¬¡ç™»å½•
- âœ… ç»‘å®šç§Ÿæˆ·
- âœ… å¤šç§Ÿæˆ·åˆ‡æ¢
- âœ… ç¦»èŒå‘˜å·¥ç™»å½•ï¼ˆåªè¯»ï¼‰
- âœ… æƒé™éªŒè¯

#### Step 11: æ•°æ®éªŒè¯

- âœ… ç³»ç»Ÿåº“æ•°æ®å®Œæ•´æ€§
- âœ… ç§Ÿæˆ·åº“æ•°æ®éš”ç¦»
- âœ… å…³è”å…³ç³»æ­£ç¡®æ€§

---

## ä¹ã€æœ€ä½³å®è·µå»ºè®®

### 9.1 é‚€è¯·ç è®¾è®¡

```go
// ç”Ÿæˆç§Ÿæˆ·é‚€è¯·ç ï¼ˆ6ä½æ•°å­—ï¼Œ24å°æ—¶æœ‰æ•ˆï¼‰
type TenantInvite struct {
    Code      string `bson:"_id"`           // 6ä½é‚€è¯·ç 
    TenantID  string `bson:"tenant_id"`
    CreatedBy string `bson:"created_by"`
    ExpiresAt int64  `bson:"expires_at"`    // è¿‡æœŸæ—¶é—´
    UsedCount int    `bson:"used_count"`    // ä½¿ç”¨æ¬¡æ•°
    MaxUse    int    `bson:"max_use"`       // æœ€å¤§ä½¿ç”¨æ¬¡æ•°
}

// ç”Ÿæˆé‚€è¯·ç 
func GenerateInviteCode(tenantID string, maxUse int) string {
    code := fmt.Sprintf("%06d", rand.Intn(1000000))
    // å­˜å‚¨åˆ°æ•°æ®åº“...
    return code
}
```

### 9.2 æ‰‹æœºå·ç»‘å®šç­–ç•¥

**æ¨èç­–ç•¥**ï¼šæ‰‹æœºå·å¯é€‰ï¼Œä½†å»ºè®®ç»‘å®š

```go
// è·å–æ‰‹æœºå·ï¼ˆå¾®ä¿¡æ¥å£ï¼‰
async function getPhoneNumber(e) {
  if (e.detail.errMsg === 'getPhoneNumber:ok') {
    // å‘é€åˆ°åç«¯ç»‘å®š
    await api.post('/api/user/bind-phone', {
      encrypted_data: e.detail.encryptedData,
      iv: e.detail.iv
    });
  }
}
```

### 9.3 ç¦»èŒå‘˜å·¥ç®¡ç†

#### ä¸»åŠ¨ç¦»èŒæµç¨‹
```go
// ç§Ÿæˆ·ç®¡ç†å‘˜å°†å‘˜å·¥è®¾ç½®ä¸ºç¦»èŒ
func (s *MemberService) SetMemberInactive(memberID string) error {
    // 1. æ›´æ–°ç§Ÿæˆ·åº“ä¸­çš„æˆå‘˜çŠ¶æ€
    member.Status = "inactive"
    member.LeftAt = time.Now().Unix()
    
    // 2. æ›´æ–°ç³»ç»Ÿåº“ä¸­çš„å…³è”çŠ¶æ€
    userTenantMap.Status = "inactive"
    userTenantMap.LeftAt = time.Now().Unix()
    
    return nil
}
```

#### è‡ªåŠ¨ç¦»èŒæ£€æµ‹ï¼ˆå¯é€‰ï¼‰
- è¶…è¿‡30å¤©æœªç™»å½•ï¼Œè‡ªåŠ¨æ ‡è®°ä¸ºå¾…ç¡®è®¤
- 60å¤©æœªç™»å½•ï¼Œè‡ªåŠ¨è½¬ä¸ºç¦»èŒçŠ¶æ€

---

## åã€æ€»ç»“

### æ ¸å¿ƒä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| âœ… ç”¨æˆ·å…¨å±€å”¯ä¸€ | ä¸€ä¸ªå¾®ä¿¡è´¦å·ï¼Œå¤šä¸ªç§Ÿæˆ·é€šç”¨ |
| âœ… æ•°æ®å®Œå…¨éš”ç¦» | ä¿æŒç°æœ‰çš„ç§Ÿæˆ·æ•°æ®åº“ç‰©ç†éš”ç¦» |
| âœ… çµæ´»çš„å…³è”å…³ç³» | æ”¯æŒä¸€äººå¤šç§Ÿæˆ·ã€ç¦»èŒåæ•°æ®ä¿ç•™ |
| âœ… æ— ç¼åˆ‡æ¢ | å‘˜å·¥æ¢å·¥å‚åæ— éœ€é‡æ–°æ³¨å†Œ |
| âœ… å®‰å…¨å¯æ§ | ä¸¥æ ¼çš„æƒé™éªŒè¯å’Œæ•°æ®éš”ç¦» |

### å®æ–½æ—¶é—´è¡¨

| é˜¶æ®µ | å·¥ä½œé‡ | å®Œæˆæ ‡å¿— |
|------|--------|----------|
| æ•°æ®æ¨¡å‹ | 2-3å¤© | åˆ›å»ºWechatUserã€UserTenantMapç­‰è¡¨ |
| å¾®ä¿¡ç™»å½•æœåŠ¡ | 2-3å¤© | å®ç°ç™»å½•ã€ç»‘å®šã€åˆ‡æ¢æ¥å£ |
| æ•°æ®è¿ç§» | 1-2å¤© | ç°æœ‰ç”¨æˆ·æ•°æ®è¿ç§»å®Œæˆ |
| å°ç¨‹åºé€‚é… | 2-3å¤© | ç™»å½•ã€é€‰æ‹©ç§Ÿæˆ·ç­‰é¡µé¢ |
| æµ‹è¯•ä¸Šçº¿ | 2-3å¤© | åŠŸèƒ½æµ‹è¯•ã€æ•°æ®éªŒè¯ |
| **æ€»è®¡** | **10-15å¤©** | å®Œæ•´åŠŸèƒ½ä¸Šçº¿ |

### åç»­ä¼˜åŒ–æ–¹å‘

1. **æ‰‹æœºå·å¿«é€Ÿç™»å½•**ï¼šå·²ç»‘å®šæ‰‹æœºå·çš„ç”¨æˆ·å¯ä»¥æ‰‹æœºå·éªŒè¯ç ç™»å½•
2. **äºŒç»´ç é‚€è¯·**ï¼šæ‰«æç§Ÿæˆ·äºŒç»´ç ç›´æ¥åŠ å…¥
3. **å®¡æ‰¹æµç¨‹**ï¼šæ–°å‘˜å·¥åŠ å…¥éœ€è¦ç®¡ç†å‘˜å®¡æ‰¹
4. **ç¦»èŒäº¤æ¥**ï¼šç¦»èŒå‘˜å·¥çš„ä¸šåŠ¡æ•°æ®äº¤æ¥ç»™ç»§ä»»è€…
5. **æ•°æ®å¯¼å‡º**ï¼šå…è®¸ç¦»èŒå‘˜å·¥å¯¼å‡ºè‡ªå·±çš„å†å²æ•°æ®

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**åˆ›å»ºæ—¥æœŸ**ï¼š2025-10-08  
**ä½œè€…**ï¼šMule-Cloud AI Assistant  
**çŠ¶æ€**ï¼šå¾…å®¡æ ¸


