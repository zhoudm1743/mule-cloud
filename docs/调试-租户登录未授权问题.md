# 调试 - 租户登录未授权问题

## 🐛 问题现象

创建租户后，使用租户管理员账号登录，提示：**"用户未授权"**

## 🔍 可能的原因

### 1. 创建租户时没有提供管理员信息

**检查**：创建租户时是否填写了：
- 管理员手机号
- 管理员密码
- 管理员昵称（可选）

**后端逻辑**：`app/system/services/tenant.go:196-220`

```go
// 4. 如果提供了管理员信息，创建租户管理员
if req.AdminPhone != "" && req.AdminPassword != "" {
    adminService := NewAdminService()
    
    // 使用带Context的创建方法，确保在租户数据库中创建
    _, err = adminService.CreateWithContext(tenantCtx, dto.AdminCreateRequest{
        Phone:    req.AdminPhone,
        Password: req.AdminPassword,
        Nickname: nickname,
        Roles:    []string{adminRole.ID}, // 分配默认管理员角色
        Status:   1,
    })
}
```

**如果没有提供管理员信息，后端不会创建默认用户！**

---

### 2. 用户已创建但状态异常

**可能的状态问题**：
- `status = 0`（禁用）
- `is_deleted = 1`（已删除）
- `roles` 为空（没有角色）

---

### 3. 密码错误

**前后端密码加密一致性**：
- 前端：提交明文密码
- 后端创建用户：`Md5(password + "mule-zdm")`
- 后端验证登录：`Md5(password + "mule-zdm")`

**应该是一致的** ✅

---

### 4. "用户未授权"错误来源

**后端错误定义**（`app/auth/services/auth.go:19-24`）：
- `ErrUserNotFound` = "用户不存在"
- `ErrInvalidPassword` = "密码错误"
- `ErrUserDisabled` = "用户已被禁用"

**没有"用户未授权"错误** ❓

**可能来源**：
- 前端翻译/转换了错误信息
- 网关或中间件返回的错误
- 前端自定义的错误信息

---

## 🎯 调试步骤

### 步骤1: 查看后端日志

**auth 服务应该输出详细日志**：

```
[登录] 租户登录: 手机号=xxx, 租户代码=yyy
[登录] 找到租户: ID=xxx, 名称=yyy
[登录] 查询结果: admin=true/false
[登录] 找到用户: ID=xxx, 昵称=xxx, 角色=[xxx]
```

**如果看到**：
```
[登录] 用户不存在: xxx
```

**说明用户没有创建成功。**

---

### 步骤2: 检查创建租户的请求参数

**打开浏览器 F12 → Network**：

1. 找到创建租户的请求（`POST /system/tenants`）
2. 查看 Request Payload：

```json
{
  "code": "ace",
  "name": "文斯",
  "contact": "",
  "phone": "",
  "email": "",
  "status": 1,
  "admin_phone": "13838383388",     // ← 必须有值
  "admin_password": "123456",       // ← 必须有值
  "admin_name": "文斯管理员"        // ← 可选
}
```

**如果 `admin_phone` 或 `admin_password` 为空，后端不会创建用户！**

---

### 步骤3: 检查 system 服务日志

**创建租户时，system 服务应该输出**：

```
创建租户: xxx
创建租户数据库: mule_xxx
创建默认角色: tenant_admin
创建租户管理员: 13838383388
```

**如果没有"创建租户管理员"日志，说明没有提供管理员信息。**

---

### 步骤4: 手动检查数据库（可选）

**如果 MongoDB 可以连接**：

```javascript
// 连接到租户数据库
use mule_68e27febab849776302...

// 查询管理员
db.admin.find({ phone: "13838383388" })

// 检查结果
// - 如果找不到：用户没有创建
// - 如果找到了，检查：
//   - status: 必须是 1（启用）
//   - is_deleted: 必须是 0（未删除）
//   - roles: 必须有值（角色ID）
```

---

## ✅ 解决方案

### 方案1: 重新创建租户（推荐）

1. **删除现有租户**
2. **重新创建租户**，**确保填写**：
   - ✅ 管理员手机号：`13838383388`
   - ✅ 管理员密码：`123456`
   - ✅ 管理员昵称：`租户管理员`（可选）
3. **查看 system 服务日志**，确认创建成功
4. **尝试登录**

---

### 方案2: 手动创建租户管理员

**如果租户已经存在，不想删除**：

1. **系统管理员登录**
2. **切换到该租户**（顶部租户选择器）
3. **进入"管理员管理"**
4. **点击"新增"**：
   - 手机号：`13838383388`
   - 密码：`123456`
   - 昵称：`租户管理员`
   - 角色：勾选"租户管理员"
   - 状态：启用
5. **保存**
6. **尝试登录**

---

## 🎯 验证

**登录信息**：
- 📱 手机号：创建租户时填写的管理员手机号
- 🔑 密码：创建租户时填写的管理员密码
- 🏢 租户：选择对应的租户

**期望结果**：
- ✅ 登录成功
- ✅ 进入系统
- ✅ 能看到菜单

**不应该看到**：
- ❌ 用户不存在
- ❌ 用户未授权
- ❌ 密码错误

---

## 📝 请提供以下信息

帮助我更准确地定位问题：

1. **创建租户时的请求参数**（F12 → Network）
   - 是否填写了 `admin_phone` 和 `admin_password`？

2. **auth 服务的登录日志**
   - 登录时输出了什么？

3. **system 服务的创建租户日志**
   - 是否有"创建租户管理员"相关日志？

**把这些信息提供给我，我可以帮你精确定位问题！** 🔍
