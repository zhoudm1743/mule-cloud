# 中间件极简使用指南

## 🎯 核心理念

**一个函数搞定所有场景** ✅

```go
middleware.Apply(group, jwtManager)
```

---

## 📦 90% 的场景

### 标准业务服务（推荐）

```go
import (
    "mule-cloud/core/jwt"
    "mule-cloud/core/middleware"
)

func main() {
    jwtManager := jwt.NewJWTManager(nil, 0)
    
    api := r.Group("/api")
    middleware.Apply(api, jwtManager)  // ✅ 就这一行
    {
        api.GET("/users", handler.GetUsers)
        api.POST("/users", handler.CreateUsers)
    }
}
```

**自动包含**:
- ✅ 网关转发支持（X-User-ID headers）
- ✅ JWT token 验证（直接访问）
- ✅ 租户数据库隔离
- ✅ 系统管理员切换租户

---

## 🔧 特殊场景（10%）

### 场景1：只支持直接访问（不通过网关）

```go
middleware.Apply(api, jwtManager, middleware.MiddlewareConfig{
    SupportGateway: false,
})
```

### 场景2：要求管理员权限

```go
middleware.Apply(admin, jwtManager, middleware.MiddlewareConfig{
    RequireRole: []string{"super"},
})
```

### 场景3：可选认证（公开接口）

```go
middleware.Apply(public, jwtManager, middleware.MiddlewareConfig{
    Optional: true,
})
```

### 场景4：组合配置

```go
middleware.Apply(api, jwtManager, middleware.MiddlewareConfig{
    SupportGateway: false,
    RequireRole:    []string{"super", "admin"},
    Optional:       false,
})
```

---

## 🚀 新建微服务模板

```go
package main

import (
    "mule-cloud/core/config"
    "mule-cloud/core/database"
    "mule-cloud/core/jwt"
    "mule-cloud/core/middleware"
    "mule-cloud/core/response"
    
    "github.com/gin-gonic/gin"
)

func main() {
    // 1. 加载配置
    cfg, _ := config.Load("config/myservice.yaml")
    
    // 2. 初始化数据库
    client, _ := database.InitMongoDB(&cfg.MongoDB)
    database.InitDatabaseManager(client)
    
    // 3. 初始化 JWT
    jwtManager := jwt.NewJWTManager(nil, 0)
    
    // 4. 初始化路由
    r := gin.New()
    r.Use(gin.Logger())
    r.Use(response.RecoveryMiddleware())
    r.Use(response.UnifiedResponseMiddleware())
    
    // 5. ✅ 一行代码应用所有标准中间件
    api := r.Group("/api")
    middleware.Apply(api, jwtManager)
    {
        api.GET("/resources", myHandler)
    }
    
    // 6. 启动服务
    r.Run(":8080")
}
```

---

## 📊 对比

### 之前（❌ 复杂）

```go
// 需要记住4个不同的函数
middleware.ApplyCommonMiddlewares(...)           // 什么时候用这个？
middleware.ApplyGatewayOrJWTMiddlewares(...)     // 还是这个？
middleware.ApplyAdminMiddlewares(...)            // 或者这个？
middleware.ApplyOptionalAuthMiddlewares(...)     // 傻傻分不清楚
```

### 现在（✅ 简单）

```go
// 只需要记住一个函数
middleware.Apply(group, jwtManager)              // 99% 的场景

// 特殊场景加个配置
middleware.Apply(group, jwtManager, middleware.MiddlewareConfig{
    RequireRole: []string{"super"},
})
```

---

## 💡 记忆法

**没有配置 = 默认最常用的配置**
- ✅ 支持网关和直接访问
- ✅ 支持租户隔离
- ✅ 支持系统管理员切换租户

**99% 的微服务只需要**:
```go
middleware.Apply(api, jwtManager)
```

---

## ✅ 现在所有服务

```go
// cmd/auth/main.go
middleware.Apply(protected, jwtManager) ✅

// cmd/basic/main.go
middleware.Apply(basic, jwtManager) ✅

// cmd/system/main.go
middleware.Apply(system, jwtManager) ✅
```

**一个函数，搞定所有！** 🎉

---

## 🔍 配置说明

```go
type MiddlewareConfig struct {
    // SupportGateway 是否支持网关转发（默认: true）
    SupportGateway bool
    
    // RequireRole 要求的角色（默认: nil = 不要求）
    RequireRole []string
    
    // Optional 是否可选认证（默认: false = 必须认证）
    Optional bool
}
```

### 默认值（不提供配置时）

```go
{
    SupportGateway: true,   // 支持网关
    RequireRole:    nil,    // 不要求特定角色
    Optional:       false,  // 必须认证
}
```

这就是最常用的配置，覆盖90%+的场景！

---

## 📚 更多示例

### 示例1：标准API服务

```go
api := r.Group("/api")
middleware.Apply(api, jwtManager)
// 完成！
```

### 示例2：管理后台

```go
admin := r.Group("/admin")
middleware.Apply(admin, jwtManager, middleware.MiddlewareConfig{
    RequireRole: []string{"super"},
})
```

### 示例3：公开+登录混合

```go
public := r.Group("/public")
middleware.Apply(public, jwtManager, middleware.MiddlewareConfig{
    Optional: true,
})
{
    public.GET("/articles", getArticles)     // 未登录可访问
    public.POST("/articles", createArticle)  // 需要登录
}
```

### 示例4：内部服务（不通过网关）

```go
internal := r.Group("/internal")
middleware.Apply(internal, jwtManager, middleware.MiddlewareConfig{
    SupportGateway: false,
})
```

---

## 🎯 总结

**一个函数 `middleware.Apply()`，适用于所有场景！**

- 不需要记忆4个不同的函数名
- 不需要纠结用哪个
- 新服务一行代码搞定

简单、统一、易用！✨
