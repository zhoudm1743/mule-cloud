# ä¸­é—´ä»¶æç®€ä½¿ç”¨æŒ‡å—

## ğŸ¯ æ ¸å¿ƒç†å¿µ

**ä¸€ä¸ªå‡½æ•°æå®šæ‰€æœ‰åœºæ™¯** âœ…

```go
middleware.Apply(group, jwtManager)
```

---

## ğŸ“¦ 90% çš„åœºæ™¯

### æ ‡å‡†ä¸šåŠ¡æœåŠ¡ï¼ˆæ¨èï¼‰

```go
import (
    "mule-cloud/core/jwt"
    "mule-cloud/core/middleware"
)

func main() {
    jwtManager := jwt.NewJWTManager(nil, 0)
    
    api := r.Group("/api")
    middleware.Apply(api, jwtManager)  // âœ… å°±è¿™ä¸€è¡Œ
    {
        api.GET("/users", handler.GetUsers)
        api.POST("/users", handler.CreateUsers)
    }
}
```

**è‡ªåŠ¨åŒ…å«**:
- âœ… ç½‘å…³è½¬å‘æ”¯æŒï¼ˆX-User-ID headersï¼‰
- âœ… JWT token éªŒè¯ï¼ˆç›´æ¥è®¿é—®ï¼‰
- âœ… ç§Ÿæˆ·æ•°æ®åº“éš”ç¦»
- âœ… ç³»ç»Ÿç®¡ç†å‘˜åˆ‡æ¢ç§Ÿæˆ·

---

## ğŸ”§ ç‰¹æ®Šåœºæ™¯ï¼ˆ10%ï¼‰

### åœºæ™¯1ï¼šåªæ”¯æŒç›´æ¥è®¿é—®ï¼ˆä¸é€šè¿‡ç½‘å…³ï¼‰

```go
middleware.Apply(api, jwtManager, middleware.MiddlewareConfig{
    SupportGateway: false,
})
```

### åœºæ™¯2ï¼šè¦æ±‚ç®¡ç†å‘˜æƒé™

```go
middleware.Apply(admin, jwtManager, middleware.MiddlewareConfig{
    RequireRole: []string{"super"},
})
```

### åœºæ™¯3ï¼šå¯é€‰è®¤è¯ï¼ˆå…¬å¼€æ¥å£ï¼‰

```go
middleware.Apply(public, jwtManager, middleware.MiddlewareConfig{
    Optional: true,
})
```

### åœºæ™¯4ï¼šç»„åˆé…ç½®

```go
middleware.Apply(api, jwtManager, middleware.MiddlewareConfig{
    SupportGateway: false,
    RequireRole:    []string{"super", "admin"},
    Optional:       false,
})
```

---

## ğŸš€ æ–°å»ºå¾®æœåŠ¡æ¨¡æ¿

```go
package main

import (
    "mule-cloud/core/config"
    "mule-cloud/core/database"
    "mule-cloud/core/jwt"
    "mule-cloud/core/middleware"
    "mule-cloud/core/response"
    
    "github.com/gin-gonic/gin"
)

func main() {
    // 1. åŠ è½½é…ç½®
    cfg, _ := config.Load("config/myservice.yaml")
    
    // 2. åˆå§‹åŒ–æ•°æ®åº“
    client, _ := database.InitMongoDB(&cfg.MongoDB)
    database.InitDatabaseManager(client)
    
    // 3. åˆå§‹åŒ– JWT
    jwtManager := jwt.NewJWTManager(nil, 0)
    
    // 4. åˆå§‹åŒ–è·¯ç”±
    r := gin.New()
    r.Use(gin.Logger())
    r.Use(response.RecoveryMiddleware())
    r.Use(response.UnifiedResponseMiddleware())
    
    // 5. âœ… ä¸€è¡Œä»£ç åº”ç”¨æ‰€æœ‰æ ‡å‡†ä¸­é—´ä»¶
    api := r.Group("/api")
    middleware.Apply(api, jwtManager)
    {
        api.GET("/resources", myHandler)
    }
    
    // 6. å¯åŠ¨æœåŠ¡
    r.Run(":8080")
}
```

---

## ğŸ“Š å¯¹æ¯”

### ä¹‹å‰ï¼ˆâŒ å¤æ‚ï¼‰

```go
// éœ€è¦è®°ä½4ä¸ªä¸åŒçš„å‡½æ•°
middleware.ApplyCommonMiddlewares(...)           // ä»€ä¹ˆæ—¶å€™ç”¨è¿™ä¸ªï¼Ÿ
middleware.ApplyGatewayOrJWTMiddlewares(...)     // è¿˜æ˜¯è¿™ä¸ªï¼Ÿ
middleware.ApplyAdminMiddlewares(...)            // æˆ–è€…è¿™ä¸ªï¼Ÿ
middleware.ApplyOptionalAuthMiddlewares(...)     // å‚»å‚»åˆ†ä¸æ¸…æ¥š
```

### ç°åœ¨ï¼ˆâœ… ç®€å•ï¼‰

```go
// åªéœ€è¦è®°ä½ä¸€ä¸ªå‡½æ•°
middleware.Apply(group, jwtManager)              // 99% çš„åœºæ™¯

// ç‰¹æ®Šåœºæ™¯åŠ ä¸ªé…ç½®
middleware.Apply(group, jwtManager, middleware.MiddlewareConfig{
    RequireRole: []string{"super"},
})
```

---

## ğŸ’¡ è®°å¿†æ³•

**æ²¡æœ‰é…ç½® = é»˜è®¤æœ€å¸¸ç”¨çš„é…ç½®**
- âœ… æ”¯æŒç½‘å…³å’Œç›´æ¥è®¿é—®
- âœ… æ”¯æŒç§Ÿæˆ·éš”ç¦»
- âœ… æ”¯æŒç³»ç»Ÿç®¡ç†å‘˜åˆ‡æ¢ç§Ÿæˆ·

**99% çš„å¾®æœåŠ¡åªéœ€è¦**:
```go
middleware.Apply(api, jwtManager)
```

---

## âœ… ç°åœ¨æ‰€æœ‰æœåŠ¡

```go
// cmd/auth/main.go
middleware.Apply(protected, jwtManager) âœ…

// cmd/basic/main.go
middleware.Apply(basic, jwtManager) âœ…

// cmd/system/main.go
middleware.Apply(system, jwtManager) âœ…
```

**ä¸€ä¸ªå‡½æ•°ï¼Œæå®šæ‰€æœ‰ï¼** ğŸ‰

---

## ğŸ” é…ç½®è¯´æ˜

```go
type MiddlewareConfig struct {
    // SupportGateway æ˜¯å¦æ”¯æŒç½‘å…³è½¬å‘ï¼ˆé»˜è®¤: trueï¼‰
    SupportGateway bool
    
    // RequireRole è¦æ±‚çš„è§’è‰²ï¼ˆé»˜è®¤: nil = ä¸è¦æ±‚ï¼‰
    RequireRole []string
    
    // Optional æ˜¯å¦å¯é€‰è®¤è¯ï¼ˆé»˜è®¤: false = å¿…é¡»è®¤è¯ï¼‰
    Optional bool
}
```

### é»˜è®¤å€¼ï¼ˆä¸æä¾›é…ç½®æ—¶ï¼‰

```go
{
    SupportGateway: true,   // æ”¯æŒç½‘å…³
    RequireRole:    nil,    // ä¸è¦æ±‚ç‰¹å®šè§’è‰²
    Optional:       false,  // å¿…é¡»è®¤è¯
}
```

è¿™å°±æ˜¯æœ€å¸¸ç”¨çš„é…ç½®ï¼Œè¦†ç›–90%+çš„åœºæ™¯ï¼

---

## ğŸ“š æ›´å¤šç¤ºä¾‹

### ç¤ºä¾‹1ï¼šæ ‡å‡†APIæœåŠ¡

```go
api := r.Group("/api")
middleware.Apply(api, jwtManager)
// å®Œæˆï¼
```

### ç¤ºä¾‹2ï¼šç®¡ç†åå°

```go
admin := r.Group("/admin")
middleware.Apply(admin, jwtManager, middleware.MiddlewareConfig{
    RequireRole: []string{"super"},
})
```

### ç¤ºä¾‹3ï¼šå…¬å¼€+ç™»å½•æ··åˆ

```go
public := r.Group("/public")
middleware.Apply(public, jwtManager, middleware.MiddlewareConfig{
    Optional: true,
})
{
    public.GET("/articles", getArticles)     // æœªç™»å½•å¯è®¿é—®
    public.POST("/articles", createArticle)  // éœ€è¦ç™»å½•
}
```

### ç¤ºä¾‹4ï¼šå†…éƒ¨æœåŠ¡ï¼ˆä¸é€šè¿‡ç½‘å…³ï¼‰

```go
internal := r.Group("/internal")
middleware.Apply(internal, jwtManager, middleware.MiddlewareConfig{
    SupportGateway: false,
})
```

---

## ğŸ¯ æ€»ç»“

**ä¸€ä¸ªå‡½æ•° `middleware.Apply()`ï¼Œé€‚ç”¨äºæ‰€æœ‰åœºæ™¯ï¼**

- ä¸éœ€è¦è®°å¿†4ä¸ªä¸åŒçš„å‡½æ•°å
- ä¸éœ€è¦çº ç»“ç”¨å“ªä¸ª
- æ–°æœåŠ¡ä¸€è¡Œä»£ç æå®š

ç®€å•ã€ç»Ÿä¸€ã€æ˜“ç”¨ï¼âœ¨
