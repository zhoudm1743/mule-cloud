# ä¿®å¤ - ç§Ÿæˆ·æƒé™å®‰å…¨é—®é¢˜

## ğŸš¨ å®‰å…¨é—®é¢˜

**å‘ç°**ï¼šç§Ÿæˆ·ç®¡ç†å‘˜é»˜è®¤æ‹¥æœ‰äº†ä¸åº”è¯¥æœ‰çš„æƒé™ï¼š
- âŒ **èœå•ç®¡ç†** (`system_menu`) - å¯ä»¥ä¿®æ”¹ç³»ç»Ÿèœå•
- âŒ **ç§Ÿæˆ·ç®¡ç†** (`system_tenant`) - å¯ä»¥åˆ›å»º/åˆ é™¤ç§Ÿæˆ·

**å½±å“**ï¼š
- ç§Ÿæˆ·å¯ä»¥ä¿®æ”¹ç³»ç»Ÿçº§åˆ«çš„èœå•é…ç½®ï¼Œå½±å“æ‰€æœ‰ç§Ÿæˆ·
- ç§Ÿæˆ·å¯ä»¥åˆ›å»º/åˆ é™¤å…¶ä»–ç§Ÿæˆ·
- è¿åäº†å¤šç§Ÿæˆ·éš”ç¦»åŸåˆ™

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### æ­£ç¡®çš„æƒé™åˆ’åˆ†

#### ç³»ç»Ÿç®¡ç†å‘˜ä¸“å±ï¼ˆ`super` è§’è‰²ï¼‰
- âœ… æ‰€æœ‰èœå•å’ŒåŠŸèƒ½
- âœ… ç§Ÿæˆ·ç®¡ç†ï¼ˆåˆ›å»º/åˆ é™¤/ç¼–è¾‘ç§Ÿæˆ·ï¼‰
- âœ… èœå•ç®¡ç†ï¼ˆç³»ç»Ÿçº§åˆ«èœå•é…ç½®ï¼‰
- âœ… è·¨ç§Ÿæˆ·æ•°æ®æŸ¥çœ‹

#### ç§Ÿæˆ·ç®¡ç†å‘˜ï¼ˆ`tenant_admin` è§’è‰²ï¼‰
- âœ… ä»ªè¡¨ç›˜ï¼ˆ`dashboard`ï¼‰
- âœ… ç®¡ç†å‘˜ç®¡ç†ï¼ˆ`system_admin`ï¼‰- ä»…ç§Ÿæˆ·å†…ç”¨æˆ·
- âœ… è§’è‰²ç®¡ç†ï¼ˆ`system_role`ï¼‰- ä»…ç§Ÿæˆ·å†…è§’è‰²
- âŒ ~~èœå•ç®¡ç†~~ - ç§»é™¤
- âŒ ~~ç§Ÿæˆ·ç®¡ç†~~ - ç§»é™¤

---

## ğŸ”§ ä»£ç ä¿®å¤

### ä¿®æ”¹æ–‡ä»¶ï¼š`app/system/services/tenant.go`

**ä¿®æ”¹å‰ï¼ˆ167-182è¡Œï¼‰**ï¼š
```go
defaultMenus := []string{
    "dashboard",
    "system",
    "system_admin",
    "system_role",
    "system_menu",      // âŒ ä¸åº”è¯¥ç»™ç§Ÿæˆ·
    "system_tenant",    // âŒ ä¸åº”è¯¥ç»™ç§Ÿæˆ·
}

defaultMenuPermissions := map[string][]string{
    "system_admin":  {"read", "create", "update", "delete"},
    "system_role":   {"read", "create", "update", "delete", "menus"},
    "system_menu":   {"read", "create", "delete"},       // âŒ
    "system_tenant": {"read", "create", "update", "delete", "menus"}, // âŒ
}
```

**ä¿®æ”¹å**ï¼š
```go
// é»˜è®¤åˆ†é…ç§Ÿæˆ·ç®¡ç†å‘˜çš„èœå•ï¼ˆä¸åŒ…å«ç³»ç»Ÿçº§åˆ«èµ„æºï¼‰
defaultMenus := []string{
    "dashboard",     // ä»ªè¡¨ç›˜
    "system",        // ç³»ç»Ÿç®¡ç†ï¼ˆçˆ¶èœå•ï¼‰
    "system_admin",  // ç®¡ç†å‘˜ç®¡ç†ï¼ˆç§Ÿæˆ·å†…ï¼‰
    "system_role",   // è§’è‰²ç®¡ç†ï¼ˆç§Ÿæˆ·å†…ï¼‰
    // âŒ ä¸åŒ…å« system_menu (èœå•ç®¡ç†) - ç³»ç»Ÿç®¡ç†å‘˜ä¸“å±
    // âŒ ä¸åŒ…å« system_tenant (ç§Ÿæˆ·ç®¡ç†) - ç³»ç»Ÿç®¡ç†å‘˜ä¸“å±
}

// é»˜è®¤åˆ†é…èœå•çš„å®Œæ•´æƒé™ï¼ˆä»…ç§Ÿæˆ·å†…èµ„æºï¼‰
defaultMenuPermissions := map[string][]string{
    "system_admin": {"read", "create", "update", "delete"},
    "system_role":  {"read", "create", "update", "delete", "menus"},
    // âŒ ç§»é™¤ system_menu å’Œ system_tenant çš„æƒé™
}
```

---

## ğŸš€ åº”ç”¨ä¿®å¤

### æ–¹å¼1: é‡æ–°åˆ›å»ºç§Ÿæˆ·ï¼ˆæ¨èï¼‰

**å¯¹äºæ–°ç§Ÿæˆ·**ï¼š
1. é‡å¯ `system` æœåŠ¡
2. æ–°åˆ›å»ºçš„ç§Ÿæˆ·å°†è‡ªåŠ¨ä½¿ç”¨æ­£ç¡®çš„æƒé™é…ç½®

```powershell
# åœæ­¢ system æœåŠ¡ï¼ˆCtrl+Cï¼‰
# é‡æ–°å¯åŠ¨
go run cmd/system/main.go
```

### æ–¹å¼2: æ›´æ–°ç°æœ‰ç§Ÿæˆ·æƒé™

#### é€‰é¡¹A: é€šè¿‡å‰ç«¯æ‰‹åŠ¨ä¿®æ”¹ï¼ˆæ¨èï¼‰

1. **ç³»ç»Ÿç®¡ç†å‘˜ç™»å½•**
2. **åˆ‡æ¢åˆ°ç›®æ ‡ç§Ÿæˆ·**
3. **è¿›å…¥"è§’è‰²ç®¡ç†"**
4. **ç¼–è¾‘"ç§Ÿæˆ·ç®¡ç†å‘˜"è§’è‰²**
5. **å–æ¶ˆå‹¾é€‰**ï¼š
   - âŒ èœå•ç®¡ç†
   - âŒ ç§Ÿæˆ·ç®¡ç†
6. **ä¿å­˜**

#### é€‰é¡¹B: é€šè¿‡è„šæœ¬æ‰¹é‡ä¿®å¤

```powershell
# å¦‚æœ MongoDB å¯ä»¥è¿æ¥
py scripts/fix_tenant_permissions.py
```

**è„šæœ¬åŠŸèƒ½**ï¼š
- è‡ªåŠ¨æŸ¥æ‰¾ç§Ÿæˆ·æ•°æ®åº“ä¸­çš„ `tenant_admin` è§’è‰²
- ç§»é™¤ `system_menu` å’Œ `system_tenant`
- æ›´æ–°ä¸ºæ­£ç¡®çš„æƒé™é…ç½®

---

## ğŸ“Š éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. **ç”¨ç§Ÿæˆ·ç®¡ç†å‘˜ç™»å½•**
   - è´¦å·ï¼š`13838383388`
   - å¯†ç ï¼š`123456`
   - ç§Ÿæˆ·ï¼š`default`

2. **æ£€æŸ¥å·¦ä¾§èœå•**

**åº”è¯¥çœ‹åˆ°**ï¼š
```
âœ… Dashboard
âœ… ç³»ç»Ÿç®¡ç†
   âœ… ç®¡ç†å‘˜ç®¡ç†
   âœ… è§’è‰²ç®¡ç†
```

**ä¸åº”è¯¥çœ‹åˆ°**ï¼š
```
âŒ ç³»ç»Ÿç®¡ç†
   âŒ èœå•ç®¡ç†
   âŒ ç§Ÿæˆ·ç®¡ç†
```

3. **æŸ¥çœ‹ auth æœåŠ¡æ—¥å¿—**

ç™»å½•åï¼Œauth æœåŠ¡åº”è¯¥è¾“å‡ºï¼š
```
[è°ƒè¯•] è§’è‰² xxx çš„èœå•æ•°é‡: 4
[è°ƒè¯•]   1. dashboard (ä»ªè¡¨ç›˜)
[è°ƒè¯•]   2. system (ç³»ç»Ÿç®¡ç†)
[è°ƒè¯•]   3. system_admin (ç®¡ç†å‘˜ç®¡ç†)
[è°ƒè¯•]   4. system_role (è§’è‰²ç®¡ç†)
```

**ä¸åº”è¯¥å‡ºç°**ï¼š
- `system_menu`
- `system_tenant`

---

## ğŸ¯ å½±å“èŒƒå›´

### æ–°ç§Ÿæˆ·
- âœ… è‡ªåŠ¨ä½¿ç”¨æ­£ç¡®çš„æƒé™é…ç½®
- âœ… æ— éœ€é¢å¤–æ“ä½œ

### ç°æœ‰ç§Ÿæˆ·
éœ€è¦æ‰‹åŠ¨æ›´æ–°ï¼ˆä¸¤ç§æ–¹å¼ä»»é€‰å…¶ä¸€ï¼‰ï¼š
1. é€šè¿‡å‰ç«¯"è§’è‰²ç®¡ç†"ä¿®æ”¹
2. è¿è¡Œä¿®å¤è„šæœ¬

---

## ğŸ“ åç»­å»ºè®®

### 1. æƒé™å®¡è®¡

å®šæœŸæ£€æŸ¥ç§Ÿæˆ·è§’è‰²çš„æƒé™é…ç½®ï¼Œç¡®ä¿æ²¡æœ‰è¶Šæƒï¼š

```javascript
// MongoDB æŸ¥è¯¢
db.role.find({
    code: 'tenant_admin',
    $or: [
        {menus: 'system_menu'},
        {menus: 'system_tenant'}
    ]
})
```

### 2. å‰ç«¯è·¯ç”±å®ˆå«

å³ä½¿åç«¯é™åˆ¶äº†æƒé™ï¼Œå‰ç«¯ä¹Ÿåº”è¯¥åšäºŒæ¬¡æ ¡éªŒï¼š

```typescript
// frontend/src/router/guard.ts
// æ£€æŸ¥ç§Ÿæˆ·ç”¨æˆ·æ˜¯å¦è®¿é—®ç³»ç»Ÿçº§åˆ«è·¯ç”±
if (userInfo.tenant_id && systemLevelRoutes.includes(route.name)) {
    return { name: 'Forbidden' }
}
```

### 3. API æƒé™æ ¡éªŒ

åœ¨ `system` æœåŠ¡çš„èœå•å’Œç§Ÿæˆ·ç®¡ç† API ä¸­ï¼Œæ·»åŠ ç³»ç»Ÿç®¡ç†å‘˜æ£€æŸ¥ï¼š

```go
// åªå…è®¸ç³»ç»Ÿç®¡ç†å‘˜è®¿é—®
if !auth.IsSuperAdmin(ctx) {
    return nil, errors.New("æƒé™ä¸è¶³ï¼šéœ€è¦ç³»ç»Ÿç®¡ç†å‘˜æƒé™")
}
```

---

## âœ… ä¿®å¤å®Œæˆ

- âœ… ç§»é™¤äº†ç§Ÿæˆ·ç®¡ç†å‘˜å¯¹ç³»ç»Ÿçº§åˆ«èµ„æºçš„è®¿é—®æƒé™
- âœ… ä¿ç•™äº†ç§Ÿæˆ·å†…éƒ¨ç®¡ç†åŠŸèƒ½ï¼ˆç®¡ç†å‘˜ã€è§’è‰²ï¼‰
- âœ… ç¬¦åˆå¤šç§Ÿæˆ·éš”ç¦»åŸåˆ™
- âœ… æé«˜äº†ç³»ç»Ÿå®‰å…¨æ€§

**è¯·æŒ‰ä¸Šè¿°æ­¥éª¤éªŒè¯ä¿®å¤æ•ˆæœï¼** ğŸ‰
