# 修复 - 租户权限安全问题

## 🚨 安全问题

**发现**：租户管理员默认拥有了不应该有的权限：
- ❌ **菜单管理** (`system_menu`) - 可以修改系统菜单
- ❌ **租户管理** (`system_tenant`) - 可以创建/删除租户

**影响**：
- 租户可以修改系统级别的菜单配置，影响所有租户
- 租户可以创建/删除其他租户
- 违反了多租户隔离原则

---

## ✅ 修复方案

### 正确的权限划分

#### 系统管理员专属（`super` 角色）
- ✅ 所有菜单和功能
- ✅ 租户管理（创建/删除/编辑租户）
- ✅ 菜单管理（系统级别菜单配置）
- ✅ 跨租户数据查看

#### 租户管理员（`tenant_admin` 角色）
- ✅ 仪表盘（`dashboard`）
- ✅ 管理员管理（`system_admin`）- 仅租户内用户
- ✅ 角色管理（`system_role`）- 仅租户内角色
- ❌ ~~菜单管理~~ - 移除
- ❌ ~~租户管理~~ - 移除

---

## 🔧 代码修复

### 修改文件：`app/system/services/tenant.go`

**修改前（167-182行）**：
```go
defaultMenus := []string{
    "dashboard",
    "system",
    "system_admin",
    "system_role",
    "system_menu",      // ❌ 不应该给租户
    "system_tenant",    // ❌ 不应该给租户
}

defaultMenuPermissions := map[string][]string{
    "system_admin":  {"read", "create", "update", "delete"},
    "system_role":   {"read", "create", "update", "delete", "menus"},
    "system_menu":   {"read", "create", "delete"},       // ❌
    "system_tenant": {"read", "create", "update", "delete", "menus"}, // ❌
}
```

**修改后**：
```go
// 默认分配租户管理员的菜单（不包含系统级别资源）
defaultMenus := []string{
    "dashboard",     // 仪表盘
    "system",        // 系统管理（父菜单）
    "system_admin",  // 管理员管理（租户内）
    "system_role",   // 角色管理（租户内）
    // ❌ 不包含 system_menu (菜单管理) - 系统管理员专属
    // ❌ 不包含 system_tenant (租户管理) - 系统管理员专属
}

// 默认分配菜单的完整权限（仅租户内资源）
defaultMenuPermissions := map[string][]string{
    "system_admin": {"read", "create", "update", "delete"},
    "system_role":  {"read", "create", "update", "delete", "menus"},
    // ❌ 移除 system_menu 和 system_tenant 的权限
}
```

---

## 🚀 应用修复

### 方式1: 重新创建租户（推荐）

**对于新租户**：
1. 重启 `system` 服务
2. 新创建的租户将自动使用正确的权限配置

```powershell
# 停止 system 服务（Ctrl+C）
# 重新启动
go run cmd/system/main.go
```

### 方式2: 更新现有租户权限

#### 选项A: 通过前端手动修改（推荐）

1. **系统管理员登录**
2. **切换到目标租户**
3. **进入"角色管理"**
4. **编辑"租户管理员"角色**
5. **取消勾选**：
   - ❌ 菜单管理
   - ❌ 租户管理
6. **保存**

#### 选项B: 通过脚本批量修复

```powershell
# 如果 MongoDB 可以连接
py scripts/fix_tenant_permissions.py
```

**脚本功能**：
- 自动查找租户数据库中的 `tenant_admin` 角色
- 移除 `system_menu` 和 `system_tenant`
- 更新为正确的权限配置

---

## 📊 验证

### 测试步骤

1. **用租户管理员登录**
   - 账号：`13838383388`
   - 密码：`123456`
   - 租户：`default`

2. **检查左侧菜单**

**应该看到**：
```
✅ Dashboard
✅ 系统管理
   ✅ 管理员管理
   ✅ 角色管理
```

**不应该看到**：
```
❌ 系统管理
   ❌ 菜单管理
   ❌ 租户管理
```

3. **查看 auth 服务日志**

登录后，auth 服务应该输出：
```
[调试] 角色 xxx 的菜单数量: 4
[调试]   1. dashboard (仪表盘)
[调试]   2. system (系统管理)
[调试]   3. system_admin (管理员管理)
[调试]   4. system_role (角色管理)
```

**不应该出现**：
- `system_menu`
- `system_tenant`

---

## 🎯 影响范围

### 新租户
- ✅ 自动使用正确的权限配置
- ✅ 无需额外操作

### 现有租户
需要手动更新（两种方式任选其一）：
1. 通过前端"角色管理"修改
2. 运行修复脚本

---

## 📝 后续建议

### 1. 权限审计

定期检查租户角色的权限配置，确保没有越权：

```javascript
// MongoDB 查询
db.role.find({
    code: 'tenant_admin',
    $or: [
        {menus: 'system_menu'},
        {menus: 'system_tenant'}
    ]
})
```

### 2. 前端路由守卫

即使后端限制了权限，前端也应该做二次校验：

```typescript
// frontend/src/router/guard.ts
// 检查租户用户是否访问系统级别路由
if (userInfo.tenant_id && systemLevelRoutes.includes(route.name)) {
    return { name: 'Forbidden' }
}
```

### 3. API 权限校验

在 `system` 服务的菜单和租户管理 API 中，添加系统管理员检查：

```go
// 只允许系统管理员访问
if !auth.IsSuperAdmin(ctx) {
    return nil, errors.New("权限不足：需要系统管理员权限")
}
```

---

## ✅ 修复完成

- ✅ 移除了租户管理员对系统级别资源的访问权限
- ✅ 保留了租户内部管理功能（管理员、角色）
- ✅ 符合多租户隔离原则
- ✅ 提高了系统安全性

**请按上述步骤验证修复效果！** 🎉
