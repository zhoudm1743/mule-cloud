# 租户菜单权限调试指南

## 🔍 问题现象

用户报告：没有给租户分配"基础信息"菜单，但租户用户能看到。

## 📊 默认权限配置

### 创建租户时的默认菜单

**`app/system/services/tenant.go:167-174`**

```go
defaultMenus := []string{
    "dashboard",           // ✅ 仪表盘
    "system",              // ✅ 系统管理
    "system_admin",        // ✅ 管理员管理
    "system_role",         // ✅ 角色管理
    "system_menu",         // ✅ 菜单管理
    "system_tenant",       // ✅ 租户管理
}
```

**结论**: 默认**不包含**任何 basic 相关菜单（颜色、尺寸等）❌

---

## 🐛 可能的原因

### 1. 前端缓存

**检查方法**:
1. 打开浏览器 F12
2. Application → Local Storage
3. 查找 `routes` 或 `menus` 相关的缓存
4. 清除缓存，强制刷新（Ctrl+Shift+R）

### 2. 前端静态路由

**检查文件**: `frontend/src/router/routes.static.ts` 或 `routes.inner.ts`

如果前端有静态配置的路由，不依赖后端返回，则会始终显示。

### 3. 角色已被修改

用户可能已经通过"角色管理"页面，手动给租户管理员角色添加了 basic 相关菜单。

**检查方法**:
1. 登录系统管理员
2. 切换到该租户
3. 进入"系统管理 → 角色管理"
4. 编辑"租户管理员"角色
5. 查看"分配权限菜单"里是否勾选了 basic 相关菜单

---

## 🎯 调试步骤

### 步骤1: 检查后端返回的菜单

**在浏览器 F12 Network 中查看**:

1. 找到 `getUserRoutes` 请求
2. 查看 Response:
```json
{
  "code": 0,
  "data": {
    "routes": [
      // 这里应该只有 dashboard 和 system 相关的
      // 如果有 basic，说明角色已被修改
    ]
  }
}
```

### 步骤2: 添加日志

**在 `app/auth/services/auth.go` 中添加调试日志**:

```go
// 获取用户所有角色的菜单权限（合并去重）
menuMap := make(map[string]dto.RouteItem)
for _, roleID := range admin.Roles {
    menus, err := s.fetchRoleMenusFromSystem(ctx, roleID)
    if err != nil {
        fmt.Printf("警告: 获取角色 %s 菜单失败: %v\n", roleID, err)
        continue
    }
    
    // ✅ 添加这行日志
    fmt.Printf("[调试] 角色 %s 的菜单数量: %d\n", roleID, len(menus))
    for i, menu := range menus {
        fmt.Printf("[调试]   %d. %s (%s)\n", i+1, menu.Name, menu.Title)
    }
    
    for _, menu := range menus {
        menuMap[menu.ID] = menu
    }
}
```

### 步骤3: 查看后端日志

**重启 auth 服务后**:
```
go run cmd/auth/main.go
```

**登录租户用户，查看输出**:
```
[调试] 角色 xxx 的菜单数量: 6
[调试]   1. dashboard (仪表盘)
[调试]   2. system (系统管理)
[调试]   3. system_admin (管理员管理)
[调试]   4. system_role (角色管理)
[调试]   5. system_menu (菜单管理)
[调试]   6. system_tenant (租户管理)
```

如果看到 `basic`、`color` 等，说明角色已被修改。

---

## ✅ 解决方案

### 方案1: 重新创建租户

如果角色已被修改，最简单的方法：
1. 删除现有租户
2. 重新创建租户
3. 新创建的租户将使用默认权限

### 方案2: 手动修改角色权限

1. 系统管理员登录
2. 切换到该租户
3. 进入"角色管理"
4. 编辑"租户管理员"角色
5. 取消勾选 basic 相关菜单

### 方案3: 直接修改数据库（不推荐）

```javascript
// 连接到租户数据库
use mule_68dda6cd04ba0d6c8dda4b7a

// 查询租户管理员角色
db.role.find({code: 'tenant_admin'})

// 更新菜单列表（只保留系统管理相关）
db.role.updateOne(
  {code: 'tenant_admin'},
  {$set: {
    menus: [
      'dashboard',
      'system',
      'system_admin',
      'system_role',
      'system_menu',
      'system_tenant'
    ]
  }}
)
```

---

## 🎯 验证

修复后，租户用户应该只能看到：

```
侧边栏菜单:
├── Dashboard        ✅
└── 系统管理         ✅
    ├── 管理员管理   ✅
    ├── 角色管理     ✅
    ├── 菜单管理     ✅
    └── 租户管理     ✅

不应该看到:
├── 基础信息         ❌
│   ├── 颜色管理     ❌
│   ├── 尺码管理     ❌
│   └── ...
```

---

## 📝 需要的信息

请提供以下信息帮助调试：

1. **浏览器 F12 Network**
   - `getUserRoutes` 请求的完整响应

2. **是否修改过角色**
   - 是否通过"角色管理"修改过租户管理员角色？

3. **前端缓存**
   - 是否清除过浏览器缓存并强制刷新？

4. **是否是新创建的租户**
   - 还是旧租户（可能有历史数据）？

提供这些信息后，我可以更准确地定位问题！
