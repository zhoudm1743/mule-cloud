# 修复：超管切换租户后跳转登录页问题

## 问题现象

超管切换租户后，页面刷新并跳转到登录页，无法正常访问租户数据。

## 问题分析

### 日志分析

```
[租户上下文] X-Tenant-Context header: ''  ← 前端没有发送该 header
```

### 根本原因

在 `frontend/src/service/http/alova.ts` 的 HTTP 请求拦截器中：

```typescript
const userInfo = local.get('userInfo')
const selectedTenantCode = local.get('selected_tenant_code')

if (userInfo && !userInfo.tenant_id && selectedTenantCode) {
  method.config.headers['X-Tenant-Context'] = selectedTenantCode
}
```

问题：
1. **条件判断过于严格**：要求 `userInfo` 必须存在且已加载
2. **时序问题**：页面刷新后，`userInfo` 可能还未从 localStorage 恢复
3. **类型判断问题**：`!userInfo.tenant_id` 无法区分空字符串 `""` 和 undefined

## 修复方案

### 方案 1：简化条件判断（推荐）

修改 `frontend/src/service/http/alova.ts`：

```typescript
beforeRequest: onAuthRequired((method) => {
  if (method.meta?.isFormPost) {
    method.config.headers['Content-Type'] = 'application/x-www-form-urlencoded'
    method.data = new URLSearchParams(method.data as URLSearchParams).toString()
  }
  
  // ✅ 修复：简化租户上下文header的添加逻辑
  // 只要存在 selected_tenant_code，就添加 X-Tenant-Context header
  // 后端会验证用户是否有权限切换租户
  const selectedTenantCode = local.get('selected_tenant_code')
  if (selectedTenantCode) {
    method.config.headers['X-Tenant-Context'] = selectedTenantCode
  }
  
  alovaConfig.beforeRequest?.(method)
}),
```

**优点：**
- 逻辑简单，不依赖 `userInfo` 的加载状态
- 后端中间件会验证权限，前端只需传递 header
- 避免时序问题

### 方案 2：延迟加载 userInfo（备选）

如果需要保留前端验证，可以在 authStore 初始化时等待 userInfo 加载：

```typescript
// 在 beforeRequest 中等待 authStore 初始化
const authStore = useAuthStore()
const selectedTenantCode = local.get('selected_tenant_code')

// 只有系统管理员才能切换租户
if (authStore.userInfo && !authStore.userInfo.tenant_id && selectedTenantCode) {
  method.config.headers['X-Tenant-Context'] = selectedTenantCode
}
```

## 推荐修复代码

```typescript
// frontend/src/service/http/alova.ts

beforeRequest: onAuthRequired((method) => {
  if (method.meta?.isFormPost) {
    method.config.headers['Content-Type'] = 'application/x-www-form-urlencoded'
    method.data = new URLSearchParams(method.data as URLSearchParams).toString()
  }
  
  // ✅ 添加租户上下文 header（如果已选择租户）
  // 后端的 TenantContextMiddleware 会验证用户权限
  const selectedTenantCode = local.get('selected_tenant_code')
  if (selectedTenantCode) {
    method.config.headers['X-Tenant-Context'] = selectedTenantCode
  }
  
  alovaConfig.beforeRequest?.(method)
}),
```

## 修改的文件

1. `frontend/src/service/http/alova.ts` - 简化租户上下文 header 的添加逻辑

## 测试验证

修复后，测试步骤：

1. 以系统管理员身份登录
2. 在租户选择器中选择一个租户（如 "ace"）
3. 页面刷新后，检查：
   - ✅ 页面不会跳转到登录页
   - ✅ 请求 header 包含 `X-Tenant-Context: ace`
   - ✅ 查询结果来自租户数据库 `mule_ace`

打开浏览器开发者工具，查看网络请求：

```
Request Headers:
  Authorization: Bearer xxx...
  X-Tenant-Context: ace  ← 应该存在
```

后端日志应该显示：

```
[租户上下文切换] ✅ 系统管理员切换到租户: ace
[MongoDB] 执行命令: ... "$db": "mule_ace"}
```

## 为什么这个方案安全

有人可能担心：如果前端直接发送 `X-Tenant-Context`，普通租户管理员是否可以伪造该 header 访问其他租户数据？

**答案：不会，因为后端有验证！**

后端的 `TenantContextMiddleware` 会检查：

```go
// 只有系统管理员（tenantCode为空或"system"）可以切换租户上下文
if currentTenantCode == "" || currentTenantCode == "system" {
    // 检查是否有 super 角色
    if isSuperAdmin {
        // ✅ 允许切换
    } else {
        // ❌ 拒绝切换
    }
}
```

所以：
- ✅ 系统管理员（super 角色）：可以切换租户
- ❌ 普通租户管理员：即使发送 header 也会被拒绝

## 额外优化建议

如果需要更友好的用户体验，可以：

1. **显示切换状态**：在页面顶部显示当前正在管理的租户
2. **不刷新页面**：使用 Vue Router 的状态管理，而不是 `window.location.reload()`
3. **添加确认对话框**：切换租户前提示用户

示例代码（可选）：

```vue
<!-- TenantSelector.vue -->
async function onTenantChange(value: string) {
  // 保存选择的租户 Code
  local.set('selected_tenant_code', value)
  
  // 显示提示
  window.$message?.success(value ? `已切换到租户: ${value}` : '已切换到系统视图')
  
  // 方案1：刷新页面（当前方案）
  window.location.reload()
  
  // 方案2：不刷新，手动重新加载数据（更优雅，但需要更多改动）
  // await refreshCurrentPageData()
}
```

## 常见问题

### Q1: 为什么删除了 `userInfo` 的检查？

**A:** 因为：
1. 后端已经有权限验证，前端检查是冗余的
2. 避免时序问题（userInfo 可能还未加载）
3. 简化代码逻辑

### Q2: 普通租户管理员会不会滥用这个功能？

**A:** 不会。后端的 `TenantContextMiddleware` 会验证：
1. 用户的 tenantCode 必须是 "" 或 "system"
2. 用户必须有 "super" 角色

两个条件都满足才允许切换。

### Q3: 是否需要前端验证？

**A:** 不需要强制验证，但可以添加 UI 提示：
- 只有系统管理员才显示租户选择器
- 这已经在 `isSystemAdmin` computed 中实现了

## 总结

这是一个典型的前端时序问题：
- 页面刷新后，HTTP 拦截器立即执行
- 但 `userInfo` 可能还未从 localStorage 恢复
- 导致条件判断失败，没有添加 `X-Tenant-Context` header

修复方案是简化逻辑：
- ✅ 只检查 `selected_tenant_code` 是否存在
- ✅ 将权限验证交给后端处理
- ✅ 避免依赖前端状态的加载顺序

