# 工作流高级功能快速开始 🚀

## 立即体验

### 1️⃣ 启动服务

```bash
# 启动order服务（工作流API已集成）
./start.ps1
```

### 2️⃣ 访问工作流可视化

#### 方式一：通过菜单（推荐）
在后台管理系统的菜单管理中添加：
- 菜单名称: `工作流管理`
- 路由路径: `/order/workflow`
- 组件路径: `views/order/workflow/index.vue`
- 父菜单: 订单管理
- 图标: `carbon:flow`

#### 方式二：直接访问
在浏览器中输入：
```
http://localhost:3000/#/order/workflow
```

### 3️⃣ 快速测试API

#### 获取工作流定义
```bash
curl -X GET http://localhost:8005/admin/order/workflow/definition \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### 查询订单状态
```bash
curl -X GET http://localhost:8005/admin/order/workflow/orders/ORDER_ID/status \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### 回滚订单状态
```bash
curl -X POST http://localhost:8005/admin/order/workflow/rollback \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "order_id": "ORDER_ID",
    "reason": "误操作，需要回滚"
  }'
```

## 🎯 核心功能速览

### ✨ 功能1：工作流可视化
- 📊 **Mermaid流程图**: 自动生成订单状态流程图
- 📝 **状态说明**: 展示所有状态和转换规则
- 🔍 **实时查询**: 查看任意订单的当前状态和历史

**访问**: 工作流管理页面 → 工作流可视化

### ✨ 功能2：条件转换规则
- ✅ **进度校验**: 完成订单时自动检查进度是否达到100%
- 🔐 **权限控制**: 取消订单需要admin角色权限
- 🎯 **自定义规则**: 可扩展添加任意业务条件

**使用**: 
```javascript
// 前端调用示例
import { transitionOrder } from '@/service/api/workflow'

await transitionOrder({
  order_id: '68e48c19b4eb03ee2a2b8dcd',
  event: 'complete',
  reason: '所有工序已完成',
  metadata: {
    progress: 1.0  // 进度100%
  }
})
```

### ✨ 功能3：状态回滚
- ⏪ **一键回滚**: 撤销错误的状态转换
- 📋 **回滚记录**: 完整的回滚历史追踪
- 🛡️ **安全限制**: 已完成/已取消的订单不允许回滚

**使用**:
```javascript
// 前端调用示例
import { rollbackOrder } from '@/service/api/workflow'

await rollbackOrder({
  order_id: '68e48c19b4eb03ee2a2b8dcd',
  reason: '误操作，需要回滚到生产中状态'
})
```

**访问**: 工作流管理页面 → 订单状态查询 → 回滚状态按钮

## 📝 实战示例

### 示例1：完成订单时的进度校验

**场景**: 订单进度只有85%，用户尝试完成订单

**操作**:
```bash
curl -X POST http://localhost:8005/admin/order/workflow/transition \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "order_id": "68e48c19b4eb03ee2a2b8dcd",
    "event": "complete",
    "metadata": {
      "progress": 0.85
    }
  }'
```

**结果**:
```json
{
  "code": 500,
  "msg": "状态转换失败: 进度不足：当前85.0%，需要100%"
}
```

### 示例2：误操作回滚

**场景**: 生产主管误将订单标记为已完成

**步骤1**: 查看当前状态
```bash
curl -X GET http://localhost:8005/admin/order/workflow/orders/68e48c19b4eb03ee2a2b8dcd/status
```

**步骤2**: 执行回滚
```bash
curl -X POST http://localhost:8005/admin/order/workflow/rollback \
  -H "Content-Type: application/json" \
  -d '{
    "order_id": "68e48c19b4eb03ee2a2b8dcd",
    "reason": "误操作，订单还有质检未完成"
  }'
```

**步骤3**: 验证回滚
```bash
curl -X GET http://localhost:8005/admin/order/workflow/orders/68e48c19b4eb03ee2a2b8dcd/rollbacks
```

### 示例3：查看完整历史

**操作**:
```bash
# 获取状态历史
curl -X GET http://localhost:8005/admin/order/workflow/orders/68e48c19b4eb03ee2a2b8dcd/history?limit=20

# 获取回滚历史
curl -X GET http://localhost:8005/admin/order/workflow/orders/68e48c19b4eb03ee2a2b8dcd/rollbacks?limit=10
```

**前端展示**: 工作流管理页面会以时间线形式展示所有历史记录

## 🎨 前端集成示例

### 在订单列表页添加工作流入口

编辑 `frontend/src/views/order/orders/index.vue`:

```vue
<template>
  <NSpace vertical size="large">
    <!-- 页面顶部添加快捷入口 -->
    <NSpace>
      <NButton type="primary" @click="handleCreateOrder">
        新增订单
      </NButton>
      <NButton type="info" @click="$router.push('/order/workflow')">
        <template #icon>
          <Icon icon="carbon:flow" />
        </template>
        工作流管理
      </NButton>
    </NSpace>
    
    <!-- 现有订单列表 -->
    <!-- ... -->
  </NSpace>
</template>
```

### 在订单详情页添加状态历史

```vue
<script setup lang="ts">
import { fetchOrderHistory } from '@/service/api/workflow'

// 加载状态历史
async function loadStatusHistory(orderId: string) {
  const { data } = await fetchOrderHistory(orderId)
  // 展示历史记录
}
</script>

<template>
  <NCard title="状态历史">
    <NTimeline>
      <NTimelineItem
        v-for="item in history"
        :key="item.timestamp"
        :title="`${item.from_state} → ${item.to_state}`"
      >
        {{ item.reason }}
      </NTimelineItem>
    </NTimeline>
  </NCard>
</template>
```

## 🔧 常见问题

### Q1: 如何添加新的转换条件？
**A**: 编辑 `core/workflow/order_workflow_advanced.go`，在 `advancedTransitions` 中添加规则。

### Q2: 回滚失败？
**A**: 检查订单状态，已完成和已取消的订单不允许回滚。

### Q3: 权限不足？
**A**: 取消订单等敏感操作需要admin角色权限。

### Q4: 前端页面不显示？
**A**: 确保在后台菜单管理中正确配置了路由。

## 📚 更多文档

- [订单工作流高级功能说明.md](./订单工作流高级功能说明.md) - 完整的功能说明和API文档
- [订单工作流系统说明.md](./订单工作流系统说明.md) - 基础工作流系统文档

## 🎉 开始使用

1. ✅ 启动 `order` 服务
2. ✅ 配置前端菜单
3. ✅ 访问工作流管理页面
4. ✅ 体验可视化、条件校验、状态回滚功能

祝您使用愉快！ 🚀

