# å·¥ä½œæµé«˜çº§åŠŸèƒ½å¿«é€Ÿå¼€å§‹ ğŸš€

## ç«‹å³ä½“éªŒ

### 1ï¸âƒ£ å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨orderæœåŠ¡ï¼ˆå·¥ä½œæµAPIå·²é›†æˆï¼‰
./start.ps1
```

### 2ï¸âƒ£ è®¿é—®å·¥ä½œæµå¯è§†åŒ–

#### æ–¹å¼ä¸€ï¼šé€šè¿‡èœå•ï¼ˆæ¨èï¼‰
åœ¨åå°ç®¡ç†ç³»ç»Ÿçš„èœå•ç®¡ç†ä¸­æ·»åŠ ï¼š
- èœå•åç§°: `å·¥ä½œæµç®¡ç†`
- è·¯ç”±è·¯å¾„: `/order/workflow`
- ç»„ä»¶è·¯å¾„: `views/order/workflow/index.vue`
- çˆ¶èœå•: è®¢å•ç®¡ç†
- å›¾æ ‡: `carbon:flow`

#### æ–¹å¼äºŒï¼šç›´æ¥è®¿é—®
åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ï¼š
```
http://localhost:3000/#/order/workflow
```

### 3ï¸âƒ£ å¿«é€Ÿæµ‹è¯•API

#### è·å–å·¥ä½œæµå®šä¹‰
```bash
curl -X GET http://localhost:8005/admin/order/workflow/definition \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### æŸ¥è¯¢è®¢å•çŠ¶æ€
```bash
curl -X GET http://localhost:8005/admin/order/workflow/orders/ORDER_ID/status \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### å›æ»šè®¢å•çŠ¶æ€
```bash
curl -X POST http://localhost:8005/admin/order/workflow/rollback \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "order_id": "ORDER_ID",
    "reason": "è¯¯æ“ä½œï¼Œéœ€è¦å›æ»š"
  }'
```

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½é€Ÿè§ˆ

### âœ¨ åŠŸèƒ½1ï¼šå·¥ä½œæµå¯è§†åŒ–
- ğŸ“Š **Mermaidæµç¨‹å›¾**: è‡ªåŠ¨ç”Ÿæˆè®¢å•çŠ¶æ€æµç¨‹å›¾
- ğŸ“ **çŠ¶æ€è¯´æ˜**: å±•ç¤ºæ‰€æœ‰çŠ¶æ€å’Œè½¬æ¢è§„åˆ™
- ğŸ” **å®æ—¶æŸ¥è¯¢**: æŸ¥çœ‹ä»»æ„è®¢å•çš„å½“å‰çŠ¶æ€å’Œå†å²

**è®¿é—®**: å·¥ä½œæµç®¡ç†é¡µé¢ â†’ å·¥ä½œæµå¯è§†åŒ–

### âœ¨ åŠŸèƒ½2ï¼šæ¡ä»¶è½¬æ¢è§„åˆ™
- âœ… **è¿›åº¦æ ¡éªŒ**: å®Œæˆè®¢å•æ—¶è‡ªåŠ¨æ£€æŸ¥è¿›åº¦æ˜¯å¦è¾¾åˆ°100%
- ğŸ” **æƒé™æ§åˆ¶**: å–æ¶ˆè®¢å•éœ€è¦adminè§’è‰²æƒé™
- ğŸ¯ **è‡ªå®šä¹‰è§„åˆ™**: å¯æ‰©å±•æ·»åŠ ä»»æ„ä¸šåŠ¡æ¡ä»¶

**ä½¿ç”¨**: 
```javascript
// å‰ç«¯è°ƒç”¨ç¤ºä¾‹
import { transitionOrder } from '@/service/api/workflow'

await transitionOrder({
  order_id: '68e48c19b4eb03ee2a2b8dcd',
  event: 'complete',
  reason: 'æ‰€æœ‰å·¥åºå·²å®Œæˆ',
  metadata: {
    progress: 1.0  // è¿›åº¦100%
  }
})
```

### âœ¨ åŠŸèƒ½3ï¼šçŠ¶æ€å›æ»š
- âª **ä¸€é”®å›æ»š**: æ’¤é”€é”™è¯¯çš„çŠ¶æ€è½¬æ¢
- ğŸ“‹ **å›æ»šè®°å½•**: å®Œæ•´çš„å›æ»šå†å²è¿½è¸ª
- ğŸ›¡ï¸ **å®‰å…¨é™åˆ¶**: å·²å®Œæˆ/å·²å–æ¶ˆçš„è®¢å•ä¸å…è®¸å›æ»š

**ä½¿ç”¨**:
```javascript
// å‰ç«¯è°ƒç”¨ç¤ºä¾‹
import { rollbackOrder } from '@/service/api/workflow'

await rollbackOrder({
  order_id: '68e48c19b4eb03ee2a2b8dcd',
  reason: 'è¯¯æ“ä½œï¼Œéœ€è¦å›æ»šåˆ°ç”Ÿäº§ä¸­çŠ¶æ€'
})
```

**è®¿é—®**: å·¥ä½œæµç®¡ç†é¡µé¢ â†’ è®¢å•çŠ¶æ€æŸ¥è¯¢ â†’ å›æ»šçŠ¶æ€æŒ‰é’®

## ğŸ“ å®æˆ˜ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šå®Œæˆè®¢å•æ—¶çš„è¿›åº¦æ ¡éªŒ

**åœºæ™¯**: è®¢å•è¿›åº¦åªæœ‰85%ï¼Œç”¨æˆ·å°è¯•å®Œæˆè®¢å•

**æ“ä½œ**:
```bash
curl -X POST http://localhost:8005/admin/order/workflow/transition \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "order_id": "68e48c19b4eb03ee2a2b8dcd",
    "event": "complete",
    "metadata": {
      "progress": 0.85
    }
  }'
```

**ç»“æœ**:
```json
{
  "code": 500,
  "msg": "çŠ¶æ€è½¬æ¢å¤±è´¥: è¿›åº¦ä¸è¶³ï¼šå½“å‰85.0%ï¼Œéœ€è¦100%"
}
```

### ç¤ºä¾‹2ï¼šè¯¯æ“ä½œå›æ»š

**åœºæ™¯**: ç”Ÿäº§ä¸»ç®¡è¯¯å°†è®¢å•æ ‡è®°ä¸ºå·²å®Œæˆ

**æ­¥éª¤1**: æŸ¥çœ‹å½“å‰çŠ¶æ€
```bash
curl -X GET http://localhost:8005/admin/order/workflow/orders/68e48c19b4eb03ee2a2b8dcd/status
```

**æ­¥éª¤2**: æ‰§è¡Œå›æ»š
```bash
curl -X POST http://localhost:8005/admin/order/workflow/rollback \
  -H "Content-Type: application/json" \
  -d '{
    "order_id": "68e48c19b4eb03ee2a2b8dcd",
    "reason": "è¯¯æ“ä½œï¼Œè®¢å•è¿˜æœ‰è´¨æ£€æœªå®Œæˆ"
  }'
```

**æ­¥éª¤3**: éªŒè¯å›æ»š
```bash
curl -X GET http://localhost:8005/admin/order/workflow/orders/68e48c19b4eb03ee2a2b8dcd/rollbacks
```

### ç¤ºä¾‹3ï¼šæŸ¥çœ‹å®Œæ•´å†å²

**æ“ä½œ**:
```bash
# è·å–çŠ¶æ€å†å²
curl -X GET http://localhost:8005/admin/order/workflow/orders/68e48c19b4eb03ee2a2b8dcd/history?limit=20

# è·å–å›æ»šå†å²
curl -X GET http://localhost:8005/admin/order/workflow/orders/68e48c19b4eb03ee2a2b8dcd/rollbacks?limit=10
```

**å‰ç«¯å±•ç¤º**: å·¥ä½œæµç®¡ç†é¡µé¢ä¼šä»¥æ—¶é—´çº¿å½¢å¼å±•ç¤ºæ‰€æœ‰å†å²è®°å½•

## ğŸ¨ å‰ç«¯é›†æˆç¤ºä¾‹

### åœ¨è®¢å•åˆ—è¡¨é¡µæ·»åŠ å·¥ä½œæµå…¥å£

ç¼–è¾‘ `frontend/src/views/order/orders/index.vue`:

```vue
<template>
  <NSpace vertical size="large">
    <!-- é¡µé¢é¡¶éƒ¨æ·»åŠ å¿«æ·å…¥å£ -->
    <NSpace>
      <NButton type="primary" @click="handleCreateOrder">
        æ–°å¢è®¢å•
      </NButton>
      <NButton type="info" @click="$router.push('/order/workflow')">
        <template #icon>
          <Icon icon="carbon:flow" />
        </template>
        å·¥ä½œæµç®¡ç†
      </NButton>
    </NSpace>
    
    <!-- ç°æœ‰è®¢å•åˆ—è¡¨ -->
    <!-- ... -->
  </NSpace>
</template>
```

### åœ¨è®¢å•è¯¦æƒ…é¡µæ·»åŠ çŠ¶æ€å†å²

```vue
<script setup lang="ts">
import { fetchOrderHistory } from '@/service/api/workflow'

// åŠ è½½çŠ¶æ€å†å²
async function loadStatusHistory(orderId: string) {
  const { data } = await fetchOrderHistory(orderId)
  // å±•ç¤ºå†å²è®°å½•
}
</script>

<template>
  <NCard title="çŠ¶æ€å†å²">
    <NTimeline>
      <NTimelineItem
        v-for="item in history"
        :key="item.timestamp"
        :title="`${item.from_state} â†’ ${item.to_state}`"
      >
        {{ item.reason }}
      </NTimelineItem>
    </NTimeline>
  </NCard>
</template>
```

## ğŸ”§ å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•æ·»åŠ æ–°çš„è½¬æ¢æ¡ä»¶ï¼Ÿ
**A**: ç¼–è¾‘ `core/workflow/order_workflow_advanced.go`ï¼Œåœ¨ `advancedTransitions` ä¸­æ·»åŠ è§„åˆ™ã€‚

### Q2: å›æ»šå¤±è´¥ï¼Ÿ
**A**: æ£€æŸ¥è®¢å•çŠ¶æ€ï¼Œå·²å®Œæˆå’Œå·²å–æ¶ˆçš„è®¢å•ä¸å…è®¸å›æ»šã€‚

### Q3: æƒé™ä¸è¶³ï¼Ÿ
**A**: å–æ¶ˆè®¢å•ç­‰æ•æ„Ÿæ“ä½œéœ€è¦adminè§’è‰²æƒé™ã€‚

### Q4: å‰ç«¯é¡µé¢ä¸æ˜¾ç¤ºï¼Ÿ
**A**: ç¡®ä¿åœ¨åå°èœå•ç®¡ç†ä¸­æ­£ç¡®é…ç½®äº†è·¯ç”±ã€‚

## ğŸ“š æ›´å¤šæ–‡æ¡£

- [è®¢å•å·¥ä½œæµé«˜çº§åŠŸèƒ½è¯´æ˜.md](./è®¢å•å·¥ä½œæµé«˜çº§åŠŸèƒ½è¯´æ˜.md) - å®Œæ•´çš„åŠŸèƒ½è¯´æ˜å’ŒAPIæ–‡æ¡£
- [è®¢å•å·¥ä½œæµç³»ç»Ÿè¯´æ˜.md](./è®¢å•å·¥ä½œæµç³»ç»Ÿè¯´æ˜.md) - åŸºç¡€å·¥ä½œæµç³»ç»Ÿæ–‡æ¡£

## ğŸ‰ å¼€å§‹ä½¿ç”¨

1. âœ… å¯åŠ¨ `order` æœåŠ¡
2. âœ… é…ç½®å‰ç«¯èœå•
3. âœ… è®¿é—®å·¥ä½œæµç®¡ç†é¡µé¢
4. âœ… ä½“éªŒå¯è§†åŒ–ã€æ¡ä»¶æ ¡éªŒã€çŠ¶æ€å›æ»šåŠŸèƒ½

ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼ ğŸš€

