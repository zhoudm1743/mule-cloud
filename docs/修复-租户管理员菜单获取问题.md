# ä¿®å¤ - ç§Ÿæˆ·ç®¡ç†å‘˜èœå•è·å–é—®é¢˜

## ğŸ› é—®é¢˜æè¿°

### ç°è±¡

åˆ›å»ºç§Ÿæˆ·æ—¶åˆ†é…äº†èœå•æƒé™ï¼ˆä¾‹å¦‚ï¼šDashboardã€åŸºç¡€ä¿¡æ¯ã€æƒé™ç®¡ç†ï¼‰ï¼Œä½†ç§Ÿæˆ·ç®¡ç†å‘˜ç™»å½•åï¼š
- âŒ åªèƒ½çœ‹åˆ°éƒ¨åˆ†èœå•ï¼ˆç®¡ç†å‘˜ç®¡ç†ã€è§’è‰²ç®¡ç†ï¼‰
- âŒ çœ‹ä¸åˆ°åŸºç¡€ä¿¡æ¯ç›¸å…³èœå•ï¼ˆé¢œè‰²ã€å°ºç ã€å·¥åºç­‰ï¼‰
- âŒ çˆ¶çº§èœå•ä¹Ÿä¸æ˜¾ç¤º

### æˆªå›¾è¯æ®

**åˆ†é…æƒé™èœå•**ï¼š
- âœ… Dashboard
- âœ… åŸºç¡€ä¿¡æ¯ï¼ˆé¢œè‰²ã€å°ºç ã€å·¥åºã€å®¢æˆ·ã€ä¸šåŠ¡å‘˜ã€è®¢å•ç±»å‹ï¼‰
- âœ… æƒé™ç®¡ç†ï¼ˆç®¡ç†å‘˜ç®¡ç†ã€è§’è‰²ç®¡ç†ï¼‰

**å®é™…æ˜¾ç¤º**ï¼š
- âœ… ä»ªè¡¨ç›˜
- âœ… ç®¡ç†å‘˜ç®¡ç†
- âœ… è§’è‰²ç®¡ç†
- âŒ åŸºç¡€ä¿¡æ¯ï¼ˆæ•´ä¸ªçˆ¶çº§èœå•åŠå­èœå•éƒ½ä¸è§äº†ï¼‰

---

## ğŸ” é—®é¢˜åŸå› 

### ä»£ç åˆ†æ

åœ¨ `app/auth/services/auth.go` çš„ `GetUserRoutes` æ–¹æ³•ä¸­ï¼š

```go
// âŒ é”™è¯¯ä»£ç 
tenantID := tenantCtx.GetTenantID(ctx)
if tenantID != "" {
    // ...
    tenant, err := s.tenantRepo.Get(context.Background(), tenantID)
    // ...
}
```

### æ ¹æœ¬åŸå› 

1. **Context ä¸­å­˜å‚¨çš„å€¼å·²å˜åŒ–**
   - ä¹‹å‰æ”¹é€ åï¼ŒContext ä¸­å­˜å‚¨çš„æ˜¯ `tenant_code`ï¼ˆå¦‚ "default"ã€"ace"ï¼‰
   - ä½†è¿™é‡Œä»ç„¶ä½¿ç”¨ `GetTenantID(ctx)` è·å–å€¼

2. **Repository æ–¹æ³•ä¸åŒ¹é…**
   - `Get(id)` æ–¹æ³•éœ€è¦çš„æ˜¯ MongoDB ObjectID
   - ä½†ä¼ å…¥çš„æ˜¯ `tenant_code`ï¼ˆå­—ç¬¦ä¸² "ace"ï¼‰
   - æŸ¥è¯¢å¤±è´¥ï¼Œæ— æ³•è·å–ç§Ÿæˆ·çš„èœå•åˆ—è¡¨

3. **å¯¼è‡´é€»è¾‘ä¸­æ–­**
   - æŸ¥è¯¢ç§Ÿæˆ·å¤±è´¥
   - `tenant.Menus` ä¸ºç©º
   - æœ€ç»ˆè¿”å›ç©ºèœå•æˆ–é»˜è®¤èœå•

---

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®æ”¹å†…å®¹

```go
// âœ… æ­£ç¡®ä»£ç 
tenantCode := tenantCtx.GetTenantCode(ctx)  // ä½¿ç”¨ GetTenantCode
if tenantCode != "" {
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ç§Ÿæˆ·ç®¡ç†å‘˜è§’è‰²
    for _, roleID := range admin.Roles {
        role, err := s.roleRepo.Get(ctx, roleID)
        if err == nil && role != nil && role.Code == "tenant_admin" {
            logger.Info("ç§Ÿæˆ·ç®¡ç†å‘˜ç™»å½•ï¼Œè¿”å›ç§Ÿæˆ·æ‰€æœ‰èœå•", 
                zap.String("user_id", userID),
                zap.String("tenant_code", tenantCode))  // æ·»åŠ æ—¥å¿—

            // âœ… ä½¿ç”¨ GetByCode æŸ¥è¯¢ç§Ÿæˆ·
            tenant, err := s.tenantRepo.GetByCode(context.Background(), tenantCode)
            if err != nil || tenant == nil {
                logger.Error("è·å–ç§Ÿæˆ·ä¿¡æ¯å¤±è´¥", zap.Error(err))
                break
            }

            // ...åç»­é€»è¾‘ä¸å˜
            
            logger.Info("ç§Ÿæˆ·ç®¡ç†å‘˜èœå•",
                zap.String("tenant_code", tenantCode),
                zap.Strings("tenant_menus", tenant.Menus),  // è¾“å‡ºç§Ÿæˆ·èœå•åˆ—è¡¨
                zap.Int("original_count", len(tenant.Menus)),
                zap.Int("completed_count", len(tenantMenus)))
            
            return &dto.GetUserRoutesResponse{
                Routes: tenantMenus,
            }, nil
        }
    }
}
```

### å…³é”®æ”¹è¿›

1. **ä½¿ç”¨æ­£ç¡®çš„ Context è·å–æ–¹æ³•**
   ```go
   tenantCode := tenantCtx.GetTenantCode(ctx)  // è€Œä¸æ˜¯ GetTenantID
   ```

2. **ä½¿ç”¨æ­£ç¡®çš„ Repository æ–¹æ³•**
   ```go
   tenant, err := s.tenantRepo.GetByCode(context.Background(), tenantCode)  // è€Œä¸æ˜¯ Get
   ```

3. **å¢å¼ºæ—¥å¿—è¾“å‡º**
   - è¾“å‡º `tenant_code`
   - è¾“å‡ºç§Ÿæˆ·åˆ†é…çš„èœå•åˆ—è¡¨ `tenant.Menus`
   - ä¾¿äºè°ƒè¯•é—®é¢˜

---

## ğŸ¯ æ•°æ®æµå¯¹æ¯”

### ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰

```
1. GetUserRoutes è°ƒç”¨
   â†“
2. tenantID = GetTenantID(ctx)  â†’ è¿”å› "ace" (å®é™…æ˜¯ code)
   â†“
3. tenant = Get("ace")  â†’ æŸ¥è¯¢å¤±è´¥ï¼ˆace ä¸æ˜¯æœ‰æ•ˆçš„ ObjectIDï¼‰
   â†“
4. tenant = nil
   â†“
5. æ— æ³•è·å– tenant.Menus
   â†“
6. è¿”å›ç©ºèœå•æˆ–é»˜è®¤èœå• âŒ
```

### ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰

```
1. GetUserRoutes è°ƒç”¨
   â†“
2. tenantCode = GetTenantCode(ctx)  â†’ è¿”å› "ace"
   â†“
3. tenant = GetByCode("ace")  â†’ æŸ¥è¯¢æˆåŠŸ âœ…
   â†“
4. tenant.Menus = ["Dashboard", "basic_color", "basic_size", ...]
   â†“
5. é€’å½’æ·»åŠ çˆ¶çº§èœå•
   â†“
6. è¿”å›å®Œæ•´çš„èœå•æ ‘ âœ…
```

---

## ğŸ“Š ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªé—®é¢˜ï¼Ÿ

### å†å²åŸå› 

1. **åŸå§‹è®¾è®¡**
   - Context ä¸­å­˜å‚¨çš„æ˜¯ `tenant_id`ï¼ˆMongoDB ObjectIDï¼‰
   - ä½¿ç”¨ `Get(tenant_id)` æŸ¥è¯¢ç§Ÿæˆ·

2. **æ•°æ®åº“å‘½åæ”¹é€ **
   - ä¸ºäº†ä½¿ç”¨è¯­ä¹‰åŒ–çš„æ•°æ®åº“åï¼ˆ`mule_default` è€Œä¸æ˜¯ `mule_68e27...`ï¼‰
   - Context ä¸­æ”¹ä¸ºå­˜å‚¨ `tenant_code`
   - JWT Claims æ·»åŠ äº† `tenant_code` å­—æ®µ

3. **éƒ¨åˆ†ä»£ç æœªæ›´æ–°**
   - ç™»å½•æ—¶æ­£ç¡®ä½¿ç”¨äº† `WithTenantCode`
   - ä½† `GetUserRoutes` ä¸­ä»ç„¶ä½¿ç”¨æ—§çš„é€»è¾‘
   - å¯¼è‡´ç§Ÿæˆ·æŸ¥è¯¢å¤±è´¥

---

## ğŸ” å¦‚ä½•éªŒè¯ä¿®å¤

### 1. æŸ¥çœ‹æ—¥å¿—

é‡å¯æœåŠ¡åï¼Œç§Ÿæˆ·ç®¡ç†å‘˜ç™»å½•ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š

```
2025-10-06T00:00:00  INFO  ç§Ÿæˆ·ç®¡ç†å‘˜ç™»å½•ï¼Œè¿”å›ç§Ÿæˆ·æ‰€æœ‰èœå•
    {"user_id": "123", "tenant_code": "ace"}

2025-10-06T00:00:01  INFO  ç§Ÿæˆ·ç®¡ç†å‘˜èœå•
    {"tenant_code": "ace", 
     "tenant_menus": ["Dashboard", "basic_info", "basic_color", "basic_size", ...],
     "original_count": 10, 
     "completed_count": 15}
```

### 2. å‰ç«¯éªŒè¯

ç™»å½•ååº”è¯¥èƒ½çœ‹åˆ°ï¼š
- âœ… ä»ªè¡¨ç›˜ï¼ˆDashboardï¼‰
- âœ… åŸºç¡€ä¿¡æ¯ï¼ˆçˆ¶çº§èœå•ï¼‰
  - âœ… é¢œè‰²
  - âœ… å°ºç 
  - âœ… å·¥åº
  - âœ… å®¢æˆ·
  - âœ… ä¸šåŠ¡å‘˜
  - âœ… è®¢å•ç±»å‹
- âœ… æƒé™ç®¡ç†ï¼ˆçˆ¶çº§èœå•ï¼‰
  - âœ… ç®¡ç†å‘˜ç®¡ç†
  - âœ… è§’è‰²ç®¡ç†

### 3. æ•°æ®åº“éªŒè¯

æŸ¥çœ‹ç§Ÿæˆ·æ•°æ®ï¼š

```javascript
// MongoDB
db.tenant.findOne({code: "ace"})

// åº”è¯¥çœ‹åˆ°
{
  "_id": ObjectId("..."),
  "code": "ace",
  "name": "ACEç§Ÿæˆ·",
  "menus": [
    "Dashboard",
    "basic_color",      // é¢œè‰²
    "basic_size",       // å°ºç 
    "basic_procedure",  // å·¥åº
    "basic_customer",   // å®¢æˆ·
    "basic_salesman",   // ä¸šåŠ¡å‘˜
    "basic_order_type", // è®¢å•ç±»å‹
    "perms_admin",      // ç®¡ç†å‘˜ç®¡ç†
    "perms_role"        // è§’è‰²ç®¡ç†
  ]
}
```

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶

- âœ… `app/auth/services/auth.go`
  - ä¿®æ”¹ `GetUserRoutes` æ–¹æ³•
  - ä½¿ç”¨ `GetTenantCode(ctx)` è·å–ç§Ÿæˆ·ä»£ç 
  - ä½¿ç”¨ `GetByCode(tenantCode)` æŸ¥è¯¢ç§Ÿæˆ·
  - å¢å¼ºæ—¥å¿—è¾“å‡º

---

## ğŸ‰ ä¿®å¤å®Œæˆ

### ç¼–è¯‘éªŒè¯

```bash
âœ… go build ./cmd/auth
```

### æ•ˆæœ

- âœ… ç§Ÿæˆ·ç®¡ç†å‘˜èƒ½çœ‹åˆ°æ‰€æœ‰åˆ†é…çš„èœå•
- âœ… çˆ¶çº§èœå•æ­£ç¡®æ˜¾ç¤º
- âœ… èœå•æ ‘å½¢ç»“æ„å®Œæ•´
- âœ… æ—¥å¿—è¾“å‡ºæ¸…æ™°ï¼Œä¾¿äºè°ƒè¯•

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [ç§Ÿæˆ· Code æ•°æ®åº“å‘½åæ–¹æ¡ˆ](å®Œæˆ-ç§Ÿæˆ·Codeæ•°æ®åº“å‘½åæ–¹æ¡ˆ.md)
- [ç§Ÿæˆ·ç®¡ç†å‘˜èœå•ç¼ºå°‘çˆ¶çº§](ä¿®å¤-ç§Ÿæˆ·ç®¡ç†å‘˜èœå•ç¼ºå°‘çˆ¶çº§.md)

---

**ç°åœ¨ç§Ÿæˆ·ç®¡ç†å‘˜ç™»å½•åå¯ä»¥çœ‹åˆ°å®Œæ•´çš„èœå•æ ‘äº†ï¼** ğŸŠ
