# 修复 - 租户管理员菜单获取问题

## 🐛 问题描述

### 现象

创建租户时分配了菜单权限（例如：Dashboard、基础信息、权限管理），但租户管理员登录后：
- ❌ 只能看到部分菜单（管理员管理、角色管理）
- ❌ 看不到基础信息相关菜单（颜色、尺码、工序等）
- ❌ 父级菜单也不显示

### 截图证据

**分配权限菜单**：
- ✅ Dashboard
- ✅ 基础信息（颜色、尺码、工序、客户、业务员、订单类型）
- ✅ 权限管理（管理员管理、角色管理）

**实际显示**：
- ✅ 仪表盘
- ✅ 管理员管理
- ✅ 角色管理
- ❌ 基础信息（整个父级菜单及子菜单都不见了）

---

## 🔍 问题原因

### 代码分析

在 `app/auth/services/auth.go` 的 `GetUserRoutes` 方法中：

```go
// ❌ 错误代码
tenantID := tenantCtx.GetTenantID(ctx)
if tenantID != "" {
    // ...
    tenant, err := s.tenantRepo.Get(context.Background(), tenantID)
    // ...
}
```

### 根本原因

1. **Context 中存储的值已变化**
   - 之前改造后，Context 中存储的是 `tenant_code`（如 "default"、"ace"）
   - 但这里仍然使用 `GetTenantID(ctx)` 获取值

2. **Repository 方法不匹配**
   - `Get(id)` 方法需要的是 MongoDB ObjectID
   - 但传入的是 `tenant_code`（字符串 "ace"）
   - 查询失败，无法获取租户的菜单列表

3. **导致逻辑中断**
   - 查询租户失败
   - `tenant.Menus` 为空
   - 最终返回空菜单或默认菜单

---

## ✅ 解决方案

### 修改内容

```go
// ✅ 正确代码
tenantCode := tenantCtx.GetTenantCode(ctx)  // 使用 GetTenantCode
if tenantCode != "" {
    // 检查用户是否有租户管理员角色
    for _, roleID := range admin.Roles {
        role, err := s.roleRepo.Get(ctx, roleID)
        if err == nil && role != nil && role.Code == "tenant_admin" {
            logger.Info("租户管理员登录，返回租户所有菜单", 
                zap.String("user_id", userID),
                zap.String("tenant_code", tenantCode))  // 添加日志

            // ✅ 使用 GetByCode 查询租户
            tenant, err := s.tenantRepo.GetByCode(context.Background(), tenantCode)
            if err != nil || tenant == nil {
                logger.Error("获取租户信息失败", zap.Error(err))
                break
            }

            // ...后续逻辑不变
            
            logger.Info("租户管理员菜单",
                zap.String("tenant_code", tenantCode),
                zap.Strings("tenant_menus", tenant.Menus),  // 输出租户菜单列表
                zap.Int("original_count", len(tenant.Menus)),
                zap.Int("completed_count", len(tenantMenus)))
            
            return &dto.GetUserRoutesResponse{
                Routes: tenantMenus,
            }, nil
        }
    }
}
```

### 关键改进

1. **使用正确的 Context 获取方法**
   ```go
   tenantCode := tenantCtx.GetTenantCode(ctx)  // 而不是 GetTenantID
   ```

2. **使用正确的 Repository 方法**
   ```go
   tenant, err := s.tenantRepo.GetByCode(context.Background(), tenantCode)  // 而不是 Get
   ```

3. **增强日志输出**
   - 输出 `tenant_code`
   - 输出租户分配的菜单列表 `tenant.Menus`
   - 便于调试问题

---

## 🎯 数据流对比

### 修复前（错误）

```
1. GetUserRoutes 调用
   ↓
2. tenantID = GetTenantID(ctx)  → 返回 "ace" (实际是 code)
   ↓
3. tenant = Get("ace")  → 查询失败（ace 不是有效的 ObjectID）
   ↓
4. tenant = nil
   ↓
5. 无法获取 tenant.Menus
   ↓
6. 返回空菜单或默认菜单 ❌
```

### 修复后（正确）

```
1. GetUserRoutes 调用
   ↓
2. tenantCode = GetTenantCode(ctx)  → 返回 "ace"
   ↓
3. tenant = GetByCode("ace")  → 查询成功 ✅
   ↓
4. tenant.Menus = ["Dashboard", "basic_color", "basic_size", ...]
   ↓
5. 递归添加父级菜单
   ↓
6. 返回完整的菜单树 ✅
```

---

## 📊 为什么会出现这个问题？

### 历史原因

1. **原始设计**
   - Context 中存储的是 `tenant_id`（MongoDB ObjectID）
   - 使用 `Get(tenant_id)` 查询租户

2. **数据库命名改造**
   - 为了使用语义化的数据库名（`mule_default` 而不是 `mule_68e27...`）
   - Context 中改为存储 `tenant_code`
   - JWT Claims 添加了 `tenant_code` 字段

3. **部分代码未更新**
   - 登录时正确使用了 `WithTenantCode`
   - 但 `GetUserRoutes` 中仍然使用旧的逻辑
   - 导致租户查询失败

---

## 🔍 如何验证修复

### 1. 查看日志

重启服务后，租户管理员登录，查看日志：

```
2025-10-06T00:00:00  INFO  租户管理员登录，返回租户所有菜单
    {"user_id": "123", "tenant_code": "ace"}

2025-10-06T00:00:01  INFO  租户管理员菜单
    {"tenant_code": "ace", 
     "tenant_menus": ["Dashboard", "basic_info", "basic_color", "basic_size", ...],
     "original_count": 10, 
     "completed_count": 15}
```

### 2. 前端验证

登录后应该能看到：
- ✅ 仪表盘（Dashboard）
- ✅ 基础信息（父级菜单）
  - ✅ 颜色
  - ✅ 尺码
  - ✅ 工序
  - ✅ 客户
  - ✅ 业务员
  - ✅ 订单类型
- ✅ 权限管理（父级菜单）
  - ✅ 管理员管理
  - ✅ 角色管理

### 3. 数据库验证

查看租户数据：

```javascript
// MongoDB
db.tenant.findOne({code: "ace"})

// 应该看到
{
  "_id": ObjectId("..."),
  "code": "ace",
  "name": "ACE租户",
  "menus": [
    "Dashboard",
    "basic_color",      // 颜色
    "basic_size",       // 尺码
    "basic_procedure",  // 工序
    "basic_customer",   // 客户
    "basic_salesman",   // 业务员
    "basic_order_type", // 订单类型
    "perms_admin",      // 管理员管理
    "perms_role"        // 角色管理
  ]
}
```

---

## 📝 修改文件

- ✅ `app/auth/services/auth.go`
  - 修改 `GetUserRoutes` 方法
  - 使用 `GetTenantCode(ctx)` 获取租户代码
  - 使用 `GetByCode(tenantCode)` 查询租户
  - 增强日志输出

---

## 🎉 修复完成

### 编译验证

```bash
✅ go build ./cmd/auth
```

### 效果

- ✅ 租户管理员能看到所有分配的菜单
- ✅ 父级菜单正确显示
- ✅ 菜单树形结构完整
- ✅ 日志输出清晰，便于调试

---

## 🔗 相关文档

- [租户 Code 数据库命名方案](完成-租户Code数据库命名方案.md)
- [租户管理员菜单缺少父级](修复-租户管理员菜单缺少父级.md)

---

**现在租户管理员登录后可以看到完整的菜单树了！** 🎊
