# 测试：超管切换租户功能

## 测试目的

验证修复后，超管通过 `X-Tenant-Context` header 切换租户时，能正确访问目标租户数据库。

## 前置条件

1. 系统中存在至少一个租户（如 `ace`）
2. 超管账户已登录（拥有 `super` 角色）
3. 目标租户数据库中存在一些测试数据

## 测试步骤

### 1. 不带 X-Tenant-Context 查询（系统管理员视角）

**请求：**
```http
GET /perms/admins?page=1&page_size=10
Authorization: Bearer <super_admin_token>
```

**预期结果：**
- 返回系统数据库（`tenant_system`）中的管理员列表
- 日志显示：`"$db": "tenant_system"`

### 2. 带 X-Tenant-Context 查询（切换到租户）

**请求：**
```http
GET /perms/admins?page=1&page_size=10
Authorization: Bearer <super_admin_token>
X-Tenant-Context: ace
```

**预期结果：**
- 返回租户数据库（`mule_ace`）中的管理员列表
- 日志显示：
  ```
  [租户上下文切换] ✅ 系统管理员切换到租户: ace
  [租户上下文切换] ✅ 切换后验证 tenantCode: 'ace'
  [MongoDB] 执行命令: ... "$db": "mule_ace"}  ✅ 正确！
  ```

### 3. 创建管理员（在租户上下文中）

**请求：**
```http
POST /perms/admins
Authorization: Bearer <super_admin_token>
X-Tenant-Context: ace
Content-Type: application/json

{
  "phone": "13800000001",
  "password": "123456",
  "nickname": "测试管理员",
  "status": 1
}
```

**预期结果：**
- 管理员创建在租户数据库（`mule_ace`）中
- 日志显示：`"$db": "mule_ace"`

### 4. 更新管理员（在租户上下文中）

**请求：**
```http
PUT /perms/admins/{admin_id}
Authorization: Bearer <super_admin_token>
X-Tenant-Context: ace
Content-Type: application/json

{
  "nickname": "更新后的名称"
}
```

**预期结果：**
- 更新租户数据库（`mule_ace`）中的管理员
- 日志显示：`"$db": "mule_ace"`

### 5. 删除管理员（在租户上下文中）

**请求：**
```http
DELETE /perms/admins/{admin_id}
Authorization: Bearer <super_admin_token>
X-Tenant-Context: ace
```

**预期结果：**
- 软删除租户数据库（`mule_ace`）中的管理员
- 日志显示：`"$db": "mule_ace"`

## 验证点

1. **日志验证**：
   - ✅ 租户上下文切换成功日志
   - ✅ MongoDB 命令显示正确的数据库名称

2. **数据验证**：
   - ✅ 查询结果来自正确的数据库
   - ✅ 增删改操作影响正确的数据库

3. **安全验证**：
   - ✅ 只有 `super` 角色可以切换租户上下文
   - ✅ 普通租户管理员不能切换到其他租户

## 测试脚本示例

```bash
# 1. 获取超管 token
TOKEN=$(curl -s -X POST http://localhost:8085/auth/login \
  -H "Content-Type: application/json" \
  -d '{"phone":"super_admin_phone","password":"password"}' \
  | jq -r '.data.token')

# 2. 查询系统管理员（不带 X-Tenant-Context）
curl -s -X GET "http://localhost:8085/perms/admins?page=1&page_size=10" \
  -H "Authorization: Bearer $TOKEN" \
  | jq

# 3. 查询租户管理员（带 X-Tenant-Context）
curl -s -X GET "http://localhost:8085/perms/admins?page=1&page_size=10" \
  -H "Authorization: Bearer $TOKEN" \
  -H "X-Tenant-Context: ace" \
  | jq

# 4. 在租户上下文中创建管理员
curl -s -X POST "http://localhost:8085/perms/admins" \
  -H "Authorization: Bearer $TOKEN" \
  -H "X-Tenant-Context: ace" \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "13800000001",
    "password": "123456",
    "nickname": "测试管理员",
    "status": 1
  }' \
  | jq
```

## 常见问题

### Q1: 日志仍然显示 `tenant_system`？

**原因：** 可能是服务未重启，或者修改未编译。

**解决：**
```bash
cd cmd/perms
go build
./perms  # 或重新启动服务
```

### Q2: 提示 "非系统管理员尝试切换租户"？

**原因：** 当前登录用户没有 `super` 角色。

**解决：** 使用系统管理员账户登录。

### Q3: 切换后仍然查询不到数据？

**原因：** 目标租户数据库可能不存在或为空。

**解决：**
1. 确认租户数据库存在（如 `mule_ace`）
2. 确认租户数据库中有测试数据

## 回归测试

修复后，确保以下功能仍然正常：

1. ✅ 普通租户管理员登录后查询自己的数据
2. ✅ 系统管理员不带 `X-Tenant-Context` 时查询系统数据
3. ✅ JWT 中间件正常工作
4. ✅ 租户隔离正常工作

