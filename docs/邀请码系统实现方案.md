# 邀请码系统实现方案

## 📋 当前状态

**临时方案**：邀请码 = 租户 code
- ✅ 优点：简单快速
- ❌ 缺点：不安全，任何人知道租户 code 就能加入

## 🎯 推荐方案：独立邀请码系统

### 数据模型

```go
// TenantInvite 租户邀请码表（存储在系统库）
type TenantInvite struct {
    ID         string `bson:"_id,omitempty"`
    Code       string `bson:"code"`          // 6位邀请码（随机生成）
    TenantID   string `bson:"tenant_id"`     // 租户ID
    TenantCode string `bson:"tenant_code"`   // 租户代码
    
    // 邀请码配置
    MaxUse     int    `bson:"max_use"`       // 最大使用次数（0=无限制）
    UsedCount  int    `bson:"used_count"`    // 已使用次数
    ExpiresAt  int64  `bson:"expires_at"`    // 过期时间（0=永久有效）
    
    // 角色配置
    DefaultRole string `bson:"default_role"` // 默认角色（如：employee）
    
    // 状态
    Status     string `bson:"status"`        // active/disabled
    
    // 创建信息
    CreatedBy  string `bson:"created_by"`    // 创建人
    CreatedAt  int64  `bson:"created_at"`
    UpdatedAt  int64  `bson:"updated_at"`
}
```

### API 接口

#### 1. 生成邀请码（管理员）

```go
POST /admin/tenant/invite/generate
{
  "tenant_id": "租户ID",
  "max_use": 10,           // 最多使用10次
  "expires_at": 1234567890, // 过期时间
  "default_role": "employee"
}

Response:
{
  "code": "ABC123",  // 6位邀请码
  "expires_at": 1234567890,
  "max_use": 10
}
```

#### 2. 验证邀请码（小程序）

```go
POST /miniapp/wechat/validate-invite
{
  "invite_code": "ABC123"
}

Response:
{
  "valid": true,
  "tenant_name": "ACE工厂",
  "tenant_id": "xxx",
  "expires_at": 1234567890,
  "remaining_uses": 5
}
```

#### 3. 使用邀请码绑定

```go
POST /miniapp/wechat/bind-tenant
{
  "user_id": "用户ID",
  "invite_code": "ABC123"
}
```

### 邀请码生成规则

```go
// 生成6位随机邀请码（数字+大写字母，排除易混淆字符）
func GenerateInviteCode() string {
    chars := "23456789ABCDEFGHJKLMNPQRSTUVWXYZ" // 排除 0O1I
    code := make([]byte, 6)
    for i := range code {
        code[i] = chars[rand.Intn(len(chars))]
    }
    return string(code)
}

// 示例：AB3K7M
```

### 前端显示优化

```vue
<template>
  <view class="invite-input">
    <input 
      v-model="inviteCode" 
      placeholder="请输入6位邀请码"
      maxlength="6"
      @input="handleInput"
    />
    <button @click="validateCode">验证</button>
  </view>
  
  <!-- 显示租户信息 -->
  <view v-if="tenantInfo" class="tenant-preview">
    <text>✓ 将加入：{{ tenantInfo.tenant_name }}</text>
    <text v-if="tenantInfo.expires_at">过期时间：{{ formatDate(tenantInfo.expires_at) }}</text>
  </view>
</template>
```

## 🔒 安全特性

1. **限制使用次数**：防止邀请码被滥用
2. **设置有效期**：过期自动失效
3. **可随时禁用**：管理员可以作废邀请码
4. **使用记录**：记录每次使用的用户和时间
5. **默认角色**：不同邀请码可以设置不同的默认角色

## 📊 管理后台功能

### 邀请码管理页面

```
┌─────────────────────────────────────────────┐
│  邀请码管理                    [+ 生成新邀请码]│
├─────────────────────────────────────────────┤
│ 邀请码   状态   已用/总数  过期时间    操作   │
├─────────────────────────────────────────────┤
│ AB3K7M   有效    5/10    2025-12-31  禁用   │
│ XY8P2N   有效    0/∞     永久        禁用   │
│ QW4R9T   已满    20/20   2025-10-15  删除   │
└─────────────────────────────────────────────┘
```

## 🚀 实施步骤

### 第一步：创建数据模型和 Repository

```bash
# 创建文件
touch internal/models/tenant_invite.go
touch internal/repository/tenant_invite.go
```

### 第二步：实现邀请码生成和验证服务

```bash
# 在 auth 或 perms 服务中添加
touch app/perms/services/invite.go
```

### 第三步：添加 API 接口

```bash
# 管理端 API
touch app/perms/endpoint/invite.go
touch app/perms/transport/invite.go
```

### 第四步：修改小程序绑定逻辑

修改 `app/miniapp/services/wechat.go` 中的 `BindTenant` 函数，使用邀请码表验证。

## 📝 数据库索引

```javascript
// tenant_system 库
db.tenant_invite.createIndex({ "code": 1 }, { unique: true })
db.tenant_invite.createIndex({ "tenant_id": 1 })
db.tenant_invite.createIndex({ "status": 1, "expires_at": 1 })
```

## 🎯 用户体验优化

### 小程序端

1. **输入实时验证**：输入6位自动验证
2. **显示租户预览**：验证成功后显示要加入的企业信息
3. **错误提示优化**：
   - "邀请码不存在"
   - "邀请码已过期"
   - "邀请码已达使用上限"
   - "邀请码已被禁用"

### 管理端

1. **批量生成**：一次生成多个邀请码
2. **二维码分享**：生成包含邀请码的二维码
3. **使用统计**：查看每个邀请码的使用情况

## 💡 高级功能（可选）

1. **部门邀请码**：不同部门使用不同邀请码，自动分配部门
2. **职位邀请码**：普通员工和管理员使用不同邀请码
3. **临时邀请码**：一次性邀请码，使用后立即失效
4. **邀请链接**：生成带邀请码的小程序链接，一键加入

---

**当前状态**：临时方案（邀请码 = 租户 code）  
**推荐升级**：实现独立邀请码系统  
**预计工作量**：1-2天

