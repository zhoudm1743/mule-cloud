# æƒé™ä½“ç³»æ•´åˆæ–¹æ¡ˆ

## å½“å‰æ¶æ„

### ä¸¤ç§æƒé™æ§åˆ¶æ–¹å¼

#### 1. åŸºäºè§’è‰²çš„èœå•åˆ†é…ï¼ˆåç«¯æ§åˆ¶ï¼‰
```
Tenant.menus: ['dashboard', 'admin', 'role']  // ç§Ÿæˆ·æ‹¥æœ‰çš„èœå•
Role.menus: ['admin', 'role']                  // è§’è‰²æ‹¥æœ‰çš„èœå•
Admin.roles: ['role1', 'role2']                // ç”¨æˆ·çš„è§’è‰²
```

**æµç¨‹ï¼š**
1. ç”¨æˆ·ç™»å½• â†’ è·å–ç”¨æˆ·çš„è§’è‰²åˆ—è¡¨
2. æ ¹æ®è§’è‰²æŸ¥è¯¢æ‰€æœ‰è§’è‰²æ‹¥æœ‰çš„èœå•ï¼ˆå–å¹¶é›†ï¼‰
3. ä¸ç§Ÿæˆ·çš„èœå•å–äº¤é›†ï¼ˆç§Ÿæˆ·é™åˆ¶ï¼‰
4. è¿”å›æœ€ç»ˆçš„èœå•åˆ—è¡¨ç»™å‰ç«¯

#### 2. èœå•çº§è§’è‰²é™åˆ¶ï¼ˆå‰ç«¯è¿‡æ»¤ï¼‰
```go
Menu.Roles: ['admin', 'super']  // è¿™ä¸ªèœå•åªå…è®¸ admin å’Œ super è§’è‰²è®¿é—®
```

**å‰ç«¯é€»è¾‘ï¼š**
```typescript
// helper.ts
resultRouter = resultRouter.filter(i => hasPermission(i.meta.roles))

// usePermission.ts
hasPermission(permission) {
  const { role } = authStore.userInfo
  // å¦‚æœèœå•è®¾ç½®äº† rolesï¼Œæ£€æŸ¥ç”¨æˆ·è§’è‰²æ˜¯å¦åœ¨å…è®¸åˆ—è¡¨ä¸­
  return permission.some(i => role.includes(i))
}
```

## æ•´åˆæ–¹æ¡ˆ

### ğŸ¯ æ¨èæ–¹æ¡ˆï¼šä¸¤å±‚æƒé™æ§åˆ¶

#### ç¬¬ä¸€å±‚ï¼šç§Ÿæˆ·/è§’è‰²èœå•åˆ†é…ï¼ˆç²—ç²’åº¦ï¼‰
- **ç›®çš„**ï¼šæ§åˆ¶å¤§èŒƒå›´çš„åŠŸèƒ½æ¨¡å—è®¿é—®
- **ä½ç½®**ï¼šåç«¯ Tenant/Role çš„ menus å­—æ®µ
- **æ§åˆ¶**ï¼šç”¨æˆ·èƒ½çœ‹åˆ°å“ªäº›èœå•æ¨¡å—

#### ç¬¬äºŒå±‚ï¼šèœå•è§’è‰²é™åˆ¶ï¼ˆç»†ç²’åº¦ï¼‰
- **ç›®çš„**ï¼šåœ¨èœå•çº§åˆ«è¿›ä¸€æ­¥ç»†åŒ–æƒé™
- **ä½ç½®**ï¼šMenu çš„ roles å­—æ®µ
- **æ§åˆ¶**ï¼šå³ä½¿è§’è‰²æœ‰è¿™ä¸ªèœå•æƒé™ï¼Œä¹Ÿè¦æ£€æŸ¥ç”¨æˆ·è§’è‰²æ˜¯å¦åŒ¹é…

### å®ç°é€»è¾‘

```
ç”¨æˆ·è®¿é—®èœå•çš„æ¡ä»¶ï¼ˆAND å…³ç³»ï¼‰ï¼š
1. âœ… ç§Ÿæˆ·æ‹¥æœ‰è¯¥èœå•ï¼ˆTenant.menus åŒ…å«ï¼‰
2. âœ… ç”¨æˆ·è§’è‰²æ‹¥æœ‰è¯¥èœå•ï¼ˆRole.menus åŒ…å«ï¼‰
3. âœ… ç”¨æˆ·è§’è‰²åœ¨èœå•å…è®¸çš„è§’è‰²åˆ—è¡¨ä¸­ï¼ˆMenu.roles ä¸ºç©ºæˆ–åŒ…å«ç”¨æˆ·è§’è‰²ï¼‰
```

## ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šåŸºç¡€æƒé™æ§åˆ¶ï¼ˆå½“å‰å®ç°ï¼‰
```yaml
ç§Ÿæˆ·: è¶…ç®¡
  menus: [dashboard, system, admin, role, tenant, menu]
  
è§’è‰²: ç³»ç»Ÿç®¡ç†å‘˜
  menus: [dashboard, system, admin, role]
  
è§’è‰²: æ™®é€šç®¡ç†å‘˜
  menus: [dashboard, admin]
```

### åœºæ™¯2ï¼šå¢åŠ ç»†ç²’åº¦æ§åˆ¶ï¼ˆä½¿ç”¨ Menu.Rolesï¼‰
```yaml
èœå•: adminï¼ˆç®¡ç†å‘˜ç®¡ç†ï¼‰
  roles: [super, admin]  # åªæœ‰ super å’Œ admin è§’è‰²èƒ½è®¿é—®
  
èœå•: tenantï¼ˆç§Ÿæˆ·ç®¡ç†ï¼‰
  roles: [super]  # åªæœ‰ super è§’è‰²èƒ½è®¿é—®
  
èœå•: dashboardï¼ˆä»ªè¡¨ç›˜ï¼‰
  roles: []  # ç©ºè¡¨ç¤ºæ‰€æœ‰è§’è‰²éƒ½èƒ½è®¿é—®
```

**æ•ˆæœï¼š**
- å³ä½¿"ç³»ç»Ÿç®¡ç†å‘˜"è§’è‰²è¢«åˆ†é…äº† `admin` èœå•
- ä½†å¦‚æœç”¨æˆ·çš„å®é™…è§’è‰²æ˜¯ `viewer`ï¼ˆåªè¯»è§’è‰²ï¼‰
- å‰ç«¯ä¼šè¿‡æ»¤æ‰è¿™ä¸ªèœå•ï¼ˆå› ä¸º `viewer` ä¸åœ¨ Menu.roles ä¸­ï¼‰

## å®æ–½æ­¥éª¤

### 1. åç«¯æ”¹é€ 

#### a. Auth Service è¿”å›ç”¨æˆ·è§’è‰²ä¿¡æ¯
```go
// auth/services/auth.go - Login æ–¹æ³•
type LoginResponse struct {
    Token     string   `json:"token"`
    UserID    string   `json:"user_id"`
    Roles     []string `json:"role"`  // è¿”å›è§’è‰²çš„ codeï¼Œå¦‚ ['super', 'admin']
    // ...
}
```

#### b. è·å–è§’è‰²çš„ code è€Œä¸æ˜¯ ID
```go
// ä» Admin.roles (è§’è‰²IDæ•°ç»„) æŸ¥è¯¢å¯¹åº”çš„ Role.code
roleNames := []string{}
for _, roleID := range admin.Roles {
    role, _ := roleRepo.GetByID(ctx, roleID)
    if role != nil {
        roleNames = append(roleNames, role.Code)  // ä½¿ç”¨ codeï¼Œå¦‚ "admin"
    }
}
```

### 2. å‰ç«¯æ”¹é€ ï¼ˆå·²å®ç°ï¼‰

å‰ç«¯å·²ç»æœ‰å®Œæ•´çš„ `hasPermission` é€»è¾‘ï¼š

```typescript
// helper.ts - åˆ›å»ºè·¯ç”±æ—¶è¿‡æ»¤
resultRouter = resultRouter.filter(i => hasPermission(i.meta.roles))

// usePermission.ts - æƒé™æ£€æŸ¥
function hasPermission(permission?: Entity.RoleType | Entity.RoleType[]) {
  if (!permission) return true  // Menu.roles ä¸ºç©ºï¼Œæ‰€æœ‰äººå¯è®¿é—®
  
  const { role } = authStore.userInfo  // ç”¨æˆ·çš„è§’è‰²åˆ—è¡¨
  return permission.some(i => role.includes(i))  // æ£€æŸ¥æ˜¯å¦æœ‰äº¤é›†
}
```

### 3. æ•°æ®åº“è®¾è®¡

#### Menu è¡¨
```go
type Menu struct {
    Name  string   `json:"name"`   // å”¯ä¸€æ ‡è¯†
    Roles []string `json:"roles"`  // å…è®¸çš„è§’è‰² code åˆ—è¡¨ï¼Œå¦‚ ['admin', 'super']
    // ...
}
```

#### Role è¡¨
```go
type Role struct {
    Code  string   `json:"code"`   // è§’è‰²ä»£ç ï¼ˆå”¯ä¸€ï¼‰ï¼Œå¦‚ 'admin', 'super'
    Name  string   `json:"name"`   // è§’è‰²åç§°ï¼ˆæ˜¾ç¤ºç”¨ï¼‰ï¼Œå¦‚ 'ç³»ç»Ÿç®¡ç†å‘˜'
    Menus []string `json:"menus"`  // è§’è‰²æ‹¥æœ‰çš„èœå• name åˆ—è¡¨
    // ...
}
```

#### Admin è¡¨
```go
type Admin struct {
    Roles []string `json:"roles"`  // ç”¨æˆ·çš„è§’è‰² ID åˆ—è¡¨
    // ...
}
```

## é…ç½®ç¤ºä¾‹

### 1. åˆ›å»ºè§’è‰²
```json
{
  "code": "admin",
  "name": "ç³»ç»Ÿç®¡ç†å‘˜",
  "menus": ["dashboard", "system", "admin", "role", "tenant"]
}

{
  "code": "viewer",
  "name": "åªè¯»ç”¨æˆ·",
  "menus": ["dashboard", "system", "admin", "role"]
}
```

### 2. é…ç½®èœå•
```json
{
  "name": "admin",
  "title": "ç®¡ç†å‘˜ç®¡ç†",
  "roles": ["admin", "super"]  // åªæœ‰ admin å’Œ super è§’è‰²èƒ½è®¿é—®
}

{
  "name": "tenant",
  "title": "ç§Ÿæˆ·ç®¡ç†",
  "roles": ["super"]  // åªæœ‰ super è§’è‰²èƒ½è®¿é—®
}

{
  "name": "dashboard",
  "title": "ä»ªè¡¨ç›˜",
  "roles": []  // æ‰€æœ‰è§’è‰²éƒ½èƒ½è®¿é—®
}
```

### 3. åˆ†é…ç”¨æˆ·
```json
{
  "phone": "13800138000",
  "roles": ["role_id_of_admin"]  // ç”¨æˆ·å±äº admin è§’è‰²
}
```

### 4. æƒé™æ£€æŸ¥
```
ç”¨æˆ·ç™»å½•åï¼š
- role: ['admin']
- é€šè¿‡è§’è‰²è·å¾—çš„èœå•: ['dashboard', 'system', 'admin', 'role', 'tenant']

å‰ç«¯è¿‡æ»¤ï¼š
- dashboard: roles=[] â†’ âœ… é€šè¿‡ï¼ˆç©ºè¡¨ç¤ºæ‰€æœ‰è§’è‰²ï¼‰
- admin: roles=['admin', 'super'] â†’ âœ… é€šè¿‡ï¼ˆç”¨æˆ·æ˜¯ adminï¼‰
- tenant: roles=['super'] â†’ âŒ æ‹’ç»ï¼ˆç”¨æˆ·ä¸æ˜¯ superï¼‰

æœ€ç»ˆå¯è®¿é—®ï¼š['dashboard', 'system', 'admin', 'role']
```

## ä¼˜åŠ¿

### 1. çµæ´»æ€§
- å¯ä»¥åªä½¿ç”¨ç¬¬ä¸€å±‚ï¼ˆè§’è‰²åˆ†é…ï¼‰ï¼Œä¸è®¾ç½® Menu.roles
- å¯ä»¥ä¸¤å±‚ç»“åˆï¼Œå®ç°æ›´ç»†ç²’åº¦çš„æ§åˆ¶

### 2. å®‰å…¨æ€§
- åç«¯æ§åˆ¶å¤§èŒƒå›´è®¿é—®ï¼ˆTenant/Role.menusï¼‰
- å‰ç«¯è¿‡æ»¤æ•æ„ŸåŠŸèƒ½ï¼ˆMenu.rolesï¼‰
- åŒé‡ä¿éšœ

### 3. å¯ç»´æŠ¤æ€§
- è§’è‰²ç®¡ç†å‘˜å¯ä»¥åˆ†é…èœå•ï¼ˆç¬¬ä¸€å±‚ï¼‰
- ç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥è®¾ç½®èœå•çš„è§’è‰²é™åˆ¶ï¼ˆç¬¬äºŒå±‚ï¼‰
- èŒè´£åˆ†ç¦»

## æ³¨æ„äº‹é¡¹

### 1. è§’è‰²æ ‡è¯†ç»Ÿä¸€
```
Menu.roles = ['admin', 'super']  â† ä½¿ç”¨ Role.code
User.role = ['admin']            â† ç™»å½•æ—¶ä» Role.code è·å–
```

### 2. ç©ºå€¼å¤„ç†
```typescript
Menu.roles = []      // ç©ºæ•°ç»„ = æ‰€æœ‰è§’è‰²å¯è®¿é—®
Menu.roles = null    // null = æ‰€æœ‰è§’è‰²å¯è®¿é—®
Menu.roles = ['admin']  // åªæœ‰ admin è§’è‰²å¯è®¿é—®
```

### 3. super è§’è‰²
```typescript
// usePermission.ts
let has = role.includes('super')  // super è§’è‰²ç»•è¿‡æ‰€æœ‰æ£€æŸ¥
```

### 4. åç«¯ä¹Ÿè¦æ£€æŸ¥
å‰ç«¯è¿‡æ»¤åªæ˜¯ UX ä¼˜åŒ–ï¼Œåç«¯ API ä¹Ÿè¦éªŒè¯ï¼š
```go
// Gateway æˆ–å„æœåŠ¡çš„ä¸­é—´ä»¶
if !user.HasRole(menu.Roles) {
    return errors.New("æƒé™ä¸è¶³")
}
```

## ä¸‹ä¸€æ­¥

### ç«‹å³å¯åš
1. âœ… Menu å·²æœ‰ roles å­—æ®µ
2. âœ… å‰ç«¯å·²æœ‰ hasPermission é€»è¾‘
3. â­ï¸ åç«¯ Login è¿”å›è§’è‰² codeï¼ˆè€Œä¸æ˜¯ IDï¼‰
4. â­ï¸ åœ¨èœå•ç®¡ç†ç•Œé¢æ”¯æŒç¼–è¾‘ roles å­—æ®µ

### é•¿æœŸä¼˜åŒ–
1. Casbin é›†æˆ - ä½¿ç”¨æ›´å¼ºå¤§çš„æƒé™ç­–ç•¥
2. æƒé™ç¼“å­˜ - å‡å°‘æ•°æ®åº“æŸ¥è¯¢
3. æƒé™å®¡è®¡ - è®°å½•æƒé™å˜æ›´å†å²

