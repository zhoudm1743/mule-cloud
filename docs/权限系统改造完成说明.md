# æƒé™ç³»ç»Ÿæ”¹é€ å®Œæˆè¯´æ˜

## ğŸ‰ æ”¹é€ å®Œæˆ

å·²æˆåŠŸä½¿ç”¨**æ–¹æ¡ˆAï¼ˆæ‰©å±•æƒé™åŠ¨ä½œï¼‰**å®Œæˆæƒé™ç³»ç»Ÿæ”¹é€ ï¼Œæ”¯æŒç»†ç²’åº¦çš„å¢åˆ æ”¹æŸ¥æƒé™å’Œè‡ªå®šä¹‰ä¸šåŠ¡æƒé™ã€‚

## âœ… å®Œæˆçš„æ”¹åŠ¨

### 1. åç«¯æ”¹åŠ¨

#### 1.1 æ¨¡å‹å±‚ (`internal/models/`)
- âœ… **Menuæ¨¡å‹** æ·»åŠ  `AvailablePermissions []Permission` å­—æ®µ
  - å®šä¹‰äº† `Permission` ç»“æ„ä½“ï¼ˆaction, label, description, is_basicï¼‰
  - æ”¯æŒèœå•è‡ªå®šä¹‰å¯ç”¨æƒé™åˆ—è¡¨

- âœ… **Roleæ¨¡å‹** æ·»åŠ  `MenuPermissions map[string][]string` å­—æ®µ
  - å­˜å‚¨æ¯ä¸ªèœå•çš„å…·ä½“æƒé™ï¼š`{"admin": ["read", "create", "update"], "role": ["read"]}`

#### 1.2 ä¸­é—´ä»¶å±‚ (`app/gateway/middleware/`)
- âœ… **Casbinä¸­é—´ä»¶** ç»†åŒ–HTTPæ–¹æ³•åˆ°æƒé™çš„æ˜ å°„ï¼š
  ```go
  GET/HEAD    â†’ "read"
  POST        â†’ "create"
  PUT/PATCH   â†’ "update"
  DELETE      â†’ "delete"
  OPTIONS     â†’ "*"
  ```

#### 1.3 Casbinå·¥å…· (`core/casbin/`)
- âœ… æ–°å¢ `SyncRoleMenusWithPermissions()` å‡½æ•°
  - æ”¯æŒæŒ‰èœå•è®¾ç½®ä¸åŒæƒé™
  - å‚æ•°ï¼š`menuPermissions map[string][]string`
- âœ… æ–°å¢ `getMenuPathFromName()` è¾…åŠ©å‡½æ•°
  - å°†èœå• name è½¬æ¢ä¸ºè·¯å¾„
  - TODO: å®é™…åº”è¯¥æŸ¥è¯¢æ•°æ®åº“

#### 1.4 DTOå±‚ (`app/system/dto/`)
- âœ… `CreateRoleRequest` æ·»åŠ  `MenuPermissions` å­—æ®µ
- âœ… `UpdateRoleRequest` æ·»åŠ  `MenuPermissions` å­—æ®µ
- âœ… `AssignMenusRequest` æ·»åŠ  `MenuPermissions` å­—æ®µ

#### 1.5 æœåŠ¡å±‚ (`app/system/services/`)
- âœ… `RoleService.Create()` æ”¯æŒ `MenuPermissions`
- âœ… `RoleService.Update()` æ”¯æŒ `MenuPermissions`
- âœ… `RoleService.AssignMenus()` å‚æ•°ä¿®æ”¹ä¸ºï¼š
  ```go
  (roleID string, menuNames []string, menuPermissions map[string][]string, updatedBy string)
  ```

#### 1.6 ä¼ è¾“å±‚ (`app/system/transport/`)
- âœ… `AssignMenusHandler` ä¼ é€’ `req.MenuPermissions`

---

### 2. å‰ç«¯æ”¹åŠ¨

#### 2.1 ç±»å‹å®šä¹‰ (`frontend/src/typings/api/`)

**menu.d.ts:**
- âœ… æ–°å¢ `Permission` æ¥å£ï¼š
  ```typescript
  interface Permission {
    action: string      // read, create, update, delete, pending, verify...
    label: string       // æŸ¥çœ‹ã€åˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤ã€æŒ‚è´¦ã€æ ¸é”€...
    description?: string
    is_basic: boolean   // æ˜¯å¦åŸºç¡€æƒé™
  }
  ```
- âœ… `MenuItem` æ·»åŠ  `available_permissions?: Permission[]`

**role.d.ts:**
- âœ… `RoleInfo` æ·»åŠ  `menu_permissions?: Record<string, string[]>`
- âœ… `AssignMenusRequest` æ·»åŠ  `menu_permissions?: Record<string, string[]>`

#### 2.2 è§’è‰²ç®¡ç†ç•Œé¢ (`frontend/src/views/system/role/components/TableModal.vue`)

**æ–°å¢åŠŸèƒ½ï¼š**
- âœ… æ·»åŠ  `menuPermissions` å“åº”å¼å˜é‡
- âœ… æ·»åŠ  `initMenuPermissions()` å‡½æ•°ï¼šåˆå§‹åŒ–æƒé™æ•°æ®
- âœ… æ·»åŠ  `watch()` ç›‘å¬èœå•å˜åŒ–ï¼šè‡ªåŠ¨ä¸ºæ–°é€‰èœå•æ·»åŠ é»˜è®¤æƒé™
- âœ… ä¿®æ”¹ `openModal()` ï¼šå¼‚æ­¥åŠ è½½æ•°æ®å¹¶åˆå§‹åŒ–æƒé™
- âœ… ä¿®æ”¹ `handleSubmit()`ï¼šæäº¤æ—¶è½¬æ¢æƒé™æ ¼å¼

**ç•Œé¢æ›´æ–°ï¼š**
- âœ… èœå•æ ‘ä¸‹æ–¹æ˜¾ç¤º "æƒé™ç»†ç²’åº¦é…ç½®" åŒºåŸŸ
- âœ… ä¸ºæ¯ä¸ªé€‰ä¸­çš„èœå•æ˜¾ç¤ºï¼š
  - **åŸºç¡€æƒé™**ï¼ˆè“è‰²æ ‡ç­¾ï¼‰ï¼šread, create, update, delete
  - **ä¸šåŠ¡æƒé™**ï¼ˆé»„è‰²æ ‡ç­¾ï¼‰ï¼špending, verify, audit...ï¼ˆå¸¦tooltipè¯´æ˜ï¼‰
  - **é»˜è®¤æƒé™**ï¼ˆç°è‰²æ ‡ç­¾ï¼‰ï¼šå¦‚æœèœå•æœªå®šä¹‰æƒé™ï¼Œæ˜¾ç¤ºé»˜è®¤CRUD

---

### 3. å·¥å…·è„šæœ¬

#### 3.1 èœå•æƒé™åˆå§‹åŒ–è„šæœ¬
- âœ… åˆ›å»º `scripts/init_menu_permissions.js`
- åŠŸèƒ½ï¼š
  - ä¸ºæ‰€æœ‰ `page` ç±»å‹çš„èœå•æ·»åŠ åŸºç¡€ CRUD æƒé™
  - Dashboard è®¾ç½®ä¸ºåªè¯»æƒé™
  - åŒ…å«è´¢åŠ¡ç®¡ç†è‡ªå®šä¹‰æƒé™çš„ç¤ºä¾‹ï¼ˆæ³¨é‡ŠçŠ¶æ€ï¼‰

ä½¿ç”¨æ–¹æ³•ï¼š
```bash
cd K:\Git\mule-cloud
mongosh mongodb://localhost:27017/mule-cloud < scripts/init_menu_permissions.js
```

---

## ğŸ“Š æ•°æ®ç»“æ„ç¤ºä¾‹

### èœå•æƒé™é…ç½®ï¼ˆMongoDBï¼‰

```javascript
{
  name: "admin",
  title: "ç®¡ç†å‘˜ç®¡ç†",
  path: "/system/admin",
  available_permissions: [
    { action: "read",   label: "æŸ¥çœ‹", is_basic: true },
    { action: "create", label: "åˆ›å»º", is_basic: true },
    { action: "update", label: "ä¿®æ”¹", is_basic: true },
    { action: "delete", label: "åˆ é™¤", is_basic: true }
  ]
}

{
  name: "finance",
  title: "è´¢åŠ¡ç®¡ç†",
  path: "/business/finance",
  available_permissions: [
    { action: "read",    label: "æŸ¥çœ‹", is_basic: true },
    { action: "create",  label: "åˆ›å»º", is_basic: true },
    { action: "pending", label: "æŒ‚è´¦", is_basic: false, description: "å°†è®¢å•æŒ‚è´¦å»¶æœŸæ”¯ä»˜" },
    { action: "verify",  label: "æ ¸é”€", is_basic: false, description: "æ ¸é”€å·²æŒ‚è´¦è®¢å•" },
    { action: "audit",   label: "å®¡æ ¸", is_basic: false, description: "è´¢åŠ¡å®¡æ ¸" },
    { action: "export",  label: "å¯¼å‡º", is_basic: false }
  ]
}
```

### è§’è‰²æƒé™æ•°æ®

```javascript
{
  name: "è´¢åŠ¡ä¸»ç®¡",
  code: "finance_manager",
  menus: ["dashboard", "admin", "finance"],
  menu_permissions: {
    "admin": ["read", "create", "update"],
    "finance": ["read", "create", "pending", "verify", "audit", "export"]
  }
}
```

### Casbin ç­–ç•¥

```
p, tenant:A:role:finance_manager, /system/admin, read
p, tenant:A:role:finance_manager, /system/admin, create
p, tenant:A:role:finance_manager, /system/admin, update
p, tenant:A:role:finance_manager, /business/finance, read
p, tenant:A:role:finance_manager, /business/finance, create
p, tenant:A:role:finance_manager, /business/finance, pending
p, tenant:A:role:finance_manager, /business/finance, verify
p, tenant:A:role:finance_manager, /business/finance, audit
p, tenant:A:role:finance_manager, /business/finance, export
```

---

## ğŸš€ ä½¿ç”¨æµç¨‹

### 1. åˆå§‹åŒ–èœå•æƒé™

```bash
mongosh mongodb://localhost:27017/mule-cloud < scripts/init_menu_permissions.js
```

### 2. ï¼ˆå¯é€‰ï¼‰ä¸ºç‰¹å®šèœå•æ·»åŠ è‡ªå®šä¹‰ä¸šåŠ¡æƒé™

```javascript
db.menus.updateOne(
  { name: "finance" },
  {
    $set: {
      available_permissions: [
        { action: "read", label: "æŸ¥çœ‹", is_basic: true },
        { action: "create", label: "åˆ›å»º", is_basic: true },
        { action: "update", label: "ä¿®æ”¹", is_basic: true },
        { action: "delete", label: "åˆ é™¤", is_basic: true },
        { action: "pending", label: "æŒ‚è´¦", is_basic: false, description: "å°†è®¢å•æŒ‚è´¦å»¶æœŸæ”¯ä»˜" },
        { action: "verify", label: "æ ¸é”€", is_basic: false, description: "æ ¸é”€å·²æŒ‚è´¦è®¢å•" },
        { action: "reverse", label: "å†²è´¦", is_basic: false, description: "å†²é”€é”™è¯¯è´¦ç›®" },
        { action: "audit", label: "å®¡æ ¸", is_basic: false, description: "è´¢åŠ¡å®¡æ ¸" },
        { action: "export", label: "å¯¼å‡º", is_basic: false }
      ]
    }
  }
)
```

### 3. å‰ç«¯åˆ†é…æƒé™

1. è¿›å…¥ **ç³»ç»Ÿè®¾ç½® â†’ è§’è‰²ç®¡ç†**
2. ç‚¹å‡»æŸä¸ªè§’è‰²çš„ **åˆ†é…æƒé™** æŒ‰é’®
3. åœ¨å¼¹çª—ä¸­ï¼š
   - é€‰æ‹©è¦åˆ†é…çš„èœå•ï¼ˆæ ‘å½¢ç»“æ„ï¼‰
   - ä¸ºæ¯ä¸ªèœå•å‹¾é€‰å…·ä½“æƒé™ï¼š
     - **åŸºç¡€æƒé™**ï¼šæŸ¥çœ‹ã€åˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤
     - **ä¸šåŠ¡æƒé™**ï¼šæŒ‚è´¦ã€æ ¸é”€ã€å®¡æ ¸ã€å¯¼å‡º...
4. ç‚¹å‡»**ç¡®å®š**ä¿å­˜

### 4. ä¸šåŠ¡ä»£ç ä¸­æ£€æŸ¥æƒé™

#### Gatewayè‡ªåŠ¨æ£€æŸ¥ï¼ˆåŸºç¡€æƒé™ï¼‰

```
GET    /system/admin     â†’ æ£€æŸ¥ "read"
POST   /system/admin     â†’ æ£€æŸ¥ "create"
PUT    /system/admin/:id â†’ æ£€æŸ¥ "update"
DELETE /system/admin/:id â†’ æ£€æŸ¥ "delete"
```

#### ä¸šåŠ¡ä»£ç æ‰‹åŠ¨æ£€æŸ¥ï¼ˆè‡ªå®šä¹‰æƒé™ï¼‰

```go
// app/business/services/finance.go

func (s *FinanceService) PendingPayment(c *gin.Context, req *dto.PendingRequest) error {
    userID := c.GetString("user_id")
    tenantID := c.GetString("tenant_id")
    
    // æ£€æŸ¥æŒ‚è´¦æƒé™
    allowed, err := casbin.CheckUserPermission(
        tenantID,
        userID,
        "/business/finance",
        "pending",  // è‡ªå®šä¹‰æƒé™
    )
    
    if !allowed {
        return fmt.Errorf("æ— æŒ‚è´¦æƒé™")
    }
    
    // æ‰§è¡ŒæŒ‚è´¦é€»è¾‘
    return s.repo.CreatePendingPayment(req)
}
```

---

## ğŸ“ ç•Œé¢æ•ˆæœ

### è§’è‰²åˆ†é…æƒé™ç•Œé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ†é…èœå•æƒé™                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è§’è‰²åç§°ï¼šè´¢åŠ¡ä¸»ç®¡                                   â”‚
â”‚                                                      â”‚
â”‚ èœå•æƒé™ï¼š                                           â”‚
â”‚   â˜‘ï¸ ä»ªè¡¨ç›˜                                         â”‚
â”‚   â˜‘ï¸ ç³»ç»Ÿè®¾ç½®                                       â”‚
â”‚       â˜‘ï¸ ç®¡ç†å‘˜ç®¡ç†                                 â”‚
â”‚       â˜‘ï¸ è§’è‰²ç®¡ç†                                   â”‚
â”‚       â˜‘ï¸ è´¢åŠ¡ç®¡ç†                                   â”‚
â”‚                                                      â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ æƒé™ç»†ç²’åº¦é…ç½®                                       â”‚
â”‚                                                      â”‚
â”‚ â”œâ”€ ç®¡ç†å‘˜ç®¡ç†                                       â”‚
â”‚ â”‚  [åŸºç¡€æƒé™] â˜‘ï¸æŸ¥çœ‹ â˜‘ï¸åˆ›å»º â˜‘ï¸ä¿®æ”¹ â˜åˆ é™¤            â”‚
â”‚ â”‚                                                    â”‚
â”‚ â”œâ”€ è§’è‰²ç®¡ç†                                         â”‚
â”‚ â”‚  [åŸºç¡€æƒé™] â˜‘ï¸æŸ¥çœ‹ â˜åˆ›å»º â˜ä¿®æ”¹ â˜åˆ é™¤              â”‚
â”‚ â”‚                                                    â”‚
â”‚ â”œâ”€ è´¢åŠ¡ç®¡ç†                                         â”‚
â”‚ â”‚  [åŸºç¡€æƒé™] â˜‘ï¸æŸ¥çœ‹ â˜‘ï¸åˆ›å»º â˜ä¿®æ”¹ â˜åˆ é™¤              â”‚
â”‚ â”‚  [ä¸šåŠ¡æƒé™] â˜‘ï¸æŒ‚è´¦â„¹ï¸ â˜‘ï¸æ ¸é”€â„¹ï¸ â˜å†²è´¦â„¹ï¸ â˜‘ï¸å®¡æ ¸â„¹ï¸ â˜‘ï¸å¯¼å‡º â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     [å–æ¶ˆ]               [ç¡®å®š]
```

---

## âš ï¸ TODO & æ³¨æ„äº‹é¡¹

### éœ€è¦è¿›ä¸€æ­¥å®Œå–„ï¼š

1. **Casbin åŒæ­¥**
   - [ ] åœ¨ `AssignMenus` æœåŠ¡ä¸­å–æ¶ˆæ³¨é‡Š Casbin åŒæ­¥ä»£ç 
   - [ ] å®ç° `getMenuPathFromName()` ä»æ•°æ®åº“æŸ¥è¯¢çœŸå®è·¯å¾„

2. **å‰ç«¯æƒé™æ£€æŸ¥**
   - [ ] æ›´æ–° `usePermission` hook æ”¯æŒç»†ç²’åº¦æƒé™æ£€æŸ¥
   - [ ] åœ¨å„ä¸ªä¸šåŠ¡é¡µé¢ä¸­æ·»åŠ æŒ‰é’®çº§æƒé™æ§åˆ¶

3. **æµ‹è¯•**
   - [ ] æµ‹è¯•æƒé™åˆ†é…åŠŸèƒ½
   - [ ] æµ‹è¯• Gateway æƒé™æ‹¦æˆª
   - [ ] æµ‹è¯•ä¸šåŠ¡æƒé™æ£€æŸ¥

### æœ€ä½³å®è·µï¼š

1. **æƒé™å‘½åè§„èŒƒ**
   - åŸºç¡€æƒé™ï¼š`read`, `create`, `update`, `delete`
   - çŠ¶æ€æ“ä½œï¼š`enable`, `disable`, `archive`, `restore`
   - å®¡æ‰¹æµç¨‹ï¼š`submit`, `approve`, `reject`, `cancel`
   - è´¢åŠ¡æ“ä½œï¼š`pending`, `verify`, `reverse`, `audit`, `refund`
   - æ•°æ®æ“ä½œï¼š`export`, `import`, `print`, `download`
   - è´¦å·æ“ä½œï¼š`reset_password`, `lock`, `unlock`

2. **æƒé™è®¾è®¡åŸåˆ™**
   - éµå¾ªæœ€å°æƒé™åŸåˆ™
   - åŸºç¡€æƒé™ï¼ˆCRUDï¼‰ç”± Gateway è‡ªåŠ¨æ£€æŸ¥
   - ä¸šåŠ¡æƒé™åœ¨å…·ä½“æœåŠ¡ä¸­æ‰‹åŠ¨æ£€æŸ¥
   - æ•æ„Ÿæ“ä½œå»ºè®®äºŒæ¬¡éªŒè¯

3. **æ€§èƒ½ä¼˜åŒ–**
   - è€ƒè™‘æ·»åŠ æƒé™ç¼“å­˜
   - é¿å…é¢‘ç¹æŸ¥è¯¢ Casbin
   - æ‰¹é‡æ“ä½œæ—¶åˆå¹¶æƒé™æ£€æŸ¥

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- âœ… `docs/Casbinå¢åˆ æ”¹æŸ¥æƒé™è¯´æ˜.md` - åŸºç¡€ CRUD æƒé™
- âœ… `docs/Casbinè‡ªå®šä¹‰ä¸šåŠ¡æƒé™æ–¹æ¡ˆ.md` - è‡ªå®šä¹‰ä¸šåŠ¡æƒé™è¯¦è§£
- âœ… `docs/Menu.rolesä½¿ç”¨è¯´æ˜.md` - Menu.roles å­—æ®µä½¿ç”¨è¯´æ˜
- âœ… `scripts/init_menu_permissions.js` - èœå•æƒé™åˆå§‹åŒ–è„šæœ¬

---

## ğŸ¯ æ€»ç»“

âœ… **å·²å®Œæˆæ”¹é€ **
- åç«¯æ¨¡å‹ã€DTOã€æœåŠ¡ã€ä¼ è¾“å±‚å…¨éƒ¨æ”¯æŒç»†ç²’åº¦æƒé™
- Gateway ä¸­é—´ä»¶æ”¯æŒ create/read/update/delete å››æƒé™
- Casbin å·¥å…·å‡½æ•°æ”¯æŒèœå•çº§æƒé™é…ç½®
- å‰ç«¯ç•Œé¢å®Œæ•´æ”¯æŒæƒé™å‹¾é€‰å’Œé…ç½®
- æä¾›åˆå§‹åŒ–è„šæœ¬å’Œå®Œæ•´æ–‡æ¡£

ğŸš€ **å¯ä»¥å¼€å§‹ä½¿ç”¨**
- è¿è¡Œåˆå§‹åŒ–è„šæœ¬é…ç½®èœå•æƒé™
- ä½¿ç”¨å‰ç«¯ç•Œé¢ä¸ºè§’è‰²åˆ†é…ç»†ç²’åº¦æƒé™
- åœ¨ä¸šåŠ¡ä»£ç ä¸­æ£€æŸ¥è‡ªå®šä¹‰æƒé™

ğŸ“ **åç»­æ”¹è¿›**
- å¯ç”¨ Casbin åŒæ­¥
- å®Œå–„å‰ç«¯æƒé™æ£€æŸ¥
- æ·»åŠ æ›´å¤šä¸šåŠ¡æƒé™ç¤ºä¾‹
- æ€§èƒ½ä¼˜åŒ–å’Œç¼“å­˜

---

**æ”¹é€ å®Œæˆï¼** ğŸ‰ ç°åœ¨å¯ä»¥æ”¯æŒçµæ´»çš„å¢åˆ æ”¹æŸ¥æƒé™å’Œè‡ªå®šä¹‰ä¸šåŠ¡æƒé™äº†ï¼

