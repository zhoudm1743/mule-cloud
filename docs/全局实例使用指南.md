# 全局实例使用指南

## 📖 概述

本项目提供了 **懒加载全局实例**，可以直接使用而无需手动初始化：
- ✅ **config.Cfg**: 全局配置实例
- ✅ **database.MongoDB**: 全局MongoDB实例
- ✅ **cache.Redis**: 全局Redis实例

**特性**:
- 🔄 **懒加载**: 首次使用时自动初始化
- 🔒 **线程安全**: 使用 `sync.Once` 保证只初始化一次
- 🚀 **零配置**: 开箱即用
- 🎯 **灵活**: 支持手动初始化和自动初始化

---

## 🚀 快速开始

### 方式1: 直接使用（推荐）

```go
package main

import (
    "context"
    "fmt"
    
    cachePkg "mule-cloud/core/cache"
    cfgPkg "mule-cloud/core/config"
    dbPkg "mule-cloud/core/database"
)

func main() {
    // 1. 设置配置文件路径（可选，默认自动查找）
    cfgPkg.Cfg.SetDefaultPath("config/app.yaml")
    
    // 2. 直接使用配置（自动加载）
    cfg := cfgPkg.Cfg.Get()
    fmt.Printf("服务名: %s\n", cfg.Server.Name)
    
    // 3. 直接使用MongoDB（自动初始化）
    collection := dbPkg.MongoDB.Collection("users")
    collection.InsertOne(context.Background(), bson.M{"name": "test"})
    
    // 4. 直接使用Redis（自动初始化）
    ctx := context.Background()
    cachePkg.Redis.Set(ctx, "key", "value", time.Hour)
}
```

### 方式2: 显式初始化

```go
func main() {
    // 1. 加载配置
    cfg, err := cfgPkg.Load("config.yaml")
    if err != nil {
        log.Fatal(err)
    }
    
    // 2. 初始化MongoDB
    if cfg.MongoDB.Enabled {
        dbPkg.MongoDB.Init()
    }
    
    // 3. 初始化Redis
    if cfg.Redis.Enabled {
        cachePkg.Redis.Init()
    }
    
    // 使用...
}
```

---

## 📚 详细用法

### Config 配置实例

#### 基本使用

```go
import cfgPkg "mule-cloud/core/config"

// 获取配置（自动加载）
cfg := cfgPkg.Cfg.Get()
port := cfg.Server.Port
```

#### 高级用法

```go
// 设置默认配置路径
cfgPkg.Cfg.SetDefaultPath("config/production.yaml")

// 检查是否已加载
if cfgPkg.Cfg.IsLoaded() {
    fmt.Println("配置已加载")
}

// 强制加载（失败则panic）
cfg := cfgPkg.Cfg.MustGet()

// 重新加载配置
cfgPkg.Cfg.Reload()
```

### MongoDB 实例

#### 基本操作

```go
import (
    "context"
    dbPkg "mule-cloud/core/database"
    "go.mongodb.org/mongo-driver/bson"
)

// 方式1: 使用Collection（推荐）
collection := dbPkg.MongoDB.Collection("users")
collection.InsertOne(context.Background(), bson.M{"name": "张三"})

// 方式2: 使用DB
db := dbPkg.MongoDB.DB()
collection := db.Collection("users")

// 方式3: 使用Client
client := dbPkg.MongoDB.Client()
db := client.Database("mydb")
```

#### 完整示例

```go
package services

import (
    "context"
    "time"
    
    dbPkg "mule-cloud/core/database"
    "go.mongodb.org/mongo-driver/bson"
    "go.mongodb.org/mongo-driver/bson/primitive"
)

type User struct {
    ID        primitive.ObjectID `bson:"_id,omitempty"`
    Name      string            `bson:"name"`
    Email     string            `bson:"email"`
    CreatedAt time.Time         `bson:"created_at"`
}

// CreateUser 创建用户
func CreateUser(name, email string) (*User, error) {
    user := &User{
        Name:      name,
        Email:     email,
        CreatedAt: time.Now(),
    }
    
    // 直接使用全局实例
    collection := dbPkg.MongoDB.Collection("users")
    result, err := collection.InsertOne(context.Background(), user)
    if err != nil {
        return nil, err
    }
    
    user.ID = result.InsertedID.(primitive.ObjectID)
    return user, nil
}

// GetUser 获取用户
func GetUser(id string) (*User, error) {
    objID, _ := primitive.ObjectIDFromHex(id)
    
    var user User
    collection := dbPkg.MongoDB.Collection("users")
    err := collection.FindOne(
        context.Background(),
        bson.M{"_id": objID},
    ).Decode(&user)
    
    return &user, err
}

// UpdateUser 更新用户
func UpdateUser(id string, name, email string) error {
    objID, _ := primitive.ObjectIDFromHex(id)
    
    collection := dbPkg.MongoDB.Collection("users")
    _, err := collection.UpdateOne(
        context.Background(),
        bson.M{"_id": objID},
        bson.M{"$set": bson.M{
            "name":  name,
            "email": email,
        }},
    )
    
    return err
}

// DeleteUser 删除用户
func DeleteUser(id string) error {
    objID, _ := primitive.ObjectIDFromHex(id)
    
    collection := dbPkg.MongoDB.Collection("users")
    _, err := collection.DeleteOne(
        context.Background(),
        bson.M{"_id": objID},
    )
    
    return err
}
```

### Redis 实例

#### 基本操作

```go
import (
    "context"
    "time"
    cachePkg "mule-cloud/core/cache"
)

ctx := context.Background()

// 字符串操作
cachePkg.Redis.Set(ctx, "key", "value", time.Hour)
value, _ := cachePkg.Redis.Get(ctx, "key")

// 哈希操作
cachePkg.Redis.HSet(ctx, "user:1", "name", "张三", "age", "25")
userInfo, _ := cachePkg.Redis.HGetAll(ctx, "user:1")

// 计数器
count, _ := cachePkg.Redis.Incr(ctx, "page:views")

// 检查键是否存在
exists, _ := cachePkg.Redis.Exists(ctx, "key")
```

#### 完整示例

```go
package services

import (
    "context"
    "fmt"
    "time"
    
    cachePkg "mule-cloud/core/cache"
)

// CacheUserSession 缓存用户会话
func CacheUserSession(userID, token string) error {
    ctx := context.Background()
    key := fmt.Sprintf("session:%s", userID)
    
    // 缓存token，24小时过期
    return cachePkg.Redis.Set(ctx, key, token, 24*time.Hour)
}

// GetUserSession 获取用户会话
func GetUserSession(userID string) (string, error) {
    ctx := context.Background()
    key := fmt.Sprintf("session:%s", userID)
    return cachePkg.Redis.Get(ctx, key)
}

// DeleteUserSession 删除用户会话
func DeleteUserSession(userID string) error {
    ctx := context.Background()
    key := fmt.Sprintf("session:%s", userID)
    return cachePkg.Redis.Del(ctx, key)
}

// IncrementViewCount 增加文章浏览量
func IncrementViewCount(articleID string) (int64, error) {
    ctx := context.Background()
    key := fmt.Sprintf("article:views:%s", articleID)
    return cachePkg.Redis.Incr(ctx, key)
}

// CacheUserProfile 缓存用户资料（使用哈希）
func CacheUserProfile(userID, name, email string) error {
    ctx := context.Background()
    key := fmt.Sprintf("user:profile:%s", userID)
    
    err := cachePkg.Redis.HSet(ctx, key,
        "name", name,
        "email", email,
        "updated_at", time.Now().Format(time.RFC3339),
    )
    
    if err == nil {
        // 设置1小时过期
        cachePkg.Redis.Expire(ctx, key, time.Hour)
    }
    
    return err
}

// GetUserProfile 获取用户资料
func GetUserProfile(userID string) (map[string]string, error) {
    ctx := context.Background()
    key := fmt.Sprintf("user:profile:%s", userID)
    return cachePkg.Redis.HGetAll(ctx, key)
}
```

---

## 🔥 在服务中使用

### Service 层示例

```go
package services

import (
    "context"
    "fmt"
    "time"
    
    cachePkg "mule-cloud/core/cache"
    dbPkg "mule-cloud/core/database"
    
    "go.mongodb.org/mongo-driver/bson"
    "go.mongodb.org/mongo-driver/bson/primitive"
)

type ProductService struct{}

func NewProductService() *ProductService {
    return &ProductService{}
}

// GetProduct 获取商品（带缓存）
func (s *ProductService) GetProduct(id string) (*Product, error) {
    ctx := context.Background()
    
    // 1. 先从Redis缓存获取
    cacheKey := fmt.Sprintf("product:%s", id)
    cached, err := cachePkg.Redis.HGetAll(ctx, cacheKey)
    if err == nil && len(cached) > 0 {
        // 缓存命中
        return &Product{
            ID:    id,
            Name:  cached["name"],
            Price: cached["price"],
        }, nil
    }
    
    // 2. 缓存未命中，从MongoDB获取
    objID, _ := primitive.ObjectIDFromHex(id)
    var product Product
    
    collection := dbPkg.MongoDB.Collection("products")
    err = collection.FindOne(ctx, bson.M{"_id": objID}).Decode(&product)
    if err != nil {
        return nil, err
    }
    
    // 3. 写入缓存
    cachePkg.Redis.HSet(ctx, cacheKey,
        "name", product.Name,
        "price", product.Price,
    )
    cachePkg.Redis.Expire(ctx, cacheKey, 10*time.Minute)
    
    return &product, nil
}

// CreateProduct 创建商品
func (s *ProductService) CreateProduct(name, price string) (*Product, error) {
    ctx := context.Background()
    
    product := &Product{
        Name:      name,
        Price:     price,
        CreatedAt: time.Now(),
    }
    
    // 保存到MongoDB
    collection := dbPkg.MongoDB.Collection("products")
    result, err := collection.InsertOne(ctx, product)
    if err != nil {
        return nil, err
    }
    
    product.ID = result.InsertedID.(primitive.ObjectID).Hex()
    
    // 清除相关缓存
    cachePkg.Redis.Del(ctx, "products:list")
    
    return product, nil
}
```

---

## 🎯 最佳实践

### 1. 配置管理

```go
// ✅ 推荐：设置默认路径
func init() {
    cfgPkg.Cfg.SetDefaultPath("config/app.yaml")
}

// ❌ 不推荐：每次都手动加载
cfg, _ := cfgPkg.Load("config.yaml")
```

### 2. 错误处理

```go
// ✅ 推荐：检查连接状态
if !dbPkg.MongoDB.IsConnected() {
    log.Println("MongoDB未连接")
}

// ✅ 推荐：使用defer关闭连接
defer func() {
    dbPkg.MongoDB.Close()
    cachePkg.Redis.Close()
}()
```

### 3. 缓存策略

```go
// ✅ 推荐：先缓存后数据库
func GetData(id string) (*Data, error) {
    // 1. 尝试从缓存获取
    if cached := getFromCache(id); cached != nil {
        return cached, nil
    }
    
    // 2. 从数据库获取
    data := getFromDB(id)
    
    // 3. 写入缓存
    setToCache(id, data)
    
    return data, nil
}
```

### 4. 懒加载时机

```go
// ✅ 推荐：在main函数中显式初始化
func main() {
    // 先加载配置
    cfg, _ := cfgPkg.Load("config.yaml")
    
    // 然后显式初始化（可选）
    if cfg.MongoDB.Enabled {
        dbPkg.MongoDB.Init()
    }
    
    // ... 启动服务
}

// ✅ 推荐：或者让首次使用时自动初始化
func main() {
    cfgPkg.Cfg.SetDefaultPath("config.yaml")
    // MongoDB 和 Redis 会在首次使用时自动初始化
}
```

---

## ⚠️ 注意事项

### 1. 配置必须先加载

```go
// ❌ 错误：配置未加载就使用MongoDB
dbPkg.MongoDB.Collection("users") // 可能失败

// ✅ 正确：先设置配置路径或加载配置
cfgPkg.Cfg.SetDefaultPath("config.yaml")
dbPkg.MongoDB.Collection("users") // 自动加载配置并初始化
```

### 2. 并发安全

```go
// ✅ 全局实例是并发安全的
go func() {
    dbPkg.MongoDB.Collection("users") // 安全
}()

go func() {
    cachePkg.Redis.Get(ctx, "key") // 安全
}()
```

### 3. 连接池复用

```go
// ✅ 推荐：复用全局实例
collection := dbPkg.MongoDB.Collection("users")

// ❌ 不推荐：重复初始化
dbPkg.InitMongoDB(&cfg.MongoDB) // 不要多次调用
```

---

## 🚀 迁移指南

### 从旧方式迁移

#### 旧方式（手动初始化）

```go
// 旧代码
cfg, _ := config.Load("config.yaml")
mongoClient, _ := database.InitMongoDB(&cfg.MongoDB)
redisClient, _ := cache.InitRedis(&cfg.Redis)

db := mongoClient.Database(cfg.MongoDB.Database)
collection := db.Collection("users")
```

#### 新方式（全局实例）

```go
// 新代码
config.Cfg.SetDefaultPath("config.yaml")

// 直接使用
collection := database.MongoDB.Collection("users")
cache.Redis.Set(ctx, "key", "value", time.Hour)
```

---

## 📝 总结

### 优点

- ✅ 简化代码，减少样板代码
- ✅ 自动初始化，开箱即用
- ✅ 线程安全，无需担心并发
- ✅ 懒加载，按需初始化

### 适用场景

- ✅ 快速开发和原型
- ✅ 小型到中型项目
- ✅ 需要全局访问数据库/缓存的场景

### 不适用场景

- ❌ 需要多个MongoDB/Redis实例
- ❌ 需要精细控制初始化时机
- ❌ 需要依赖注入框架

---

**快速开发，优雅使用！🚀**
