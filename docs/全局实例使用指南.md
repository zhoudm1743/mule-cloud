# å…¨å±€å®ä¾‹ä½¿ç”¨æŒ‡å—

## ğŸ“– æ¦‚è¿°

æœ¬é¡¹ç›®æä¾›äº† **æ‡’åŠ è½½å…¨å±€å®ä¾‹**ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨è€Œæ— éœ€æ‰‹åŠ¨åˆå§‹åŒ–ï¼š
- âœ… **config.Cfg**: å…¨å±€é…ç½®å®ä¾‹
- âœ… **database.MongoDB**: å…¨å±€MongoDBå®ä¾‹
- âœ… **cache.Redis**: å…¨å±€Rediså®ä¾‹

**ç‰¹æ€§**:
- ğŸ”„ **æ‡’åŠ è½½**: é¦–æ¬¡ä½¿ç”¨æ—¶è‡ªåŠ¨åˆå§‹åŒ–
- ğŸ”’ **çº¿ç¨‹å®‰å…¨**: ä½¿ç”¨ `sync.Once` ä¿è¯åªåˆå§‹åŒ–ä¸€æ¬¡
- ğŸš€ **é›¶é…ç½®**: å¼€ç®±å³ç”¨
- ğŸ¯ **çµæ´»**: æ”¯æŒæ‰‹åŠ¨åˆå§‹åŒ–å’Œè‡ªåŠ¨åˆå§‹åŒ–

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹å¼1: ç›´æ¥ä½¿ç”¨ï¼ˆæ¨èï¼‰

```go
package main

import (
    "context"
    "fmt"
    
    cachePkg "mule-cloud/core/cache"
    cfgPkg "mule-cloud/core/config"
    dbPkg "mule-cloud/core/database"
)

func main() {
    // 1. è®¾ç½®é…ç½®æ–‡ä»¶è·¯å¾„ï¼ˆå¯é€‰ï¼Œé»˜è®¤è‡ªåŠ¨æŸ¥æ‰¾ï¼‰
    cfgPkg.Cfg.SetDefaultPath("config/app.yaml")
    
    // 2. ç›´æ¥ä½¿ç”¨é…ç½®ï¼ˆè‡ªåŠ¨åŠ è½½ï¼‰
    cfg := cfgPkg.Cfg.Get()
    fmt.Printf("æœåŠ¡å: %s\n", cfg.Server.Name)
    
    // 3. ç›´æ¥ä½¿ç”¨MongoDBï¼ˆè‡ªåŠ¨åˆå§‹åŒ–ï¼‰
    collection := dbPkg.MongoDB.Collection("users")
    collection.InsertOne(context.Background(), bson.M{"name": "test"})
    
    // 4. ç›´æ¥ä½¿ç”¨Redisï¼ˆè‡ªåŠ¨åˆå§‹åŒ–ï¼‰
    ctx := context.Background()
    cachePkg.Redis.Set(ctx, "key", "value", time.Hour)
}
```

### æ–¹å¼2: æ˜¾å¼åˆå§‹åŒ–

```go
func main() {
    // 1. åŠ è½½é…ç½®
    cfg, err := cfgPkg.Load("config.yaml")
    if err != nil {
        log.Fatal(err)
    }
    
    // 2. åˆå§‹åŒ–MongoDB
    if cfg.MongoDB.Enabled {
        dbPkg.MongoDB.Init()
    }
    
    // 3. åˆå§‹åŒ–Redis
    if cfg.Redis.Enabled {
        cachePkg.Redis.Init()
    }
    
    // ä½¿ç”¨...
}
```

---

## ğŸ“š è¯¦ç»†ç”¨æ³•

### Config é…ç½®å®ä¾‹

#### åŸºæœ¬ä½¿ç”¨

```go
import cfgPkg "mule-cloud/core/config"

// è·å–é…ç½®ï¼ˆè‡ªåŠ¨åŠ è½½ï¼‰
cfg := cfgPkg.Cfg.Get()
port := cfg.Server.Port
```

#### é«˜çº§ç”¨æ³•

```go
// è®¾ç½®é»˜è®¤é…ç½®è·¯å¾„
cfgPkg.Cfg.SetDefaultPath("config/production.yaml")

// æ£€æŸ¥æ˜¯å¦å·²åŠ è½½
if cfgPkg.Cfg.IsLoaded() {
    fmt.Println("é…ç½®å·²åŠ è½½")
}

// å¼ºåˆ¶åŠ è½½ï¼ˆå¤±è´¥åˆ™panicï¼‰
cfg := cfgPkg.Cfg.MustGet()

// é‡æ–°åŠ è½½é…ç½®
cfgPkg.Cfg.Reload()
```

### MongoDB å®ä¾‹

#### åŸºæœ¬æ“ä½œ

```go
import (
    "context"
    dbPkg "mule-cloud/core/database"
    "go.mongodb.org/mongo-driver/bson"
)

// æ–¹å¼1: ä½¿ç”¨Collectionï¼ˆæ¨èï¼‰
collection := dbPkg.MongoDB.Collection("users")
collection.InsertOne(context.Background(), bson.M{"name": "å¼ ä¸‰"})

// æ–¹å¼2: ä½¿ç”¨DB
db := dbPkg.MongoDB.DB()
collection := db.Collection("users")

// æ–¹å¼3: ä½¿ç”¨Client
client := dbPkg.MongoDB.Client()
db := client.Database("mydb")
```

#### å®Œæ•´ç¤ºä¾‹

```go
package services

import (
    "context"
    "time"
    
    dbPkg "mule-cloud/core/database"
    "go.mongodb.org/mongo-driver/bson"
    "go.mongodb.org/mongo-driver/bson/primitive"
)

type User struct {
    ID        primitive.ObjectID `bson:"_id,omitempty"`
    Name      string            `bson:"name"`
    Email     string            `bson:"email"`
    CreatedAt time.Time         `bson:"created_at"`
}

// CreateUser åˆ›å»ºç”¨æˆ·
func CreateUser(name, email string) (*User, error) {
    user := &User{
        Name:      name,
        Email:     email,
        CreatedAt: time.Now(),
    }
    
    // ç›´æ¥ä½¿ç”¨å…¨å±€å®ä¾‹
    collection := dbPkg.MongoDB.Collection("users")
    result, err := collection.InsertOne(context.Background(), user)
    if err != nil {
        return nil, err
    }
    
    user.ID = result.InsertedID.(primitive.ObjectID)
    return user, nil
}

// GetUser è·å–ç”¨æˆ·
func GetUser(id string) (*User, error) {
    objID, _ := primitive.ObjectIDFromHex(id)
    
    var user User
    collection := dbPkg.MongoDB.Collection("users")
    err := collection.FindOne(
        context.Background(),
        bson.M{"_id": objID},
    ).Decode(&user)
    
    return &user, err
}

// UpdateUser æ›´æ–°ç”¨æˆ·
func UpdateUser(id string, name, email string) error {
    objID, _ := primitive.ObjectIDFromHex(id)
    
    collection := dbPkg.MongoDB.Collection("users")
    _, err := collection.UpdateOne(
        context.Background(),
        bson.M{"_id": objID},
        bson.M{"$set": bson.M{
            "name":  name,
            "email": email,
        }},
    )
    
    return err
}

// DeleteUser åˆ é™¤ç”¨æˆ·
func DeleteUser(id string) error {
    objID, _ := primitive.ObjectIDFromHex(id)
    
    collection := dbPkg.MongoDB.Collection("users")
    _, err := collection.DeleteOne(
        context.Background(),
        bson.M{"_id": objID},
    )
    
    return err
}
```

### Redis å®ä¾‹

#### åŸºæœ¬æ“ä½œ

```go
import (
    "context"
    "time"
    cachePkg "mule-cloud/core/cache"
)

ctx := context.Background()

// å­—ç¬¦ä¸²æ“ä½œ
cachePkg.Redis.Set(ctx, "key", "value", time.Hour)
value, _ := cachePkg.Redis.Get(ctx, "key")

// å“ˆå¸Œæ“ä½œ
cachePkg.Redis.HSet(ctx, "user:1", "name", "å¼ ä¸‰", "age", "25")
userInfo, _ := cachePkg.Redis.HGetAll(ctx, "user:1")

// è®¡æ•°å™¨
count, _ := cachePkg.Redis.Incr(ctx, "page:views")

// æ£€æŸ¥é”®æ˜¯å¦å­˜åœ¨
exists, _ := cachePkg.Redis.Exists(ctx, "key")
```

#### å®Œæ•´ç¤ºä¾‹

```go
package services

import (
    "context"
    "fmt"
    "time"
    
    cachePkg "mule-cloud/core/cache"
)

// CacheUserSession ç¼“å­˜ç”¨æˆ·ä¼šè¯
func CacheUserSession(userID, token string) error {
    ctx := context.Background()
    key := fmt.Sprintf("session:%s", userID)
    
    // ç¼“å­˜tokenï¼Œ24å°æ—¶è¿‡æœŸ
    return cachePkg.Redis.Set(ctx, key, token, 24*time.Hour)
}

// GetUserSession è·å–ç”¨æˆ·ä¼šè¯
func GetUserSession(userID string) (string, error) {
    ctx := context.Background()
    key := fmt.Sprintf("session:%s", userID)
    return cachePkg.Redis.Get(ctx, key)
}

// DeleteUserSession åˆ é™¤ç”¨æˆ·ä¼šè¯
func DeleteUserSession(userID string) error {
    ctx := context.Background()
    key := fmt.Sprintf("session:%s", userID)
    return cachePkg.Redis.Del(ctx, key)
}

// IncrementViewCount å¢åŠ æ–‡ç« æµè§ˆé‡
func IncrementViewCount(articleID string) (int64, error) {
    ctx := context.Background()
    key := fmt.Sprintf("article:views:%s", articleID)
    return cachePkg.Redis.Incr(ctx, key)
}

// CacheUserProfile ç¼“å­˜ç”¨æˆ·èµ„æ–™ï¼ˆä½¿ç”¨å“ˆå¸Œï¼‰
func CacheUserProfile(userID, name, email string) error {
    ctx := context.Background()
    key := fmt.Sprintf("user:profile:%s", userID)
    
    err := cachePkg.Redis.HSet(ctx, key,
        "name", name,
        "email", email,
        "updated_at", time.Now().Format(time.RFC3339),
    )
    
    if err == nil {
        // è®¾ç½®1å°æ—¶è¿‡æœŸ
        cachePkg.Redis.Expire(ctx, key, time.Hour)
    }
    
    return err
}

// GetUserProfile è·å–ç”¨æˆ·èµ„æ–™
func GetUserProfile(userID string) (map[string]string, error) {
    ctx := context.Background()
    key := fmt.Sprintf("user:profile:%s", userID)
    return cachePkg.Redis.HGetAll(ctx, key)
}
```

---

## ğŸ”¥ åœ¨æœåŠ¡ä¸­ä½¿ç”¨

### Service å±‚ç¤ºä¾‹

```go
package services

import (
    "context"
    "fmt"
    "time"
    
    cachePkg "mule-cloud/core/cache"
    dbPkg "mule-cloud/core/database"
    
    "go.mongodb.org/mongo-driver/bson"
    "go.mongodb.org/mongo-driver/bson/primitive"
)

type ProductService struct{}

func NewProductService() *ProductService {
    return &ProductService{}
}

// GetProduct è·å–å•†å“ï¼ˆå¸¦ç¼“å­˜ï¼‰
func (s *ProductService) GetProduct(id string) (*Product, error) {
    ctx := context.Background()
    
    // 1. å…ˆä»Redisç¼“å­˜è·å–
    cacheKey := fmt.Sprintf("product:%s", id)
    cached, err := cachePkg.Redis.HGetAll(ctx, cacheKey)
    if err == nil && len(cached) > 0 {
        // ç¼“å­˜å‘½ä¸­
        return &Product{
            ID:    id,
            Name:  cached["name"],
            Price: cached["price"],
        }, nil
    }
    
    // 2. ç¼“å­˜æœªå‘½ä¸­ï¼Œä»MongoDBè·å–
    objID, _ := primitive.ObjectIDFromHex(id)
    var product Product
    
    collection := dbPkg.MongoDB.Collection("products")
    err = collection.FindOne(ctx, bson.M{"_id": objID}).Decode(&product)
    if err != nil {
        return nil, err
    }
    
    // 3. å†™å…¥ç¼“å­˜
    cachePkg.Redis.HSet(ctx, cacheKey,
        "name", product.Name,
        "price", product.Price,
    )
    cachePkg.Redis.Expire(ctx, cacheKey, 10*time.Minute)
    
    return &product, nil
}

// CreateProduct åˆ›å»ºå•†å“
func (s *ProductService) CreateProduct(name, price string) (*Product, error) {
    ctx := context.Background()
    
    product := &Product{
        Name:      name,
        Price:     price,
        CreatedAt: time.Now(),
    }
    
    // ä¿å­˜åˆ°MongoDB
    collection := dbPkg.MongoDB.Collection("products")
    result, err := collection.InsertOne(ctx, product)
    if err != nil {
        return nil, err
    }
    
    product.ID = result.InsertedID.(primitive.ObjectID).Hex()
    
    // æ¸…é™¤ç›¸å…³ç¼“å­˜
    cachePkg.Redis.Del(ctx, "products:list")
    
    return product, nil
}
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. é…ç½®ç®¡ç†

```go
// âœ… æ¨èï¼šè®¾ç½®é»˜è®¤è·¯å¾„
func init() {
    cfgPkg.Cfg.SetDefaultPath("config/app.yaml")
}

// âŒ ä¸æ¨èï¼šæ¯æ¬¡éƒ½æ‰‹åŠ¨åŠ è½½
cfg, _ := cfgPkg.Load("config.yaml")
```

### 2. é”™è¯¯å¤„ç†

```go
// âœ… æ¨èï¼šæ£€æŸ¥è¿æ¥çŠ¶æ€
if !dbPkg.MongoDB.IsConnected() {
    log.Println("MongoDBæœªè¿æ¥")
}

// âœ… æ¨èï¼šä½¿ç”¨deferå…³é—­è¿æ¥
defer func() {
    dbPkg.MongoDB.Close()
    cachePkg.Redis.Close()
}()
```

### 3. ç¼“å­˜ç­–ç•¥

```go
// âœ… æ¨èï¼šå…ˆç¼“å­˜åæ•°æ®åº“
func GetData(id string) (*Data, error) {
    // 1. å°è¯•ä»ç¼“å­˜è·å–
    if cached := getFromCache(id); cached != nil {
        return cached, nil
    }
    
    // 2. ä»æ•°æ®åº“è·å–
    data := getFromDB(id)
    
    // 3. å†™å…¥ç¼“å­˜
    setToCache(id, data)
    
    return data, nil
}
```

### 4. æ‡’åŠ è½½æ—¶æœº

```go
// âœ… æ¨èï¼šåœ¨mainå‡½æ•°ä¸­æ˜¾å¼åˆå§‹åŒ–
func main() {
    // å…ˆåŠ è½½é…ç½®
    cfg, _ := cfgPkg.Load("config.yaml")
    
    // ç„¶åæ˜¾å¼åˆå§‹åŒ–ï¼ˆå¯é€‰ï¼‰
    if cfg.MongoDB.Enabled {
        dbPkg.MongoDB.Init()
    }
    
    // ... å¯åŠ¨æœåŠ¡
}

// âœ… æ¨èï¼šæˆ–è€…è®©é¦–æ¬¡ä½¿ç”¨æ—¶è‡ªåŠ¨åˆå§‹åŒ–
func main() {
    cfgPkg.Cfg.SetDefaultPath("config.yaml")
    // MongoDB å’Œ Redis ä¼šåœ¨é¦–æ¬¡ä½¿ç”¨æ—¶è‡ªåŠ¨åˆå§‹åŒ–
}
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. é…ç½®å¿…é¡»å…ˆåŠ è½½

```go
// âŒ é”™è¯¯ï¼šé…ç½®æœªåŠ è½½å°±ä½¿ç”¨MongoDB
dbPkg.MongoDB.Collection("users") // å¯èƒ½å¤±è´¥

// âœ… æ­£ç¡®ï¼šå…ˆè®¾ç½®é…ç½®è·¯å¾„æˆ–åŠ è½½é…ç½®
cfgPkg.Cfg.SetDefaultPath("config.yaml")
dbPkg.MongoDB.Collection("users") // è‡ªåŠ¨åŠ è½½é…ç½®å¹¶åˆå§‹åŒ–
```

### 2. å¹¶å‘å®‰å…¨

```go
// âœ… å…¨å±€å®ä¾‹æ˜¯å¹¶å‘å®‰å…¨çš„
go func() {
    dbPkg.MongoDB.Collection("users") // å®‰å…¨
}()

go func() {
    cachePkg.Redis.Get(ctx, "key") // å®‰å…¨
}()
```

### 3. è¿æ¥æ± å¤ç”¨

```go
// âœ… æ¨èï¼šå¤ç”¨å…¨å±€å®ä¾‹
collection := dbPkg.MongoDB.Collection("users")

// âŒ ä¸æ¨èï¼šé‡å¤åˆå§‹åŒ–
dbPkg.InitMongoDB(&cfg.MongoDB) // ä¸è¦å¤šæ¬¡è°ƒç”¨
```

---

## ğŸš€ è¿ç§»æŒ‡å—

### ä»æ—§æ–¹å¼è¿ç§»

#### æ—§æ–¹å¼ï¼ˆæ‰‹åŠ¨åˆå§‹åŒ–ï¼‰

```go
// æ—§ä»£ç 
cfg, _ := config.Load("config.yaml")
mongoClient, _ := database.InitMongoDB(&cfg.MongoDB)
redisClient, _ := cache.InitRedis(&cfg.Redis)

db := mongoClient.Database(cfg.MongoDB.Database)
collection := db.Collection("users")
```

#### æ–°æ–¹å¼ï¼ˆå…¨å±€å®ä¾‹ï¼‰

```go
// æ–°ä»£ç 
config.Cfg.SetDefaultPath("config.yaml")

// ç›´æ¥ä½¿ç”¨
collection := database.MongoDB.Collection("users")
cache.Redis.Set(ctx, "key", "value", time.Hour)
```

---

## ğŸ“ æ€»ç»“

### ä¼˜ç‚¹

- âœ… ç®€åŒ–ä»£ç ï¼Œå‡å°‘æ ·æ¿ä»£ç 
- âœ… è‡ªåŠ¨åˆå§‹åŒ–ï¼Œå¼€ç®±å³ç”¨
- âœ… çº¿ç¨‹å®‰å…¨ï¼Œæ— éœ€æ‹…å¿ƒå¹¶å‘
- âœ… æ‡’åŠ è½½ï¼ŒæŒ‰éœ€åˆå§‹åŒ–

### é€‚ç”¨åœºæ™¯

- âœ… å¿«é€Ÿå¼€å‘å’ŒåŸå‹
- âœ… å°å‹åˆ°ä¸­å‹é¡¹ç›®
- âœ… éœ€è¦å…¨å±€è®¿é—®æ•°æ®åº“/ç¼“å­˜çš„åœºæ™¯

### ä¸é€‚ç”¨åœºæ™¯

- âŒ éœ€è¦å¤šä¸ªMongoDB/Rediså®ä¾‹
- âŒ éœ€è¦ç²¾ç»†æ§åˆ¶åˆå§‹åŒ–æ—¶æœº
- âŒ éœ€è¦ä¾èµ–æ³¨å…¥æ¡†æ¶

---

**å¿«é€Ÿå¼€å‘ï¼Œä¼˜é›…ä½¿ç”¨ï¼ğŸš€**
