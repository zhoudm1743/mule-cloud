# æ–°æƒé™ä½“ç³» - ç§Ÿæˆ·éš”ç¦»

## ğŸ¯ è®¾è®¡ç›®æ ‡

å®ç°**å¤šç§Ÿæˆ·æƒé™éš”ç¦»**ï¼Œæ¯ä¸ªç§Ÿæˆ·æ‹¥æœ‰è‡ªå·±çš„è¶…çº§ç®¡ç†å‘˜ï¼ŒåŒæ—¶ä¿ç•™ç³»ç»Ÿçº§è¶…çº§ç®¡ç†å‘˜ç”¨äºè·¨ç§Ÿæˆ·ç®¡ç†ã€‚

## ğŸ“ æ¶æ„è®¾è®¡

### ä¸‰çº§æƒé™ä½“ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ç³»ç»Ÿçº§è¶…ç®¡ (super)                     â”‚
â”‚    tenant_id: ""  +  role: ["super"]            â”‚
â”‚    - è·¨ç§Ÿæˆ·è®¿é—®æ‰€æœ‰èµ„æº                          â”‚
â”‚    - ç®¡ç†æ‰€æœ‰ç§Ÿæˆ·                                â”‚
â”‚    - åˆ›å»º/åˆ é™¤ç§Ÿæˆ·                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ç§Ÿæˆ·çº§è¶…ç®¡ (tenant_admin)                â”‚
â”‚    tenant_id: "xxx"  +  role: ["tenant_admin"]  â”‚
â”‚    - ä»…è®¿é—®æœ¬ç§Ÿæˆ·èµ„æº                            â”‚
â”‚    - ç®¡ç†æœ¬ç§Ÿæˆ·ç”¨æˆ·                              â”‚
â”‚    - ç®¡ç†æœ¬ç§Ÿæˆ·è§’è‰²                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ™®é€šç”¨æˆ· (user)                     â”‚
â”‚    tenant_id: "xxx"  +  role: ["user"]          â”‚
â”‚    - é€šè¿‡ Casbin è§’è‰²åˆ†é…æƒé™                    â”‚
â”‚    - ç»†ç²’åº¦æƒé™æ§åˆ¶                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”‘ è§’è‰²å®šä¹‰

### 1. **super** - ç³»ç»Ÿçº§è¶…ç®¡
```javascript
{
    _id: ObjectId("..."),
    tenant_id: "",              // âœ… å¿…é¡»ä¸ºç©ºå­—ç¬¦ä¸²
    role: ["super"],            // âœ… æ•°ç»„æ ¼å¼
    phone: "13800138000",
    nickname: "ç³»ç»Ÿç®¡ç†å‘˜",
    // ...
}
```

**æƒé™èŒƒå›´**ï¼š
- âœ… è®¿é—®æ‰€æœ‰ç§Ÿæˆ·æ•°æ®
- âœ… åˆ›å»º/åˆ é™¤/ç®¡ç†ç§Ÿæˆ·
- âœ… æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·
- âœ… è·¨ç§Ÿæˆ·æ“ä½œ
- âœ… **Gateway ç›´æ¥æ”¾è¡Œï¼Œæ— éœ€ Casbin æ£€æŸ¥**

### 2. **tenant_admin** - ç§Ÿæˆ·çº§è¶…ç®¡
```javascript
{
    _id: ObjectId("..."),
    tenant_id: "68dd0...",      // âœ… å¿…é¡»æœ‰å…·ä½“ç§Ÿæˆ·ID
    role: ["tenant_admin"],     // âœ… æ•°ç»„æ ¼å¼
    phone: "13900139000",
    nickname: "ç§Ÿæˆ·Aç®¡ç†å‘˜",
    // ...
}
```

**æƒé™èŒƒå›´**ï¼š
- âœ… è®¿é—®æœ¬ç§Ÿæˆ·æ‰€æœ‰èµ„æº
- âœ… ç®¡ç†æœ¬ç§Ÿæˆ·ç”¨æˆ·
- âœ… ç®¡ç†æœ¬ç§Ÿæˆ·è§’è‰²
- âœ… åˆ†é…æœ¬ç§Ÿæˆ·æƒé™
- âŒ **ä¸èƒ½è®¿é—®å…¶ä»–ç§Ÿæˆ·æ•°æ®**
- âœ… **Gateway ç›´æ¥æ”¾è¡Œï¼Œæ— éœ€ Casbin æ£€æŸ¥**

### 3. **user** - æ™®é€šç”¨æˆ·
```javascript
{
    _id: ObjectId("..."),
    tenant_id: "68dd0...",      // âœ… å¿…é¡»æœ‰ç§Ÿæˆ·ID
    role: ["user"],             // âœ… æ•°ç»„æ ¼å¼
    phone: "13700137000",
    nickname: "æ™®é€šç”¨æˆ·",
    // ...
}
```

**æƒé™èŒƒå›´**ï¼š
- âœ… é€šè¿‡ Casbin è§’è‰²è·å–æƒé™
- âœ… ç»†ç²’åº¦æƒé™æ§åˆ¶ï¼ˆCRUD + ä¸šåŠ¡æƒé™ï¼‰
- âŒ **å¿…é¡»é€šè¿‡ Casbin æƒé™æ£€æŸ¥**

## ğŸ” JWT Token ç»“æ„

```json
{
  "user_id": "68dcf02...",
  "username": "ç¾Šç´«æ—",
  "tenant_id": "68dd0...",      // âœ… æ–°å¢ï¼šç§Ÿæˆ·ID
  "roles": ["tenant_admin"],    // âœ… è§’è‰²æ•°ç»„
  "exp": 1759452196,
  "iat": 1759365796
}
```

## ğŸšª Gateway é‰´æƒæµç¨‹

```go
// 1. æå–ç”¨æˆ·ä¿¡æ¯
userID := c.Get("user_id")
tenantID := c.Get("tenant_id")
roles := c.Get("roles")

// 2. æ£€æŸ¥ç³»ç»Ÿçº§è¶…ç®¡ï¼ˆæ— ç§Ÿæˆ·é™åˆ¶ï¼‰
if role == "super" && tenantID == "" {
    // âœ… ç›´æ¥æ”¾è¡Œ
    return
}

// 3. æ£€æŸ¥ç§Ÿæˆ·çº§è¶…ç®¡ï¼ˆæœ¬ç§Ÿæˆ·æ‰€æœ‰æƒé™ï¼‰
if role == "tenant_admin" && tenantID != "" {
    // âœ… ç›´æ¥æ”¾è¡Œ
    return
}

// 4. æ™®é€šç”¨æˆ·èµ° Casbin æ£€æŸ¥
userSub := fmt.Sprintf("tenant:%s:user:%s", tenantID, userID)
allowed := casbin.CheckPermission(userSub, resource, action)
```

## ğŸ“Š æ•°æ®éš”ç¦»

### ç§Ÿæˆ·æ•°æ®éš”ç¦»è§„åˆ™

| æ“ä½œ | ç³»ç»Ÿè¶…ç®¡ | ç§Ÿæˆ·è¶…ç®¡ | æ™®é€šç”¨æˆ· |
|------|---------|---------|---------|
| æŸ¥çœ‹ç§Ÿæˆ·Aæ•°æ® | âœ… å…¨éƒ¨ | âœ… ä»…A | âš ï¸ éœ€Casbin |
| æŸ¥çœ‹ç§Ÿæˆ·Bæ•°æ® | âœ… å…¨éƒ¨ | âŒ æ‹’ç» | âŒ æ‹’ç» |
| åˆ›å»ºç§Ÿæˆ· | âœ… å…è®¸ | âŒ æ‹’ç» | âŒ æ‹’ç» |
| ç®¡ç†æœ¬ç§Ÿæˆ·ç”¨æˆ· | âœ… å…è®¸ | âœ… å…è®¸ | âš ï¸ éœ€Casbin |
| è·¨ç§Ÿæˆ·æ“ä½œ | âœ… å…è®¸ | âŒ æ‹’ç» | âŒ æ‹’ç» |

## ğŸ”„ æ•°æ®è¿ç§»

è¿è¡Œè¿ç§»è„šæœ¬ï¼š

```bash
# è¿ç§»ç°æœ‰è§’è‰²æ•°æ®
mongo mule-cloud scripts/migrate_roles_system.js
```

è¿ç§»å†…å®¹ï¼š
1. âœ… å°†æœ‰ `tenant_id` çš„ `super` æ”¹ä¸º `tenant_admin`
2. âœ… è§„èŒƒåŒ–ç³»ç»Ÿçº§ `super` çš„ `tenant_id` ä¸ºç©ºå­—ç¬¦ä¸²
3. âœ… å°†æ‰€æœ‰ `role` å­—æ®µç»Ÿä¸€ä¸ºæ•°ç»„æ ¼å¼
4. âœ… ä¸ºæ— è§’è‰²ç”¨æˆ·è®¾ç½®é»˜è®¤ `user` è§’è‰²

## ğŸ¨ å‰ç«¯æƒé™åˆ¤æ–­

```typescript
// 1. æ£€æŸ¥è§’è‰²æƒé™
if (hasPermission('super') || hasPermission('tenant_admin')) {
  // è¶…ç®¡å¯ä»¥è®¿é—®
}

// 2. æ£€æŸ¥æ“ä½œæƒé™
if (hasAction('admin', 'create')) {
  // æœ‰åˆ›å»ºç®¡ç†å‘˜æƒé™
}

// 3. æ£€æŸ¥èµ„æºæƒé™
if (hasResource('admin:create')) {
  // æœ‰åˆ›å»ºç®¡ç†å‘˜æƒé™
}
```

## ğŸ›¡ï¸ å®‰å…¨æ€§

### ç§Ÿæˆ·éš”ç¦»ä¿è¯

1. **JWT Token åŒ…å« tenant_id**ï¼šæ— æ³•ä¼ªé€ å…¶ä»–ç§Ÿæˆ·èº«ä»½
2. **Gateway éªŒè¯ç§Ÿæˆ·å½’å±**ï¼šä¸¥æ ¼æ£€æŸ¥ tenant_id åŒ¹é…
3. **Casbin ç­–ç•¥åŒ…å«ç§Ÿæˆ·å‰ç¼€**ï¼š`tenant:A:user:123` vs `tenant:B:user:456`
4. **ä¸šåŠ¡å±‚äºŒæ¬¡æ ¡éªŒ**ï¼šå…³é”®æ“ä½œå†æ¬¡éªŒè¯ tenant_id

### é˜²æ­¢è¶Šæƒ

```go
// âŒ é”™è¯¯ï¼šæœªéªŒè¯ç§Ÿæˆ·
db.admin.find({ _id: userID })

// âœ… æ­£ç¡®ï¼šå§‹ç»ˆå¸¦ä¸Šç§Ÿæˆ·è¿‡æ»¤
db.admin.find({ _id: userID, tenant_id: tenantID })
```

## ğŸ“ æœ€ä½³å®è·µ

### 1. åˆ›å»ºç§Ÿæˆ·æ—¶è‡ªåŠ¨åˆ›å»ºè¶…ç®¡

```javascript
// åˆ›å»ºç§Ÿæˆ·
const tenant = {
    name: "æ–°ç§Ÿæˆ·",
    // ...
}

// è‡ªåŠ¨åˆ›å»ºç§Ÿæˆ·è¶…ç®¡
const admin = {
    tenant_id: tenant._id,
    role: ["tenant_admin"],
    phone: "...",
    nickname: "ç§Ÿæˆ·ç®¡ç†å‘˜"
}
```

### 2. ç§Ÿæˆ·è¶…ç®¡ä¸èƒ½æå‡ä¸ºç³»ç»Ÿè¶…ç®¡

```go
// åªæœ‰ç³»ç»Ÿè¶…ç®¡å¯ä»¥ä¿®æ”¹ç”¨æˆ·çš„ tenant_id
if userRole != "super" {
    // æ™®é€šç”¨æˆ·å’Œç§Ÿæˆ·è¶…ç®¡ä¸èƒ½ä¿®æ”¹ tenant_id
    if newTenantID != currentUser.TenantID {
        return errors.New("æ— æƒä¿®æ”¹ç§Ÿæˆ·å½’å±")
    }
}
```

### 3. æ‰€æœ‰æ•°æ®åº“æŸ¥è¯¢å¸¦ç§Ÿæˆ·è¿‡æ»¤

```go
// åç«¯æŸ¥è¯¢å§‹ç»ˆåŒ…å«ç§Ÿæˆ·è¿‡æ»¤
filter := bson.M{
    "tenant_id": currentUser.TenantID,
    // å…¶ä»–æ¡ä»¶...
}
```

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šç§Ÿæˆ·è¶…ç®¡çœ‹ä¸åˆ°æ•°æ®
- âœ… æ£€æŸ¥ `tenant_id` æ˜¯å¦æ­£ç¡®
- âœ… æ£€æŸ¥ `role` æ˜¯å¦ä¸º `["tenant_admin"]`
- âœ… æ£€æŸ¥ JWT Token æ˜¯å¦åŒ…å«æ­£ç¡®çš„ `tenant_id`

### é—®é¢˜2ï¼šç³»ç»Ÿè¶…ç®¡æ— æ³•è·¨ç§Ÿæˆ·è®¿é—®
- âœ… æ£€æŸ¥ `tenant_id` æ˜¯å¦ä¸ºç©ºå­—ç¬¦ä¸² `""`
- âœ… æ£€æŸ¥ `role` æ˜¯å¦ä¸º `["super"]`
- âœ… æ£€æŸ¥ Gateway æ—¥å¿—ç¡®è®¤é‰´æƒæµç¨‹

### é—®é¢˜3ï¼šæ™®é€šç”¨æˆ·æƒé™å¼‚å¸¸
- âœ… æ£€æŸ¥ Casbin ç­–ç•¥æ˜¯å¦æ­£ç¡®
- âœ… æ£€æŸ¥è§’è‰²èœå•æƒé™é…ç½®
- âœ… æ£€æŸ¥ `tenant_id` å‰ç¼€æ˜¯å¦ä¸€è‡´

## ğŸ¯ æ€»ç»“

| ç‰¹æ€§ | ç³»ç»Ÿè¶…ç®¡ | ç§Ÿæˆ·è¶…ç®¡ | æ™®é€šç”¨æˆ· |
|------|---------|---------|---------|
| tenant_id | "" | "xxx" | "xxx" |
| role | ["super"] | ["tenant_admin"] | ["user"] |
| è·¨ç§Ÿæˆ·è®¿é—® | âœ… | âŒ | âŒ |
| ç›´æ¥æ”¾è¡Œ | âœ… | âœ… | âŒ |
| Casbinæ£€æŸ¥ | âŒ | âŒ | âœ… |
| æ•°æ®éš”ç¦» | å…¨éƒ¨ | æœ¬ç§Ÿæˆ· | Casbin |

