# 新权限体系 - 租户隔离

## 🎯 设计目标

实现**多租户权限隔离**，每个租户拥有自己的超级管理员，同时保留系统级超级管理员用于跨租户管理。

## 📐 架构设计

### 三级权限体系

```
┌─────────────────────────────────────────────────┐
│           系统级超管 (super)                     │
│    tenant_id: ""  +  role: ["super"]            │
│    - 跨租户访问所有资源                          │
│    - 管理所有租户                                │
│    - 创建/删除租户                               │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│         租户级超管 (tenant_admin)                │
│    tenant_id: "xxx"  +  role: ["tenant_admin"]  │
│    - 仅访问本租户资源                            │
│    - 管理本租户用户                              │
│    - 管理本租户角色                              │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│              普通用户 (user)                     │
│    tenant_id: "xxx"  +  role: ["user"]          │
│    - 通过 Casbin 角色分配权限                    │
│    - 细粒度权限控制                              │
└─────────────────────────────────────────────────┘
```

## 🔑 角色定义

### 1. **super** - 系统级超管
```javascript
{
    _id: ObjectId("..."),
    tenant_id: "",              // ✅ 必须为空字符串
    role: ["super"],            // ✅ 数组格式
    phone: "13800138000",
    nickname: "系统管理员",
    // ...
}
```

**权限范围**：
- ✅ 访问所有租户数据
- ✅ 创建/删除/管理租户
- ✅ 查看所有用户
- ✅ 跨租户操作
- ✅ **Gateway 直接放行，无需 Casbin 检查**

### 2. **tenant_admin** - 租户级超管
```javascript
{
    _id: ObjectId("..."),
    tenant_id: "68dd0...",      // ✅ 必须有具体租户ID
    role: ["tenant_admin"],     // ✅ 数组格式
    phone: "13900139000",
    nickname: "租户A管理员",
    // ...
}
```

**权限范围**：
- ✅ 访问本租户所有资源
- ✅ 管理本租户用户
- ✅ 管理本租户角色
- ✅ 分配本租户权限
- ❌ **不能访问其他租户数据**
- ✅ **Gateway 直接放行，无需 Casbin 检查**

### 3. **user** - 普通用户
```javascript
{
    _id: ObjectId("..."),
    tenant_id: "68dd0...",      // ✅ 必须有租户ID
    role: ["user"],             // ✅ 数组格式
    phone: "13700137000",
    nickname: "普通用户",
    // ...
}
```

**权限范围**：
- ✅ 通过 Casbin 角色获取权限
- ✅ 细粒度权限控制（CRUD + 业务权限）
- ❌ **必须通过 Casbin 权限检查**

## 🔐 JWT Token 结构

```json
{
  "user_id": "68dcf02...",
  "username": "羊紫林",
  "tenant_id": "68dd0...",      // ✅ 新增：租户ID
  "roles": ["tenant_admin"],    // ✅ 角色数组
  "exp": 1759452196,
  "iat": 1759365796
}
```

## 🚪 Gateway 鉴权流程

```go
// 1. 提取用户信息
userID := c.Get("user_id")
tenantID := c.Get("tenant_id")
roles := c.Get("roles")

// 2. 检查系统级超管（无租户限制）
if role == "super" && tenantID == "" {
    // ✅ 直接放行
    return
}

// 3. 检查租户级超管（本租户所有权限）
if role == "tenant_admin" && tenantID != "" {
    // ✅ 直接放行
    return
}

// 4. 普通用户走 Casbin 检查
userSub := fmt.Sprintf("tenant:%s:user:%s", tenantID, userID)
allowed := casbin.CheckPermission(userSub, resource, action)
```

## 📊 数据隔离

### 租户数据隔离规则

| 操作 | 系统超管 | 租户超管 | 普通用户 |
|------|---------|---------|---------|
| 查看租户A数据 | ✅ 全部 | ✅ 仅A | ⚠️ 需Casbin |
| 查看租户B数据 | ✅ 全部 | ❌ 拒绝 | ❌ 拒绝 |
| 创建租户 | ✅ 允许 | ❌ 拒绝 | ❌ 拒绝 |
| 管理本租户用户 | ✅ 允许 | ✅ 允许 | ⚠️ 需Casbin |
| 跨租户操作 | ✅ 允许 | ❌ 拒绝 | ❌ 拒绝 |

## 🔄 数据迁移

运行迁移脚本：

```bash
# 迁移现有角色数据
mongo mule-cloud scripts/migrate_roles_system.js
```

迁移内容：
1. ✅ 将有 `tenant_id` 的 `super` 改为 `tenant_admin`
2. ✅ 规范化系统级 `super` 的 `tenant_id` 为空字符串
3. ✅ 将所有 `role` 字段统一为数组格式
4. ✅ 为无角色用户设置默认 `user` 角色

## 🎨 前端权限判断

```typescript
// 1. 检查角色权限
if (hasPermission('super') || hasPermission('tenant_admin')) {
  // 超管可以访问
}

// 2. 检查操作权限
if (hasAction('admin', 'create')) {
  // 有创建管理员权限
}

// 3. 检查资源权限
if (hasResource('admin:create')) {
  // 有创建管理员权限
}
```

## 🛡️ 安全性

### 租户隔离保证

1. **JWT Token 包含 tenant_id**：无法伪造其他租户身份
2. **Gateway 验证租户归属**：严格检查 tenant_id 匹配
3. **Casbin 策略包含租户前缀**：`tenant:A:user:123` vs `tenant:B:user:456`
4. **业务层二次校验**：关键操作再次验证 tenant_id

### 防止越权

```go
// ❌ 错误：未验证租户
db.admin.find({ _id: userID })

// ✅ 正确：始终带上租户过滤
db.admin.find({ _id: userID, tenant_id: tenantID })
```

## 📝 最佳实践

### 1. 创建租户时自动创建超管

```javascript
// 创建租户
const tenant = {
    name: "新租户",
    // ...
}

// 自动创建租户超管
const admin = {
    tenant_id: tenant._id,
    role: ["tenant_admin"],
    phone: "...",
    nickname: "租户管理员"
}
```

### 2. 租户超管不能提升为系统超管

```go
// 只有系统超管可以修改用户的 tenant_id
if userRole != "super" {
    // 普通用户和租户超管不能修改 tenant_id
    if newTenantID != currentUser.TenantID {
        return errors.New("无权修改租户归属")
    }
}
```

### 3. 所有数据库查询带租户过滤

```go
// 后端查询始终包含租户过滤
filter := bson.M{
    "tenant_id": currentUser.TenantID,
    // 其他条件...
}
```

## 🔧 故障排查

### 问题1：租户超管看不到数据
- ✅ 检查 `tenant_id` 是否正确
- ✅ 检查 `role` 是否为 `["tenant_admin"]`
- ✅ 检查 JWT Token 是否包含正确的 `tenant_id`

### 问题2：系统超管无法跨租户访问
- ✅ 检查 `tenant_id` 是否为空字符串 `""`
- ✅ 检查 `role` 是否为 `["super"]`
- ✅ 检查 Gateway 日志确认鉴权流程

### 问题3：普通用户权限异常
- ✅ 检查 Casbin 策略是否正确
- ✅ 检查角色菜单权限配置
- ✅ 检查 `tenant_id` 前缀是否一致

## 🎯 总结

| 特性 | 系统超管 | 租户超管 | 普通用户 |
|------|---------|---------|---------|
| tenant_id | "" | "xxx" | "xxx" |
| role | ["super"] | ["tenant_admin"] | ["user"] |
| 跨租户访问 | ✅ | ❌ | ❌ |
| 直接放行 | ✅ | ✅ | ❌ |
| Casbin检查 | ❌ | ❌ | ✅ |
| 数据隔离 | 全部 | 本租户 | Casbin |

