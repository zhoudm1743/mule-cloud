# 修复 - 系统管理员角色查询问题

## 🐛 问题现象

```
2025/10/05 21:45:45 [MongoDB] 执行命令: find, 命令内容: {"find": "role","filter": {"_id": "super",...},"$db": "mule_68dda6cd04ba0d6c8dda4b7a"}
警告: 角色 super 不存在
```

## 🔍 问题分析

### 问题根源

当系统管理员登录租户时：

1. **用户存储位置**：租户数据库 `mule_68dda6cd04ba0d6c8dda4b7a`
2. **用户角色**：`["super"]` (系统级别角色)
3. **登录流程**：调用 `getUserMenuPermissions` 获取菜单权限
4. **错误查询**：在**租户数据库**中查询 `super` 角色
5. **结果**：找不到，因为 `super` 角色存储在 `tenant_system` 系统库中 ❌

### 代码位置

**`app/auth/services/auth.go:503-509`**

```go
func (s *AuthService) getUserMenuPermissions(ctx context.Context, userID, tenantID string) (map[string][]string, error) {
    // ...
    for _, roleID := range admin.Roles {
        // ❌ 在租户数据库中查询系统角色
        role, err := s.roleRepo.Get(ctx, roleID)
        if role == nil {
            fmt.Printf("警告: 角色 %s 不存在\n", roleID)
            continue
        }
    }
}
```

**问题**：
- `ctx` 包含租户数据库信息
- `super` 角色在系统库 `tenant_system` 中
- 在租户库查询 → 找不到 ❌

---

## ✅ 解决方案

### 修复逻辑

系统超级管理员（`super` 角色）**直接返回所有权限**，不需要查询角色详情。

### 代码修改

**`app/auth/services/auth.go:498-505`**

```go
func (s *AuthService) getUserMenuPermissions(ctx context.Context, userID, tenantID string) (map[string][]string, error) {
    // 获取用户信息
    admin, err := s.repo.Get(ctx, userID)
    if err != nil || admin == nil {
        return nil, fmt.Errorf("获取用户信息失败: %w", err)
    }

    // 如果用户没有角色，返回空权限
    if len(admin.Roles) == 0 {
        return make(map[string][]string), nil
    }

    // ✅ 系统超级管理员直接返回所有权限
    for _, role := range admin.Roles {
        if role == "super" {
            // 系统管理员拥有所有权限，返回空 map 表示无限制
            // 前端会根据菜单列表自动判断权限
            return make(map[string][]string), nil
        }
    }

    // 普通租户用户：查询角色权限
    menuPermissions := make(map[string][]string)
    for _, roleID := range admin.Roles {
        role, err := s.roleRepo.Get(ctx, roleID)
        // ...
    }
}
```

### 逻辑说明

1. **检查角色列表**：如果包含 `super` 角色
2. **提前返回**：返回空权限 map（表示无限制）
3. **跳过查询**：不再尝试在租户数据库中查询 `super` 角色

---

## 🎯 验证

### 重启服务

```powershell
# 停止 auth 服务（Ctrl+C）
# 重新启动
go run cmd/auth/main.go
```

### 测试登录

**系统管理员登录租户**：
- 账号：`13800138000`
- 密码：`123456`
- 租户：`default`

**期望结果**：
```
✅ 登录成功
✅ 不再出现"警告: 角色 super 不存在"
✅ 正常返回菜单权限
```

---

## 📝 扩展说明

### 为什么系统管理员在租户数据库？

正常情况下，系统管理员应该：
- 存储在 `tenant_system` 系统库
- 没有 `tenant_id`
- 角色为 `super`

但如果用户在租户库且角色是 `super`，可能是：
1. 测试数据配置问题
2. 手动创建的特殊账号
3. 迁移/导入数据时的遗留问题

**建议**：
- 系统管理员统一存储在系统库
- 租户数据库只存储租户用户（角色为 `tenant_admin` 等）

---

## 🎉 修复完成

- ✅ 修复了系统管理员角色查询失败的问题
- ✅ 避免在租户库中查询系统级别角色
- ✅ 系统管理员仍然拥有所有权限
- ✅ 不影响普通租户用户的权限查询

**现在请重启 auth 服务，然后测试租户用户登录，查看调试日志！**
