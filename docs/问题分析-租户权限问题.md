# 问题分析 - 租户权限问题

## 🐛 用户报告的问题

**现象**：
- 没有给租户分配"基础信息"菜单权限
- 但租户用户登录后，能看到"基础信息"及其所有子菜单

**截图显示**：
- 图1：租户权限配置 - 只勾选了 Dashboard 和系统管理
- 图2：登录后菜单 - 显示了 Dashboard、基础信息、系统管理

---

## 🔍 问题根源

### 1. 创建租户时的默认权限

**`app/system/services/tenant.go:167-174`**

```go
// 默认分配所有菜单
defaultMenus := []string{
    "dashboard",
    "system",
    "system_admin",
    "system_role",
    "system_menu",
    "system_tenant",
}
```

**问题**：
- ✅ 只包含了 dashboard 和 system 相关菜单
- ❌ **不包含** basic 相关菜单

**所以租户默认角色应该没有 basic 权限** ✅

---

### 2. 获取用户路由的逻辑

**`app/auth/services/auth.go:364-385`**

```go
// 获取用户所有角色的菜单权限（合并去重）
menuMap := make(map[string]dto.RouteItem)
for _, roleID := range admin.Roles {
    menus, err := s.fetchRoleMenusFromSystem(roleID)  // ← 问题在这
    if err != nil {
        // 忽略单个角色的错误，继续处理其他角色
        continue  // ❌ 错误被忽略了
    }
    for _, menu := range menus {
        menuMap[menu.ID] = menu
    }
}
```

---

### 3. 获取角色菜单的逻辑

**`app/auth/services/auth.go:432-477`**

```go
func (s *AuthService) fetchRoleMenusFromSystem(roleID string) ([]dto.RouteItem, error) {
    // 使用 httpclient 调用 system 服务
    path := fmt.Sprintf("/system/roles/%s/menus", roleID)
    if s.httpClient != nil {
        err := s.httpClient.CallService(ctx, "GET", "systemservice", path, nil, &result, nil)
        if err != nil {
            return nil, fmt.Errorf("调用 system 服务失败: %w", err)  // ❌ HTTP 调用失败
        }
    } else {
        return nil, fmt.Errorf("Consul 不可用，无法获取角色菜单权限")
    }
    
    // ...
}
```

---

## 🎯 问题分析

### 场景1：HTTP 调用失败

如果 `fetchRoleMenusFromSystem` 失败：
1. 返回错误
2. `getUserRoutes` 中的 `continue` 跳过该角色
3. 如果所有角色都失败 → `menuMap` 为空
4. **返回空菜单** ❌

**但用户看到了菜单**，所以不是这个问题。

---

### 场景2：HTTP 调用成功但返回了错误数据

可能的问题：
1. **system 服务需要认证**，但 HTTP 调用没有传 token
2. **返回 401 错误**
3. 但 `result.Code` 可能不是 0
4. 继续执行，获取所有菜单
5. **按照 menuName 过滤** - 但如果 `result.Data` 为空，则返回空数组

---

### 场景3：前端缓存或默认菜单

也可能是：
1. 前端有菜单缓存
2. 或者前端路由配置中有默认菜单
3. 不依赖后端返回的菜单

---

## ✅ 解决方案

### 1. 让 fetchRoleMenusFromSystem 也使用 repository

和修复 `fetchAllMenusFromSystem` 一样，改用直接查询数据库：

```go
func (s *AuthService) fetchRoleMenusFromSystem(roleID string) ([]dto.RouteItem, error) {
    // ✅ 直接使用 repository 查询数据库
    ctx := context.Background() // 角色在租户库
    
    // 需要知道租户ID才能查询正确的数据库
    // 这里有个问题：context 中没有 tenantID！
    
    role, err := s.roleRepo.Get(ctx, roleID)
    if err != nil {
        return nil, fmt.Errorf("查询角色失败: %w", err)
    }
    
    // 获取角色的菜单列表
    menuNames := role.Menus // []string
    
    // 获取所有菜单
    allMenus, err := s.fetchAllMenusFromSystem()
    if err != nil {
        return nil, err
    }
    
    // 过滤出角色拥有的菜单
    menuMap := make(map[string]dto.RouteItem)
    for _, menu := range allMenus {
        menuMap[menu.Name] = menu
    }
    
    routes := make([]dto.RouteItem, 0)
    for _, menuName := range menuNames {
        if menu, ok := menuMap[menuName]; ok {
            routes = append(routes, menu)
        }
    }
    
    return routes, nil
}
```

### 2. 问题：如何获取正确的 tenantID？

当前问题：
- `getUserRoutes(ctx, userID)` 被调用时
- `ctx` 中应该包含 `tenantID`（从 JWT 中来）
- 但 `fetchRoleMenusFromSystem` 创建了新的 `context.Background()`
- **丢失了 tenantID**！

**修复**：
```go
// 应该传递原始的 ctx
func (s *AuthService) fetchRoleMenusFromSystem(ctx context.Context, roleID string) ([]dto.RouteItem, error) {
    // 使用传入的 ctx，保留 tenantID
    role, err := s.roleRepo.Get(ctx, roleID)
    // ...
}
```

---

## 🚀 实施步骤

1. ✅ 修改 `fetchRoleMenusFromSystem` 签名，添加 `ctx context.Context` 参数
2. ✅ 改用 `s.roleRepo.Get(ctx, roleID)` 直接查询角色
3. ✅ 更新 `getUserRoutes` 中的调用，传递 `ctx`
4. ✅ 测试：租户用户应该只能看到角色分配的菜单

---

## 📝 预期结果

**修复后**：
1. 租户管理员默认只能看到：
   - Dashboard ✅
   - 系统管理 ✅
     - 管理员管理
     - 角色管理
     - 菜单管理
     - 租户管理

2. **不应该看到**：
   - 基础信息 ❌
   - 颜色管理 ❌
   - 尺码管理 ❌
   - 等等...

3. 如果需要基础信息权限：
   - 超管给租户分配菜单权限
   - 或者租户管理员编辑角色，添加 basic 相关菜单

---

让我立即修复这个问题！
