# é—®é¢˜åˆ†æ - ç§Ÿæˆ·æƒé™é—®é¢˜

## ğŸ› ç”¨æˆ·æŠ¥å‘Šçš„é—®é¢˜

**ç°è±¡**ï¼š
- æ²¡æœ‰ç»™ç§Ÿæˆ·åˆ†é…"åŸºç¡€ä¿¡æ¯"èœå•æƒé™
- ä½†ç§Ÿæˆ·ç”¨æˆ·ç™»å½•åï¼Œèƒ½çœ‹åˆ°"åŸºç¡€ä¿¡æ¯"åŠå…¶æ‰€æœ‰å­èœå•

**æˆªå›¾æ˜¾ç¤º**ï¼š
- å›¾1ï¼šç§Ÿæˆ·æƒé™é…ç½® - åªå‹¾é€‰äº† Dashboard å’Œç³»ç»Ÿç®¡ç†
- å›¾2ï¼šç™»å½•åèœå• - æ˜¾ç¤ºäº† Dashboardã€åŸºç¡€ä¿¡æ¯ã€ç³»ç»Ÿç®¡ç†

---

## ğŸ” é—®é¢˜æ ¹æº

### 1. åˆ›å»ºç§Ÿæˆ·æ—¶çš„é»˜è®¤æƒé™

**`app/system/services/tenant.go:167-174`**

```go
// é»˜è®¤åˆ†é…æ‰€æœ‰èœå•
defaultMenus := []string{
    "dashboard",
    "system",
    "system_admin",
    "system_role",
    "system_menu",
    "system_tenant",
}
```

**é—®é¢˜**ï¼š
- âœ… åªåŒ…å«äº† dashboard å’Œ system ç›¸å…³èœå•
- âŒ **ä¸åŒ…å«** basic ç›¸å…³èœå•

**æ‰€ä»¥ç§Ÿæˆ·é»˜è®¤è§’è‰²åº”è¯¥æ²¡æœ‰ basic æƒé™** âœ…

---

### 2. è·å–ç”¨æˆ·è·¯ç”±çš„é€»è¾‘

**`app/auth/services/auth.go:364-385`**

```go
// è·å–ç”¨æˆ·æ‰€æœ‰è§’è‰²çš„èœå•æƒé™ï¼ˆåˆå¹¶å»é‡ï¼‰
menuMap := make(map[string]dto.RouteItem)
for _, roleID := range admin.Roles {
    menus, err := s.fetchRoleMenusFromSystem(roleID)  // â† é—®é¢˜åœ¨è¿™
    if err != nil {
        // å¿½ç•¥å•ä¸ªè§’è‰²çš„é”™è¯¯ï¼Œç»§ç»­å¤„ç†å…¶ä»–è§’è‰²
        continue  // âŒ é”™è¯¯è¢«å¿½ç•¥äº†
    }
    for _, menu := range menus {
        menuMap[menu.ID] = menu
    }
}
```

---

### 3. è·å–è§’è‰²èœå•çš„é€»è¾‘

**`app/auth/services/auth.go:432-477`**

```go
func (s *AuthService) fetchRoleMenusFromSystem(roleID string) ([]dto.RouteItem, error) {
    // ä½¿ç”¨ httpclient è°ƒç”¨ system æœåŠ¡
    path := fmt.Sprintf("/system/roles/%s/menus", roleID)
    if s.httpClient != nil {
        err := s.httpClient.CallService(ctx, "GET", "systemservice", path, nil, &result, nil)
        if err != nil {
            return nil, fmt.Errorf("è°ƒç”¨ system æœåŠ¡å¤±è´¥: %w", err)  // âŒ HTTP è°ƒç”¨å¤±è´¥
        }
    } else {
        return nil, fmt.Errorf("Consul ä¸å¯ç”¨ï¼Œæ— æ³•è·å–è§’è‰²èœå•æƒé™")
    }
    
    // ...
}
```

---

## ğŸ¯ é—®é¢˜åˆ†æ

### åœºæ™¯1ï¼šHTTP è°ƒç”¨å¤±è´¥

å¦‚æœ `fetchRoleMenusFromSystem` å¤±è´¥ï¼š
1. è¿”å›é”™è¯¯
2. `getUserRoutes` ä¸­çš„ `continue` è·³è¿‡è¯¥è§’è‰²
3. å¦‚æœæ‰€æœ‰è§’è‰²éƒ½å¤±è´¥ â†’ `menuMap` ä¸ºç©º
4. **è¿”å›ç©ºèœå•** âŒ

**ä½†ç”¨æˆ·çœ‹åˆ°äº†èœå•**ï¼Œæ‰€ä»¥ä¸æ˜¯è¿™ä¸ªé—®é¢˜ã€‚

---

### åœºæ™¯2ï¼šHTTP è°ƒç”¨æˆåŠŸä½†è¿”å›äº†é”™è¯¯æ•°æ®

å¯èƒ½çš„é—®é¢˜ï¼š
1. **system æœåŠ¡éœ€è¦è®¤è¯**ï¼Œä½† HTTP è°ƒç”¨æ²¡æœ‰ä¼  token
2. **è¿”å› 401 é”™è¯¯**
3. ä½† `result.Code` å¯èƒ½ä¸æ˜¯ 0
4. ç»§ç»­æ‰§è¡Œï¼Œè·å–æ‰€æœ‰èœå•
5. **æŒ‰ç…§ menuName è¿‡æ»¤** - ä½†å¦‚æœ `result.Data` ä¸ºç©ºï¼Œåˆ™è¿”å›ç©ºæ•°ç»„

---

### åœºæ™¯3ï¼šå‰ç«¯ç¼“å­˜æˆ–é»˜è®¤èœå•

ä¹Ÿå¯èƒ½æ˜¯ï¼š
1. å‰ç«¯æœ‰èœå•ç¼“å­˜
2. æˆ–è€…å‰ç«¯è·¯ç”±é…ç½®ä¸­æœ‰é»˜è®¤èœå•
3. ä¸ä¾èµ–åç«¯è¿”å›çš„èœå•

---

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. è®© fetchRoleMenusFromSystem ä¹Ÿä½¿ç”¨ repository

å’Œä¿®å¤ `fetchAllMenusFromSystem` ä¸€æ ·ï¼Œæ”¹ç”¨ç›´æ¥æŸ¥è¯¢æ•°æ®åº“ï¼š

```go
func (s *AuthService) fetchRoleMenusFromSystem(roleID string) ([]dto.RouteItem, error) {
    // âœ… ç›´æ¥ä½¿ç”¨ repository æŸ¥è¯¢æ•°æ®åº“
    ctx := context.Background() // è§’è‰²åœ¨ç§Ÿæˆ·åº“
    
    // éœ€è¦çŸ¥é“ç§Ÿæˆ·IDæ‰èƒ½æŸ¥è¯¢æ­£ç¡®çš„æ•°æ®åº“
    // è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼šcontext ä¸­æ²¡æœ‰ tenantIDï¼
    
    role, err := s.roleRepo.Get(ctx, roleID)
    if err != nil {
        return nil, fmt.Errorf("æŸ¥è¯¢è§’è‰²å¤±è´¥: %w", err)
    }
    
    // è·å–è§’è‰²çš„èœå•åˆ—è¡¨
    menuNames := role.Menus // []string
    
    // è·å–æ‰€æœ‰èœå•
    allMenus, err := s.fetchAllMenusFromSystem()
    if err != nil {
        return nil, err
    }
    
    // è¿‡æ»¤å‡ºè§’è‰²æ‹¥æœ‰çš„èœå•
    menuMap := make(map[string]dto.RouteItem)
    for _, menu := range allMenus {
        menuMap[menu.Name] = menu
    }
    
    routes := make([]dto.RouteItem, 0)
    for _, menuName := range menuNames {
        if menu, ok := menuMap[menuName]; ok {
            routes = append(routes, menu)
        }
    }
    
    return routes, nil
}
```

### 2. é—®é¢˜ï¼šå¦‚ä½•è·å–æ­£ç¡®çš„ tenantIDï¼Ÿ

å½“å‰é—®é¢˜ï¼š
- `getUserRoutes(ctx, userID)` è¢«è°ƒç”¨æ—¶
- `ctx` ä¸­åº”è¯¥åŒ…å« `tenantID`ï¼ˆä» JWT ä¸­æ¥ï¼‰
- ä½† `fetchRoleMenusFromSystem` åˆ›å»ºäº†æ–°çš„ `context.Background()`
- **ä¸¢å¤±äº† tenantID**ï¼

**ä¿®å¤**ï¼š
```go
// åº”è¯¥ä¼ é€’åŸå§‹çš„ ctx
func (s *AuthService) fetchRoleMenusFromSystem(ctx context.Context, roleID string) ([]dto.RouteItem, error) {
    // ä½¿ç”¨ä¼ å…¥çš„ ctxï¼Œä¿ç•™ tenantID
    role, err := s.roleRepo.Get(ctx, roleID)
    // ...
}
```

---

## ğŸš€ å®æ–½æ­¥éª¤

1. âœ… ä¿®æ”¹ `fetchRoleMenusFromSystem` ç­¾åï¼Œæ·»åŠ  `ctx context.Context` å‚æ•°
2. âœ… æ”¹ç”¨ `s.roleRepo.Get(ctx, roleID)` ç›´æ¥æŸ¥è¯¢è§’è‰²
3. âœ… æ›´æ–° `getUserRoutes` ä¸­çš„è°ƒç”¨ï¼Œä¼ é€’ `ctx`
4. âœ… æµ‹è¯•ï¼šç§Ÿæˆ·ç”¨æˆ·åº”è¯¥åªèƒ½çœ‹åˆ°è§’è‰²åˆ†é…çš„èœå•

---

## ğŸ“ é¢„æœŸç»“æœ

**ä¿®å¤å**ï¼š
1. ç§Ÿæˆ·ç®¡ç†å‘˜é»˜è®¤åªèƒ½çœ‹åˆ°ï¼š
   - Dashboard âœ…
   - ç³»ç»Ÿç®¡ç† âœ…
     - ç®¡ç†å‘˜ç®¡ç†
     - è§’è‰²ç®¡ç†
     - èœå•ç®¡ç†
     - ç§Ÿæˆ·ç®¡ç†

2. **ä¸åº”è¯¥çœ‹åˆ°**ï¼š
   - åŸºç¡€ä¿¡æ¯ âŒ
   - é¢œè‰²ç®¡ç† âŒ
   - å°ºç ç®¡ç† âŒ
   - ç­‰ç­‰...

3. å¦‚æœéœ€è¦åŸºç¡€ä¿¡æ¯æƒé™ï¼š
   - è¶…ç®¡ç»™ç§Ÿæˆ·åˆ†é…èœå•æƒé™
   - æˆ–è€…ç§Ÿæˆ·ç®¡ç†å‘˜ç¼–è¾‘è§’è‰²ï¼Œæ·»åŠ  basic ç›¸å…³èœå•

---

è®©æˆ‘ç«‹å³ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼
