# 修复 - 角色菜单数据不一致

## 🐛 问题现象

编辑角色时，菜单勾选状态不一致：
- 第一次打开编辑："菜单管理"和"租户管理"显示为灰色（未勾选）
- 点击"确定"后，再次打开编辑：这两个菜单显示为绿色（勾选）

## 🔍 问题原因

### 数据不一致

**后端数据**（数据库中的角色）：
```json
{
  "code": "tenant_admin",
  "menus": [
    "dashboard",
    "system",
    "system_admin",
    "system_role",
    "system_menu",      // ← 旧数据，不应该有
    "system_tenant"     // ← 旧数据，不应该有
  ]
}
```

**前端显示**：
- 租户的可用菜单列表（`tenantMenus`）：`["dashboard", "system", "system_admin", "system_role"]`
- 树形组件过滤：只显示租户拥有的菜单
- 结果：`system_menu` 和 `system_tenant` 在树中显示为**灰色**（不可选）

### 为什么保存后又变勾选？

**前端逻辑**（`TableModal.vue:328-366`）：

1. 用户点击"确定"
2. 前端读取 `formModel.menus`（包含旧数据）
3. 如果用户**没有主动取消勾选**，`formModel.menus` 保持不变
4. 自动添加父级菜单逻辑运行
5. 提交的数据仍然包含 `system_menu` 和 `system_tenant`
6. 保存成功，但数据没有变化
7. 再次打开编辑，这两个菜单仍然存在，显示为勾选状态

---

## ✅ 解决方案

### 方式1: 通过前端手动修复（最简单）

#### 步骤

1. **系统管理员登录**
2. **切换到租户**（顶部租户选择器）
3. **进入"角色管理"**
4. **编辑"租户管理员"角色**
5. **点击"分配权限菜单"**
6. **找到已勾选的菜单列表**
7. **手动取消勾选**：
   - ❌ 菜单管理
   - ❌ 租户管理
8. **点击"确定"保存**
9. **验证**：再次打开编辑，这两个菜单应该不再出现

#### 期望结果

**租户管理员角色的菜单**：
```
✅ Dashboard
✅ 权限管理（父菜单）
   ✅ 管理员管理
   ✅ 角色管理
   ❌ 菜单管理（移除）
   ❌ 租户管理（移除）
```

---

### 方式2: 前端代码优化（可选）

如果你想让前端自动过滤掉不可用的菜单，可以修改保存逻辑：

**修改文件**：`frontend/src/views/auth/role/components/TableModal.vue`

**在第 328 行之后添加**：

```typescript
else if (modalType.value === 'assignMenus') {
  if (!formModel.id) {
    window.$message.error('缺少角色ID')
    return
  }
  
  // ✅ 过滤掉租户不拥有的菜单
  const availableMenus = isSystemAdmin.value 
    ? allMenus.value.map(m => m.name)
    : tenantMenus.value
  
  // 只保留租户拥有的菜单
  formModel.menus = (formModel.menus || []).filter(menuName => 
    availableMenus.includes(menuName)
  )
  
  // 自动添加父级菜单（仅在租户拥有的菜单范围内）
  const menusWithParents = new Set<string>(formModel.menus || [])
  // ...
}
```

**效果**：保存时自动过滤掉租户不拥有的菜单，避免数据不一致。

---

### 方式3: 批量修复所有租户（数据库脚本）

如果 MongoDB 可以连接，运行修复脚本：

```powershell
py scripts/fix_tenant_permissions.py
```

**脚本功能**：
1. 查找所有租户的 `tenant_admin` 角色
2. 移除 `system_menu` 和 `system_tenant`
3. 更新数据库

---

## 🎯 验证

修复后，再次编辑角色：

**应该看到**：
- ✅ 菜单列表保持一致
- ✅ 没有"菜单管理"和"租户管理"
- ✅ 多次编辑，勾选状态一致

**不应该看到**：
- ❌ 第一次灰色，第二次绿色
- ❌ 保存后状态变化

---

## 📝 总结

**根本原因**：创建租户时的默认角色包含了不应该有的菜单（历史遗留数据）

**临时解决**：手动取消勾选并保存

**长期方案**：
1. ✅ 已修复创建租户的默认菜单配置
2. ⏳ 现有租户需要手动修复或运行脚本
3. ⏳ 可选：前端添加自动过滤逻辑

**已修复的代码**：
- `app/system/services/tenant.go:167-181` - 新租户不再有这个问题

**现在请手动保存一次，就能解决问题！** 🎉
