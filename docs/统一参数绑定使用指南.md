# 统一参数绑定使用指南

## 背景

在使用 Gin 框架开发 API 时，经常需要同时绑定 URI 参数（如 `:id`）和 Body 参数（JSON）。之前的做法是先调用 `ShouldBindUri`，再调用 `ShouldBindJSON`，但这会导致参数验证失败，因为两次独立的绑定调用无法正确合并数据。

为了解决这个问题，我们在 `core/binding` 包中提供了统一的参数绑定方法。

---

## 核心方法

### 1. `binding.BindAll(c *gin.Context, req interface{}) error`

统一绑定 URI、Query 和 Body 参数的万能方法。

**执行顺序：**
1. 先绑定 URI 参数（如 `:id`）
2. 再绑定其他参数（Query/Body），根据 Content-Type 自动选择

**优点：**
- 自动处理参数合并，避免覆盖问题
- 支持所有常见的参数来源（URI、Query、JSON、Form 等）
- 代码更简洁，只需一行

---

## 使用示例

### ❌ 旧的写法（有问题）

```go
func UpdateOrderHandler(svc services.IOrderService) gin.HandlerFunc {
    return func(c *gin.Context) {
        var req dto.OrderUpdateRequest
        
        // 先绑定 URI 参数
        if err := c.ShouldBindUri(&req); err != nil {
            response.Error(c, "参数错误: "+err.Error())
            return
        }
        
        // 再绑定 JSON body（会导致验证失败）
        if err := c.ShouldBindJSON(&req); err != nil {
            response.Error(c, "参数错误: "+err.Error())
            return
        }
        
        // ... 业务逻辑
    }
}
```

**问题：** 第二次调用 `ShouldBindJSON` 会重新验证整个结构体，但只从 JSON body 中读取数据，导致 URI 参数验证失败。

---

### ✅ 新的写法（推荐）

```go
import (
    "mule-cloud/core/binding"
    "mule-cloud/core/response"
)

func UpdateOrderHandler(svc services.IOrderService) gin.HandlerFunc {
    return func(c *gin.Context) {
        var req dto.OrderUpdateRequest
        
        // 使用统一的绑定方法，一行搞定
        if err := binding.BindAll(c, &req); err != nil {
            response.Error(c, "参数错误: "+err.Error())
            return
        }
        
        // ... 业务逻辑
    }
}
```

---

## 适用场景

### 场景 1：URI + JSON Body

```go
// DTO 定义
type OrderUpdateRequest struct {
    ID       string `uri:"id" binding"required"`      // URI 参数
    Name     string `json:"name" binding"required"`   // JSON 参数
    Quantity int    `json:"quantity"`
}

// Handler
func UpdateOrderHandler(svc services.IOrderService) gin.HandlerFunc {
    return func(c *gin.Context) {
        var req dto.OrderUpdateRequest
        if err := binding.BindAll(c, &req); err != nil {
            response.Error(c, "参数错误: "+err.Error())
            return
        }
        // ... 处理逻辑
    }
}

// 路由
r.PUT("/orders/:id", UpdateOrderHandler(orderSvc))
```

### 场景 2：URI + Query + JSON

```go
type SearchRequest struct {
    ID       string   `uri:"id" binding"required"`        // URI 参数
    Keyword  string   `form:"keyword"`                    // Query 参数
    Page     int      `form:"page"`
    Filters  []string `json:"filters"`                     // JSON 参数
}

func SearchHandler(c *gin.Context) {
    var req SearchRequest
    if err := binding.BindAll(c, &req); err != nil {
        response.Error(c, "参数错误: "+err.Error())
        return
    }
    // ... 处理逻辑
}
```

### 场景 3：仅 JSON（创建操作）

```go
type CreateOrderRequest struct {
    Name     string `json:"name" binding"required"`
    Quantity int    `json:"quantity" binding"required"`
}

func CreateOrderHandler(c *gin.Context) {
    var req CreateOrderRequest
    // 没有 URI 参数时，也可以使用 BindAll
    if err := binding.BindAll(c, &req); err != nil {
        response.Error(c, "参数错误: "+err.Error())
        return
    }
    // ... 处理逻辑
}
```

---

## 其他可用方法

如果需要更精细的控制，也可以使用以下方法：

```go
// 仅绑定 JSON Body
binding.BindJSON(c, &req)

// 仅绑定 URI 参数
binding.BindUri(c, &req)

// 仅绑定 Query 参数
binding.BindQuery(c, &req)

// BindAll 的语义化别名
binding.BindUriAndJSON(c, &req)
```

---

## 迁移指南

### 1. 导入新包

在 transport 文件中添加导入：

```go
import (
    "mule-cloud/core/binding"
    // ... 其他导入
)
```

### 2. 替换绑定代码

将以下模式：

```go
if err := c.ShouldBindUri(&req); err != nil {
    // ...
}
if err := c.ShouldBindJSON(&req); err != nil {
    // ...
}
```

替换为：

```go
if err := binding.BindAll(c, &req); err != nil {
    // ...
}
```

### 3. 需要迁移的文件

以下模块的 transport 层文件可能需要更新：

- ✅ `app/order/transport/order.go` - 已更新
- ✅ `app/order/transport/style.go` - 已更新
- ⏳ `app/basic/transport/*.go` - 待更新
- ⏳ `app/perms/transport/*.go` - 待更新

---

## 优势总结

1. **代码更简洁** - 从 8 行代码减少到 4 行
2. **避免 Bug** - 自动处理参数合并，避免验证失败
3. **统一规范** - 所有服务使用相同的绑定方式
4. **易于维护** - 集中管理绑定逻辑，便于未来优化

---

## 注意事项

1. **参数标签必须正确**
   - URI 参数使用 `uri` 标签：`` uri:"id" ``
   - JSON 参数使用 `json` 标签：`` json:"name" ``
   - Query 参数使用 `query` 标签：`` form:"page" ``

2. **验证规则**
   - 使用 `binding` 标签定义验证规则：`` binding"required" ``
   - 支持 Gin 的所有验证器

3. **性能**
   - `BindAll` 会依次调用 `ShouldBindUri` 和 `ShouldBind`
   - 对性能的影响可以忽略不计（微秒级别）

---

## 完整示例

```go
package transport

import (
    "mule-cloud/app/order/dto"
    "mule-cloud/app/order/endpoint"
    "mule-cloud/app/order/services"
    "mule-cloud/core/binding"
    "mule-cloud/core/response"

    "github.com/gin-gonic/gin"
)

// UpdateOrderStyleHandler 更新订单款式处理器
func UpdateOrderStyleHandler(svc services.IOrderService) gin.HandlerFunc {
    return func(c *gin.Context) {
        var req dto.OrderStyleRequest
        
        // 使用统一的绑定方法
        if err := binding.BindAll(c, &req); err != nil {
            response.Error(c, "参数错误: "+err.Error())
            return
        }

        ep := endpoint.UpdateOrderStyleEndpoint(svc)
        resp, err := ep(c.Request.Context(), req)
        if err != nil {
            response.Error(c, err.Error())
            return
        }

        response.Success(c, resp)
    }
}
```

---

## 相关文档

- [Gin 参数绑定文档](https://gin-gonic.com/docs/examples/binding-and-validation/)
- [Go validator 文档](https://pkg.go.dev/github.com/go-playground/validator/v10)

