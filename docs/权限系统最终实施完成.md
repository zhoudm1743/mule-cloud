# æƒé™ç³»ç»Ÿæœ€ç»ˆå®æ–½å®Œæˆ ğŸ‰

## âœ… å…¨éƒ¨å®Œæˆ

æ‰€æœ‰å¾…åŠäº‹é¡¹å·²å®Œæˆï¼Œç»†ç²’åº¦æƒé™ç³»ç»Ÿå·²å®Œæ•´å®æ–½å¹¶å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚

---

## ğŸ“‹ å®Œæˆæ¸…å•

### é˜¶æ®µ1: åŸºç¡€æ¶æ„ï¼ˆå·²å®Œæˆï¼‰

- [x] Menu æ¨¡å‹æ·»åŠ  `AvailablePermissions` å­—æ®µ
- [x] Role æ¨¡å‹æ·»åŠ  `MenuPermissions` å­—æ®µ
- [x] Permission ç»“æ„ä½“å®šä¹‰
- [x] Gateway ä¸­é—´ä»¶æ”¯æŒ create/read/update/delete å››æƒé™
- [x] Casbin å·¥å…·å‡½æ•°æ”¯æŒç»†ç²’åº¦æƒé™
- [x] å‰ç«¯ç±»å‹å®šä¹‰æ›´æ–°

### é˜¶æ®µ2: åç«¯å®æ–½ï¼ˆå·²å®Œæˆï¼‰

- [x] âœ… **åœ¨ AssignMenus æœåŠ¡ä¸­å¯ç”¨ Casbin åŒæ­¥**
  - æŸ¥è¯¢èœå•è·¯å¾„å¹¶æ„å»ºæ˜ å°„
  - è°ƒç”¨ `casbin.SyncRoleMenusWithPermissions()`
  - é”™è¯¯å¤„ç†ä¸ä¸­æ–­æµç¨‹

- [x] âœ… **å®ç° getMenuPathFromName() ä»æ•°æ®åº“æŸ¥è¯¢**
  - Service å±‚æŸ¥è¯¢èœå•å¹¶æ„å»ºè·¯å¾„æ˜ å°„
  - Casbin å±‚æ¥æ”¶è·¯å¾„æ˜ å°„å‚æ•°
  - é™çº§æ–¹æ¡ˆä¿è¯å¯ç”¨æ€§

- [x] âœ… **æ£€æŸ¥ç§Ÿæˆ·æƒé™åˆ†é…é€»è¾‘**
  - `HasAllMenus()` æ­£ç¡®å®ç°
  - ç§Ÿæˆ·è¶…ç®¡åªèƒ½ä»è‡ªå·±æ‹¥æœ‰çš„èœå•ä¸­åˆ†é…
  - æƒé™è¾¹ç•Œæ£€æŸ¥å®Œæ•´

- [x] âœ… **åç«¯è¿”å›ç”¨æˆ· menu_permissions**
  - LoginResponse æ·»åŠ  `menu_permissions` å­—æ®µ
  - GetProfileResponse æ·»åŠ  `menu_permissions` å­—æ®µ
  - `getUserMenuPermissions()` æ–¹æ³•åˆå¹¶æ‰€æœ‰è§’è‰²æƒé™
  - Login å’Œ GetProfile æ–¹æ³•è°ƒç”¨å¹¶è¿”å›æƒé™æ•°æ®

### é˜¶æ®µ3: å‰ç«¯å®æ–½ï¼ˆå·²å®Œæˆï¼‰

- [x] âœ… **æ‰©å±• usePermission hook**
  - `hasPermission()` - è§’è‰²æƒé™æ£€æŸ¥ï¼ˆä¿ç•™ï¼‰
  - `hasAction(menuName, action)` - æ“ä½œæƒé™æ£€æŸ¥ï¼ˆæ–°å¢ï¼‰
  - `hasResource(resource)` - èµ„æºæƒé™æ£€æŸ¥ï¼ˆæ–°å¢ï¼‰

- [x] âœ… **å‰ç«¯ç±»å‹å®šä¹‰æ›´æ–°**
  - `Api.Login.Info` æ·»åŠ  `menu_permissions`
  - `Api.Login.Profile` æ·»åŠ  `menu_permissions`
  - `Api.Role.RoleInfo` æ·»åŠ  `menu_permissions`
  - `Api.Menu.Permission` æ¥å£å®šä¹‰

- [x] âœ… **å®Œå–„ hasAction çš„å®é™…æ£€æŸ¥é€»è¾‘**
  - è¯»å– `authStore.userInfo.menu_permissions`
  - super è§’è‰²æ‹¥æœ‰æ‰€æœ‰æƒé™
  - é™çº§æ–¹æ¡ˆï¼šæ— æ•°æ®æ—¶å‡è®¾æœ‰èœå•å°±æœ‰æƒé™

- [x] âœ… **åœ¨ä¸šåŠ¡é¡µé¢åº”ç”¨æŒ‰é’®çº§æƒé™æ§åˆ¶**
  - Admin ç®¡ç†é¡µé¢å®Œæ•´å®æ–½
  - æ–°å»ºæŒ‰é’®ï¼š`hasResource('admin:create')`
  - æŸ¥çœ‹æŒ‰é’®ï¼š`hasAction('admin', 'read')`
  - ç¼–è¾‘æŒ‰é’®ï¼š`hasAction('admin', 'update')`
  - åˆ é™¤æŒ‰é’®ï¼š`hasAction('admin', 'delete')`
  - æ‰¹é‡åˆ é™¤ï¼š`hasResource('admin:delete')`

- [x] âœ… **è§’è‰²ç®¡ç†ç•Œé¢æ”¯æŒæƒé™é…ç½®**
  - èœå•æ ‘é€‰æ‹©
  - æƒé™ç»†ç²’åº¦é…ç½®ï¼ˆåŸºç¡€æƒé™/ä¸šåŠ¡æƒé™ï¼‰
  - è‡ªåŠ¨åˆå§‹åŒ–å’Œç›‘å¬å˜åŒ–

---

## ğŸ¯ å®æ–½äº®ç‚¹

### 1. å®Œæ•´çš„æƒé™æµè½¬

```
ç”¨æˆ·ç™»å½•
  â†“
åç«¯æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰è§’è‰²
  â†“
åˆå¹¶æ‰€æœ‰è§’è‰²çš„ menu_permissions
  â†“
è¿”å›ç»™å‰ç«¯å­˜å‚¨
  â†“
å‰ç«¯ hasAction æ£€æŸ¥
  â†“
æŒ‰é’®æ˜¾ç¤º/éšè—
  â†“
ç”¨æˆ·æ“ä½œ
  â†“
Gateway æ£€æŸ¥åŸºç¡€æƒé™ï¼ˆHTTP æ–¹æ³•ï¼‰
  â†“
ä¸šåŠ¡ä»£ç æ£€æŸ¥è‡ªå®šä¹‰æƒé™
  â†“
æ‰§è¡Œ/æ‹’ç»
```

### 2. å››å±‚æƒé™æ§åˆ¶

**ç¬¬ä¸€å±‚ï¼šèœå•æ˜¾ç¤º**
- åŸºäº `Role.menus`
- ç”¨æˆ·æ²¡æœ‰èœå• â†’ èœå•ä¸æ˜¾ç¤º
- è·¯ç”± guard è‡ªåŠ¨å¤„ç†

**ç¬¬äºŒå±‚ï¼šHTTP æ–¹æ³•æƒé™**
- Gateway Casbin ä¸­é—´ä»¶è‡ªåŠ¨æ£€æŸ¥
- `GET` â†’ `read`
- `POST` â†’ `create`
- `PUT/PATCH` â†’ `update`
- `DELETE` â†’ `delete`

**ç¬¬ä¸‰å±‚ï¼šæŒ‰é’®æ˜¾ç¤º**
- å‰ç«¯ `hasAction` / `hasResource` æ§åˆ¶
- æ— æƒé™æŒ‰é’®è‡ªåŠ¨éšè—
- æå‡ç”¨æˆ·ä½“éªŒ

**ç¬¬å››å±‚ï¼šä¸šåŠ¡æ“ä½œæƒé™**
- ä¸šåŠ¡ä»£ç æ‰‹åŠ¨æ£€æŸ¥ï¼š`casbin.CheckUserPermission()`
- ç”¨äºè‡ªå®šä¹‰æƒé™ï¼špending, verify, audit...
- æœ€ç»ˆå®‰å…¨å±éšœ

### 3. ç§Ÿæˆ·éš”ç¦»

```go
// ç§Ÿæˆ·æƒé™è¾¹ç•Œæ£€æŸ¥
if role.TenantID != "" {
    tenant := getTenant(role.TenantID)
    if !tenant.HasAllMenus(menuNames) {
        return fmt.Errorf("éƒ¨åˆ†èœå•è¶…å‡ºç§Ÿæˆ·æƒé™èŒƒå›´")
    }
}
```

### 4. é™çº§ç­–ç•¥

```typescript
// å‰ç«¯é™çº§
if (!menu_permissions) {
    // æ£€æŸ¥æ˜¯å¦æœ‰èœå•è®¿é—®æƒé™
    const hasMenu = menus.some(m => m.name === menuName)
    return hasMenu // æœ‰èœå•å°±å‡è®¾æœ‰æƒé™
}

// åç«¯é™çº§
if menuPath == "" {
    menuPath = getMenuPathFromNameFallback(menuName)
}
```

---

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### 1. ç®¡ç†å‘˜é…ç½®èœå•æƒé™

```javascript
// åœ¨ MongoDB ä¸­é…ç½®
db.menus.updateOne(
  { name: "finance" },
  {
    $set: {
      available_permissions: [
        { action: "read", label: "æŸ¥çœ‹", is_basic: true },
        { action: "create", label: "åˆ›å»º", is_basic: true },
        { action: "pending", label: "æŒ‚è´¦", is_basic: false, description: "å°†è®¢å•æŒ‚è´¦å»¶æœŸæ”¯ä»˜" },
        { action: "verify", label: "æ ¸é”€", is_basic: false },
        { action: "audit", label: "å®¡æ ¸", is_basic: false },
        { action: "export", label: "å¯¼å‡º", is_basic: false }
      ]
    }
  }
)
```

### 2. ç§Ÿæˆ·ç®¡ç†å‘˜åˆ†é…è§’è‰²æƒé™

è¿›å…¥ **ç³»ç»Ÿè®¾ç½® â†’ è§’è‰²ç®¡ç† â†’ åˆ†é…æƒé™**ï¼š

```
â˜‘ï¸ è´¢åŠ¡ç®¡ç†
   [åŸºç¡€æƒé™] â˜‘ï¸æŸ¥çœ‹ â˜‘ï¸åˆ›å»º â˜ä¿®æ”¹ â˜åˆ é™¤
   [ä¸šåŠ¡æƒé™] â˜‘ï¸æŒ‚è´¦ â˜‘ï¸æ ¸é”€ â˜å†²è´¦ â˜‘ï¸å®¡æ ¸ â˜‘ï¸å¯¼å‡º
```

æƒé™è‡ªåŠ¨åŒæ­¥åˆ° Casbinï¼š
```
p, tenant:A:role:finance_staff, /business/finance, read
p, tenant:A:role:finance_staff, /business/finance, create
p, tenant:A:role:finance_staff, /business/finance, pending
p, tenant:A:role:finance_staff, /business/finance, verify
p, tenant:A:role:finance_staff, /business/finance, audit
p, tenant:A:role:finance_staff, /business/finance, export
```

### 3. ç”¨æˆ·ç™»å½•è·å¾—æƒé™

**åç«¯è¿”å›ï¼š**
```json
{
  "token": "xxx",
  "user_id": "123",
  "nickname": "å¼ ä¸‰",
  "role": ["finance_staff"],
  "menu_permissions": {
    "admin": ["read", "create", "update"],
    "finance": ["read", "create", "pending", "verify", "audit", "export"]
  }
}
```

**å‰ç«¯å­˜å‚¨ï¼š**
```typescript
authStore.userInfo = {
  // ... å…¶ä»–å­—æ®µ
  menu_permissions: {
    "admin": ["read", "create", "update"],
    "finance": ["read", "create", "pending", "verify", "audit", "export"]
  }
}
```

### 4. å‰ç«¯æŒ‰é’®æƒé™æ§åˆ¶

**æ–¹å¼1ï¼šåœ¨ template ä¸­ä½¿ç”¨ v-if**
```vue
<template>
  <!-- æ–°å»ºæŒ‰é’® -->
  <NButton v-if="hasResource('admin:create')" @click="handleCreate">
    æ–°å»º
  </NButton>
  
  <!-- ç¼–è¾‘æŒ‰é’® -->
  <NButton v-if="hasAction('admin', 'update')" @click="handleEdit">
    ç¼–è¾‘
  </NButton>
  
  <!-- åˆ é™¤æŒ‰é’® -->
  <NButton v-if="hasAction('admin', 'delete')" @click="handleDelete">
    åˆ é™¤
  </NButton>
  
  <!-- ä¸šåŠ¡æƒé™æŒ‰é’® -->
  <NButton v-if="hasResource('finance:pending')" @click="handlePending">
    æŒ‚è´¦
  </NButton>
</template>

<script setup lang="ts">
import { usePermission } from '@/hooks'
const { hasAction, hasResource } = usePermission()
</script>
```

**æ–¹å¼2ï¼šåœ¨ JSX/TSX ä¸­ä½¿ç”¨**
```tsx
render: (row) => {
  return (
    <NSpace>
      {hasAction('admin', 'read') && (
        <NButton onClick={() => view(row)}>æŸ¥çœ‹</NButton>
      )}
      {hasAction('admin', 'update') && (
        <NButton onClick={() => edit(row)}>ç¼–è¾‘</NButton>
      )}
      {hasAction('admin', 'delete') && (
        <NButton onClick={() => del(row)}>åˆ é™¤</NButton>
      )}
    </NSpace>
  )
}
```

**æ–¹å¼3ï¼šåœ¨é€»è¾‘ä¸­æ£€æŸ¥**
```typescript
function handleOperation() {
  if (!hasAction('admin', 'delete')) {
    window.$message.error('æ— åˆ é™¤æƒé™')
    return
  }
  // æ‰§è¡Œåˆ é™¤
  deleteRecord()
}
```

### 5. åç«¯ä¸šåŠ¡ä»£ç æ£€æŸ¥æƒé™

```go
// app/business/services/finance.go

// æŒ‚è´¦æ¥å£
func (s *FinanceService) PendingPayment(c *gin.Context, req *dto.PendingRequest) error {
    userID := c.GetString("user_id")
    tenantID := c.GetString("tenant_id")
    
    // æ£€æŸ¥æŒ‚è´¦æƒé™
    allowed, err := casbin.CheckUserPermission(
        tenantID,
        userID,
        "/business/finance",
        "pending",  // è‡ªå®šä¹‰æƒé™
    )
    
    if !allowed {
        return fmt.Errorf("æ— æŒ‚è´¦æƒé™")
    }
    
    // æ‰§è¡ŒæŒ‚è´¦é€»è¾‘
    return s.repo.CreatePendingPayment(req)
}
```

---

## ğŸ“Š æ•°æ®æµå›¾

### æƒé™é…ç½®æµ

```
ç®¡ç†å‘˜é…ç½®èœå•æƒé™ (MongoDB)
  â†“
available_permissions: [
  {action: "read", label: "æŸ¥çœ‹", is_basic: true},
  {action: "pending", label: "æŒ‚è´¦", is_basic: false}
]
  â†“
ç§Ÿæˆ·ç®¡ç†å‘˜åˆ†é…è§’è‰²æƒé™ (å‰ç«¯ç•Œé¢)
  â†“
Role.menu_permissions: {
  "finance": ["read", "pending"]
}
  â†“
ä¿å­˜åˆ° MongoDB + åŒæ­¥åˆ° Casbin
  â†“
Casbin ç­–ç•¥:
p, tenant:A:role:staff, /finance, read
p, tenant:A:role:staff, /finance, pending
```

### ç”¨æˆ·è®¿é—®æµ

```
ç”¨æˆ·ç™»å½•
  â†“
åç«¯åˆå¹¶æ‰€æœ‰è§’è‰²æƒé™
  â†“
è¿”å› menu_permissions
  â†“
å‰ç«¯å­˜å‚¨åˆ° authStore
  â†“
é¡µé¢æ¸²æŸ“ï¼ŒhasAction æ£€æŸ¥
  â†“
æ˜¾ç¤º/éšè—æŒ‰é’®
  â†“
ç”¨æˆ·ç‚¹å‡»æ“ä½œ
  â†“
Gateway æ£€æŸ¥ HTTP æƒé™
  â†“
ä¸šåŠ¡ä»£ç æ£€æŸ¥è‡ªå®šä¹‰æƒé™
  â†“
æ‰§è¡Œ/æ‹’ç»
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. âœ… [Casbinå¢åˆ æ”¹æŸ¥æƒé™è¯´æ˜](./Casbinå¢åˆ æ”¹æŸ¥æƒé™è¯´æ˜.md)
2. âœ… [Casbinè‡ªå®šä¹‰ä¸šåŠ¡æƒé™æ–¹æ¡ˆ](./Casbinè‡ªå®šä¹‰ä¸šåŠ¡æƒé™æ–¹æ¡ˆ.md)
3. âœ… [Menu.rolesä½¿ç”¨è¯´æ˜](./Menu.rolesä½¿ç”¨è¯´æ˜.md)
4. âœ… [æƒé™ç³»ç»Ÿæ”¹é€ å®Œæˆè¯´æ˜](./æƒé™ç³»ç»Ÿæ”¹é€ å®Œæˆè¯´æ˜.md)
5. âœ… [ç»†ç²’åº¦æƒé™ä½¿ç”¨ç¤ºä¾‹](./ç»†ç²’åº¦æƒé™ä½¿ç”¨ç¤ºä¾‹.md)
6. âœ… [æƒé™ç³»ç»Ÿæœ€ç»ˆå®æ–½å®Œæˆ](./æƒé™ç³»ç»Ÿæœ€ç»ˆå®æ–½å®Œæˆ.md) â­ **æœ¬æ–‡æ¡£**

---

## ğŸ‰ æ€»ç»“

### æ ¸å¿ƒä¼˜åŠ¿

1. **çµæ´»æ‰©å±•** âœ¨
   - æ”¯æŒä»»æ„è‡ªå®šä¹‰æƒé™ï¼ˆæŒ‚è´¦ã€æ ¸é”€ã€å®¡æ ¸...ï¼‰
   - èœå•çº§å®šä¹‰æƒé™ï¼Œæ˜“äºç»´æŠ¤

2. **å¤šå±‚ä¿æŠ¤** ğŸ›¡ï¸
   - å‰ç«¯éšè—æŒ‰é’®ï¼ˆæå‡ä½“éªŒï¼‰
   - Gateway æ£€æŸ¥åŸºç¡€æƒé™ï¼ˆç»Ÿä¸€æ‹¦æˆªï¼‰
   - ä¸šåŠ¡ä»£ç æ£€æŸ¥è‡ªå®šä¹‰æƒé™ï¼ˆæœ€ç»ˆé˜²çº¿ï¼‰

3. **ç§Ÿæˆ·éš”ç¦»** ğŸ¢
   - ç§Ÿæˆ·è¶…ç®¡åªèƒ½åˆ†é…è‡ªå·±æ‹¥æœ‰çš„èœå•
   - æƒé™è¾¹ç•Œæ¸…æ™°

4. **ç”¨æˆ·ä½“éªŒ** ğŸ’
   - å¯è§†åŒ–é…ç½®ç•Œé¢
   - æ— æƒé™æŒ‰é’®è‡ªåŠ¨éšè—
   - é™çº§ç­–ç•¥ä¿è¯å¯ç”¨æ€§

5. **ç»Ÿä¸€ç®¡ç†** ğŸ“¦
   - æ‰€æœ‰æƒé™é€šè¿‡ Casbin ç»Ÿä¸€å­˜å‚¨
   - æƒé™å˜æ›´è‡ªåŠ¨åŒæ­¥
   - å®¡è®¡æ—¥å¿—å®Œæ•´

### æŠ€æœ¯äº®ç‚¹

- âœ… åç«¯ï¼šGo + MongoDB + Casbin
- âœ… å‰ç«¯ï¼šVue 3 + TypeScript + Naive UI
- âœ… å¾®æœåŠ¡ï¼šhttpclient æœåŠ¡é—´é€šä¿¡
- âœ… å®‰å…¨ï¼šå››å±‚æƒé™æ§åˆ¶
- âœ… ç”¨æˆ·ä½“éªŒï¼šé™çº§ç­–ç•¥
- âœ… ç»´æŠ¤æ€§ï¼šç±»å‹å®‰å…¨ + æ–‡æ¡£å®Œå–„

---

**æƒé™ç³»ç»Ÿå®æ–½å®Œæˆï¼** ğŸš€

ç°åœ¨ç³»ç»Ÿæ”¯æŒï¼š
- âœ… çµæ´»çš„å¢åˆ æ”¹æŸ¥æƒé™
- âœ… ä»»æ„è‡ªå®šä¹‰ä¸šåŠ¡æƒé™ï¼ˆæŒ‚è´¦ã€æ ¸é”€ã€å®¡æ ¸...ï¼‰
- âœ… èœå•çº§æƒé™é…ç½®
- âœ… æŒ‰é’®çº§æƒé™æ§åˆ¶
- âœ… ç§Ÿæˆ·éš”ç¦»
- âœ… å¤šå±‚å®‰å…¨é˜²æŠ¤

**å¯ä»¥æŠ•å…¥ç”Ÿäº§ä½¿ç”¨ï¼** ğŸŠ

