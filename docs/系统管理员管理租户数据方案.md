# 系统管理员管理租户数据方案

## 当前架构分析

### 数据存储

**系统库 (tenant_system)**
- tenant - 租户元数据
- menu - 菜单配置

**租户库 (mule_{tenantID})**
- admin - 租户管理员
- role - 租户角色
- basic - 业务数据 (color, size, customer, etc.)

### Context 和数据库切换

```go
// 系统管理员
tenantID := ""  // 空
→ db := r.dbManager.GetDatabase("")  // tenant_system

// 租户用户
tenantID := "68dda6cd04ba0d6c8dda4b7a"
→ db := r.dbManager.GetDatabase(tenantID)  // mule_68dda6cd04ba0d6c8dda4b7a
```

## 当前问题

**系统管理员无法查看和管理租户的业务数据**，因为：
1. 系统管理员的 `tenantID` 为空
2. Repository 自动切换到系统数据库
3. 但租户的 admin、role、业务数据都在租户数据库中

## 解决方案

### 方案1：租户上下文切换（推荐）⭐⭐⭐⭐⭐

**核心思路**：系统管理员可以临时"切换"到某个租户的上下文

#### 实现方式

**后端：添加 X-Tenant-Context header 支持**

```go
// core/middleware/tenant_context.go
func TenantContextMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        tenantID := tenantCtx.GetTenantID(c.Request.Context())
        
        // 系统管理员可以通过 X-Tenant-Context header 切换租户上下文
        if tenantID == "" {  // 系统管理员
            contextTenantID := c.GetHeader("X-Tenant-Context")
            if contextTenantID != "" {
                // 验证是否为系统管理员
                roles, _ := c.Get("roles")
                if hasRole(roles, "super") {
                    // 允许切换到指定租户上下文
                    ctx := c.Request.Context()
                    ctx = tenantCtx.WithTenantID(ctx, contextTenantID)
                    c.Request = c.Request.WithContext(ctx)
                    
                    log.Printf("系统管理员切换到租户上下文: %s", contextTenantID)
                }
            }
        }
        
        c.Next()
    }
}
```

**前端：添加租户选择下拉框**

```vue
<!-- 系统管理员页面顶部 -->
<template>
  <div v-if="isSystemAdmin" class="tenant-selector">
    <n-select
      v-model:value="selectedTenantId"
      :options="tenantOptions"
      placeholder="选择要管理的租户"
      @update:value="onTenantChange"
    />
  </div>
</template>

<script setup>
// 当切换租户时，设置全局 tenant context
const onTenantChange = (tenantId) => {
  // 设置到 axios interceptor
  axios.defaults.headers.common['X-Tenant-Context'] = tenantId
  
  // 刷新当前页面数据
  refreshData()
}
</script>
```

#### 优点
- ✅ 灵活：系统管理员可以切换到任意租户
- ✅ 安全：只有系统管理员可以切换
- ✅ 简单：前端只需添加一个下拉框
- ✅ 代码少：后端只需添加一个中间件

#### 缺点
- ⚠️ 需要手动切换租户（但这也是优点，避免误操作）

---

### 方案2：聚合查询接口 ⭐⭐⭐

**核心思路**：系统管理员看到的是所有租户数据的聚合

#### 实现方式

**后端：添加聚合查询服务**

```go
// app/system/services/tenant_data.go
func (s *TenantDataService) ListAllTenantColors() ([]ColorWithTenant, error) {
    var allColors []ColorWithTenant
    
    // 获取所有租户
    tenants, _ := s.tenantRepo.Find(ctx, bson.M{"is_deleted": 0})
    
    // 遍历每个租户数据库
    for _, tenant := range tenants {
        tenantCtx := tenantCtx.WithTenantID(ctx, tenant.ID)
        
        // 查询该租户的 colors
        colors, _ := s.colorRepo.Find(tenantCtx, bson.M{"name": "color"})
        
        // 添加租户信息
        for _, color := range colors {
            allColors = append(allColors, ColorWithTenant{
                Color: color,
                TenantID: tenant.ID,
                TenantName: tenant.Name,
            })
        }
    }
    
    return allColors, nil
}
```

#### 优点
- ✅ 统一视图：系统管理员看到所有数据
- ✅ 批量操作：可以跨租户统计、对比

#### 缺点
- ❌ 性能问题：需要遍历所有租户数据库
- ❌ 代码量大：每个资源都需要聚合接口
- ❌ 复杂度高：需要额外的数据结构

---

### 方案3：直接数据库查询（仅用于特殊情况）⭐⭐

**核心思路**：系统管理员专用接口，直接指定数据库查询

```go
// 系统管理员专用：查询指定租户的数据
func (s *AdminService) GetTenantColors(tenantID string) ([]models.Basic, error) {
    ctx := context.Background()
    ctx = tenantCtx.WithTenantID(ctx, tenantID)  // 强制设置租户上下文
    
    return s.colorRepo.Find(ctx, bson.M{"name": "color"})
}
```

---

## 推荐实施方案

### 🎯 方案1：租户上下文切换（最佳实践）

#### 实施步骤

**步骤1：添加租户上下文中间件**
```bash
# 创建文件
touch core/middleware/tenant_context.go
```

**步骤2：前端添加租户选择器**
- 在系统管理页面顶部添加租户下拉框
- 仅系统管理员可见
- 选择后设置 `X-Tenant-Context` header

**步骤3：API 请求拦截器**
```typescript
// frontend/src/service/http/index.ts
axios.interceptors.request.use((config) => {
  // 如果是系统管理员且已选择租户
  const selectedTenantId = localStorage.getItem('selected_tenant_id')
  const userTenantId = store.state.auth.userInfo?.tenant_id
  
  if (!userTenantId && selectedTenantId) {  // 系统管理员 + 已选择租户
    config.headers['X-Tenant-Context'] = selectedTenantId
  }
  
  return config
})
```

#### 用户体验

```
系统管理员登录
  ↓
看到租户选择下拉框：
  [ 选择要管理的租户 ▼ ]
  - 租户A
  - 租户B
  - 租户C
  ↓
选择"租户A"
  ↓
所有页面的数据都是租户A的：
  - admin 管理员
  - role 角色
  - color 颜色
  - customer 客户
  等等...
  ↓
切换到"租户B"
  ↓
立即看到租户B的数据
```

---

## 当前缺失的功能

### 1. ❌ 租户上下文切换中间件
**位置**: `core/middleware/tenant_context.go`  
**功能**: 允许系统管理员通过 header 切换租户上下文

### 2. ❌ 前端租户选择器
**位置**: `frontend/src/components/TenantSelector.vue`  
**功能**: 系统管理员选择要管理的租户

### 3. ❌ 前端 HTTP 拦截器
**位置**: `frontend/src/service/http/index.ts`  
**功能**: 自动添加 `X-Tenant-Context` header

### 4. ❌ 系统管理员权限验证
**位置**: 中间件中  
**功能**: 确保只有系统管理员可以切换租户上下文

---

## 需要实施吗？

我可以帮你：
1. **立即实施方案1** - 完整实现租户上下文切换功能
2. **只看方案** - 提供详细的实施指南，你自己实施
3. **其他方案** - 讨论其他可能的方案

请告诉我你的选择，我会相应提供代码或文档！
