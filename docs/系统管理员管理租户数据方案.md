# ç³»ç»Ÿç®¡ç†å‘˜ç®¡ç†ç§Ÿæˆ·æ•°æ®æ–¹æ¡ˆ

## å½“å‰æ¶æ„åˆ†æ

### æ•°æ®å­˜å‚¨

**ç³»ç»Ÿåº“ (tenant_system)**
- tenant - ç§Ÿæˆ·å…ƒæ•°æ®
- menu - èœå•é…ç½®

**ç§Ÿæˆ·åº“ (mule_{tenantID})**
- admin - ç§Ÿæˆ·ç®¡ç†å‘˜
- role - ç§Ÿæˆ·è§’è‰²
- basic - ä¸šåŠ¡æ•°æ® (color, size, customer, etc.)

### Context å’Œæ•°æ®åº“åˆ‡æ¢

```go
// ç³»ç»Ÿç®¡ç†å‘˜
tenantID := ""  // ç©º
â†’ db := r.dbManager.GetDatabase("")  // tenant_system

// ç§Ÿæˆ·ç”¨æˆ·
tenantID := "68dda6cd04ba0d6c8dda4b7a"
â†’ db := r.dbManager.GetDatabase(tenantID)  // mule_68dda6cd04ba0d6c8dda4b7a
```

## å½“å‰é—®é¢˜

**ç³»ç»Ÿç®¡ç†å‘˜æ— æ³•æŸ¥çœ‹å’Œç®¡ç†ç§Ÿæˆ·çš„ä¸šåŠ¡æ•°æ®**ï¼Œå› ä¸ºï¼š
1. ç³»ç»Ÿç®¡ç†å‘˜çš„ `tenantID` ä¸ºç©º
2. Repository è‡ªåŠ¨åˆ‡æ¢åˆ°ç³»ç»Ÿæ•°æ®åº“
3. ä½†ç§Ÿæˆ·çš„ adminã€roleã€ä¸šåŠ¡æ•°æ®éƒ½åœ¨ç§Ÿæˆ·æ•°æ®åº“ä¸­

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šç§Ÿæˆ·ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆæ¨èï¼‰â­â­â­â­â­

**æ ¸å¿ƒæ€è·¯**ï¼šç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥ä¸´æ—¶"åˆ‡æ¢"åˆ°æŸä¸ªç§Ÿæˆ·çš„ä¸Šä¸‹æ–‡

#### å®ç°æ–¹å¼

**åç«¯ï¼šæ·»åŠ  X-Tenant-Context header æ”¯æŒ**

```go
// core/middleware/tenant_context.go
func TenantContextMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        tenantID := tenantCtx.GetTenantID(c.Request.Context())
        
        // ç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥é€šè¿‡ X-Tenant-Context header åˆ‡æ¢ç§Ÿæˆ·ä¸Šä¸‹æ–‡
        if tenantID == "" {  // ç³»ç»Ÿç®¡ç†å‘˜
            contextTenantID := c.GetHeader("X-Tenant-Context")
            if contextTenantID != "" {
                // éªŒè¯æ˜¯å¦ä¸ºç³»ç»Ÿç®¡ç†å‘˜
                roles, _ := c.Get("roles")
                if hasRole(roles, "super") {
                    // å…è®¸åˆ‡æ¢åˆ°æŒ‡å®šç§Ÿæˆ·ä¸Šä¸‹æ–‡
                    ctx := c.Request.Context()
                    ctx = tenantCtx.WithTenantID(ctx, contextTenantID)
                    c.Request = c.Request.WithContext(ctx)
                    
                    log.Printf("ç³»ç»Ÿç®¡ç†å‘˜åˆ‡æ¢åˆ°ç§Ÿæˆ·ä¸Šä¸‹æ–‡: %s", contextTenantID)
                }
            }
        }
        
        c.Next()
    }
}
```

**å‰ç«¯ï¼šæ·»åŠ ç§Ÿæˆ·é€‰æ‹©ä¸‹æ‹‰æ¡†**

```vue
<!-- ç³»ç»Ÿç®¡ç†å‘˜é¡µé¢é¡¶éƒ¨ -->
<template>
  <div v-if="isSystemAdmin" class="tenant-selector">
    <n-select
      v-model:value="selectedTenantId"
      :options="tenantOptions"
      placeholder="é€‰æ‹©è¦ç®¡ç†çš„ç§Ÿæˆ·"
      @update:value="onTenantChange"
    />
  </div>
</template>

<script setup>
// å½“åˆ‡æ¢ç§Ÿæˆ·æ—¶ï¼Œè®¾ç½®å…¨å±€ tenant context
const onTenantChange = (tenantId) => {
  // è®¾ç½®åˆ° axios interceptor
  axios.defaults.headers.common['X-Tenant-Context'] = tenantId
  
  // åˆ·æ–°å½“å‰é¡µé¢æ•°æ®
  refreshData()
}
</script>
```

#### ä¼˜ç‚¹
- âœ… çµæ´»ï¼šç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥åˆ‡æ¢åˆ°ä»»æ„ç§Ÿæˆ·
- âœ… å®‰å…¨ï¼šåªæœ‰ç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥åˆ‡æ¢
- âœ… ç®€å•ï¼šå‰ç«¯åªéœ€æ·»åŠ ä¸€ä¸ªä¸‹æ‹‰æ¡†
- âœ… ä»£ç å°‘ï¼šåç«¯åªéœ€æ·»åŠ ä¸€ä¸ªä¸­é—´ä»¶

#### ç¼ºç‚¹
- âš ï¸ éœ€è¦æ‰‹åŠ¨åˆ‡æ¢ç§Ÿæˆ·ï¼ˆä½†è¿™ä¹Ÿæ˜¯ä¼˜ç‚¹ï¼Œé¿å…è¯¯æ“ä½œï¼‰

---

### æ–¹æ¡ˆ2ï¼šèšåˆæŸ¥è¯¢æ¥å£ â­â­â­

**æ ¸å¿ƒæ€è·¯**ï¼šç³»ç»Ÿç®¡ç†å‘˜çœ‹åˆ°çš„æ˜¯æ‰€æœ‰ç§Ÿæˆ·æ•°æ®çš„èšåˆ

#### å®ç°æ–¹å¼

**åç«¯ï¼šæ·»åŠ èšåˆæŸ¥è¯¢æœåŠ¡**

```go
// app/system/services/tenant_data.go
func (s *TenantDataService) ListAllTenantColors() ([]ColorWithTenant, error) {
    var allColors []ColorWithTenant
    
    // è·å–æ‰€æœ‰ç§Ÿæˆ·
    tenants, _ := s.tenantRepo.Find(ctx, bson.M{"is_deleted": 0})
    
    // éå†æ¯ä¸ªç§Ÿæˆ·æ•°æ®åº“
    for _, tenant := range tenants {
        tenantCtx := tenantCtx.WithTenantID(ctx, tenant.ID)
        
        // æŸ¥è¯¢è¯¥ç§Ÿæˆ·çš„ colors
        colors, _ := s.colorRepo.Find(tenantCtx, bson.M{"name": "color"})
        
        // æ·»åŠ ç§Ÿæˆ·ä¿¡æ¯
        for _, color := range colors {
            allColors = append(allColors, ColorWithTenant{
                Color: color,
                TenantID: tenant.ID,
                TenantName: tenant.Name,
            })
        }
    }
    
    return allColors, nil
}
```

#### ä¼˜ç‚¹
- âœ… ç»Ÿä¸€è§†å›¾ï¼šç³»ç»Ÿç®¡ç†å‘˜çœ‹åˆ°æ‰€æœ‰æ•°æ®
- âœ… æ‰¹é‡æ“ä½œï¼šå¯ä»¥è·¨ç§Ÿæˆ·ç»Ÿè®¡ã€å¯¹æ¯”

#### ç¼ºç‚¹
- âŒ æ€§èƒ½é—®é¢˜ï¼šéœ€è¦éå†æ‰€æœ‰ç§Ÿæˆ·æ•°æ®åº“
- âŒ ä»£ç é‡å¤§ï¼šæ¯ä¸ªèµ„æºéƒ½éœ€è¦èšåˆæ¥å£
- âŒ å¤æ‚åº¦é«˜ï¼šéœ€è¦é¢å¤–çš„æ•°æ®ç»“æ„

---

### æ–¹æ¡ˆ3ï¼šç›´æ¥æ•°æ®åº“æŸ¥è¯¢ï¼ˆä»…ç”¨äºç‰¹æ®Šæƒ…å†µï¼‰â­â­

**æ ¸å¿ƒæ€è·¯**ï¼šç³»ç»Ÿç®¡ç†å‘˜ä¸“ç”¨æ¥å£ï¼Œç›´æ¥æŒ‡å®šæ•°æ®åº“æŸ¥è¯¢

```go
// ç³»ç»Ÿç®¡ç†å‘˜ä¸“ç”¨ï¼šæŸ¥è¯¢æŒ‡å®šç§Ÿæˆ·çš„æ•°æ®
func (s *AdminService) GetTenantColors(tenantID string) ([]models.Basic, error) {
    ctx := context.Background()
    ctx = tenantCtx.WithTenantID(ctx, tenantID)  // å¼ºåˆ¶è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡
    
    return s.colorRepo.Find(ctx, bson.M{"name": "color"})
}
```

---

## æ¨èå®æ–½æ–¹æ¡ˆ

### ğŸ¯ æ–¹æ¡ˆ1ï¼šç§Ÿæˆ·ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆæœ€ä½³å®è·µï¼‰

#### å®æ–½æ­¥éª¤

**æ­¥éª¤1ï¼šæ·»åŠ ç§Ÿæˆ·ä¸Šä¸‹æ–‡ä¸­é—´ä»¶**
```bash
# åˆ›å»ºæ–‡ä»¶
touch core/middleware/tenant_context.go
```

**æ­¥éª¤2ï¼šå‰ç«¯æ·»åŠ ç§Ÿæˆ·é€‰æ‹©å™¨**
- åœ¨ç³»ç»Ÿç®¡ç†é¡µé¢é¡¶éƒ¨æ·»åŠ ç§Ÿæˆ·ä¸‹æ‹‰æ¡†
- ä»…ç³»ç»Ÿç®¡ç†å‘˜å¯è§
- é€‰æ‹©åè®¾ç½® `X-Tenant-Context` header

**æ­¥éª¤3ï¼šAPI è¯·æ±‚æ‹¦æˆªå™¨**
```typescript
// frontend/src/service/http/index.ts
axios.interceptors.request.use((config) => {
  // å¦‚æœæ˜¯ç³»ç»Ÿç®¡ç†å‘˜ä¸”å·²é€‰æ‹©ç§Ÿæˆ·
  const selectedTenantId = localStorage.getItem('selected_tenant_id')
  const userTenantId = store.state.auth.userInfo?.tenant_id
  
  if (!userTenantId && selectedTenantId) {  // ç³»ç»Ÿç®¡ç†å‘˜ + å·²é€‰æ‹©ç§Ÿæˆ·
    config.headers['X-Tenant-Context'] = selectedTenantId
  }
  
  return config
})
```

#### ç”¨æˆ·ä½“éªŒ

```
ç³»ç»Ÿç®¡ç†å‘˜ç™»å½•
  â†“
çœ‹åˆ°ç§Ÿæˆ·é€‰æ‹©ä¸‹æ‹‰æ¡†ï¼š
  [ é€‰æ‹©è¦ç®¡ç†çš„ç§Ÿæˆ· â–¼ ]
  - ç§Ÿæˆ·A
  - ç§Ÿæˆ·B
  - ç§Ÿæˆ·C
  â†“
é€‰æ‹©"ç§Ÿæˆ·A"
  â†“
æ‰€æœ‰é¡µé¢çš„æ•°æ®éƒ½æ˜¯ç§Ÿæˆ·Açš„ï¼š
  - admin ç®¡ç†å‘˜
  - role è§’è‰²
  - color é¢œè‰²
  - customer å®¢æˆ·
  ç­‰ç­‰...
  â†“
åˆ‡æ¢åˆ°"ç§Ÿæˆ·B"
  â†“
ç«‹å³çœ‹åˆ°ç§Ÿæˆ·Bçš„æ•°æ®
```

---

## å½“å‰ç¼ºå¤±çš„åŠŸèƒ½

### 1. âŒ ç§Ÿæˆ·ä¸Šä¸‹æ–‡åˆ‡æ¢ä¸­é—´ä»¶
**ä½ç½®**: `core/middleware/tenant_context.go`  
**åŠŸèƒ½**: å…è®¸ç³»ç»Ÿç®¡ç†å‘˜é€šè¿‡ header åˆ‡æ¢ç§Ÿæˆ·ä¸Šä¸‹æ–‡

### 2. âŒ å‰ç«¯ç§Ÿæˆ·é€‰æ‹©å™¨
**ä½ç½®**: `frontend/src/components/TenantSelector.vue`  
**åŠŸèƒ½**: ç³»ç»Ÿç®¡ç†å‘˜é€‰æ‹©è¦ç®¡ç†çš„ç§Ÿæˆ·

### 3. âŒ å‰ç«¯ HTTP æ‹¦æˆªå™¨
**ä½ç½®**: `frontend/src/service/http/index.ts`  
**åŠŸèƒ½**: è‡ªåŠ¨æ·»åŠ  `X-Tenant-Context` header

### 4. âŒ ç³»ç»Ÿç®¡ç†å‘˜æƒé™éªŒè¯
**ä½ç½®**: ä¸­é—´ä»¶ä¸­  
**åŠŸèƒ½**: ç¡®ä¿åªæœ‰ç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥åˆ‡æ¢ç§Ÿæˆ·ä¸Šä¸‹æ–‡

---

## éœ€è¦å®æ–½å—ï¼Ÿ

æˆ‘å¯ä»¥å¸®ä½ ï¼š
1. **ç«‹å³å®æ–½æ–¹æ¡ˆ1** - å®Œæ•´å®ç°ç§Ÿæˆ·ä¸Šä¸‹æ–‡åˆ‡æ¢åŠŸèƒ½
2. **åªçœ‹æ–¹æ¡ˆ** - æä¾›è¯¦ç»†çš„å®æ–½æŒ‡å—ï¼Œä½ è‡ªå·±å®æ–½
3. **å…¶ä»–æ–¹æ¡ˆ** - è®¨è®ºå…¶ä»–å¯èƒ½çš„æ–¹æ¡ˆ

è¯·å‘Šè¯‰æˆ‘ä½ çš„é€‰æ‹©ï¼Œæˆ‘ä¼šç›¸åº”æä¾›ä»£ç æˆ–æ–‡æ¡£ï¼
