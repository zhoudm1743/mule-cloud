# 超管切换租户功能完整修复总结

## 问题概述

超管通过租户选择器切换租户后出现两个问题：
1. 数据库未正常获取（仍然查询系统数据库）
2. 页面跳转到登录页（前端未发送租户上下文 header）

## 问题 1：数据库未正常获取

### 原因

后端 Service 层使用 `context.Background()` 创建新的空上下文，丢失了从 HTTP 请求传递下来的租户上下文信息。

### 修复

修改了 5 个后端文件，为所有 Service 方法添加 `ctx context.Context` 参数：

1. **app/perms/services/admin.go**
   - 修改接口：所有方法添加 `ctx` 参数
   - 修改实现：使用传入的 `ctx` 而不是 `context.Background()`
   - 使用 `GetCollectionWithContext(ctx)` 获取正确的租户数据库

2. **app/perms/endpoint/admin.go**
   - 所有 endpoint 传递 `ctx` 给 service 方法

3. **internal/repository/admin.go**
   - 添加 `GetCollectionWithContext(ctx)` 方法
   - 根据 context 中的 tenantCode 获取正确的数据库集合

4. **core/database/manager.go**
   - 修复 `GetDatabase()` 方法，同时处理空字符串和 "system"

5. **app/perms/services/tenant.go**
   - 更新调用 admin service 的代码

### 效果

```diff
// Before ❌
[MongoDB] 执行命令: ... "$db": "tenant_system"}

// After ✅
[MongoDB] 执行命令: ... "$db": "mule_ace"}
```

## 问题 2：页面跳转登录页

### 原因

前端 HTTP 拦截器的条件判断过于严格，且存在时序问题：

```typescript
// ❌ 问题代码
const userInfo = local.get('userInfo')
const selectedTenantCode = local.get('selected_tenant_code')

if (userInfo && !userInfo.tenant_id && selectedTenantCode) {
  method.config.headers['X-Tenant-Context'] = selectedTenantCode
}
```

问题：
1. 页面刷新后，`userInfo` 可能还未从 localStorage 恢复
2. 条件不成立，导致没有添加 `X-Tenant-Context` header
3. 后端认为用户没有权限，返回 401 未授权

### 修复

简化 HTTP 拦截器逻辑，将权限验证交给后端：

```typescript
// ✅ 修复后
const selectedTenantCode = local.get('selected_tenant_code')
if (selectedTenantCode) {
  method.config.headers['X-Tenant-Context'] = selectedTenantCode
}
```

### 修改文件

1. **frontend/src/service/http/alova.ts**
   - 简化租户上下文 header 的添加逻辑
   - 移除对 `userInfo` 的依赖，避免时序问题

### 安全性

前端简化后，安全性由后端保证：

```go
// core/middleware/tenant_context.go
if currentTenantCode == "" || currentTenantCode == "system" {
    if isSuperAdmin {
        // ✅ 允许系统管理员切换
        ctx = tenantCtx.WithTenantCode(ctx, contextTenantCode)
    } else {
        // ❌ 拒绝普通用户切换
    }
}
```

## 完整的数据流

### 1. 用户切换租户

```javascript
// frontend/src/components/TenantSelector.vue
function onTenantChange(value: string) {
  local.set('selected_tenant_code', 'ace')  // 保存到 localStorage
  window.location.reload()                   // 刷新页面
}
```

### 2. HTTP 请求发送

```javascript
// frontend/src/service/http/alova.ts
beforeRequest: onAuthRequired((method) => {
  const selectedTenantCode = local.get('selected_tenant_code')  // = 'ace'
  if (selectedTenantCode) {
    method.config.headers['X-Tenant-Context'] = 'ace'  // ✅ 添加 header
  }
})
```

### 3. 后端中间件验证

```go
// core/middleware/gateway_or_jwt.go
claims, _ := jwtManager.ValidateToken(tokenString)
ctx = tenantCtx.WithTenantCode(ctx, claims.TenantCode)  // = "system"
```

```go
// core/middleware/tenant_context.go
currentTenantCode := tenantCtx.GetTenantCode(ctx)  // = "system"
contextTenantCode := c.GetHeader("X-Tenant-Context")  // = "ace"

if currentTenantCode == "system" && isSuperAdmin {
  ctx = tenantCtx.WithTenantCode(ctx, "ace")  // ✅ 切换到租户上下文
}
```

### 4. Repository 获取数据库

```go
// internal/repository/admin.go
func (r *adminRepository) getCollection(ctx context.Context) *mongo.Collection {
  tenantCode := tenantCtx.GetTenantCode(ctx)  // = "ace"
  db := r.dbManager.GetDatabase(tenantCode)    // = mule_ace
  return db.Collection("admin")
}
```

### 5. 数据库查询

```
[MongoDB] 执行命令: find, ... "$db": "mule_ace"}  ✅
```

## 修改的文件清单

### 后端（5个文件）

1. `app/perms/services/admin.go` - Service 接口和实现
2. `app/perms/endpoint/admin.go` - Endpoint 层
3. `internal/repository/admin.go` - Repository 层
4. `core/database/manager.go` - 数据库管理器
5. `app/perms/services/tenant.go` - 租户服务

### 前端（1个文件）

1. `frontend/src/service/http/alova.ts` - HTTP 拦截器

### 文档（3个文件）

1. `docs/修复-超管切换租户数据库问题.md` - 后端问题分析
2. `docs/修复-超管切换租户前端问题.md` - 前端问题分析
3. `docs/测试-超管切换租户功能.md` - 测试指南

## 测试验证

### 1. 编译后端

```bash
cd cmd/perms
go build  # ✅ 编译成功
```

### 2. 启动服务

```bash
# 启动 perms 服务
./perms.exe

# 查看日志
[租户上下文切换] ✅ 系统管理员切换到租户: ace
[MongoDB] 执行命令: ... "$db": "mule_ace"}
```

### 3. 前端测试

1. 以系统管理员身份登录
2. 选择租户"ace"
3. 页面刷新（不会跳转到登录页 ✅）
4. 查看网络请求：
   ```
   Request Headers:
     X-Tenant-Context: ace  ✅
   ```
5. 查看返回数据：来自 `mule_ace` 数据库 ✅

## 经验教训

### 1. Context 传递的重要性

在微服务架构中，Context 是传递请求级别信息的关键，不能在中间层丢失。

**错误做法：**
```go
func (s *Service) Method(req Request) (*Response, error) {
  ctx := context.Background()  // ❌ 丢失了租户信息
  // ...
}
```

**正确做法：**
```go
func (s *Service) Method(ctx context.Context, req Request) (*Response, error) {
  // ✅ 使用传入的 ctx
  // ...
}
```

### 2. 前端时序问题

页面刷新后，localStorage 数据的恢复和状态的初始化存在时序问题。

**错误做法：**
```typescript
const userInfo = local.get('userInfo')  // 可能还未加载
if (userInfo && userInfo.xxx) {
  // ...
}
```

**正确做法：**
```typescript
// 依赖最少的状态，避免时序问题
const config = local.get('some_config')
if (config) {
  // ...
}
```

### 3. 权限验证的位置

前端验证是 UX 优化，后端验证是安全保证。

- ✅ 前端：简化逻辑，提供友好提示
- ✅ 后端：严格验证，保证安全

不要把所有验证逻辑都放在前端，也不要过度依赖前端验证。

## 后续优化建议

### 1. 不刷新页面切换租户

当前实现使用 `window.location.reload()`，用户体验不够好。可以改为：

```typescript
async function onTenantChange(value: string) {
  local.set('selected_tenant_code', value)
  // 重新加载当前页面数据，而不是刷新整个页面
  await reloadCurrentPageData()
}
```

### 2. 显示当前租户

在页面顶部显示当前正在管理的租户，提醒用户：

```vue
<n-alert v-if="selectedTenantId" type="warning">
  当前正在管理租户: {{ currentTenantName }}
</n-alert>
```

### 3. 添加切换确认

切换租户前提示用户：

```typescript
async function onTenantChange(value: string) {
  const confirmed = await confirm('确定要切换租户吗？')
  if (confirmed) {
    // 执行切换
  }
}
```

### 4. 统一其他服务

目前只修复了 Admin Service，其他服务（如 Role、Menu、Dept 等）也应该进行相同的修复。

## 总结

这次修复涉及前后端两个独立但相关的问题：

1. **后端问题**：Context 传递断层，导致数据库选择错误
   - 解决方案：在整个调用链中传递 context

2. **前端问题**：时序问题导致 header 未发送
   - 解决方案：简化逻辑，依赖最少的状态

两个问题都修复后，超管切换租户功能正常工作。

