# 防止重复上报修复说明

## 问题描述

用户发现可以对同一批次的同一工序重复上报，每次上报都会：
1. 创建新的上报记录
2. 重复计算工资
3. 导致工资数据错误

**示例：**
- 批次：202510070999 扎号9
- 工序：裁剪
- 数量：4800件
- 单价：3元
- 每次上报都会增加 ¥14400 工资

## 问题原因

后端 `SubmitReport` 方法在提交上报前，**没有检查该批次该工序是否已经完成**，导致可以无限次重复上报。

## 修复方案

### 1. 添加重复上报检查

在 `app/production/services/report.go` 的 `SubmitReport` 方法中，添加以下逻辑：

```go
// 检查批次工序进度，防止重复上报
if req.BatchID != "" {
    progress, err := s.batchProgressRepo.GetByBatchAndProcedure(ctx, req.BatchID, req.ProcedureSeq)
    if err == nil && progress != nil {
        // 检查是否已完成
        if progress.IsCompleted {
            return nil, fmt.Errorf("该批次该工序已完成上报，不可重复上报")
        }
        
        // 检查上报数量是否超限
        if progress.ReportedQty+req.Quantity > progress.Quantity {
            return nil, fmt.Errorf("上报数量超限：已上报%d件，批次总量%d件，本次上报%d件",
                progress.ReportedQty, progress.Quantity, req.Quantity)
        }
    }
}
```

### 2. 检查逻辑说明

**检查项1：是否已完成**
- 查询 `BatchProcedureProgress` 表
- 如果 `is_completed = true`，拒绝上报
- 返回错误："该批次该工序已完成上报，不可重复上报"

**检查项2：数量是否超限**
- 计算：已上报数量 + 本次上报数量
- 如果超过批次总数量，拒绝上报
- 返回详细的数量信息

### 3. 进度更新机制

每次成功上报后，会自动更新批次工序进度：

```go
// 更新批次工序进度
if req.BatchID != "" {
    _ = s.batchProgressRepo.UpdateReportedQty(ctx, req.BatchID, req.ProcedureSeq, req.Quantity)
}
```

`UpdateReportedQty` 方法会：
1. 累加已上报数量：`reported_qty += quantity`
2. 检查是否完成：`is_completed = (reported_qty >= quantity)`
3. 如果完成，记录完成时间：`completed_at = now()`

## 数据流程

### 正常上报流程

```
1. 扫码
   └─> 初始化批次进度（如果不存在）
       └─> 创建 BatchProcedureProgress 记录
           - reported_qty: 0
           - is_completed: false

2. 第一次上报（4800件）
   └─> 检查进度：✅ 未完成，数量未超限
   └─> 创建上报记录
   └─> 更新进度：
       - reported_qty: 4800
       - is_completed: true
       - completed_at: 当前时间

3. 第二次上报（尝试）
   └─> 检查进度：❌ 已完成
   └─> 返回错误："该批次该工序已完成上报，不可重复上报"
   └─> 上报失败
```

### 部分上报场景

如果支持部分上报（批次总量 > 单次上报量）：

```
批次总量：10000件

1. 第一次上报：5000件
   └─> reported_qty: 5000
   └─> is_completed: false ✅

2. 第二次上报：3000件
   └─> 检查：5000 + 3000 = 8000 <= 10000 ✅
   └─> reported_qty: 8000
   └─> is_completed: false

3. 第三次上报：2000件
   └─> 检查：8000 + 2000 = 10000 <= 10000 ✅
   └─> reported_qty: 10000
   └─> is_completed: true ✅

4. 第四次上报：1件
   └─> 检查：is_completed = true ❌
   └─> 拒绝上报
```

### 超量上报保护

```
批次总量：5000件

1. 上报6000件（超量）
   └─> 检查：0 + 6000 > 5000 ❌
   └─> 返回："上报数量超限：已上报0件，批次总量5000件，本次上报6000件"
```

## 小程序端提示

前端在 `pages/report/detail.vue` 中已有提示：

```javascript
// 检查是否已完成上报
const progress = getProcedureProgress(selectedProcedure.value.sequence)
if (progress && progress.is_completed) {
    const confirmed = await new Promise(resolve => {
        uni.showModal({
            title: '提示',
            content: '该批次该工序已全部上报，确定要重复上报吗？',
            success: (res) => resolve(res.confirm)
        })
    })
    if (!confirmed) return
}
```

**现在后端会拒绝重复上报**，即使前端确认也无法提交成功。

## 如何测试

### 测试步骤

1. **启动 production 服务**
   ```powershell
   cd cmd/production
   go run main.go -c ../../config/production.yaml
   ```

2. **扫码获取批次信息**
   - 小程序扫描菲码
   - 查看批次工序进度

3. **第一次上报**
   - 选择工序（如：裁剪）
   - 点击"提交上报"
   - 预期：✅ 上报成功，显示工资

4. **第二次上报（同一批次同一工序）**
   - 再次扫描相同的菲码
   - 选择相同的工序
   - 点击"提交上报"
   - 预期：❌ 上报失败，提示"该批次该工序已完成上报，不可重复上报"

### 预期结果

**成功场景：**
```json
{
  "code": 200,
  "data": {
    "report_id": "xxx",
    "total_price": 14400,
    "message": "上报成功"
  }
}
```

**失败场景（重复上报）：**
```json
{
  "code": 400,
  "message": "该批次该工序已完成上报，不可重复上报"
}
```

**失败场景（超量上报）：**
```json
{
  "code": 400,
  "message": "上报数量超限：已上报4800件，批次总量4800件，本次上报4800件"
}
```

## 已清理数据

如果需要清理重复上报的测试数据：

```javascript
// 在 MongoDB 中执行
use mule  // 或你的数据库名

// 查看重复的上报记录
db.procedure_reports.aggregate([
  {
    $group: {
      _id: { batch_id: "$batch_id", procedure_seq: "$procedure_seq" },
      count: { $sum: 1 },
      records: { $push: "$$ROOT" }
    }
  },
  { $match: { count: { $gt: 1 } } }
])

// 删除重复记录（保留第一条）
// 注意：请根据实际情况谨慎操作
```

## 修改文件清单

- ✅ `app/production/services/report.go` - 添加重复上报检查
- ✅ `internal/repository/batch_procedure_progress.go` - 已有相关方法
- ✅ `internal/models/production.go` - 数据模型定义

## 部署说明

修改完成后，需要重启 production 服务：

```powershell
# 方法1：使用启动脚本
.\start.ps1

# 方法2：单独重启 production 服务
cd cmd/production
go run main.go -c ../../config/production.yaml
```

## 注意事项

1. **历史数据**：修复前已经产生的重复记录需要手动清理
2. **工资计算**：清理重复记录后，需要重新计算工人的工资统计
3. **无批次上报**：如果 `batch_id` 为空，不会进行重复检查（适用于无扎号工序）
4. **并发控制**：当前实现在数据库层面有原子性保证，不会出现并发问题

## 相关文档

- [扫码打菲工序上报实施方案](./扫码打菲工序上报实施方案.md)
- [Production 服务调试指南](./production服务调试指南.md)

