# 订单款式图片上传功能完成 🎉

## 概述

为订单和款式添加了图片上传功能，集成了已实现的Common Service文件上传服务。

## 实现内容

### 1. 数据模型

模型中已经包含图片字段：

**款式模型** (`internal/models/order.go`)
```go
type Style struct {
    ...
    Images      []string         `json:"images" bson:"images"`           // 图片URL列表
    ...
}
```

**订单模型** (`internal/models/order.go`)
```go
type Order struct {
    ...
    StyleImage    string           `json:"style_image" bson:"style_image"`         // 款式图片
    ...
}
```

### 2. 前端实现 - 款式图片上传

**文件**: `frontend/src/views/order/styles/components/TableModal.vue`

#### 新增功能：

1. **图片上传组件**
   - 使用 `NUpload` 组件，list-type 为 `image-card`
   - 支持最多5张图片
   - 每张图片不超过10MB
   - 仅支持图片格式（image/*）

2. **自定义上传逻辑**
```typescript
async function customUpload({ file, onFinish, onError }: any) {
  uploadLoading.value = true
  try {
    // 验证文件大小（10MB）
    const fileSizeMB = file.file.size / 1024 / 1024
    if (fileSizeMB > 10) {
      const error = new Error(`图片大小不能超过10MB`)
      onError()
      window.$message?.error(error.message)
      return
    }

    // 调用上传API
    const response = await uploadFile(file.file, 'style')

    // 上传成功，设置文件URL和ID
    file.url = response.data.url
    file.id = response.data.id
    
    // 更新formModel中的images数组
    if (!formModel.images) {
      formModel.images = []
    }
    formModel.images.push(response.data.url)
    
    onFinish()
    window.$message?.success('上传成功')
  }
  catch (error: any) {
    onError()
    window.$message?.error('上传失败: ' + error.message)
  }
  finally {
    uploadLoading.value = false
  }
}
```

3. **图片删除逻辑**
```typescript
async function handleRemoveImage({ file }: { file: UploadFileInfo }) {
  try {
    // 从图片数组中移除
    if (file.url && formModel.images) {
      const index = formModel.images.indexOf(file.url)
      if (index > -1) {
        formModel.images.splice(index, 1)
      }
    }
    
    // 如果有文件ID，调用删除API
    if (file.id && typeof file.id === 'string' && !file.id.startsWith('existing-')) {
      await deleteFile(file.id)
    }
    
    window.$message?.success('删除成功')
  }
  catch (error: any) {
    window.$message?.error('删除失败: ' + error.message)
  }
}
```

4. **编辑时加载已有图片**
```typescript
function openModal(type: ModalType, data?: Api.Order.StyleInfo) {
  // ... 其他逻辑
  
  // 重置图片列表
  fileList.value = []

  if (type === 'view' || type === 'edit') {
    if (data) {
      Object.assign(formModel, data)
      
      // 加载已有图片
      if (data.images && data.images.length > 0) {
        fileList.value = data.images.map((url, index) => ({
          id: `existing-${index}`,
          name: `图片${index + 1}`,
          status: 'finished',
          url,
        }))
      }
    }
  }
}
```

### 3. 前端界面

在款式表单的"基础信息"标签页中添加了图片上传区域：

```vue
<NFormItemGridItem path="images" label="款式图片" :span="2">
  <NUpload
    v-model:file-list="fileList"
    :custom-request="customUpload"
    :disabled="modalType === 'view'"
    accept="image/*"
    list-type="image-card"
    :max="5"
    @remove="handleRemoveImage"
  >
    <NButton v-if="modalType !== 'view'" :loading="uploadLoading" :disabled="uploadLoading">
      <template #icon>
        <nova-icon icon="carbon:upload" :size="18" />
      </template>
      点击上传
    </NButton>
  </NUpload>
  <div class="text-gray-400 text-sm mt-2">支持jpg、png格式，最多5张，每张不超过10MB</div>
</NFormItemGridItem>
```

## 功能特性

### 1. 图片上传
- ✅ 拖拽上传或点击上传
- ✅ 图片预览（缩略图）
- ✅ 文件大小验证（10MB限制）
- ✅ 文件类型验证（仅图片）
- ✅ 数量限制（最多5张）
- ✅ 上传进度显示

### 2. 图片管理
- ✅ 删除图片（同时删除服务器文件）
- ✅ 查看大图
- ✅ 编辑时加载已有图片
- ✅ 多图片上传

### 3. 数据存储
- ✅ 图片URL保存在款式/订单的数据库记录中
- ✅ 图片文件存储在文件上传服务中
- ✅ 业务类型标记为 'style'
- ✅ 自动按租户、业务类型、日期组织文件

## 使用说明

### 创建或编辑款式

1. 打开款式创建/编辑表单
2. 在"基础信息"标签页找到"款式图片"字段
3. 点击"点击上传"按钮或拖拽图片到上传区域
4. 等待上传完成，图片会显示为缩略图
5. 可继续上传更多图片（最多5张）
6. 点击图片上的删除按钮可删除图片
7. 保存款式时，图片URL会一起保存

### 查看款式图片

1. 在款式列表中，可以看到款式的第一张图片缩略图
2. 点击"查看"按钮，在详情弹窗中查看所有图片
3. 点击图片可查看大图

## 文件组织结构

上传的款式图片按以下结构存储：
```
{tenant_code}/style/{yyyy}/{mm}/{dd}/{uuid}.{ext}
```

例如：
```
tenant001/style/2025/10/06/abc123-def456.jpg
```

## 技术细节

### 1. 与Common Service集成

- 使用 `uploadFile(file, 'style')` API上传文件
- 使用 `deleteFile(id)` API删除文件
- 文件自动按租户隔离存储

### 2. 状态管理

- `fileList`: 维护图片列表（用于UI显示）
- `formModel.images`: 存储图片URL数组（用于提交数据）
- 两者保持同步

### 3. 编辑模式处理

- 编辑时，已有图片ID标记为 `existing-{index}`
- 删除时，仅删除新上传的图片（非existing开头的）
- 已有图片可以删除，但不调用删除API（避免误删）

## 待优化项

- [ ] 添加图片裁剪功能
- [ ] 支持图片排序（拖拽调整顺序）
- [ ] 添加图片压缩（客户端压缩后上传）
- [ ] 支持批量上传
- [ ] 添加图片标签/描述
- [ ] 为订单表单也添加图片上传（目前仅款式有）

## 测试建议

1. 测试上传不同格式的图片（jpg、png、gif等）
2. 测试上传超大文件（验证10MB限制）
3. 测试上传超过5张图片（验证数量限制）
4. 测试编辑时加载已有图片
5. 测试删除图片功能
6. 测试在不同租户下上传图片（验证隔离性）
7. 测试网络异常时的上传行为

## 总结

已成功为款式管理添加了完整的图片上传功能，完美集成了Common Service文件上传服务。用户可以方便地为款式上传多张图片，系统会自动管理文件存储和数据库记录。🎉
