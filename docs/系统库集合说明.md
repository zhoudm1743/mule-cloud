# 系统库集合说明

## 当前架构调整

经过实际数据分析，确定以下集合统一存储在系统库（tenant_system）：

### 系统库（tenant_system）集合

#### 1. tenant - 租户元数据
- **说明**：租户信息表
- **隔离方式**：无需隔离（全局唯一）
- **Repository**：始终使用系统库

#### 2. menu - 菜单配置
- **说明**：全局菜单配置
- **隔离方式**：无需隔离（全局共享）
- **Repository**：始终使用系统库

#### 3. role - 角色配置
- **说明**：所有租户的角色数据
- **隔离方式**：无需物理隔离（在系统库中）
- **Repository**：始终使用系统库
- **注意**：虽然在系统库，但前端/业务逻辑可能需要区分租户

#### 4. admin - 管理员用户
- **说明**：所有租户的管理员数据
- **隔离方式**：无需物理隔离（在系统库中）
- **Repository**：始终使用系统库
- **注意**：虽然在系统库，但前端/业务逻辑可能需要区分租户

### 租户库（mule_xxx）集合

目前**不存在租户数据库**，所有数据都在系统库中。

## Repository 配置

### MenuRepository ✅
```go
func (r *MenuRepository) getCollection(ctx context.Context) *mongo.Collection {
    db := r.dbManager.GetDatabase("") // 系统库
    return db.Collection("menu")
}
```

### RoleRepository ✅（已修复）
```go
func (r *roleRepository) getCollection(ctx context.Context) *mongo.Collection {
    db := r.dbManager.GetDatabase("") // 系统库
    return db.Collection("role")
}
```

### AdminRepository ✅（已修复）
```go
func (r *adminRepository) getCollection(ctx context.Context) *mongo.Collection {
    db := r.dbManager.GetDatabase("") // 系统库
    return db.Collection("admin")
}
```

### TenantRepository ✅
```go
func (r *tenantRepository) getCollection(ctx context.Context) *mongo.Collection {
    db := r.dbManager.GetDatabase("") // 系统库
    return db.Collection("tenant")
}
```

### BasicRepository（业务数据）
```go
func (r *basicRepository) getCollection(ctx context.Context) *mongo.Collection {
    tenantID := tenantCtx.GetTenantID(ctx)
    db := r.dbManager.GetDatabase(tenantID) // 租户库（如果创建的话）
    return db.Collection("basic")
}
```

## 当前状态

### ✅ 已修复
1. **MenuRepository** - 始终使用系统库
2. **TenantRepository** - 始终使用系统库
3. **RoleRepository** - 始终使用系统库（刚修复）
4. **AdminRepository** - 始终使用系统库

### 📊 实际数据分布
```
tenant_system (系统库)
├── tenant      (租户元数据)
├── menu        (菜单配置)
├── role        (角色数据) ← 所有角色都在这里
└── admin       (管理员数据) ← 所有用户都在这里
```

### 💡 架构说明

**当前是"单库多租户"架构：**
- 所有数据在一个数据库（tenant_system）
- 通过业务逻辑区分租户（如果需要的话）
- 没有物理隔离，但代码支持物理隔离的切换

**如果未来需要物理隔离：**
1. 创建租户数据库（mule_xxx）
2. 迁移 admin、role 到对应租户库
3. AdminRepository、RoleRepository 的 getCollection 改为根据 context 切换
4. 无需修改其他代码（因为已经使用 Context 传递）

## 关键点

1. ✅ **所有核心数据在系统库** - tenant, menu, role, admin
2. ✅ **Repository 正确配置** - 都指向系统库
3. ✅ **Context 机制保留** - 为未来物理隔离做准备
4. ✅ **前端无需检查 tenant_id** - 数据都在同一库

## 下一步

当前架构适用于：
- 中小型应用
- 租户数量不多
- 不需要极致的数据隔离

如果未来需要：
- 更严格的数据隔离
- 支持大量租户
- 租户独立扩展

可以通过数据迁移实现物理隔离，代码结构已经支持这种切换。

