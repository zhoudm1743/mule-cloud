# 工作流设计器功能说明

## 📋 需求理解

您希望实现的是**可自定义的工作流设计器**，而不只是查看固定的工作流。我正在实现以下功能：

## 🎯 新增功能

### 1. 数据库存储的工作流定义
- ✅ 工作流定义不再硬编码在代码中
- ✅ 存储在MongoDB系统库
- ✅ 支持多版本管理
- ✅ 支持激活/停用

### 2. 可视化工作流编辑器
用户可以通过拖拽方式自定义工作流：

```
┌────────────────────────────────────────────────────┐
│  订单工作流设计器                                    │
├────────────────────────────────────────────────────┤
│  [新建] [保存] [发布] [预览]                         │
├─────────┬──────────────────────────────────────────┤
│ 组件库   │           画布区域                        │
│         │                                          │
│ 📍起始  │    ┌───┐                                 │
│ 📄状态  │    │草稿│                                 │
│ 🔀转换  │    └─┬─┘                                 │
│ ⚙️条件  │      │ 提交订单                           │
│         │    ┌─▼──┐                                │
│         │    │已下单│                                │
│         │    └─┬──┘                                │
│         │      │ 开始生产                           │
│         │    ┌─▼───┐      ┌────┐                  │
│         │    │生产中│─────▶│已完成│                  │
│         │    └─────┘      └────┘                  │
└─────────┴──────────────────────────────────────────┘
```

### 3. 灵活的状态定义
用户可以自定义：
- 状态名称（如：草稿、已下单、生产中...）
- 状态类型（起始、中间、结束）
- 状态颜色（用于可视化区分）
- 状态描述

### 4. 灵活的转换规则
用户可以定义：
- **触发事件**：提交、取消、完成等
- **转换条件**：
  - 字段条件：如 `progress >= 100`
  - 脚本条件：支持复杂逻辑
  - 角色权限：如需要admin角色
- **转换动作**：
  - 更新字段
  - 发送通知
  - 自定义脚本

### 5. 条件配置器
```
┌───────────────────────────────────────┐
│  转换规则配置                          │
├───────────────────────────────────────┤
│  事件名称: [完成订单___________]       │
│  起始状态: [生产中 ▼]                 │
│  目标状态: [已完成 ▼]                 │
│                                       │
│  转换条件:                             │
│  ┌─────────────────────────────────┐ │
│  │ 字段: progress                  │ │
│  │ 操作符: >=                      │ │
│  │ 值: 1.0                         │ │
│  │ 描述: 进度必须达到100%           │ │
│  └─────────────────────────────────┘ │
│  [+ 添加条件]                         │
│                                       │
│  权限要求: [ ] admin [ ] 生产主管    │
│                                       │
│  [保存] [取消]                        │
└───────────────────────────────────────┘
```

## 🔧 技术实现

### 后端
1. **数据模型**（已完成）
   - `WorkflowDefinition` - 工作流定义
   - `WorkflowState` - 状态定义
   - `WorkflowTransition` - 转换规则
   - `TransitionCondition` - 转换条件
   - `TransitionAction` - 转换动作

2. **Repository**（已完成）
   - 工作流定义的CRUD
   - 版本管理
   - 激活/停用

3. **Service**（已完成）
   - 工作流设计器服务
   - 条件检查引擎
   - 动作执行引擎

4. **API**（待实现）
   - 工作流定义管理
   - 工作流实例管理
   - 转换执行

### 前端
1. **可视化编辑器**（待实现）
   - 使用LogicFlow或G6
   - 拖拽式节点编辑
   - 连线配置
   
2. **配置面板**（待实现）
   - 状态配置器
   - 条件配置器
   - 动作配置器

## 🎨 使用场景

### 场景1：订单工作流
```javascript
{
  "name": "订单工作流",
  "code": "order_workflow",
  "states": [
    { "id": "draft", "name": "草稿", "type": "start" },
    { "id": "ordered", "name": "已下单", "type": "normal" },
    { "id": "production", "name": "生产中", "type": "normal" },
    { "id": "completed", "name": "已完成", "type": "end" }
  ],
  "transitions": [
    {
      "fromState": "draft",
      "toState": "ordered",
      "event": "submit",
      "conditions": [],
      "actions": []
    },
    {
      "fromState": "production",
      "toState": "completed",
      "event": "complete",
      "conditions": [
        {
          "type": "field",
          "field": "progress",
          "operator": "gte",
          "value": 1.0
        }
      ],
      "actions": [
        {
          "type": "send_notification",
          "description": "发送完成通知"
        }
      ]
    }
  ]
}
```

### 场景2：自定义审批流程
用户可以自己设计：
```
提交 → 部门主管审批 → 总经理审批 → 完成
  ↘                         ↗
    驳回 ───────────────────┘
```

### 场景3：质检流程
```
生产完成 → 质检 → 合格 → 入库
            ↓
          不合格 → 返工 → 质检
```

## 🚀 下一步实现计划

### 阶段1：基础API（进行中）
- [x] 数据模型
- [x] Repository层
- [x] Service层
- [ ] API端点
- [ ] 测试

### 阶段2：前端编辑器
- [ ] 可视化画布
- [ ] 节点拖拽
- [ ] 连线配置
- [ ] 保存/加载

### 阶段3：条件配置器
- [ ] 字段条件配置
- [ ] 脚本编辑器
- [ ] 权限配置
- [ ] 预览测试

### 阶段4：高级功能
- [ ] 工作流模板库
- [ ] 版本比较
- [ ] 导入/导出
- [ ] 工作流模拟

## ❓ 需要确认

1. **可视化编辑器库的选择**
   - LogicFlow（推荐）：阿里开源，流程图编辑
   - G6：蚂蚁开源，图编辑引擎
   - X6：AntV开源，图编辑引擎

2. **条件表达式的复杂度**
   - 简单：仅支持字段比较
   - 中等：支持AND/OR逻辑
   - 复杂：支持JavaScript表达式

3. **权限粒度**
   - 基于角色
   - 基于用户
   - 基于部门

## 📝 当前进度

✅ 已完成：
- 数据模型设计
- Repository实现
- Service基础实现

🔄 进行中：
- API接口实现

⏳ 待实现：
- 前端可视化编辑器
- 条件配置UI

---

**这是您想要的功能吗？需要继续实现吗？**

