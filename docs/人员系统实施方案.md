# 服装生产MES人员系统实施方案

## 📋 目录
- [1. 现状分析](#1-现状分析)
- [2. 系统架构设计](#2-系统架构设计)
- [3. 数据存储架构](#3-数据存储架构)
- [4. 数据模型设计](#4-数据模型设计)
- [5. 功能模块设计](#5-功能模块设计)
- [6. API接口设计](#6-api接口设计)
- [7. 小程序UI设计](#7-小程序ui设计)
- [8. 实施计划](#8-实施计划)
- [9. 数据迁移方案](#9-数据迁移方案)
- [10. 安全与权限](#10-安全与权限)

---

## 1. 现状分析

### 1.1 当前系统

**已有模型**：
```go
// WechatUser - 全局微信用户（系统库：tenant_system.wechat_user）
type WechatUser struct {
    ID        string   `json:"id" bson:"_id,omitempty"`
    UnionID   string   `json:"union_id" bson:"union_id"`    // 微信UnionID
    OpenID    string   `json:"open_id" bson:"open_id"`      // 微信OpenID
    Phone     string   `json:"phone" bson:"phone"`          // 手机号
    Nickname  string   `json:"nickname" bson:"nickname"`    // 微信昵称
    Avatar    string   `json:"avatar" bson:"avatar"`        // 微信头像
    Gender    int      `json:"gender" bson:"gender"`        // 性别：0-未知 1-男 2-女
    Country   string   `json:"country" bson:"country"`      // 国家
    Province  string   `json:"province" bson:"province"`    // 省份
    City      string   `json:"city" bson:"city"`            // 城市
    TenantIDs []string `json:"tenant_ids" bson:"tenant_ids"` // 关联的租户ID列表
    // ...系统字段
}

// TenantMember - 租户成员（租户库：tenant_xxx.member）
type TenantMember struct {
    ID         string   `json:"id" bson:"_id,omitempty"`
    UnionID    string   `json:"union_id" bson:"union_id"`  // 关联全局用户
    UserID     string   `json:"user_id" bson:"user_id"`    // 全局用户ID
    Name       string   `json:"name" bson:"name"`          // 姓名
    JobNumber  string   `json:"job_number" bson:"job_number"` // 工号
    Department string   `json:"department" bson:"department"` // 部门
    Position   string   `json:"position" bson:"position"`     // 岗位
    Phone      string   `json:"phone" bson:"phone"`           // 联系电话
    Avatar     string   `json:"avatar" bson:"avatar"`         // 头像
    Roles      []string `json:"role" bson:"role"`             // 角色
    Status     string   `json:"status" bson:"status"`         // 状态
    // ...系统字段
}
```

**小程序现有功能**：
- ✅ 编辑姓名、性别、电话
- ✅ 编辑工号、部门、岗位
- ✅ 上传/更换头像

### 1.2 存在问题

**❌ 缺少的基本信息**：
- 身份证号、生日、年龄、民族、籍贯
- 婚姻状况、政治面貌、学历
- 家庭住址、紧急联系人
- 员工证件照（不同于微信头像）

**❌ 缺少的工作信息**：
- 车间、班组（服装厂必需）
- 入职日期、转正日期、工龄
- 合同类型、合同期限
- 离职日期、离职原因

**❌ 缺少的生产相关信息**：
- 技能列表（缝纫、裁剪、整烫等）
- 技能等级（初级、中级、高级、专家）
- 可操作工序（关联工序表）
- 证书资质

**❌ 缺少的薪资信息**：
- 薪资类型（计时、计件、月薪）
- 基本工资、计件单价
- 银行卡信息

**❌ 缺少的管理功能**：
- 员工查询、统计
- 花名册导出
- 技能统计报表
- 合同到期提醒

---

## 2. 系统架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                    微信小程序端                          │
│  - 员工自助服务（查看档案、编辑信息）                   │
│  - 考勤打卡、工序上报                                   │
└─────────────────────────────────────────────────────────┘
                            ↓ HTTP/HTTPS
┌─────────────────────────────────────────────────────────┐
│                    API网关 (Gateway)                     │
│  - JWT认证                                              │
│  - 租户上下文传递                                       │
│  - 路由转发                                             │
└─────────────────────────────────────────────────────────┘
                            ↓ gRPC
┌─────────────────────────────────────────────────────────┐
│               Miniapp Service (小程序服务)               │
│  - 微信登录                                             │
│  - 员工档案管理                                         │
│  - 租户切换                                             │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                  MongoDB 数据存储                        │
│  ┌───────────────────────────────────────────────────┐  │
│  │  系统库 (tenant_system)                          │  │
│  │  - wechat_user        全局微信用户               │  │
│  │  - user_tenant_map    用户-租户映射              │  │
│  │  - tenant             租户信息                   │  │
│  └───────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────┐  │
│  │  租户库 (tenant_ace)  ← 按 tenant_code 命名     │  │
│  │  - member             租户成员（员工档案）★      │  │
│  │  - order              订单数据                   │  │
│  │  - production         生产数据                   │  │
│  │  - ...                其他业务数据               │  │
│  └───────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────┐  │
│  │  租户库 (tenant_factory2)                        │  │
│  │  - member             租户成员                   │  │
│  │  - ...                                           │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 2.2 数据流

**登录流程**：
```
1. 小程序 wx.login() 获取 code
2. 调用 /miniapp/wechat/login (code)
3. 后端调用微信API获取 UnionID/OpenID
4. 查询/创建 WechatUser（系统库）
5. 查询 user_tenant_map 获取租户列表
6. 生成 JWT Token（包含 tenant_code）
7. 返回 Token 和用户信息
```

**获取员工档案流程**：
```
1. 小程序携带 JWT Token 请求 /miniapp/member/profile
2. 网关验证 JWT，提取 tenant_code
3. Context 传递 tenant_code
4. Repository 自动切换到 tenant_xxx 数据库
5. 从 member 集合查询员工档案
6. 返回完整员工信息
```

**更新员工信息流程**：
```
1. 小程序提交更新数据 PUT /miniapp/member/profile/basic
2. Service 层根据字段权限判断是否可编辑
3. Repository 更新 member 集合
4. 同时更新 WechatUser 中的冗余字段（如头像、昵称）
```

---

## 3. 数据存储架构

### 3.1 存储策略

**系统库 (tenant_system) - 全局唯一数据**：
| 集合名 | 说明 | 用途 |
|--------|------|------|
| `wechat_user` | 微信用户 | 存储全局微信用户基本信息（UnionID、OpenID、昵称、头像等） |
| `user_tenant_map` | 用户-租户映射 | 记录用户在哪些租户中有成员身份 |
| `tenant` | 租户信息 | 租户基本信息（name、code、状态等） |

**租户库 (tenant_{code}) - 租户隔离数据**：
| 集合名 | 说明 | 用途 |
|--------|------|------|
| `member` | **租户成员（员工档案）** | 存储完整的员工档案信息（本方案核心） |
| `order` | 订单 | 订单数据 |
| `production` | 生产 | 生产记录 |
| `attendance` | 考勤 | 考勤打卡记录 |
| `salary` | 薪资 | 薪资计算记录 |

### 3.2 数据隔离机制

**物理隔离**：
```go
// 通过 tenant_code 自动切换数据库
ctx := context.Background()
ctx = tenantCtx.WithTenantCode(ctx, "ace")  // 设置租户code

// Repository 自动切换到 tenant_ace 数据库
dbName := fmt.Sprintf("tenant_%s", tenantCode) // "tenant_ace"
db := client.Database(dbName)
collection := db.Collection("member")
```

**关键代码**：
```go
// core/context/tenant.go
func WithTenantCode(ctx context.Context, tenantCode string) context.Context {
    return context.WithValue(ctx, TenantCodeKey, tenantCode)
}

func GetTenantCode(ctx context.Context) string {
    if code, ok := ctx.Value(TenantCodeKey).(string); ok {
        return code
    }
    return ""
}

// internal/repository/member.go
func (r *memberRepository) getCollection(ctx context.Context) *mongo.Collection {
    tenantCode := tenantCtx.GetTenantCode(ctx)
    dbName := fmt.Sprintf("tenant_%s", tenantCode)
    db := r.client.Database(dbName)
    return db.Collection("member")
}
```

### 3.3 数据关联

```
系统库                       租户库
┌─────────────────┐         ┌─────────────────┐
│ wechat_user     │         │ member          │
│ ─────────────── │         │ ─────────────── │
│ _id (user_id)   │◄────────│ user_id         │
│ union_id        │◄────────│ union_id        │
│ nickname        │         │ name            │
│ avatar          │         │ avatar          │
│ phone           │         │ phone           │
│                 │         │ job_number      │
│                 │         │ department      │
│                 │         │ skills          │
│                 │         │ salary_type     │
└─────────────────┘         └─────────────────┘

关联方式：
1. union_id 作为全局唯一标识（主要）
2. user_id 作为辅助关联（WechatUser._id）
```

### 3.4 数据冗余策略

**冗余字段**（提高查询性能）：
```go
// WechatUser（系统库）存储微信原始信息
WechatUser.Nickname = "微信昵称"
WechatUser.Avatar   = "微信头像"
WechatUser.Phone    = "手机号"

// TenantMember（租户库）存储企业内信息（可被管理员修改）
TenantMember.Name   = "张三"      // 企业内称呼，可能与微信昵称不同
TenantMember.Avatar = "工作照"    // 企业内头像，可能与微信头像不同
TenantMember.Phone  = "工作手机"  // 工作手机，可能与微信绑定手机不同
```

**更新策略**：
1. 用户在小程序编辑基本信息 → 同时更新 WechatUser 和 TenantMember
2. 管理员修改员工信息 → 只更新 TenantMember
3. 微信登录更新头像昵称 → 只更新 WechatUser

### 3.5 索引设计

**系统库 - wechat_user 索引**：
```javascript
db.wechat_user.createIndex({ "union_id": 1 }, { unique: true, sparse: true })
db.wechat_user.createIndex({ "open_id": 1 }, { unique: true })
db.wechat_user.createIndex({ "phone": 1 }, { unique: true, sparse: true })
db.wechat_user.createIndex({ "tenant_ids": 1 })
```

**租户库 - member 索引**：
```javascript
db.member.createIndex({ "union_id": 1 }, { unique: true })  // 全局唯一
db.member.createIndex({ "user_id": 1 })                     // 关联查询
db.member.createIndex({ "job_number": 1 }, { unique: true, sparse: true }) // 工号唯一
db.member.createIndex({ "phone": 1 })                       // 手机号查询
db.member.createIndex({ "department": 1, "status": 1 })     // 部门筛选
db.member.createIndex({ "status": 1, "is_deleted": 1 })     // 状态筛选
db.member.createIndex({ "id_card_no": 1 }, { unique: true, sparse: true }) // 身份证唯一
db.member.createIndex({ "skills.process_ids": 1 })          // 技能查询
```

---

## 4. 数据模型设计

### 4.1 TenantMember 完整模型

```go
package models

// TenantMember 租户成员（员工档案）- 存储在租户库 tenant_xxx.member
type TenantMember struct {
    ID string `json:"id" bson:"_id,omitempty"` // MongoDB ObjectID
    
    // ========== 基础关联 ==========
    UnionID string `json:"union_id" bson:"union_id"` // 微信UnionID（全局唯一标识）
    UserID  string `json:"user_id" bson:"user_id"`   // 全局用户ID（WechatUser._id）
    
    // ========== 个人基本信息 ==========
    Name        string `json:"name" bson:"name"`               // 姓名（真实姓名）
    NamePinyin  string `json:"name_pinyin" bson:"name_pinyin"` // 姓名拼音（用于排序）
    Gender      int    `json:"gender" bson:"gender"`           // 性别：0-未知 1-男 2-女
    IDCardType  string `json:"id_card_type" bson:"id_card_type"` // 证件类型：idcard-身份证 passport-护照
    IDCardNo    string `json:"id_card_no" bson:"id_card_no"`   // 身份证号/护照号（加密存储）
    Birthday    int64  `json:"birthday" bson:"birthday"`       // 出生日期（Unix时间戳）
    Age         int    `json:"age" bson:"age"`                 // 年龄（自动计算）
    Nation      string `json:"nation" bson:"nation"`           // 民族（如：汉族、回族等）
    NativePlace string `json:"native_place" bson:"native_place"` // 籍贯（如：广东深圳）
    MaritalStatus string `json:"marital_status" bson:"marital_status"` // 婚姻状况：single-未婚 married-已婚 divorced-离异
    Political   string `json:"political" bson:"political"`     // 政治面貌：party-党员 league-团员 masses-群众
    Education   string `json:"education" bson:"education"`     // 学历：primary-小学 middle-初中 high-高中 college-大专 bachelor-本科 master-硕士 doctor-博士
    Avatar      string `json:"avatar" bson:"avatar"`           // 头像（可能与微信头像不同）
    Photo       string `json:"photo" bson:"photo"`             // 员工证件照（一寸照）
    
    // ========== 联系信息 ==========
    Phone            string `json:"phone" bson:"phone"`                   // 手机号（主要联系方式）
    Email            string `json:"email" bson:"email"`                   // 邮箱
    Address          string `json:"address" bson:"address"`               // 家庭住址（详细地址）
    EmergencyContact string `json:"emergency_contact" bson:"emergency_contact"` // 紧急联系人姓名
    EmergencyPhone   string `json:"emergency_phone" bson:"emergency_phone"`     // 紧急联系电话
    EmergencyRelation string `json:"emergency_relation" bson:"emergency_relation"` // 与紧急联系人关系（如：父亲、配偶等）
    
    // ========== 企业信息 ==========
    JobNumber    string `json:"job_number" bson:"job_number"`   // 工号（企业内唯一）
    Department   string `json:"department" bson:"department"`   // 部门名称（如：生产部、质检部）
    DepartmentID string `json:"department_id" bson:"department_id"` // 部门ID（如果有部门表）
    Position     string `json:"position" bson:"position"`       // 岗位名称（如：缝纫工、裁剪师）
    PositionID   string `json:"position_id" bson:"position_id"` // 岗位ID（如果有岗位表）
    Workshop     string `json:"workshop" bson:"workshop"`       // 车间（如：一车间、二车间）
    WorkshopID   string `json:"workshop_id" bson:"workshop_id"` // 车间ID
    Team         string `json:"team" bson:"team"`               // 班组（如：A组、B组）
    TeamID       string `json:"team_id" bson:"team_id"`         // 班组ID
    TeamLeader   string `json:"team_leader" bson:"team_leader"` // 班组长姓名
    
    // ========== 权限与角色 ==========
    Roles       []string `json:"role" bson:"role"`             // 角色ID数组（注意：字段名为role单数）
    Permissions []string `json:"permissions" bson:"permissions"` // 额外权限
    
    // ========== 工作相关 ==========
    EmployedAt      int64  `json:"employed_at" bson:"employed_at"`         // 入职日期（Unix时间戳）
    RegularAt       int64  `json:"regular_at" bson:"regular_at"`           // 转正日期（0表示未转正）
    ContractType    string `json:"contract_type" bson:"contract_type"`     // 合同类型：fulltime-全职 parttime-兼职 intern-实习 dispatch-劳务派遣
    ContractStartAt int64  `json:"contract_start_at" bson:"contract_start_at"` // 合同开始日期
    ContractEndAt   int64  `json:"contract_end_at" bson:"contract_end_at"`     // 合同结束日期（0表示无固定期限）
    WorkYears       int    `json:"work_years" bson:"work_years"`           // 工龄（自动计算，年）
    WorkMonths      int    `json:"work_months" bson:"work_months"`         // 工龄（自动计算，月）
    
    // ========== 技能与资质（服装生产特有） ==========
    Skills       []MemberSkill       `json:"skills" bson:"skills"`             // 技能列表
    Certificates []MemberCertificate `json:"certificates" bson:"certificates"` // 证书列表
    
    // ========== 薪资信息（敏感信息，权限控制） ==========
    SalaryType      string  `json:"salary_type" bson:"salary_type"`         // 薪资类型：hourly-计时 piece-计件 monthly-月薪 mixed-混合
    BaseSalary      float64 `json:"base_salary" bson:"base_salary"`         // 基本工资（元/月）
    HourlyRate      float64 `json:"hourly_rate" bson:"hourly_rate"`         // 时薪（元/小时）
    PieceRate       float64 `json:"piece_rate" bson:"piece_rate"`           // 计件单价（元/件，服装行业常用）
    BankName        string  `json:"bank_name" bson:"bank_name"`             // 开户行
    BankAccount     string  `json:"bank_account" bson:"bank_account"`       // 银行卡号（加密存储）
    BankAccountName string  `json:"bank_account_name" bson:"bank_account_name"` // 开户名
    
    // ========== 状态 ==========
    Status      string `json:"status" bson:"status"`             // 状态：active-在职 probation-试用期 inactive-离职 suspended-停职
    LeftAt      int64  `json:"left_at" bson:"left_at,omitempty"` // 离职时间（Unix时间戳）
    LeftReason  string `json:"left_reason" bson:"left_reason"`   // 离职原因
    
    // ========== 备注 ==========
    Remark string `json:"remark" bson:"remark"` // 备注（可填写特殊情况说明）
    
    // ========== 系统字段 ==========
    IsDeleted int    `json:"is_deleted" bson:"is_deleted"`
    CreatedBy string `json:"created_by" bson:"created_by"`
    UpdatedBy string `json:"updated_by" bson:"updated_by"`
    CreatedAt int64  `json:"created_at" bson:"created_at"`
    UpdatedAt int64  `json:"updated_at" bson:"updated_at"`
}

// MemberSkill 员工技能（服装生产特有）
type MemberSkill struct {
    Name       string   `json:"name" bson:"name"`               // 技能名称（如：缝纫、裁剪、整烫、包装、质检等）
    Level      string   `json:"level" bson:"level"`             // 技能等级：beginner-初级 intermediate-中级 advanced-高级 expert-专家
    ProcessIDs []string `json:"process_ids" bson:"process_ids"` // 可操作的工序ID列表（关联工序表）
    ObtainedAt int64    `json:"obtained_at" bson:"obtained_at"` // 获得时间（Unix时间戳）
    Remark     string   `json:"remark" bson:"remark"`           // 备注
}

// MemberCertificate 员工证书
type MemberCertificate struct {
    Name       string `json:"name" bson:"name"`               // 证书名称（如：职业技能等级证书、特种作业操作证等）
    No         string `json:"no" bson:"no"`                   // 证书编号
    IssueOrg   string `json:"issue_org" bson:"issue_org"`     // 发证机关
    IssuedAt   int64  `json:"issued_at" bson:"issued_at"`     // 发证日期（Unix时间戳）
    ExpiredAt  int64  `json:"expired_at" bson:"expired_at"`   // 过期日期（0表示长期有效）
    FileURL    string `json:"file_url" bson:"file_url"`       // 证书扫描件URL
}

// TableName 返回集合名
func (TenantMember) TableName() string {
    return "member"
}

// IsActive 是否在职
func (m *TenantMember) IsActive() bool {
    return m.Status == "active"
}

// IsProbation 是否试用期
func (m *TenantMember) IsProbation() bool {
    return m.Status == "probation"
}

// CalculateAge 计算年龄
func (m *TenantMember) CalculateAge() int {
    if m.Birthday == 0 {
        return 0
    }
    birthYear := time.Unix(m.Birthday, 0).Year()
    currentYear := time.Now().Year()
    return currentYear - birthYear
}

// CalculateWorkYears 计算工龄（返回年和月）
func (m *TenantMember) CalculateWorkYears() (years int, months int) {
    if m.EmployedAt == 0 {
        return 0, 0
    }
    
    employedTime := time.Unix(m.EmployedAt, 0)
    now := time.Now()
    
    years = now.Year() - employedTime.Year()
    months = int(now.Month()) - int(employedTime.Month())
    
    if months < 0 {
        years--
        months += 12
    }
    
    return years, months
}

// HasSkill 是否拥有指定技能
func (m *TenantMember) HasSkill(skillName string) bool {
    for _, skill := range m.Skills {
        if skill.Name == skillName {
            return true
        }
    }
    return false
}

// CanOperateProcess 是否可以操作指定工序
func (m *TenantMember) CanOperateProcess(processID string) bool {
    for _, skill := range m.Skills {
        for _, pid := range skill.ProcessIDs {
            if pid == processID {
                return true
            }
        }
    }
    return false
}

// MaskIDCardNo 脱敏身份证号
func (m *TenantMember) MaskIDCardNo() string {
    if len(m.IDCardNo) < 8 {
        return m.IDCardNo
    }
    return m.IDCardNo[:3] + "***********" + m.IDCardNo[len(m.IDCardNo)-4:]
}

// MaskBankAccount 脱敏银行卡号
func (m *TenantMember) MaskBankAccount() string {
    if len(m.BankAccount) < 8 {
        return m.BankAccount
    }
    return m.BankAccount[:4] + " **** **** " + m.BankAccount[len(m.BankAccount)-4:]
}
```

### 4.2 字段说明表

| 分类 | 字段数 | 必填字段 | 可选字段 |
|------|--------|----------|----------|
| 基础关联 | 2 | UnionID, UserID | - |
| 个人基本信息 | 13 | Name, Gender | Birthday, IDCardNo, Nation, Education等 |
| 联系信息 | 6 | Phone | Email, Address, EmergencyContact等 |
| 企业信息 | 10 | JobNumber, Department, Position | Workshop, Team等 |
| 权限与角色 | 2 | Roles | Permissions |
| 工作相关 | 7 | EmployedAt, ContractType | RegularAt, ContractEndAt等 |
| 技能与资质 | 2 | - | Skills, Certificates |
| 薪资信息 | 8 | SalaryType | BaseSalary, BankAccount等 |
| 状态 | 3 | Status | LeftAt, LeftReason |
| 其他 | 1 | - | Remark |
| 系统字段 | 5 | IsDeleted, CreatedAt, UpdatedAt | CreatedBy, UpdatedBy |

**总计**：59个字段（比原来的12个字段扩展了47个）

---

## 5. 功能模块设计

### 5.1 后端服务结构

```
app/miniapp/
├── dto/
│   ├── member.go          # 员工相关DTO（新增）
│   └── wechat.go          # 微信相关DTO（已有）
├── endpoint/
│   ├── member.go          # 员工API端点（新增）
│   └── wechat.go          # 微信API端点（已有）
├── services/
│   ├── member_service.go  # 员工服务（新增）
│   └── wechat.go          # 微信服务（已有）
└── transport/
    ├── member.go          # 员工HTTP路由（新增）
    └── wechat.go          # 微信HTTP路由（已有）

internal/repository/
├── tenant_member.go       # 员工Repository（扩展）
└── wechat_user.go         # 微信用户Repository（已有）
```

### 5.2 核心功能列表

#### 5.2.1 员工端（小程序）

**个人档案管理**：
- ✅ 查看完整个人档案
- ✅ 编辑基本信息（姓名、性别、生日、民族、学历等）
- ✅ 编辑联系信息（手机、地址、紧急联系人）
- ✅ 上传/更换头像和证件照
- ✅ 查看工作信息（工号、部门、岗位、入职时间等，只读）
- ✅ 查看技能和证书（只读，由管理员维护）
- ✅ 查看薪资类型（计时/计件，隐藏具体金额）

**数据权限**：
- 员工只能查看和编辑自己的档案
- 敏感字段脱敏显示（身份证、银行卡）
- 部分字段只读（工号、部门、薪资等）

#### 5.2.2 管理端（PC后台 - 可后续扩展）

**员工管理**：
- ⬜ 员工列表查询（支持按部门、岗位、状态筛选）
- ⬜ 员工详情查看
- ⬜ 添加新员工
- ⬜ 编辑员工档案（所有字段）
- ⬜ 员工离职处理
- ⬜ 批量导入员工（Excel）
- ⬜ 导出员工花名册（Excel）

**技能管理**：
- ⬜ 为员工分配技能和等级
- ⬜ 关联员工可操作的工序
- ⬜ 技能统计报表

**合同管理**：
- ⬜ 合同到期提醒
- ⬜ 试用期员工列表
- ⬜ 转正提醒

**统计报表**：
- ⬜ 员工年龄分布
- ⬜ 员工学历分布
- ⬜ 员工工龄分布
- ⬜ 部门人员统计
- ⬜ 技能分布统计

---

## 6. API接口设计

### 6.1 员工自助服务 API（小程序）

#### 6.1.1 获取个人档案

```http
GET /miniapp/member/profile
Authorization: Bearer {JWT_TOKEN}
```

**Response**:
```json
{
  "code": 200,
  "data": {
    "id": "member_id_xxx",
    "union_id": "union_id_xxx",
    "user_id": "user_id_xxx",
    
    // 个人基本信息
    "name": "张三",
    "name_pinyin": "zhangsan",
    "gender": 1,
    "id_card_type": "idcard",
    "id_card_no": "430***********1234",  // 脱敏
    "birthday": 946656000,
    "age": 28,
    "nation": "汉族",
    "native_place": "湖南长沙",
    "marital_status": "married",
    "political": "masses",
    "education": "college",
    "avatar": "https://cdn.example.com/avatar.jpg",
    "photo": "https://cdn.example.com/photo.jpg",
    
    // 联系信息
    "phone": "13800138000",
    "email": "zhangsan@example.com",
    "address": "广东省深圳市南山区...",
    "emergency_contact": "李四",
    "emergency_phone": "13900139000",
    "emergency_relation": "配偶",
    
    // 企业信息
    "job_number": "GY001",
    "department": "生产部",
    "department_id": "dept_xxx",
    "position": "缝纫工",
    "position_id": "pos_xxx",
    "workshop": "一车间",
    "team": "A组",
    "team_leader": "王五",
    
    // 角色权限
    "role": ["employee"],
    "permissions": [],
    
    // 工作相关
    "employed_at": 1577808000,  // 2020-01-01
    "regular_at": 1585641600,   // 2020-04-01
    "contract_type": "fulltime",
    "contract_start_at": 1577808000,
    "contract_end_at": 1735660800,  // 2025-01-01
    "work_years": 5,
    "work_months": 3,
    
    // 技能（只读）
    "skills": [
      {
        "name": "缝纫",
        "level": "advanced",
        "process_ids": ["proc_001", "proc_002"],
        "obtained_at": 1609430400,
        "remark": "熟练掌握各类缝纫技术"
      }
    ],
    
    // 证书（只读）
    "certificates": [
      {
        "name": "职业技能等级证书",
        "no": "CERT123456",
        "issue_org": "人力资源和社会保障部",
        "issued_at": 1609430400,
        "expired_at": 0,  // 长期有效
        "file_url": "https://cdn.example.com/cert.pdf"
      }
    ],
    
    // 薪资信息（部分隐藏）
    "salary_type": "piece",  // 计件
    // base_salary, bank_account 等敏感信息不返回
    
    // 状态
    "status": "active",
    "remark": "",
    
    // 系统字段
    "created_at": 1577808000,
    "updated_at": 1698768000
  }
}
```

#### 6.1.2 更新基本信息

```http
PUT /miniapp/member/profile/basic
Authorization: Bearer {JWT_TOKEN}
Content-Type: application/json
```

**Request**:
```json
{
  "name": "张三",
  "gender": 1,
  "id_card_no": "430121199501011234",  // 可选，首次填写后不可修改
  "birthday": 946656000,
  "nation": "汉族",
  "native_place": "湖南长沙",
  "marital_status": "married",
  "political": "masses",
  "education": "college"
}
```

**可编辑字段限制**：
- ✅ 允许编辑：姓名、性别、生日、民族、籍贯、婚姻状况、政治面貌、学历
- ❌ 不允许编辑：工号、部门、岗位、角色、薪资等（只能由管理员修改）
- ⚠️ 特殊：身份证号首次填写后不可修改（需管理员审核修改）

#### 6.1.3 更新联系信息

```http
PUT /miniapp/member/profile/contact
Authorization: Bearer {JWT_TOKEN}
Content-Type: application/json
```

**Request**:
```json
{
  "phone": "13800138000",
  "email": "zhangsan@example.com",
  "address": "广东省深圳市南山区...",
  "emergency_contact": "李四",
  "emergency_phone": "13900139000",
  "emergency_relation": "配偶"
}
```

#### 6.1.4 上传证件照

```http
POST /miniapp/member/profile/photo
Authorization: Bearer {JWT_TOKEN}
Content-Type: multipart/form-data
```

**Request**:
```
file: 图片文件（支持jpg、png，最大5MB）
type: avatar | photo  // avatar-头像 photo-证件照
```

**Response**:
```json
{
  "code": 200,
  "data": {
    "url": "https://cdn.example.com/photos/xxx.jpg"
  }
}
```

### 6.2 管理端 API（PC后台 - 可后续扩展）

#### 6.2.1 员工列表（分页、筛选、搜索）

```http
GET /admin/members?page=1&size=20&department=生产部&status=active&keyword=张三
Authorization: Bearer {ADMIN_JWT_TOKEN}
```

**Query参数**:
- `page`: 页码（默认1）
- `size`: 每页数量（默认20）
- `department`: 部门筛选
- `workshop`: 车间筛选
- `position`: 岗位筛选
- `status`: 状态筛选（active/probation/inactive）
- `keyword`: 关键词搜索（姓名、工号、手机号）

**Response**:
```json
{
  "code": 200,
  "data": {
    "list": [
      {
        "id": "member_id_xxx",
        "name": "张三",
        "job_number": "GY001",
        "department": "生产部",
        "position": "缝纫工",
        "phone": "13800138000",
        "status": "active",
        "employed_at": 1577808000
      }
    ],
    "total": 100,
    "page": 1,
    "size": 20
  }
}
```

#### 6.2.2 创建员工

```http
POST /admin/members
Authorization: Bearer {ADMIN_JWT_TOKEN}
Content-Type: application/json
```

**Request**:
```json
{
  "name": "张三",
  "gender": 1,
  "phone": "13800138000",
  "job_number": "GY001",
  "department": "生产部",
  "position": "缝纫工",
  "employed_at": 1577808000,
  "contract_type": "fulltime",
  "salary_type": "piece",
  // ...其他字段
}
```

#### 6.2.3 员工离职

```http
POST /admin/members/:id/resign
Authorization: Bearer {ADMIN_JWT_TOKEN}
Content-Type: application/json
```

**Request**:
```json
{
  "left_at": 1698768000,
  "left_reason": "个人原因"
}
```

#### 6.2.4 批量导入员工

```http
POST /admin/members/import
Authorization: Bearer {ADMIN_JWT_TOKEN}
Content-Type: multipart/form-data
```

**Request**:
```
file: Excel文件（xlsx）
```

**Excel格式**:
| 姓名 | 性别 | 手机号 | 工号 | 部门 | 岗位 | 入职日期 |
|------|------|--------|------|------|------|----------|
| 张三 | 男   | 138... | GY001| 生产部| 缝纫工| 2020-01-01|

#### 6.2.5 导出员工花名册

```http
GET /admin/members/export?department=生产部&status=active
Authorization: Bearer {ADMIN_JWT_TOKEN}
```

**Response**: Excel文件下载

---

## 7. 小程序UI设计

### 7.1 页面结构

```
wxApp/src/pages/member/
├── profile/
│   └── profile.vue        # 个人档案（查看）
├── edit-profile/
│   └── edit-profile.vue   # 编辑基本信息（扩展现有页面）
├── edit-contact/
│   └── edit-contact.vue   # 编辑联系信息（新增）
├── work-info/
│   └── work-info.vue      # 工作信息（查看，只读）
└── skills/
    └── skills.vue         # 技能证书（查看，只读）
```

### 7.2 个人档案页面 (profile.vue)

```
┌─────────────────────────────────────┐
│          个人档案                   │
├─────────────────────────────────────┤
│                                     │
│       [头像]    [证件照]           │
│                                     │
│       张三                          │
│       生产部 · 缝纫工               │
│       工号：GY001                   │
│                                     │
├─────────────────────────────────────┤
│  📋 基本信息              [编辑]    │
│  ┌─────────────────────────────┐   │
│  │ 姓名     张三                │   │
│  │ 性别     男                  │   │
│  │ 身份证   430***********1234  │   │
│  │ 生日     1995-01-01          │   │
│  │ 民族     汉族                │   │
│  │ 籍贯     湖南长沙            │   │
│  │ 婚姻     已婚                │   │
│  │ 学历     大专                │   │
│  └─────────────────────────────┘   │
├─────────────────────────────────────┤
│  📞 联系信息              [编辑]    │
│  ┌─────────────────────────────┐   │
│  │ 手机     13800138000         │   │
│  │ 邮箱     zhangsan@...        │   │
│  │ 住址     广东省深圳市...     │   │
│  │ 紧急联系人 李四              │   │
│  │ 紧急电话  13900139000        │   │
│  │ 关系     配偶                │   │
│  └─────────────────────────────┘   │
├─────────────────────────────────────┤
│  💼 工作信息              [查看]    │
│  ┌─────────────────────────────┐   │
│  │ 工号     GY001               │   │
│  │ 部门     生产部              │   │
│  │ 岗位     缝纫工              │   │
│  │ 车间     一车间              │   │
│  │ 班组     A组                 │   │
│  │ 入职日期  2020-01-01         │   │
│  │ 工龄     5年3个月            │   │
│  │ 合同类型  全职               │   │
│  │ 合同期限  2020-01 至 2025-01 │   │
│  └─────────────────────────────┘   │
├─────────────────────────────────────┤
│  ⭐ 技能证书              [查看]    │
│  ┌─────────────────────────────┐   │
│  │ 缝纫 - 高级              ✓   │   │
│  │ 可操作2个工序                │   │
│  │                              │   │
│  │ 职业技能等级证书          📄│   │
│  │ 编号：CERT123456             │   │
│  └─────────────────────────────┘   │
├─────────────────────────────────────┤
│  💰 薪资信息                        │
│  ┌─────────────────────────────┐   │
│  │ 薪资类型  计件               │   │
│  │ (具体金额请联系人事部门)     │   │
│  └─────────────────────────────┘   │
└─────────────────────────────────────┘
```

### 7.3 编辑基本信息页面 (edit-profile.vue)

**扩展现有页面，添加更多字段**：

```
┌─────────────────────────────────────┐
│          编辑基本信息               │
├─────────────────────────────────────┤
│                                     │
│  [头像]          [证件照]          │
│  点击更换         点击上传          │
│                                     │
├─────────────────────────────────────┤
│  姓名         [张三____________]    │
│  性别         ⚪男  ⚪女             │
│  身份证号     [430121...____]      │
│               (首次填写后不可修改)  │
│  出生日期     [选择日期______]     │
│  民族         [汉族▼_______]       │
│  籍贯         [湖南长沙______]     │
│  婚姻状况     [已婚▼_______]       │
│  政治面貌     [群众▼_______]       │
│  学历         [大专▼_______]       │
├─────────────────────────────────────┤
│              [保存]                 │
└─────────────────────────────────────┘
```

### 7.4 编辑联系信息页面 (edit-contact.vue)

```
┌─────────────────────────────────────┐
│          编辑联系信息               │
├─────────────────────────────────────┤
│  手机号       [13800138000____]    │
│  邮箱         [zhangsan@...___]    │
│  家庭住址     [________________]   │
│               [________________]   │
│                                     │
│  ───── 紧急联系人 ─────             │
│  姓名         [李四__________]     │
│  电话         [13900139000____]    │
│  关系         [配偶▼________]      │
├─────────────────────────────────────┤
│              [保存]                 │
└─────────────────────────────────────┘
```

### 7.5 工作信息页面 (work-info.vue)

**只读展示，不可编辑**：

```
┌─────────────────────────────────────┐
│          工作信息                   │
├─────────────────────────────────────┤
│  工号         GY001                 │
│  部门         生产部                │
│  岗位         缝纫工                │
│  车间         一车间                │
│  班组         A组                   │
│  班组长       王五                  │
├─────────────────────────────────────┤
│  入职日期     2020-01-01            │
│  转正日期     2020-04-01            │
│  工龄         5年3个月              │
├─────────────────────────────────────┤
│  合同类型     全职                  │
│  合同期限     2020-01-01            │
│               至                     │
│               2025-01-01            │
├─────────────────────────────────────┤
│  ⚠️ 以上信息如有错误，              │
│     请联系人事部门修改              │
└─────────────────────────────────────┘
```

### 7.6 技能证书页面 (skills.vue)

```
┌─────────────────────────────────────┐
│          技能证书                   │
├─────────────────────────────────────┤
│  ───── 技能列表 ─────               │
│  ┌─────────────────────────────┐   │
│  │ 缝纫              高级   ✓  │   │
│  │ 获得时间：2021-01-01        │   │
│  │ 可操作工序：                 │   │
│  │ • 平缝                       │   │
│  │ • 锁边                       │   │
│  └─────────────────────────────┘   │
│  ┌─────────────────────────────┐   │
│  │ 整烫              中级   ✓  │   │
│  │ 获得时间：2022-06-01        │   │
│  │ 可操作工序：                 │   │
│  │ • 熨烫                       │   │
│  └─────────────────────────────┘   │
├─────────────────────────────────────┤
│  ───── 证书列表 ─────               │
│  ┌─────────────────────────────┐   │
│  │ 📄 职业技能等级证书          │   │
│  │ 编号：CERT123456             │   │
│  │ 发证机关：人社部             │   │
│  │ 发证日期：2021-01-01         │   │
│  │ 有效期：长期有效             │   │
│  │                   [查看证书] │   │
│  └─────────────────────────────┘   │
├─────────────────────────────────────┤
│  ⚠️ 技能和证书由管理员维护，        │
│     如有疑问请联系人事部门          │
└─────────────────────────────────────┘
```

---

## 8. 实施计划

### 8.1 总体时间表

| 阶段 | 任务 | 工作量 | 预计完成 |
|------|------|--------|----------|
| **阶段一** | 数据模型和Repository | 0.5天 | Day 1 上午 |
| **阶段二** | Service层和DTO | 1天 | Day 1-2 |
| **阶段三** | API接口（Endpoint+Transport） | 1天 | Day 2-3 |
| **阶段四** | 小程序前端（5个页面） | 2-3天 | Day 3-6 |
| **阶段五** | 数据迁移和测试 | 1天 | Day 7 |
| **总计** | | **5-7天** | |

### 8.2 阶段一：数据模型和Repository (0.5天)

#### Task 1.1: 扩展 TenantMember 模型
- ✅ 文件：`internal/models/tenant_member.go`
- ✅ 添加新字段（47个）
- ✅ 添加辅助方法（CalculateAge、MaskIDCardNo等）
- ⏱️ 预计：2小时

#### Task 1.2: 扩展 TenantMemberRepository
- ✅ 文件：`internal/repository/tenant_member.go`
- ✅ 添加查询方法（按部门、岗位、技能查询）
- ✅ 添加更新方法（分字段更新）
- ⏱️ 预计：2小时

### 8.3 阶段二：Service层和DTO (1天)

#### Task 2.1: 创建 DTO
- ✅ 文件：`app/miniapp/dto/member.go`
- ✅ GetProfileResponse - 获取档案响应
- ✅ UpdateBasicInfoRequest - 更新基本信息请求
- ✅ UpdateContactInfoRequest - 更新联系信息请求
- ⏱️ 预计：2小时

#### Task 2.2: 创建 MemberService
- ✅ 文件：`app/miniapp/services/member_service.go`
- ✅ GetProfile() - 获取个人档案
- ✅ UpdateBasicInfo() - 更新基本信息
- ✅ UpdateContactInfo() - 更新联系信息
- ✅ UploadPhoto() - 上传照片
- ✅ 字段权限控制（员工可编辑/只读）
- ⏱️ 预计：4小时

#### Task 2.3: 扩展文件上传服务
- ✅ 支持员工证件照上传
- ✅ 支持证书文件上传
- ⏱️ 预计：2小时

### 8.4 阶段三：API接口 (1天)

#### Task 3.1: 创建 Endpoint
- ✅ 文件：`app/miniapp/endpoint/member.go`
- ✅ MakeGetProfileEndpoint
- ✅ MakeUpdateBasicInfoEndpoint
- ✅ MakeUpdateContactInfoEndpoint
- ✅ MakeUploadPhotoEndpoint
- ⏱️ 预计：3小时

#### Task 3.2: 创建 HTTP Transport
- ✅ 文件：`app/miniapp/transport/member.go`
- ✅ 路由注册
- ✅ 请求/响应编解码
- ⏱️ 预计：2小时

#### Task 3.3: 集成测试
- ✅ 使用Postman测试所有API
- ✅ 验证数据存储到正确的租户库
- ⏱️ 预计：3小时

### 8.5 阶段四：小程序前端 (2-3天)

#### Task 4.1: 创建个人档案页面
- ✅ 文件：`wxApp/src/pages/member/profile/profile.vue`
- ✅ 展示完整员工信息（分区块）
- ✅ 跳转到各编辑页面
- ✅ 敏感信息脱敏显示
- ⏱️ 预计：4小时

#### Task 4.2: 扩展编辑基本信息页面
- ✅ 文件：`wxApp/src/pages/member/edit-profile/edit-profile.vue`（扩展现有）
- ✅ 添加身份证、生日、民族等字段
- ✅ 日期选择器、下拉选择器
- ✅ 表单验证
- ⏱️ 预计：4小时

#### Task 4.3: 创建编辑联系信息页面
- ✅ 文件：`wxApp/src/pages/member/edit-contact/edit-contact.vue`
- ✅ 编辑手机、邮箱、地址
- ✅ 编辑紧急联系人
- ⏱️ 预计：3小时

#### Task 4.4: 创建工作信息页面
- ✅ 文件：`wxApp/src/pages/member/work-info/work-info.vue`
- ✅ 只读展示工作信息
- ✅ 显示工龄计算
- ⏱️ 预计：2小时

#### Task 4.5: 创建技能证书页面
- ✅ 文件：`wxApp/src/pages/member/skills/skills.vue`
- ✅ 展示技能列表（技能名、等级、可操作工序）
- ✅ 展示证书列表（证书名、编号、有效期）
- ✅ 查看证书扫描件
- ⏱️ 预计：3小时

#### Task 4.6: 照片上传功能
- ✅ 头像上传（拍照/相册）
- ✅ 证件照上传（拍照/相册）
- ✅ 图片裁剪和压缩
- ⏱️ 预计：3小时

#### Task 4.7: 路由配置和导航
- ✅ 配置页面路由
- ✅ 从"我的"页面入口
- ⏱️ 预计：1小时

### 8.6 阶段五：数据迁移和测试 (1天)

#### Task 5.1: 数据迁移脚本
- ✅ 为现有 member 记录填充默认值
- ✅ 数据验证
- ⏱️ 预计：2小时

#### Task 5.2: 功能测试
- ✅ 查看档案
- ✅ 编辑基本信息
- ✅ 编辑联系信息
- ✅ 上传照片
- ✅ 查看工作信息
- ✅ 查看技能证书
- ⏱️ 预计：3小时

#### Task 5.3: 兼容性测试
- ✅ 多租户数据隔离测试
- ✅ 字段权限测试
- ✅ 数据脱敏测试
- ⏱️ 预计：2小时

---

## 9. 数据迁移方案

### 9.1 迁移策略

**现有数据**：
- 租户库中已有 `member` 集合
- 只有基础字段（name, job_number, department, position等）

**迁移目标**：
- 保留现有数据
- 为新字段填充默认值
- 不影响现有功能

### 9.2 迁移脚本

**文件**：`scripts/migrate_member_fields.js`

```javascript
// MongoDB Shell 迁移脚本
// 用法：切换到租户数据库后运行
// use tenant_ace
// load('scripts/migrate_member_fields.js')

print("=== 开始迁移 member 集合 ===");

// 获取当前数据库名
const dbName = db.getName();
print(`当前数据库: ${dbName}`);

// 统计现有记录数
const totalCount = db.member.countDocuments({ is_deleted: 0 });
print(`找到 ${totalCount} 条员工记录`);

// 批量更新：为新字段设置默认值
const result = db.member.updateMany(
    { is_deleted: 0 },
    {
        $set: {
            // 个人基本信息
            name_pinyin: "",
            id_card_type: "idcard",
            id_card_no: "",
            birthday: 0,
            age: 0,
            nation: "汉族",
            native_place: "",
            marital_status: "single",
            political: "masses",
            education: "",
            photo: "",
            
            // 联系信息
            email: "",
            address: "",
            emergency_contact: "",
            emergency_phone: "",
            emergency_relation: "",
            
            // 企业信息扩展
            department_id: "",
            position_id: "",
            workshop: "",
            workshop_id: "",
            team: "",
            team_id: "",
            team_leader: "",
            
            // 工作相关
            regular_at: 0,
            contract_type: "fulltime",  // 默认全职
            contract_start_at: 0,
            contract_end_at: 0,
            work_years: 0,
            work_months: 0,
            
            // 技能与资质
            skills: [],
            certificates: [],
            
            // 薪资信息
            salary_type: "piece",  // 服装厂默认计件
            base_salary: 0,
            hourly_rate: 0,
            piece_rate: 0,
            bank_name: "",
            bank_account: "",
            bank_account_name: "",
            
            // 备注
            remark: ""
        }
    }
);

print(`✅ 更新完成: ${result.modifiedCount} 条记录`);

// 创建新索引
print("\n=== 创建索引 ===");

db.member.createIndex({ "job_number": 1 }, { unique: true, sparse: true });
print("✅ job_number 索引");

db.member.createIndex({ "phone": 1 });
print("✅ phone 索引");

db.member.createIndex({ "id_card_no": 1 }, { unique: true, sparse: true });
print("✅ id_card_no 索引");

db.member.createIndex({ "department": 1, "status": 1 });
print("✅ department+status 复合索引");

db.member.createIndex({ "skills.process_ids": 1 });
print("✅ skills.process_ids 索引");

print("\n=== 迁移完成 ===");
print("请在小程序测试以下功能：");
print("1. 查看个人档案");
print("2. 编辑基本信息");
print("3. 编辑联系信息");
```

### 9.3 迁移步骤

1. **备份数据**：
   ```bash
   mongodump --uri="mongodb://localhost:27015/tenant_ace" --out=backup_$(date +%Y%m%d)
   ```

2. **运行迁移脚本**：
   ```bash
   mongo --host localhost --port 27015 \
         --username root --password xxx \
         tenant_ace \
         scripts/migrate_member_fields.js
   ```

3. **验证数据**：
   ```javascript
   // 查看一条记录，验证新字段
   db.member.findOne({ is_deleted: 0 })
   ```

4. **对所有租户库执行**：
   ```bash
   # 列出所有租户数据库
   mongo --eval "db.adminCommand('listDatabases').databases.forEach(d => { if(d.name.startsWith('tenant_')) print(d.name) })"
   
   # 对每个租户库执行迁移
   for db in tenant_ace tenant_factory2; do
       mongo $db scripts/migrate_member_fields.js
   done
   ```

### 9.4 回滚方案

如果迁移出现问题：

```bash
# 恢复备份
mongorestore --uri="mongodb://localhost:27015/tenant_ace" backup_20241019/tenant_ace
```

---

## 10. 安全与权限

### 10.1 数据脱敏

**敏感字段脱敏规则**：

```go
// MaskIDCardNo 脱敏身份证号
// 430121199501011234 → 430***********1234
func MaskIDCardNo(idCardNo string) string {
    if len(idCardNo) < 8 {
        return idCardNo
    }
    return idCardNo[:3] + "***********" + idCardNo[len(idCardNo)-4:]
}

// MaskBankAccount 脱敏银行卡号
// 6222021234567890 → 6222 **** **** 7890
func MaskBankAccount(bankAccount string) string {
    if len(bankAccount) < 8 {
        return bankAccount
    }
    return bankAccount[:4] + " **** **** " + bankAccount[len(bankAccount)-4:]
}
```

**前端展示**：
- 身份证号：`430***********1234`
- 银行卡号：`6222 **** **** 7890`
- 员工查看自己：显示脱敏
- 管理员查看：显示完整（权限控制）

### 10.2 字段权限控制

**员工可编辑字段**（小程序）：
```go
var EmployeeEditableFields = []string{
    "name", "gender", "birthday", "nation", "native_place",
    "marital_status", "political", "education", "avatar", "photo",
    "phone", "email", "address",
    "emergency_contact", "emergency_phone", "emergency_relation",
}
```

**员工只读字段**（只能管理员修改）：
- 工号、部门、岗位、车间、班组
- 角色、权限
- 入职日期、转正日期、合同信息
- 技能、证书
- 薪资信息

**Service层权限检查**：
```go
func (s *MemberService) UpdateBasicInfo(ctx context.Context, userID string, req dto.UpdateBasicInfoRequest) error {
    // 1. 获取当前用户
    member, err := s.repo.GetByUserID(ctx, userID)
    if err != nil {
        return err
    }
    
    // 2. 构建更新字段（只允许员工可编辑字段）
    updateData := map[string]interface{}{
        "updated_at": time.Now().Unix(),
    }
    
    // 3. 只更新允许的字段
    if req.Name != "" {
        updateData["name"] = req.Name
    }
    if req.Gender != 0 {
        updateData["gender"] = req.Gender
    }
    // ... 其他可编辑字段
    
    // 4. 特殊字段：身份证号首次填写后不可修改
    if req.IDCardNo != "" && member.IDCardNo == "" {
        updateData["id_card_no"] = req.IDCardNo
    } else if req.IDCardNo != "" && member.IDCardNo != "" {
        return errors.New("身份证号已填写，如需修改请联系管理员")
    }
    
    // 5. 自动计算年龄
    if req.Birthday != 0 {
        updateData["birthday"] = req.Birthday
        updateData["age"] = calculateAge(req.Birthday)
    }
    
    return s.repo.Update(ctx, member.ID, updateData)
}
```

### 10.3 数据加密

**敏感字段加密存储**：

```go
import "crypto/aes"

// EncryptIDCardNo 加密身份证号
func EncryptIDCardNo(idCardNo string, key []byte) (string, error) {
    // 使用AES加密
    block, err := aes.NewCipher(key)
    if err != nil {
        return "", err
    }
    // ... 加密逻辑
    return encryptedText, nil
}

// DecryptIDCardNo 解密身份证号
func DecryptIDCardNo(encryptedText string, key []byte) (string, error) {
    // ... 解密逻辑
    return idCardNo, nil
}
```

**配置加密密钥**：
```yaml
# config/miniapp.yaml
security:
  encryption_key: "your-32-byte-encryption-key-here"  # 32字节密钥（AES-256）
```

### 10.4 审计日志

**记录敏感操作**：
- 查看员工身份证号（完整）
- 修改薪资信息
- 查看银行卡号（完整）
- 修改员工状态（离职等）

```go
type AuditLog struct {
    UserID    string `json:"user_id"`
    Action    string `json:"action"`      // view_idcard, update_salary等
    TargetID  string `json:"target_id"`   // 被操作的员工ID
    IPAddress string `json:"ip_address"`
    CreatedAt int64  `json:"created_at"`
}
```

---

## 11. 扩展功能（未来）

### 11.1 统计报表

- **年龄分布**：按年龄段统计员工数量
- **学历分布**：按学历统计员工数量
- **工龄分布**：按工龄统计员工数量
- **部门人员统计**：各部门在职人数
- **技能分布**：各技能掌握人数
- **合同到期提醒**：即将到期的合同列表

### 11.2 生日提醒

- 当天生日员工列表
- 本月生日员工列表
- 生日祝福消息推送（小程序）

### 11.3 合同管理

- 合同到期提醒（提前30天）
- 试用期到期提醒（提前7天）
- 自动转正提醒
- 合同续签管理

### 11.4 员工绩效

- 绩效考核记录
- 奖惩记录
- 晋升记录
- 培训记录

### 11.5 电子工资条

- 月度工资条生成
- 工资条推送（小程序消息）
- 历史工资条查询
- 工资统计分析

---

## 12. 总结

### 12.1 核心特点

1. ✅ **完整的员工档案**：59个字段，覆盖服装生产MES所需的所有信息
2. ✅ **数据物理隔离**：基于租户code的数据库隔离，安全可靠
3. ✅ **灵活的权限控制**：员工可编辑/只读字段清晰区分
4. ✅ **敏感信息保护**：身份证、银行卡脱敏和加密存储
5. ✅ **服装行业特色**：技能、工序、计件单价等服装生产特有字段
6. ✅ **员工自助服务**：小程序端查看和编辑个人档案
7. ✅ **良好的扩展性**：支持后续添加管理后台、统计报表等功能

### 12.2 技术亮点

- **MongoDB灵活文档结构**：支持技能、证书等数组字段
- **租户数据库隔离**：`tenant_{code}` 命名规范，物理隔离
- **Context传递租户信息**：自动切换数据库，代码简洁
- **字段权限控制**：Service层控制可编辑字段
- **数据脱敏和加密**：保护敏感信息
- **前后端分离**：接口清晰，易于扩展

### 12.3 实施收益

| 维度 | 改造前 | 改造后 | 提升 |
|------|--------|--------|------|
| 员工档案完整性 | 12个基础字段 | 59个完整字段 | ⭐⭐⭐⭐⭐ |
| 服装行业适配 | 无行业特色 | 技能、工序、计件 | ⭐⭐⭐⭐⭐ |
| 员工自助服务 | 基础编辑 | 完整档案管理 | ⭐⭐⭐⭐ |
| 数据安全性 | 基础 | 脱敏+加密+审计 | ⭐⭐⭐⭐⭐ |
| 可扩展性 | 一般 | 支持多种扩展 | ⭐⭐⭐⭐ |

### 12.4 后续计划

**短期（1-2周）**：
- ✅ 完成阶段一至五（后端API + 小程序前端）
- ✅ 数据迁移和测试
- ✅ 上线试运行

**中期（1-2个月）**：
- ⬜ PC管理后台（员工管理、统计报表）
- ⬜ 批量导入/导出功能
- ⬜ 合同到期提醒
- ⬜ 生日提醒

**长期（3-6个月）**：
- ⬜ 员工绩效管理
- ⬜ 电子工资条
- ⬜ 培训记录管理
- ⬜ 技能成长轨迹

---

**文档版本**：v1.0  
**创建日期**：2025-10-19  
**作者**：Mule-Cloud 开发团队  
**状态**：待实施

---

## 附录

### 附录A：字段对照表（中英文）

| 中文 | 英文 | 类型 | 说明 |
|------|------|------|------|
| 姓名拼音 | name_pinyin | string | 用于排序 |
| 证件类型 | id_card_type | string | idcard/passport |
| 身份证号 | id_card_no | string | 加密存储 |
| 出生日期 | birthday | int64 | Unix时间戳 |
| 年龄 | age | int | 自动计算 |
| 民族 | nation | string | 如：汉族 |
| 籍贯 | native_place | string | 如：广东深圳 |
| 婚姻状况 | marital_status | string | single/married/divorced |
| 政治面貌 | political | string | party/league/masses |
| 学历 | education | string | primary/middle/high/college/bachelor/master/doctor |
| 证件照 | photo | string | URL |
| 紧急联系人 | emergency_contact | string | 姓名 |
| 紧急电话 | emergency_phone | string | 手机号 |
| 紧急联系人关系 | emergency_relation | string | 如：父亲、配偶 |
| 车间 | workshop | string | 如：一车间 |
| 班组 | team | string | 如：A组 |
| 班组长 | team_leader | string | 姓名 |
| 转正日期 | regular_at | int64 | Unix时间戳 |
| 合同类型 | contract_type | string | fulltime/parttime/intern/dispatch |
| 合同开始日期 | contract_start_at | int64 | Unix时间戳 |
| 合同结束日期 | contract_end_at | int64 | Unix时间戳（0=无固定期限） |
| 工龄（年） | work_years | int | 自动计算 |
| 工龄（月） | work_months | int | 自动计算 |
| 薪资类型 | salary_type | string | hourly/piece/monthly/mixed |
| 基本工资 | base_salary | float64 | 元/月 |
| 时薪 | hourly_rate | float64 | 元/小时 |
| 计件单价 | piece_rate | float64 | 元/件 |
| 开户行 | bank_name | string | 银行名称 |
| 银行卡号 | bank_account | string | 加密存储 |
| 开户名 | bank_account_name | string | 姓名 |
| 离职日期 | left_at | int64 | Unix时间戳 |
| 离职原因 | left_reason | string | 文本 |

### 附录B：枚举值定义

```go
// 性别
const (
    GenderUnknown = 0  // 未知
    GenderMale    = 1  // 男
    GenderFemale  = 2  // 女
)

// 证件类型
const (
    IDCardTypeIDCard   = "idcard"   // 身份证
    IDCardTypePassport = "passport" // 护照
)

// 婚姻状况
const (
    MaritalStatusSingle   = "single"   // 未婚
    MaritalStatusMarried  = "married"  // 已婚
    MaritalStatusDivorced = "divorced" // 离异
)

// 政治面貌
const (
    PoliticalParty  = "party"  // 党员
    PoliticalLeague = "league" // 团员
    PoliticalMasses = "masses" // 群众
)

// 学历
const (
    EducationPrimary  = "primary"  // 小学
    EducationMiddle   = "middle"   // 初中
    EducationHigh     = "high"     // 高中
    EducationCollege  = "college"  // 大专
    EducationBachelor = "bachelor" // 本科
    EducationMaster   = "master"   // 硕士
    EducationDoctor   = "doctor"   // 博士
)

// 合同类型
const (
    ContractTypeFullTime = "fulltime"  // 全职
    ContractTypePartTime = "parttime"  // 兼职
    ContractTypeIntern   = "intern"    // 实习
    ContractTypeDispatch = "dispatch"  // 劳务派遣
)

// 薪资类型
const (
    SalaryTypeHourly  = "hourly"  // 计时
    SalaryTypePiece   = "piece"   // 计件
    SalaryTypeMonthly = "monthly" // 月薪
    SalaryTypeMixed   = "mixed"   // 混合
)

// 员工状态
const (
    MemberStatusActive    = "active"    // 在职
    MemberStatusProbation = "probation" // 试用期
    MemberStatusInactive  = "inactive"  // 离职
    MemberStatusSuspended = "suspended" // 停职
)

// 技能等级
const (
    SkillLevelBeginner     = "beginner"     // 初级
    SkillLevelIntermediate = "intermediate" // 中级
    SkillLevelAdvanced     = "advanced"     // 高级
    SkillLevelExpert       = "expert"       // 专家
)
```

### 附录C：常用技能列表（服装行业）

```go
var CommonSkills = []string{
    "缝纫",      // 平缝、锁边、包缝等
    "裁剪",      // 手工裁剪、电裁等
    "整烫",      // 熨烫、定型等
    "包装",      // 折叠、装袋、打包等
    "质检",      // 成品检验、过程检验等
    "打样",      // 样衣制作
    "拉布",      // 铺布
    "绣花",      // 电脑绣花
    "印花",      // 丝网印花、数码印花等
    "钉扣",      // 钉纽扣、钉标等
    "车间管理",  // 生产管理
    "工艺设计",  // 工艺流程设计
}
```

