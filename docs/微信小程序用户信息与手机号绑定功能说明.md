# å¾®ä¿¡å°ç¨‹åºç”¨æˆ·ä¿¡æ¯ä¸æ‰‹æœºå·ç»‘å®šåŠŸèƒ½è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

å·²å®Œæˆå¾®ä¿¡å°ç¨‹åºçš„ç”¨æˆ·ä¿¡æ¯è·å–å’Œæ‰‹æœºå·ç»‘å®š/è§£ç»‘åŠŸèƒ½ï¼Œå®ç°äº†ï¼š

1. âœ… **ç™»å½•æ—¶è·å–ç”¨æˆ·æ˜µç§°å’Œå¤´åƒ** - ä»å¾®ä¿¡è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
2. âœ… **æ‰‹æœºå·ç»‘å®š** - ä½¿ç”¨å¾®ä¿¡ `getPhoneNumber` API
3. âœ… **æ‰‹æœºå·è§£ç»‘** - å…è®¸ç”¨æˆ·è§£é™¤æ‰‹æœºå·ç»‘å®š
4. âœ… **ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤ºä¿®å¤** - æ­£ç¡®æ˜¾ç¤ºç™»å½•ç”¨æˆ·çš„æ˜µç§°å’Œå¤´åƒ

## åç«¯å®ç°

### 1. å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯è·å–

åœ¨ `app/miniapp/services/wechat.go` ä¸­å®ç°äº†ç”¨æˆ·ä¿¡æ¯è§£æï¼š

```go
// ç™»å½•æ—¶è§£æç”¨æˆ·ä¿¡æ¯ï¼ˆå¦‚æœå‰ç«¯ä¼ äº†ï¼‰
var wechatUserInfoData *WechatUserInfoData
if req.EncryptedData != "" && req.IV != "" {
    wechatUserInfoData, err = s.decryptUserInfo(wxSession.SessionKey, req.EncryptedData, req.IV)
    if err != nil {
        logger.Warn("è§£å¯†ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨åŸºæœ¬ä¿¡æ¯", zap.Error(err))
    }
}

// ä¿å­˜/æ›´æ–°ç”¨æˆ·æ˜µç§°å’Œå¤´åƒ
if wechatUserInfoData != nil {
    wechatUser.Nickname = wechatUserInfoData.NickName
    wechatUser.Avatar = wechatUserInfoData.AvatarUrl
    wechatUser.Gender = wechatUserInfoData.Gender
    wechatUser.Country = wechatUserInfoData.Country
    wechatUser.Province = wechatUserInfoData.Province
    wechatUser.City = wechatUserInfoData.City
}
```

### 2. æ‰‹æœºå·ç»‘å®š API

**æ¥å£**: `POST /api/miniapp/wechat/phone`ï¼ˆéœ€è¦è®¤è¯ï¼‰

**åŠŸèƒ½**: è°ƒç”¨å¾®ä¿¡ `getPhoneNumber` API è·å–ç”¨æˆ·æ‰‹æœºå·å¹¶ä¿å­˜

```go
func (s *WechatService) GetPhoneNumber(userID string, code string) (*dto.GetPhoneNumberResponse, error) {
    // 1. è·å– access_token
    accessToken, err := s.getAccessToken()
    
    // 2. è°ƒç”¨å¾®ä¿¡æ¥å£è·å–æ‰‹æœºå·
    url := fmt.Sprintf("https://api.weixin.qq.com/wxa/business/getuserphonenumber?access_token=%s", accessToken)
    
    // 3. æ›´æ–°ç”¨æˆ·æ‰‹æœºå·åˆ°æ•°æ®åº“
    err = s.wechatUserRepo.Update(systemCtx, userID, map[string]interface{}{
        "phone": phoneInfo.PhoneInfo.PhoneNumber,
    })
    
    return &dto.GetPhoneNumberResponse{
        Success:     true,
        PhoneNumber: phoneInfo.PhoneInfo.PhoneNumber,
        Message:     "ç»‘å®šæˆåŠŸ",
    }, nil
}
```

### 3. æ‰‹æœºå·è§£ç»‘ API

**æ¥å£**: `DELETE /api/miniapp/wechat/phone`ï¼ˆéœ€è¦è®¤è¯ï¼‰

**åŠŸèƒ½**: æ¸…ç©ºç”¨æˆ·æ‰‹æœºå·å­—æ®µ

```go
func (s *WechatService) UnbindPhone(userID string) error {
    err := s.wechatUserRepo.Update(systemCtx, userID, map[string]interface{}{
        "phone": "",
    })
    return nil
}
```

### 4. è·¯ç”±é…ç½®

åœ¨ `cmd/miniapp/main.go` ä¸­æ·»åŠ äº†è·¯ç”±ï¼š

```go
// éœ€è¦è®¤è¯çš„è·¯ç”±
protected := r.Group("/miniapp")
middleware.Apply(protected, jwtManager)
{
    protected.POST("/wechat/phone", transport.GetPhoneNumberHandler(wechatSvc))     // ç»‘å®šæ‰‹æœºå·
    protected.DELETE("/wechat/phone", transport.UnbindPhoneHandler(wechatSvc))      // è§£ç»‘æ‰‹æœºå·
}
```

## å‰ç«¯å®ç°

### 1. API å°è£…

åœ¨ `wxApp/src/api/auth.js` ä¸­æ·»åŠ ï¼š

```javascript
/**
 * ç»‘å®šæ‰‹æœºå·
 * @param {String} code å¾®ä¿¡è¿”å›çš„code
 */
export function bindPhone(code) {
    return post('/miniapp/wechat/phone', { code })
}

/**
 * è§£ç»‘æ‰‹æœºå·
 */
export function unbindPhone() {
    return del('/miniapp/wechat/phone')
}
```

### 2. ä¸ªäººä¸­å¿ƒé¡µé¢

åœ¨ `wxApp/src/pages/mine/mine.vue` ä¸­å®ç°ï¼š

#### ç»‘å®šæ‰‹æœºå·æŒ‰é’®

```vue
<!-- ä½¿ç”¨å¾®ä¿¡æä¾›çš„ button ç»„ä»¶è·å–æ‰‹æœºå· -->
<button 
    v-if="!userInfo?.phone"
    class="menu-item menu-button" 
    open-type="getPhoneNumber"
    @getphonenumber="handleGetPhoneNumber"
>
    <view class="menu-icon">ğŸ“±</view>
    <view class="menu-text">ç»‘å®šæ‰‹æœºå·</view>
    <view class="menu-arrow">â€º</view>
</button>
```

#### å¤„ç†æ‰‹æœºå·æˆæƒå›è°ƒ

```javascript
const handleGetPhoneNumber = async (e) => {
    if (e.detail.code) {
        try {
            uni.showLoading({ title: 'ç»‘å®šä¸­...' })
            const { bindPhone } = await import('@/api/auth')
            const res = await bindPhone(e.detail.code)
            
            if (res.success) {
                uni.showToast({ title: 'ç»‘å®šæˆåŠŸ', icon: 'success' })
                // åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
                await userStore.fetchUserInfo()
            }
        } catch (error) {
            uni.showToast({ title: error.message || 'ç»‘å®šå¤±è´¥', icon: 'none' })
        } finally {
            uni.hideLoading()
        }
    }
}
```

#### è§£ç»‘æ‰‹æœºå·

```javascript
const handleUnbindPhone = () => {
    uni.showModal({
        title: 'è§£ç»‘æ‰‹æœºå·',
        content: 'ç¡®å®šè¦è§£ç»‘æ‰‹æœºå·å—ï¼Ÿ',
        success: async (res) => {
            if (res.confirm) {
                try {
                    uni.showLoading({ title: 'è§£ç»‘ä¸­...' })
                    const { unbindPhone } = await import('@/api/auth')
                    await unbindPhone()
                    
                    uni.showToast({ title: 'è§£ç»‘æˆåŠŸ', icon: 'success' })
                    await userStore.fetchUserInfo()
                } catch (error) {
                    uni.showToast({ title: error.message || 'è§£ç»‘å¤±è´¥', icon: 'none' })
                } finally {
                    uni.hideLoading()
                }
            }
        }
    })
}
```

### 3. ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤ºä¿®å¤

åœ¨ `wxApp/src/pages/mine/mine.vue` ä¸­ï¼š

```vue
<!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
<view class="user-card">
    <view class="user-avatar">
        <image :src="userInfo?.avatar || '/static/logo.png'" mode="aspectFill"></image>
    </view>
    <view class="user-info">
        <view class="user-name">{{ userInfo?.nickname || 'å¾®ä¿¡ç”¨æˆ·' }}</view>
        <view class="user-phone" @click="handleBindPhone">
            {{ userInfo?.phone || 'ç‚¹å‡»ç»‘å®šæ‰‹æœºå·' }}
        </view>
    </view>
</view>
```

åœ¨ç»„ä»¶æŒ‚è½½æ—¶åˆ·æ–°ç”¨æˆ·ä¿¡æ¯ï¼š

```javascript
onMounted(() => {
    // åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
    if (userStore.isLoggedIn) {
        userStore.fetchUserInfo().catch(err => {
            console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥', err)
        })
    }
})
```

## ä½¿ç”¨æµç¨‹

### ç»‘å®šæ‰‹æœºå·æµç¨‹

1. ç”¨æˆ·ç™»å½•åè¿›å…¥"æˆ‘çš„"é¡µé¢
2. ç‚¹å‡»"ç»‘å®šæ‰‹æœºå·"æŒ‰é’®
3. å¾®ä¿¡å¼¹å‡ºæˆæƒå¼¹çª—
4. ç”¨æˆ·åŒæ„æˆæƒåï¼Œå¾®ä¿¡è¿”å› code
5. å‰ç«¯å°† code å‘é€åˆ°åç«¯
6. åç«¯è°ƒç”¨å¾®ä¿¡ API è·å–æ‰‹æœºå·
7. åç«¯å°†æ‰‹æœºå·ä¿å­˜åˆ°ç”¨æˆ·ä¿¡æ¯
8. å‰ç«¯åˆ·æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º

### è§£ç»‘æ‰‹æœºå·æµç¨‹

1. ç”¨æˆ·ç‚¹å‡»å·²ç»‘å®šçš„æ‰‹æœºå·
2. ç³»ç»Ÿå¼¹å‡ºç¡®è®¤å¼¹çª—
3. ç”¨æˆ·ç¡®è®¤åï¼Œå‰ç«¯è°ƒç”¨è§£ç»‘ API
4. åç«¯æ¸…ç©ºç”¨æˆ·æ‰‹æœºå·å­—æ®µ
5. å‰ç«¯åˆ·æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º

## æ•°æ®åº“å­—æ®µ

åœ¨ `internal/models/wechat_user.go` çš„ `WechatUser` æ¨¡å‹ä¸­ï¼š

```go
type WechatUser struct {
    ID       string `bson:"_id,omitempty" json:"id"`
    UnionID  string `bson:"union_id" json:"union_id"`
    OpenID   string `bson:"open_id" json:"open_id"`
    Nickname string `bson:"nickname" json:"nickname"`     // æ˜µç§°
    Avatar   string `bson:"avatar" json:"avatar"`         // å¤´åƒ
    Phone    string `bson:"phone" json:"phone"`           // æ‰‹æœºå·
    Gender   int    `bson:"gender" json:"gender"`         // æ€§åˆ«
    Country  string `bson:"country" json:"country"`       // å›½å®¶
    Province string `bson:"province" json:"province"`     // çœä»½
    City     string `bson:"city" json:"city"`             // åŸå¸‚
    // ... å…¶ä»–å­—æ®µ
}
```

## æ³¨æ„äº‹é¡¹

1. **å¾®ä¿¡å®¡æ ¸è¦æ±‚**: ä½¿ç”¨ `getPhoneNumber` éœ€è¦å°ç¨‹åºå·²é€šè¿‡å¾®ä¿¡å®¡æ ¸
2. **ç”¨æˆ·æˆæƒ**: æ‰‹æœºå·è·å–éœ€è¦ç”¨æˆ·ä¸»åŠ¨æˆæƒï¼Œä¸èƒ½å¼ºåˆ¶
3. **æ•°æ®åŠ å¯†**: å¾®ä¿¡è¿”å›çš„ç”¨æˆ·ä¿¡æ¯æ˜¯åŠ å¯†çš„ï¼ˆç›®å‰åç«¯è§£å¯†åŠŸèƒ½å¾…å®ç°ï¼‰
4. **access_token ç¼“å­˜**: ç”Ÿäº§ç¯å¢ƒå»ºè®®ç¼“å­˜ access_tokenï¼ˆæœ‰æ•ˆæœŸ 2 å°æ—¶ï¼‰
5. **é”™è¯¯å¤„ç†**: éœ€è¦å¦¥å–„å¤„ç†ç”¨æˆ·æ‹’ç»æˆæƒã€ç½‘ç»œé”™è¯¯ç­‰æƒ…å†µ

## å¾…ä¼˜åŒ–é¡¹

1. **å®ç°å¾®ä¿¡æ•°æ®è§£å¯†** - å®Œæ•´è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆæ˜µç§°ã€å¤´åƒç­‰ï¼‰
2. **access_token ç¼“å­˜** - ä½¿ç”¨ Redis ç¼“å­˜ access_token
3. **åŒæ­¥æ›´æ–°ç§Ÿæˆ·æˆå‘˜** - æ‰‹æœºå·æ›´æ–°æ—¶åŒæ­¥åˆ°å„ç§Ÿæˆ·çš„ member è¡¨
4. **ç”¨æˆ·ä¿¡æ¯è‡ªåŠ¨æ›´æ–°** - å®šæœŸæˆ–ç™»å½•æ—¶è‡ªåŠ¨æ›´æ–°ç”¨æˆ·ä¿¡æ¯

## æµ‹è¯•å»ºè®®

1. æµ‹è¯•é¦–æ¬¡ç»‘å®šæ‰‹æœºå·
2. æµ‹è¯•é‡å¤ç»‘å®šï¼ˆåº”æç¤ºå·²ç»‘å®šï¼‰
3. æµ‹è¯•è§£ç»‘åå†æ¬¡ç»‘å®š
4. æµ‹è¯•ç”¨æˆ·æ‹’ç»æˆæƒçš„æƒ…å†µ
5. æµ‹è¯•ç½‘ç»œå¼‚å¸¸æƒ…å†µ

## ç›¸å…³æ–‡æ¡£

- [å¾®ä¿¡å°ç¨‹åºå¤šç§Ÿæˆ·ç”¨æˆ·ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ](./å¾®ä¿¡å°ç¨‹åºå¤šç§Ÿæˆ·ç”¨æˆ·ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ.md)
- [å¾®ä¿¡å®˜æ–¹æ–‡æ¡£ - è·å–æ‰‹æœºå·](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/getPhoneNumber.html)
- [å¾®ä¿¡å®˜æ–¹æ–‡æ¡£ - ç”¨æˆ·ä¿¡æ¯](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/userProfile.html)

