# 微信小程序用户信息与手机号绑定功能说明

## 功能概述

已完成微信小程序的用户信息获取和手机号绑定/解绑功能，实现了：

1. ✅ **登录时获取用户昵称和头像** - 从微信获取用户基本信息
2. ✅ **手机号绑定** - 使用微信 `getPhoneNumber` API
3. ✅ **手机号解绑** - 允许用户解除手机号绑定
4. ✅ **用户信息显示修复** - 正确显示登录用户的昵称和头像

## 后端实现

### 1. 微信用户信息获取

在 `app/miniapp/services/wechat.go` 中实现了用户信息解析：

```go
// 登录时解析用户信息（如果前端传了）
var wechatUserInfoData *WechatUserInfoData
if req.EncryptedData != "" && req.IV != "" {
    wechatUserInfoData, err = s.decryptUserInfo(wxSession.SessionKey, req.EncryptedData, req.IV)
    if err != nil {
        logger.Warn("解密用户信息失败，继续使用基本信息", zap.Error(err))
    }
}

// 保存/更新用户昵称和头像
if wechatUserInfoData != nil {
    wechatUser.Nickname = wechatUserInfoData.NickName
    wechatUser.Avatar = wechatUserInfoData.AvatarUrl
    wechatUser.Gender = wechatUserInfoData.Gender
    wechatUser.Country = wechatUserInfoData.Country
    wechatUser.Province = wechatUserInfoData.Province
    wechatUser.City = wechatUserInfoData.City
}
```

### 2. 手机号绑定 API

**接口**: `POST /api/miniapp/wechat/phone`（需要认证）

**功能**: 调用微信 `getPhoneNumber` API 获取用户手机号并保存

```go
func (s *WechatService) GetPhoneNumber(userID string, code string) (*dto.GetPhoneNumberResponse, error) {
    // 1. 获取 access_token
    accessToken, err := s.getAccessToken()
    
    // 2. 调用微信接口获取手机号
    url := fmt.Sprintf("https://api.weixin.qq.com/wxa/business/getuserphonenumber?access_token=%s", accessToken)
    
    // 3. 更新用户手机号到数据库
    err = s.wechatUserRepo.Update(systemCtx, userID, map[string]interface{}{
        "phone": phoneInfo.PhoneInfo.PhoneNumber,
    })
    
    return &dto.GetPhoneNumberResponse{
        Success:     true,
        PhoneNumber: phoneInfo.PhoneInfo.PhoneNumber,
        Message:     "绑定成功",
    }, nil
}
```

### 3. 手机号解绑 API

**接口**: `DELETE /api/miniapp/wechat/phone`（需要认证）

**功能**: 清空用户手机号字段

```go
func (s *WechatService) UnbindPhone(userID string) error {
    err := s.wechatUserRepo.Update(systemCtx, userID, map[string]interface{}{
        "phone": "",
    })
    return nil
}
```

### 4. 路由配置

在 `cmd/miniapp/main.go` 中添加了路由：

```go
// 需要认证的路由
protected := r.Group("/miniapp")
middleware.Apply(protected, jwtManager)
{
    protected.POST("/wechat/phone", transport.GetPhoneNumberHandler(wechatSvc))     // 绑定手机号
    protected.DELETE("/wechat/phone", transport.UnbindPhoneHandler(wechatSvc))      // 解绑手机号
}
```

## 前端实现

### 1. API 封装

在 `wxApp/src/api/auth.js` 中添加：

```javascript
/**
 * 绑定手机号
 * @param {String} code 微信返回的code
 */
export function bindPhone(code) {
    return post('/miniapp/wechat/phone', { code })
}

/**
 * 解绑手机号
 */
export function unbindPhone() {
    return del('/miniapp/wechat/phone')
}
```

### 2. 个人中心页面

在 `wxApp/src/pages/mine/mine.vue` 中实现：

#### 绑定手机号按钮

```vue
<!-- 使用微信提供的 button 组件获取手机号 -->
<button 
    v-if="!userInfo?.phone"
    class="menu-item menu-button" 
    open-type="getPhoneNumber"
    @getphonenumber="handleGetPhoneNumber"
>
    <view class="menu-icon">📱</view>
    <view class="menu-text">绑定手机号</view>
    <view class="menu-arrow">›</view>
</button>
```

#### 处理手机号授权回调

```javascript
const handleGetPhoneNumber = async (e) => {
    if (e.detail.code) {
        try {
            uni.showLoading({ title: '绑定中...' })
            const { bindPhone } = await import('@/api/auth')
            const res = await bindPhone(e.detail.code)
            
            if (res.success) {
                uni.showToast({ title: '绑定成功', icon: 'success' })
                // 刷新用户信息
                await userStore.fetchUserInfo()
            }
        } catch (error) {
            uni.showToast({ title: error.message || '绑定失败', icon: 'none' })
        } finally {
            uni.hideLoading()
        }
    }
}
```

#### 解绑手机号

```javascript
const handleUnbindPhone = () => {
    uni.showModal({
        title: '解绑手机号',
        content: '确定要解绑手机号吗？',
        success: async (res) => {
            if (res.confirm) {
                try {
                    uni.showLoading({ title: '解绑中...' })
                    const { unbindPhone } = await import('@/api/auth')
                    await unbindPhone()
                    
                    uni.showToast({ title: '解绑成功', icon: 'success' })
                    await userStore.fetchUserInfo()
                } catch (error) {
                    uni.showToast({ title: error.message || '解绑失败', icon: 'none' })
                } finally {
                    uni.hideLoading()
                }
            }
        }
    })
}
```

### 3. 用户信息显示修复

在 `wxApp/src/pages/mine/mine.vue` 中：

```vue
<!-- 用户信息卡片 -->
<view class="user-card">
    <view class="user-avatar">
        <image :src="userInfo?.avatar || '/static/logo.png'" mode="aspectFill"></image>
    </view>
    <view class="user-info">
        <view class="user-name">{{ userInfo?.nickname || '微信用户' }}</view>
        <view class="user-phone" @click="handleBindPhone">
            {{ userInfo?.phone || '点击绑定手机号' }}
        </view>
    </view>
</view>
```

在组件挂载时刷新用户信息：

```javascript
onMounted(() => {
    // 刷新用户信息
    if (userStore.isLoggedIn) {
        userStore.fetchUserInfo().catch(err => {
            console.error('获取用户信息失败', err)
        })
    }
})
```

## 使用流程

### 绑定手机号流程

1. 用户登录后进入"我的"页面
2. 点击"绑定手机号"按钮
3. 微信弹出授权弹窗
4. 用户同意授权后，微信返回 code
5. 前端将 code 发送到后端
6. 后端调用微信 API 获取手机号
7. 后端将手机号保存到用户信息
8. 前端刷新用户信息显示

### 解绑手机号流程

1. 用户点击已绑定的手机号
2. 系统弹出确认弹窗
3. 用户确认后，前端调用解绑 API
4. 后端清空用户手机号字段
5. 前端刷新用户信息显示

## 数据库字段

在 `internal/models/wechat_user.go` 的 `WechatUser` 模型中：

```go
type WechatUser struct {
    ID       string `bson:"_id,omitempty" json:"id"`
    UnionID  string `bson:"union_id" json:"union_id"`
    OpenID   string `bson:"open_id" json:"open_id"`
    Nickname string `bson:"nickname" json:"nickname"`     // 昵称
    Avatar   string `bson:"avatar" json:"avatar"`         // 头像
    Phone    string `bson:"phone" json:"phone"`           // 手机号
    Gender   int    `bson:"gender" json:"gender"`         // 性别
    Country  string `bson:"country" json:"country"`       // 国家
    Province string `bson:"province" json:"province"`     // 省份
    City     string `bson:"city" json:"city"`             // 城市
    // ... 其他字段
}
```

## 注意事项

1. **微信审核要求**: 使用 `getPhoneNumber` 需要小程序已通过微信审核
2. **用户授权**: 手机号获取需要用户主动授权，不能强制
3. **数据加密**: 微信返回的用户信息是加密的（目前后端解密功能待实现）
4. **access_token 缓存**: 生产环境建议缓存 access_token（有效期 2 小时）
5. **错误处理**: 需要妥善处理用户拒绝授权、网络错误等情况

## 待优化项

1. **实现微信数据解密** - 完整获取用户信息（昵称、头像等）
2. **access_token 缓存** - 使用 Redis 缓存 access_token
3. **同步更新租户成员** - 手机号更新时同步到各租户的 member 表
4. **用户信息自动更新** - 定期或登录时自动更新用户信息

## 测试建议

1. 测试首次绑定手机号
2. 测试重复绑定（应提示已绑定）
3. 测试解绑后再次绑定
4. 测试用户拒绝授权的情况
5. 测试网络异常情况

## 相关文档

- [微信小程序多租户用户系统设计方案](./微信小程序多租户用户系统设计方案.md)
- [微信官方文档 - 获取手机号](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/getPhoneNumber.html)
- [微信官方文档 - 用户信息](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/userProfile.html)

