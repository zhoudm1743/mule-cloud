# 订单与裁剪功能完成总结

## 更新时间
2025-01-05

---

## 一、功能概述

本次更新完成了订单管理系统的核心功能，包括：
1. **基础数据简化** - 去除ID依赖，直接使用名称
2. **订单全流程管理** - 从创建到裁剪的完整流转
3. **裁剪功能** - 裁剪任务、制菲（裁剪批次）、打印标签、裁片监控
4. **数据联动** - 订单与款式、基础数据的自动关联

---

## 二、核心改进

### 2.1 基础数据简化

#### 原设计问题
- 基础数据（颜色、尺码、客户、工序等）使用ID+名称双字段
- 前端需要维护ID与名称的映射关系
- 数据联动复杂，容易出错

#### 优化方案
- **直接使用名称**：所有基础数据字段只存储名称
- **Tag模式输入**：前端使用Naive UI的`tag`模式，支持直接输入新值
- **前端快速创建**：输入不存在的名称时，前端可调用basic service API创建

#### 涉及的数据字段
```typescript
// 订单明细 - 之前
{
  color_id: string
  color_name: string
  size_id: string  
  size_name: string
  quantity: number
}

// 订单明细 - 现在
{
  color: string
  size: string
  quantity: number
}
```

同样简化了：
- 工序（`procedure_name` 代替 `procedure_id` + `procedure_name`）
- 裁剪批次中的颜色和尺码

---

## 三、订单流转

### 3.1 订单创建流程（三步）

**步骤1：基础信息**
- 合同号（必填）
- 客户（必填，支持tag模式快速创建）
- 交货日期
- 订单类型（支持tag模式快速创建）
- 业务员（支持tag模式快速创建）
- 备注

**步骤2：款式数量**
- 选择款式（自动填充）
  - 自动加载款式的颜色列表
  - 自动加载款式的尺码列表
  - 自动加载款式单价
  - 自动加载款式工序清单
- 颜色选择（支持tag模式快速创建）
- 尺码选择（支持tag模式快速创建）
- 单价
- 配置颜色×尺码组合的数量表格
- 自动计算总数量

**步骤3：工序确认**
- 查看工序清单
- 调整工价
- 指定工人
- 标记最慢工序
- 设置不分扎上报

### 3.2 订单到裁剪的流转

**订单列表操作按钮**
- 详情
- 编辑
- **裁剪**（新增） ← 核心流转入口
- 复制
- 删除

**裁剪按钮功能**
1. 检查订单是否已有裁剪任务
2. 如已存在，提示并跳转到裁剪管理页面
3. 如不存在，创建裁剪任务并跳转

**实现代码**
```typescript
async function handleCreateCutting(order: Api.Order.OrderInfo) {
  try {
    // 检查是否已有裁剪任务
    const { data } = await fetchCuttingTaskByOrderId(order.id)
    if (data?.task) {
      window.$message.warning('该订单已有裁剪任务')
      router.push('/order/cutting')
      return
    }
  } catch (error) {
    // 未找到，创建新任务
  }

  // 创建裁剪任务
  const { data } = await createCuttingTask({ order_id: order.id })
  if (data?.task) {
    window.$message.success('裁剪任务创建成功')
    router.push('/order/cutting')
  }
}
```

---

## 四、裁剪功能

### 4.1 数据模型

#### CuttingTask（裁剪任务）
```go
type CuttingTask struct {
    ID           string   // 任务ID
    OrderID      string   // 订单ID
    ContractNo   string   // 合同号
    StyleNo      string   // 款号
    StyleName    string   // 款名
    CustomerName string   // 客户名称
    TotalPieces  int      // 总件数
    CutPieces    int      // 已裁件数
    Status       int      // 0-待裁剪 1-裁剪中 2-已完成
    Batches      []CuttingBatch
    CreatedAt    int64
    UpdatedAt    int64
}
```

#### CuttingBatch（裁剪批次/制菲）
```go
type CuttingBatch struct {
    ID          string   // 批次ID
    TaskID      string   // 裁剪任务ID
    OrderID     string   // 订单ID
    ContractNo  string   // 合同号
    StyleNo     string   // 款号
    BedNo       string   // 床号
    BundleNo    string   // 扎号
    Color       string   // 颜色名称
    LayerCount  int      // 拉布层数
    SizeDetails []SizeDetail  // 尺码明细
    TotalPieces int      // 总件数 = Σ(尺码数量 × 层数)
    QRCode      string   // 二维码JSON内容
    PrintCount  int      // 打印次数
    CreatedAt   int64
    PrintedAt   int64
}
```

#### CuttingPiece（裁片监控）
```go
type CuttingPiece struct {
    ID           string  // 裁片ID
    OrderID      string  // 订单ID
    ContractNo   string  // 合同号
    StyleNo      string  // 款号
    BedNo        string  // 床号
    BundleNo     string  // 扎号
    Color        string  // 颜色名称
    Size         string  // 尺码名称
    Quantity     int     // 数量
    Progress     int     // 进度（已完成工序数）
    TotalProcess int     // 总工序数
    CreatedAt    int64
}
```

### 4.2 裁剪流程

#### 1. 创建裁剪任务
从订单创建裁剪任务，自动计算总件数。

#### 2. 制菲（创建裁剪批次）
- 输入床号、扎号
- 选择颜色
- 设置拉布层数
- 配置尺码明细（每个尺码每层的数量）
- 自动计算总件数
- 自动生成二维码

**尺码初始化优化**
从订单API获取订单详情，自动提取尺码列表：
```typescript
async function initializeSizeDetails(task: Api.Order.CuttingTaskInfo) {
  const { data } = await fetchOrderDetail(task.order_id)
  if (data?.order) {
    formModel.size_details = (data.order.sizes || []).map(size => ({
      size: size,
      quantity: 0,
    }))
  }
}
```

#### 3. 打印标签
- 生成打印预览窗口
- 包含批次所有信息
- 包含尺码明细表格
- 显示二维码内容（JSON格式）
- 记录打印次数

**打印内容**
```html
裁剪批次标签
合同号：XXX
款号：XXX
床号：XXX
扎号：XXX
颜色：XXX
拉布层数：XXX
总件数：XXX

尺码明细表格：
| 尺码 | 数量 |
| S    | 10   |
| M    | 15   |

二维码内容：{...}
```

#### 4. 裁片监控
- 查看裁片列表
- 按订单、合同号、床号、扎号筛选
- 显示每个裁片的进度
- 更新工序完成情况

### 4.3 二维码内容

批次二维码包含以下JSON信息：
```json
{
  "task_id": "任务ID",
  "order_id": "订单ID",
  "contract_no": "合同号",
  "style_no": "款号",
  "bed_no": "床号",
  "bundle_no": "扎号",
  "color": "颜色",
  "layer_count": 10,
  "size_details": [
    {"size": "S", "quantity": 5},
    {"size": "M", "quantity": 8}
  ],
  "total_pieces": 130
}
```

---

## 五、技术实现

### 5.1 后端架构

**Repository层**
- `CuttingTaskRepository` - 裁剪任务数据访问
- `CuttingBatchRepository` - 裁剪批次数据访问
- `CuttingPieceRepository` - 裁片监控数据访问

**Service层**
- `ICuttingService` - 裁剪业务逻辑
  - 创建裁剪任务
  - 制菲（创建批次）
  - 打印管理
  - 裁片监控

**Endpoint层**
- 使用Go-Kit框架定义端点
- 12个端点覆盖所有裁剪功能

**Transport层**
- Gin HTTP路由
- 统一使用`response.Success/Error`返回

### 5.2 前端架构

**Vue 3 + TypeScript**
- Composition API
- `<script setup>` 语法
- 使用`h`函数实现render函数（避免JSX）

**关键技术点**
```typescript
// 使用h函数创建动态表格列
const columns = computed(() => [
  {
    title: '数量',
    key: 'quantity',
    render: (row, index) => {
      return h(NInputNumber, {
        value: formModel.items[index].quantity,
        'onUpdate:value': (value: number | null) => {
          formModel.items[index].quantity = value || 0
        },
      })
    },
  },
])
```

**状态管理**
- 使用`reactive`/`ref`管理状态
- 使用`computed`计算派生状态
- 使用`useBoolean`简化布尔状态

---

## 六、数据联动

### 6.1 款式联动

选择款式时自动填充：
```typescript
function onStyleChange(styleId: string) {
  const style = styleOptions.value.find(s => s.value === styleId)
  if (style) {
    // 自动填充
    formModel.colors = style.colors || []
    formModel.sizes = style.sizes || []
    formModel.unit_price = style.unit_price || 0
    formModel.procedures = style.procedures.map((proc, index) => ({
      sequence: index + 1,
      procedure_name: proc.procedure_name,
      unit_price: proc.unit_price,
      assigned_worker: proc.assigned_worker,
      is_slowest: proc.is_slowest,
      no_bundle: proc.no_bundle,
    }))
    
    // 生成订单明细
    generateOrderItems()
  }
}
```

### 6.2 颜色尺码联动

颜色或尺码变化时，自动生成组合表格：
```typescript
function generateOrderItems() {
  const items: Api.Order.OrderItem[] = []
  
  formModel.colors.forEach((color) => {
    formModel.sizes.forEach((size) => {
      // 查找已存在的组合，保留原有数量
      const existing = formModel.items.find(
        item => item.color === color && item.size === size
      )
      
      items.push({
        color: color,
        size: size,
        quantity: existing?.quantity || 0,
      })
    })
  })
  
  formModel.items = items
  formModel.quantity = items.reduce((sum, item) => sum + item.quantity, 0)
}
```

---

## 七、文件清单

### 7.1 后端文件

#### 数据模型
- `internal/models/order.go` - 订单、款式、裁剪模型

#### Repository层
- `internal/repository/order.go` - 订单数据仓库
- `internal/repository/style.go` - 款式数据仓库
- `internal/repository/cutting.go` - 裁剪数据仓库（新增）

#### Service层
- `app/order/services/order.go` - 订单服务
- `app/order/services/style.go` - 款式服务
- `app/order/services/cutting.go` - 裁剪服务（新增）
- `app/order/services/common.go` - 公共服务

#### Endpoint层
- `app/order/endpoint/order.go` - 订单端点
- `app/order/endpoint/style.go` - 款式端点
- `app/order/endpoint/cutting.go` - 裁剪端点（新增）

#### Transport层
- `app/order/transport/order.go` - 订单HTTP路由
- `app/order/transport/style.go` - 款式HTTP路由
- `app/order/transport/cutting.go` - 裁剪HTTP路由（新增）

#### DTO层
- `app/order/dto/order.go` - 订单DTO
- `app/order/dto/style.go` - 款式DTO
- `app/order/dto/cutting.go` - 裁剪DTO（新增）

### 7.2 前端文件

#### 类型定义
- `frontend/src/typings/api/order.d.ts` - 订单和裁剪类型定义

#### API服务
- `frontend/src/service/api/order.ts` - 订单和裁剪API

#### 订单页面
- `frontend/src/views/order/orders/index.vue` - 订单列表（新增裁剪按钮）
- `frontend/src/views/order/orders/components/TableModal.vue` - 订单表单

#### 款式页面
- `frontend/src/views/order/styles/index.vue` - 款式列表
- `frontend/src/views/order/styles/components/TableModal.vue` - 款式表单

#### 裁剪页面（新增）
- `frontend/src/views/order/cutting/index.vue` - 裁剪管理主页面
- `frontend/src/views/order/cutting/components/BatchModal.vue` - 制菲Modal

---

## 八、API接口

### 8.1 订单API

```
POST   /api/v1/order/orders                  创建订单（步骤1）
PUT    /api/v1/order/orders/:id/style        更新款式数量（步骤2）
PUT    /api/v1/order/orders/:id/procedure    更新工序（步骤3）
GET    /api/v1/order/orders                  订单列表
GET    /api/v1/order/orders/:id              订单详情
PUT    /api/v1/order/orders/:id              更新订单
POST   /api/v1/order/orders/:id/copy         复制订单
DELETE /api/v1/order/orders/:id              删除订单
```

### 8.2 款式API

```
GET    /api/v1/order/styles           款式列表
GET    /api/v1/order/styles/all       所有款式（不分页）
GET    /api/v1/order/styles/:id       款式详情
POST   /api/v1/order/styles           创建款式
PUT    /api/v1/order/styles/:id       更新款式
DELETE /api/v1/order/styles/:id       删除款式
```

### 8.3 裁剪API（新增）

```
# 裁剪任务
POST   /api/v1/order/cutting/tasks                创建裁剪任务
GET    /api/v1/order/cutting/tasks                裁剪任务列表
GET    /api/v1/order/cutting/tasks/:id            裁剪任务详情
GET    /api/v1/order/cutting/tasks/order/:orderId 根据订单ID获取任务

# 裁剪批次
POST   /api/v1/order/cutting/batches              创建裁剪批次（制菲）
GET    /api/v1/order/cutting/batches              裁剪批次列表
GET    /api/v1/order/cutting/batches/:id          裁剪批次详情
DELETE /api/v1/order/cutting/batches/:id          删除裁剪批次
POST   /api/v1/order/cutting/batches/:id/print    打印裁剪批次

# 裁片监控
GET    /api/v1/order/cutting/pieces               裁片列表
GET    /api/v1/order/cutting/pieces/:id           裁片详情
PUT    /api/v1/order/cutting/pieces/:id/progress  更新裁片进度
```

---

## 九、使用示例

### 9.1 完整订单流程

**1. 创建订单**
```
订单列表 → 新建订单
→ 步骤1：填写基础信息 → 下一步
→ 步骤2：选择款式（自动填充），配置数量 → 下一步  
→ 步骤3：确认工序 → 完成
```

**2. 发起裁剪**
```
订单列表 → 选择订单 → 点击"裁剪"按钮
→ 自动创建裁剪任务 → 跳转到裁剪管理页面
```

**3. 制菲**
```
裁剪管理页面 → 找到裁剪任务 → 点击"制菲"
→ 填写床号、扎号、颜色
→ 设置拉布层数
→ 配置尺码明细（自动从订单获取）
→ 确认（自动生成二维码）
```

**4. 打印标签**
```
裁剪管理页面 → 查看批次 → 选择批次 → 点击"打印"
→ 打开打印预览窗口 → 调用浏览器打印功能
```

### 9.2 快速创建基础数据

**在订单表单中**
```
1. 客户字段：直接输入"新客户名称"，回车
2. 颜色字段：直接输入"新颜色"，回车
3. 尺码字段：直接输入"XXL"，回车
→ 前端自动添加tag
→ 提交时，basic service自动创建不存在的数据
```

---

## 十、注意事项

### 10.1 数据完整性
- 创建裁剪任务后，不能删除对应的订单
- 删除批次会更新任务进度
- 裁片监控自动从批次创建

### 10.2 租户隔离
- 所有数据操作支持租户隔离
- Repository层自动使用租户上下文
- MongoDB按租户分库存储

### 10.3 前端性能
- 使用`computed`缓存计算结果
- 大表格使用虚拟滚动（如需要）
- 图片懒加载

### 10.4 打印功能
- 当前使用浏览器打印API
- 可扩展支持打印机直连
- 可集成二维码生成库

---

## 十一、下一步计划

### 11.1 裁片监控完善
- [ ] 扫码更新进度
- [ ] 实时进度看板
- [ ] 异常裁片提醒

### 11.2 报表统计
- [ ] 订单统计报表
- [ ] 裁剪效率分析
- [ ] 工人产量统计

### 11.3 移动端
- [ ] 移动端扫码功能
- [ ] 移动端进度更新
- [ ] 离线支持

### 11.4 打印优化
- [ ] 实际二维码图片生成
- [ ] 批量打印
- [ ] 自定义打印模板

---

## 十二、总结

本次更新完成了订单管理系统从创建到生产的完整流转：

✅ **基础数据简化** - 去除ID依赖，提升易用性  
✅ **订单三步创建** - 清晰的流程，强大的数据联动  
✅ **裁剪全流程** - 任务→制菲→打印→监控  
✅ **订单流转** - 一键从订单进入裁剪  
✅ **前后端完整实现** - 无linter错误  

系统现已具备完整的生产管理能力，可支撑服装企业的日常订单和裁剪管理业务。
