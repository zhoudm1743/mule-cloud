# 修复 - 租户管理员菜单缺少父级

## 🐛 问题现象

租户管理员登录后，看到的菜单是扁平的：
```
- 管理员管理      ← 应该在"权限管理"下
- 仪表盘
- 角色管理        ← 应该在"权限管理"下
- 基础信息        ← 父菜单
```

**缺少父级菜单**：
- ❌ "权限管理"父菜单不见了

## 🔍 问题原因

### 给租户分配菜单时

系统管理员给租户分配菜单，通常会勾选子菜单（如：管理员管理、角色管理），但**不会手动勾选父级菜单**（如：权限管理）。

**租户的菜单列表**（`tenant.menus`）：
```json
[
  "dashboard",
  "basic",           // 基础信息（父菜单）
  "color",           // 颜色（子菜单）
  "size",            // 尺码（子菜单）
  "auth_admin",      // 管理员管理（子菜单）
  "auth_role"        // 角色管理（子菜单）
]
```

**缺少**：`"auth"` - 权限管理（父菜单）

### 原来的代码逻辑

```typescript
// 只返回租户拥有的菜单
var tenantMenus []dto.RouteItem
for _, menu := range allMenus {
    if tenantMenuMap[menu.Name] {  // ← 只检查租户是否拥有这个菜单
        tenantMenus = append(tenantMenus, menu)
    }
}
```

**问题**：
- 父菜单 `auth` 不在 `tenant.menus` 中
- 代码不会返回父菜单
- 前端无法构建正确的树形结构

---

## ✅ 解决方案

### 自动添加父级菜单

**修改**：`app/auth/services/auth.go:400-447`

```go
// 过滤：返回租户拥有的菜单 + 自动添加父级菜单
tenantMenuMap := make(map[string]bool)
for _, menuName := range tenant.Menus {
    tenantMenuMap[menuName] = true
}

// 创建菜单名称到完整菜单对象的映射
menuNameToItem := make(map[string]dto.RouteItem)
for _, menu := range allMenus {
    menuNameToItem[menu.Name] = menu
}

// 自动添加父级菜单（递归）
addParentMenus := func(menuName string) {
    menu, exists := menuNameToItem[menuName]
    if !exists {
        return
    }
    
    // 标记当前菜单
    tenantMenuMap[menuName] = true
    
    // 如果有父菜单，递归添加
    if menu.PID != "" {
        // 找到父菜单的名称
        for _, parentMenu := range allMenus {
            if parentMenu.ID == menu.PID {
                addParentMenus(parentMenu.Name)  // ← 递归添加父级
                break
            }
        }
    }
}

// 为租户的每个菜单，递归添加其父级
for _, menuName := range tenant.Menus {
    addParentMenus(menuName)
}

// 构建最终的菜单列表
var tenantMenus []dto.RouteItem
for _, menu := range allMenus {
    if tenantMenuMap[menu.Name] {
        tenantMenus = append(tenantMenus, menu)
    }
}
```

### 逻辑说明

1. **收集租户的菜单**：`tenant.menus`
2. **递归添加父级**：
   - 对每个菜单，检查是否有父菜单
   - 如果有，递归添加父级
   - 一直递归到根菜单
3. **返回完整的菜单树**

---

## 📊 示例

### 租户分配的菜单

```json
[
  "dashboard",
  "basic",
  "color",
  "size",
  "auth_admin",
  "auth_role"
]
```

### 自动补全后

```json
[
  "dashboard",
  "basic",        // 父菜单
  "color",        // 子菜单
  "size",         // 子菜单
  "auth",         // ✅ 自动添加的父菜单
  "auth_admin",   // 子菜单
  "auth_role"     // 子菜单
]
```

### 前端显示

```
✅ Dashboard
✅ 基础信息              ← 父菜单
   ✅ 颜色管理          ← 子菜单
   ✅ 尺码管理          ← 子菜单
✅ 权限管理              ← 自动添加的父菜单
   ✅ 管理员管理        ← 子菜单
   ✅ 角色管理          ← 子菜单
```

---

## 🎯 测试

### 1. 重启 auth 服务

```powershell
# 停止 auth 服务（Ctrl+C）
# 重新启动
go run cmd/auth/main.go
```

### 2. 租户用户登录

### 3. 验证菜单结构

**期望结果**：
- ✅ 完整的树形结构
- ✅ 父级菜单正确显示
- ✅ 子菜单在父菜单下

**auth 服务日志**：
```
[租户管理员] 用户 xxx 是租户管理员，返回租户所有菜单
[租户管理员] 租户原始菜单: [dashboard basic color size auth_admin auth_role]
[租户管理员] 补全后菜单数量: 7  ← 自动添加了 auth 父菜单
```

---

## 🎉 修复完成

- ✅ 自动添加父级菜单
- ✅ 保证菜单树结构完整
- ✅ 前端能正确显示树形菜单
- ✅ 不需要手动给租户分配父级菜单

**现在重启 auth 服务，重新登录，菜单树应该完整了！** 🎊
