# 操作日志中间件使用指南

## 📋 概述

操作日志中间件用于自动记录用户的 CRUD 操作（POST、PUT、DELETE、PATCH），不记录 GET 等读操作。

---

## 🎯 功能特性

- ✅ **自动记录写操作**：POST、PUT、DELETE、PATCH
- ❌ **跳过读操作**：GET、HEAD、OPTIONS
- 🔒 **敏感信息脱敏**：自动移除密码、token 等敏感字段
- 📊 **性能监控**：记录每个操作的耗时
- 🏢 **租户隔离**：记录租户信息，支持跨租户审计
- 💾 **统一存储**：所有日志存储在系统数据库（便于审计）

---

## 🚀 使用方法

### 1. 在服务中添加中间件

#### Gateway（推荐）

在网关添加操作日志中间件，统一记录所有服务的操作：

```go
// cmd/gateway/main.go
import (
	"mule-cloud/core/middleware"
)

func main() {
	// ...初始化...

	r := gin.New()
	
	// 全局中间件
	r.Use(gin.Logger())
	r.Use(gin.Recovery())
	r.Use(gwMiddleware.CORS())
	
	// ✅ 添加操作日志中间件（在认证之后）
	r.Use(gwMiddleware.JWTAuth(jwtManager))
	r.Use(middleware.OperationLogMiddleware())  // 记录操作日志
	
	// ...路由配置...
}
```

#### 单个服务（可选）

如果不使用网关，可以在每个服务中添加：

```go
// cmd/auth/main.go
import (
	"mule-cloud/core/middleware"
)

func main() {
	// ...初始化...

	r := gin.New()
	r.Use(gin.Logger())
	r.Use(gin.Recovery())
	
	// 保护的路由（需要认证）
	protected := r.Group("/api")
	protected.Use(middleware.JWTAuth(jwtManager))
	protected.Use(middleware.OperationLogMiddleware())  // ✅ 添加
	
	// ...路由配置...
}
```

### 2. 初始化数据库索引（可选）

为了提高查询性能，建议在服务启动时创建索引：

```go
// cmd/gateway/main.go 或 cmd/system/main.go
func main() {
	// ...初始化数据库...

	// 创建操作日志索引
	logRepo := repository.NewOperationLogRepository()
	if err := logRepo.CreateIndexes(context.Background()); err != nil {
		logger.Warn("创建操作日志索引失败", zap.Error(err))
	} else {
		logger.Info("操作日志索引创建成功")
	}

	// ...启动服务...
}
```

---

## 📊 记录的信息

### 操作日志字段

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | string | 日志ID |
| `tenant_id` | string | 租户ID（系统管理员为空） |
| `tenant_code` | string | 租户代码 |
| `user_id` | string | 操作用户ID |
| `username` | string | 操作用户名 |
| `method` | string | HTTP方法（POST/PUT/DELETE/PATCH） |
| `path` | string | 请求路径 |
| `resource` | string | 资源名称（从路径解析） |
| `action` | string | 操作类型（create/update/delete） |
| `request_body` | string | 请求体（已脱敏） |
| `response_code` | int | 响应状态码 |
| `duration` | int64 | 耗时（毫秒） |
| `ip` | string | 客户端IP |
| `user_agent` | string | 用户代理 |
| `error` | string | 错误信息（如果有） |
| `created_at` | time.Time | 创建时间 |

### 示例日志

```json
{
  "id": "68e27febab849776302f149",
  "tenant_id": "68dda6cd04ba0d6c8dda4b7a",
  "tenant_code": "default",
  "user_id": "123",
  "username": "张三",
  "method": "POST",
  "path": "/api/system/users",
  "resource": "system",
  "action": "create",
  "request_body": "{\"nickname\":\"测试用户\",\"phone\":\"13800138000\",\"password\":\"***\"}",
  "response_code": 200,
  "duration": 150,
  "ip": "192.168.1.100",
  "user_agent": "Mozilla/5.0...",
  "error": "",
  "created_at": "2025-01-08T10:00:00Z"
}
```

---

## 🔒 敏感信息脱敏

中间件会自动脱敏以下敏感字段：
- `password` → `***`
- `passwd` → `***`
- `token` → `***`
- `secret` → `***`
- `api_key` / `apiKey` → `***`

### 示例

**原始请求体**：
```json
{
  "nickname": "张三",
  "phone": "13800138000",
  "password": "123456",
  "api_key": "abc123xyz"
}
```

**脱敏后**：
```json
{
  "nickname": "张三",
  "phone": "13800138000",
  "password": "***",
  "api_key": "***"
}
```

---

## 🚫 跳过记录的操作

### 1. 跳过的 HTTP 方法

- `GET` - 查询操作
- `HEAD` - 元数据查询
- `OPTIONS` - CORS 预检

### 2. 跳过的路径

```go
// 自动跳过以下路径
/health          // 健康检查
/metrics         // 监控指标
/favicon.ico     // 图标
/static/*        // 静态资源
/assets/*        // 静态资源
/api/auth/refresh  // Token 刷新
```

### 3. 自定义跳过路径

修改 `core/middleware/operation_log.go` 的 `shouldSkipPath` 函数：

```go
func shouldSkipPath(path string) bool {
	skipPrefixes := []string{
		"/health",
		"/metrics",
		"/favicon.ico",
		"/static/",
		"/assets/",
		"/api/auth/refresh",
		"/api/logs",  // ✅ 添加：跳过日志查询接口
	}

	for _, prefix := range skipPrefixes {
		if strings.HasPrefix(path, prefix) {
			return true
		}
	}

	return false
}
```

---

## 📖 查询操作日志

### 1. 创建查询 API

在 `system` 服务中创建操作日志查询接口：

```go
// app/system/transport/operation_log.go
package transport

import (
	"mule-cloud/core/response"
	"mule-cloud/internal/repository"
	"strconv"

	"github.com/gin-gonic/gin"
	"go.mongodb.org/mongo-driver/v2/bson"
)

type OperationLogHandler struct {
	repo *repository.OperationLogRepository
}

func NewOperationLogHandler() *OperationLogHandler {
	return &OperationLogHandler{
		repo: repository.NewOperationLogRepository(),
	}
}

// List 查询操作日志列表
func (h *OperationLogHandler) List(c *gin.Context) {
	// 分页参数
	page, _ := strconv.Atoi(c.DefaultQuery("page", "1"))
	pageSize, _ := strconv.Atoi(c.DefaultQuery("page_size", "20"))

	// 筛选条件
	filter := bson.M{}
	
	// 按租户筛选
	if tenantID := c.Query("tenant_id"); tenantID != "" {
		filter["tenant_id"] = tenantID
	}
	
	// 按用户筛选
	if userID := c.Query("user_id"); userID != "" {
		filter["user_id"] = userID
	}
	
	// 按操作类型筛选
	if action := c.Query("action"); action != "" {
		filter["action"] = action
	}

	// 查询
	logs, total, err := h.repo.List(c.Request.Context(), filter, page, pageSize)
	if err != nil {
		response.Error(c, "查询失败")
		return
	}

	response.SuccessWithData(c, gin.H{
		"list":  logs,
		"total": total,
		"page":  page,
		"page_size": pageSize,
	})
}

// RegisterRoutes 注册路由
func (h *OperationLogHandler) RegisterRoutes(r *gin.RouterGroup) {
	logs := r.Group("/logs")
	{
		logs.GET("", h.List)  // GET /api/system/logs
	}
}
```

### 2. 注册路由

```go
// cmd/system/main.go
func main() {
	// ...初始化...

	// 注册操作日志路由
	logHandler := transport.NewOperationLogHandler()
	logHandler.RegisterRoutes(system)

	// ...启动服务...
}
```

### 3. 查询示例

```bash
# 查询所有操作日志
curl "http://localhost:8002/api/system/logs?page=1&page_size=20"

# 按租户筛选
curl "http://localhost:8002/api/system/logs?tenant_id=68dda6cd04ba0d6c8dda4b7a"

# 按用户筛选
curl "http://localhost:8002/api/system/logs?user_id=123"

# 按操作类型筛选
curl "http://localhost:8002/api/system/logs?action=delete"
```

---

## 🎯 使用场景

### 1. 安全审计

查看谁在什么时间对系统进行了什么操作：

```
用户 [张三] 在 2025-01-08 10:00:00 删除了角色 [role_123]
用户 [李四] 在 2025-01-08 10:05:00 创建了租户 [租户A]
```

### 2. 问题排查

当数据异常时，可以查看操作日志追溯原因：

```
订单 [order_456] 状态异常
→ 查看操作日志
→ 发现用户 [王五] 在 2025-01-08 09:50:00 执行了更新操作
→ 请求体：{"status": "cancelled"}
```

### 3. 性能分析

统计接口性能，找出慢接口：

```sql
-- MongoDB 查询示例
db.operation_logs.aggregate([
  { $group: {
    _id: "$path",
    avg_duration: { $avg: "$duration" },
    max_duration: { $max: "$duration" },
    count: { $sum: 1 }
  }},
  { $sort: { avg_duration: -1 } },
  { $limit: 10 }
])
```

### 4. 用户行为分析

分析用户操作习惯：

```
用户 [张三] 最近 7 天操作统计：
- 创建操作：15 次
- 更新操作：30 次
- 删除操作：5 次
- 活跃时间段：09:00-18:00
```

---

## ⚙️ 配置选项

### 1. 调整请求体长度限制

```go
// core/middleware/operation_log.go
func sanitizeRequestBody(body string) string {
	if body == "" {
		return ""
	}

	// ✅ 调整长度限制
	maxLen := 50000 // 改为 50KB
	if len(body) > maxLen {
		body = body[:maxLen] + "...(truncated)"
	}
	
	// ...
}
```

### 2. 添加自定义敏感字段

```go
// core/middleware/operation_log.go
func sanitizeRequestBody(body string) string {
	// ...
	
	// ✅ 添加自定义敏感字段
	sensitiveFields := []string{
		"password", "passwd", "token", "secret", 
		"api_key", "apiKey",
		"credit_card",  // 新增
		"ssn",          // 新增
	}
	
	// ...
}
```

### 3. 异步批量写入（高并发优化）

如果操作日志量很大，可以改为批量写入：

```go
// 使用 channel + goroutine 批量写入
var logChannel = make(chan *models.OperationLog, 1000)

func init() {
	go batchWriteLogs()
}

func batchWriteLogs() {
	ticker := time.NewTicker(5 * time.Second)
	batch := make([]*models.OperationLog, 0, 100)
	
	for {
		select {
		case log := <-logChannel:
			batch = append(batch, log)
			if len(batch) >= 100 {
				// 批量写入
				writeBatch(batch)
				batch = batch[:0]
			}
		case <-ticker.C:
			if len(batch) > 0 {
				writeBatch(batch)
				batch = batch[:0]
			}
		}
	}
}
```

---

## 📝 最佳实践

### 1. 日志保留策略

建议定期清理旧日志：

```javascript
// MongoDB TTL 索引（自动删除 90 天前的日志）
db.operation_logs.createIndex(
  { "created_at": 1 },
  { expireAfterSeconds: 7776000 }  // 90 天 = 90 * 24 * 60 * 60
)
```

### 2. 性能考虑

- ✅ 异步写入：不阻塞主请求
- ✅ 索引优化：为常查询字段创建索引
- ✅ 长度限制：避免存储过大的请求体
- ✅ 批量写入：高并发场景使用批量写入

### 3. 安全考虑

- ✅ 敏感信息脱敏：自动移除密码、token 等
- ✅ 权限控制：只允许管理员查看操作日志
- ✅ 数据加密：存储时可以对敏感字段加密

---

## 🎉 总结

操作日志中间件提供了：
- ✅ 自动记录 CRUD 操作
- ✅ 敏感信息脱敏
- ✅ 性能监控
- ✅ 跨租户审计
- ✅ 灵活的查询接口

**使用操作日志中间件，让系统操作更加透明、可追溯！** 🎊
