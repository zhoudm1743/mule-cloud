# æ“ä½œæ—¥å¿—ä¸­é—´ä»¶ä½¿ç”¨æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æ“ä½œæ—¥å¿—ä¸­é—´ä»¶ç”¨äºè‡ªåŠ¨è®°å½•ç”¨æˆ·çš„ CRUD æ“ä½œï¼ˆPOSTã€PUTã€DELETEã€PATCHï¼‰ï¼Œä¸è®°å½• GET ç­‰è¯»æ“ä½œã€‚

---

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

- âœ… **è‡ªåŠ¨è®°å½•å†™æ“ä½œ**ï¼šPOSTã€PUTã€DELETEã€PATCH
- âŒ **è·³è¿‡è¯»æ“ä½œ**ï¼šGETã€HEADã€OPTIONS
- ğŸ”’ **æ•æ„Ÿä¿¡æ¯è„±æ•**ï¼šè‡ªåŠ¨ç§»é™¤å¯†ç ã€token ç­‰æ•æ„Ÿå­—æ®µ
- ğŸ“Š **æ€§èƒ½ç›‘æ§**ï¼šè®°å½•æ¯ä¸ªæ“ä½œçš„è€—æ—¶
- ğŸ¢ **ç§Ÿæˆ·éš”ç¦»**ï¼šè®°å½•ç§Ÿæˆ·ä¿¡æ¯ï¼Œæ”¯æŒè·¨ç§Ÿæˆ·å®¡è®¡
- ğŸ’¾ **ç»Ÿä¸€å­˜å‚¨**ï¼šæ‰€æœ‰æ—¥å¿—å­˜å‚¨åœ¨ç³»ç»Ÿæ•°æ®åº“ï¼ˆä¾¿äºå®¡è®¡ï¼‰

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. åœ¨æœåŠ¡ä¸­æ·»åŠ ä¸­é—´ä»¶

#### Gatewayï¼ˆæ¨èï¼‰

åœ¨ç½‘å…³æ·»åŠ æ“ä½œæ—¥å¿—ä¸­é—´ä»¶ï¼Œç»Ÿä¸€è®°å½•æ‰€æœ‰æœåŠ¡çš„æ“ä½œï¼š

```go
// cmd/gateway/main.go
import (
	"mule-cloud/core/middleware"
)

func main() {
	// ...åˆå§‹åŒ–...

	r := gin.New()
	
	// å…¨å±€ä¸­é—´ä»¶
	r.Use(gin.Logger())
	r.Use(gin.Recovery())
	r.Use(gwMiddleware.CORS())
	
	// âœ… æ·»åŠ æ“ä½œæ—¥å¿—ä¸­é—´ä»¶ï¼ˆåœ¨è®¤è¯ä¹‹åï¼‰
	r.Use(gwMiddleware.JWTAuth(jwtManager))
	r.Use(middleware.OperationLogMiddleware())  // è®°å½•æ“ä½œæ—¥å¿—
	
	// ...è·¯ç”±é…ç½®...
}
```

#### å•ä¸ªæœåŠ¡ï¼ˆå¯é€‰ï¼‰

å¦‚æœä¸ä½¿ç”¨ç½‘å…³ï¼Œå¯ä»¥åœ¨æ¯ä¸ªæœåŠ¡ä¸­æ·»åŠ ï¼š

```go
// cmd/auth/main.go
import (
	"mule-cloud/core/middleware"
)

func main() {
	// ...åˆå§‹åŒ–...

	r := gin.New()
	r.Use(gin.Logger())
	r.Use(gin.Recovery())
	
	// ä¿æŠ¤çš„è·¯ç”±ï¼ˆéœ€è¦è®¤è¯ï¼‰
	protected := r.Group("/api")
	protected.Use(middleware.JWTAuth(jwtManager))
	protected.Use(middleware.OperationLogMiddleware())  // âœ… æ·»åŠ 
	
	// ...è·¯ç”±é…ç½®...
}
```

### 2. åˆå§‹åŒ–æ•°æ®åº“ç´¢å¼•ï¼ˆå¯é€‰ï¼‰

ä¸ºäº†æé«˜æŸ¥è¯¢æ€§èƒ½ï¼Œå»ºè®®åœ¨æœåŠ¡å¯åŠ¨æ—¶åˆ›å»ºç´¢å¼•ï¼š

```go
// cmd/gateway/main.go æˆ– cmd/system/main.go
func main() {
	// ...åˆå§‹åŒ–æ•°æ®åº“...

	// åˆ›å»ºæ“ä½œæ—¥å¿—ç´¢å¼•
	logRepo := repository.NewOperationLogRepository()
	if err := logRepo.CreateIndexes(context.Background()); err != nil {
		logger.Warn("åˆ›å»ºæ“ä½œæ—¥å¿—ç´¢å¼•å¤±è´¥", zap.Error(err))
	} else {
		logger.Info("æ“ä½œæ—¥å¿—ç´¢å¼•åˆ›å»ºæˆåŠŸ")
	}

	// ...å¯åŠ¨æœåŠ¡...
}
```

---

## ğŸ“Š è®°å½•çš„ä¿¡æ¯

### æ“ä½œæ—¥å¿—å­—æ®µ

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `id` | string | æ—¥å¿—ID |
| `tenant_id` | string | ç§Ÿæˆ·IDï¼ˆç³»ç»Ÿç®¡ç†å‘˜ä¸ºç©ºï¼‰ |
| `tenant_code` | string | ç§Ÿæˆ·ä»£ç  |
| `user_id` | string | æ“ä½œç”¨æˆ·ID |
| `username` | string | æ“ä½œç”¨æˆ·å |
| `method` | string | HTTPæ–¹æ³•ï¼ˆPOST/PUT/DELETE/PATCHï¼‰ |
| `path` | string | è¯·æ±‚è·¯å¾„ |
| `resource` | string | èµ„æºåç§°ï¼ˆä»è·¯å¾„è§£æï¼‰ |
| `action` | string | æ“ä½œç±»å‹ï¼ˆcreate/update/deleteï¼‰ |
| `request_body` | string | è¯·æ±‚ä½“ï¼ˆå·²è„±æ•ï¼‰ |
| `response_code` | int | å“åº”çŠ¶æ€ç  |
| `duration` | int64 | è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰ |
| `ip` | string | å®¢æˆ·ç«¯IP |
| `user_agent` | string | ç”¨æˆ·ä»£ç† |
| `error` | string | é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰ |
| `created_at` | time.Time | åˆ›å»ºæ—¶é—´ |

### ç¤ºä¾‹æ—¥å¿—

```json
{
  "id": "68e27febab849776302f149",
  "tenant_id": "68dda6cd04ba0d6c8dda4b7a",
  "tenant_code": "default",
  "user_id": "123",
  "username": "å¼ ä¸‰",
  "method": "POST",
  "path": "/api/system/users",
  "resource": "system",
  "action": "create",
  "request_body": "{\"nickname\":\"æµ‹è¯•ç”¨æˆ·\",\"phone\":\"13800138000\",\"password\":\"***\"}",
  "response_code": 200,
  "duration": 150,
  "ip": "192.168.1.100",
  "user_agent": "Mozilla/5.0...",
  "error": "",
  "created_at": "2025-01-08T10:00:00Z"
}
```

---

## ğŸ”’ æ•æ„Ÿä¿¡æ¯è„±æ•

ä¸­é—´ä»¶ä¼šè‡ªåŠ¨è„±æ•ä»¥ä¸‹æ•æ„Ÿå­—æ®µï¼š
- `password` â†’ `***`
- `passwd` â†’ `***`
- `token` â†’ `***`
- `secret` â†’ `***`
- `api_key` / `apiKey` â†’ `***`

### ç¤ºä¾‹

**åŸå§‹è¯·æ±‚ä½“**ï¼š
```json
{
  "nickname": "å¼ ä¸‰",
  "phone": "13800138000",
  "password": "123456",
  "api_key": "abc123xyz"
}
```

**è„±æ•å**ï¼š
```json
{
  "nickname": "å¼ ä¸‰",
  "phone": "13800138000",
  "password": "***",
  "api_key": "***"
}
```

---

## ğŸš« è·³è¿‡è®°å½•çš„æ“ä½œ

### 1. è·³è¿‡çš„ HTTP æ–¹æ³•

- `GET` - æŸ¥è¯¢æ“ä½œ
- `HEAD` - å…ƒæ•°æ®æŸ¥è¯¢
- `OPTIONS` - CORS é¢„æ£€

### 2. è·³è¿‡çš„è·¯å¾„

```go
// è‡ªåŠ¨è·³è¿‡ä»¥ä¸‹è·¯å¾„
/health          // å¥åº·æ£€æŸ¥
/metrics         // ç›‘æ§æŒ‡æ ‡
/favicon.ico     // å›¾æ ‡
/static/*        // é™æ€èµ„æº
/assets/*        // é™æ€èµ„æº
/api/auth/refresh  // Token åˆ·æ–°
```

### 3. è‡ªå®šä¹‰è·³è¿‡è·¯å¾„

ä¿®æ”¹ `core/middleware/operation_log.go` çš„ `shouldSkipPath` å‡½æ•°ï¼š

```go
func shouldSkipPath(path string) bool {
	skipPrefixes := []string{
		"/health",
		"/metrics",
		"/favicon.ico",
		"/static/",
		"/assets/",
		"/api/auth/refresh",
		"/api/logs",  // âœ… æ·»åŠ ï¼šè·³è¿‡æ—¥å¿—æŸ¥è¯¢æ¥å£
	}

	for _, prefix := range skipPrefixes {
		if strings.HasPrefix(path, prefix) {
			return true
		}
	}

	return false
}
```

---

## ğŸ“– æŸ¥è¯¢æ“ä½œæ—¥å¿—

### 1. åˆ›å»ºæŸ¥è¯¢ API

åœ¨ `system` æœåŠ¡ä¸­åˆ›å»ºæ“ä½œæ—¥å¿—æŸ¥è¯¢æ¥å£ï¼š

```go
// app/system/transport/operation_log.go
package transport

import (
	"mule-cloud/core/response"
	"mule-cloud/internal/repository"
	"strconv"

	"github.com/gin-gonic/gin"
	"go.mongodb.org/mongo-driver/v2/bson"
)

type OperationLogHandler struct {
	repo *repository.OperationLogRepository
}

func NewOperationLogHandler() *OperationLogHandler {
	return &OperationLogHandler{
		repo: repository.NewOperationLogRepository(),
	}
}

// List æŸ¥è¯¢æ“ä½œæ—¥å¿—åˆ—è¡¨
func (h *OperationLogHandler) List(c *gin.Context) {
	// åˆ†é¡µå‚æ•°
	page, _ := strconv.Atoi(c.DefaultQuery("page", "1"))
	pageSize, _ := strconv.Atoi(c.DefaultQuery("page_size", "20"))

	// ç­›é€‰æ¡ä»¶
	filter := bson.M{}
	
	// æŒ‰ç§Ÿæˆ·ç­›é€‰
	if tenantID := c.Query("tenant_id"); tenantID != "" {
		filter["tenant_id"] = tenantID
	}
	
	// æŒ‰ç”¨æˆ·ç­›é€‰
	if userID := c.Query("user_id"); userID != "" {
		filter["user_id"] = userID
	}
	
	// æŒ‰æ“ä½œç±»å‹ç­›é€‰
	if action := c.Query("action"); action != "" {
		filter["action"] = action
	}

	// æŸ¥è¯¢
	logs, total, err := h.repo.List(c.Request.Context(), filter, page, pageSize)
	if err != nil {
		response.Error(c, "æŸ¥è¯¢å¤±è´¥")
		return
	}

	response.SuccessWithData(c, gin.H{
		"list":  logs,
		"total": total,
		"page":  page,
		"page_size": pageSize,
	})
}

// RegisterRoutes æ³¨å†Œè·¯ç”±
func (h *OperationLogHandler) RegisterRoutes(r *gin.RouterGroup) {
	logs := r.Group("/logs")
	{
		logs.GET("", h.List)  // GET /api/system/logs
	}
}
```

### 2. æ³¨å†Œè·¯ç”±

```go
// cmd/system/main.go
func main() {
	// ...åˆå§‹åŒ–...

	// æ³¨å†Œæ“ä½œæ—¥å¿—è·¯ç”±
	logHandler := transport.NewOperationLogHandler()
	logHandler.RegisterRoutes(system)

	// ...å¯åŠ¨æœåŠ¡...
}
```

### 3. æŸ¥è¯¢ç¤ºä¾‹

```bash
# æŸ¥è¯¢æ‰€æœ‰æ“ä½œæ—¥å¿—
curl "http://localhost:8002/api/system/logs?page=1&page_size=20"

# æŒ‰ç§Ÿæˆ·ç­›é€‰
curl "http://localhost:8002/api/system/logs?tenant_id=68dda6cd04ba0d6c8dda4b7a"

# æŒ‰ç”¨æˆ·ç­›é€‰
curl "http://localhost:8002/api/system/logs?user_id=123"

# æŒ‰æ“ä½œç±»å‹ç­›é€‰
curl "http://localhost:8002/api/system/logs?action=delete"
```

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### 1. å®‰å…¨å®¡è®¡

æŸ¥çœ‹è°åœ¨ä»€ä¹ˆæ—¶é—´å¯¹ç³»ç»Ÿè¿›è¡Œäº†ä»€ä¹ˆæ“ä½œï¼š

```
ç”¨æˆ· [å¼ ä¸‰] åœ¨ 2025-01-08 10:00:00 åˆ é™¤äº†è§’è‰² [role_123]
ç”¨æˆ· [æå››] åœ¨ 2025-01-08 10:05:00 åˆ›å»ºäº†ç§Ÿæˆ· [ç§Ÿæˆ·A]
```

### 2. é—®é¢˜æ’æŸ¥

å½“æ•°æ®å¼‚å¸¸æ—¶ï¼Œå¯ä»¥æŸ¥çœ‹æ“ä½œæ—¥å¿—è¿½æº¯åŸå› ï¼š

```
è®¢å• [order_456] çŠ¶æ€å¼‚å¸¸
â†’ æŸ¥çœ‹æ“ä½œæ—¥å¿—
â†’ å‘ç°ç”¨æˆ· [ç‹äº”] åœ¨ 2025-01-08 09:50:00 æ‰§è¡Œäº†æ›´æ–°æ“ä½œ
â†’ è¯·æ±‚ä½“ï¼š{"status": "cancelled"}
```

### 3. æ€§èƒ½åˆ†æ

ç»Ÿè®¡æ¥å£æ€§èƒ½ï¼Œæ‰¾å‡ºæ…¢æ¥å£ï¼š

```sql
-- MongoDB æŸ¥è¯¢ç¤ºä¾‹
db.operation_logs.aggregate([
  { $group: {
    _id: "$path",
    avg_duration: { $avg: "$duration" },
    max_duration: { $max: "$duration" },
    count: { $sum: 1 }
  }},
  { $sort: { avg_duration: -1 } },
  { $limit: 10 }
])
```

### 4. ç”¨æˆ·è¡Œä¸ºåˆ†æ

åˆ†æç”¨æˆ·æ“ä½œä¹ æƒ¯ï¼š

```
ç”¨æˆ· [å¼ ä¸‰] æœ€è¿‘ 7 å¤©æ“ä½œç»Ÿè®¡ï¼š
- åˆ›å»ºæ“ä½œï¼š15 æ¬¡
- æ›´æ–°æ“ä½œï¼š30 æ¬¡
- åˆ é™¤æ“ä½œï¼š5 æ¬¡
- æ´»è·ƒæ—¶é—´æ®µï¼š09:00-18:00
```

---

## âš™ï¸ é…ç½®é€‰é¡¹

### 1. è°ƒæ•´è¯·æ±‚ä½“é•¿åº¦é™åˆ¶

```go
// core/middleware/operation_log.go
func sanitizeRequestBody(body string) string {
	if body == "" {
		return ""
	}

	// âœ… è°ƒæ•´é•¿åº¦é™åˆ¶
	maxLen := 50000 // æ”¹ä¸º 50KB
	if len(body) > maxLen {
		body = body[:maxLen] + "...(truncated)"
	}
	
	// ...
}
```

### 2. æ·»åŠ è‡ªå®šä¹‰æ•æ„Ÿå­—æ®µ

```go
// core/middleware/operation_log.go
func sanitizeRequestBody(body string) string {
	// ...
	
	// âœ… æ·»åŠ è‡ªå®šä¹‰æ•æ„Ÿå­—æ®µ
	sensitiveFields := []string{
		"password", "passwd", "token", "secret", 
		"api_key", "apiKey",
		"credit_card",  // æ–°å¢
		"ssn",          // æ–°å¢
	}
	
	// ...
}
```

### 3. å¼‚æ­¥æ‰¹é‡å†™å…¥ï¼ˆé«˜å¹¶å‘ä¼˜åŒ–ï¼‰

å¦‚æœæ“ä½œæ—¥å¿—é‡å¾ˆå¤§ï¼Œå¯ä»¥æ”¹ä¸ºæ‰¹é‡å†™å…¥ï¼š

```go
// ä½¿ç”¨ channel + goroutine æ‰¹é‡å†™å…¥
var logChannel = make(chan *models.OperationLog, 1000)

func init() {
	go batchWriteLogs()
}

func batchWriteLogs() {
	ticker := time.NewTicker(5 * time.Second)
	batch := make([]*models.OperationLog, 0, 100)
	
	for {
		select {
		case log := <-logChannel:
			batch = append(batch, log)
			if len(batch) >= 100 {
				// æ‰¹é‡å†™å…¥
				writeBatch(batch)
				batch = batch[:0]
			}
		case <-ticker.C:
			if len(batch) > 0 {
				writeBatch(batch)
				batch = batch[:0]
			}
		}
	}
}
```

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. æ—¥å¿—ä¿ç•™ç­–ç•¥

å»ºè®®å®šæœŸæ¸…ç†æ—§æ—¥å¿—ï¼š

```javascript
// MongoDB TTL ç´¢å¼•ï¼ˆè‡ªåŠ¨åˆ é™¤ 90 å¤©å‰çš„æ—¥å¿—ï¼‰
db.operation_logs.createIndex(
  { "created_at": 1 },
  { expireAfterSeconds: 7776000 }  // 90 å¤© = 90 * 24 * 60 * 60
)
```

### 2. æ€§èƒ½è€ƒè™‘

- âœ… å¼‚æ­¥å†™å…¥ï¼šä¸é˜»å¡ä¸»è¯·æ±‚
- âœ… ç´¢å¼•ä¼˜åŒ–ï¼šä¸ºå¸¸æŸ¥è¯¢å­—æ®µåˆ›å»ºç´¢å¼•
- âœ… é•¿åº¦é™åˆ¶ï¼šé¿å…å­˜å‚¨è¿‡å¤§çš„è¯·æ±‚ä½“
- âœ… æ‰¹é‡å†™å…¥ï¼šé«˜å¹¶å‘åœºæ™¯ä½¿ç”¨æ‰¹é‡å†™å…¥

### 3. å®‰å…¨è€ƒè™‘

- âœ… æ•æ„Ÿä¿¡æ¯è„±æ•ï¼šè‡ªåŠ¨ç§»é™¤å¯†ç ã€token ç­‰
- âœ… æƒé™æ§åˆ¶ï¼šåªå…è®¸ç®¡ç†å‘˜æŸ¥çœ‹æ“ä½œæ—¥å¿—
- âœ… æ•°æ®åŠ å¯†ï¼šå­˜å‚¨æ—¶å¯ä»¥å¯¹æ•æ„Ÿå­—æ®µåŠ å¯†

---

## ğŸ‰ æ€»ç»“

æ“ä½œæ—¥å¿—ä¸­é—´ä»¶æä¾›äº†ï¼š
- âœ… è‡ªåŠ¨è®°å½• CRUD æ“ä½œ
- âœ… æ•æ„Ÿä¿¡æ¯è„±æ•
- âœ… æ€§èƒ½ç›‘æ§
- âœ… è·¨ç§Ÿæˆ·å®¡è®¡
- âœ… çµæ´»çš„æŸ¥è¯¢æ¥å£

**ä½¿ç”¨æ“ä½œæ—¥å¿—ä¸­é—´ä»¶ï¼Œè®©ç³»ç»Ÿæ“ä½œæ›´åŠ é€æ˜ã€å¯è¿½æº¯ï¼** ğŸŠ
