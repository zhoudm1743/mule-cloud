# 数据库级别租户隔离 - 快速实施指南

## 📋 改造进度

### ✅ 已完成（2025-10-02）

| 序号 | 改造项 | 状态 | 说明 |
|-----|--------|------|------|
| 1 | 核心基础设施 | ✅ 完成 | DatabaseManager, Context传递机制 |
| 2 | 模型层改造 | ✅ 完成 | 删除所有tenant_id字段 |
| 3 | 网关中间件 | ✅ 完成 | 添加Context传递 |
| 4 | Admin Repository | ✅ 完成 | 改用DatabaseManager |

### 🔨 待完成

| 序号 | 改造项 | 文件 | 预计工作量 |
|-----|--------|------|----------|
| 5 | 其他Repository | role.go, menu.go, tenant.go, basic.go | 2小时 |
| 6 | Service层改造 | admin.go, tenant.go, role.go等 | 2小时 |
| 7 | DTO层改造 | 删除tenant_id字段 | 30分钟 |
| 8 | Transport层改造 | 确保传递Context | 1小时 |
| 9 | 认证服务改造 | auth.go登录逻辑 | 1小时 |
| 10 | 初始化改造 | 所有main.go | 30分钟 |
| 11 | 数据迁移脚本 | migrate_to_physical_isolation.js | 1小时 |

---

## 🔧 Repository层改造模板

### 标准改造步骤

以 `admin.go` 为模板，其他Repository按以下步骤改造：

#### 1. 添加导入

```go
import (
    "context"
    "mule-cloud/core/database"
    tenantCtx "mule-cloud/core/context"  // ✅ 新增
    "mule-cloud/internal/models"
    // ...
)
```

#### 2. 修改Repository结构体

```go
// ❌ 旧代码
type xxxRepository struct {
    collection *mongo.Collection
}

func NewXXXRepository() XXXRepository {
    collection := database.MongoDB.Collection("xxx")
    return &xxxRepository{
        collection: collection,
    }
}

// ✅ 新代码
type xxxRepository struct {
    dbManager *database.DatabaseManager
}

func NewXXXRepository() XXXRepository {
    return &xxxRepository{
        dbManager: database.GetDatabaseManager(),
    }
}

// 添加getCollection方法
func (r *xxxRepository) getCollection(ctx context.Context) *mongo.Collection {
    tenantID := tenantCtx.GetTenantID(ctx)
    db := r.dbManager.GetDatabase(tenantID)
    return db.Collection("xxx")  // xxx为集合名
}
```

#### 3. 修改所有方法

将所有方法中的 `r.collection` 替换为 `r.getCollection(ctx)`：

```go
// ❌ 旧代码
func (r *xxxRepository) Get(ctx context.Context, id string) (*models.XXX, error) {
    filter := bson.M{"_id": id}
    result := &models.XXX{}
    err := r.collection.FindOne(ctx, filter).Decode(result)
    // ...
}

// ✅ 新代码
func (r *xxxRepository) Get(ctx context.Context, id string) (*models.XXX, error) {
    collection := r.getCollection(ctx)  // ✅ 新增这一行
    filter := bson.M{"_id": id}
    result := &models.XXX{}
    err := collection.FindOne(ctx, filter).Decode(result)  // ✅ 使用collection
    // ...
}
```

#### 4. 特殊处理：TenantRepository

`tenant.go` 需要固定使用系统数据库：

```go
// tenant.go 特殊处理
type tenantRepository struct {
    dbManager *database.DatabaseManager
}

// ✅ 租户数据固定使用系统数据库
func (r *tenantRepository) getCollection() *mongo.Collection {
    db := r.dbManager.GetSystemDatabase()  // 固定使用系统库
    return db.Collection("tenant")
}

// 所有方法直接调用 r.getCollection() 而不是 r.getCollection(ctx)
func (r *tenantRepository) Get(ctx context.Context, id string) (*models.Tenant, error) {
    collection := r.getCollection()  // 不需要ctx参数
    // ...
}
```

---

## 🎯 Service层改造模板

### 标准改造步骤

#### 1. 删除所有tenant_id相关过滤

```go
// ❌ 旧代码
func (s *AdminService) List(req dto.AdminListRequest) ([]models.Admin, int64, error) {
    ctx := context.Background()
    filter := bson.M{"is_deleted": 0}
    
    if req.TenantID != "" {
        filter["tenant_id"] = req.TenantID  // ❌ 删除
    }
    
    total, err := s.repo.Count(ctx, filter)
    // ...
}

// ✅ 新代码
func (s *AdminService) List(ctx context.Context, req dto.AdminListRequest) ([]models.Admin, int64, error) {
    // ✅ Context作为参数传入
    filter := bson.M{"is_deleted": 0}
    // ❌ 删除tenant_id过滤，Repository会自动处理
    
    total, err := s.repo.Count(ctx, filter)
    // ...
}
```

#### 2. 创建记录时删除TenantID

```go
// ❌ 旧代码
func (s *AdminService) Create(req dto.AdminCreateRequest) (*models.Admin, error) {
    ctx := context.Background()
    admin := &models.Admin{
        TenantID: req.TenantID,  // ❌ 删除
        Phone:    req.Phone,
        // ...
    }
    // ...
}

// ✅ 新代码
func (s *AdminService) Create(ctx context.Context, req dto.AdminCreateRequest) (*models.Admin, error) {
    // ✅ Context作为参数传入
    admin := &models.Admin{
        Phone:    req.Phone,
        // ...
    }
    err := s.repo.Create(ctx, admin)  // ✅ 传递Context
    // ...
}
```

#### 3. 特殊：TenantService创建租户

```go
// ✅ 租户Service需要创建租户数据库
func (s *TenantService) Create(ctx context.Context, req dto.TenantCreateRequest) (*models.Tenant, error) {
    // 1. 创建租户记录（系统库）
    tenant := &models.Tenant{
        Code: req.Code,
        Name: req.Name,
        // ...
    }
    
    // Context使用空租户ID（系统库）
    systemCtx := tenantCtx.WithTenantID(ctx, "")
    err := s.repo.Create(systemCtx, tenant)
    if err != nil {
        return nil, err
    }
    
    // ✅ 2. 创建租户专属数据库
    dbManager := database.GetDatabaseManager()
    err = dbManager.CreateTenantDatabase(ctx, tenant.ID)
    if err != nil {
        // 回滚：删除租户记录
        s.repo.HardDelete(systemCtx, tenant.ID)
        return nil, fmt.Errorf("创建租户数据库失败: %v", err)
    }
    
    // ✅ 3. 在租户数据库创建租户管理员
    tenantCtx := tenantCtx.WithTenantID(ctx, tenant.ID)
    adminService := NewAdminService()
    _, err = adminService.Create(tenantCtx, dto.AdminCreateRequest{
        Phone:    req.AdminPhone,
        Password: req.AdminPassword,
        Nickname: "租户管理员",
        Roles:    []string{"tenant_admin"},
        Status:   1,
    })
    if err != nil {
        // 回滚
        dbManager.DeleteTenantDatabase(ctx, tenant.ID)
        s.repo.HardDelete(systemCtx, tenant.ID)
        return nil, fmt.Errorf("创建租户管理员失败: %v", err)
    }
    
    return tenant, nil
}
```

---

## 📝 DTO层改造

### 删除所有tenant_id字段

```go
// app/system/dto/admin.go
// ❌ 旧代码
type AdminListRequest struct {
    Page     int64  `json:"page" form:"page"`
    PageSize int64  `json:"page_size" form:"page_size"`
    TenantID string `json:"tenant_id" form:"tenant_id"`  // ❌ 删除
    // ...
}

type AdminCreateRequest struct {
    Phone    string `json:"phone" binding"required"`
    TenantID string `json:"tenant_id"`  // ❌ 删除
    // ...
}

// ✅ 新代码（直接删除tenant_id字段）
type AdminListRequest struct {
    Page     int64  `json:"page" form:"page"`
    PageSize int64  `json:"page_size" form:"page_size"`
    // ...
}

type AdminCreateRequest struct {
    Phone string `json:"phone" binding"required"`
    // ...
}
```

---

## 🚀 Transport层改造

### 确保传递Context

```go
// app/system/transport/admin.go
// ❌ 旧代码
func ListAdminHandler(svc services.IAdminService) endpoint.Endpoint {
    return func(ctx context.Context, request interface{}) (interface{}, error) {
        req := request.(dto.AdminListRequest)
        admins, total, err := svc.List(req)  // ❌ 没有传Context
        // ...
    }
}

// ✅ 新代码
func ListAdminHandler(svc services.IAdminService) endpoint.Endpoint {
    return func(ctx context.Context, request interface{}) (interface{}, error) {
        req := request.(dto.AdminListRequest)
        admins, total, err := svc.List(ctx, req)  // ✅ 传递Context
        // ...
    }
}
```

---

## 🔐 认证服务改造

### 登录跨库查询

```go
// app/auth/services/auth.go
func (s *AuthService) Login(ctx context.Context, phone, password string) (*dto.LoginResponse, error) {
    var admin *models.Admin
    var targetTenantID string
    
    // 1. 先在系统库查找（系统超管）
    systemCtx := tenantCtx.WithTenantID(ctx, "")
    admin, err := s.repo.GetByPhone(systemCtx, phone)
    
    if admin == nil {
        // ✅ 2. 未找到，查询手机号映射表
        mapping, err := s.getMappingByPhone(systemCtx, phone)
        if err == nil && mapping != nil {
            // 找到映射，直接在对应租户库查询
            tenantCtx := tenantCtx.WithTenantID(ctx, mapping.TenantID)
            admin, _ = s.repo.GetByPhone(tenantCtx, phone)
            targetTenantID = mapping.TenantID
        } else {
            // ✅ 3. 兜底方案：遍历所有租户库查找（性能较差，建议建映射表）
            tenants, _ := s.tenantRepo.FindAll(systemCtx)
            for _, tenant := range tenants {
                tenantCtx := tenantCtx.WithTenantID(ctx, tenant.ID)
                admin, _ = s.repo.GetByPhone(tenantCtx, phone)
                if admin != nil {
                    targetTenantID = tenant.ID
                    break
                }
            }
        }
    }
    
    if admin == nil {
        return nil, errors.New("用户不存在")
    }
    
    // 4. 验证密码
    if !util.CheckPassword(password, admin.Password) {
        return nil, errors.New("密码错误")
    }
    
    // 5. 生成JWT Token
    token, err := s.jwtManager.GenerateToken(
        admin.ID, 
        admin.Nickname, 
        targetTenantID,  // 租户ID
        admin.Roles,
    )
    
    return &dto.LoginResponse{
        Token:    token,
        UserInfo: admin,
    }, nil
}
```

### 性能优化：手机号映射表

```go
// internal/models/phone_mapping.go (新建)
package models

// PhoneToTenant 手机号租户映射表（系统库）
type PhoneToTenant struct {
    Phone    string `bson:"_id" json:"phone"`         // 手机号作为主键
    TenantID string `bson:"tenant_id" json:"tenant_id"` // 租户ID
}

func (PhoneToTenant) TableName() string {
    return "phone_to_tenant"
}
```

```go
// app/auth/services/auth.go
func (s *AuthService) getMappingByPhone(ctx context.Context, phone string) (*models.PhoneToTenant, error) {
    // 从系统库查询映射表
    collection := s.dbManager.GetSystemDatabase().Collection("phone_to_tenant")
    mapping := &models.PhoneToTenant{}
    err := collection.FindOne(ctx, bson.M{"_id": phone}).Decode(mapping)
    if err != nil {
        return nil, err
    }
    return mapping, nil
}

// 注册时添加映射
func (s *AuthService) Register(ctx context.Context, req dto.RegisterRequest) error {
    // 1. 创建用户...
    
    // 2. 添加手机号映射
    tenantID := tenantCtx.GetTenantID(ctx)
    if tenantID != "" {
        mapping := &models.PhoneToTenant{
            Phone:    req.Phone,
            TenantID: tenantID,
        }
        collection := s.dbManager.GetSystemDatabase().Collection("phone_to_tenant")
        collection.InsertOne(ctx, mapping)
    }
    
    return nil
}
```

---

## 🎬 初始化改造

### 所有main.go添加DatabaseManager初始化

```go
// cmd/system/main.go (所有服务的main.go都需要类似改造)
func main() {
    // 1. 加载配置
    cfg := config.Get()
    
    // 2. 初始化日志
    logger.InitLogger(&cfg.Log)
    
    // 3. 初始化MongoDB客户端
    client, err := database.InitMongoDB(&cfg.MongoDB)
    if err != nil {
        log.Fatalf("❌ 初始化MongoDB失败: %v", err)
    }
    defer database.CloseMongoDB()
    
    // ✅ 4. 初始化数据库管理器（新增）
    database.InitDatabaseManager(client)
    log.Println("✅ 数据库管理器初始化成功")
    
    // 5. 初始化Redis
    // ...
    
    // 6. 启动服务
    // ...
}
```

需要修改的文件：
- `cmd/system/main.go`
- `cmd/basic/main.go`
- `cmd/auth/main.go`
- `cmd/gateway/main.go`

---

## 📊 数据迁移

### 迁移脚本

在MongoDB Shell中执行：

```javascript
// scripts/migrate_to_physical_isolation.js
// 用法：mongo --host 127.0.0.1 --port 27015 -u root -p bgg8384495 --authenticationDatabase admin mule scripts/migrate_to_physical_isolation.js

const sourceDB = db.getSiblingDB("mule");
const systemDB = db.getSiblingDB("tenant_system");

print("=== 开始数据迁移 ===");
print(`源数据库: mule`);
print(`目标系统库: tenant_system`);
print("");

// 1. 迁移租户数据到系统库
print("[1/5] 迁移租户数据...");
const tenants = sourceDB.tenant.find({ is_deleted: 0 }).toArray();
print(`  找到 ${tenants.length} 个租户`);

if (tenants.length > 0) {
    systemDB.tenant.insertMany(tenants);
    print(`  ✅ 租户数据迁移完成`);
}

// 2. 迁移系统超管到系统库
print("\n[2/5] 迁移系统超管...");
const superAdmins = sourceDB.admin.find({ 
    tenant_id: { $in: ["", null] },
    role: { $in: ["super"] },
    is_deleted: 0 
}).toArray();

print(`  找到 ${superAdmins.length} 个系统超管`);
superAdmins.forEach(admin => {
    delete admin.tenant_id;
});

if (superAdmins.length > 0) {
    systemDB.admin.insertMany(superAdmins);
    print(`  ✅ 系统超管迁移完成`);
}

// 3. 为每个租户创建独立数据库
print("\n[3/5] 为每个租户创建独立数据库...");
tenants.forEach((tenant, index) => {
    const tenantID = tenant._id.toString();
    const tenantDBName = `tenant_${tenantID}`;
    const tenantDB = db.getSiblingDB(tenantDBName);
    
    print(`\n  [${index + 1}/${tenants.length}] 处理租户: ${tenant.name} (${tenantID})`);
    
    // 需要迁移的集合
    const collections = [
        "admin", "role", "menu", "basic", 
        "color", "customer", "order_type", 
        "procedure", "salesman", "size"
    ];
    
    collections.forEach(collName => {
        const filter = { tenant_id: tenantID, is_deleted: 0 };
        const docs = sourceDB[collName].find(filter).toArray();
        
        if (docs.length > 0) {
            // 删除 tenant_id 字段
            docs.forEach(doc => {
                delete doc.tenant_id;
            });
            
            tenantDB[collName].insertMany(docs);
            print(`    ✅ ${collName}: ${docs.length} 条`);
        }
    });
    
    // 创建索引
    tenantDB.admin.createIndex({ phone: 1 }, { unique: true, sparse: true });
    tenantDB.admin.createIndex({ is_deleted: 1 });
    tenantDB.role.createIndex({ code: 1 }, { unique: true });
    tenantDB.menu.createIndex({ name: 1 });
    
    print(`  ✅ 租户数据库创建完成`);
});

// 4. 创建手机号映射表
print("\n[4/5] 创建手机号映射表...");
const allAdmins = sourceDB.admin.find({ 
    tenant_id: { $ne: "", $exists: true },
    is_deleted: 0 
}).toArray();

if (allAdmins.length > 0) {
    const mappings = [];
    allAdmins.forEach(admin => {
        if (admin.phone) {
            mappings.push({
                _id: admin.phone,
                tenant_id: admin.tenant_id
            });
        }
    });
    
    if (mappings.length > 0) {
        systemDB.phone_to_tenant.insertMany(mappings, { ordered: false });
        print(`  ✅ 创建 ${mappings.length} 条映射记录`);
    }
}

// 5. 验证迁移结果
print("\n[5/5] 验证迁移结果...");
let allSuccess = true;

// 验证租户数量
const sourceTenantCount = sourceDB.tenant.countDocuments({ is_deleted: 0 });
const systemTenantCount = systemDB.tenant.countDocuments({ is_deleted: 0 });
print(`  租户数量: 原库 ${sourceTenantCount} vs 系统库 ${systemTenantCount}`);
if (sourceTenantCount !== systemTenantCount) {
    print("  ❌ 租户数量不匹配！");
    allSuccess = false;
}

// 验证每个租户的数据
tenants.forEach(tenant => {
    const tenantID = tenant._id.toString();
    const tenantDBName = `tenant_${tenantID}`;
    const tenantDB = db.getSiblingDB(tenantDBName);
    
    const collections = ["admin", "role", "menu"];
    collections.forEach(collName => {
        const sourceCount = sourceDB[collName].countDocuments({ 
            tenant_id: tenantID, 
            is_deleted: 0 
        });
        const tenantCount = tenantDB[collName].countDocuments({ is_deleted: 0 });
        
        if (sourceCount !== tenantCount) {
            print(`  ❌ 租户 ${tenant.name} - ${collName}: 原库 ${sourceCount} vs 租户库 ${tenantCount}`);
            allSuccess = false;
        }
    });
});

print("\n=== 迁移完成 ===");
if (allSuccess) {
    print("✅ 所有数据验证通过！");
    print("\n⚠️  请在新系统稳定运行后再删除原数据库！");
    print("删除命令：");
    print("  use mule");
    print("  db.dropDatabase()");
} else {
    print("❌ 数据验证失败，请检查迁移脚本！");
}
```

### 执行迁移

```powershell
# Windows PowerShell
# 连接到Docker中的MongoDB
docker exec -it <mongodb-container-name> mongo --host 127.0.0.1 --port 27017 -u root -p bgg8384495 --authenticationDatabase admin mule /scripts/migrate_to_physical_isolation.js

# 或者从宿主机执行
mongo --host 127.0.0.1 --port 27015 -u root -p bgg8384495 --authenticationDatabase admin mule < K:\Git\mule-cloud\scripts\migrate_to_physical_isolation.js
```

---

## ⚠️ 注意事项

### 1. MongoDB Docker配置

确保你的`docker-compose.yml`或MongoDB配置包含：

```yaml
mongodb:
  image: mongo:latest
  ports:
    - "27015:27017"
  environment:
    MONGO_INITDB_ROOT_USERNAME: root
    MONGO_INITDB_ROOT_PASSWORD: bgg8384495
  volumes:
    - ./scripts:/scripts  # 挂载脚本目录
```

### 2. 配置文件更新

`config/*.yaml` 保持不变，DatabaseManager会自动管理多个数据库：

```yaml
mongodb:
  enabled: true
  host: "127.0.0.1"
  port: 27015
  username: "root"
  password: "bgg8384495"
  database: "mule"  # 这个配置实际上不再使用，但保留避免报错
  auth_source: "admin"
```

### 3. 性能考虑

- ✅ 建立手机号映射表加速登录
- ✅ 使用连接池复用
- ✅ 懒加载租户数据库
- ✅ 定期清理不活跃连接：`dbManager.CleanupInactiveDatabases()`

### 4. 安全考虑

- ✅ 系统超管固定使用系统库（tenant_id为空）
- ✅ 普通租户用户无法访问系统库
- ✅ 租户A用户无法访问租户B数据库
- ✅ JWT Token中的tenant_id不可伪造

---

## 🧪 测试步骤

### 1. 单元测试

```go
// internal/repository/admin_test.go
func TestAdminRepository_MultiTenant(t *testing.T) {
    ctx := context.Background()
    repo := NewAdminRepository()
    
    // 测试租户A
    ctxA := tenantCtx.WithTenantID(ctx, "tenant_a")
    adminA := &models.Admin{Phone: "13800138000", Nickname: "租户A用户"}
    repo.Create(ctxA, adminA)
    
    // 测试租户B
    ctxB := tenantCtx.WithTenantID(ctx, "tenant_b")
    adminB := &models.Admin{Phone: "13900139000", Nickname: "租户B用户"}
    repo.Create(ctxB, adminB)
    
    // 验证隔离：租户A看不到租户B的数据
    adminsA, _ := repo.Find(ctxA, bson.M{})
    assert.Equal(t, 1, len(adminsA))
    assert.Equal(t, "租户A用户", adminsA[0].Nickname)
}
```

### 2. 集成测试

```bash
# 1. 创建租户
curl -X POST http://localhost:8080/tenant/create \
  -H "Authorization: Bearer {super_admin_token}" \
  -d '{"code":"TEST","name":"测试租户","admin_phone":"13800138000","admin_password":"123456"}'

# 2. 验证数据库创建
mongo --host 127.0.0.1 --port 27015 -u root -p bgg8384495 --authenticationDatabase admin
> show dbs
tenant_system
tenant_xxx  # 新创建的租户数据库

# 3. 租户管理员登录
curl -X POST http://localhost:8080/auth/login \
  -d '{"phone":"13800138000","password":"123456"}'

# 4. CRUD操作验证数据隔离
```

---

## 📚 参考文档

- [数据库级别租户隔离改造方案](./数据库级别租户隔离改造方案.md) - 完整方案
- [MongoDB Multi-Tenancy](https://www.mongodb.com/basics/multi-tenancy)
- [Go Context最佳实践](https://go.dev/blog/context)

---

**更新时间：** 2025-10-02  
**作者：** Mule-Cloud 团队

