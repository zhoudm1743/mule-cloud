# æ•°æ®åº“çº§åˆ«ç§Ÿæˆ·éš”ç¦» - å¿«é€Ÿå®æ–½æŒ‡å—

## ğŸ“‹ æ”¹é€ è¿›åº¦

### âœ… å·²å®Œæˆï¼ˆ2025-10-02ï¼‰

| åºå· | æ”¹é€ é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|-----|--------|------|------|
| 1 | æ ¸å¿ƒåŸºç¡€è®¾æ–½ | âœ… å®Œæˆ | DatabaseManager, Contextä¼ é€’æœºåˆ¶ |
| 2 | æ¨¡å‹å±‚æ”¹é€  | âœ… å®Œæˆ | åˆ é™¤æ‰€æœ‰tenant_idå­—æ®µ |
| 3 | ç½‘å…³ä¸­é—´ä»¶ | âœ… å®Œæˆ | æ·»åŠ Contextä¼ é€’ |
| 4 | Admin Repository | âœ… å®Œæˆ | æ”¹ç”¨DatabaseManager |

### ğŸ”¨ å¾…å®Œæˆ

| åºå· | æ”¹é€ é¡¹ | æ–‡ä»¶ | é¢„è®¡å·¥ä½œé‡ |
|-----|--------|------|----------|
| 5 | å…¶ä»–Repository | role.go, menu.go, tenant.go, basic.go | 2å°æ—¶ |
| 6 | Serviceå±‚æ”¹é€  | admin.go, tenant.go, role.goç­‰ | 2å°æ—¶ |
| 7 | DTOå±‚æ”¹é€  | åˆ é™¤tenant_idå­—æ®µ | 30åˆ†é’Ÿ |
| 8 | Transportå±‚æ”¹é€  | ç¡®ä¿ä¼ é€’Context | 1å°æ—¶ |
| 9 | è®¤è¯æœåŠ¡æ”¹é€  | auth.goç™»å½•é€»è¾‘ | 1å°æ—¶ |
| 10 | åˆå§‹åŒ–æ”¹é€  | æ‰€æœ‰main.go | 30åˆ†é’Ÿ |
| 11 | æ•°æ®è¿ç§»è„šæœ¬ | migrate_to_physical_isolation.js | 1å°æ—¶ |

---

## ğŸ”§ Repositoryå±‚æ”¹é€ æ¨¡æ¿

### æ ‡å‡†æ”¹é€ æ­¥éª¤

ä»¥ `admin.go` ä¸ºæ¨¡æ¿ï¼Œå…¶ä»–RepositoryæŒ‰ä»¥ä¸‹æ­¥éª¤æ”¹é€ ï¼š

#### 1. æ·»åŠ å¯¼å…¥

```go
import (
    "context"
    "mule-cloud/core/database"
    tenantCtx "mule-cloud/core/context"  // âœ… æ–°å¢
    "mule-cloud/internal/models"
    // ...
)
```

#### 2. ä¿®æ”¹Repositoryç»“æ„ä½“

```go
// âŒ æ—§ä»£ç 
type xxxRepository struct {
    collection *mongo.Collection
}

func NewXXXRepository() XXXRepository {
    collection := database.MongoDB.Collection("xxx")
    return &xxxRepository{
        collection: collection,
    }
}

// âœ… æ–°ä»£ç 
type xxxRepository struct {
    dbManager *database.DatabaseManager
}

func NewXXXRepository() XXXRepository {
    return &xxxRepository{
        dbManager: database.GetDatabaseManager(),
    }
}

// æ·»åŠ getCollectionæ–¹æ³•
func (r *xxxRepository) getCollection(ctx context.Context) *mongo.Collection {
    tenantID := tenantCtx.GetTenantID(ctx)
    db := r.dbManager.GetDatabase(tenantID)
    return db.Collection("xxx")  // xxxä¸ºé›†åˆå
}
```

#### 3. ä¿®æ”¹æ‰€æœ‰æ–¹æ³•

å°†æ‰€æœ‰æ–¹æ³•ä¸­çš„ `r.collection` æ›¿æ¢ä¸º `r.getCollection(ctx)`ï¼š

```go
// âŒ æ—§ä»£ç 
func (r *xxxRepository) Get(ctx context.Context, id string) (*models.XXX, error) {
    filter := bson.M{"_id": id}
    result := &models.XXX{}
    err := r.collection.FindOne(ctx, filter).Decode(result)
    // ...
}

// âœ… æ–°ä»£ç 
func (r *xxxRepository) Get(ctx context.Context, id string) (*models.XXX, error) {
    collection := r.getCollection(ctx)  // âœ… æ–°å¢è¿™ä¸€è¡Œ
    filter := bson.M{"_id": id}
    result := &models.XXX{}
    err := collection.FindOne(ctx, filter).Decode(result)  // âœ… ä½¿ç”¨collection
    // ...
}
```

#### 4. ç‰¹æ®Šå¤„ç†ï¼šTenantRepository

`tenant.go` éœ€è¦å›ºå®šä½¿ç”¨ç³»ç»Ÿæ•°æ®åº“ï¼š

```go
// tenant.go ç‰¹æ®Šå¤„ç†
type tenantRepository struct {
    dbManager *database.DatabaseManager
}

// âœ… ç§Ÿæˆ·æ•°æ®å›ºå®šä½¿ç”¨ç³»ç»Ÿæ•°æ®åº“
func (r *tenantRepository) getCollection() *mongo.Collection {
    db := r.dbManager.GetSystemDatabase()  // å›ºå®šä½¿ç”¨ç³»ç»Ÿåº“
    return db.Collection("tenant")
}

// æ‰€æœ‰æ–¹æ³•ç›´æ¥è°ƒç”¨ r.getCollection() è€Œä¸æ˜¯ r.getCollection(ctx)
func (r *tenantRepository) Get(ctx context.Context, id string) (*models.Tenant, error) {
    collection := r.getCollection()  // ä¸éœ€è¦ctxå‚æ•°
    // ...
}
```

---

## ğŸ¯ Serviceå±‚æ”¹é€ æ¨¡æ¿

### æ ‡å‡†æ”¹é€ æ­¥éª¤

#### 1. åˆ é™¤æ‰€æœ‰tenant_idç›¸å…³è¿‡æ»¤

```go
// âŒ æ—§ä»£ç 
func (s *AdminService) List(req dto.AdminListRequest) ([]models.Admin, int64, error) {
    ctx := context.Background()
    filter := bson.M{"is_deleted": 0}
    
    if req.TenantID != "" {
        filter["tenant_id"] = req.TenantID  // âŒ åˆ é™¤
    }
    
    total, err := s.repo.Count(ctx, filter)
    // ...
}

// âœ… æ–°ä»£ç 
func (s *AdminService) List(ctx context.Context, req dto.AdminListRequest) ([]models.Admin, int64, error) {
    // âœ… Contextä½œä¸ºå‚æ•°ä¼ å…¥
    filter := bson.M{"is_deleted": 0}
    // âŒ åˆ é™¤tenant_idè¿‡æ»¤ï¼ŒRepositoryä¼šè‡ªåŠ¨å¤„ç†
    
    total, err := s.repo.Count(ctx, filter)
    // ...
}
```

#### 2. åˆ›å»ºè®°å½•æ—¶åˆ é™¤TenantID

```go
// âŒ æ—§ä»£ç 
func (s *AdminService) Create(req dto.AdminCreateRequest) (*models.Admin, error) {
    ctx := context.Background()
    admin := &models.Admin{
        TenantID: req.TenantID,  // âŒ åˆ é™¤
        Phone:    req.Phone,
        // ...
    }
    // ...
}

// âœ… æ–°ä»£ç 
func (s *AdminService) Create(ctx context.Context, req dto.AdminCreateRequest) (*models.Admin, error) {
    // âœ… Contextä½œä¸ºå‚æ•°ä¼ å…¥
    admin := &models.Admin{
        Phone:    req.Phone,
        // ...
    }
    err := s.repo.Create(ctx, admin)  // âœ… ä¼ é€’Context
    // ...
}
```

#### 3. ç‰¹æ®Šï¼šTenantServiceåˆ›å»ºç§Ÿæˆ·

```go
// âœ… ç§Ÿæˆ·Serviceéœ€è¦åˆ›å»ºç§Ÿæˆ·æ•°æ®åº“
func (s *TenantService) Create(ctx context.Context, req dto.TenantCreateRequest) (*models.Tenant, error) {
    // 1. åˆ›å»ºç§Ÿæˆ·è®°å½•ï¼ˆç³»ç»Ÿåº“ï¼‰
    tenant := &models.Tenant{
        Code: req.Code,
        Name: req.Name,
        // ...
    }
    
    // Contextä½¿ç”¨ç©ºç§Ÿæˆ·IDï¼ˆç³»ç»Ÿåº“ï¼‰
    systemCtx := tenantCtx.WithTenantID(ctx, "")
    err := s.repo.Create(systemCtx, tenant)
    if err != nil {
        return nil, err
    }
    
    // âœ… 2. åˆ›å»ºç§Ÿæˆ·ä¸“å±æ•°æ®åº“
    dbManager := database.GetDatabaseManager()
    err = dbManager.CreateTenantDatabase(ctx, tenant.ID)
    if err != nil {
        // å›æ»šï¼šåˆ é™¤ç§Ÿæˆ·è®°å½•
        s.repo.HardDelete(systemCtx, tenant.ID)
        return nil, fmt.Errorf("åˆ›å»ºç§Ÿæˆ·æ•°æ®åº“å¤±è´¥: %v", err)
    }
    
    // âœ… 3. åœ¨ç§Ÿæˆ·æ•°æ®åº“åˆ›å»ºç§Ÿæˆ·ç®¡ç†å‘˜
    tenantCtx := tenantCtx.WithTenantID(ctx, tenant.ID)
    adminService := NewAdminService()
    _, err = adminService.Create(tenantCtx, dto.AdminCreateRequest{
        Phone:    req.AdminPhone,
        Password: req.AdminPassword,
        Nickname: "ç§Ÿæˆ·ç®¡ç†å‘˜",
        Roles:    []string{"tenant_admin"},
        Status:   1,
    })
    if err != nil {
        // å›æ»š
        dbManager.DeleteTenantDatabase(ctx, tenant.ID)
        s.repo.HardDelete(systemCtx, tenant.ID)
        return nil, fmt.Errorf("åˆ›å»ºç§Ÿæˆ·ç®¡ç†å‘˜å¤±è´¥: %v", err)
    }
    
    return tenant, nil
}
```

---

## ğŸ“ DTOå±‚æ”¹é€ 

### åˆ é™¤æ‰€æœ‰tenant_idå­—æ®µ

```go
// app/system/dto/admin.go
// âŒ æ—§ä»£ç 
type AdminListRequest struct {
    Page     int64  `json:"page" form:"page"`
    PageSize int64  `json:"page_size" form:"page_size"`
    TenantID string `json:"tenant_id" form:"tenant_id"`  // âŒ åˆ é™¤
    // ...
}

type AdminCreateRequest struct {
    Phone    string `json:"phone" binding"required"`
    TenantID string `json:"tenant_id"`  // âŒ åˆ é™¤
    // ...
}

// âœ… æ–°ä»£ç ï¼ˆç›´æ¥åˆ é™¤tenant_idå­—æ®µï¼‰
type AdminListRequest struct {
    Page     int64  `json:"page" form:"page"`
    PageSize int64  `json:"page_size" form:"page_size"`
    // ...
}

type AdminCreateRequest struct {
    Phone string `json:"phone" binding"required"`
    // ...
}
```

---

## ğŸš€ Transportå±‚æ”¹é€ 

### ç¡®ä¿ä¼ é€’Context

```go
// app/system/transport/admin.go
// âŒ æ—§ä»£ç 
func ListAdminHandler(svc services.IAdminService) endpoint.Endpoint {
    return func(ctx context.Context, request interface{}) (interface{}, error) {
        req := request.(dto.AdminListRequest)
        admins, total, err := svc.List(req)  // âŒ æ²¡æœ‰ä¼ Context
        // ...
    }
}

// âœ… æ–°ä»£ç 
func ListAdminHandler(svc services.IAdminService) endpoint.Endpoint {
    return func(ctx context.Context, request interface{}) (interface{}, error) {
        req := request.(dto.AdminListRequest)
        admins, total, err := svc.List(ctx, req)  // âœ… ä¼ é€’Context
        // ...
    }
}
```

---

## ğŸ” è®¤è¯æœåŠ¡æ”¹é€ 

### ç™»å½•è·¨åº“æŸ¥è¯¢

```go
// app/auth/services/auth.go
func (s *AuthService) Login(ctx context.Context, phone, password string) (*dto.LoginResponse, error) {
    var admin *models.Admin
    var targetTenantID string
    
    // 1. å…ˆåœ¨ç³»ç»Ÿåº“æŸ¥æ‰¾ï¼ˆç³»ç»Ÿè¶…ç®¡ï¼‰
    systemCtx := tenantCtx.WithTenantID(ctx, "")
    admin, err := s.repo.GetByPhone(systemCtx, phone)
    
    if admin == nil {
        // âœ… 2. æœªæ‰¾åˆ°ï¼ŒæŸ¥è¯¢æ‰‹æœºå·æ˜ å°„è¡¨
        mapping, err := s.getMappingByPhone(systemCtx, phone)
        if err == nil && mapping != nil {
            // æ‰¾åˆ°æ˜ å°„ï¼Œç›´æ¥åœ¨å¯¹åº”ç§Ÿæˆ·åº“æŸ¥è¯¢
            tenantCtx := tenantCtx.WithTenantID(ctx, mapping.TenantID)
            admin, _ = s.repo.GetByPhone(tenantCtx, phone)
            targetTenantID = mapping.TenantID
        } else {
            // âœ… 3. å…œåº•æ–¹æ¡ˆï¼šéå†æ‰€æœ‰ç§Ÿæˆ·åº“æŸ¥æ‰¾ï¼ˆæ€§èƒ½è¾ƒå·®ï¼Œå»ºè®®å»ºæ˜ å°„è¡¨ï¼‰
            tenants, _ := s.tenantRepo.FindAll(systemCtx)
            for _, tenant := range tenants {
                tenantCtx := tenantCtx.WithTenantID(ctx, tenant.ID)
                admin, _ = s.repo.GetByPhone(tenantCtx, phone)
                if admin != nil {
                    targetTenantID = tenant.ID
                    break
                }
            }
        }
    }
    
    if admin == nil {
        return nil, errors.New("ç”¨æˆ·ä¸å­˜åœ¨")
    }
    
    // 4. éªŒè¯å¯†ç 
    if !util.CheckPassword(password, admin.Password) {
        return nil, errors.New("å¯†ç é”™è¯¯")
    }
    
    // 5. ç”ŸæˆJWT Token
    token, err := s.jwtManager.GenerateToken(
        admin.ID, 
        admin.Nickname, 
        targetTenantID,  // ç§Ÿæˆ·ID
        admin.Roles,
    )
    
    return &dto.LoginResponse{
        Token:    token,
        UserInfo: admin,
    }, nil
}
```

### æ€§èƒ½ä¼˜åŒ–ï¼šæ‰‹æœºå·æ˜ å°„è¡¨

```go
// internal/models/phone_mapping.go (æ–°å»º)
package models

// PhoneToTenant æ‰‹æœºå·ç§Ÿæˆ·æ˜ å°„è¡¨ï¼ˆç³»ç»Ÿåº“ï¼‰
type PhoneToTenant struct {
    Phone    string `bson:"_id" json:"phone"`         // æ‰‹æœºå·ä½œä¸ºä¸»é”®
    TenantID string `bson:"tenant_id" json:"tenant_id"` // ç§Ÿæˆ·ID
}

func (PhoneToTenant) TableName() string {
    return "phone_to_tenant"
}
```

```go
// app/auth/services/auth.go
func (s *AuthService) getMappingByPhone(ctx context.Context, phone string) (*models.PhoneToTenant, error) {
    // ä»ç³»ç»Ÿåº“æŸ¥è¯¢æ˜ å°„è¡¨
    collection := s.dbManager.GetSystemDatabase().Collection("phone_to_tenant")
    mapping := &models.PhoneToTenant{}
    err := collection.FindOne(ctx, bson.M{"_id": phone}).Decode(mapping)
    if err != nil {
        return nil, err
    }
    return mapping, nil
}

// æ³¨å†Œæ—¶æ·»åŠ æ˜ å°„
func (s *AuthService) Register(ctx context.Context, req dto.RegisterRequest) error {
    // 1. åˆ›å»ºç”¨æˆ·...
    
    // 2. æ·»åŠ æ‰‹æœºå·æ˜ å°„
    tenantID := tenantCtx.GetTenantID(ctx)
    if tenantID != "" {
        mapping := &models.PhoneToTenant{
            Phone:    req.Phone,
            TenantID: tenantID,
        }
        collection := s.dbManager.GetSystemDatabase().Collection("phone_to_tenant")
        collection.InsertOne(ctx, mapping)
    }
    
    return nil
}
```

---

## ğŸ¬ åˆå§‹åŒ–æ”¹é€ 

### æ‰€æœ‰main.goæ·»åŠ DatabaseManageråˆå§‹åŒ–

```go
// cmd/system/main.go (æ‰€æœ‰æœåŠ¡çš„main.goéƒ½éœ€è¦ç±»ä¼¼æ”¹é€ )
func main() {
    // 1. åŠ è½½é…ç½®
    cfg := config.Get()
    
    // 2. åˆå§‹åŒ–æ—¥å¿—
    logger.InitLogger(&cfg.Log)
    
    // 3. åˆå§‹åŒ–MongoDBå®¢æˆ·ç«¯
    client, err := database.InitMongoDB(&cfg.MongoDB)
    if err != nil {
        log.Fatalf("âŒ åˆå§‹åŒ–MongoDBå¤±è´¥: %v", err)
    }
    defer database.CloseMongoDB()
    
    // âœ… 4. åˆå§‹åŒ–æ•°æ®åº“ç®¡ç†å™¨ï¼ˆæ–°å¢ï¼‰
    database.InitDatabaseManager(client)
    log.Println("âœ… æ•°æ®åº“ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ")
    
    // 5. åˆå§‹åŒ–Redis
    // ...
    
    // 6. å¯åŠ¨æœåŠ¡
    // ...
}
```

éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶ï¼š
- `cmd/system/main.go`
- `cmd/basic/main.go`
- `cmd/auth/main.go`
- `cmd/gateway/main.go`

---

## ğŸ“Š æ•°æ®è¿ç§»

### è¿ç§»è„šæœ¬

åœ¨MongoDB Shellä¸­æ‰§è¡Œï¼š

```javascript
// scripts/migrate_to_physical_isolation.js
// ç”¨æ³•ï¼šmongo --host 127.0.0.1 --port 27015 -u root -p bgg8384495 --authenticationDatabase admin mule scripts/migrate_to_physical_isolation.js

const sourceDB = db.getSiblingDB("mule");
const systemDB = db.getSiblingDB("tenant_system");

print("=== å¼€å§‹æ•°æ®è¿ç§» ===");
print(`æºæ•°æ®åº“: mule`);
print(`ç›®æ ‡ç³»ç»Ÿåº“: tenant_system`);
print("");

// 1. è¿ç§»ç§Ÿæˆ·æ•°æ®åˆ°ç³»ç»Ÿåº“
print("[1/5] è¿ç§»ç§Ÿæˆ·æ•°æ®...");
const tenants = sourceDB.tenant.find({ is_deleted: 0 }).toArray();
print(`  æ‰¾åˆ° ${tenants.length} ä¸ªç§Ÿæˆ·`);

if (tenants.length > 0) {
    systemDB.tenant.insertMany(tenants);
    print(`  âœ… ç§Ÿæˆ·æ•°æ®è¿ç§»å®Œæˆ`);
}

// 2. è¿ç§»ç³»ç»Ÿè¶…ç®¡åˆ°ç³»ç»Ÿåº“
print("\n[2/5] è¿ç§»ç³»ç»Ÿè¶…ç®¡...");
const superAdmins = sourceDB.admin.find({ 
    tenant_id: { $in: ["", null] },
    role: { $in: ["super"] },
    is_deleted: 0 
}).toArray();

print(`  æ‰¾åˆ° ${superAdmins.length} ä¸ªç³»ç»Ÿè¶…ç®¡`);
superAdmins.forEach(admin => {
    delete admin.tenant_id;
});

if (superAdmins.length > 0) {
    systemDB.admin.insertMany(superAdmins);
    print(`  âœ… ç³»ç»Ÿè¶…ç®¡è¿ç§»å®Œæˆ`);
}

// 3. ä¸ºæ¯ä¸ªç§Ÿæˆ·åˆ›å»ºç‹¬ç«‹æ•°æ®åº“
print("\n[3/5] ä¸ºæ¯ä¸ªç§Ÿæˆ·åˆ›å»ºç‹¬ç«‹æ•°æ®åº“...");
tenants.forEach((tenant, index) => {
    const tenantID = tenant._id.toString();
    const tenantDBName = `tenant_${tenantID}`;
    const tenantDB = db.getSiblingDB(tenantDBName);
    
    print(`\n  [${index + 1}/${tenants.length}] å¤„ç†ç§Ÿæˆ·: ${tenant.name} (${tenantID})`);
    
    // éœ€è¦è¿ç§»çš„é›†åˆ
    const collections = [
        "admin", "role", "menu", "basic", 
        "color", "customer", "order_type", 
        "procedure", "salesman", "size"
    ];
    
    collections.forEach(collName => {
        const filter = { tenant_id: tenantID, is_deleted: 0 };
        const docs = sourceDB[collName].find(filter).toArray();
        
        if (docs.length > 0) {
            // åˆ é™¤ tenant_id å­—æ®µ
            docs.forEach(doc => {
                delete doc.tenant_id;
            });
            
            tenantDB[collName].insertMany(docs);
            print(`    âœ… ${collName}: ${docs.length} æ¡`);
        }
    });
    
    // åˆ›å»ºç´¢å¼•
    tenantDB.admin.createIndex({ phone: 1 }, { unique: true, sparse: true });
    tenantDB.admin.createIndex({ is_deleted: 1 });
    tenantDB.role.createIndex({ code: 1 }, { unique: true });
    tenantDB.menu.createIndex({ name: 1 });
    
    print(`  âœ… ç§Ÿæˆ·æ•°æ®åº“åˆ›å»ºå®Œæˆ`);
});

// 4. åˆ›å»ºæ‰‹æœºå·æ˜ å°„è¡¨
print("\n[4/5] åˆ›å»ºæ‰‹æœºå·æ˜ å°„è¡¨...");
const allAdmins = sourceDB.admin.find({ 
    tenant_id: { $ne: "", $exists: true },
    is_deleted: 0 
}).toArray();

if (allAdmins.length > 0) {
    const mappings = [];
    allAdmins.forEach(admin => {
        if (admin.phone) {
            mappings.push({
                _id: admin.phone,
                tenant_id: admin.tenant_id
            });
        }
    });
    
    if (mappings.length > 0) {
        systemDB.phone_to_tenant.insertMany(mappings, { ordered: false });
        print(`  âœ… åˆ›å»º ${mappings.length} æ¡æ˜ å°„è®°å½•`);
    }
}

// 5. éªŒè¯è¿ç§»ç»“æœ
print("\n[5/5] éªŒè¯è¿ç§»ç»“æœ...");
let allSuccess = true;

// éªŒè¯ç§Ÿæˆ·æ•°é‡
const sourceTenantCount = sourceDB.tenant.countDocuments({ is_deleted: 0 });
const systemTenantCount = systemDB.tenant.countDocuments({ is_deleted: 0 });
print(`  ç§Ÿæˆ·æ•°é‡: åŸåº“ ${sourceTenantCount} vs ç³»ç»Ÿåº“ ${systemTenantCount}`);
if (sourceTenantCount !== systemTenantCount) {
    print("  âŒ ç§Ÿæˆ·æ•°é‡ä¸åŒ¹é…ï¼");
    allSuccess = false;
}

// éªŒè¯æ¯ä¸ªç§Ÿæˆ·çš„æ•°æ®
tenants.forEach(tenant => {
    const tenantID = tenant._id.toString();
    const tenantDBName = `tenant_${tenantID}`;
    const tenantDB = db.getSiblingDB(tenantDBName);
    
    const collections = ["admin", "role", "menu"];
    collections.forEach(collName => {
        const sourceCount = sourceDB[collName].countDocuments({ 
            tenant_id: tenantID, 
            is_deleted: 0 
        });
        const tenantCount = tenantDB[collName].countDocuments({ is_deleted: 0 });
        
        if (sourceCount !== tenantCount) {
            print(`  âŒ ç§Ÿæˆ· ${tenant.name} - ${collName}: åŸåº“ ${sourceCount} vs ç§Ÿæˆ·åº“ ${tenantCount}`);
            allSuccess = false;
        }
    });
});

print("\n=== è¿ç§»å®Œæˆ ===");
if (allSuccess) {
    print("âœ… æ‰€æœ‰æ•°æ®éªŒè¯é€šè¿‡ï¼");
    print("\nâš ï¸  è¯·åœ¨æ–°ç³»ç»Ÿç¨³å®šè¿è¡Œåå†åˆ é™¤åŸæ•°æ®åº“ï¼");
    print("åˆ é™¤å‘½ä»¤ï¼š");
    print("  use mule");
    print("  db.dropDatabase()");
} else {
    print("âŒ æ•°æ®éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¿ç§»è„šæœ¬ï¼");
}
```

### æ‰§è¡Œè¿ç§»

```powershell
# Windows PowerShell
# è¿æ¥åˆ°Dockerä¸­çš„MongoDB
docker exec -it <mongodb-container-name> mongo --host 127.0.0.1 --port 27017 -u root -p bgg8384495 --authenticationDatabase admin mule /scripts/migrate_to_physical_isolation.js

# æˆ–è€…ä»å®¿ä¸»æœºæ‰§è¡Œ
mongo --host 127.0.0.1 --port 27015 -u root -p bgg8384495 --authenticationDatabase admin mule < K:\Git\mule-cloud\scripts\migrate_to_physical_isolation.js
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. MongoDB Dockeré…ç½®

ç¡®ä¿ä½ çš„`docker-compose.yml`æˆ–MongoDBé…ç½®åŒ…å«ï¼š

```yaml
mongodb:
  image: mongo:latest
  ports:
    - "27015:27017"
  environment:
    MONGO_INITDB_ROOT_USERNAME: root
    MONGO_INITDB_ROOT_PASSWORD: bgg8384495
  volumes:
    - ./scripts:/scripts  # æŒ‚è½½è„šæœ¬ç›®å½•
```

### 2. é…ç½®æ–‡ä»¶æ›´æ–°

`config/*.yaml` ä¿æŒä¸å˜ï¼ŒDatabaseManagerä¼šè‡ªåŠ¨ç®¡ç†å¤šä¸ªæ•°æ®åº“ï¼š

```yaml
mongodb:
  enabled: true
  host: "127.0.0.1"
  port: 27015
  username: "root"
  password: "bgg8384495"
  database: "mule"  # è¿™ä¸ªé…ç½®å®é™…ä¸Šä¸å†ä½¿ç”¨ï¼Œä½†ä¿ç•™é¿å…æŠ¥é”™
  auth_source: "admin"
```

### 3. æ€§èƒ½è€ƒè™‘

- âœ… å»ºç«‹æ‰‹æœºå·æ˜ å°„è¡¨åŠ é€Ÿç™»å½•
- âœ… ä½¿ç”¨è¿æ¥æ± å¤ç”¨
- âœ… æ‡’åŠ è½½ç§Ÿæˆ·æ•°æ®åº“
- âœ… å®šæœŸæ¸…ç†ä¸æ´»è·ƒè¿æ¥ï¼š`dbManager.CleanupInactiveDatabases()`

### 4. å®‰å…¨è€ƒè™‘

- âœ… ç³»ç»Ÿè¶…ç®¡å›ºå®šä½¿ç”¨ç³»ç»Ÿåº“ï¼ˆtenant_idä¸ºç©ºï¼‰
- âœ… æ™®é€šç§Ÿæˆ·ç”¨æˆ·æ— æ³•è®¿é—®ç³»ç»Ÿåº“
- âœ… ç§Ÿæˆ·Aç”¨æˆ·æ— æ³•è®¿é—®ç§Ÿæˆ·Bæ•°æ®åº“
- âœ… JWT Tokenä¸­çš„tenant_idä¸å¯ä¼ªé€ 

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. å•å…ƒæµ‹è¯•

```go
// internal/repository/admin_test.go
func TestAdminRepository_MultiTenant(t *testing.T) {
    ctx := context.Background()
    repo := NewAdminRepository()
    
    // æµ‹è¯•ç§Ÿæˆ·A
    ctxA := tenantCtx.WithTenantID(ctx, "tenant_a")
    adminA := &models.Admin{Phone: "13800138000", Nickname: "ç§Ÿæˆ·Aç”¨æˆ·"}
    repo.Create(ctxA, adminA)
    
    // æµ‹è¯•ç§Ÿæˆ·B
    ctxB := tenantCtx.WithTenantID(ctx, "tenant_b")
    adminB := &models.Admin{Phone: "13900139000", Nickname: "ç§Ÿæˆ·Bç”¨æˆ·"}
    repo.Create(ctxB, adminB)
    
    // éªŒè¯éš”ç¦»ï¼šç§Ÿæˆ·Açœ‹ä¸åˆ°ç§Ÿæˆ·Bçš„æ•°æ®
    adminsA, _ := repo.Find(ctxA, bson.M{})
    assert.Equal(t, 1, len(adminsA))
    assert.Equal(t, "ç§Ÿæˆ·Aç”¨æˆ·", adminsA[0].Nickname)
}
```

### 2. é›†æˆæµ‹è¯•

```bash
# 1. åˆ›å»ºç§Ÿæˆ·
curl -X POST http://localhost:8080/tenant/create \
  -H "Authorization: Bearer {super_admin_token}" \
  -d '{"code":"TEST","name":"æµ‹è¯•ç§Ÿæˆ·","admin_phone":"13800138000","admin_password":"123456"}'

# 2. éªŒè¯æ•°æ®åº“åˆ›å»º
mongo --host 127.0.0.1 --port 27015 -u root -p bgg8384495 --authenticationDatabase admin
> show dbs
tenant_system
tenant_xxx  # æ–°åˆ›å»ºçš„ç§Ÿæˆ·æ•°æ®åº“

# 3. ç§Ÿæˆ·ç®¡ç†å‘˜ç™»å½•
curl -X POST http://localhost:8080/auth/login \
  -d '{"phone":"13800138000","password":"123456"}'

# 4. CRUDæ“ä½œéªŒè¯æ•°æ®éš”ç¦»
```

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [æ•°æ®åº“çº§åˆ«ç§Ÿæˆ·éš”ç¦»æ”¹é€ æ–¹æ¡ˆ](./æ•°æ®åº“çº§åˆ«ç§Ÿæˆ·éš”ç¦»æ”¹é€ æ–¹æ¡ˆ.md) - å®Œæ•´æ–¹æ¡ˆ
- [MongoDB Multi-Tenancy](https://www.mongodb.com/basics/multi-tenancy)
- [Go Contextæœ€ä½³å®è·µ](https://go.dev/blog/context)

---

**æ›´æ–°æ—¶é—´ï¼š** 2025-10-02  
**ä½œè€…ï¼š** Mule-Cloud å›¢é˜Ÿ

