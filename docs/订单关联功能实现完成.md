# 订单关联功能实现完成

## 📋 功能概述

实现了订单复制时的关联功能，用户可以选择是否将新订单与原订单建立关联关系，并指定关联类型。

---

## ✨ 功能特性

### 1. 复制订单时的选项

**关联设置：**
- ✅ **关联原订单** - 建立父子关系，便于追踪
- ✅ **独立订单** - 不建立关联，独立管理

**关联类型：**
- 📦 **追加订单** (add) - 客户增加数量时使用，合同号添加 `-A` 后缀
- 📋 **复制订单** (copy) - 重复下单时使用，合同号添加 `-C` 后缀

**关联说明：**
- 可选填写，说明追加原因或备注信息
- 如不填写，系统自动生成说明文字

### 2. 合同号命名规则

```
原订单：202510067553

┌─ 关联追加订单：202510067553-A1234
│  （客户要求追加数量）
│
├─ 关联复制订单：202510067553-C5678
│  （重复下单）
│
└─ 独立订单：202510067553-copy-1728838400
   （不关联）
```

---

## 🎨 用户界面

### 复制订单弹窗

```
┌────────────── 复制订单 ───────────────┐
│                                       │
│ 是否关联：[●开] 关联原订单 [○关] 独立订单 │
│                                       │
│ ─────── 选择关联时显示 ─────────      │
│                                       │
│ 关联类型：                             │
│   ○ 追加订单（客户增加数量）            │
│   ● 复制订单（重复下单）               │
│                                       │
│ 关联说明：                             │
│ ┌─────────────────────────────┐     │
│ │ 选填，可说明追加原因或备注...  │     │
│ │                             │     │
│ └─────────────────────────────┘     │
│                                       │
│ ℹ️ 复制订单：新订单将关联原订单，      │
│   合同号自动添加"-C"后缀，保留关联关系。│
│                                       │
│              [取消]    [确认复制]     │
└───────────────────────────────────────┘
```

### 使用流程

1. **找到要复制的订单**
2. **点击"复制"按钮** → 弹出关联设置窗口
3. **选择关联方式**：
   - 开启"关联原订单"开关
   - 选择"追加订单"或"复制订单"
   - 可选填写关联说明
4. **点击"确认复制"** → 创建新订单
5. **新订单特点**：
   - 合同号自动添加后缀
   - 包含父订单ID和关联类型
   - 自动生成或使用用户填写的关联说明

---

## 💾 数据模型

### Order 模型新增字段

```go
type Order struct {
    // ...原有字段
    
    // 订单关联关系
    ParentOrderID   string `json:"parent_order_id" bson:"parent_order_id"`     // 父订单ID
    RelationType    string `json:"relation_type" bson:"relation_type"`         // 关联类型：copy/add
    RelationRemark  string `json:"relation_remark" bson:"relation_remark"`     // 关联说明
}
```

### 关联类型说明

| 类型 | 值 | 用途 | 合同号后缀 | 说明 |
|------|------|------|-----------|------|
| 追加订单 | `add` | 客户追加数量 | `-A{时间戳}` | 原订单202510067553-A1234 |
| 复制订单 | `copy` | 重复下单 | `-C{时间戳}` | 原订单202510067553-C5678 |
| 独立订单 | - | 无关联 | `-copy-{时间戳}` | 原订单202510067553-copy-1728838400 |

---

## 🔧 API 接口

### 复制订单 API

**请求：**
```http
POST /order/orders/:id/copy

Content-Type: application/json

{
  "is_related": true,
  "relation_type": "add",
  "relation_remark": "客户要求追加200件"
}
```

**响应：**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "order": {
      "id": "新订单ID",
      "contract_no": "202510067553-A1234",
      "parent_order_id": "原订单ID",
      "relation_type": "add",
      "relation_remark": "客户要求追加200件",
      // ...其他字段
    }
  }
}
```

**参数说明：**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| is_related | boolean | 否 | 是否关联原订单，默认false |
| relation_type | string | 否 | 关联类型：add-追加 copy-复制 |
| relation_remark | string | 否 | 关联说明，不填自动生成 |

---

## 📊 实际应用场景

### 场景1：客户追加订单

**背景：**
- 原订单：合同号202510067553，1000件，已生产500件
- 客户要求：追加200件

**操作步骤：**
1. 点击原订单的"复制"按钮
2. 开启"关联原订单"
3. 选择"追加订单"
4. 填写说明："客户追加200件"
5. 确认复制

**结果：**
```
原订单：202510067553
├─ 数量：1000件
├─ 已生产：500件
└─ 状态：生产中

追加订单：202510067553-A1234
├─ 数量：200件（修改为实际追加数量）
├─ 父订单ID：原订单ID
├─ 关联类型：add
├─ 关联说明："客户追加200件"
└─ 状态：草稿（可直接创建裁剪任务）
```

### 场景2：重复下单

**背景：**
- 原订单：合同号202510067553，1000件，已完成
- 客户要求：重新下一模一样的订单

**操作步骤：**
1. 点击原订单的"复制"按钮
2. 开启"关联原订单"
3. 选择"复制订单"
4. 确认复制

**结果：**
```
原订单：202510067553
└─ 状态：已完成

复制订单：202510067553-C5678
├─ 数量：1000件（与原订单相同）
├─ 父订单ID：原订单ID
├─ 关联类型：copy
└─ 关联说明："从订单202510067553复制"
```

### 场景3：独立订单

**背景：**
- 想复制订单结构，但作为全新的独立订单

**操作步骤：**
1. 点击原订单的"复制"按钮
2. 关闭"关联原订单"开关
3. 确认复制

**结果：**
```
独立订单：202510067553-copy-1728838400
├─ 父订单ID：空
├─ 关联类型：空
└─ 完全独立于原订单
```

---

## 📈 后续扩展建议

### 1. 订单详情显示关联关系

在订单详情页面显示：

```
┌─────────────────────────────┐
│ 订单关联信息                 │
├─────────────────────────────┤
│ 📦 追加订单                  │
│ 原订单：202510067553         │
│ 追加说明：客户要求追加200件   │
│                             │
│ [查看原订单]                 │
└─────────────────────────────┘
```

### 2. 关联订单列表

在订单列表中增加"查看关联"功能：

```
┌─────────────────────────────┐
│ 订单 202510067553 的关联订单 │
├─────────────────────────────┤
│ ├─ 202510067553-A1234 (追加) │
│ ├─ 202510067553-A2345 (追加) │
│ └─ 202510067553-C3456 (复制) │
│                             │
│ 合计数量：1400件             │
└─────────────────────────────┘
```

### 3. 统计报表优化

可以按关联关系汇总统计：

```sql
-- 查询某订单及其所有关联订单
SELECT * FROM orders 
WHERE id = '订单ID' 
   OR parent_order_id = '订单ID'
ORDER BY created_at

-- 统计某订单系列的总数量
SELECT 
  contract_no, 
  COUNT(*) as order_count,
  SUM(quantity) as total_quantity
FROM orders
WHERE contract_no LIKE '202510067553%'
  AND is_deleted = 0
```

### 4. 关联关系图

可视化显示订单的关联树：

```
202510067553 (1000件)
  ├─ 202510067553-A1234 (200件) [追加]
  ├─ 202510067553-A2345 (150件) [追加]
  └─ 202510067553-C3456 (1000件) [复制]
      └─ 202510067553-C3456-A7890 (100件) [追加]
```

---

## 🎯 使用建议

### 什么时候选择"追加订单"？

✅ 适用场景：
- 客户在原订单基础上增加数量
- 需要统计原订单+追加的总量
- 希望保留订单之间的关联关系

### 什么时候选择"复制订单"？

✅ 适用场景：
- 客户重复下同样的订单
- 需要记录是从哪个订单复制的
- 定期重复的订单

### 什么时候选择"独立订单"？

✅ 适用场景：
- 只是想快速复制订单结构
- 新订单与原订单没有业务关系
- 不需要关联追踪

---

## 🔍 数据查询示例

### 查询某订单的所有追加订单

```javascript
// 前端
const parentOrderId = '订单ID';
const orders = await fetchOrderList({
  parent_order_id: parentOrderId,
  relation_type: 'add'
});
```

### 查询某订单系列的总数量

```javascript
// 根据合同号前缀查询
const contractNoPrefix = '202510067553';
const orders = await fetchOrderList({
  contract_no: contractNoPrefix
});

const totalQuantity = orders.reduce((sum, order) => sum + order.quantity, 0);
```

---

## ✅ 实现清单

- [x] 数据模型扩展（ParentOrderID, RelationType, RelationRemark）
- [x] 后端API支持关联参数
- [x] Service层实现关联逻辑
- [x] Endpoint和Transport层更新
- [x] 前端复制弹窗UI
- [x] 前端关联选项和说明
- [x] 合同号自动命名规则
- [x] API接口调用更新
- [ ] 订单详情显示关联信息（后续）
- [ ] 关联订单列表查询（后续）
- [ ] 统计报表关联支持（后续）

---

## 📝 总结

通过订单关联功能，系统现在可以：

1. ✅ **清晰区分**追加订单、复制订单和独立订单
2. ✅ **自动命名**合同号，便于识别和管理
3. ✅ **保留关系**父子订单关联，便于追溯
4. ✅ **灵活选择**关联与否，适应不同业务场景
5. ✅ **用户友好**直观的UI和清晰的说明

这为后续的订单统计、报表分析提供了数据基础！
