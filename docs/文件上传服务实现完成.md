# 文件上传服务实现完成 🎉

## 概述

已成功实现完整的文件上传服务（Common Service），支持多种存储后端，包括本地存储、MinIO、AWS S3、阿里云OSS。该服务提供文件上传、下载、删除、列表查询、预签名URL生成等功能。

## 后端实现

### 1. 存储接口设计

**文件**: `core/storage/interface.go`

设计了统一的存储接口 `Storage`，支持以下操作：
- `Upload`: 上传文件
- `Download`: 下载文件
- `Delete`: 删除文件
- `Exists`: 检查文件是否存在
- `GetURL`: 获取文件访问URL
- `GetPresignedURL`: 获取预签名URL（用于临时访问）

### 2. 存储实现

实现了4种存储后端：

#### 本地存储 (`core/storage/local.go`)
- 将文件存储在本地文件系统
- 支持目录自动创建
- 通过HTTP静态文件服务访问

#### MinIO存储 (`core/storage/minio.go`)
- 支持MinIO对象存储
- 自动创建存储桶
- 支持预签名URL生成

#### AWS S3存储 (`core/storage/s3.go`)
- 支持AWS S3或兼容S3的存储服务
- 支持自定义端点配置
- 支持预签名URL生成

#### 阿里云OSS存储 (`core/storage/oss.go`)
- 支持阿里云OSS对象存储
- 支持预签名URL生成

### 3. 数据模型

**文件**: `internal/models/file.go`

```go
type FileInfo struct {
    ID           primitive.ObjectID
    TenantCode   string  // 租户代码
    FileName     string  // 原始文件名
    FileSize     int64   // 文件大小（字节）
    FileType     string  // 文件类型（MIME类型）
    FileExt      string  // 文件扩展名
    StorageType  string  // 存储类型（local/minio/s3/oss）
    StoragePath  string  // 存储路径
    StorageKey   string  // 存储键（用于对象存储）
    URL          string  // 访问URL
    BusinessType string  // 业务类型（avatar/document/image等）
    UploadBy     string  // 上传人ID
    CreatedAt    time.Time
    UpdatedAt    time.Time
}
```

### 4. Repository层

**文件**: `internal/repository/file.go`

实现了文件元数据的数据库操作：
- 支持多租户数据隔离
- 提供CRUD操作
- 支持分页查询和业务类型过滤

### 5. Service层

**文件**: `app/common/services/file.go`

实现业务逻辑：
- 文件上传验证（大小、类型限制）
- 文件存储路径生成（按租户/业务类型/日期组织）
- 事务性操作（存储失败时回滚数据库记录）
- 支持的文件类型：
  - 图片：jpg, jpeg, png, gif, bmp, webp
  - 文档：pdf, doc, docx, xls, xlsx, ppt, pptx
  - 其他：txt, csv, zip, rar, 7z

### 6. Transport层

**文件**: `app/common/transport/file.go`

提供HTTP API接口：
- `POST /admin/common/files/upload` - 上传文件
- `GET /admin/common/files` - 获取文件列表
- `GET /admin/common/files/:id` - 下载文件
- `DELETE /admin/common/files/:id` - 删除文件
- `GET /admin/common/files/:id/presigned` - 获取预签名URL

### 7. 配置文件

**文件**: `config/common.yaml`

```yaml
# 文件存储配置
storage:
  type: "local"  # 存储类型: local/minio/s3/oss
  
  # 本地存储配置
  local:
    upload_dir: "./uploads"
    base_url: "http://192.168.31.78:8004/files"
  
  # MinIO配置
  minio:
    endpoint: "localhost:9000"
    access_key_id: "minioadmin"
    secret_access_key: "minioadmin"
    bucket_name: "mule-cloud"
    use_ssl: false
    region: "us-east-1"
  
  # S3配置
  s3:
    endpoint: ""  # 留空使用AWS S3
    access_key_id: "your-access-key"
    secret_access_key: "your-secret-key"
    bucket_name: "mule-cloud"
    region: "us-east-1"
  
  # OSS配置
  oss:
    endpoint: "oss-cn-hangzhou.aliyuncs.com"
    access_key_id: "your-access-key"
    access_key_secret: "your-secret-key"
    bucket_name: "mule-cloud"
```

### 8. 服务主程序

**文件**: `cmd/common/main.go`

- 服务端口：8004
- 支持Consul服务注册
- 支持多租户数据库隔离
- 提供健康检查接口
- 提供静态文件访问（本地存储模式）

## 前端实现

### 1. API类型定义

**文件**: `frontend/src/typings/api/common.d.ts`

定义了完整的TypeScript类型：
- `FileInfo` - 文件信息
- `UploadResponse` - 上传响应
- `FileListRequest` - 列表请求
- `FileListResponse` - 列表响应
- `PresignedURLRequest` - 预签名URL请求
- `PresignedURLResponse` - 预签名URL响应

### 2. API服务

**文件**: `frontend/src/service/api/common.ts`

提供API调用方法：
- `uploadFile` - 上传文件
- `fetchFileList` - 获取文件列表
- `downloadFile` - 下载文件
- `deleteFile` - 删除文件
- `getPresignedURL` - 获取预签名URL

### 3. 文件上传组件

**文件**: `frontend/src/components/common/FileUpload.vue`

封装的可复用文件上传组件，特性：
- 支持单文件/多文件上传
- 文件大小验证
- 自定义业务类型
- 支持文件预览
- 支持文件删除
- 上传进度显示
- 错误处理和提示
- 支持三种显示模式：text、image、image-card

## 使用示例

### 后端启动

```bash
go run cmd/common/main.go
```

### 切换存储后端

修改 `config/common.yaml` 中的 `storage.type` 字段：

```yaml
storage:
  type: "minio"  # 可选: local, minio, s3, oss
```

### 前端使用

```vue
<template>
  <FileUpload
    business-type="avatar"
    :max-size="5"
    list-type="image-card"
    @success="handleUploadSuccess"
  />
</template>

<script setup lang="ts">
import FileUpload from '@/components/common/FileUpload.vue'

function handleUploadSuccess(fileInfo: Api.Common.UploadResponse) {
  console.log('上传成功:', fileInfo)
}
</script>
```

## 功能特性

### 1. 多租户支持
- 文件按租户隔离存储
- 数据库记录按租户隔离

### 2. 存储路径组织
文件按以下结构组织：
```
{tenant_code}/{business_type}/{yyyy}/{mm}/{dd}/{uuid}.{ext}
```

例如：
```
tenant001/avatar/2025/10/06/abc123-def456.jpg
```

### 3. 安全性
- 文件大小限制（默认100MB）
- 文件类型白名单验证
- 租户隔离确保数据安全
- 支持预签名URL实现临时访问控制

### 4. 性能优化
- 流式文件上传和下载
- 支持对象存储CDN加速
- 文件元数据缓存（可扩展）

### 5. 可扩展性
- 统一的存储接口，易于添加新的存储后端
- 配置化的存储选择，无需修改代码
- 支持业务类型扩展

## 配置建议

### 开发环境
推荐使用本地存储：
```yaml
storage:
  type: "local"
  local:
    upload_dir: "./uploads"
    base_url: "http://localhost:8004/files"
```

### 生产环境
推荐使用对象存储（MinIO/S3/OSS）：
```yaml
storage:
  type: "minio"
  minio:
    endpoint: "minio.example.com:9000"
    access_key_id: "your-key"
    secret_access_key: "your-secret"
    bucket_name: "production"
    use_ssl: true
```

## 注意事项

1. **文件大小限制**: 默认100MB，可在 `app/common/services/file.go` 中修改
2. **文件类型限制**: 在 `app/common/services/file.go` 的 `allowedExts` 中配置
3. **存储切换**: 切换存储类型后，历史文件需要手动迁移
4. **预签名URL**: 仅对象存储支持，本地存储直接返回永久URL
5. **租户上下文**: 所有API需要在请求头中携带租户信息

## 下一步计划

- [ ] 添加文件分片上传支持（大文件）
- [ ] 实现文件缩略图生成（图片）
- [ ] 添加文件访问日志
- [ ] 实现文件去重（基于Hash）
- [ ] 添加文件批量操作接口
- [ ] 实现文件版本管理

## 总结

Common Service 文件上传功能已完整实现，提供了：
- ✅ 完善的存储接口抽象
- ✅ 4种存储后端实现
- ✅ 完整的CRUD API
- ✅ 前端上传组件封装
- ✅ 多租户数据隔离
- ✅ 灵活的配置方式
- ✅ 安全的文件验证

可以直接用于生产环境！🎉
