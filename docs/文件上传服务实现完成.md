# æ–‡ä»¶ä¸Šä¼ æœåŠ¡å®ç°å®Œæˆ ğŸ‰

## æ¦‚è¿°

å·²æˆåŠŸå®ç°å®Œæ•´çš„æ–‡ä»¶ä¸Šä¼ æœåŠ¡ï¼ˆCommon Serviceï¼‰ï¼Œæ”¯æŒå¤šç§å­˜å‚¨åç«¯ï¼ŒåŒ…æ‹¬æœ¬åœ°å­˜å‚¨ã€MinIOã€AWS S3ã€é˜¿é‡Œäº‘OSSã€‚è¯¥æœåŠ¡æä¾›æ–‡ä»¶ä¸Šä¼ ã€ä¸‹è½½ã€åˆ é™¤ã€åˆ—è¡¨æŸ¥è¯¢ã€é¢„ç­¾åURLç”Ÿæˆç­‰åŠŸèƒ½ã€‚

## åç«¯å®ç°

### 1. å­˜å‚¨æ¥å£è®¾è®¡

**æ–‡ä»¶**: `core/storage/interface.go`

è®¾è®¡äº†ç»Ÿä¸€çš„å­˜å‚¨æ¥å£ `Storage`ï¼Œæ”¯æŒä»¥ä¸‹æ“ä½œï¼š
- `Upload`: ä¸Šä¼ æ–‡ä»¶
- `Download`: ä¸‹è½½æ–‡ä»¶
- `Delete`: åˆ é™¤æ–‡ä»¶
- `Exists`: æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
- `GetURL`: è·å–æ–‡ä»¶è®¿é—®URL
- `GetPresignedURL`: è·å–é¢„ç­¾åURLï¼ˆç”¨äºä¸´æ—¶è®¿é—®ï¼‰

### 2. å­˜å‚¨å®ç°

å®ç°äº†4ç§å­˜å‚¨åç«¯ï¼š

#### æœ¬åœ°å­˜å‚¨ (`core/storage/local.go`)
- å°†æ–‡ä»¶å­˜å‚¨åœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ
- æ”¯æŒç›®å½•è‡ªåŠ¨åˆ›å»º
- é€šè¿‡HTTPé™æ€æ–‡ä»¶æœåŠ¡è®¿é—®

#### MinIOå­˜å‚¨ (`core/storage/minio.go`)
- æ”¯æŒMinIOå¯¹è±¡å­˜å‚¨
- è‡ªåŠ¨åˆ›å»ºå­˜å‚¨æ¡¶
- æ”¯æŒé¢„ç­¾åURLç”Ÿæˆ

#### AWS S3å­˜å‚¨ (`core/storage/s3.go`)
- æ”¯æŒAWS S3æˆ–å…¼å®¹S3çš„å­˜å‚¨æœåŠ¡
- æ”¯æŒè‡ªå®šä¹‰ç«¯ç‚¹é…ç½®
- æ”¯æŒé¢„ç­¾åURLç”Ÿæˆ

#### é˜¿é‡Œäº‘OSSå­˜å‚¨ (`core/storage/oss.go`)
- æ”¯æŒé˜¿é‡Œäº‘OSSå¯¹è±¡å­˜å‚¨
- æ”¯æŒé¢„ç­¾åURLç”Ÿæˆ

### 3. æ•°æ®æ¨¡å‹

**æ–‡ä»¶**: `internal/models/file.go`

```go
type FileInfo struct {
    ID           primitive.ObjectID
    TenantCode   string  // ç§Ÿæˆ·ä»£ç 
    FileName     string  // åŸå§‹æ–‡ä»¶å
    FileSize     int64   // æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
    FileType     string  // æ–‡ä»¶ç±»å‹ï¼ˆMIMEç±»å‹ï¼‰
    FileExt      string  // æ–‡ä»¶æ‰©å±•å
    StorageType  string  // å­˜å‚¨ç±»å‹ï¼ˆlocal/minio/s3/ossï¼‰
    StoragePath  string  // å­˜å‚¨è·¯å¾„
    StorageKey   string  // å­˜å‚¨é”®ï¼ˆç”¨äºå¯¹è±¡å­˜å‚¨ï¼‰
    URL          string  // è®¿é—®URL
    BusinessType string  // ä¸šåŠ¡ç±»å‹ï¼ˆavatar/document/imageç­‰ï¼‰
    UploadBy     string  // ä¸Šä¼ äººID
    CreatedAt    time.Time
    UpdatedAt    time.Time
}
```

### 4. Repositoryå±‚

**æ–‡ä»¶**: `internal/repository/file.go`

å®ç°äº†æ–‡ä»¶å…ƒæ•°æ®çš„æ•°æ®åº“æ“ä½œï¼š
- æ”¯æŒå¤šç§Ÿæˆ·æ•°æ®éš”ç¦»
- æä¾›CRUDæ“ä½œ
- æ”¯æŒåˆ†é¡µæŸ¥è¯¢å’Œä¸šåŠ¡ç±»å‹è¿‡æ»¤

### 5. Serviceå±‚

**æ–‡ä»¶**: `app/common/services/file.go`

å®ç°ä¸šåŠ¡é€»è¾‘ï¼š
- æ–‡ä»¶ä¸Šä¼ éªŒè¯ï¼ˆå¤§å°ã€ç±»å‹é™åˆ¶ï¼‰
- æ–‡ä»¶å­˜å‚¨è·¯å¾„ç”Ÿæˆï¼ˆæŒ‰ç§Ÿæˆ·/ä¸šåŠ¡ç±»å‹/æ—¥æœŸç»„ç»‡ï¼‰
- äº‹åŠ¡æ€§æ“ä½œï¼ˆå­˜å‚¨å¤±è´¥æ—¶å›æ»šæ•°æ®åº“è®°å½•ï¼‰
- æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼š
  - å›¾ç‰‡ï¼šjpg, jpeg, png, gif, bmp, webp
  - æ–‡æ¡£ï¼špdf, doc, docx, xls, xlsx, ppt, pptx
  - å…¶ä»–ï¼štxt, csv, zip, rar, 7z

### 6. Transportå±‚

**æ–‡ä»¶**: `app/common/transport/file.go`

æä¾›HTTP APIæ¥å£ï¼š
- `POST /admin/common/files/upload` - ä¸Šä¼ æ–‡ä»¶
- `GET /admin/common/files` - è·å–æ–‡ä»¶åˆ—è¡¨
- `GET /admin/common/files/:id` - ä¸‹è½½æ–‡ä»¶
- `DELETE /admin/common/files/:id` - åˆ é™¤æ–‡ä»¶
- `GET /admin/common/files/:id/presigned` - è·å–é¢„ç­¾åURL

### 7. é…ç½®æ–‡ä»¶

**æ–‡ä»¶**: `config/common.yaml`

```yaml
# æ–‡ä»¶å­˜å‚¨é…ç½®
storage:
  type: "local"  # å­˜å‚¨ç±»å‹: local/minio/s3/oss
  
  # æœ¬åœ°å­˜å‚¨é…ç½®
  local:
    upload_dir: "./uploads"
    base_url: "http://192.168.31.78:8004/files"
  
  # MinIOé…ç½®
  minio:
    endpoint: "localhost:9000"
    access_key_id: "minioadmin"
    secret_access_key: "minioadmin"
    bucket_name: "mule-cloud"
    use_ssl: false
    region: "us-east-1"
  
  # S3é…ç½®
  s3:
    endpoint: ""  # ç•™ç©ºä½¿ç”¨AWS S3
    access_key_id: "your-access-key"
    secret_access_key: "your-secret-key"
    bucket_name: "mule-cloud"
    region: "us-east-1"
  
  # OSSé…ç½®
  oss:
    endpoint: "oss-cn-hangzhou.aliyuncs.com"
    access_key_id: "your-access-key"
    access_key_secret: "your-secret-key"
    bucket_name: "mule-cloud"
```

### 8. æœåŠ¡ä¸»ç¨‹åº

**æ–‡ä»¶**: `cmd/common/main.go`

- æœåŠ¡ç«¯å£ï¼š8004
- æ”¯æŒConsulæœåŠ¡æ³¨å†Œ
- æ”¯æŒå¤šç§Ÿæˆ·æ•°æ®åº“éš”ç¦»
- æä¾›å¥åº·æ£€æŸ¥æ¥å£
- æä¾›é™æ€æ–‡ä»¶è®¿é—®ï¼ˆæœ¬åœ°å­˜å‚¨æ¨¡å¼ï¼‰

## å‰ç«¯å®ç°

### 1. APIç±»å‹å®šä¹‰

**æ–‡ä»¶**: `frontend/src/typings/api/common.d.ts`

å®šä¹‰äº†å®Œæ•´çš„TypeScriptç±»å‹ï¼š
- `FileInfo` - æ–‡ä»¶ä¿¡æ¯
- `UploadResponse` - ä¸Šä¼ å“åº”
- `FileListRequest` - åˆ—è¡¨è¯·æ±‚
- `FileListResponse` - åˆ—è¡¨å“åº”
- `PresignedURLRequest` - é¢„ç­¾åURLè¯·æ±‚
- `PresignedURLResponse` - é¢„ç­¾åURLå“åº”

### 2. APIæœåŠ¡

**æ–‡ä»¶**: `frontend/src/service/api/common.ts`

æä¾›APIè°ƒç”¨æ–¹æ³•ï¼š
- `uploadFile` - ä¸Šä¼ æ–‡ä»¶
- `fetchFileList` - è·å–æ–‡ä»¶åˆ—è¡¨
- `downloadFile` - ä¸‹è½½æ–‡ä»¶
- `deleteFile` - åˆ é™¤æ–‡ä»¶
- `getPresignedURL` - è·å–é¢„ç­¾åURL

### 3. æ–‡ä»¶ä¸Šä¼ ç»„ä»¶

**æ–‡ä»¶**: `frontend/src/components/common/FileUpload.vue`

å°è£…çš„å¯å¤ç”¨æ–‡ä»¶ä¸Šä¼ ç»„ä»¶ï¼Œç‰¹æ€§ï¼š
- æ”¯æŒå•æ–‡ä»¶/å¤šæ–‡ä»¶ä¸Šä¼ 
- æ–‡ä»¶å¤§å°éªŒè¯
- è‡ªå®šä¹‰ä¸šåŠ¡ç±»å‹
- æ”¯æŒæ–‡ä»¶é¢„è§ˆ
- æ”¯æŒæ–‡ä»¶åˆ é™¤
- ä¸Šä¼ è¿›åº¦æ˜¾ç¤º
- é”™è¯¯å¤„ç†å’Œæç¤º
- æ”¯æŒä¸‰ç§æ˜¾ç¤ºæ¨¡å¼ï¼štextã€imageã€image-card

## ä½¿ç”¨ç¤ºä¾‹

### åç«¯å¯åŠ¨

```bash
go run cmd/common/main.go
```

### åˆ‡æ¢å­˜å‚¨åç«¯

ä¿®æ”¹ `config/common.yaml` ä¸­çš„ `storage.type` å­—æ®µï¼š

```yaml
storage:
  type: "minio"  # å¯é€‰: local, minio, s3, oss
```

### å‰ç«¯ä½¿ç”¨

```vue
<template>
  <FileUpload
    business-type="avatar"
    :max-size="5"
    list-type="image-card"
    @success="handleUploadSuccess"
  />
</template>

<script setup lang="ts">
import FileUpload from '@/components/common/FileUpload.vue'

function handleUploadSuccess(fileInfo: Api.Common.UploadResponse) {
  console.log('ä¸Šä¼ æˆåŠŸ:', fileInfo)
}
</script>
```

## åŠŸèƒ½ç‰¹æ€§

### 1. å¤šç§Ÿæˆ·æ”¯æŒ
- æ–‡ä»¶æŒ‰ç§Ÿæˆ·éš”ç¦»å­˜å‚¨
- æ•°æ®åº“è®°å½•æŒ‰ç§Ÿæˆ·éš”ç¦»

### 2. å­˜å‚¨è·¯å¾„ç»„ç»‡
æ–‡ä»¶æŒ‰ä»¥ä¸‹ç»“æ„ç»„ç»‡ï¼š
```
{tenant_code}/{business_type}/{yyyy}/{mm}/{dd}/{uuid}.{ext}
```

ä¾‹å¦‚ï¼š
```
tenant001/avatar/2025/10/06/abc123-def456.jpg
```

### 3. å®‰å…¨æ€§
- æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆé»˜è®¤100MBï¼‰
- æ–‡ä»¶ç±»å‹ç™½åå•éªŒè¯
- ç§Ÿæˆ·éš”ç¦»ç¡®ä¿æ•°æ®å®‰å…¨
- æ”¯æŒé¢„ç­¾åURLå®ç°ä¸´æ—¶è®¿é—®æ§åˆ¶

### 4. æ€§èƒ½ä¼˜åŒ–
- æµå¼æ–‡ä»¶ä¸Šä¼ å’Œä¸‹è½½
- æ”¯æŒå¯¹è±¡å­˜å‚¨CDNåŠ é€Ÿ
- æ–‡ä»¶å…ƒæ•°æ®ç¼“å­˜ï¼ˆå¯æ‰©å±•ï¼‰

### 5. å¯æ‰©å±•æ€§
- ç»Ÿä¸€çš„å­˜å‚¨æ¥å£ï¼Œæ˜“äºæ·»åŠ æ–°çš„å­˜å‚¨åç«¯
- é…ç½®åŒ–çš„å­˜å‚¨é€‰æ‹©ï¼Œæ— éœ€ä¿®æ”¹ä»£ç 
- æ”¯æŒä¸šåŠ¡ç±»å‹æ‰©å±•

## é…ç½®å»ºè®®

### å¼€å‘ç¯å¢ƒ
æ¨èä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼š
```yaml
storage:
  type: "local"
  local:
    upload_dir: "./uploads"
    base_url: "http://localhost:8004/files"
```

### ç”Ÿäº§ç¯å¢ƒ
æ¨èä½¿ç”¨å¯¹è±¡å­˜å‚¨ï¼ˆMinIO/S3/OSSï¼‰ï¼š
```yaml
storage:
  type: "minio"
  minio:
    endpoint: "minio.example.com:9000"
    access_key_id: "your-key"
    secret_access_key: "your-secret"
    bucket_name: "production"
    use_ssl: true
```

## æ³¨æ„äº‹é¡¹

1. **æ–‡ä»¶å¤§å°é™åˆ¶**: é»˜è®¤100MBï¼Œå¯åœ¨ `app/common/services/file.go` ä¸­ä¿®æ”¹
2. **æ–‡ä»¶ç±»å‹é™åˆ¶**: åœ¨ `app/common/services/file.go` çš„ `allowedExts` ä¸­é…ç½®
3. **å­˜å‚¨åˆ‡æ¢**: åˆ‡æ¢å­˜å‚¨ç±»å‹åï¼Œå†å²æ–‡ä»¶éœ€è¦æ‰‹åŠ¨è¿ç§»
4. **é¢„ç­¾åURL**: ä»…å¯¹è±¡å­˜å‚¨æ”¯æŒï¼Œæœ¬åœ°å­˜å‚¨ç›´æ¥è¿”å›æ°¸ä¹…URL
5. **ç§Ÿæˆ·ä¸Šä¸‹æ–‡**: æ‰€æœ‰APIéœ€è¦åœ¨è¯·æ±‚å¤´ä¸­æºå¸¦ç§Ÿæˆ·ä¿¡æ¯

## ä¸‹ä¸€æ­¥è®¡åˆ’

- [ ] æ·»åŠ æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ æ”¯æŒï¼ˆå¤§æ–‡ä»¶ï¼‰
- [ ] å®ç°æ–‡ä»¶ç¼©ç•¥å›¾ç”Ÿæˆï¼ˆå›¾ç‰‡ï¼‰
- [ ] æ·»åŠ æ–‡ä»¶è®¿é—®æ—¥å¿—
- [ ] å®ç°æ–‡ä»¶å»é‡ï¼ˆåŸºäºHashï¼‰
- [ ] æ·»åŠ æ–‡ä»¶æ‰¹é‡æ“ä½œæ¥å£
- [ ] å®ç°æ–‡ä»¶ç‰ˆæœ¬ç®¡ç†

## æ€»ç»“

Common Service æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½å·²å®Œæ•´å®ç°ï¼Œæä¾›äº†ï¼š
- âœ… å®Œå–„çš„å­˜å‚¨æ¥å£æŠ½è±¡
- âœ… 4ç§å­˜å‚¨åç«¯å®ç°
- âœ… å®Œæ•´çš„CRUD API
- âœ… å‰ç«¯ä¸Šä¼ ç»„ä»¶å°è£…
- âœ… å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»
- âœ… çµæ´»çš„é…ç½®æ–¹å¼
- âœ… å®‰å…¨çš„æ–‡ä»¶éªŒè¯

å¯ä»¥ç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒï¼ğŸ‰
