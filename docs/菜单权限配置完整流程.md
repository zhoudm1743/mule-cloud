# 菜单权限配置完整流程

## 📋 问题背景

之前虽然实现了细粒度权限系统，但菜单数据库中并没有 `available_permissions` 字段，导致：
- Role 分配权限时无法看到权限选项
- 系统只能使用默认的 CRUD 权限
- 无法配置业务特定权限（如"挂账"、"核销"等）

## ✅ 已完成的修改

### 1. 后端修改

#### 1.1 DTO 层 (`app/system/dto/menu.go`)

```go
import "mule-cloud/internal/models"

type CreateMenuRequest struct {
    // ... 原有字段 ...
    AvailablePermissions []models.Permission `json:"available_permissions"` // ✅ 新增
}

type UpdateMenuRequest struct {
    // ... 原有字段 ...
    AvailablePermissions []models.Permission `json:"available_permissions"` // ✅ 新增
}
```

#### 1.2 Transport 层 (`app/system/transport/menu.go`)

```go
// CreateMenuHandler
menu := &models.Menu{
    // ... 原有字段 ...
    AvailablePermissions: req.AvailablePermissions, // ✅ 新增
}

// UpdateMenuHandler
if req.AvailablePermissions != nil {
    updates["available_permissions"] = req.AvailablePermissions // ✅ 新增
}
```

### 2. 前端修改

#### 2.1 类型定义 (`frontend/src/typings/api/menu.d.ts`)

```typescript
interface CreateRequest {
    // ... 原有字段 ...
    available_permissions?: Permission[] // ✅ 新增
}

interface UpdateRequest {
    // ... 原有字段 ...
    available_permissions?: Permission[] // ✅ 新增
}
```

#### 2.2 菜单管理界面 (`frontend/src/views/system/menu/components/TableModal.vue`)

**新增功能：**

1. **基础权限配置**：勾选 CRUD 权限（查看、创建、修改、删除）
2. **业务权限配置**：动态添加业务权限（挂账、核销、审核等）
3. **权限卡片展示**：清晰的 UI，区分基础权限和业务权限

```vue
<!-- 权限配置 UI -->
<n-form-item-grid-item v-if="formModel.menuType === 'page'" :span="2">
  <template #label>
    权限配置
    <HelpInfo message="配置该菜单支持的操作权限（CRUD + 业务权限）" />
  </template>
  <n-card size="small">
    <!-- 基础权限 -->
    <div>
      <div class="mb-2 font-medium text-sm">基础权限（CRUD）</div>
      <n-space>
        <n-checkbox v-for="bp in basicPermissions" ...>
          {{ bp.label }}
        </n-checkbox>
      </n-space>
    </div>
    
    <!-- 业务权限 -->
    <div>
      <div class="mb-2 font-medium text-sm flex items-center justify-between">
        <span>业务权限（如：挂账、核销等）</span>
        <n-button size="tiny" @click="addBusinessPermission">
          + 添加业务权限
        </n-button>
      </div>
      <!-- 业务权限列表 -->
    </div>
  </n-card>
</n-form-item-grid-item>
```

## 🔄 完整流程演示

### 步骤1：配置菜单权限

1. 打开**系统设置 > 菜单设置**
2. 点击某个菜单的**编辑**按钮（如 "admin" 菜单）
3. 滚动到**权限配置**区域
4. **配置基础权限**：勾选需要的 CRUD 权限
   - ☑️ 查看
   - ☑️ 创建
   - ☑️ 修改
   - ☑️ 删除

5. **配置业务权限**（如财务模块）：
   - 点击 **"+ 添加业务权限"**
   - 填写：
     - 权限动作：`pending`
     - 显示名称：`挂账`
     - 描述说明：`将订单标记为挂账状态`
   - 再次点击 **"+ 添加业务权限"**
   - 填写：
     - 权限动作：`verify`
     - 显示名称：`核销`
     - 描述说明：`核销挂账订单`

6. 点击**提交**保存

### 步骤2：为角色分配权限

1. 打开**系统设置 > 角色设置**
2. 点击某个角色的**分配权限**按钮
3. 勾选菜单（如 "admin"）
4. 在**权限细粒度配置**区域：
   - **基础权限**区域会显示：☑️ 查看 ☑️ 创建 ☑️ 修改 ☑️ 删除
   - **业务权限**区域会显示：☑️ 挂账 ☑️ 核销
5. 根据需要勾选相应权限
6. 点击**提交**

### 步骤3：前端使用权限控制

```vue
<script setup lang="ts">
import { usePermission } from '@/hooks'

const { hasAction, hasResource } = usePermission()
</script>

<template>
  <!-- 按钮级权限控制 -->
  <NButton v-if="hasAction('admin', 'create')" @click="handleCreate">
    新建
  </NButton>
  
  <NButton v-if="hasAction('admin', 'update')" @click="handleEdit">
    编辑
  </NButton>
  
  <!-- 业务权限 -->
  <NButton v-if="hasAction('finance', 'pending')" @click="handlePending">
    挂账
  </NButton>
  
  <NButton v-if="hasAction('finance', 'verify')" @click="handleVerify">
    核销
  </NButton>
  
  <!-- 或使用 hasResource -->
  <NButton v-if="hasResource('admin:delete')" @click="handleDelete">
    删除
  </NButton>
</template>
```

### 步骤4：后端检查权限

```go
import "mule-cloud/core/casbin"

func HandlePendingOrder(c *gin.Context) {
    userID := c.GetString("userID")
    tenantID := c.GetString("tenantID")
    
    // 检查是否有"挂账"权限
    hasPermission := casbin.CheckUserPermission(tenantID, userID, "/finance", "pending")
    if !hasPermission {
        response.Error(c, "无挂账权限")
        return
    }
    
    // 执行挂账逻辑...
}
```

## 🎯 系统流程图

```
1. 管理员配置菜单权限
   └─> 编辑菜单 -> 配置 available_permissions -> 保存到 MongoDB
   
2. 角色管理员分配权限
   └─> 选择菜单 -> 勾选细粒度权限 -> 保存到 Role.menu_permissions
       └─> 自动同步到 Casbin 策略表
   
3. 用户登录
   └─> 后端查询用户所有角色的 menu_permissions
       └─> 合并权限并返回给前端
           └─> 前端存储在 userInfo.menu_permissions
   
4. 权限检查
   ├─> 前端：usePermission.hasAction('admin', 'create')
   │   └─> 检查 userInfo.menu_permissions['admin'].includes('create')
   │
   └─> 后端：casbin.CheckUserPermission(tenantID, userID, "/admin", "create")
       └─> 查询 Casbin 策略表
```

## 📊 数据流示例

### MongoDB 菜单数据

```json
{
  "_id": "68dd0d911adf4a854a8a9f66",
  "name": "admin",
  "path": "/system/admin",
  "title": "管理员设置",
  "available_permissions": [
    { "action": "read", "label": "查看", "is_basic": true },
    { "action": "create", "label": "创建", "is_basic": true },
    { "action": "update", "label": "修改", "is_basic": true },
    { "action": "delete", "label": "删除", "is_basic": true }
  ]
}
```

### MongoDB 角色数据

```json
{
  "_id": "role123",
  "name": "管理员",
  "menus": ["dashboard", "admin", "role"],
  "menu_permissions": {
    "admin": ["read", "create", "update"],
    "role": ["read"]
  }
}
```

### 用户登录响应

```json
{
  "code": 0,
  "data": {
    "token": "xxx",
    "userInfo": {
      "username": "admin",
      "menus": ["dashboard", "admin", "role"],
      "menu_permissions": {
        "admin": ["read", "create", "update"],
        "role": ["read"]
      }
    }
  }
}
```

## ⚠️ 注意事项

1. **权限配置只在"页面"类型菜单中可用**
   - `menuType: 'dir'` 的目录菜单不显示权限配置

2. **权限同步是自动的**
   - 在角色分配菜单时，会自动调用 `casbin.SyncRoleMenusWithPermissions`
   - Gateway 的 Casbin 中间件会实时检查权限

3. **业务权限的 action 命名规范**
   - 使用小写英文：`pending`, `verify`, `audit`
   - 避免使用特殊字符和空格
   - 保持语义清晰

4. **权限检查层级**
   - Gateway 层：HTTP 方法映射到 CRUD 操作（read/create/update/delete）
   - 业务代码层：检查自定义业务权限（pending/verify/audit）

## 🔗 相关文档

- [权限体系整合方案.md](./权限体系整合方案.md)
- [Casbin自定义业务权限方案.md](./Casbin自定义业务权限方案.md)
- [细粒度权限使用示例.md](./细粒度权限使用示例.md)
- [权限系统最终实施完成.md](./权限系统最终实施完成.md)

## ✨ 总结

现在你可以：
1. ✅ 在菜单管理界面配置每个菜单的可用权限
2. ✅ 在角色分配时看到并选择细粒度权限
3. ✅ 在前端使用 `hasAction` 和 `hasResource` 进行权限检查
4. ✅ 在后端使用 `casbin.CheckUserPermission` 进行权限验证
5. ✅ 支持自定义业务权限（挂账、核销、审核等）

整个权限系统现在是**完全可配置、细粒度、多层级**的！🎉

