# èœå•æƒé™é…ç½®å®Œæ•´æµç¨‹

## ğŸ“‹ é—®é¢˜èƒŒæ™¯

ä¹‹å‰è™½ç„¶å®ç°äº†ç»†ç²’åº¦æƒé™ç³»ç»Ÿï¼Œä½†èœå•æ•°æ®åº“ä¸­å¹¶æ²¡æœ‰ `available_permissions` å­—æ®µï¼Œå¯¼è‡´ï¼š
- Role åˆ†é…æƒé™æ—¶æ— æ³•çœ‹åˆ°æƒé™é€‰é¡¹
- ç³»ç»Ÿåªèƒ½ä½¿ç”¨é»˜è®¤çš„ CRUD æƒé™
- æ— æ³•é…ç½®ä¸šåŠ¡ç‰¹å®šæƒé™ï¼ˆå¦‚"æŒ‚è´¦"ã€"æ ¸é”€"ç­‰ï¼‰

## âœ… å·²å®Œæˆçš„ä¿®æ”¹

### 1. åç«¯ä¿®æ”¹

#### 1.1 DTO å±‚ (`app/system/dto/menu.go`)

```go
import "mule-cloud/internal/models"

type CreateMenuRequest struct {
    // ... åŸæœ‰å­—æ®µ ...
    AvailablePermissions []models.Permission `json:"available_permissions"` // âœ… æ–°å¢
}

type UpdateMenuRequest struct {
    // ... åŸæœ‰å­—æ®µ ...
    AvailablePermissions []models.Permission `json:"available_permissions"` // âœ… æ–°å¢
}
```

#### 1.2 Transport å±‚ (`app/system/transport/menu.go`)

```go
// CreateMenuHandler
menu := &models.Menu{
    // ... åŸæœ‰å­—æ®µ ...
    AvailablePermissions: req.AvailablePermissions, // âœ… æ–°å¢
}

// UpdateMenuHandler
if req.AvailablePermissions != nil {
    updates["available_permissions"] = req.AvailablePermissions // âœ… æ–°å¢
}
```

### 2. å‰ç«¯ä¿®æ”¹

#### 2.1 ç±»å‹å®šä¹‰ (`frontend/src/typings/api/menu.d.ts`)

```typescript
interface CreateRequest {
    // ... åŸæœ‰å­—æ®µ ...
    available_permissions?: Permission[] // âœ… æ–°å¢
}

interface UpdateRequest {
    // ... åŸæœ‰å­—æ®µ ...
    available_permissions?: Permission[] // âœ… æ–°å¢
}
```

#### 2.2 èœå•ç®¡ç†ç•Œé¢ (`frontend/src/views/system/menu/components/TableModal.vue`)

**æ–°å¢åŠŸèƒ½ï¼š**

1. **åŸºç¡€æƒé™é…ç½®**ï¼šå‹¾é€‰ CRUD æƒé™ï¼ˆæŸ¥çœ‹ã€åˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤ï¼‰
2. **ä¸šåŠ¡æƒé™é…ç½®**ï¼šåŠ¨æ€æ·»åŠ ä¸šåŠ¡æƒé™ï¼ˆæŒ‚è´¦ã€æ ¸é”€ã€å®¡æ ¸ç­‰ï¼‰
3. **æƒé™å¡ç‰‡å±•ç¤º**ï¼šæ¸…æ™°çš„ UIï¼ŒåŒºåˆ†åŸºç¡€æƒé™å’Œä¸šåŠ¡æƒé™

```vue
<!-- æƒé™é…ç½® UI -->
<n-form-item-grid-item v-if="formModel.menuType === 'page'" :span="2">
  <template #label>
    æƒé™é…ç½®
    <HelpInfo message="é…ç½®è¯¥èœå•æ”¯æŒçš„æ“ä½œæƒé™ï¼ˆCRUD + ä¸šåŠ¡æƒé™ï¼‰" />
  </template>
  <n-card size="small">
    <!-- åŸºç¡€æƒé™ -->
    <div>
      <div class="mb-2 font-medium text-sm">åŸºç¡€æƒé™ï¼ˆCRUDï¼‰</div>
      <n-space>
        <n-checkbox v-for="bp in basicPermissions" ...>
          {{ bp.label }}
        </n-checkbox>
      </n-space>
    </div>
    
    <!-- ä¸šåŠ¡æƒé™ -->
    <div>
      <div class="mb-2 font-medium text-sm flex items-center justify-between">
        <span>ä¸šåŠ¡æƒé™ï¼ˆå¦‚ï¼šæŒ‚è´¦ã€æ ¸é”€ç­‰ï¼‰</span>
        <n-button size="tiny" @click="addBusinessPermission">
          + æ·»åŠ ä¸šåŠ¡æƒé™
        </n-button>
      </div>
      <!-- ä¸šåŠ¡æƒé™åˆ—è¡¨ -->
    </div>
  </n-card>
</n-form-item-grid-item>
```

## ğŸ”„ å®Œæ•´æµç¨‹æ¼”ç¤º

### æ­¥éª¤1ï¼šé…ç½®èœå•æƒé™

1. æ‰“å¼€**ç³»ç»Ÿè®¾ç½® > èœå•è®¾ç½®**
2. ç‚¹å‡»æŸä¸ªèœå•çš„**ç¼–è¾‘**æŒ‰é’®ï¼ˆå¦‚ "admin" èœå•ï¼‰
3. æ»šåŠ¨åˆ°**æƒé™é…ç½®**åŒºåŸŸ
4. **é…ç½®åŸºç¡€æƒé™**ï¼šå‹¾é€‰éœ€è¦çš„ CRUD æƒé™
   - â˜‘ï¸ æŸ¥çœ‹
   - â˜‘ï¸ åˆ›å»º
   - â˜‘ï¸ ä¿®æ”¹
   - â˜‘ï¸ åˆ é™¤

5. **é…ç½®ä¸šåŠ¡æƒé™**ï¼ˆå¦‚è´¢åŠ¡æ¨¡å—ï¼‰ï¼š
   - ç‚¹å‡» **"+ æ·»åŠ ä¸šåŠ¡æƒé™"**
   - å¡«å†™ï¼š
     - æƒé™åŠ¨ä½œï¼š`pending`
     - æ˜¾ç¤ºåç§°ï¼š`æŒ‚è´¦`
     - æè¿°è¯´æ˜ï¼š`å°†è®¢å•æ ‡è®°ä¸ºæŒ‚è´¦çŠ¶æ€`
   - å†æ¬¡ç‚¹å‡» **"+ æ·»åŠ ä¸šåŠ¡æƒé™"**
   - å¡«å†™ï¼š
     - æƒé™åŠ¨ä½œï¼š`verify`
     - æ˜¾ç¤ºåç§°ï¼š`æ ¸é”€`
     - æè¿°è¯´æ˜ï¼š`æ ¸é”€æŒ‚è´¦è®¢å•`

6. ç‚¹å‡»**æäº¤**ä¿å­˜

### æ­¥éª¤2ï¼šä¸ºè§’è‰²åˆ†é…æƒé™

1. æ‰“å¼€**ç³»ç»Ÿè®¾ç½® > è§’è‰²è®¾ç½®**
2. ç‚¹å‡»æŸä¸ªè§’è‰²çš„**åˆ†é…æƒé™**æŒ‰é’®
3. å‹¾é€‰èœå•ï¼ˆå¦‚ "admin"ï¼‰
4. åœ¨**æƒé™ç»†ç²’åº¦é…ç½®**åŒºåŸŸï¼š
   - **åŸºç¡€æƒé™**åŒºåŸŸä¼šæ˜¾ç¤ºï¼šâ˜‘ï¸ æŸ¥çœ‹ â˜‘ï¸ åˆ›å»º â˜‘ï¸ ä¿®æ”¹ â˜‘ï¸ åˆ é™¤
   - **ä¸šåŠ¡æƒé™**åŒºåŸŸä¼šæ˜¾ç¤ºï¼šâ˜‘ï¸ æŒ‚è´¦ â˜‘ï¸ æ ¸é”€
5. æ ¹æ®éœ€è¦å‹¾é€‰ç›¸åº”æƒé™
6. ç‚¹å‡»**æäº¤**

### æ­¥éª¤3ï¼šå‰ç«¯ä½¿ç”¨æƒé™æ§åˆ¶

```vue
<script setup lang="ts">
import { usePermission } from '@/hooks'

const { hasAction, hasResource } = usePermission()
</script>

<template>
  <!-- æŒ‰é’®çº§æƒé™æ§åˆ¶ -->
  <NButton v-if="hasAction('admin', 'create')" @click="handleCreate">
    æ–°å»º
  </NButton>
  
  <NButton v-if="hasAction('admin', 'update')" @click="handleEdit">
    ç¼–è¾‘
  </NButton>
  
  <!-- ä¸šåŠ¡æƒé™ -->
  <NButton v-if="hasAction('finance', 'pending')" @click="handlePending">
    æŒ‚è´¦
  </NButton>
  
  <NButton v-if="hasAction('finance', 'verify')" @click="handleVerify">
    æ ¸é”€
  </NButton>
  
  <!-- æˆ–ä½¿ç”¨ hasResource -->
  <NButton v-if="hasResource('admin:delete')" @click="handleDelete">
    åˆ é™¤
  </NButton>
</template>
```

### æ­¥éª¤4ï¼šåç«¯æ£€æŸ¥æƒé™

```go
import "mule-cloud/core/casbin"

func HandlePendingOrder(c *gin.Context) {
    userID := c.GetString("userID")
    tenantID := c.GetString("tenantID")
    
    // æ£€æŸ¥æ˜¯å¦æœ‰"æŒ‚è´¦"æƒé™
    hasPermission := casbin.CheckUserPermission(tenantID, userID, "/finance", "pending")
    if !hasPermission {
        response.Error(c, "æ— æŒ‚è´¦æƒé™")
        return
    }
    
    // æ‰§è¡ŒæŒ‚è´¦é€»è¾‘...
}
```

## ğŸ¯ ç³»ç»Ÿæµç¨‹å›¾

```
1. ç®¡ç†å‘˜é…ç½®èœå•æƒé™
   â””â”€> ç¼–è¾‘èœå• -> é…ç½® available_permissions -> ä¿å­˜åˆ° MongoDB
   
2. è§’è‰²ç®¡ç†å‘˜åˆ†é…æƒé™
   â””â”€> é€‰æ‹©èœå• -> å‹¾é€‰ç»†ç²’åº¦æƒé™ -> ä¿å­˜åˆ° Role.menu_permissions
       â””â”€> è‡ªåŠ¨åŒæ­¥åˆ° Casbin ç­–ç•¥è¡¨
   
3. ç”¨æˆ·ç™»å½•
   â””â”€> åç«¯æŸ¥è¯¢ç”¨æˆ·æ‰€æœ‰è§’è‰²çš„ menu_permissions
       â””â”€> åˆå¹¶æƒé™å¹¶è¿”å›ç»™å‰ç«¯
           â””â”€> å‰ç«¯å­˜å‚¨åœ¨ userInfo.menu_permissions
   
4. æƒé™æ£€æŸ¥
   â”œâ”€> å‰ç«¯ï¼šusePermission.hasAction('admin', 'create')
   â”‚   â””â”€> æ£€æŸ¥ userInfo.menu_permissions['admin'].includes('create')
   â”‚
   â””â”€> åç«¯ï¼šcasbin.CheckUserPermission(tenantID, userID, "/admin", "create")
       â””â”€> æŸ¥è¯¢ Casbin ç­–ç•¥è¡¨
```

## ğŸ“Š æ•°æ®æµç¤ºä¾‹

### MongoDB èœå•æ•°æ®

```json
{
  "_id": "68dd0d911adf4a854a8a9f66",
  "name": "admin",
  "path": "/system/admin",
  "title": "ç®¡ç†å‘˜è®¾ç½®",
  "available_permissions": [
    { "action": "read", "label": "æŸ¥çœ‹", "is_basic": true },
    { "action": "create", "label": "åˆ›å»º", "is_basic": true },
    { "action": "update", "label": "ä¿®æ”¹", "is_basic": true },
    { "action": "delete", "label": "åˆ é™¤", "is_basic": true }
  ]
}
```

### MongoDB è§’è‰²æ•°æ®

```json
{
  "_id": "role123",
  "name": "ç®¡ç†å‘˜",
  "menus": ["dashboard", "admin", "role"],
  "menu_permissions": {
    "admin": ["read", "create", "update"],
    "role": ["read"]
  }
}
```

### ç”¨æˆ·ç™»å½•å“åº”

```json
{
  "code": 0,
  "data": {
    "token": "xxx",
    "userInfo": {
      "username": "admin",
      "menus": ["dashboard", "admin", "role"],
      "menu_permissions": {
        "admin": ["read", "create", "update"],
        "role": ["read"]
      }
    }
  }
}
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æƒé™é…ç½®åªåœ¨"é¡µé¢"ç±»å‹èœå•ä¸­å¯ç”¨**
   - `menuType: 'dir'` çš„ç›®å½•èœå•ä¸æ˜¾ç¤ºæƒé™é…ç½®

2. **æƒé™åŒæ­¥æ˜¯è‡ªåŠ¨çš„**
   - åœ¨è§’è‰²åˆ†é…èœå•æ—¶ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨ `casbin.SyncRoleMenusWithPermissions`
   - Gateway çš„ Casbin ä¸­é—´ä»¶ä¼šå®æ—¶æ£€æŸ¥æƒé™

3. **ä¸šåŠ¡æƒé™çš„ action å‘½åè§„èŒƒ**
   - ä½¿ç”¨å°å†™è‹±æ–‡ï¼š`pending`, `verify`, `audit`
   - é¿å…ä½¿ç”¨ç‰¹æ®Šå­—ç¬¦å’Œç©ºæ ¼
   - ä¿æŒè¯­ä¹‰æ¸…æ™°

4. **æƒé™æ£€æŸ¥å±‚çº§**
   - Gateway å±‚ï¼šHTTP æ–¹æ³•æ˜ å°„åˆ° CRUD æ“ä½œï¼ˆread/create/update/deleteï¼‰
   - ä¸šåŠ¡ä»£ç å±‚ï¼šæ£€æŸ¥è‡ªå®šä¹‰ä¸šåŠ¡æƒé™ï¼ˆpending/verify/auditï¼‰

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [æƒé™ä½“ç³»æ•´åˆæ–¹æ¡ˆ.md](./æƒé™ä½“ç³»æ•´åˆæ–¹æ¡ˆ.md)
- [Casbinè‡ªå®šä¹‰ä¸šåŠ¡æƒé™æ–¹æ¡ˆ.md](./Casbinè‡ªå®šä¹‰ä¸šåŠ¡æƒé™æ–¹æ¡ˆ.md)
- [ç»†ç²’åº¦æƒé™ä½¿ç”¨ç¤ºä¾‹.md](./ç»†ç²’åº¦æƒé™ä½¿ç”¨ç¤ºä¾‹.md)
- [æƒé™ç³»ç»Ÿæœ€ç»ˆå®æ–½å®Œæˆ.md](./æƒé™ç³»ç»Ÿæœ€ç»ˆå®æ–½å®Œæˆ.md)

## âœ¨ æ€»ç»“

ç°åœ¨ä½ å¯ä»¥ï¼š
1. âœ… åœ¨èœå•ç®¡ç†ç•Œé¢é…ç½®æ¯ä¸ªèœå•çš„å¯ç”¨æƒé™
2. âœ… åœ¨è§’è‰²åˆ†é…æ—¶çœ‹åˆ°å¹¶é€‰æ‹©ç»†ç²’åº¦æƒé™
3. âœ… åœ¨å‰ç«¯ä½¿ç”¨ `hasAction` å’Œ `hasResource` è¿›è¡Œæƒé™æ£€æŸ¥
4. âœ… åœ¨åç«¯ä½¿ç”¨ `casbin.CheckUserPermission` è¿›è¡Œæƒé™éªŒè¯
5. âœ… æ”¯æŒè‡ªå®šä¹‰ä¸šåŠ¡æƒé™ï¼ˆæŒ‚è´¦ã€æ ¸é”€ã€å®¡æ ¸ç­‰ï¼‰

æ•´ä¸ªæƒé™ç³»ç»Ÿç°åœ¨æ˜¯**å®Œå…¨å¯é…ç½®ã€ç»†ç²’åº¦ã€å¤šå±‚çº§**çš„ï¼ğŸ‰

