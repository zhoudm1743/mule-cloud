# 裁剪功能实现方案

## 概述

裁剪功能与订单深度绑定，包括裁剪任务管理、裁剪制菲、菲裁打印（二维码标签）、裁片监控等功能。

## 数据模型（已完成）

### 1. CuttingTask（裁剪任务）

```go
type CuttingTask struct {
    ID           string          // 任务ID
    OrderID      string          // 订单ID
    ContractNo   string          // 合同号
    StyleNo      string          // 款号
    StyleName    string          // 款名
    CustomerName string          // 客户名称
    TotalPieces  int             // 总件数
    CutPieces    int             // 已裁件数
    Status       int             // 状态：0-待裁剪 1-裁剪中 2-已完成
    Batches      []CuttingBatch  // 裁剪批次列表
    // ... 其他字段
}
```

### 2. CuttingBatch（裁剪批次-制菲）

```go
type CuttingBatch struct {
    ID           string        // 批次ID
    TaskID       string        // 裁剪任务ID
    OrderID      string        // 订单ID
    ContractNo   string        // 合同号
    StyleNo      string        // 款号
    BedNo        string        // 床号
    BundleNo     string        // 扎号
    ColorID      string        // 颜色ID
    ColorName    string        // 颜色名称
    LayerCount   int           // 拉布层数
    SizeDetails  []SizeDetail  // 尺码明细
    TotalPieces  int           // 总件数
    QRCode       string        // 二维码内容
    PrintCount   int           // 打印次数
    PrintedAt    int64         // 最后打印时间
    // ... 其他字段
}
```

### 3. CuttingPiece（裁片监控）

```go
type CuttingPiece struct {
    ID           string  // 裁片ID
    OrderID      string  // 订单ID
    ContractNo   string  // 合同号
    StyleNo      string  // 款号
    BedNo        string  // 床号
    BundleNo     string  // 扎号
    ColorID      string  // 颜色ID
    ColorName    string  // 颜色名称
    SizeID       string  // 尺码ID
    SizeName     string  // 尺码名称
    Quantity     int     // 数量
    Progress     int     // 进度（已完成工序数）
    TotalProcess int     // 总工序数
    // ... 其他字段
}
```

## 功能模块

### 1. 裁剪任务管理

#### 功能说明
- 从订单创建裁剪任务
- 查看裁剪任务列表
- 查看裁剪任务详情
- 更新裁剪任务状态

#### 页面设计
- 裁剪任务列表：显示所有待裁剪和进行中的任务
- 任务详情：显示任务基本信息和裁剪批次列表

#### API接口
```go
// 创建裁剪任务（从订单创建）
POST /order/cutting/tasks
{
  "order_id": "订单ID"
}

// 裁剪任务列表
GET /order/cutting/tasks?page=1&page_size=10&status=1

// 裁剪任务详情
GET /order/cutting/tasks/:id

// 更新任务状态
PUT /order/cutting/tasks/:id/status
{
  "status": 1  // 0-待裁剪 1-裁剪中 2-已完成
}
```

### 2. 裁剪制菲

#### 功能说明
- 选择颜色
- 输入床号、扎号
- 设置拉布层数
- 选择尺码并输入数量
- 生成二维码
- 保存裁剪批次

#### 页面设计（参考原型图）
```
┌──────────────────────────────────────┐
│ 裁剪制菲                        [X] │
├──────────────────────────────────────┤
│ 操作步骤：                           │
│ 1、点击添加一行数据                   │
│ 2、选择按钮的颜色（橘成衣颜色）        │
│ 3、设置每个尺码的数量                 │
│ 4、设置每个尺码的扎数                 │
│ 5、如果最后绑布，用次点击后一行数据    │
│                                      │
│ 设置床号: [____]                     │
│ 起始扎号: [1]                        │
│                                      │
│ 颜色  拉布层数  L   M   S  合计扎数 合计件数 操作│
│ [下拉] [10]   [10] [10] [10] [30]  [300]  [删除]│
│                                      │
│ + 添加一行数据                       │
│                                      │
│                 [保存]               │
└──────────────────────────────────────┘
```

#### API接口
```go
// 创建裁剪批次
POST /order/cutting/batches
{
  "task_id": "裁剪任务ID",
  "order_id": "订单ID",
  "bed_no": "床号",
  "bundle_no": "扎号",
  "color_id": "颜色ID",
  "layer_count": 10,
  "size_details": [
    {"size_id": "L", "size_name": "L", "quantity": 10},
    {"size_id": "M", "size_name": "M", "quantity": 10},
    {"size_id": "S", "size_name": "S", "quantity": 10}
  ]
}

// 批次列表
GET /order/cutting/batches?task_id=xxx

// 删除批次
DELETE /order/cutting/batches/:id
```

### 3. 菲裁打印

#### 功能说明
- 显示裁剪批次列表
- 选择要打印的批次
- 生成二维码标签
- 打印标签

#### 页面设计（参考原型图）
```
┌──────────────────────────────────────┐
│ 菲裁打印                        [X]  │
├──────────────────────────────────────┤
│ 床号: [___] 扎号: [___] 颜色: [___]  │
│                                      │
│ [云打印] [打印]                      │
│                                      │
│ □ 合同号    款号  床号  扎号 颜色 尺码 数量 裁剪时间│
│ □ 00003131412  003  3   79  青蓝  M   1  2022-09-22│
│ □ 00003131412  003  3   78  青蓝  M   1  2022-09-22│
│ ...                                  │
└──────────────────────────────────────┘
```

打印预览：
```
┌─────────────┐  ┌─────────────┐
│ [QR Code]   │  │ [QR Code]   │
│ 订单:0000313│  │ 订单:0000313│
│ 款号:0031214│  │ 款号:0031214│
│ 颜色:青蓝    │  │ 颜色:青蓝    │
│ 尺码:S      │  │ 尺码:S      │
│ 床号:3      │  │ 床号:3      │
│ 扎号:30     │  │ 扎号:29     │
│ 数量:10     │  │ 数量:10     │
└─────────────┘  └─────────────┘
```

#### 二维码内容
```json
{
  "contract_no": "00003131412",
  "style_no": "0031214",
  "bed_no": "3",
  "bundle_no": "79",
  "color_id": "color_id",
  "color_name": "青蓝",
  "size_id": "size_id",
  "size_name": "M",
  "quantity": 1
}
```

#### API接口
```go
// 获取打印列表
GET /order/cutting/batches/print?order_id=xxx&bed_no=&bundle_no=&color_id=

// 批量打印
POST /order/cutting/batches/print
{
  "batch_ids": ["id1", "id2", ...]
}

// 生成二维码
GET /order/cutting/batches/:id/qrcode
// 返回二维码图片base64
```

### 4. 裁片监控

#### 功能说明
- 查看订单的所有裁片
- 按床号、扎号、颜色、尺码分组显示
- 显示每个裁片的进度
- 显示已完成和未完成数量

#### 页面设计（参考原型图）
```
┌──────────────────────────────────────┐
│ 裁片监控（订单详情标签页）           │
├──────────────────────────────────────┤
│ 合同号  款号  客户  床号 扎号 颜色 尺码 数量 进度 裁剪时间│
│ 000031  003  大龙  3   79  青蓝  M   1  100% 2022-09-22│
│ 000031  003  大龙  3   78  青蓝  M   1  100% 2022-09-22│
│ 000031  003  大龙  3   77  青蓝  M   1  66%  2022-09-22│
│ 000031  003  大龙  3   76  青蓝  M   1  33%  2022-09-22│
│ 000031  003  大龙  3   75  青蓝  M   1  0%   2022-09-22│
│ ...                                  │
│ [详细] [删除]                        │
└──────────────────────────────────────┘
```

#### API接口
```go
// 裁片监控列表
GET /order/cutting/pieces?order_id=xxx

// 裁片详情
GET /order/cutting/pieces/:id

// 更新裁片进度
PUT /order/cutting/pieces/:id/progress
{
  "progress": 3,  // 已完成工序数
  "total_process": 5  // 总工序数
}
```

## 实现步骤

### 后端实现

#### 1. Repository层（已完成 ✅）
- `internal/repository/cutting.go` - 已创建

#### 2. Service层（待实现）
创建 `app/order/services/cutting.go`：

```go
package services

type ICuttingService interface {
    // 裁剪任务
    CreateTask(ctx context.Context, orderID string) (*models.CuttingTask, error)
    GetTask(ctx context.Context, id string) (*models.CuttingTask, error)
    ListTasks(ctx context.Context, req dto.CuttingTaskListRequest) ([]models.CuttingTask, int64, error)
    UpdateTaskStatus(ctx context.Context, id string, status int) error
    
    // 裁剪批次
    CreateBatch(ctx context.Context, req dto.CreateCuttingBatchRequest) (*models.CuttingBatch, error)
    ListBatches(ctx context.Context, req dto.CuttingBatchListRequest) ([]models.CuttingBatch, int64, error)
    DeleteBatch(ctx context.Context, id string) error
    GenerateQRCode(ctx context.Context, id string) (string, error)
    PrintBatches(ctx context.Context, ids []string) error
    
    // 裁片监控
    GetPiecesByOrder(ctx context.Context, orderID string) ([]models.CuttingPiece, error)
    UpdatePieceProgress(ctx context.Context, id string, progress, totalProcess int) error
}
```

#### 3. DTO层（待实现）
在 `app/order/dto/cutting.go` 中定义请求和响应结构

#### 4. Endpoint和Transport层（待实现）
- `app/order/endpoint/cutting.go`
- `app/order/transport/cutting.go`

#### 5. 注册路由（待实现）
在 `cmd/order/main.go` 中添加裁剪相关路由

### 前端实现

#### 1. 类型定义（待实现）
在 `frontend/src/typings/api/order.d.ts` 中添加裁剪相关类型

#### 2. API服务（待实现）
在 `frontend/src/service/api/order.ts` 中添加裁剪API

#### 3. 裁剪任务页面（待实现）
- `frontend/src/views/order/cutting/tasks/index.vue` - 裁剪任务列表
- `frontend/src/views/order/cutting/tasks/components/TaskModal.vue` - 任务详情

#### 4. 裁剪制菲页面（待实现）
- `frontend/src/views/order/cutting/batches/index.vue` - 裁剪批次列表
- `frontend/src/views/order/cutting/batches/components/BatchModal.vue` - 制菲弹窗

#### 5. 菲裁打印页面（待实现）
- `frontend/src/views/order/cutting/print/index.vue` - 打印列表
- `frontend/src/views/order/cutting/print/components/PrintPreview.vue` - 打印预览
- 使用 `qrcode` 库生成二维码

#### 6. 裁片监控（待实现）
- 在订单详情页面添加"裁片监控"标签页
- 显示裁片列表和进度

## 二维码生成方案

### 后端（Go）
使用 `github.com/skip2/go-qrcode` 库：

```go
import "github.com/skip2/go-qrcode"

func GenerateQRCode(data string) ([]byte, error) {
    qr, err := qrcode.New(data, qrcode.Medium)
    if err != nil {
        return nil, err
    }
    
    // 返回PNG格式的二维码图片
    return qr.PNG(256)
}
```

### 前端（Vue）
使用 `qrcode` 库：

```bash
npm install qrcode
```

```vue
<script setup lang="ts">
import QRCode from 'qrcode'

async function generateQRCode(data: string) {
  const canvas = document.getElementById('qrcode')
  await QRCode.toCanvas(canvas, data, {
    width: 200,
    margin: 1,
  })
}
</script>

<template>
  <canvas id="qrcode"></canvas>
</template>
```

## 打印方案

### 浏览器打印
```javascript
function printLabel() {
  window.print()
}
```

### CSS打印样式
```css
@media print {
  @page {
    size: 100mm 100mm;  /* 标签纸尺寸 */
    margin: 0;
  }
  
  .label {
    width: 100mm;
    height: 100mm;
    page-break-after: always;
  }
}
```

### 云打印（可选）
集成第三方云打印服务，如：
- 飞鹅云打印
- 易联云打印
- 小票打印机

## 数据流程

### 1. 创建裁剪任务
```
订单列表 → 点击"裁剪"按钮 → 创建裁剪任务 → 任务列表
```

### 2. 裁剪制菲
```
裁剪任务 → 点击"制菲"按钮 → 
输入床号、扎号 → 
选择颜色 → 
设置拉布层数 → 
配置尺码数量 → 
保存批次 → 
生成裁片记录
```

### 3. 打印流程
```
菲裁打印页面 → 
搜索批次 → 
选择批次 → 
生成二维码 → 
打印标签
```

### 4. 裁片监控
```
订单详情 → 
裁片监控标签页 → 
显示所有裁片 → 
显示进度（已完成工序数/总工序数）
```

## 注意事项

### 1. 数据一致性
- 裁剪任务的总件数应等于订单的总数量
- 所有裁剪批次的总件数应等于裁剪任务的总件数
- 裁片记录应与裁剪批次一一对应

### 2. 并发控制
- 打印时更新打印次数和打印时间
- 避免重复生成裁片记录

### 3. 二维码内容
- 二维码内容应包含足够的信息用于后续扫码识别
- 考虑添加校验码防止数据篡改

### 4. 打印优化
- 支持批量打印
- 打印预览功能
- 打印记录保存

## 扩展功能

### 1. 扫码上报
- 工人扫描二维码上报工序完成情况
- 自动更新裁片进度
- 实时更新订单进度

### 2. 数据统计
- 裁剪效率统计
- 工人产量统计
- 进度报表

### 3. 移动端支持
- 手机扫码
- 移动端上报
- 实时查看进度

## 总结

裁剪功能是订单管理系统的核心功能之一，涉及：
- ✅ 数据模型（已完成）
- ✅ Repository层（已完成）
- ⏳ Service层（待实现）
- ⏳ API接口层（待实现）
- ⏳ 前端页面（待实现）
- ⏳ 二维码生成（待实现）
- ⏳ 打印功能（待实现）

建议按照以下顺序实现：
1. 完成Service层业务逻辑
2. 实现API接口
3. 实现前端页面
4. 集成二维码生成
5. 实现打印功能
6. 测试完整流程

预计工作量：3-5天
