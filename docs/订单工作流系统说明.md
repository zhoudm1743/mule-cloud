# è®¢å•å·¥ä½œæµç³»ç»Ÿè¯´æ˜

## ğŸ“‹ æ¦‚è¿°

åŸºäº Redis çš„è®¢å•å·¥ä½œæµç³»ç»Ÿï¼Œç”¨äºç®¡ç†è®¢å•çŠ¶æ€æµè½¬ï¼Œå‡è½»æ•°æ®åº“å‹åŠ›ï¼Œæä¾›çŠ¶æ€å†å²è¿½æº¯åŠŸèƒ½ã€‚

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. çŠ¶æ€ç®¡ç†
- **çŠ¶æ€å®šä¹‰**ï¼š
  - 0: è‰ç¨¿
  - 1: å·²ä¸‹å•
  - 2: ç”Ÿäº§ä¸­
  - 3: å·²å®Œæˆ
  - 4: å·²å–æ¶ˆ

### 2. äº‹ä»¶é©±åŠ¨
- `submit_order`: æäº¤è®¢å•ï¼ˆè‰ç¨¿ â†’ å·²ä¸‹å•ï¼‰
- `start_cutting`: å¼€å§‹è£å‰ªï¼ˆå·²ä¸‹å• â†’ ç”Ÿäº§ä¸­ï¼‰
- `start_production`: å¼€å§‹ç”Ÿäº§ï¼ˆå·²ä¸‹å• â†’ ç”Ÿäº§ä¸­ï¼‰
- `update_progress`: æ›´æ–°è¿›åº¦ï¼ˆä¿æŒç”Ÿäº§ä¸­çŠ¶æ€ï¼‰
- `complete`: å®Œæˆè®¢å•ï¼ˆç”Ÿäº§ä¸­ â†’ å·²å®Œæˆï¼‰
- `cancel`: å–æ¶ˆè®¢å•ï¼ˆä»»æ„çŠ¶æ€ â†’ å·²å–æ¶ˆï¼‰

### 3. Redis ç¼“å­˜ç­–ç•¥
- **çŠ¶æ€ç¼“å­˜**: `order:status:{order_id}` - ç¼“å­˜ 24 å°æ—¶
- **å†å²è®°å½•**: `order:history:{order_id}` - ä¿ç•™æœ€è¿‘ 100 æ¡ï¼Œ90 å¤©è¿‡æœŸ

## ğŸ”„ çŠ¶æ€æµè½¬è§„åˆ™

```
è‰ç¨¿ (0)
  â”œâ”€ submit_order â†’ å·²ä¸‹å• (1)
  â””â”€ cancel â†’ å·²å–æ¶ˆ (4)

å·²ä¸‹å• (1)
  â”œâ”€ start_cutting â†’ ç”Ÿäº§ä¸­ (2)
  â”œâ”€ start_production â†’ ç”Ÿäº§ä¸­ (2)
  â””â”€ cancel â†’ å·²å–æ¶ˆ (4)

ç”Ÿäº§ä¸­ (2)
  â”œâ”€ update_progress â†’ ç”Ÿäº§ä¸­ (2)
  â”œâ”€ complete â†’ å·²å®Œæˆ (3)
  â””â”€ cancel â†’ å·²å–æ¶ˆ (4)

å·²å®Œæˆ (3)
  â””â”€ (ç»ˆæ€)

å·²å–æ¶ˆ (4)
  â””â”€ (ç»ˆæ€)
```

## ğŸ’» ä½¿ç”¨æ–¹æ³•

### åˆå§‹åŒ–

```go
import "mule-cloud/core/workflow"

wf := workflow.NewOrderWorkflow()
```

### çŠ¶æ€è½¬æ¢

```go
// 1. åˆ›å»ºè£å‰ªä»»åŠ¡æ—¶
err := wf.StartCutting(ctx, orderID, "æ“ä½œå‘˜")

// 2. å¼€å§‹åˆ¶è²æ—¶
err := wf.StartProduction(ctx, orderID, "æ“ä½œå‘˜", "åˆ¶è²å¼€å§‹")

// 3. æ›´æ–°ç”Ÿäº§è¿›åº¦æ—¶
err := wf.UpdateProgress(ctx, orderID, 0.5, "æ“ä½œå‘˜") // 50%

// 4. å®Œæˆè®¢å•æ—¶
err := wf.CompleteOrder(ctx, orderID, "æ“ä½œå‘˜", "æ‰€æœ‰å·¥åºå®Œæˆ")

// 5. å–æ¶ˆè®¢å•æ—¶
err := wf.CancelOrder(ctx, orderID, "æ“ä½œå‘˜", "å®¢æˆ·å–æ¶ˆ")
```

### æŸ¥è¯¢çŠ¶æ€

```go
// è·å–å½“å‰çŠ¶æ€ï¼ˆä¼˜å…ˆä» Redisï¼‰
status, err := wf.GetCurrentStatus(ctx, orderID)

// è·å–çŠ¶æ€å†å²
histories, err := wf.GetHistory(ctx, orderID, 10) // æœ€è¿‘10æ¡
```

### æ‰‹åŠ¨æ§åˆ¶

```go
// æ£€æŸ¥æ˜¯å¦å¯ä»¥è½¬æ¢
canTransition := wf.CanTransition(currentStatus, workflow.EventComplete)

// è·å–ä¸‹ä¸€ä¸ªçŠ¶æ€
nextStatus, err := wf.GetNextStatus(currentStatus, workflow.EventComplete)

// é€šç”¨çŠ¶æ€è½¬æ¢ï¼ˆå¸¦å…ƒæ•°æ®ï¼‰
err := wf.TransitionTo(ctx, orderID, workflow.EventComplete, "æ“ä½œå‘˜", "å®ŒæˆåŸå› ", map[string]interface{}{
    "total_pieces": 1000,
    "quality_score": 98.5,
})
```

## ğŸ”§ é›†æˆç¤ºä¾‹

### è£å‰ªæœåŠ¡é›†æˆ

```go
// app/order/services/cutting.go

type cuttingService struct {
    // ...
    workflow *workflow.OrderWorkflow
}

func NewCuttingService(...) ICuttingService {
    return &cuttingService{
        // ...
        workflow: workflow.NewOrderWorkflow(),
    }
}

func (s *cuttingService) CreateCuttingTask(ctx context.Context, req *dto.CuttingTaskCreateRequest) (*models.CuttingTask, error) {
    // åˆ›å»ºä»»åŠ¡...
    
    // ä½¿ç”¨å·¥ä½œæµæ›´æ–°çŠ¶æ€
    _ = s.workflow.StartCutting(ctx, orderID, req.CreatedBy)
    
    return task, nil
}
```

### ç”Ÿäº§ä¸ŠæŠ¥æœåŠ¡é›†æˆ

```go
// app/production/services/report.go

func (s *reportService) updateOrderProgress(ctx context.Context, orderID string) {
    // è®¡ç®—æ€»ä½“è¿›åº¦
    newProgress := overallProgress / 100.0
    
    // è·å–æ“ä½œå‘˜
    operator := corecontext.GetUsername(ctx)
    
    // ä½¿ç”¨å·¥ä½œæµæ›´æ–°è¿›åº¦å’ŒçŠ¶æ€
    _ = s.workflow.UpdateProgress(ctx, orderID, newProgress, operator)
}
```

## ğŸ“Š çŠ¶æ€å†å²è®°å½•

æ¯æ¬¡çŠ¶æ€è½¬æ¢éƒ½ä¼šè®°å½•åˆ° Redisï¼ŒåŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š

```json
{
  "order_id": "68e48c19b4eb03ee2a2b8dcd",
  "from_state": 1,
  "to_state": 2,
  "event": "start_cutting",
  "reason": "åˆ›å»ºè£å‰ªä»»åŠ¡",
  "operator": "admin",
  "timestamp": 1729234567,
  "metadata": {
    "task_id": "xxx"
  }
}
```

## ğŸš€ ä¼˜åŠ¿

### 1. æ€§èƒ½ä¼˜åŒ–
- âœ… Redis ç¼“å­˜å‡å°‘æ•°æ®åº“æŸ¥è¯¢
- âœ… çŠ¶æ€æŸ¥è¯¢æ¯«ç§’çº§å“åº”
- âœ… æ‰¹é‡æ“ä½œæ—¶é¿å…é¢‘ç¹æ•°æ®åº“æ›´æ–°

### 2. å¯è¿½æº¯æ€§
- âœ… å®Œæ•´çš„çŠ¶æ€å˜æ›´å†å²
- âœ… è®°å½•æ“ä½œäººå’Œæ“ä½œåŸå› 
- âœ… æ”¯æŒå®¡è®¡å’Œé—®é¢˜æ’æŸ¥

### 3. å¯ç»´æŠ¤æ€§
- âœ… é›†ä¸­ç®¡ç†çŠ¶æ€æµè½¬è§„åˆ™
- âœ… è§„åˆ™å˜æ›´æ— éœ€ä¿®æ”¹å¤šå¤„ä»£ç 
- âœ… é˜²æ­¢éæ³•çŠ¶æ€è½¬æ¢

### 4. å¯æ‰©å±•æ€§
- âœ… æ”¯æŒè‡ªå®šä¹‰äº‹ä»¶å’ŒçŠ¶æ€
- âœ… æ”¯æŒçŠ¶æ€è½¬æ¢é’©å­
- âœ… å…ƒæ•°æ®æ”¯æŒä»»æ„ä¸šåŠ¡ä¿¡æ¯

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **Redis ä¾èµ–**: éœ€è¦ç¡®ä¿ Redis æœåŠ¡æ­£å¸¸è¿è¡Œ
2. **æ•°æ®ä¸€è‡´æ€§**: çŠ¶æ€æœ€ç»ˆä¼šåŒæ­¥åˆ° MongoDB
3. **ç¼“å­˜å¤±æ•ˆ**: å¯ä½¿ç”¨ `InvalidateCache()` æ‰‹åŠ¨æ¸…é™¤ç¼“å­˜
4. **å¹¶å‘æ§åˆ¶**: çŠ¶æ€è½¬æ¢éœ€è¦è€ƒè™‘å¹¶å‘åœºæ™¯ï¼ˆåç»­å¯æ·»åŠ åˆ†å¸ƒå¼é”ï¼‰

## ğŸ”® æœªæ¥æ‰©å±•

- [ ] æ·»åŠ åˆ†å¸ƒå¼é”é˜²æ­¢å¹¶å‘å†²çª
- [ ] æ”¯æŒçŠ¶æ€è½¬æ¢å‰ç½®/åç½®é’©å­
- [ ] æ”¯æŒå·¥ä½œæµå¯è§†åŒ–
- [ ] æ”¯æŒå¤æ‚çš„æ¡ä»¶è½¬æ¢è§„åˆ™
- [ ] æ”¯æŒçŠ¶æ€å›æ»šåŠŸèƒ½

