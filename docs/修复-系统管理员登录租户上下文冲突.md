# 修复 - 系统管理员登录租户上下文冲突

## 🐛 问题现象

系统管理员 `17858361617` 登录时：
1. ✅ 登录成功（200）
2. ❌ 前端显示"用户不存在"

## 🔍 问题分析

### 后端日志

```
[登录] 系统管理员登录: 手机号=17858361617
[登录] 找到用户: ID=68dcf02cc592a24457a2f978, 昵称=羊紫林, 角色=[super]
[GIN] 2025/10/05 - 22:11:27 | 200 | POST "/auth/login"  ← 登录成功

[租户上下文切换] 系统管理员切换到租户: 68dda6cd04ba0d6c8dda4b7a  ← 问题！
[MongoDB] 执行命令: find, "filter": {"_id": "68dcf02c..."}, "$db": "mule_68dda6cd04ba0d6c8dda4b7a"  ← 在租户库查询
[GIN] 2025/10/05 - 22:11:27 | 200 | GET "/auth/getUserRoutes"
```

### 问题链路

1. **系统管理员登录成功** - 用户在 `tenant_system` 数据库
2. **前端发送 `getUserRoutes` 请求** - 自动获取用户菜单
3. **请求携带 `X-Tenant-Context: 68dda6cd04ba0d6c8dda4b7a`** - 问题所在！
4. **后端在租户数据库中查询系统管理员** - 查不到，返回错误
5. **前端显示"用户不存在"**

### 根本原因

**浏览器 localStorage 中残留了之前选择的租户ID**：

```typescript
// frontend/src/service/http/alova.ts:74-81
const userInfo = local.get('userInfo')
const selectedTenantId = local.get('selected_tenant_id')  // ← 这里有值！

if (userInfo && !userInfo.tenant_id && selectedTenantId) {
  // 系统管理员 + 已选择租户 = 添加租户上下文 header
  method.config.headers['X-Tenant-Context'] = selectedTenantId  // ← 自动添加！
}
```

**问题**：
- 用户之前作为系统管理员选择过租户
- `selected_tenant_id` 保存在 localStorage 中
- 退出重新登录时，这个值还在
- 导致刚登录就自动带上租户上下文

---

## ✅ 解决方案

### 修改：`frontend/src/store/auth.ts`

在系统管理员登录时，**清除之前选择的租户上下文**：

**修改前（74-92行）**：
```typescript
async handleLoginInfo(data: Api.Login.Info) {
  // 将token和userInfo保存下来
  local.set('userInfo', data)
  local.set('accessToken', data.token)
  local.set('refreshToken', data.token)
  this.token = data.token
  this.userInfo = data

  // 添加路由和菜单
  const routeStore = useRouteStore()
  await routeStore.initAuthRoute()

  // 进行重定向跳转
  const route = unref(router.currentRoute)
  const query = route.query as { redirect: string }
  router.push({
    path: query.redirect || '/',
  })
},
```

**修改后**：
```typescript
async handleLoginInfo(data: Api.Login.Info) {
  // 将token和userInfo保存下来
  local.set('userInfo', data)
  local.set('accessToken', data.token)
  local.set('refreshToken', data.token)
  this.token = data.token
  this.userInfo = data

  // ✅ 系统管理员登录时，清除之前选择的租户上下文
  if (!data.tenant_id) {
    local.remove('selected_tenant_id')
  }

  // 添加路由和菜单
  const routeStore = useRouteStore()
  await routeStore.initAuthRoute()

  // 进行重定向跳转
  const route = unref(router.currentRoute)
  const query = route.query as { redirect: string }
  router.push({
    path: query.redirect || '/',
  })
},
```

### 逻辑说明

1. **判断用户类型**：`!data.tenant_id` - 无租户ID = 系统管理员
2. **清除租户选择**：`local.remove('selected_tenant_id')`
3. **效果**：系统管理员刚登录时，不会自动带租户上下文

---

## 🎯 验证

### 测试步骤

1. **清除浏览器缓存**（可选，但推荐）
   - F12 → Application → Local Storage → 删除所有

2. **系统管理员登录**
   - 租户：系统管理员
   - 手机号：`17858361617`
   - 密码：`123456`

3. **查看 auth 服务日志**

**期望日志**：
```
[登录] 系统管理员登录: 手机号=17858361617
[登录] 找到用户: ID=xxx, 昵称=羊紫林, 角色=[super]
[GIN] POST "/auth/login" - 200

[MongoDB] find "admin" in "$db": "tenant_system"  ← 在系统库查询，正确！
[GIN] GET "/auth/getUserRoutes" - 200
```

**不应该看到**：
```
❌ [租户上下文切换] 系统管理员切换到租户: xxx
❌ [MongoDB] "$db": "mule_68dda6cd04ba0d6c8dda4b7a"  ← 不应该查询租户库
```

### 前端验证

**登录成功后应该看到**：
- ✅ 顶部有"租户选择器"下拉框
- ✅ 左侧菜单正常显示
- ✅ 能正常访问各个页面

---

## 📝 相关逻辑

### 系统管理员访问租户数据的流程

1. **刚登录** - 不带租户上下文，看到的是系统级别数据
2. **选择租户** - 通过顶部"租户选择器"选择
3. **自动切换** - 选择后，`selected_tenant_id` 保存到 localStorage
4. **后续请求** - 自动带 `X-Tenant-Context` header
5. **查看租户数据** - 后端在租户数据库中查询

### 租户上下文何时生效

```typescript
// frontend/src/service/http/alova.ts:78
if (userInfo && !userInfo.tenant_id && selectedTenantId) {
  method.config.headers['X-Tenant-Context'] = selectedTenantId
}
```

**条件**：
1. ✅ 用户已登录（`userInfo` 存在）
2. ✅ 是系统管理员（`!userInfo.tenant_id`）
3. ✅ 已选择租户（`selectedTenantId` 存在）

**结果**：所有请求自动带租户上下文

---

## 🎉 修复完成

- ✅ 系统管理员登录时自动清除残留的租户上下文
- ✅ 登录后 `getUserRoutes` 在正确的数据库中查询
- ✅ 不影响后续的租户切换功能
- ✅ 租户用户登录不受影响

**现在可以正常登录系统管理员了！** 🎊
