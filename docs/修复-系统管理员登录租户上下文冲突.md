# ä¿®å¤ - ç³»ç»Ÿç®¡ç†å‘˜ç™»å½•ç§Ÿæˆ·ä¸Šä¸‹æ–‡å†²çª

## ğŸ› é—®é¢˜ç°è±¡

ç³»ç»Ÿç®¡ç†å‘˜ `17858361617` ç™»å½•æ—¶ï¼š
1. âœ… ç™»å½•æˆåŠŸï¼ˆ200ï¼‰
2. âŒ å‰ç«¯æ˜¾ç¤º"ç”¨æˆ·ä¸å­˜åœ¨"

## ğŸ” é—®é¢˜åˆ†æ

### åç«¯æ—¥å¿—

```
[ç™»å½•] ç³»ç»Ÿç®¡ç†å‘˜ç™»å½•: æ‰‹æœºå·=17858361617
[ç™»å½•] æ‰¾åˆ°ç”¨æˆ·: ID=68dcf02cc592a24457a2f978, æ˜µç§°=ç¾Šç´«æ—, è§’è‰²=[super]
[GIN] 2025/10/05 - 22:11:27 | 200 | POST "/auth/login"  â† ç™»å½•æˆåŠŸ

[ç§Ÿæˆ·ä¸Šä¸‹æ–‡åˆ‡æ¢] ç³»ç»Ÿç®¡ç†å‘˜åˆ‡æ¢åˆ°ç§Ÿæˆ·: 68dda6cd04ba0d6c8dda4b7a  â† é—®é¢˜ï¼
[MongoDB] æ‰§è¡Œå‘½ä»¤: find, "filter": {"_id": "68dcf02c..."}, "$db": "mule_68dda6cd04ba0d6c8dda4b7a"  â† åœ¨ç§Ÿæˆ·åº“æŸ¥è¯¢
[GIN] 2025/10/05 - 22:11:27 | 200 | GET "/auth/getUserRoutes"
```

### é—®é¢˜é“¾è·¯

1. **ç³»ç»Ÿç®¡ç†å‘˜ç™»å½•æˆåŠŸ** - ç”¨æˆ·åœ¨ `tenant_system` æ•°æ®åº“
2. **å‰ç«¯å‘é€ `getUserRoutes` è¯·æ±‚** - è‡ªåŠ¨è·å–ç”¨æˆ·èœå•
3. **è¯·æ±‚æºå¸¦ `X-Tenant-Context: 68dda6cd04ba0d6c8dda4b7a`** - é—®é¢˜æ‰€åœ¨ï¼
4. **åç«¯åœ¨ç§Ÿæˆ·æ•°æ®åº“ä¸­æŸ¥è¯¢ç³»ç»Ÿç®¡ç†å‘˜** - æŸ¥ä¸åˆ°ï¼Œè¿”å›é”™è¯¯
5. **å‰ç«¯æ˜¾ç¤º"ç”¨æˆ·ä¸å­˜åœ¨"**

### æ ¹æœ¬åŸå› 

**æµè§ˆå™¨ localStorage ä¸­æ®‹ç•™äº†ä¹‹å‰é€‰æ‹©çš„ç§Ÿæˆ·ID**ï¼š

```typescript
// frontend/src/service/http/alova.ts:74-81
const userInfo = local.get('userInfo')
const selectedTenantId = local.get('selected_tenant_id')  // â† è¿™é‡Œæœ‰å€¼ï¼

if (userInfo && !userInfo.tenant_id && selectedTenantId) {
  // ç³»ç»Ÿç®¡ç†å‘˜ + å·²é€‰æ‹©ç§Ÿæˆ· = æ·»åŠ ç§Ÿæˆ·ä¸Šä¸‹æ–‡ header
  method.config.headers['X-Tenant-Context'] = selectedTenantId  // â† è‡ªåŠ¨æ·»åŠ ï¼
}
```

**é—®é¢˜**ï¼š
- ç”¨æˆ·ä¹‹å‰ä½œä¸ºç³»ç»Ÿç®¡ç†å‘˜é€‰æ‹©è¿‡ç§Ÿæˆ·
- `selected_tenant_id` ä¿å­˜åœ¨ localStorage ä¸­
- é€€å‡ºé‡æ–°ç™»å½•æ—¶ï¼Œè¿™ä¸ªå€¼è¿˜åœ¨
- å¯¼è‡´åˆšç™»å½•å°±è‡ªåŠ¨å¸¦ä¸Šç§Ÿæˆ·ä¸Šä¸‹æ–‡

---

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®æ”¹ï¼š`frontend/src/store/auth.ts`

åœ¨ç³»ç»Ÿç®¡ç†å‘˜ç™»å½•æ—¶ï¼Œ**æ¸…é™¤ä¹‹å‰é€‰æ‹©çš„ç§Ÿæˆ·ä¸Šä¸‹æ–‡**ï¼š

**ä¿®æ”¹å‰ï¼ˆ74-92è¡Œï¼‰**ï¼š
```typescript
async handleLoginInfo(data: Api.Login.Info) {
  // å°†tokenå’ŒuserInfoä¿å­˜ä¸‹æ¥
  local.set('userInfo', data)
  local.set('accessToken', data.token)
  local.set('refreshToken', data.token)
  this.token = data.token
  this.userInfo = data

  // æ·»åŠ è·¯ç”±å’Œèœå•
  const routeStore = useRouteStore()
  await routeStore.initAuthRoute()

  // è¿›è¡Œé‡å®šå‘è·³è½¬
  const route = unref(router.currentRoute)
  const query = route.query as { redirect: string }
  router.push({
    path: query.redirect || '/',
  })
},
```

**ä¿®æ”¹å**ï¼š
```typescript
async handleLoginInfo(data: Api.Login.Info) {
  // å°†tokenå’ŒuserInfoä¿å­˜ä¸‹æ¥
  local.set('userInfo', data)
  local.set('accessToken', data.token)
  local.set('refreshToken', data.token)
  this.token = data.token
  this.userInfo = data

  // âœ… ç³»ç»Ÿç®¡ç†å‘˜ç™»å½•æ—¶ï¼Œæ¸…é™¤ä¹‹å‰é€‰æ‹©çš„ç§Ÿæˆ·ä¸Šä¸‹æ–‡
  if (!data.tenant_id) {
    local.remove('selected_tenant_id')
  }

  // æ·»åŠ è·¯ç”±å’Œèœå•
  const routeStore = useRouteStore()
  await routeStore.initAuthRoute()

  // è¿›è¡Œé‡å®šå‘è·³è½¬
  const route = unref(router.currentRoute)
  const query = route.query as { redirect: string }
  router.push({
    path: query.redirect || '/',
  })
},
```

### é€»è¾‘è¯´æ˜

1. **åˆ¤æ–­ç”¨æˆ·ç±»å‹**ï¼š`!data.tenant_id` - æ— ç§Ÿæˆ·ID = ç³»ç»Ÿç®¡ç†å‘˜
2. **æ¸…é™¤ç§Ÿæˆ·é€‰æ‹©**ï¼š`local.remove('selected_tenant_id')`
3. **æ•ˆæœ**ï¼šç³»ç»Ÿç®¡ç†å‘˜åˆšç™»å½•æ—¶ï¼Œä¸ä¼šè‡ªåŠ¨å¸¦ç§Ÿæˆ·ä¸Šä¸‹æ–‡

---

## ğŸ¯ éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜**ï¼ˆå¯é€‰ï¼Œä½†æ¨èï¼‰
   - F12 â†’ Application â†’ Local Storage â†’ åˆ é™¤æ‰€æœ‰

2. **ç³»ç»Ÿç®¡ç†å‘˜ç™»å½•**
   - ç§Ÿæˆ·ï¼šç³»ç»Ÿç®¡ç†å‘˜
   - æ‰‹æœºå·ï¼š`17858361617`
   - å¯†ç ï¼š`123456`

3. **æŸ¥çœ‹ auth æœåŠ¡æ—¥å¿—**

**æœŸæœ›æ—¥å¿—**ï¼š
```
[ç™»å½•] ç³»ç»Ÿç®¡ç†å‘˜ç™»å½•: æ‰‹æœºå·=17858361617
[ç™»å½•] æ‰¾åˆ°ç”¨æˆ·: ID=xxx, æ˜µç§°=ç¾Šç´«æ—, è§’è‰²=[super]
[GIN] POST "/auth/login" - 200

[MongoDB] find "admin" in "$db": "tenant_system"  â† åœ¨ç³»ç»Ÿåº“æŸ¥è¯¢ï¼Œæ­£ç¡®ï¼
[GIN] GET "/auth/getUserRoutes" - 200
```

**ä¸åº”è¯¥çœ‹åˆ°**ï¼š
```
âŒ [ç§Ÿæˆ·ä¸Šä¸‹æ–‡åˆ‡æ¢] ç³»ç»Ÿç®¡ç†å‘˜åˆ‡æ¢åˆ°ç§Ÿæˆ·: xxx
âŒ [MongoDB] "$db": "mule_68dda6cd04ba0d6c8dda4b7a"  â† ä¸åº”è¯¥æŸ¥è¯¢ç§Ÿæˆ·åº“
```

### å‰ç«¯éªŒè¯

**ç™»å½•æˆåŠŸååº”è¯¥çœ‹åˆ°**ï¼š
- âœ… é¡¶éƒ¨æœ‰"ç§Ÿæˆ·é€‰æ‹©å™¨"ä¸‹æ‹‰æ¡†
- âœ… å·¦ä¾§èœå•æ­£å¸¸æ˜¾ç¤º
- âœ… èƒ½æ­£å¸¸è®¿é—®å„ä¸ªé¡µé¢

---

## ğŸ“ ç›¸å…³é€»è¾‘

### ç³»ç»Ÿç®¡ç†å‘˜è®¿é—®ç§Ÿæˆ·æ•°æ®çš„æµç¨‹

1. **åˆšç™»å½•** - ä¸å¸¦ç§Ÿæˆ·ä¸Šä¸‹æ–‡ï¼Œçœ‹åˆ°çš„æ˜¯ç³»ç»Ÿçº§åˆ«æ•°æ®
2. **é€‰æ‹©ç§Ÿæˆ·** - é€šè¿‡é¡¶éƒ¨"ç§Ÿæˆ·é€‰æ‹©å™¨"é€‰æ‹©
3. **è‡ªåŠ¨åˆ‡æ¢** - é€‰æ‹©åï¼Œ`selected_tenant_id` ä¿å­˜åˆ° localStorage
4. **åç»­è¯·æ±‚** - è‡ªåŠ¨å¸¦ `X-Tenant-Context` header
5. **æŸ¥çœ‹ç§Ÿæˆ·æ•°æ®** - åç«¯åœ¨ç§Ÿæˆ·æ•°æ®åº“ä¸­æŸ¥è¯¢

### ç§Ÿæˆ·ä¸Šä¸‹æ–‡ä½•æ—¶ç”Ÿæ•ˆ

```typescript
// frontend/src/service/http/alova.ts:78
if (userInfo && !userInfo.tenant_id && selectedTenantId) {
  method.config.headers['X-Tenant-Context'] = selectedTenantId
}
```

**æ¡ä»¶**ï¼š
1. âœ… ç”¨æˆ·å·²ç™»å½•ï¼ˆ`userInfo` å­˜åœ¨ï¼‰
2. âœ… æ˜¯ç³»ç»Ÿç®¡ç†å‘˜ï¼ˆ`!userInfo.tenant_id`ï¼‰
3. âœ… å·²é€‰æ‹©ç§Ÿæˆ·ï¼ˆ`selectedTenantId` å­˜åœ¨ï¼‰

**ç»“æœ**ï¼šæ‰€æœ‰è¯·æ±‚è‡ªåŠ¨å¸¦ç§Ÿæˆ·ä¸Šä¸‹æ–‡

---

## ğŸ‰ ä¿®å¤å®Œæˆ

- âœ… ç³»ç»Ÿç®¡ç†å‘˜ç™»å½•æ—¶è‡ªåŠ¨æ¸…é™¤æ®‹ç•™çš„ç§Ÿæˆ·ä¸Šä¸‹æ–‡
- âœ… ç™»å½•å `getUserRoutes` åœ¨æ­£ç¡®çš„æ•°æ®åº“ä¸­æŸ¥è¯¢
- âœ… ä¸å½±å“åç»­çš„ç§Ÿæˆ·åˆ‡æ¢åŠŸèƒ½
- âœ… ç§Ÿæˆ·ç”¨æˆ·ç™»å½•ä¸å—å½±å“

**ç°åœ¨å¯ä»¥æ­£å¸¸ç™»å½•ç³»ç»Ÿç®¡ç†å‘˜äº†ï¼** ğŸŠ
