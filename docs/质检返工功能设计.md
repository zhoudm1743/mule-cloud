# 质检返工功能设计方案

## 一、功能概述

### 1.1 质检功能
工人完成质检工序后，需要记录：
- 质检数量（检查了多少件）
- 合格数量
- 不合格数量
- 不合格原因
- 质检工人信息

### 1.2 返工功能
质检发现不合格品后，需要：
- 记录返工信息
- 指定返回到哪个工序
- 返工数量
- 返工原因
- 更新批次工序进度（减少已完成数量）

## 二、业务流程

### 2.1 质检流程

```
工序完成 → 扫码质检 → 质检结果录入 → 更新进度
                              ↓
                         合格/不合格
                              ↓
                    不合格 → 创建返工单
```

### 2.2 返工流程

```
质检不合格 → 创建返工单 → 返回指定工序 → 重新加工 → 再次质检
```

## 三、数据模型设计

### 3.1 质检记录（QualityInspection）

```go
type QualityInspection struct {
    ID               string   `json:"id" bson:"_id,omitempty"`
    OrderID          string   `json:"order_id" bson:"order_id"`                   // 订单ID
    ContractNo       string   `json:"contract_no" bson:"contract_no"`             // 合同号
    StyleNo          string   `json:"style_no" bson:"style_no"`                   // 款号
    BatchID          string   `json:"batch_id" bson:"batch_id"`                   // 批次ID（可选）
    BundleNo         string   `json:"bundle_no" bson:"bundle_no"`                 // 扎号（可选）
    Color            string   `json:"color" bson:"color"`                         // 颜色
    Size             string   `json:"size" bson:"size"`                           // 尺码
    ProcedureSeq     int      `json:"procedure_seq" bson:"procedure_seq"`         // 质检的工序序号
    ProcedureName    string   `json:"procedure_name" bson:"procedure_name"`       // 工序名称
    InspectedQty     int      `json:"inspected_qty" bson:"inspected_qty"`         // 质检数量
    QualifiedQty     int      `json:"qualified_qty" bson:"qualified_qty"`         // 合格数量
    UnqualifiedQty   int      `json:"unqualified_qty" bson:"unqualified_qty"`     // 不合格数量
    QualityRate      float64  `json:"quality_rate" bson:"quality_rate"`           // 合格率（%）
    DefectTypes      []string `json:"defect_types" bson:"defect_types"`           // 缺陷类型
    DefectDesc       string   `json:"defect_desc" bson:"defect_desc"`             // 缺陷描述
    InspectorID      string   `json:"inspector_id" bson:"inspector_id"`           // 质检员ID
    InspectorName    string   `json:"inspector_name" bson:"inspector_name"`       // 质检员姓名
    InspectionTime   int64    `json:"inspection_time" bson:"inspection_time"`     // 质检时间
    Images           []string `json:"images" bson:"images"`                       // 质检照片
    Remark           string   `json:"remark" bson:"remark"`                       // 备注
    NeedRework       bool     `json:"need_rework" bson:"need_rework"`             // 是否需要返工
    ReworkID         string   `json:"rework_id" bson:"rework_id"`                 // 返工单ID
    IsDeleted        int      `json:"is_deleted" bson:"is_deleted"`               // 是否删除
    CreatedAt        int64    `json:"created_at" bson:"created_at"`               // 创建时间
    UpdatedAt        int64    `json:"updated_at" bson:"updated_at"`               // 更新时间
}
```

### 3.2 返工记录（ReworkRecord）

```go
type ReworkRecord struct {
    ID                string `json:"id" bson:"_id,omitempty"`
    OrderID           string `json:"order_id" bson:"order_id"`                     // 订单ID
    ContractNo        string `json:"contract_no" bson:"contract_no"`               // 合同号
    BatchID           string `json:"batch_id" bson:"batch_id"`                     // 批次ID
    BundleNo          string `json:"bundle_no" bson:"bundle_no"`                   // 扎号
    Color             string `json:"color" bson:"color"`                           // 颜色
    Size              string `json:"size" bson:"size"`                             // 尺码
    InspectionID      string `json:"inspection_id" bson:"inspection_id"`           // 关联的质检记录ID
    SourceProcedure   int    `json:"source_procedure" bson:"source_procedure"`     // 来源工序（哪个工序出的问题）
    TargetProcedure   int    `json:"target_procedure" bson:"target_procedure"`     // 目标工序（返回到哪个工序）
    ReworkQty         int    `json:"rework_qty" bson:"rework_qty"`                 // 返工数量
    ReworkReason      string `json:"rework_reason" bson:"rework_reason"`           // 返工原因
    Status            int    `json:"status" bson:"status"`                         // 状态：0-待返工 1-返工中 2-已完成
    CreatedBy         string `json:"created_by" bson:"created_by"`                 // 创建人（质检员）
    CreatedByName     string `json:"created_by_name" bson:"created_by_name"`       // 创建人姓名
    AssignedWorker    string `json:"assigned_worker" bson:"assigned_worker"`       // 返工工人
    AssignedWorkerName string `json:"assigned_worker_name" bson:"assigned_worker_name"` // 返工工人姓名
    CompletedAt       int64  `json:"completed_at" bson:"completed_at"`             // 完成时间
    Images            []string `json:"images" bson:"images"`                       // 返工照片
    Remark            string `json:"remark" bson:"remark"`                         // 备注
    IsDeleted         int    `json:"is_deleted" bson:"is_deleted"`                 // 是否删除
    CreatedAt         int64  `json:"created_at" bson:"created_at"`                 // 创建时间
    UpdatedAt         int64  `json:"updated_at" bson:"updated_at"`                 // 更新时间
}
```

## 四、API 接口设计

### 4.1 质检接口

#### 4.1.1 提交质检结果

**POST** `/production/inspections`

**请求参数：**
```json
{
  "order_id": "订单ID",
  "batch_id": "批次ID",
  "bundle_no": "扎号",
  "procedure_seq": 3,
  "procedure_name": "质检",
  "inspected_qty": 4800,
  "qualified_qty": 4600,
  "unqualified_qty": 200,
  "defect_types": ["线头", "污渍"],
  "defect_desc": "发现200件有线头和污渍",
  "color": "红色",
  "size": "L",
  "images": ["url1", "url2"],
  "remark": ""
}
```

**响应：**
```json
{
  "code": 200,
  "data": {
    "inspection_id": "xxx",
    "quality_rate": 95.83,
    "need_rework": true,
    "message": "质检记录成功，检测到200件不合格"
  }
}
```

#### 4.1.2 获取质检记录列表

**GET** `/production/inspections`

**查询参数：**
- `page`: 页码
- `page_size`: 每页数量
- `contract_no`: 合同号（可选）
- `start_date`: 开始日期（可选）
- `end_date`: 结束日期（可选）
- `inspector_id`: 质检员ID（可选，默认当前用户）

#### 4.1.3 获取质检统计

**GET** `/production/inspections/statistics`

**响应：**
```json
{
  "code": 200,
  "data": {
    "total_inspected": 50000,
    "total_qualified": 48500,
    "total_unqualified": 1500,
    "quality_rate": 97.0
  }
}
```

### 4.2 返工接口

#### 4.2.1 创建返工单

**POST** `/production/reworks`

**请求参数：**
```json
{
  "inspection_id": "质检记录ID",
  "order_id": "订单ID",
  "batch_id": "批次ID",
  "bundle_no": "扎号",
  "source_procedure": 2,
  "target_procedure": 1,
  "rework_qty": 200,
  "rework_reason": "打板有误",
  "assigned_worker": "工人ID",
  "color": "红色",
  "size": "L"
}
```

**响应：**
```json
{
  "code": 200,
  "data": {
    "rework_id": "xxx",
    "message": "返工单创建成功"
  }
}
```

#### 4.2.2 获取返工列表

**GET** `/production/reworks`

**查询参数：**
- `page`: 页码
- `page_size`: 每页数量
- `status`: 状态（0-待返工 1-返工中 2-已完成）
- `worker_id`: 工人ID（可选）
- `contract_no`: 合同号（可选）

#### 4.2.3 完成返工

**PUT** `/production/reworks/:id/complete`

**请求参数：**
```json
{
  "images": ["url1", "url2"],
  "remark": "返工完成"
}
```

#### 4.2.4 获取返工统计

**GET** `/production/reworks/statistics`

**响应：**
```json
{
  "code": 200,
  "data": {
    "total_rework": 1500,
    "pending": 200,
    "in_progress": 300,
    "completed": 1000
  }
}
```

## 五、小程序页面设计

### 5.1 质检页面 (pages/quality/inspection)

**功能：**
1. 扫码获取批次信息
2. 输入质检结果（合格数、不合格数）
3. 选择缺陷类型（多选）
4. 拍照记录缺陷
5. 提交质检结果

**页面元素：**
- 批次信息卡片
- 质检数量输入
- 合格数量输入
- 不合格数量输入
- 缺陷类型选择
- 缺陷描述输入
- 拍照按钮
- 提交按钮

### 5.2 返工管理页面 (pages/quality/rework)

**功能：**
1. 查看返工列表
2. 查看返工详情
3. 接受返工任务
4. 完成返工

**页面元素：**
- 返工列表
- 返工状态标签
- 返工详情弹窗
- 完成返工按钮

### 5.3 质检统计页面 (pages/quality/statistics)

**功能：**
1. 查看个人质检统计
2. 查看合格率趋势
3. 查看缺陷类型分布

## 六、业务规则

### 6.1 质检规则

1. **质检数量校验**：
   - 合格数量 + 不合格数量 = 质检数量
   - 质检数量 ≤ 批次总数量

2. **合格率计算**：
   - 合格率 = (合格数量 / 质检数量) × 100%

3. **自动触发返工**：
   - 如果不合格数量 > 0，自动标记为需要返工

### 6.2 返工规则

1. **返工数量限制**：
   - 返工数量 ≤ 不合格数量

2. **工序回退**：
   - 目标工序 ≤ 来源工序
   - 返工完成后，需要重新走完后续工序

3. **进度更新**：
   - 创建返工单时，减少来源工序的已完成数量
   - 返工完成后，增加目标工序的已完成数量

## 七、实施步骤

### 阶段1：数据模型和仓储层
- [ ] 创建 QualityInspection 模型
- [ ] 创建 ReworkRecord 模型
- [ ] 实现质检仓储接口
- [ ] 实现返工仓储接口

### 阶段2：服务层和API
- [ ] 实现质检服务
- [ ] 实现返工服务
- [ ] 创建质检 DTO
- [ ] 创建返工 DTO
- [ ] 实现质检 Endpoint
- [ ] 实现返工 Endpoint
- [ ] 实现质检 Transport
- [ ] 实现返工 Transport

### 阶段3：小程序页面
- [ ] 质检录入页面
- [ ] 质检记录列表页面
- [ ] 返工列表页面
- [ ] 返工详情页面
- [ ] 质检统计页面

### 阶段4：测试和优化
- [ ] 单元测试
- [ ] 集成测试
- [ ] 性能优化
- [ ] 用户体验优化

## 八、注意事项

1. **权限控制**：
   - 质检员才能提交质检结果
   - 返工任务需要指定工人或允许工人抢单

2. **数据一致性**：
   - 质检和返工需要更新批次工序进度
   - 需要事务保证数据一致性

3. **质检工价**：
   - 质检可能是独立工序，也可能是对已完成工序的检查
   - 如果是独立工序，按质检数量计算工资
   - 如果质检不合格率过高，可能影响原工序工人的工资

4. **返工工价**：
   - 返工一般不额外计算工资，因为是重新加工
   - 或者按返工数量的折扣价计算

5. **缺陷类型标准化**：
   - 建议维护一个缺陷类型字典
   - 便于统计分析和改进生产流程

