# 订单详情页工作流状态显示 ✅

## 🎉 实施完成

**完成时间**: 2025-10-18  
**状态**: ✅ 前端完整集成

## 📦 实施内容

### 1. 前端API服务

**文件**: `frontend/src/service/api/order.ts`

新增3个API接口：
```typescript
// 获取订单工作流状态
export function fetchOrderWorkflowState(orderId: string)

// 获取订单可用的状态转换
export function fetchOrderAvailableTransitions(orderId: string)

// 执行订单工作流状态转换
export function executeOrderWorkflowTransition(orderId: string, data: Api.Order.WorkflowTransitionRequest)
```

### 2. TypeScript类型定义

**文件**: `frontend/src/typings/api/order.d.ts`

新增类型定义：
```typescript
// 工作流实例
interface WorkflowInstance {
  id: string
  workflow_id: string
  entity_type: string
  entity_id: string
  current_state: string
  history: WorkflowHistory[]
  variables: Record<string, any>
  created_at: number
  updated_at: number
}

// 工作流历史记录
interface WorkflowHistory {
  from_state: string
  to_state: string
  event: string
  operator: string
  reason: string
  timestamp: number
  metadata?: Record<string, any>
}

// 工作流转换规则
interface WorkflowTransition {
  id: string
  name: string
  from_state: string
  to_state: string
  event: string
  conditions: TransitionCondition[]
  actions: TransitionAction[]
  require_role?: string
  description?: string
}
```

### 3. 工作流状态组件

**文件**: `frontend/src/views/order/orders/components/WorkflowStatus.vue`

**功能**：
- ✅ 显示当前工作流状态（带颜色标签）
- ✅ 显示可执行的状态转换按钮
- ✅ 显示完整的状态历史记录（时间轴）
- ✅ 状态转换模态框（带条件说明）
- ✅ 自动刷新机制

**特性**：
- 📊 状态可视化展示
- 🎨 颜色编码（草稿、已下单、生产中、已完成、已取消）
- 📝 历史记录追踪
- 🔄 一键状态转换
- ⚙️ 条件验证提示

### 4. 订单详情页集成

**文件**: `frontend/src/views/order/orders/components/ProgressDrawer.vue`

在订单详情抽屉顶部添加了工作流状态组件。

## 🎨 界面展示

### 当前状态显示
```
┌─────────────────────────┐
│ 工作流状态              │
├─────────────────────────┤
│ 当前状态                │
│ [生产中] 🟡             │
│                         │
│ 可执行操作              │
│ [完成订单]              │
│                         │
│ 状态历史                │
│ ○ 已完成 ─ 开始生产     │
│   2025-10-18 14:30      │
│   原因：裁剪完成        │
│                         │
│ ○ 生产中 ─ 提交订单     │
│   2025-10-18 10:00      │
│   原因：客户确认        │
│                         │
│ ○ 草稿 ─ 初始化         │
│   2025-10-18 09:00      │
└─────────────────────────┘
```

### 状态转换模态框
```
┌─────────────────────────┐
│ 完成订单                │
├─────────────────────────┤
│ 转换说明                │
│ 从 [生产中] 转换到      │
│ [已完成]                │
│                         │
│ 转换条件                │
│ • 进度必须达到100%      │
│                         │
│ 转换原因                │
│ ┌─────────────────────┐ │
│ │ 所有工序已完成      │ │
│ └─────────────────────┘ │
│                         │
│ [取消] [确认]           │
└─────────────────────────┘
```

## 🎯 状态颜色编码

| 状态 | 标签颜色 | 说明 |
|------|---------|------|
| draft | 灰色 (default) | 订单草稿 |
| ordered | 蓝色 (info) | 已下单 |
| production | 橙色 (warning) | 生产中 |
| completed | 绿色 (success) | 已完成 |
| cancelled | 红色 (error) | 已取消 |

## 📖 使用流程

### 1. 查看订单工作流状态

1. 在订单列表页点击"查看进度"
2. 抽屉顶部显示工作流状态卡片
3. 查看当前状态、历史记录

### 2. 执行状态转换

1. 点击"可执行操作"下的按钮
2. 在模态框中查看转换说明和条件
3. 输入转换原因（可选）
4. 点击"确认"执行转换
5. 转换成功后自动刷新状态

### 3. 查看历史记录

- 时间轴按时间倒序显示
- 显示状态转换的完整信息
- 包含操作人、原因、时间

## 💡 技术实现

### 组件生命周期

```typescript
onMounted() {
  loadWorkflowState()  // 加载工作流状态
}

async function loadWorkflowState() {
  // 1. 获取工作流实例
  const stateRes = await fetchOrderWorkflowState(orderId)
  
  // 2. 获取可用转换
  const transitionsRes = await fetchOrderAvailableTransitions(orderId)
}
```

### 状态转换流程

```typescript
async function handleTransition() {
  // 执行转换
  await executeOrderWorkflowTransition(orderId, {
    event: selectedTransition.event,
    reason: transitionForm.reason,
    metadata: {}
  })
  
  // 刷新状态
  await loadWorkflowState()
}
```

### 错误处理

- 如果订单未关联工作流，显示"该订单未关联工作流"
- 如果加载失败（非404），显示错误消息
- 如果转换失败，显示具体错误原因

## 🔧 扩展功能

### 自定义状态名称

在 `WorkflowStatus.vue` 中修改：

```typescript
const stateNameMap: Record<string, string> = {
  draft: '草稿',
  ordered: '已下单',
  production: '生产中',
  completed: '已完成',
  cancelled: '已取消',
  // 添加自定义状态
  your_state: '你的状态名称'
}
```

### 自定义状态颜色

```typescript
const stateTypeMap: Record<string, 'default' | 'info' | 'success' | 'warning' | 'error'> = {
  draft: 'default',
  ordered: 'info',
  production: 'warning',
  completed: 'success',
  cancelled: 'error',
  // 添加自定义颜色
  your_state: 'info'
}
```

### 添加元数据输入

在转换模态框中可以添加更多字段：

```vue
<NFormItem label="检验结果">
  <NInput v-model:value="transitionForm.metadata.quality_score" />
</NFormItem>
```

## 🎯 完整集成检查清单

- [x] ✅ 前端API服务创建
- [x] ✅ TypeScript类型定义
- [x] ✅ 工作流状态组件开发
- [x] ✅ 订单详情页集成
- [x] ✅ 状态可视化展示
- [x] ✅ 历史记录时间轴
- [x] ✅ 状态转换按钮
- [x] ✅ 转换模态框
- [x] ✅ 条件显示
- [x] ✅ 错误处理
- [x] ✅ 自动刷新

## 📸 组件截图说明

工作流状态组件包含以下部分：

1. **当前状态区域**
   - 大号彩色标签显示当前状态
   - 一目了然的状态识别

2. **可执行操作区域**
   - 根据当前状态动态显示可用按钮
   - 按钮文字来自工作流定义的转换名称

3. **状态历史区域**
   - 时间轴展示所有历史记录
   - 最新的记录在最上方
   - 显示完整的状态转换信息

4. **转换模态框**
   - 友好的转换说明
   - 条件提示（如果有）
   - 原因输入框

## 🚀 测试步骤

### 1. 前置条件
- 后端工作流系统已启动
- 数据库中有激活的 `order_basic` 工作流定义

### 2. 测试流程

1. **创建订单**
   ```bash
   POST /admin/order/orders
   {
     "contract_no": "TEST001",
     "customer_id": "customer_1"
   }
   ```

2. **查看工作流状态**
   - 在订单列表点击"查看进度"
   - 确认显示当前状态为"草稿"
   - 确认显示"提交订单"按钮

3. **执行状态转换**
   - 点击"提交订单"按钮
   - 输入转换原因
   - 点击确认
   - 确认状态变为"已下单"

4. **查看历史记录**
   - 确认显示2条历史记录（初始化 + 提交订单）
   - 确认时间、操作人、原因都正确显示

### 3. 边界测试

- [x] 订单未关联工作流时显示空状态
- [x] 没有可用转换时不显示按钮区域
- [x] 转换失败时显示错误提示
- [x] 条件不满足时后端返回错误

## 🎊 总结

订单详情页现在完整显示工作流状态！

**已实现功能**：
- ✅ 实时显示当前工作流状态
- ✅ 展示完整的历史记录
- ✅ 一键执行状态转换
- ✅ 友好的条件提示
- ✅ 完善的错误处理

**用户体验提升**：
- 📊 可视化状态展示
- 🎨 直观的颜色编码
- 📝 完整的操作日志
- 🔄 流畅的转换流程

**技术亮点**：
- 🏗️ 组件化设计
- 🔌 松耦合集成
- 🎯 TypeScript类型安全
- ⚡ 异步加载优化

现在用户可以在订单详情页：
1. 查看订单的工作流状态
2. 了解订单的流转历史
3. 快速执行状态转换
4. 获得实时的状态反馈

---

**实施状态**: ✅ 完成  
**可用性**: ✅ 立即可用  
**文档完整度**: ✅ 100%

