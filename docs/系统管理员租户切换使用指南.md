# 系统管理员租户切换使用指南

## ✅ 已实现的功能

### 后端

#### 1. 租户上下文切换中间件
**文件**: `core/middleware/tenant_context.go`

**功能**:
- 允许系统管理员通过 `X-Tenant-Context` header 临时切换到指定租户
- 验证用户是否有 `super` 角色
- 自动将租户ID注入到 Context

**使用**:
```go
// 在需要租户隔离的服务中应用
basic := r.Group("/basic")
basic.Use(authMiddleware)                    // JWT 认证
basic.Use(coreMdw.TenantContextMiddleware()) // 租户上下文切换 ✅
```

#### 2. Basic 服务已应用
**文件**: `cmd/basic/main.go`  
**状态**: ✅ 已添加中间件

### 前端

#### 1. HTTP 拦截器
**文件**: `frontend/src/service/http/alova.ts`

**功能**:
- 检测用户是否为系统管理员（`tenant_id` 为空）
- 如果已选择租户，自动添加 `X-Tenant-Context` header

```typescript
const userInfo = local.get('userInfo')
const selectedTenantId = local.get('selected_tenant_id')

if (userInfo && !userInfo.tenant_id && selectedTenantId) {
  method.config.headers['X-Tenant-Context'] = selectedTenantId  // ✅
}
```

#### 2. 租户选择器组件
**文件**: `frontend/src/components/TenantSelector.vue`

**功能**:
- 显示租户下拉选择框（仅系统管理员可见）
- 保存选择到 localStorage
- 切换租户时自动刷新页面

---

## 使用流程

### 系统管理员登录

```
1. 登录系统管理员账号
   - 账号: 17858361617
   - 密码: 123456
   - 租户代码: （留空）
   
2. 登录后 JWT 包含:
   - tenant_id: ""  (空 = 系统管理员)
   - role: ["super"]
```

### 切换到租户上下文

```
3. 在页面顶部出现租户选择器:
   ┌────────────────────────────────────┐
   │ 管理租户: [选择租户 ▼]             │
   │           - 所有租户（系统视图）    │
   │           - 租户A (code_a)         │
   │           - 租户B (code_b)         │
   └────────────────────────────────────┘

4. 选择"租户A"
   
5. 页面刷新，所有请求自动带上:
   X-Tenant-Context: {租户A的ID}
   
6. 后端收到请求:
   - 验证系统管理员权限 ✅
   - Context 切换到租户A
   - Repository 访问 mule_租户A 数据库
   
7. 现在看到的都是租户A的数据:
   - admin 管理员列表
   - role 角色列表
   - color 颜色数据
   - customer 客户数据
   等等...
```

### 切换回系统视图

```
8. 选择"所有租户（系统视图）"或清空选择
   
9. Context 恢复为空
   
10. 访问系统库数据
```

---

## 需要集成到布局

### 步骤1：在主布局中引入组件

找到主布局文件（通常是 `layouts/` 目录），添加：

```vue
<script setup>
import TenantSelector from '@/components/TenantSelector.vue'
</script>

<template>
  <div class="layout">
    <!-- 在顶部导航栏添加租户选择器 -->
    <header>
      <TenantSelector />  ←  添加这个
    </header>
    
    <!-- 其他布局内容 -->
    <router-view />
  </div>
</template>
```

### 步骤2：也可以应用到其他服务

```go
// cmd/system/main.go
system := r.Group("/system")
system.Use(authMiddleware)
system.Use(coreMdw.TenantContextMiddleware())  // ✅ 添加

// cmd/auth/main.go (某些接口)
protected := r.Group("/auth")
protected.Use(middleware.JWTAuth(jwtManager))
protected.Use(coreMdw.TenantContextMiddleware())  // ✅ 添加
```

---

## 安全性保证

1. **权限检查** ✅
   - 只有 `super` 角色可以切换租户上下文
   - 普通租户用户无法切换

2. **日志记录** ✅
   - 记录系统管理员的租户切换操作
   - 便于审计

3. **数据隔离** ✅
   - 未切换时，系统管理员只能看到系统库数据
   - 切换后，只能看到选定租户的数据
   - 不会混淆

---

## 使用场景

### 场景1：运维支持
系统管理员帮助租户A排查数据问题：
1. 切换到租户A
2. 查看租户A的所有数据
3. 进行调试和修改
4. 完成后切回系统视图

### 场景2：数据迁移
系统管理员为租户B导入数据：
1. 切换到租户B
2. 批量创建数据
3. 验证数据正确性
4. 切回系统视图

### 场景3：数据审计
系统管理员检查各租户数据：
1. 依次切换到每个租户
2. 查看数据统计
3. 生成报告

---

## 下一步实施

### ⚠️ 还需要做的

1. **找到主布局文件** - 添加 `<TenantSelector />` 组件
2. **应用到其他服务** - system、auth 服务也添加中间件
3. **测试功能** - 验证切换租户后数据正确

### 我可以帮你

**选项A**: 帮你找到布局文件并添加组件  
**选项B**: 应用中间件到所有服务  
**选项C**: 创建完整的测试和演示  

需要我继续吗？
