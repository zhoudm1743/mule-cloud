# 批量删除批次功能说明

## 一、功能概述

添加了"清空任务批次"功能，用于一键删除某个裁剪任务下的所有批次，方便重新生成正确的菲码。

## 二、业务场景

### 问题场景

1. **旧版菲码数量错误**：由于之前的BUG，一个菲码把所有尺码的数量加总了
   - 例如：扎号1，L码，显示100件（实际应该是50件，100是S+M+L的总和）

2. **需要重新生成菲码**：修复BUG后，需要重新创建批次和菲码
   - 如果手动删除，有100个批次需要删100次
   - 非常麻烦且容易出错

### 解决方案

提供"清空批次"功能：
- ✅ 一键删除某个任务的所有批次
- ✅ 删除对应的裁片监控记录
- ✅ 重置任务统计（已裁件数、状态）
- ✅ 然后可以重新使用批量创建功能

## 三、API接口

### 3.1 清空任务批次

**接口**：`DELETE /order/cutting/tasks/:taskId/batches`

**说明**：删除指定裁剪任务下的所有批次，并重置任务状态

**请求参数**：
- `taskId`：裁剪任务ID（路径参数）

**响应示例**：
```json
{
  "code": 200,
  "message": "清空成功，可以重新创建批次了"
}
```

## 四、使用流程

### 步骤1：清空批次

```bash
DELETE http://localhost:8081/order/cutting/tasks/{taskId}/batches
```

或者在前端页面点击"清空批次"按钮

### 步骤2：重新创建批次

使用批量创建接口重新创建正确的批次：

```bash
POST http://localhost:8081/order/cutting/batches/bulk
```

### 步骤3：打印菲码

打印新生成的菲码，替换旧的菲码

## 五、代码实现

### 5.1 Repository层

`internal/repository/cutting.go`

```go
// 添加按任务ID删除批次的方法
func DeleteByTaskID(ctx context.Context, taskID string) error
```

### 5.2 Service层

`app/order/services/cutting.go`

```go
// 清空任务的所有批次
func ClearTaskBatches(ctx context.Context, taskID string) error {
    // 1. 删除该任务的所有批次
    // 2. 删除对应的裁片监控记录
    // 3. 重置任务统计（已裁件数=0，状态=待裁剪）
}
```

### 5.3 Endpoint层

`app/order/endpoint/cutting.go`

```go
// 清空任务批次端点
func ClearTaskBatchesEndpoint(s services.ICuttingService) endpoint.Endpoint
```

### 5.4 Transport层

`app/order/transport/cutting.go`

```go
// 清空任务批次处理器
func ClearTaskBatchesHandler(svc services.ICuttingService) gin.HandlerFunc
```

### 5.5 路由注册

需要在路由中添加：

```go
// 在 cmd/order/main.go 或路由注册文件中添加
orderGroup.DELETE("/cutting/tasks/:taskId/batches", transport.ClearTaskBatchesHandler(cuttingSvc))
```

## 六、前端实现建议

### 6.1 在任务列表添加"清空批次"按钮

```vue
<template>
  <n-button 
    type="warning" 
    @click="handleClearBatches(task.id)"
    :disabled="task.cut_pieces === 0"
  >
    清空批次
  </n-button>
</template>

<script setup>
async function handleClearBatches(taskId) {
  const confirmed = await window.$dialog.confirm({
    title: '确认清空',
    content: '清空后，该任务的所有批次和菲码都将被删除，需要重新创建。确定要继续吗？',
    positiveText: '确定',
    negativeText: '取消'
  })
  
  if (confirmed) {
    try {
      await clearTaskBatches(taskId)
      window.$message.success('清空成功，现在可以重新创建批次了')
      fetchTaskData()
    } catch (error) {
      window.$message.error(error.message || '清空失败')
    }
  }
}
</script>
```

### 6.2 添加API方法

```typescript
// src/service/api/order.ts

export function clearTaskBatches(taskId: string) {
  return request.delete<Api.Common.ApiResult<any>>(`/order/cutting/tasks/${taskId}/batches`)
}
```

## 七、注意事项

### 7.1 数据安全

- ⚠️ 该操作会删除所有批次数据
- ⚠️ 如果已有工序上报记录，需要特别注意
- ✅ 建议添加二次确认提示

### 7.2 批次状态检查

建议在清空前检查：
- 是否有已打印的批次
- 是否有已开始生产的批次（已有上报记录）

如果有，可以提示用户：

```
警告：该任务已有 X 个批次被打印，Y 个批次已开始生产。
清空后这些数据将丢失，确定要继续吗？
```

### 7.3 工序上报数据

如果已有工序上报记录：
- 可以考虑保留上报记录
- 或者提示用户需要同步删除上报记录

## 八、测试建议

### 测试用例1：正常清空

1. 创建一个裁剪任务
2. 创建若干批次
3. 调用清空接口
4. 验证：
   - 批次全部被标记为删除
   - 裁片监控记录被删除
   - 任务状态重置为"待裁剪"
   - 已裁件数重置为0

### 测试用例2：重新创建

1. 清空批次后
2. 重新创建批次
3. 验证：
   - 可以正常创建
   - 菲码格式正确
   - 数量准确

### 测试用例3：边界情况

1. 对没有批次的任务调用清空
   - 应该成功，不报错
2. 对不存在的任务调用清空
   - 应该返回错误

## 九、更新日志

### 2025年10月19日

**新增功能**：
- ✅ 添加 `DeleteByTaskID` Repository方法
- ✅ 添加 `ClearTaskBatches` Service方法
- ✅ 添加清空批次的Endpoint和Handler
- ✅ 编写功能说明文档

**待完成**：
- ⏸️ 在路由中注册新接口（需要找到路由注册位置）
- ⏸️ 前端实现"清空批次"按钮
- ⏸️ 添加二次确认提示
- ⏸️ 测试功能是否正常

## 十、下一步

1. **找到路由注册位置**
   - 可能在 `cmd/order/main.go`
   - 或单独的路由文件中

2. **注册路由**
   ```go
   DELETE /order/cutting/tasks/:taskId/batches
   ```

3. **前端实现**
   - 在任务列表页添加"清空批次"按钮
   - 添加API方法
   - 添加确认对话框

4. **测试验证**
   - 清空功能是否正常
   - 重新创建是否正常
   - 菲码数据是否正确

