# 扫码打菲工序上报实施方案

## 一、功能概述

工人通过微信小程序扫描菲码（裁剪批次二维码），可以快速上报当前批次的工序完成情况，实现精细化的生产进度跟踪和计件工资统计。

**重要架构决策**：由于工序上报属于生产环节，已独立创建为 **production（生产）服务**，实现与订单服务的职责分离，更符合微服务架构原则。

## 二、业务流程

### 2.1 整体流程图

```
裁剪制菲 → 生成二维码 → 贴菲码 → 工序流转 → 扫码上报 → 进度统计 → 工资计算
```

### 2.2 详细流程

1. **裁剪制菲**：裁剪部门完成裁剪，制作菲码（CuttingBatch）
2. **二维码生成**：每个菲码包含唯一的二维码，**新版简化格式**包含以下核心信息：
   ```json
   {
     "batch_id": "批次ID（唯一标识）",
     "bed_no": "床号",
     "bundle_no": "扎号",
     "color": "颜色",
     "size": "尺码",
     "quantity": "数量"
   }
   ```
   
   **优势**：
   - ✅ **使用batch_id作为唯一标识**：直接定位到具体批次，准确无误
   - ✅ **简化数据结构**：只包含必要字段，减小二维码大小
   - ✅ **提高扫码速度**：数据量小，识别更快
   - ✅ **避免歧义**：通过ID查找，不再依赖组合字段
3. **工序流转**：菲码随着生产流程在各个工序之间流转
4. **工人扫码上报**：
   - 工人打开小程序扫描菲码
   - 系统识别菲码，获取订单和批次信息
   - 显示该订单的工序列表
   - 工人选择当前完成的工序
   - 提交上报，记录工序完成情况
5. **进度统计**：系统自动统计订单进度、工序进度
6. **工资计算**：根据上报记录，计算工人的计件工资

## 三、数据模型设计

### 3.1 工序上报记录（ProcedureReport）

```go
type ProcedureReport struct {
    ID            string  `json:"id" bson:"_id,omitempty"`
    OrderID       string  `json:"order_id" bson:"order_id"`             // 订单ID
    ContractNo    string  `json:"contract_no" bson:"contract_no"`       // 合同号
    StyleNo       string  `json:"style_no" bson:"style_no"`             // 款号
    BatchID       string  `json:"batch_id" bson:"batch_id"`             // 批次ID（可选，不分扎工序不需要）
    BundleNo      string  `json:"bundle_no" bson:"bundle_no"`           // 扎号（可选）
    Color         string  `json:"color" bson:"color"`                   // 颜色
    Size          string  `json:"size" bson:"size"`                     // 尺码（可选）
    Quantity      int     `json:"quantity" bson:"quantity"`             // 上报数量
    ProcedureSeq  int     `json:"procedure_seq" bson:"procedure_seq"`   // 工序序号
    ProcedureName string  `json:"procedure_name" bson:"procedure_name"` // 工序名称
    UnitPrice     float64 `json:"unit_price" bson:"unit_price"`         // 工价
    TotalPrice    float64 `json:"total_price" bson:"total_price"`       // 总工资 = 数量 * 工价
    WorkerID      string  `json:"worker_id" bson:"worker_id"`           // 工人ID（从登录信息获取）
    WorkerName    string  `json:"worker_name" bson:"worker_name"`       // 工人姓名
    WorkerNo      string  `json:"worker_no" bson:"worker_no"`           // 工号
    ReportTime    int64   `json:"report_time" bson:"report_time"`       // 上报时间
    Remark        string  `json:"remark" bson:"remark"`                 // 备注
    IsDeleted     int     `json:"is_deleted" bson:"is_deleted"`         // 是否删除
    CreatedAt     int64   `json:"created_at" bson:"created_at"`         // 创建时间
}
```

### 3.2 批次工序进度（BatchProcedureProgress）

用于跟踪每个批次在各工序的完成情况：

```go
type BatchProcedureProgress struct {
    ID            string `json:"id" bson:"_id,omitempty"`
    BatchID       string `json:"batch_id" bson:"batch_id"`             // 批次ID
    BundleNo      string `json:"bundle_no" bson:"bundle_no"`           // 扎号
    OrderID       string `json:"order_id" bson:"order_id"`             // 订单ID
    ProcedureSeq  int    `json:"procedure_seq" bson:"procedure_seq"`   // 工序序号
    ProcedureName string `json:"procedure_name" bson:"procedure_name"` // 工序名称
    Quantity      int    `json:"quantity" bson:"quantity"`             // 批次总数量
    ReportedQty   int    `json:"reported_qty" bson:"reported_qty"`     // 已上报数量
    IsCompleted   bool   `json:"is_completed" bson:"is_completed"`     // 是否完成
    CompletedAt   int64  `json:"completed_at" bson:"completed_at"`     // 完成时间
    UpdatedAt     int64  `json:"updated_at" bson:"updated_at"`         // 更新时间
}
```

### 3.3 订单工序进度汇总（OrderProcedureProgress）

用于订单级别的工序进度统计：

```go
type OrderProcedureProgress struct {
    ID            string  `json:"id" bson:"_id,omitempty"`
    OrderID       string  `json:"order_id" bson:"order_id"`             // 订单ID
    ProcedureSeq  int     `json:"procedure_seq" bson:"procedure_seq"`   // 工序序号
    ProcedureName string  `json:"procedure_name" bson:"procedure_name"` // 工序名称
    TotalQty      int     `json:"total_qty" bson:"total_qty"`           // 订单总数量
    ReportedQty   int     `json:"reported_qty" bson:"reported_qty"`     // 已上报数量
    Progress      float64 `json:"progress" bson:"progress"`             // 进度百分比
    UpdatedAt     int64   `json:"updated_at" bson:"updated_at"`         // 更新时间
}
```

## 四、后端API设计

### 4.1 扫码解析接口

**接口**：`POST /production/scan/parse`

**说明**：解析扫码内容，返回批次信息和订单信息

**请求体**（新版菲码格式）：
```json
{
  "qr_code": "{\"batch_id\":\"63f8a1b2c3d4e5f678901234\",\"bed_no\":\"1\",\"bundle_no\":\"01\",\"color\":\"红色\",\"size\":\"L\",\"quantity\":50}"
}
```

**响应**：
```json
{
  "code": 200,
  "data": {
    "batch": {
      "id": "63f8a1b2c3d4e5f678901234",
      "task_id": "63f8a1b2c3d4e5f678901233",
      "order_id": "63f8a1b2c3d4e5f678901232",
      "bundle_no": "01",
      "color": "红色",
      "size": "L",
      "quantity": 50,
      "bed_no": "1",
      "contract_no": "HT2024001",
      "style_no": "KH001"
    },
    "order": {
      "id": "订单ID",
      "contract_no": "HT2024001",
      "style_no": "KH001",
      "style_name": "春季衬衫",
      "style_image": "http://...",
      "customer_name": "张三",
      "procedures": [
        {
          "sequence": 1,
          "procedure_name": "车缝",
          "unit_price": 0.5,
          "assigned_worker": "",
          "no_bundle": false
        },
        {
          "sequence": 2,
          "procedure_name": "质检",
          "unit_price": 0.3,
          "assigned_worker": "",
          "no_bundle": true
        }
      ]
    },
    "batch_progress": [
      {
        "procedure_seq": 1,
        "procedure_name": "车缝",
        "reported_qty": 0,
        "is_completed": false
      }
    ]
  }
}
```

### 4.2 工序上报接口

**接口**：`POST /production/reports`

**说明**：提交工序完成上报

**请求体**：
```json
{
  "order_id": "订单ID",
  "batch_id": "批次ID",
  "bundle_no": "001",
  "procedure_seq": 1,
  "procedure_name": "车缝",
  "quantity": 50,
  "color": "红色",
  "size": "L",
  "remark": ""
}
```

**响应**：
```json
{
  "code": 200,
  "data": {
    "report_id": "上报记录ID",
    "total_price": 25.0,
    "message": "上报成功"
  }
}
```

### 4.3 工序上报历史接口

**接口**：`GET /production/reports`

**说明**：查询工序上报历史记录

**请求参数**：
- `page`: 页码（默认1）
- `page_size`: 每页数量（默认20）
- `worker_id`: 工人ID（可选，不传则查询当前登录工人）
- `start_date`: 开始日期（可选）
- `end_date`: 结束日期（可选）
- `contract_no`: 合同号（可选）

**响应**：
```json
{
  "code": 200,
  "data": {
    "reports": [
      {
        "id": "记录ID",
        "contract_no": "HT2024001",
        "style_no": "KH001",
        "bundle_no": "001",
        "color": "红色",
        "size": "L",
        "procedure_name": "车缝",
        "quantity": 50,
        "unit_price": 0.5,
        "total_price": 25.0,
        "report_time": 1697688000,
        "remark": ""
      }
    ],
    "total": 100,
    "statistics": {
      "total_quantity": 5000,
      "total_amount": 2500.0
    }
  }
}
```

### 4.4 订单工序进度查询接口

**接口**：`GET /production/progress/:order_id`

**说明**：查询订单的工序进度

**响应**：
```json
{
  "code": 200,
  "data": {
    "order_id": "订单ID",
    "contract_no": "HT2024001",
    "total_quantity": 1000,
    "procedures": [
      {
        "procedure_seq": 1,
        "procedure_name": "车缝",
        "total_qty": 1000,
        "reported_qty": 800,
        "progress": 80.0
      },
      {
        "procedure_seq": 2,
        "procedure_name": "质检",
        "total_qty": 1000,
        "reported_qty": 500,
        "progress": 50.0
      }
    ],
    "overall_progress": 65.0
  }
}
```

### 4.5 工人工资统计接口

**接口**：`GET /production/salary`

**说明**：统计工人的计件工资

**请求参数**：
- `worker_id`: 工人ID（可选，不传则查询当前登录工人）
- `start_date`: 开始日期
- `end_date`: 结束日期

**响应**：
```json
{
  "code": 200,
  "data": {
    "worker_id": "工人ID",
    "worker_name": "张三",
    "worker_no": "W001",
    "start_date": "2024-10-01",
    "end_date": "2024-10-31",
    "total_quantity": 5000,
    "total_amount": 2500.0,
    "details": [
      {
        "procedure_name": "车缝",
        "quantity": 3000,
        "unit_price": 0.5,
        "amount": 1500.0
      },
      {
        "procedure_name": "质检",
        "quantity": 2000,
        "unit_price": 0.5,
        "amount": 1000.0
      }
    ]
  }
}
```

## 五、小程序实现方案

### 5.1 页面结构

```
pages/
├── scan/
│   └── scan.vue           # 扫码页面（已有）
├── report/
│   ├── detail.vue         # 上报详情页
│   ├── history.vue        # 上报历史页
│   └── salary.vue         # 工资统计页
```

### 5.2 扫码流程实现

#### 5.2.1 扫码识别（scan.vue）

```javascript
// 扫码成功回调
const onScanCode = async (e) => {
  const qrCode = e.detail.result
  
  try {
    uni.showLoading({ title: '识别中...' })
    
    // 调用后端解析接口
    const res = await scanApi.parseScanCode({ qr_code: qrCode })
    
    uni.hideLoading()
    
    // 跳转到上报详情页
    uni.navigateTo({
      url: `/pages/report/detail?data=${encodeURIComponent(JSON.stringify(res.data))}`
    })
  } catch (error) {
    uni.hideLoading()
    uni.showModal({
      title: '识别失败',
      content: error.message || '无法识别该二维码',
      showCancel: false
    })
  }
}
```

#### 5.2.2 上报详情页（report/detail.vue）

**页面功能**：
1. 显示扫码信息（合同号、款号、扎号、颜色、尺码、数量）
2. 显示订单工序列表
3. 选择要上报的工序
4. 显示该工序的工价和预计工资
5. 显示该批次该工序的已上报情况
6. 输入备注（可选）
7. 提交上报

**页面布局**：
```vue
<template>
  <view class="report-detail">
    <!-- 批次信息卡片 -->
    <view class="batch-info">
      <view class="info-header">
        <image :src="batchData.order.style_image" class="style-image" />
        <view class="info-text">
          <view class="style-name">{{ batchData.order.style_name }}</view>
          <view class="contract-no">合同号：{{ batchData.batch.contract_no }}</view>
        </view>
      </view>
      <view class="info-grid">
        <view class="info-item">
          <text class="label">扎号</text>
          <text class="value">{{ batchData.batch.bundle_no }}</text>
        </view>
        <view class="info-item">
          <text class="label">颜色</text>
          <text class="value">{{ batchData.batch.color }}</text>
        </view>
        <view class="info-item">
          <text class="label">尺码</text>
          <text class="value">{{ batchData.batch.size }}</text>
        </view>
        <view class="info-item">
          <text class="label">数量</text>
          <text class="value highlight">{{ batchData.batch.quantity }}</text>
        </view>
      </view>
    </view>
    
    <!-- 工序选择 -->
    <view class="procedure-section">
      <view class="section-title">选择工序</view>
      <view class="procedure-list">
        <view 
          v-for="proc in batchData.order.procedures" 
          :key="proc.sequence"
          :class="['procedure-item', { 'active': selectedProcedure?.sequence === proc.sequence }]"
          @click="selectProcedure(proc)"
        >
          <view class="proc-info">
            <view class="proc-name">
              <text class="seq-badge">{{ proc.sequence }}</text>
              <text>{{ proc.procedure_name }}</text>
            </view>
            <view class="proc-price">{{ proc.unit_price }}元/件</view>
          </view>
          <view class="proc-progress" v-if="getProcedureProgress(proc.sequence)">
            <text>已上报：{{ getProcedureProgress(proc.sequence).reported_qty }}/{{ batchData.batch.quantity }}</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- 上报信息 -->
    <view class="report-info" v-if="selectedProcedure">
      <view class="info-row">
        <text class="label">上报数量</text>
        <text class="value">{{ batchData.batch.quantity }} 件</text>
      </view>
      <view class="info-row">
        <text class="label">单价</text>
        <text class="value">{{ selectedProcedure.unit_price }} 元/件</text>
      </view>
      <view class="info-row highlight">
        <text class="label">预计工资</text>
        <text class="value">{{ calculateSalary() }} 元</text>
      </view>
    </view>
    
    <!-- 备注 -->
    <view class="remark-section">
      <textarea 
        v-model="remark" 
        placeholder="备注（可选）" 
        maxlength="200"
        class="remark-input"
      />
    </view>
    
    <!-- 提交按钮 -->
    <view class="submit-section">
      <button 
        type="primary" 
        :disabled="!selectedProcedure"
        @click="submitReport"
        class="submit-btn"
      >
        提交上报
      </button>
    </view>
  </view>
</template>
```

**核心逻辑**：
```javascript
import { ref, computed } from 'vue'
import { submitProcedureReport } from '@/api/scan'

export default {
  setup() {
    const batchData = ref(null)
    const selectedProcedure = ref(null)
    const remark = ref('')
    
    // 选择工序
    const selectProcedure = (proc) => {
      selectedProcedure.value = proc
    }
    
    // 获取工序进度
    const getProcedureProgress = (seq) => {
      return batchData.value.batch_progress.find(p => p.procedure_seq === seq)
    }
    
    // 计算预计工资
    const calculateSalary = () => {
      if (!selectedProcedure.value) return 0
      return (batchData.value.batch.quantity * selectedProcedure.value.unit_price).toFixed(2)
    }
    
    // 提交上报
    const submitReport = async () => {
      if (!selectedProcedure.value) {
        uni.showToast({ title: '请选择工序', icon: 'none' })
        return
      }
      
      // 检查是否已完成上报
      const progress = getProcedureProgress(selectedProcedure.value.sequence)
      if (progress && progress.is_completed) {
        uni.showModal({
          title: '提示',
          content: '该批次该工序已全部上报，确定要重复上报吗？',
          success: async (res) => {
            if (res.confirm) {
              await doSubmit()
            }
          }
        })
        return
      }
      
      await doSubmit()
    }
    
    const doSubmit = async () => {
      try {
        uni.showLoading({ title: '提交中...' })
        
        const params = {
          order_id: batchData.value.order.id,
          batch_id: batchData.value.batch.id,
          bundle_no: batchData.value.batch.bundle_no,
          procedure_seq: selectedProcedure.value.sequence,
          procedure_name: selectedProcedure.value.procedure_name,
          quantity: batchData.value.batch.quantity,
          color: batchData.value.batch.color,
          size: batchData.value.batch.size,
          remark: remark.value
        }
        
        const res = await submitProcedureReport(params)
        
        uni.hideLoading()
        
        // 显示上报成功
        uni.showModal({
          title: '上报成功',
          content: `工资：${res.data.total_price} 元`,
          showCancel: false,
          success: () => {
            // 返回扫码页，继续扫码
            uni.navigateBack()
          }
        })
      } catch (error) {
        uni.hideLoading()
        uni.showModal({
          title: '上报失败',
          content: error.message || '网络错误',
          showCancel: false
        })
      }
    }
    
    return {
      batchData,
      selectedProcedure,
      remark,
      selectProcedure,
      getProcedureProgress,
      calculateSalary,
      submitReport
    }
  }
}
```

### 5.3 上报历史页（report/history.vue）

**页面功能**：
1. 显示工人的上报历史记录
2. 按日期、合同号筛选
3. 显示统计信息（总数量、总工资）
4. 支持下拉刷新、上拉加载

**页面布局**：
```vue
<template>
  <view class="report-history">
    <!-- 统计卡片 -->
    <view class="statistics">
      <view class="stat-item">
        <text class="stat-value">{{ statistics.total_quantity }}</text>
        <text class="stat-label">总件数</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">¥{{ statistics.total_amount }}</text>
        <text class="stat-label">总工资</text>
      </view>
    </view>
    
    <!-- 筛选栏 -->
    <view class="filter-bar">
      <picker mode="date" @change="onDateChange">
        <view class="filter-item">
          <text>{{ filterDate || '选择日期' }}</text>
          <u-icon name="calendar" size="20" />
        </view>
      </picker>
    </view>
    
    <!-- 记录列表 -->
    <view class="record-list">
      <view 
        v-for="record in records" 
        :key="record.id"
        class="record-item"
      >
        <view class="record-header">
          <text class="contract-no">{{ record.contract_no }}</text>
          <text class="amount">¥{{ record.total_price }}</text>
        </view>
        <view class="record-body">
          <view class="record-info">
            <text>扎号：{{ record.bundle_no }}</text>
            <text>工序：{{ record.procedure_name }}</text>
          </view>
          <view class="record-info">
            <text>{{ record.color }} / {{ record.size }}</text>
            <text>{{ record.quantity }}件 × {{ record.unit_price }}元</text>
          </view>
        </view>
        <view class="record-footer">
          <text class="time">{{ formatTime(record.report_time) }}</text>
        </view>
      </view>
    </view>
  </view>
</template>
```

### 5.4 工资统计页（report/salary.vue）

**页面功能**：
1. 按月统计工资
2. 按工序分类显示
3. 显示详细的计件数据

## 六、实施步骤

### 阶段一：后端开发（1-2天）✅ 已完成

1. **创建数据模型** ✅
   - `internal/models/production.go`：工序上报记录模型
   - 添加批次工序进度和订单工序进度模型

2. **创建数据访问层** ✅
   - `internal/repository/procedure_report.go`：CRUD操作
   - `internal/repository/batch_procedure_progress.go`：批次工序进度
   - `internal/repository/order_procedure_progress.go`：订单工序进度
   - **支持租户数据库隔离**：所有 Repository 使用 `GetCollectionWithContext(ctx)` 方法

3. **创建业务服务层** ✅
   - `app/production/services/scan.go`：扫码解析服务
   - `app/production/services/report.go`：工序上报服务
   - 实现扫码解析、工序上报、进度更新、工资统计

4. **创建端点和传输层** ✅
   - `app/production/dto/scan.go`、`app/production/dto/report.go`：DTO定义
   - `app/production/endpoint/scan.go`、`app/production/endpoint/report.go`：端点定义
   - `app/production/transport/scan.go`、`app/production/transport/report.go`：HTTP处理器

5. **创建主程序和配置文件** ✅
   - `cmd/production/main.go`：服务主程序
   - `config/production.yaml`：配置文件（端口：8007）

### 阶段二：小程序开发（2-3天）✅ 核心功能已完成

1. **创建API接口封装** ✅
   - `wxApp/src/api/scan.js`：扫码和上报相关API

2. **完善扫码页面** ✅
   - 修改 `scan.vue`，实现扫码后的数据处理和跳转

3. **创建上报详情页** ✅
   - `pages/report/detail.vue`：上报详情和提交
   - 显示批次信息、工序选择、工资预览、提交上报

4. **创建历史记录页** ✅
   - `pages/report/history.vue`：上报历史查询
   - 显示统计数据、记录列表、日期筛选

5. **创建工资统计页** ⏸️
   - `pages/report/salary.vue`：工资统计展示（可后续扩展）

6. **优化用户体验** ✅
   - 添加加载动画、错误提示
   - 优化交互流程和视觉效果

### 阶段三：测试与优化（1-2天）⏳ 待进行

1. **功能测试**
   - 扫码识别测试
   - 上报流程测试
   - 数据统计测试

2. **边界测试**
   - 重复上报处理
   - 数据异常处理
   - 网络异常处理

3. **性能优化**
   - 查询优化
   - 缓存策略
   - 并发控制

## 七、服务启动方式

### 启动 Production 服务

```bash
# 编译
go build -o production.exe cmd/production/main.go

# 运行
./production.exe -config=config/production.yaml
```

### 服务信息

- **服务名称**：production-service
- **端口**：8007
- **路由前缀**：`/production`
- **注册到 Consul**：是（可通过网关访问）

### 通过网关访问

- 网关地址：`http://gateway:8080/admin/production/*`
- 直接访问：`http://localhost:8007/production/*`

### 数据库说明

Production 服务使用租户数据库隔离，所有数据存储在对应租户的数据库中：

- **系统库**：`mule`（存储系统级别数据）
- **租户库**：`mule_tenant_{tenant_code}`（存储租户生产数据）

集合列表：
- `procedure_reports`：工序上报记录
- `batch_procedure_progress`：批次工序进度
- `order_procedure_progress`：订单工序进度

## 八、关键技术点

### 7.1 不分扎工序处理

某些工序（如质检）设置了 `no_bundle: true`，表示不需要按扎上报，而是按订单整体上报。

**处理方式**：
- 扫码后检查工序的 `no_bundle` 属性
- 如果为 `true`，则不限制扎号，允许批量上报
- 上报时 `batch_id` 和 `bundle_no` 可以为空

### 7.2 重复上报控制

**场景**：同一批次同一工序可能被多次扫码上报（如返工、补报）

**处理方式**：
- 允许重复上报，但需要提示用户
- 记录每次上报的详细信息
- 在工资统计时需要考虑重复上报的情况
- 可以设置上报上限（如不超过批次数量的110%）

### 7.3 工序顺序控制

**场景**：工序有先后顺序，应该按序完成

**处理方式**：
- 方案1：严格控制，只允许上报当前应该完成的工序
- 方案2：宽松控制，允许跨工序上报，但给出提示
- 建议采用方案2，提高灵活性

### 7.4 离线上报

**场景**：车间网络不稳定，需要支持离线上报

**处理方式**：
- 将上报数据暂存本地
- 网络恢复后自动同步
- 显示同步状态

### 7.5 数据同步与一致性

**问题**：多个工人可能同时上报同一批次的同一工序

**处理方式**：
- 使用数据库事务保证一致性
- 更新进度时使用原子操作
- 乐观锁处理并发冲突

## 九、扩展功能（后期）

1. **质量检查**：不合格品记录和返工流程
2. **实时统计**：工序进度实时看板
3. **异常预警**：进度延迟、质量问题预警
4. **排名激励**：工人产量排行榜
5. **智能分配**：根据工人技能自动分配工序
6. **语音上报**：支持语音识别快速上报
7. **批量扫码**：一次扫描多个菲码
8. **工资预发**：根据实时上报数据预发工资

## 十、注意事项

1. **权限控制**：确保工人只能查看和上报自己的数据
2. **数据安全**：工资数据需要加密传输
3. **性能优化**：大量数据时需要分页和索引优化
4. **用户体验**：扫码要快速响应，操作要简单直观
5. **容错处理**：网络异常、数据异常要有友好提示
6. **审计日志**：重要操作需要记录日志
7. **数据备份**：定期备份上报数据，防止数据丢失

## 十一、总结

本方案设计并**已实现**了一套完整的扫码打菲工序上报系统，涵盖了从数据模型、API接口到小程序页面的全部内容。通过扫码快速上报工序，不仅可以准确跟踪生产进度，还能实时计算工人工资，大大提高了生产管理的效率和准确性。

**核心优势**：
- ✅ 操作简单：扫码即可上报，无需手工输入
- ✅ 数据准确：自动识别批次信息，减少人工错误
- ✅ 实时统计：即时更新进度和工资数据
- ✅ 灵活可扩展：支持不分扎工序、重复上报等特殊场景
- ✅ 用户友好：清晰的界面和流畅的交互体验
- ✅ 租户隔离：支持多租户数据库级别隔离
- ✅ 微服务架构：独立的 production 服务，职责清晰

## 十二、已完成内容清单

### 后端（100%）

✅ 数据模型：
- `internal/models/production.go`

✅ Repository层：
- `internal/repository/procedure_report.go`
- `internal/repository/batch_procedure_progress.go`
- `internal/repository/order_procedure_progress.go`

✅ Service层：
- `app/production/services/scan.go`
- `app/production/services/report.go`

✅ DTO层：
- `app/production/dto/scan.go`
- `app/production/dto/report.go`

✅ Endpoint层：
- `app/production/endpoint/scan.go`
- `app/production/endpoint/report.go`

✅ Transport层：
- `app/production/transport/scan.go`
- `app/production/transport/report.go`

✅ 主程序和配置：
- `cmd/production/main.go`
- `config/production.yaml`

### 小程序（90%）

✅ API封装：
- `wxApp/src/api/scan.js`

✅ 页面实现：
- `wxApp/src/pages/scan/scan.vue`（已完善）
- `wxApp/src/pages/report/detail.vue`（上报详情页）
- `wxApp/src/pages/report/history.vue`（历史记录页）

⏸️ 待扩展：
- 工资统计页（可后续添加）

### 下一步行动

1. **启动服务测试**：编译并启动 production 服务
2. **联调测试**：测试扫码、上报、查询等功能
3. **前端配置**：确保小程序能访问到 production 服务（通过网关）
4. **数据验证**：验证租户隔离和数据统计的准确性

## 十三、重要更新记录（2025年10月）

### 菲码JSON格式优化 ✅

**更新时间**：2025年10月19日

**更新内容**：

1. **简化菲码JSON结构**
   - **旧版格式**：包含 task_id, order_id, contract_no, style_no, layer_count, size_details 等大量字段
   - **新版格式**：只包含 6 个核心字段
     ```json
     {
       "batch_id": "批次ID",
       "bed_no": "床号",
       "bundle_no": "扎号",
       "color": "颜色",
       "size": "尺码",
       "quantity": "数量"
     }
     ```

2. **使用batch_id作为主键**
   - 在批次创建时先生成ID，然后生成包含该ID的二维码
   - 扫码时优先通过 batch_id 直接查找批次
   - 上报时通过 batch_id 获取完整批次信息，确保数据准确

3. **修改的文件**
   - `app/order/services/cutting.go`：修改 CreateCuttingBatch 和 BulkCreateCuttingBatch 方法
   - `app/production/services/scan.go`：优先使用 batch_id 解析扫码
   - `app/production/services/report.go`：通过 batch_id 获取准确的批次信息进行上报

4. **优势**
   - ✅ **准确性提升**：直接通过ID查找，避免了"订单号+床号+扎号"组合查询可能的歧义
   - ✅ **性能提升**：ID查询比多字段组合查询更快
   - ✅ **数据简化**：二维码数据量减少约60%，识别速度更快
   - ✅ **维护性好**：逻辑更清晰，代码更易维护

5. **兼容性**
   - 保留了对旧版菲码格式的兼容，如果没有 batch_id 字段，会尝试使用 order_id 和其他字段查找
   - 建议重新打印所有菲码以使用新格式

**影响范围**：
- 裁剪制菲功能
- 扫码上报功能
- 生产进度跟踪

**测试建议**：
1. 创建新的裁剪批次，验证二维码格式
2. 扫描新格式的菲码，验证解析正确
3. 进行工序上报，验证数据准确性
4. 测试旧格式菲码的兼容性

