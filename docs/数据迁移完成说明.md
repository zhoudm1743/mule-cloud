# 数据迁移完成说明

## ✅ 已完成的迁移

### 迁移内容
将 `admin` 和 `role` 数据从系统库（tenant_system）迁移到租户库（mule_xxx）

### 迁移结果

```
源: tenant_system
  ├── admin (1 条) → 已迁移
  └── role (1 条) → 已迁移

目标: mule_68dda6cd04ba0d6c8dda4b7a
  ├── admin (1 条) ✅
  └── role (1 条) ✅
```

**迁移的数据：**
- **管理员**: 羊紫林 (17858361617)
- **角色**: 系统管理员 (fgfgy)

### 代码调整

#### RoleRepository ✅
```go
// getCollection 获取集合（自动根据Context中的租户ID切换数据库）
func (r *roleRepository) getCollection(ctx context.Context) *mongo.Collection {
    tenantID := tenantCtx.GetTenantID(ctx)
    db := r.dbManager.GetDatabase(tenantID)  // 切换到 mule_xxx
    return db.Collection("role")
}
```

#### AdminRepository ✅
```go
// getCollection 获取集合（自动根据Context中的租户ID切换数据库）
func (r *adminRepository) getCollection(ctx context.Context) *mongo.Collection {
    tenantID := tenantCtx.GetTenantID(ctx)
    db := r.dbManager.GetDatabase(tenantID)  // 切换到 mule_xxx
    return db.Collection("admin")
}
```

## 正确的架构

### 系统库（tenant_system）
- ✅ **tenant** - 租户元数据（全局唯一）
- ✅ **menu** - 菜单配置（全局共享）

### 租户库（mule_xxx）
- ✅ **admin** - 租户管理员（物理隔离）
- ✅ **role** - 租户角色（物理隔离）
- ✅ **业务数据** - color, customer, order_type 等（物理隔离）

## 登录流程验证

### 1. 租户用户登录
```
POST /admin/auth/login
{
    "phone": "17858361617",
    "password": "123456",
    "tenant_code": "default"
}

流程：
1. 根据 tenant_code 查询租户 (tenant_system.tenant)
2. 获取 tenant_id: "68dda6cd04ba0d6c8dda4b7a"
3. 切换到租户库 (mule_68dda6cd04ba0d6c8dda4b7a)
4. 查询管理员 (mule_68dda6cd04ba0d6c8dda4b7a.admin)
5. 生成 JWT (包含 tenant_id)
```

### 2. 查询角色列表
```
GET /admin/system/roles
Header: Authorization: Bearer {token}

流程：
1. 中间件解析 JWT，获取 tenant_id
2. 注入到 Context
3. RoleRepository 自动切换到 mule_68dda6cd04ba0d6c8dda4b7a
4. 返回该租户的角色列表
```

## 下一步

### 1. 测试登录 ✅
```bash
# 使用租户代码登录
POST /admin/auth/login
{
    "phone": "17858361617",
    "password": "123456",
    "tenant_code": "default"
}
```

### 2. 测试角色功能
- 查询角色列表
- 编辑角色
- 分配菜单权限

### 3. 确认功能正常后清理系统库
```bash
py scripts/cleanup_system_admin_role.py
```

## 注意事项

1. **系统库中的数据暂时保留**，用于回滚
2. **测试通过后再清理**系统库
3. **admin 和 role 现在在租户库**，每个租户独立
4. **物理隔离**：租户 A 无法访问租户 B 的数据

## 安全性

✅ **数据库级别隔离** - 每个租户数据在独立数据库  
✅ **Context 传递** - 通过 JWT 自动切换数据库  
✅ **Repository 自动切换** - 无需手动指定数据库  
✅ **防止跨租户访问** - 物理层面无法访问其他租户数据

