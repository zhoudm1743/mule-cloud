# 修复 - 租户菜单自动添加父级问题

## 🐛 问题现象

给租户分配菜单时：
1. 取消勾选"菜单管理"和"租户管理"
2. 点击"确定"保存
3. 提示"分配权限成功"
4. 再次打开编辑
5. **"菜单管理"和"租户管理"又回来了！** ❌

## 🔍 问题原因

### 前端逻辑问题

**文件**：`frontend/src/views/auth/tenant/components/TableModal.vue:169-189`

```typescript
// ❌ 有问题的代码
else if (modalType.value === 'assignMenus') {
  // 自动添加父级菜单（确保菜单层级完整）
  const menusWithParents = new Set<string>(formModel.menus || [])
  
  // 为每个选中的菜单，递归添加其所有父级菜单
  const addParentMenus = (menuName: string) => {
    const menu = allMenus.value.find(m => m.name === menuName)
    if (menu && menu.pid) {
      const parentMenu = allMenus.value.find(m => m.id === menu.pid)
      if (parentMenu && parentMenu.name) {
        menusWithParents.add(parentMenu.name)  // ← 无条件添加父菜单！
        addParentMenus(parentMenu.name)
      }
    }
  }
  
  // 为所有选中的菜单添加父级
  (formModel.menus || []).forEach(menuName => {
    addParentMenus(menuName)
  })
  
  await assignTenantMenus(formModel.id, { menus: Array.from(menusWithParents) })
}
```

### 问题链路

1. **用户选择菜单**：
   - ✅ Dashboard
   - ✅ 基础信息（及其子菜单）
   - ✅ 权限管理（父菜单）
     - ✅ 管理员管理
     - ✅ 角色管理
     - ❌ 菜单管理（未勾选）
     - ❌ 租户管理（未勾选）

2. **前端处理**：
   - `formModel.menus` = `["dashboard", "basic", "color", ..., "auth", "auth_admin", "auth_role"]`
   - 执行 `addParentMenus` 逻辑
   - 为 `auth_admin` 添加父菜单 `auth`
   - `auth` 已经在列表中，看起来没问题

3. **保存到后端**：
   - 后端保存菜单列表

4. **再次打开编辑**：
   - 后端返回的租户数据：`{ menus: [...] }`
   - 前端从**所有菜单列表**构建树
   - **问题**：数据库中的菜单列表可能包含旧数据！

### 为什么会包含旧数据？

可能的原因：
1. 第一次保存时，虽然前端去掉了 `system_menu` 和 `system_tenant`
2. 但后端可能有缓存或其他逻辑又把它们加回去了
3. 或者数据库中本来就有这些数据，第一次保存没有真正覆盖

---

## ✅ 解决方案

### 修复：移除自动添加父级菜单的逻辑

**原因**：
- 租户不应该拥有系统级别的菜单
- 即使这些是父级菜单，也不应该自动添加
- 应该由系统管理员**明确指定**租户可以访问哪些菜单

**修改**：`frontend/src/views/auth/tenant/components/TableModal.vue:163-200`

```typescript
else if (modalType.value === 'assignMenus') {
  if (!formModel.id) {
    window.$message.error('缺少租户ID')
    return
  }
  
  // ✅ 租户菜单分配：直接保存用户选择的菜单，不自动添加父级
  // 原因：租户不应该拥有系统级别的菜单（如 system_menu, system_tenant）
  // 即使这些是父级菜单，也不应该自动添加
  
  console.log('[租户菜单保存] 选中的菜单:', formModel.menus)
  
  await assignTenantMenus(formModel.id, { menus: formModel.menus || [] })
  window.$message.success('分配权限成功')
}
```

---

## 🎯 测试步骤

### 1. 刷新前端

按 `Ctrl + Shift + R` 强制刷新浏览器，确保加载最新代码。

### 2. 重新分配菜单

1. **系统管理员登录**
2. **进入"租户管理"**
3. **点击"分配权限菜单"**
4. **取消勾选**：
   - ❌ 菜单管理
   - ❌ 租户管理
5. **点击"确定"**
6. **查看控制台**：应该看到日志 `[租户菜单保存] 选中的菜单: [...]`

### 3. 验证

1. **再次点击"分配权限菜单"**
2. **检查菜单列表**

**期望结果**：
- ✅ "菜单管理"和"租户管理"保持未勾选状态
- ✅ 多次打开编辑，状态一致
- ✅ 租户用户登录后看不到这两个菜单

**不应该看到**：
- ❌ 保存后菜单又回来了
- ❌ 勾选状态反复变化

---

## 📊 对比：角色菜单 vs 租户菜单

### 角色菜单分配

**需要自动添加父级菜单** ✅

**原因**：
- 角色在租户内部
- 租户已经定义了可用菜单范围
- 角色只能在租户的范围内分配
- 需要完整的菜单树结构才能正常显示

**代码**：`frontend/src/views/auth/role/components/TableModal.vue:328-366`
```typescript
// 自动添加父级菜单（仅在租户拥有的菜单范围内）
const availableMenus = isSystemAdmin.value 
  ? allMenus.value.map(m => m.name)
  : tenantMenus.value  // ← 限制在租户范围内

// 为每个选中的菜单，递归添加其所有父级菜单
const addParentMenus = (menuName: string) => {
  const menu = allMenus.value.find(m => m.name === menuName)
  if (menu && menu.pid) {
    const parentMenu = allMenus.value.find(m => m.id === menu.pid)
    if (parentMenu && parentMenu.name) {
      // 只有当父菜单在可用范围内时才添加
      if (availableMenus.includes(parentMenu.name)) {  // ← 有范围限制
        menusWithParents.add(parentMenu.name)
        addParentMenus(parentMenu.name)
      }
    }
  }
}
```

### 租户菜单分配

**不应该自动添加父级菜单** ❌

**原因**：
- 租户直接从系统获取菜单
- 没有上层的范围限制
- 系统管理员应该**明确指定**租户可以访问的菜单
- 避免意外授予系统级别的权限

**代码**：`frontend/src/views/auth/tenant/components/TableModal.vue:163-174`
```typescript
// ✅ 直接保存用户选择的菜单
await assignTenantMenus(formModel.id, { menus: formModel.menus || [] })
```

---

## 🎉 修复完成

- ✅ 移除了租户菜单的自动添加父级逻辑
- ✅ 租户菜单由系统管理员明确指定
- ✅ 避免了意外授予系统级别权限
- ✅ 保持角色菜单的自动添加逻辑（在租户范围内）

**现在刷新浏览器，重新保存一次，应该就能解决问题了！** 🎊
