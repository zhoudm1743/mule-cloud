# 微信小程序头像昵称获取方案

## 问题说明

### 背景
从2023年开始，微信小程序调整了用户信息获取策略：
- `getUserProfile` 接口已废弃
- 无法直接获取用户真实的昵称和头像
- 默认返回"微信用户"和默认头像

### 影响
- 登录时无法获取用户真实信息
- 用户资料显示不准确

## 解决方案

### 整体思路
采用**用户主动授权**的方式获取真实头像和昵称：

1. **登录阶段**：不再获取用户信息，直接使用微信code登录
2. **资料完善**：登录后引导用户到个人资料页面，让用户主动选择头像和输入昵称
3. **使用新API**：
   - 使用 `<button open-type="chooseAvatar">` 让用户选择头像
   - 使用 `<input type="nickname">` 让用户输入昵称

### 技术实现

#### 1. 登录流程优化

**文件：`wxApp/src/pages/login/login.vue`**

```javascript
// 移除了 getUserProfile 调用
// 直接使用微信code登录
const res = await userStore.login()

// 登录成功后检查是否需要完善资料
const needCompleteProfile = !res.user_info.nickname || res.user_info.nickname === '微信用户'

if (needCompleteProfile) {
    // 引导用户完善资料
    uni.showModal({
        title: '完善资料',
        content: '为了更好地为您服务，请完善您的个人资料',
        confirmText: '去完善',
        cancelText: '稍后',
        success: (modalRes) => {
            if (modalRes.confirm) {
                uni.reLaunch({ url: '/pages/edit-profile/edit-profile' })
            }
        }
    })
}
```

#### 2. 头像选择功能

**文件：`wxApp/src/pages/edit-profile/edit-profile.vue`**

```vue
<template>
  <!-- 使用微信新API选择头像 -->
  <button 
    class="avatar-section-btn" 
    open-type="chooseAvatar" 
    @chooseavatar="onChooseAvatar"
    :disabled="uploading"
  >
    <image :src="formData.avatar || '/static/logo.png'" mode="aspectFill"></image>
    <view class="avatar-tip">
      <text>{{ uploading ? '上传中...' : '更换头像' }}</text>
    </view>
  </button>
</template>

<script setup>
import { uploadFile } from '@/api/auth'

const onChooseAvatar = async (e) => {
  const { avatarUrl } = e.detail
  if (!avatarUrl) return
  
  try {
    // 上传到服务器
    const uploadResult = await uploadFile(avatarUrl, 'avatar')
    formData.value.avatar = uploadResult.url
    uni.showToast({ title: '头像已选择', icon: 'success' })
  } catch (error) {
    uni.showToast({ title: '头像上传失败', icon: 'none' })
  }
}
</script>
```

#### 3. 昵称输入功能

```vue
<input 
  class="item-input" 
  type="nickname"
  v-model="formData.name" 
  placeholder="请输入姓名"
  maxlength="20"
  @blur="onNicknameBlur"
/>
```

#### 4. 文件上传API

**文件：`wxApp/src/api/auth.js`**

```javascript
export function uploadFile(filePath, businessType = 'avatar') {
  return new Promise((resolve, reject) => {
    const token = uni.getStorageSync('token')
    const currentTenant = uni.getStorageSync('currentTenant')
    
    uni.uploadFile({
      url: 'https://dev.inzj.cn/api/admin/common/files/upload',
      filePath: filePath,
      name: 'file',
      formData: { business_type: businessType },
      header: {
        'Authorization': 'Bearer ' + token,
        'X-Tenant-Code': currentTenant?.tenant_code || ''
      },
      success: (res) => {
        if (res.statusCode === 200) {
          const result = JSON.parse(res.data)
          if (result.code === 200 || result.code === 0) {
            resolve(result.data) // 返回 { url, id, file_name, ... }
          }
        }
      }
    })
  })
}
```

## 使用流程

### 用户角度

1. **首次登录**
   - 点击"微信一键登录"
   - 登录成功后，弹窗提示"完善资料"
   - 点击"去完善"进入资料编辑页面

2. **完善资料**
   - 点击头像区域，选择相册或拍照
   - 系统自动上传头像到服务器
   - 输入真实姓名（使用微信昵称输入框，支持微信表情符号）
   - 填写其他信息（性别、工号、部门等）
   - 点击保存

3. **后续使用**
   - 在"我的"页面可随时编辑个人资料
   - 点击头部用户信息区域进入编辑页面

### 开发者角度

#### 关键点说明

1. **头像临时路径**
   - `chooseAvatar` 返回的 `avatarUrl` 是临时文件路径
   - 必须上传到服务器获取永久URL
   - 临时路径有效期短，不能直接存储

2. **昵称输入**
   - 使用 `type="nickname"` 的input组件
   - 支持微信表情符号和特殊字符
   - 最大长度建议20个字符

3. **文件上传**
   - 使用Common服务的文件上传接口
   - 需要携带JWT token和租户信息
   - 文件按租户和业务类型自动分类存储

4. **用户体验**
   - 登录流程简化，不强制完善资料
   - 首次登录时友好提示
   - 上传过程显示加载状态

## 修改的文件

1. **前端文件**
   - `wxApp/src/pages/login/login.vue` - 简化登录流程
   - `wxApp/src/pages/edit-profile/edit-profile.vue` - 使用新的头像和昵称API
   - `wxApp/src/api/auth.js` - 添加文件上传函数

2. **后端接口**（无需修改）
   - `/miniapp/wechat/login` - 登录接口（已支持不传用户信息）
   - `/miniapp/user/info` - 更新用户信息接口
   - `/admin/common/files/upload` - 文件上传接口

## 测试步骤

1. **清除旧数据**
   ```javascript
   // 在小程序控制台执行
   uni.clearStorageSync()
   ```

2. **测试登录**
   - 重新进入小程序
   - 点击"微信一键登录"
   - 验证是否弹出"完善资料"提示

3. **测试头像选择**
   - 进入资料编辑页面
   - 点击头像区域
   - 选择一张图片
   - 验证是否显示"上传中..."和上传成功提示

4. **测试昵称输入**
   - 在姓名输入框输入昵称
   - 可以输入表情符号
   - 保存后验证是否更新成功

5. **验证数据持久化**
   - 退出小程序
   - 重新进入
   - 验证头像和昵称是否正确显示

## 注意事项

1. **微信小程序配置**
   - 需要在小程序管理后台配置服务器域名
   - 添加 `https://dev.inzj.cn` 到 uploadFile 合法域名

2. **真机调试**
   - 开发工具中可能无法完全模拟真实效果
   - 建议在真机上测试头像和昵称功能

3. **用户隐私**
   - 用户有权不填写真实信息
   - 不强制用户完善资料
   - 可以点击"稍后"跳过

4. **头像尺寸**
   - 微信返回的头像通常是132x132
   - 如需其他尺寸，可在上传后进行裁剪

5. **错误处理**
   - 网络错误：显示友好提示
   - 上传失败：允许重试
   - 文件过大：提示压缩或选择其他图片

## 相关文档

- [微信官方文档 - 头像昵称填写](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/userProfile.html)
- [Common Service - 文件上传服务](./app/common/README.md)
- [微信小程序多租户用户系统设计方案](./微信小程序多租户用户系统设计方案.md)

## 常见问题

### Q1: 为什么登录时不直接获取用户信息？
**A:** 因为微信已废弃 `getUserProfile` 接口，无法获取真实的用户信息。新的方式需要用户主动选择头像和输入昵称。

### Q2: 用户不完善资料会影响使用吗？
**A:** 不会。系统允许用户跳过资料完善步骤，后续可以在"我的"页面随时编辑。

### Q3: 头像上传失败怎么办？
**A:** 
- 检查网络连接
- 确认服务器域名已配置
- 检查文件大小是否超限（默认100MB）
- 查看控制台错误日志

### Q4: 昵称不能输入特殊字符？
**A:** 使用 `type="nickname"` 的input组件支持微信表情符号和大部分特殊字符，但有20个字符的长度限制。

### Q5: 开发环境如何测试？
**A:** 
- 开发工具：不勾选"不校验合法域名"
- 真机调试：使用体验版或开发版
- 建议主要在真机上测试头像昵称功能

## 更新日志

### 2025-10-18
- 移除 `getUserProfile` 调用
- 实现基于用户主动授权的头像昵称获取
- 添加文件上传功能
- 优化登录流程和用户体验

