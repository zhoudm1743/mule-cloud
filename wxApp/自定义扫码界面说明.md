# 自定义扫码界面实现说明

## 🎯 需求

用户希望在扫码时看到一个**带二维码框的相机界面**，而不是使用微信默认的扫码界面。

## ✅ 解决方案

使用微信小程序的 `<camera>` 组件 + 自定义UI遮罩层来实现带二维码框的扫码界面。

## 📱 界面效果

```
┌─────────────────────────┐
│  ✕   扫描二维码   💡    │  ← 顶部工具栏（关闭、闪光灯）
│                         │
│   [ 实时相机画面 ]      │
│                         │
│        ┏━━━━┓          │
│        ┃    ┃          │  ← 扫码框（四个角+扫描线）
│        ┃    ┃          │
│        ┗━━━━┛          │
│                         │
│  将二维码放入框内...    │  ← 提示文字
│                         │
│   ✕     ⌨️     🖼️     │  ← 底部操作栏
│  取消  手动输入  相册   │
└─────────────────────────┘
```

## 🔧 技术实现

### 1. 核心组件

#### Camera 组件
```vue
<camera 
  class="camera" 
  device-position="back"        <!-- 后置摄像头 -->
  :flash="flashOn ? 'torch' : 'off'"  <!-- 闪光灯控制 -->
  mode="scanCode"               <!-- 扫码模式 -->
  @scancode="onScanCode"        <!-- 扫码成功回调 -->
  @error="onCameraError"        <!-- 错误回调 -->
>
</camera>
```

#### Cover-View 遮罩层
由于 camera 组件层级最高，需要使用 `cover-view` 来覆盖UI元素。

```vue
<cover-view class="camera-cover">
  <!-- 顶部工具栏 -->
  <cover-view class="camera-header">...</cover-view>
  
  <!-- 扫码框区域 -->
  <cover-view class="scan-area">
    <cover-view class="scan-frame">
      <!-- 四个角 -->
      <cover-view class="corner corner-tl"></cover-view>
      <cover-view class="corner corner-tr"></cover-view>
      <cover-view class="corner corner-bl"></cover-view>
      <cover-view class="corner corner-br"></cover-view>
      <!-- 扫描线 -->
      <cover-view class="scan-line"></cover-view>
    </cover-view>
  </cover-view>
  
  <!-- 底部操作栏 -->
  <cover-view class="camera-footer">...</cover-view>
</cover-view>
```

### 2. 交互流程

```
用户进入页面
   ↓
点击"开始扫码"
   ↓
请求相机权限
   ├─ 成功 → 打开相机界面
   └─ 失败 → 提示去设置中开启
   ↓
显示相机预览 + 扫码框
   ↓
用户扫描二维码
   ↓
自动识别 (mode="scanCode")
   ↓
触发 @scancode 事件
   ↓
处理扫码结果
   ↓
弹窗显示结果
   ├─ 继续扫码 → 重新打开相机
   └─ 返回首页
```

### 3. 关键代码

#### 状态管理
```javascript
const showCamera = ref(false)  // 是否显示相机
const flashOn = ref(false)     // 闪光灯状态
```

#### 打开扫码
```javascript
const openScan = () => {
  uni.authorize({
    scope: 'scope.camera',
    success: () => {
      showCamera.value = true
    },
    fail: () => {
      // 引导用户去设置中开启权限
    }
  })
}
```

#### 扫码成功
```javascript
const onScanCode = (e) => {
  const result = e.detail.result
  showCamera.value = false  // 关闭相机
  // 处理扫码结果...
}
```

#### 切换闪光灯
```javascript
const toggleFlash = () => {
  flashOn.value = !flashOn.value
}
```

### 4. 扫码框样式

#### 四个角
```scss
.corner {
  position: absolute;
  width: 80rpx;
  height: 80rpx;
  border: 6rpx solid #5EA3F2;  // 蓝色边框
  
  &.corner-tl { /* 左上角 */
    top: 0; left: 0;
    border-right: none;
    border-bottom: none;
  }
  // 其他三个角类似...
}
```

#### 扫描线动画
```scss
.scan-line {
  position: absolute;
  height: 4rpx;
  background: linear-gradient(90deg, transparent 0%, #5EA3F2 50%, transparent 100%);
  box-shadow: 0 0 20rpx #5EA3F2;  // 发光效果
  animation: scan 2.5s ease-in-out infinite;
}

@keyframes scan {
  0% { transform: translateY(0); opacity: 0; }
  10% { opacity: 1; }
  90% { opacity: 1; }
  100% { transform: translateY(500rpx); opacity: 0; }
}
```

## 🎨 UI设计要点

### 1. 层级结构
```
相机层 (camera)
  └─ 遮罩层 (cover-view)
      ├─ 顶部工具栏 (半透明黑色背景)
      ├─ 中间扫码区 (透明区域)
      │   └─ 扫码框 (四个角 + 扫描线)
      └─ 底部操作栏 (半透明黑色背景)
```

### 2. 颜色方案
- **主色调**: #5EA3F2 (蓝色)
- **扫码框**: 蓝色边框 + 发光效果
- **遮罩**: rgba(0, 0, 0, 0.6)
- **按钮背景**: rgba(0, 0, 0, 0.3)
- **文字**: #fff (白色)

### 3. 尺寸规范
- **扫码框**: 500rpx × 500rpx
- **角的尺寸**: 80rpx × 80rpx
- **边框粗细**: 6rpx
- **按钮大小**: 80rpx (顶部), 96rpx (底部)

## ⚙️ 配置要求

### 1. app.json 配置
需要在小程序配置中声明相机权限：

```json
{
  "permission": {
    "scope.camera": {
      "desc": "需要使用您的相机进行扫码"
    }
  }
}
```

### 2. 页面配置
在 page.json 中设置：

```json
{
  "navigationBarTitleText": "扫码",
  "backgroundColor": "#000000"
}
```

## 🔍 功能说明

### 主要功能

1. **实时扫码**
   - 使用后置摄像头
   - 自动识别二维码/条形码
   - 无需手动拍照

2. **扫码框指引**
   - 四个角指示扫描区域
   - 扫描线动画提示正在扫描
   - 提示文字引导用户操作

3. **闪光灯控制**
   - 点击顶部闪光灯图标切换
   - 适应暗光环境

4. **底部操作**
   - **取消**: 关闭扫码界面
   - **手动输入**: 弹出输入框
   - **相册**: 从相册选择二维码图片

### 辅助功能

- **权限管理**: 自动请求/引导开启相机权限
- **错误处理**: 相机启动失败提示
- **结果反馈**: 扫码成功后弹窗显示结果

## 📝 使用说明

### 基本使用

1. **进入扫码页面**
   ```javascript
   uni.navigateTo({
     url: '/pages/scan/scan'
   })
   ```

2. **点击"开始扫码"按钮**
   - 首次使用会请求相机权限
   - 权限通过后自动打开相机

3. **对准二维码**
   - 将二维码放入扫码框内
   - 系统自动识别，无需手动拍照

4. **查看结果**
   - 扫码成功后自动关闭相机
   - 弹窗显示扫描内容
   - 可选择继续扫码或返回

### 高级用法

#### 处理扫码结果
```javascript
const onScanCode = (e) => {
  const result = e.detail.result
  
  // 根据业务需求处理结果
  if (result.startsWith('ORDER:')) {
    // 订单二维码
    handleOrderScan(result)
  } else if (result.startsWith('PRODUCT:')) {
    // 商品二维码
    handleProductScan(result)
  }
}
```

#### 自定义扫码框样式
修改 `.scan-frame` 和 `.corner` 的样式：
```scss
.scan-frame {
  width: 600rpx;  // 改变扫码框大小
  height: 600rpx;
}

.corner {
  border-color: #FF5722;  // 改变颜色
}
```

## ⚠️ 注意事项

### 1. Cover-View 限制
- 只能嵌套 `cover-view`、`cover-image`、`cover-text`
- 不能使用普通的 `view`、`image` 等组件
- 样式支持有限（不支持 transform 等某些属性）

### 2. 相机权限
- 首次使用需要用户授权
- 如果用户拒绝，需要引导到设置页面
- iOS需要在隐私说明中声明用途

### 3. 性能优化
- 离开页面时及时关闭相机（节省电量）
- 扫码成功后立即关闭相机
- 避免长时间开启闪光灯

### 4. 兼容性
- 基础库版本要求：2.1.0+
- 部分老设备可能不支持扫码模式
- 建议提供备用方案（uni.scanCode）

## 🚀 测试步骤

### 1. 权限测试
- [ ] 首次打开请求相机权限
- [ ] 拒绝权限后提示引导
- [ ] 从设置开启权限后可正常使用

### 2. 扫码测试
- [ ] 扫描二维码成功
- [ ] 扫描条形码成功
- [ ] 暗光环境下使用闪光灯
- [ ] 扫码框动画流畅

### 3. 交互测试
- [ ] 点击取消关闭相机
- [ ] 点击手动输入弹出输入框
- [ ] 扫码成功后弹窗显示
- [ ] 继续扫码可重新打开相机

### 4. 边界测试
- [ ] 相机启动失败提示
- [ ] 识别不到二维码时不会卡死
- [ ] 快速进出页面不会崩溃

## 📊 对比方案

| 方案 | 优点 | 缺点 |
|------|------|------|
| uni.scanCode | 简单易用，微信官方UI | 无法自定义UI，无扫码框 |
| camera组件 | 完全自定义UI，带扫码框 | 代码复杂，需要处理权限 |
| 第三方插件 | 功能丰富 | 依赖第三方，可能收费 |

**推荐**: 如果需要自定义UI和扫码框，使用camera组件是最佳选择。

## 🎯 后续优化

### 可扩展功能

1. **多码识别**
   - 一次扫描识别多个二维码
   - 批量扫码模式

2. **历史记录**
   - 保存扫码历史
   - 快速重扫

3. **声音反馈**
   - 扫码成功时播放提示音
   - 震动反馈

4. **二维码生成**
   - 在扫码页面添加"我的二维码"
   - 展示用户自己的二维码供他人扫描

## 📚 相关文档

- [微信小程序 camera 组件文档](https://developers.weixin.qq.com/miniprogram/dev/component/camera.html)
- [cover-view 组件文档](https://developers.weixin.qq.com/miniprogram/dev/component/cover-view.html)
- [相机权限说明](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/authorize.html)

---

**实现日期**: 2025-10-18  
**版本**: v2.0.0
**作者**: AI Assistant

