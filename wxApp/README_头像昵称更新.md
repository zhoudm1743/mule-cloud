# 微信小程序 - 头像昵称获取更新说明

## 🎯 问题解决

**问题**：真机调试时，获取到的微信用户数据显示为"微信用户"和默认头像

**原因**：微信隐私政策调整，`getUserProfile` 接口已废弃，无法直接获取真实用户信息

**解决方案**：采用用户主动授权的方式，让用户自己选择头像和输入昵称

## ✅ 已完成的更改

### 1. 登录流程简化
- ❌ 移除了 `getUserProfile` 调用
- ✅ 直接使用微信code登录
- ✅ 登录成功后检测是否需要完善资料
- ✅ 首次登录引导用户完善资料（可跳过）

### 2. 头像选择功能
- ✅ 使用微信新API `<button open-type="chooseAvatar">`
- ✅ 自动上传头像到服务器
- ✅ 显示上传进度提示
- ✅ 支持相册和拍照

### 3. 昵称输入功能
- ✅ 使用微信新API `<input type="nickname">`
- ✅ 支持微信表情符号
- ✅ 字符长度限制20个

### 4. 文件上传API
- ✅ 新增 `uploadFile` 函数
- ✅ 支持JWT认证和租户隔离
- ✅ 统一错误处理

## 📱 用户体验流程

```
1. 用户点击"微信一键登录"
   ↓
2. 登录成功
   ↓
3. [首次登录] 弹窗提示"完善资料"
   ├─ 点击"去完善" → 进入资料编辑页面
   └─ 点击"稍后" → 进入首页
   ↓
4. [编辑资料页面]
   ├─ 点击头像 → 选择图片 → 自动上传
   ├─ 输入昵称（支持表情符号）
   ├─ 填写其他信息（性别、工号等）
   └─ 点击保存
   ↓
5. 头像和昵称正确显示
```

## 🚀 快速测试

### 准备工作
```javascript
// 在小程序开发工具控制台执行，清除旧数据
uni.clearStorageSync()
```

### 测试步骤

1. **测试登录**
   - 重新进入小程序
   - 点击"微信一键登录"
   - ✅ 验证是否弹出"完善资料"提示

2. **测试头像**
   - 进入资料编辑页面（或点击提示中的"去完善"）
   - 点击头像区域
   - 选择一张图片
   - ✅ 验证是否显示"上传中..."
   - ✅ 验证是否上传成功并显示新头像

3. **测试昵称**
   - 在姓名输入框输入昵称
   - 可以尝试输入表情符号 😊
   - 点击保存
   - ✅ 验证是否保存成功

4. **验证持久化**
   - 退出小程序（杀掉进程）
   - 重新进入
   - ✅ 验证头像和昵称是否正确显示

## ⚠️ 重要提醒

### 微信小程序配置
在微信小程序管理后台需要配置服务器域名：

1. 登录 [微信小程序后台](https://mp.weixin.qq.com/)
2. 开发 → 开发管理 → 开发设置 → 服务器域名
3. 添加以下域名到 **uploadFile合法域名**：
   ```
   https://dev.inzj.cn
   ```

### 开发调试
- 开发工具：可以勾选"不校验合法域名"进行测试
- 真机调试：**必须配置合法域名**才能上传文件
- 建议：优先在真机上测试完整功能

## 📂 修改的文件

```
wxApp/
├── src/
│   ├── pages/
│   │   ├── login/
│   │   │   └── login.vue          # ✏️ 简化登录流程
│   │   └── edit-profile/
│   │       └── edit-profile.vue   # ✏️ 使用新的头像昵称API
│   └── api/
│       └── auth.js                 # ✏️ 添加文件上传函数
└── README_头像昵称更新.md          # 📄 本文档
```

## 🔍 技术细节

### 头像选择
```vue
<button open-type="chooseAvatar" @chooseavatar="onChooseAvatar">
  <!-- 用户点击后会触发微信原生的头像选择器 -->
</button>
```

### 上传流程
```javascript
// 1. 用户选择头像
const { avatarUrl } = e.detail  // 临时文件路径

// 2. 上传到服务器
const result = await uploadFile(avatarUrl, 'avatar')

// 3. 保存永久URL
formData.value.avatar = result.url
```

### 昵称输入
```vue
<input type="nickname" v-model="name" @blur="onNicknameBlur" />
<!-- 微信会提供智能输入建议，支持表情符号 -->
```

## 🐛 常见问题

### Q: 上传失败怎么办？
**A:** 检查以下几点：
1. 是否配置了服务器域名（真机必须）
2. 网络是否正常
3. 是否登录（需要token）
4. 查看控制台错误信息

### Q: 能否跳过资料完善？
**A:** 可以！点击"稍后"即可跳过，后续可在"我的"页面随时编辑。

### Q: 头像大小有限制吗？
**A:** 后端限制100MB，微信选择的头像通常很小（几十KB），不用担心。

### Q: 为什么昵称不能输入某些字符？
**A:** 微信的昵称输入框支持大部分字符和表情符号，但有20个字符的长度限制。

## 📞 技术支持

如有问题，请查看详细文档：
- 📖 [微信小程序头像昵称获取方案](../docs/微信小程序头像昵称获取方案.md)
- 📖 [Common Service文档](../app/common/README.md)

---

**更新时间**: 2025-10-18  
**适用版本**: v1.0.0+

